# ç¬¬4èŠ‚. nginxçš„rewriteæ¨¡å—å®ç°



# rewrite



![image-20240202183308606](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240202183308606.png)



å…ˆçœ‹ä¸‹å®˜ç½‘çš„ä¾‹å­ï¼Œå…³æ³¨ä¸‹last

![image-20240202141210125](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240202141210125.png)





![image-20240202162208107](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240202162208107.png)

è¿™ç§æ˜¯æœåŠ¡å™¨å†…éƒ¨çš„è·³è½¬ï¼Œclientæ˜¯çœ‹ä¸åˆ°çš„ï¼Œæ˜¯æ²¡æœ‰ä»€ä¹ˆ301 302 çš„ï¼Œç›´æ¥å°±æ˜¯serverå†…éƒ¨é‡å®šå‘å¥½äº†ç›´æ¥ç»™ä½ 200çš„ã€‚è€Œä¸æ˜¯returnä½ 301è®©ä½ é‡æ–°å»è®¿é—®ä¸€ä¸ªæ–°çš„urlçš„ã€‚

é€šè¿‡https://www.site1.cm/test1/å¯è§ç›´æ¥æ˜¯200è¿”å›ç ï¼Œå†…å®¹æ˜¯serverè‡ªå·±rewriteæˆäº†/data/ssl/site2/inedex22.htmläº†ï¼Œä¸Šå›¾çš„ç¬¬äºŒä¸ªlocationåŒ¹é…åˆ°çš„

![image-20240202174522073](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240202174522073.png)

è¿™ç‚¹å°±å’Œreturn 301 httpxxxxä¸åŒäº†ï¼Œ301æ˜¯å‘Šè¯‰ç”¨æˆ·é‡æ–°è®¿é—®å‘èµ·çš„ã€‚è¿™ä¸ªrewriteåªserverè‡ªå·±å†…éƒ¨å¤„ç†åç›´æ¥è¿”ç»™ç”¨æˆ·çš„ã€‚èŠ‚çœäº†c/säº¤äº’å§ã€‚



ğŸ‘‡echoä¼šæŠ¢äº†rewriteçš„

![image-20240202180635535](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240202180635535.png)

åæ­£lastä¸æ¨èæ”¾åˆ°locationé‡Œ





![image-20240202183647746](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240202183647746.png)

ğŸ‘†ä¸Šå›¾æ˜¯å®˜ç½‘çš„è¯´æ³•ï¼Œæˆ‘åæ­£è¿™ä¹ˆæµ‹è¯•ğŸ‘‡æ²¡çœ‹åˆ°ä»€ä¹ˆ10æ¬¡å¾ªç¯500codeçš„ç»“æœ

![image-20240204142206572](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204142206572.png)



![image-20240204142422429](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204142422429.png)





æ‰€ä»¥æˆ‘è®¤ä¸ºğŸ‘‡

![image-20240204142511481](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204142511481.png)



**æ€»ä¹‹ï¼šlastå°±æ˜¯ä¸‹ä¸€ä¸ªlocationåŒ¹é…ï¼›breakå°±æ˜¯ä¸ç»§ç»­åŒ¹é…äº†**



![image-20240204143405874](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204143405874.png)

å¥½åƒä¸Šå›¾çš„è¯´æ³•ä¹Ÿä¸å¯¹ï¼Œå“ˆå“ˆï¼ŒåŸå› çœ‹ä¸‹å›¾ğŸ‘‡

![image-20240204143600536](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204143600536.png)

å¯èƒ½echoä¼˜å…ˆçº§é«˜äºrewriteå§ï¼Œæ‰€ä»¥echoå¯ç”¨åï¼Œè®¿é—®xxx/xxx/testå°±é»˜è®¤è¡Œä¸ºé‡å®šå‘301åˆ°xxx/xxx/test/ç„¶å  echoä¼˜å…ˆçº§é«˜ï¼Œäºæ˜¯ç›´æ¥echoå‡ºæ¥äº†ã€‚

è€Œè®¿é—®xxx/xxx/test/ï¼ŒæŒ‰ç†è¯´ä¹Ÿæ˜¯å‘½ä¸­location /testï¼Œä½†æ˜¯æ­¤æ—¶echoåˆæ²¡æœ‰ç”Ÿæ•ˆï¼å¥‡æ€ªäº†

ä¸¤æ¬¡ç°è±¡çš„åŒºåˆ«å°±æ˜¯ç¬¬ä¸€æ¬¡æœ‰ä¸€ä¸ª301ï¼Œè€Œç›´æ¥è®¿é—®/test/æ˜¯æ²¡æœ‰301çš„ã€‚å°±è¿™ä¸ªåŒºåˆ«äº†ï¼Œæ‰€ä»¥æˆ‘è®¤ä¸ºï¼š

**å¯¹äºlastï¼š**

**/test 301åˆ°/test/å°±ä¼šechoä¼˜å…ˆ**

**/test/ ç›´æ¥è®¿é—®echoå°±ä¼šrewriteä¼˜å…ˆï¼Œåˆæˆ–è€…å°±æ˜¯rewriteæ›´å¸Œæœ›æ²¡æœ‰é‡æ–°å‘è¿‡çš„è¡Œä¸ºã€‚**





![image-20240204144521796](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204144521796.png)

![image-20240204144720921](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204144720921.png)

**å¯¹äºbreakå’Œlastä¸€æ ·çš„é€»è¾‘**

**1ã€å¦‚æœå­˜åœ¨echoï¼Œé‚£ä¹ˆechoå°±ä¼šä¼˜å…ˆï¼Œå’Œlastçš„åŒºåˆ«å°±æ˜¯ /xxxå’Œ/xxx/ ä¸€æ ·éƒ½æ˜¯echoä¼˜å…ˆäº†**

**2ã€ä¸å­˜åœ¨echoï¼Œå°±æ˜¯å¸¸è§„ç†è§£äº†ï¼Œå°±æ˜¯è·³å‡ºç»§ç»­çš„locationåŒ¹é…äº†ï¼Œ**



æˆ‘è®¤ä¸ºï¼Œè¿™é‡Œå†™çš„å°±æ˜¯ä¸€å¨ï¼Œè€Œä¸”echoæ˜¯æ’ä»¶ï¼Œæ²¡æœ‰å¼„å¥½ä¸€äº›ç»†èŠ‚ï¼Œè¿™å—æŠ€æœ¯è½åœ°çš„æ—¶å€™è¦æµ‹è¯•å¥½ä½ è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯çš„ã€‚





### redirectï¼Œhttpè·³è½¬https

![image-20240204153934297](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204153934297.png)



![image-20240204152134078](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204152134078.png)

ç¬¬ä¸€ä¸ª301ï¼Œé»˜è®¤çš„/xxxè·³è½¬/xxx/è¡Œä¸º

![image-20240204152226622](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204152226622.png)

ç¬¬äºŒä¸ª302 å°±æ˜¯confæ–‡ä»¶é‡Œçš„redirectå¯¼è‡´

![image-20240204152259551](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204152259551.png)



![image-20240204160837395](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204160837395.png)

curl é‡Œçš„logè¦çœ‹åˆ°æ¡†æ¡†é‡Œçš„é‡å®šå‘é‡Œçš„å®Œæ•´urléœ€è¦è¿™ä¹ˆå†™ï¼Œè¦æ³¨æ„request_uriå’Œuriè¿˜æ˜¯æœ‰åŒºåˆ«çš„ï¼

æ¯”å¦‚/xxx/æ˜¯request_uriï¼Œè€Œuriç¡®å®/xxx/index.htmlã€‚

![image-20240204160941628](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240204160941628.png)





### sslçš„åŸºäºåŸŸåè¿›è¡Œè½¬å‘

1ã€ç»™site2.comåˆ›å»ºsslè¯ä¹¦ç›¸å…³çš„æ–‡ä»¶

â‘ ä¿®æ”¹opensslé…ç½®æ–‡ä»¶é‡Œçš„dnsä¸º*.site2.com

![image-20240205144050110](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205144050110.png)

![image-20240205144125792](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205144125792.png)

ä¸Šå›¾æ”¹é”™äº†ï¼Œå¿…é¡»æ”¹æˆ*.site2.comæ‰è¡Œï¼Œå¦åˆ™è¯ä¹¦æ— æ³•éªŒè¯é€šè¿‡ï¼



å¥½äº†ä¸¤ä¸ªæ–‡ä»¶æœ‰äº†

![image-20240205144328103](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205144328103.png)



![image-20240205144413520](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205144413520.png)



é…ç½®å¥½è™šæ‹Ÿä¸»æœºï¼ŒåŸºäºåŸŸåçš„

![image-20240205144538198](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205144538198.png)

![image-20240205144640954](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205144640954.png)



![image-20240205144655257](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205144655257.png)

ç„¶åå°±å®ç°äº†ğŸ‘‡

![image-20240205144824245](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205144824245.png)



ç”±äºä¸Šé¢çš„site2.comæ²¡æœ‰å†™æˆ*.site2.comé€šé…ï¼Œæ‰€ä»¥ssléªŒè¯å¤±è´¥ï¼Œè¿™é‡Œæ”¹ä¸€ä¸‹ï¼Œé¡ºä¾¿ç”¨ä¸€ä¸ªsslè¯ä¹¦æå®šä¸¤ä¸ªç½‘ç«™

![image-20240205153835616](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205153835616.png)



å»æ‰Makefileçš„xxx.keyåŠ å¯†é€‰é¡¹å’Œæ·»åŠ v3çš„dnsé€‰é¡¹çš„ğŸ‘‡

![image-20240205153234675](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205153234675.png)

![image-20240205154712875](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205154712875.png)



![image-20240205153355453](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205153355453.png)

sslè¯ä¹¦ä¸¤ä¸ªè™šæ‹Ÿä¸»æœºå°±ç”¨ä¸€ä¸ªæ ·çš„

![image-20240205153525994](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205153525994.png)

![image-20240205153558613](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205153558613.png)

ç„¶åçœ‹æœ€å…³é”®çš„æµè§ˆå™¨

é€šè¿‡sz site.crtå¯¼å…¥åˆ°æœ¬åœ°ç”µè„‘çš„æ¡Œé¢ä¸Šï¼Œç„¶ååŒå‡»å¯¼å…¥ å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„ å°±è¡Œäº†

![image-20240205154734173](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205154734173.png)





![image-20240205154841969](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205154841969.png)

ğŸ‘†è¿™å°±å®ç°äº†ä¸€ä¸ªè¯ä¹¦æå®šå¤šä¸ªåŸŸåå•¦ï¼Œè‡ªç„¶ä¹Ÿæ˜¯ä¸€ä¸ªip+80å¯¹åº”ä¸åŒåŸŸåçš„ã€‚

![image-20240205155421367](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205155421367.png)





æ®è¯´nginxæ”¯æŒè¿™ç§sslçš„å¤šåŸŸåå¯¹åº”ä¸€ä¸ªip+portæ˜¯å› ä¸ºTLS SNIåŠŸèƒ½

![image-20240205160212167](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205160212167.png)

TLS SNIå°±æ˜¯TLSçš„sever name indicationï¼ˆsni)

![image-20240205160402176](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205160402176.png)





### è®¿é—®é”™è¯¯é¡µé¢æ—¶çš„å¤„ç†

éœ€è¦åˆ©ç”¨request_filenameå˜é‡æ¥åˆ¤æ–­è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨

![image-20240205164935118](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205164935118.png)





![image-20240205165000916](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205165000916.png)







<img src="4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205165914695.png" alt="image-20240205165914695" style="zoom:50%;" />





![image-20240205170759575](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205170759575.png)

![image-20240205170957699](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205170957699.png)



è¿™å°±å®ç°äº†è®¿é—®ä¸å­˜åœ¨çš„ç½‘é¡µè·³è½¬åˆ°é¦–é¡µäº†ï¼Œä¸è¿‡è¦å’Œ80è½¬443å…±å­˜ï¼Œå¯èƒ½éœ€è¦è¿™ä¹ˆä¿®æ”¹

![image-20240205171443340](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205171443340.png)

è¿™æ˜¯80è½¬443çš„è¿‡ç¨‹ï¼Œé‡Œé¢ä¹Ÿæ¶‰åŠä¸€ä¸ªä¸å­˜åœ¨çš„é¡µé¢(https://www.site1.com/)è¿™ä¸ªé¡µé¢æœ¬æ¥æ˜¯åº”è¯¥å­˜åœ¨çš„å•Šï¼Œå¥‡æ€ªäº†ï¼Ÿè¿™ä¹ˆå†™æŠŠåŸæ¥çš„é»˜è®¤/å°±æ˜¯è®¿é—®/index.htmlçš„è¡Œä¸ºç»™ææ²¡äº†ã€‚

![image-20240205172000501](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205172000501.png)

è¿™æ˜¯ä¸å­˜åœ¨é¡µé¢è½¬çš„è¿‡ç¨‹ğŸ‘‡

![image-20240205171745224](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205171745224.png)



å¥‡æ€ªçš„ç‚¹çœ‹çœ‹æ—¥å¿—ğŸ‘‡

![image-20240205173230871](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205173230871.png)

![image-20240205173246718](4-nginxçš„rewriteæ¨¡å—å®ç°.assets/image-20240205173246718.png)

å¥½äº†ä¸ç®¡äº†





