# ç¬¬3èŠ‚. nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°



# å‹ç¼©

apacheä¹Ÿæ”¯æŒå‹ç¼©

![image-20240125144151279](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125144151279.png)

------------------

![image-20240125143945781](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125143945781.png)

è¿™æ˜¯ğŸ‘†httpdçš„å‹ç¼©ç¯‡ç« 



nginx -tæŸ¥çœ‹ç¼–è¯‘çš„é…ç½®é€‰é¡¹

![image-20240125145453478](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125145453478.png)

é…ç½®å‚æ•°å¦‚ä¸‹ï¼š

gzip on|off  å¼€å…³

gzip_comp_level level     å‹ç¼©æ¯”ä¿®æ”¹ 1åˆ°9ï¼Œ9 æœ€é«˜å‹ç¼©æ¯”ï¼Œ9ä¹Ÿæ˜¯æœ€è€—CPUçš„

è™½ç„¶æ˜¯1-9ï¼Œä½†æ˜¯å‹ç¼©çš„æ•ˆæœä¹Ÿä¸ä¼šå·®å¤ªå¤š

gzip_disable regex ...     åŒ¹é…å®¢æˆ·ç«¯æµè§ˆå™¨ç±»å‹å°±ä¸æ‰§è¡Œå‹ç¼©ï¼Œæ¯”å¦‚gzip_disable "MSIE[1-6]\\.";

gzip_min_length length   å‹ç¼©çš„èµ·ç‚¹ï¼Œä»€ä¹ˆæ ·çš„å¤§å°æ‰å¼€å§‹å‹ç¼©ï¼Œæ¯”å¦‚ï¼100kçš„æ‰å¼€å§‹å‹ç¼©ï¼Œ100Byteså°±åˆ«å‹äº†ï¼Œå‹äº†ä¹Ÿæ²¡å•¥æ•ˆæœã€‚



gzip_http_version 1.0|1.1  æ˜¯æ”¯æŒçš„httpç‰ˆæœ¬

<img src="3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125151438624.png" alt="image-20240125151438624" style="zoom:50%;" />



gzip_buffers number szie   å‹ç¼©çš„æ—¶å€™å¯ç”¨å¤šå¤§çš„ç¼“å†²åŒº

gzip_types mime-type ... é’ˆå¯¹ä»€ä¹ˆç±»å‹çš„æ–‡ä»¶è¿›è¡Œå‹ç¼©ï¼Œé»˜è®¤åŒ…å«text/htmlçš„æ ¼å¼æ”¯æŒï¼Œä¸è¦å†™ï¼Œå†™äº†åè€ŒæŠ¥é”™ã€‚



gzip_vary on|off   å¦‚æœå¯ç”¨å‹ç¼©äº†ï¼Œæ˜¯å¦åœ¨å“åº”æŠ¥æ–‡é¦–éƒ¨æ’å…¥"Varyï¼šAccept-Encoding"

è§£é‡Šï¼šğŸ‘‡å°±æ˜¯è¯´serverè¦æ’å…¥è¿™ä¸ªæ ‡è®°ï¼Œä»£ç†é‚£è¾¹å°±ä¼šå­˜å‚¨ä¸¤ä¸ªç‰ˆæœ¬çš„webé¡µï¼Œä¸€ä¸ªå‹ç¼©ä¸€ä¸ªä¸å‹ç¼©ï¼Œä»¥æ­¤æ¥å“åº”æ”¯æŒå’Œä¸æ”¯æŒå‹ç¼©çš„clientæµè§ˆå™¨ã€‚å½“ç„¶c-serç›´è¿çš„è¯å°±çœ‹clienté‚£è¾¹æµè§ˆå™¨æ˜¯å¦æ”¯æŒå‹ç¼©äº†æ”¯æŒ-serverå°±å‘é€ç»è¿‡gzipå‹ç¼©çš„é¡µé¢ç‰ˆæœ¬ã€‚

<img src="3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125160601264.png" alt="image-20240125160601264" style="zoom:50%;" />



gzip_proxied off|expied|no-cache|no-store|private|no_last_modified|no_etag|auth|any ...;

nginxåšåä»£çš„æ—¶å€™ï¼Œåç«¯æœåŠ¡å™¨å°†å“åº”æŠ¥æ–‡å‘ç»™nginxï¼Œnginxå†å›ç»™ç”¨æˆ·çš„æ—¶å€™ï¼Œæ˜¯å¦å¯ç”¨å‹ç¼©ï¼Œå°±é è¿™ä¸ªå‚æ•°æ¥åšçš„ã€‚

off  å°±æ˜¯nginxè¿”ç»™clientçš„æ—¶å€™ä¸å‹ç¼©

expied|no-cache|no-store|private|no_last_modified|no_etag|auth|any ...   åç«¯æœåŠ¡å™¨å“åº”æŠ¥æ–‡ä¸­å¸¦æœ‰Cache-Controlå­—æ®µï¼Œç„¶åè¿™ä¸ªå­—æ®µé‡Œçš„å€¼ å†™çš„æ˜¯è¿™äº›çš„æ—¶å€™ï¼Œå°±å¯ç”¨å‹ç¼©ã€‚

<img src="3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125163350082.png" alt="image-20240125163350082" style="zoom:50%;" />



é…ç½®ä¸‹

åŒæ ·ï¼Œå¯ä»¥äº†è§£ä¸‹gzipçš„é€‚é…æ¨¡å—

![image-20240125163747665](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125163747665.png)

gzip çš„æ€»å¼€å…³ é»˜è®¤å°±æ˜¯offçš„ã€‚å…¶ä»–çš„å°±æ˜¯onåçš„ä¸€äº›é€‰é¡¹



![image-20240125164139869](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125164139869.png)



è§‚å¯Ÿè¿™ä¸ªå¤§æ–‡ä»¶ï¼Œçœ‹ä¸‹å‹ç¼©çš„æ•ˆæœ

![image-20240125164525089](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125164525089.png)

curlå¯ä»¥çœ‹åˆ°Content-Lenthå¤§å°å°±æ˜¯æ–‡ä»¶çš„å¤§å°ğŸ‘‡ğŸ‘†

![image-20240125164704005](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125164704005.png)

æ—¢æ˜¯curlå¸¦ä¸Šå‹ç¼©åŠŸèƒ½ï¼Œä¹Ÿæ²¡æœ‰ï¼Œå› ä¸ºserveré‚£è¾¹æ²¡æœ‰å¼€å¯

![image-20240125165131369](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125165131369.png)



ç„¶åserverå¼€å¯å‹ç¼©åŠŸèƒ½

![image-20240125164039972](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125164039972.png)

ç„¶åcurlçœ‹å‹ç¼©è¦å¯ç”¨å‹ç¼©åŠŸèƒ½çš„ï¼Œä¸å¯ç”¨æ˜¯æ²¡æ•ˆæœçš„

![image-20240125164917874](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125164917874.png)

curlå¸¦ä¸Šå‹ç¼©é€‰é¡¹ï¼Œåº”è¯¥æ˜¯æˆåŠŸäº†ï¼Œåªæ˜¯ä¸å†æ˜¾ç¤ºContent-Lengthäº†ã€‚

![image-20240125165242206](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125165242206.png)

![image-20240125170959291](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125170959291.png)



æ‰€ä»¥è¯´å‹ç¼©æ¯”å·®ä¸å¤šå°±è¡Œäº†ğŸ‘‡

![image-20240125171611395](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240125171611395.png)



# SSLè¯ä¹¦ï¼ŒåŠ å¯†

ä¹‹å‰httpdä¹Ÿå¼„è¿‡ï¼Œè‡ªç­¾åè¯ä¹¦è¿˜æŒºæœ‰æ„æ€çš„ï¼Œå®ç°äº†clientçš„å®‰å…¨è®¿é—®çš„å…³é”®ç‚¹ã€‚



ç„¶åè´­ä¹°è¯ä¹¦è¿™å—çš„æƒ…å†µ

é˜¿é‡Œäº‘ä¸Šæœ‰å…¨å¥—çš„è´­ä¹°ç”³è¯·æµç¨‹ï¼Œå¯ä»¥å­¦ä¹ ä¸‹ï¼Œä½†æ˜¯ä¹°ä¸ä¸€å®šï¼Œéœ€è¦çœ‹å“ªé‡Œæ€§ä»·æ¯”é«˜ã€‚

apacheåšsslï¼Œserverä¸Šæ˜¯é…ç½®3ä¸ªæ–‡ä»¶ï¼šcaè¯ä¹¦ã€æœåŠ¡å™¨è¯ä¹¦ã€æœåŠ¡å™¨ç§é’¥

nginxåšsslï¼ŒæœåŠ¡å™¨è¯ä¹¦ã€æœåŠ¡å™¨ç§é’¥



å®ç°sslæ˜¯ç”¨çš„ngx_http_ssl_moduleæ¨¡å—

**â‘ ssl on|offï¼Œ   sslå¼€å…³ï¼Œä¸æ¨èï¼Œå»ºè®®ä½¿ç”¨listenæŒ‡ä»¤ï¼Œå’Œhttpdä¸€æ · listen 443 ssl**

![image-20240126180128632](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240126180128632.png)

httpdå°±æ˜¯listen 443 https ï¼Œä¸æ˜¯ä¸€ä¸ªæ„æ€å˜›ã€‚



**â‘¡ssl_certificate_file** å’Œ **ssl_certificate_key file**

æœåŠ¡å™¨è¯ä¹¦æ–‡ä»¶å’Œç§é’¥æ–‡ä»¶ï¼›ä»ä¾›åº”å•†è´­ä¹°åä¼šå¾—åˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæœåŠ¡å™¨è¯ä¹¦æ–‡ä»¶ï¼Œä¸€ä¸ªç§é’¥key



**â‘¢ssl_protocols**

æ”¯æŒçš„sslåŠ å¯†åè®®ï¼Œé»˜è®¤å°±è¡Œäº†

**â‘£ssl_session_cache **

åŠ é€ŸæœåŠ¡å™¨å“åº”é€Ÿåº¦çš„å§åº”è¯¥æ˜¯ï¼Œ

![image-20240126181350636](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240126181350636.png)



**â‘¤ssl_session_timeout **

å®¢æˆ·ç«¯é“¾æ¥å¯ä»¥å¤ç”¨ssl session cacheä¸­ç¼“å­˜çš„æœ‰æ•ˆæ—¶é•¿ï¼Œé»˜è®¤5m

![image-20240126181858915](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240126181858915.png)





## ä¸‹é¢å¼€å§‹å®éªŒ

è¿˜æ˜¯ä½¿ç”¨è‡ªç­¾åè¯ä¹¦å’¯

ä¹‹å‰httpçš„æ—¶å€™ç”¨çš„opensslè¿˜æ˜¯æ¯”è¾ƒå¤šæ­¥éª¤çš„ï¼Œç°åœ¨åˆ©ç”¨ä¸€ä¸ªMakefileæ–‡ä»¶æ¥å¼„ï¼Œå…¶å®å°±æ˜¯Makefileå°è£…å¥½äº†å‡½æ•°ï¼Œè„šæœ¬ç®€åŒ–æˆäº†cliäº†ã€‚

é¦–å…ˆä½ éœ€è¦ä¸€ä¸ªMakefileæ–‡ä»¶ğŸ‘‡

https://exampleconfig.com/view/openssl-centos7-etc-pki-tls-certs-makefile

â‘ ä¸‹è½½Makefile

![image-20240131094126491](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240131094126491.png)

â‘¡ç”Ÿæˆè‡ªç­¾åè¯ä¹¦

![image-20240131095441316](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240131095441316.png)

ä¸Šå›¾æ¼äº†Common Nameï¼Œå°±æ˜¯è¦å†™ç½‘ç«™åŸŸåçš„ğŸ‘‡

![image-20240131100029436](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240131100029436.png)

ä½†æ˜¯ç°åœ¨æœ‰ä¸ªé—®é¢˜ï¼Œæ¯æ¬¡é‡å¯æœåŠ¡éƒ½æœ‰é—®é¢˜ï¼Œå°±æ˜¯ming.keyè¿™ä¸ªç§é’¥æ–‡ä»¶æ˜¯åŠ å¯†çš„ï¼Œ

![image-20240131100225835](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240131100225835.png)

æ‰€ä»¥è¿˜éœ€è¦ç»™å®ƒè§£å¯†ä¸€ä¸‹ğŸ‘‡

[root@server tls]# openssl rsa -in ming.key -out ming.net.key

![image-20240201092828066](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201092828066.png)

è¿™æ ·å°±å¾—åˆ°ä¸åŠ å¯†çš„ç§é’¥äº†

![image-20240201094822255](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201094822255.png)

å°†ä¸¤ä¸ªæ–‡ä»¶ming.crtå’Œming.keyæ”¾åˆ°nginxçš„é…ç½®è·¯å¾„ä¸‹ï¼Œå†çœ‹ä¸‹æƒé™æ˜¯å¦ä¸º600

![image-20240201095107653](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201095107653.png)

è¯ä¹¦æ–‡ä»¶æœ‰äº†ï¼Œå°±å¯ä»¥æ”¹nginxçš„é…ç½®æ–‡ä»¶äº†

![image-20240201103042527](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201103042527.png)

ç„¶åæ‰“å¼€æµè§ˆå™¨

![image-20240201103332794](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201103332794.png)

è¿™ä¸å°±æ¥äº†å˜›

ä½†æ˜¯ä¸å®‰å…¨æ²¡æ³•æï¼Œå› ä¸ºéœ€è¦ä¸‹è½½ming.crtè¯ä¹¦åˆ°PCï¼Œç„¶åå¯¼å…¥åˆ°å—ä¿¡ä»»çš„æ ¹è¯ä¹¦é¢å‘æœºæ„

æ—¢æ˜¯å¯¼å…¥äº†å¯ä»¥è‚¯å®šä¹Ÿæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºé€šè¿‡

openssl x509 -in ming.crt -text -nooutå‘ç°è¿™ç§Makefileçš„æ–¹å¼å¹¶æ²¡æœ‰X509v3 Subject Alternative Nameè¿™ä¸ªé€‰é¡¹ï¼Œæ‰€ä»¥å¯¼å…¥ä¹Ÿæ²¡æœ‰ç”¨çš„ï¼ŒMakefileéœ€è¦ä¼˜åŒ–ä¸‹ã€‚

![image-20240201110359655](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201110359655.png)



#### å°è¯•ä¼˜åŒ–Makefileæ–‡ä»¶

æå®š

![image-20240201132012102](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201132012102.png)

å“ˆå“ˆå“ˆï¼Œä¿®æ”¹Makefileå’Œå¤„ç†æ–¹å¼å¦‚ä¸‹

1ã€makefileçš„ä¿®æ”¹

![image-20240201132058522](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201132058522.png)

è¿™é‡Œè¡¥å……ä¸€ä¸ªå–æ¶ˆxxx.keyç”Ÿæˆçš„æ—¶å€™è¾“å…¥å¯†ç çš„è¦æ±‚ï¼Œä¹Ÿå°±æ˜¯ä¸åŠ å¯†äº†

![image-20240205150009632](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240205150009632.png)

å»æ‰-aes128å°±è¡Œäº†

![image-20240205150102097](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240205150102097.png)





2ã€opensslçš„é…ç½®æ–‡ä»¶ä¿®æ”¹

![image-20240201132150628](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201132150628.png)

3ã€é‡æ–°make ä¸€ä¸‹

```
make ming.crt  # ä¸€é”®ç”Ÿæˆming.key å’Œ ming.crt

openssl rsa -in ming.key -out ming.net.key  # å»æ‰ming.keyçš„å¯†ç 

rm -rf ming.key  # åˆ é™¤å¸¦å¯†ç çš„key

mv ming.net.key ming.key  # åé¢ä½¿ç”¨ä¸å¸¦å‘½åçš„keyï¼Œé‡å‘½åä¸€ä¸‹

mv ming.key ming.crt /etc/nginx/ssl/  # ç§»åŠ¨åˆ°è§„èŒƒç›®å½•ä¸‹ï¼Œä¾›nginxè°ƒç”¨

[root@server tls]# cat /etc/nginx/conf.d/site.conf

server {
    listen 443 ssl;
    server_name *.site1.com;
    root /data/ssl/;
    ssl_certificate /etc/nginx/ssl/ming.crt;
    ssl_certificate_key /etc/nginx/ssl/ming.key;
    ssl_session_cache shared:sslcache:20m;
    ssl_session_timeout 10m;
    access_log /data/ssl/log/site1.access.log access_json;
}

systemctl restart nginx
```



4ã€å¯¼å‡ºming.crt

5ã€å¯¼å…¥PC

æ‰“å¼€æµè§ˆå™¨å°±okæ‹‰



ä½†æ˜¯é€šè¿‡è¿™ä¸ªå¯å‘å‘ç°ï¼Œç°åœ¨sslæµè§ˆå™¨éªŒè¯æœç„¶ä¸å†çœ‹ç«™ç‚¹äº†ï¼Œåªçœ‹å¤‡ç”¨åç§°ã€‚

![image-20240201132646727](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201132646727.png)

ä½ çœ‹å“¦

![image-20240201133435030](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201133435030.png)

è¿™é‡ŒğŸ‘†å†™é”™äº†ï¼Œå…¶å®æ²¡å…³ç³»

è‚¯å®šæ­£å¸¸è¦ä¸€æ ·çš„

![image-20240201133518104](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201133518104.png)

è¿™é‡Œæ•…æ„å†™ä¸ä¸€æ ·ï¼Œå°±æ˜¯éªŒè¯åªçœ‹Alternative Name

![image-20240201133637170](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201133637170.png)

![image-20240201133655841](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201133655841.png)

ç„¶åå¯¼å…¥ming.crtè¿›å…¥PC

![image-20240201134106371](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201134106371.png)





## sslè·³è½¬ï¼Œngx_http_rewrite_module

![image-20240201143722831](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201143722831.png)



### å…ˆè¯´if

![image-20240201144906698](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201144906698.png)



returnæ˜¯è¿”å›301è¿™ä¸ªcodeï¼Œå¹¶é‡å®šå‘åˆ°æ€§çš„url

![image-20240201150210312](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201150210312.png)

ä¸Šå›¾æ¼äº†80ç›‘å¬ï¼Œå¦åˆ™ä¼šå®ç°sslè·³è½¬

![image-20240201150704138](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201150704138.png)



okäº†å°±ï¼Œä¸è¿‡æ›´å¤šçš„ä¸ç”¨returnï¼Œè€Œæ˜¯ç”¨rewriteæ¥åšé‡å®šå‘ã€‚

![image-20240201150804788](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201150804788.png)





![image-20240201155221923](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201155221923.png)





curléªŒè¯

![image-20240201150947211](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201150947211.png)

![image-20240201155111676](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201155111676.png)

ğŸ‘†çœ‹çš„å¾ˆæ¸…æ¥šè·³è½¬äº†





ç„¶åechoçš„æµ‹è¯•è¦ç”¨ä¹‹å‰çš„ç¼–è¯‘å®‰è£…çš„nginx

![image-20240201163825403](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201163825403.png)

å°†includeç§»åˆ°åé¢å°±è¡Œäº†ï¼Œä¸»é…ç½®æ–‡ä»¶

![image-20240201164012014](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201164012014.png)

å­é…ç½®æ–‡ä»¶ğŸ‘‡

![image-20240201164115084](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201164115084.png)



OKäº†è¿™æ ·ï¼Œç¬¬ä¸€ä¸ªifé‡å®šå‘åˆ°httpsï¼Œç„¶åæµè§ˆå™¨ç»§ç»­å‘èµ·httpsçš„è¯·æ±‚ï¼Œç„¶åå°±å‘½ä¸­ç¬¬äºŒä¸ªifï¼Œç„¶åå°±ä¼šè°ƒç”¨echoå¾—åˆ°ğŸ‘‡é¡µé¢äº†ï¼š

![image-20240201164309562](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201164309562.png)



å®˜ç½‘çš„ifä¾‹å­

![image-20240201165854931](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201165854931.png)

å¯ä»¥çŸ¥é“ifå¯ä»¥æ§åˆ¶ï¼Œæ¯”å¦‚æˆ‘çš„ç«™ç‚¹ä¸è®©ä½ curl

æ¯”å¦‚163è‚¯å®šå°±åšäº†if ä¸è®©ä½ curlï¼Œ

![image-20240201165948126](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201165948126.png)

ä½†å…¶å®curlä¾ç„¶å¯ä»¥ç”¨ï¼Œå› ä¸º163é™åˆ¶curlæ˜¯é€šè¿‡ifæ¥åŒ¹é…å¿…é¡»è¦æœ‰æµè§ˆå™¨ï¼Œè€Œcurlè‡ªç„¶å¯ä»¥æ¨¡æ‹Ÿæµè§ˆå™¨

![image-20240201170503176](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201170503176.png)

### ğŸ‘†curlé€šè¿‡-AIEæ¥æ¨¡æ‹ŸIEæµè§ˆå™¨ï¼ŒåŠ ä¸Š-Læ”¯æŒé‡å®šå‘å°±è¡Œäº†ã€‚ä¸€èˆ¬å°±å¯ä»¥ç»•è¿‡ç½‘ç«™å¯¹curlçš„é™åˆ¶äº†



![image-20240201173327741](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201173327741.png)



### æµ‹è¯•if   user_agent

![image-20240201174133014](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201174133014.png)

æ”¹ä¸€ä¸‹ä¸è¦æ–¹æ‹¬å·

![image-20240201174757679](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201174757679.png)

![image-20240201174808765](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201174808765.png)

è¿™æ ·å°±ifåŒºåˆ†äº†curlğŸ‘‡

![image-20240201175042477](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201175042477.png)









![image-20240201175723535](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201175723535.png)



çœ‹ä¸‹agentæ€ä¹ˆè‡ªå®šä¹‰å‡ºæ¥çš„ğŸ‘‡

![image-20240201175851195](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201175851195.png)

![image-20240201180109985](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201180109985.png)



### çœ‹ä¸‹301 302 307

![image-20240201180529307](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201180529307.png)

åŒºåˆ«ï¼š

1ã€301æ˜¯æ°¸ä¹…é‡å®šå‘ï¼Œæ˜¯å¯ä»¥ç¼“å­˜çš„ï¼Œæ‰€ä»¥ä¼šå‡ºç°from disk cacheã€‚

2ã€



![image-20240201181641146](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201181641146.png)

ç»“æœç¬¬äºŒæ¬¡å˜æˆ307 from disk cacheäº†ã€‚ã€‚ã€‚

![image-20240201182145712](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201182145712.png)



302å°±æ˜¯ä¸´æ—¶æ€§çš„ï¼Œä¸€èˆ¬ç°åœ¨è¶‹åŠ¿æ˜¯å…¨ç«™åŠ å¯†ï¼Œå¯èƒ½301åè€Œæ›´å¤šä¸€äº›ã€‚



307æ˜¯æµè§ˆå™¨å†…éƒ¨è·³è½¬ï¼Œä¸è®¿é—®é¡µé¢äº†ï¼Œè¿™ä¸ªæ€ä¹ˆå…³æ‰å‘¢ï¼Œå°±æ˜¯ç°åœ¨æˆ‘æµ‹è¯•éƒ½æ˜¯

ç¬¬ä¸€æ¬¡ 301 

ç¬¬äºŒæ¬¡ ç„¶åå°±307 from disk cache

æˆ‘æƒ³åšå‡ºå‡ºæ¥

ç¬¬ä¸€æ¬¡ 301 

ç¬¬äºŒæ¬¡ 301 from disck cache



HSTSæ˜¯å•¥

![image-20240201183338145](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201183338145.png)

HSTSæ˜¯





![image-20240201183554109](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201183554109.png)



![image-20240201184323204](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201184323204.png)ã€ã€





![image-20240201184336413](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201184336413.png)



![image-20240201184359321](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201184359321.png)

![image-20240201184613214](3-nginxçš„å‹ç¼©å’ŒhttpsåŠ å¯†å®ç°.assets/image-20240201184613214.png)





