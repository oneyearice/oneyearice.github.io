# ç¬¬5èŠ‚. nginxåå‘ä»£ç†å®ç°



# é˜²ç›—é“¾

ç›—é“¾å°±æ˜¯ä¸€ä¸ªç½‘ç«™è°ƒç”¨å¦ä¸€ä¸ªç½‘ç«™çš„èµ„æº



**æ„å»ºç›—é“¾**

site1ç«™ç‚¹ç›—é“¾site2ç«™ç‚¹é‡Œçš„ä¸€å¼ å›¾ç‰‡

![image-20240206111138310](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206111138310.png)

è¿™æ˜¯ä¸¤ä¸ªä¹‹å‰åšçš„ç«™ç‚¹ğŸ‘†å°±åˆ©ç”¨è¿™ä¸ªç°æˆçš„åšå®éªŒ

![image-20240206111350203](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206111350203.png)

è¿™å°±å®ç°äº†ç›—é“¾ï¼Œ

![image-20240206112043970](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206112043970.png)

å¾ˆæ˜æ˜¾å­˜åœ¨ä¸¤ä¸ªé—®é¢˜â‘ ä¹±ç â‘¡å›¾ç‰‡ä¸èƒ½ç¼©æ”¾äº†ï¼Œ

![image-20240206112800647](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206112800647.png)

![image-20240206113334211](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206113334211.png)

è¿™æ˜¯site1å’Œsite2 log åˆåœ¨ä¸€èµ·å’¯ï¼Œç›—é“¾è¡Œä¸ºå…¶å®æ˜¯ï¼Œç«™åœ¨è¢«ç›—æ–¹çš„è§’åº¦å»é˜²æ­¢ï¼Œæ‰€ä»¥logæ‹†å¼€æ¥ï¼Œå»å¼€è¢«ç›—ç«™ç‚¹site2çš„log

![image-20240206114652752](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206114652752.png)

å¯ä»¥çœ‹åˆ°çš„ï¼Œæ‰€ä»¥å°±å¯ä»¥é˜²æ­¢ç›—é“¾è¡Œäº†çš„



**é˜²æ­¢ç›—é“¾çš„è§£æ”¾æ–¹æ³•ï¼šngx_http_referer_moduleæ¨¡å—æ¥å¼„**

å¤§ä½“æ„æ€å°±æ˜¯å…ˆå®šä¹‰å‡ºå“ªäº›æ˜¯åˆæ³•çš„refererï¼Œæ¯”å¦‚ç™¾åº¦è¿‡æ¥çš„refererè¯´æ˜ä½ å¹¿å‘Šè´¹æ²¡ç™½å‡ºã€‚

ä¸¤ä¸ªå‚æ•°

**valid_referers none|blocked|server_names|string ...;**      # ç”¨æ¥å®šä¹‰åˆæ³•refererçš„å€¼çš„

**none**ï¼šå°±æ˜¯refererä¸ºç©º åˆ¤æ–­ä¸ºåˆæ³•ã€‚ä¸€èˆ¬ç›´æ¥è®¿é—®æŸä¸ªç½‘ç«™refereréƒ½æ˜¯ç©ºçš„ã€‚è‡ªç„¶è¦å†™noneçš„ã€‚

![image-20240206120416349](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206120416349.png)

noneåœ¨æµè§ˆå™¨é‡ŒF12æ˜¯çœ‹ä¸åˆ°çš„å§



![image-20240206120747913](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206120747913.png)



![image-20240206120557421](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206120557421.png)





**blocked**ï¼šå°±æ˜¯refereré‡Œå†™çš„ä¸œè¥¿ä¸æ˜¯å¸¸è§„çš„uriï¼Œè¿™ä¸ªæ²¡è§è¿‡è¿˜



**server_names**ï¼šæœ¬ç½‘ç«™å†…éƒ¨è·³è½¬çš„ï¼Œå°±ä¼šåœ¨refereré‡Œå¸¦ä¸Šè‡ªå·±çš„ä¸»æœºåï¼Œéƒ½æ˜¯è‡ªå®¶äººå•Šã€‚



**arbitrary_string**ï¼šä»»æ„å­—ç¬¦ä¸²ï¼Œç”¨é€šé…ç¬¦çš„æ–¹å¼ã€‚

![image-20240206135745293](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206135745293.png)



**regular_expression** ï¼šä¹Ÿæ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œç”¨regexæ¥åšäº†ï¼Œæ ¼å¼å°±æ˜¯~å¼€å¤´ä»£è¡¨regexã€‚

â€‹																		ä¾‹å¦‚ï¼š        ~.*\.site1\.com





é…ç½®é˜²ç›—é“¾è‚¯å®šåœ¨è¢«ç›—ç«™ç‚¹ä¸Šé…ç½®äº†ğŸ‘‡

```
    valid_referers none block server_names
    *.site2.com site2.* ~\.site2\.
    ~\.google\. ~\.baidu\.;

    if  ($invalid_referer)  {
         return 403 "Forbidden Access";
    }

```

![image-20240206142530884](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206142530884.png)







![image-20240206142854980](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206142854980.png)



![image-20240206143005932](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206143005932.png)



ç„¶åå¦‚æœæ˜¯ä»baiduè·³è¿‡æ¥çš„å°±ä¸ç¦æ­¢è®¿é—®ï¼Œå› ä¸ºåæœ‰å…«ä¹å°±æ˜¯å¹¿å‘Šçš„é’±å•¦ğŸ‘‡

æµ‹è¯•ï¼šä¿®æ”¹site1ä¸ºbaidu

![image-20240206154826262](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206154826262.png)

ä¿®æ”¹æœ¬åœ°hostsæ–‡ä»¶

C:\Windows\System32\drivers\etc      ä¸‹ğŸ‘‡

![image-20240206154608745](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206154608745.png)



ä¸Šå›¾é…ç½®æ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºhttp://www.baidu.com/daolian.htmlæ˜¯80è·³443çš„ä¹Ÿå°±æ˜¯è·³åˆ°https://www.site1.comçš„ï¼Œ

![image-20240206155119867](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206155119867.png)

ç„¶åå°±ä¼šå»è®¿é—®https://www.site1.com/daolian.html

ç„¶åå›¾ç‰‡çš„è®¿é—®é‡Œå°±æœ‰

![image-20240206155206461](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206155206461.png)

è¿™æ ·å°±ä¸æ˜¯ä»www.baidu.comè·³è¿‡å»çš„äº†ï¼Œ

æµ‹è¯•çš„è¯å€’ä¸ç”¨æ”¹é…ç½®æ–‡ä»¶ï¼Œç›´æ¥è®¿é—®https://www.baidu.com/daolian.html

è¿™æ ·å°±å¯ä»¥äº†ï¼Œ

![image-20240206155336952](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206155336952.png)



å½“ç„¶è¿™é‡Œsslä¸å®‰å…¨çš„åŸå› ä¹Ÿå¾ˆç®€å•å•Šï¼Œå°±æ˜¯åŸŸåå’Œsslé‡Œçš„ å¤‡ç”¨åç§°ä¸€è‡´ã€‚

![image-20240206155712189](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206155712189.png)





![image-20240206155541825](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206155541825.png)



å¦‚æœå°±è¦å®ç°http://www.baidu.com/daolian.htmlèƒ½å¤Ÿæ‰“å¼€å‘¢

å¯ä»¥ï¼Œå•ç‹¬å†™baiduå°±è¡Œäº†

![image-20240206163545898](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206163545898.png)

![image-20240206163735200](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206163735200.png)









# å¼€å§‹å­¦ä¹ nginxçš„åå‘ä»£ç†å’¯

æ­£å‘ä»£ç†åé¢ä¹Ÿè¦å­¦ä¹ ï¼Œåº”ç”¨åœ¨æ¯”å¦‚æ‰‹æœºçš„sslæŠ¥æ–‡æŠ“åŒ…è¦æŠ“åˆ°å†…å®¹çš„ï¼Œåšsslè§£å¯†çš„ã€‚åè¯è¿™é‡Œè®°ä¸€ä¸‹~



æ®è¯´nginxçš„åä»£è¿˜å¯ä»¥åšå¥åº·æ€§æ£€æŸ¥ï¼Œè¿™ç‚¹æ¯”LVSå¼ºï¼ŒLVSå¥½åƒæ²¡æœ‰å¥åº·æ€§æ£€æŸ¥ï¼Œæ®è¯´å“¦ã€‚

è€Œä¸”nginxå¯ä»¥åšåº”ç”¨å±‚å’ŒTCPå±‚çš„åä»£ï¼Œä¸è¿‡é€Ÿåº¦æ²¡æœ‰LVSå¿«æ®è¯´ã€‚LVSå¥½åƒå·¥ä½œåœ¨å†…æ ¸å±‚çš„ï¼Ÿ

![image-20240206181246911](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206181246911.png)





![image-20240206181536254](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206181536254.png)





![image-20240206181729908](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206181729908.png)







**æ¨¡å—æ”¯æŒ**

![image-20240206181940090](5-nginxåå‘ä»£ç†å®ç°.assets/image-20240206181940090.png)

1ã€proxyã€fastcgiã€uwsgiè¿™äº›éƒ½æ˜¯httpç±»çš„ï¼Œæ‰€ä»¥åå­—éƒ½æ˜¯ngx_httpå¼€å¤´çš„ã€‚

â€‹		1.1 ã€ proxyå°±æ˜¯nginxå¯¹æ¥httpåŸæœ¬åè®®ã€fastcgiå°±æ˜¯nginxå¯¹æ¥phpåè®®ã€uwsgiæ˜¯nginxå¯¹æ¥pythonåè®®

â€‹				1.1.1ã€ç¼–å†™åŠ¨æ€é¡µé¢ï¼Œå¯ä»¥ç”¨PHPã€pythonã€javaã€

â€‹							å¯¹äºjavaï¼Œå¦‚æœåç«¯æ˜¯ä¸€ä¸ªtomcatç±»ä¼¼çš„ï¼Œè¿™ä¸ªå°±ç”¨ngx_http_proxy_moduleæ¥æ”¯æŒäº†ã€‚



æ‰€ä»¥ï¼š

â€‹		å‰åç«¯æ˜¯java-tomcatä¹‹ç±»ï¼Œå°±ç”¨ngx_http_proxy_moduleäº†

â€‹		å‰åç«¯æ˜¯pythonï¼Œæ¯”å¦‚jangoï¼Œå°±ç”¨ngx_http_uwsgi_modueläº†

â€‹		å‰åç«¯æ˜¯phpï¼Œå°±ç”¨ngx_http_fastcgi_moduleäº†











