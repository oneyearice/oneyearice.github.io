# 第5节. 实现DNS子域委派和转发





![image-20230221102610667](5-实现DNS子域委派和转发.assets/image-20230221102610667.png) 





oneyearice算作父域，bejing、shanghai是子域，



### 1、如果父域和子域在一个机器上



shanghai.oneyearice.asia和oneyearice.asia放在同一台电脑上



根据前面章节学的内容，也就是一条A记录的事

www.shanghai A 192.168.100.100

<img src="5-实现DNS子域委派和转发.assets/image-20230221103601380.png" alt="image-20230221103601380" style="zoom:50%;" />  

<img src="5-实现DNS子域委派和转发.assets/image-20230221103346810.png" alt="image-20230221103346810" style="zoom:50%;" /> 

这样虽然有www.shanghai.oneyearice.aisa的解析看着有一个shanghai的子域，但是其实只是条A记录。

如果shanghai这个子域里的记录比较多，是可以独立出来成为单独的配置文件的。

比如

ftp.shanghai.

db.shanghai.

mysql.shanghai.

mail.shanghai.



管理上父域和子域属于集团不同部门或者子公司的权限下发，就需要独立开来。



独立出来就很简单，cp -a 一份出来 改改就行

<img src="5-实现DNS子域委派和转发.assets/image-20230221104825697.png" alt="image-20230221104825697" style="zoom:80%;" /> 



<img src="5-实现DNS子域委派和转发.assets/image-20230221105833874.png" alt="image-20230221105833874" style="zoom:50%;" /> 

修改一下zone域配置文件。然后这里有个快捷键挺好玩的，👇记一下可以。

<img src="5-实现DNS子域委派和转发.assets/image-20230221110053284.png" alt="image-20230221110053284" style="zoom:50%;" />  

虽然说是父子域，但是从配置角度上来讲，就是两个独立的zone。

![image-20230221110745068](5-实现DNS子域委派和转发.assets/image-20230221110745068.png)

  

![image-20230221110842585](5-实现DNS子域委派和转发.assets/image-20230221110842585.png)

 

这样父子域 还在同一个设备，从管理角度上还没有完全分开。除非你用facl去管理权限？

最好分开来合乎管理，下面就是学习 父子不在一起的场景。





### 2、如果父域和子域在不同机器上

其实就是子域委派，感觉就是NS写一下就好了，之前freenom里就这么写的。

<img src="5-实现DNS子域委派和转发.assets/image-20230221122100034.png" alt="image-20230221122100034" style="zoom:50%;" />  

上图有问题写错文件了，应该写道oneyearice.asia.zone这个父域文件里的NS记录，然后这个shanghai.oneyearice.aisa.zone的子域文件就可以删除了。



修改一下：

1、删除zone 配置文件

<img src="5-实现DNS子域委派和转发.assets/image-20230221122837636.png" alt="image-20230221122837636" style="zoom:50%;" /> 

2、删掉对应的zone file记录文件

<img src="5-实现DNS子域委派和转发.assets/image-20230221122924452.png" alt="image-20230221122924452" style="zoom:50%;" /> 

3、修改添加一条父域里，关于子域shanghai的NS记录，指向对应的服务器，这里就简单点，直接利用从了。之前从服务器，已经同步了主之前还有的shanghai.oneyearice.asia.zone子域记录文件了(文中未体现，其实就是在从那边配置了一个zone type slave并指明master，然后重启从的服务就拿到了。)，所以此时就可以解析了

<img src="5-实现DNS子域委派和转发.assets/image-20230221122231468.png" alt="image-20230221122231468" style="zoom:50%;" /> 

![image-20230221123256511](5-实现DNS子域委派和转发.assets/image-20230221123256511.png)

![image-20230221123353495](5-实现DNS子域委派和转发.assets/image-20230221123353495.png)



必须重启192.168.126.129这个主域上的named才能看到现象，因为有缓存的。

![image-20230221123549368](5-实现DNS子域委派和转发.assets/image-20230221123549368.png)



还原

![image-20230221123638244](5-实现DNS子域委派和转发.assets/image-20230221123638244.png)

不行还是，



![image-20230221123724992](5-实现DNS子域委派和转发.assets/image-20230221123724992.png)

重启服务试试



![image-20230221123906396](5-实现DNS子域委派和转发.assets/image-20230221123906396.png)

还是不行，会卡在这里

![image-20230221124044074](5-实现DNS子域委派和转发.assets/image-20230221124044074.png)

过一会就

![image-20230221124053621](5-实现DNS子域委派和转发.assets/image-20230221124053621.png)



找到原因了

![image-20230221131501535](5-实现DNS子域委派和转发.assets/image-20230221131501535.png) 



![image-20230221131516637](5-实现DNS子域委派和转发.assets/image-20230221131516637.png) 



![image-20230221131555949](5-实现DNS子域委派和转发.assets/image-20230221131555949.png)

可以了👆



补充：

每次修改主DNS的zone记录的时候，一定要记得递增版本号。





NS在很多地方都有看到，这是阿里的关于子域的NS

<img src="5-实现DNS子域委派和转发.assets/image-20230221133121955.png" alt="image-20230221133121955" style="zoom:50%;" /> 





腾讯上看看

![image-20230221133335464](5-实现DNS子域委派和转发.assets/image-20230221133335464.png)

还挺多，功能

不过我记得有oneyearice.asia这种一级域名的NS修改的，现在没找到。。。

还是说必须是www.oneyearice.asia这种，这种倒是直接就能写。





**如果是新开一台干净的机器来做子域**，

直接上图了，就这么着吧：

![image-20230221134900752](5-实现DNS子域委派和转发.assets/image-20230221134900752.png) 

![image-20230221134923523](5-实现DNS子域委派和转发.assets/image-20230221134923523.png) 

![image-20230221135011983](5-实现DNS子域委派和转发.assets/image-20230221135011983.png) 

![image-20230221135156263](5-实现DNS子域委派和转发.assets/image-20230221135156263.png) 

![image-20230221135227288](5-实现DNS子域委派和转发.assets/image-20230221135227288.png)



然后人家的报错

![image-20230221135558652](5-实现DNS子域委派和转发.assets/image-20230221135558652.png)



然后他就改了下图两项为no

![image-20230221151018943](5-实现DNS子域委派和转发.assets/image-20230221151018943.png)





![image-20230221151104250](5-实现DNS子域委派和转发.assets/image-20230221151104250.png)

然后就神奇的好了。反正我没改也成功，不过我的子域委派的那台其实是从啦，和他在这点上不一样。

![image-20230221151130499](5-实现DNS子域委派和转发.assets/image-20230221151130499.png)



我要新建一台试试了，NND

![image-20230221152153454](5-实现DNS子域委派和转发.assets/image-20230221152153454.png) 



![image-20230221152231661](5-实现DNS子域委派和转发.assets/image-20230221152231661.png)



![image-20230221152245106](5-实现DNS子域委派和转发.assets/image-20230221152245106.png) 

![image-20230221152312493](5-实现DNS子域委派和转发.assets/image-20230221152312493.png)

去到父域上修改ns记录👇

![image-20230221152758165](5-实现DNS子域委派和转发.assets/image-20230221152758165.png)



![image-20230221152901574](5-实现DNS子域委派和转发.assets/image-20230221152901574.png)



![image-20230221152908044](5-实现DNS子域委派和转发.assets/image-20230221152908044.png)

上图说明缓存没清除。



systemctl restart named就行，或者用rndc flush

![image-20230221152951824](5-实现DNS子域委派和转发.assets/image-20230221152951824.png)



![image-20230221152959077](5-实现DNS子域委派和转发.assets/image-20230221152959077.png)

这不好了嘛，也没有修改那两项啊，父域和子域dns服务器上都没有修改啊。

![image-20230221153027840](5-实现DNS子域委派和转发.assets/image-20230221153027840.png) 

注意缓存一直在，比如你现在修改子域的A记录为，加一条



![image-20230221153429759](5-实现DNS子域委派和转发.assets/image-20230221153429759.png)

然后子域DNS上reload

![image-20230221153442530](5-实现DNS子域委派和转发.assets/image-20230221153442530.png)



此时client dig结果不会变的

![image-20230221153502975](5-实现DNS子域委派和转发.assets/image-20230221153502975.png)



因为你问的还是父域，父域回你还是TTL时间内的缓存给你的，所以要flush一下

![image-20230221153541558](5-实现DNS子域委派和转发.assets/image-20230221153541558.png)

![image-20230221153557027](5-实现DNS子域委派和转发.assets/image-20230221153557027.png)

好啦。





### dig -t NS查看NS

![image-20230221160628905](5-实现DNS子域委派和转发.assets/image-20230221160628905.png)





腾讯还不显示，直接自己查

![image-20230221161106780](5-实现DNS子域委派和转发.assets/image-20230221161106780.png)

![image-20230221161049551](5-实现DNS子域委派和转发.assets/image-20230221161049551.png)



qq的ns

![image-20230221161316377](5-实现DNS子域委派和转发.assets/image-20230221161316377.png)

![image-20230221161257006](5-实现DNS子域委派和转发.assets/image-20230221161257006.png)





根的

![image-20230221161409084](5-实现DNS子域委派和转发.assets/image-20230221161409084.png)







![image-20230221161609091](5-实现DNS子域委派和转发.assets/image-20230221161609091.png)





![image-20230221161735513](5-实现DNS子域委派和转发.assets/image-20230221161735513.png)

上图ns1是master，其他都是slave；同样可见版本号就很大了，也不是以年月日NO来编写的。



![image-20230221162246504](5-实现DNS子域委派和转发.assets/image-20230221162246504.png)

阿里还不错，按官方推荐来编写的版本号



![image-20230221163204317](5-实现DNS子域委派和转发.assets/image-20230221163204317.png)







以上就完成了子域创建和委派，

### 然后研究下53端口的tcp和udp的情况

先上结论，client查询一般就是udp 53，子域委派也就是域间也是只有UDP53；主从复制的时候是TCP53和UDP53都有。



当前client 去问 子域的www.shanghai.oneyearice.asia的解析情况，这样涉及父域和子域的情况，用iptables进行查看

1、打开firewalld

![image-20230221164244718](5-实现DNS子域委派和转发.assets/image-20230221164244718.png)



2、放行udp 53

![image-20230221164213442](5-实现DNS子域委派和转发.assets/image-20230221164213442.png)





3、OK



![image-20230221164304482](5-实现DNS子域委派和转发.assets/image-20230221164304482.png)



说明client和dns server只需要UDP 53，



4、进一步研究父域和子域之间的53

去子域开启firewalld

![image-20230221164417445](5-实现DNS子域委派和转发.assets/image-20230221164417445.png)

清父域的缓存

![image-20230221164429046](5-实现DNS子域委派和转发.assets/image-20230221164429046.png)

报错

![image-20230221164454867](5-实现DNS子域委派和转发.assets/image-20230221164454867.png)

5、打开子域的tcp 53



![image-20230221164548644](5-实现DNS子域委派和转发.assets/image-20230221164548644.png)



测试 依然不行，

![image-20230221164609128](5-实现DNS子域委派和转发.assets/image-20230221164609128.png)

查看firewall的抓包记录看是否命中TCP 53

https://developer.aliyun.com/article/1100649

https://www.onitroad.com/jc/linux/sec/firewall/firewalld-log.html

![image-20230221165350206](5-实现DNS子域委派和转发.assets/image-20230221165350206.png)





![image-20230221165540522](5-实现DNS子域委派和转发.assets/image-20230221165540522.png)

明确可见udp 53被拒了，但是tcp 53 没看到，所以

6、子域firewall改放行UDP 53 tcp干掉。

![image-20230221165849378](5-实现DNS子域委派和转发.assets/image-20230221165849378.png)



测试，竟然就可以了

![image-20230221165943657](5-实现DNS子域委派和转发.assets/image-20230221165943657.png)



只需要UDP53，啊哈哈

![image-20230221170611880](5-实现DNS子域委派和转发.assets/image-20230221170611880.png)

记得client 上一次解析成功了，要去父域上flush缓存的

![image-20230221170654507](5-实现DNS子域委派和转发.assets/image-20230221170654507.png)

![image-20230221170736513](5-实现DNS子域委派和转发.assets/image-20230221170736513.png)

这个firewall不像iptables可以看到命中报文，有点不爽，估计是有其他方法我没找到。



然后考察主从复制的53是哪种L4协议

去从服务器上



![image-20230221171311271](5-实现DNS子域委派和转发.assets/image-20230221171311271.png)



将日志挂在那，然后去主上编辑一下，记得修改版本号



1、只是修改了master的版本号

![image-20230221171457507](5-实现DNS子域委派和转发.assets/image-20230221171457507.png)

2、然后看到从服务器有拒绝日志

![image-20230221171510925](5-实现DNS子域委派和转发.assets/image-20230221171510925.png)

说明UDP53存在

3、继续修改master的记录+调大版本号

<img src="5-实现DNS子域委派和转发.assets/image-20230221171638506.png" alt="image-20230221171638506" style="zoom:50%;" /> 



依然只有UDP 53 未见TCP53

![image-20230221171704204](5-实现DNS子域委派和转发.assets/image-20230221171704204.png)

放行防火墙的UDP53，同时用户解析也需要UDP的

![image-20230221171913792](5-实现DNS子域委派和转发.assets/image-20230221171913792.png)



client去dig下

![image-20230221171954894](5-实现DNS子域委派和转发.assets/image-20230221171954894.png)

发现named没开

开了，也要同步一下

<img src="5-实现DNS子域委派和转发.assets/image-20230221172242882.png" alt="image-20230221172242882" style="zoom:50%;" /> 

![image-20230221172252805](5-实现DNS子域委派和转发.assets/image-20230221172252805.png)



从服务器上还是没有同步

![image-20230221172311602](5-实现DNS子域委派和转发.assets/image-20230221172311602.png)



看看日志

![image-20230221172354379](5-实现DNS子域委派和转发.assets/image-20230221172354379.png)

这里就看到日志，但是不清楚是 要主的TCP53还是从的TCP53

1、放行从的TCP 53看看，虽然我觉得是from 129嘛应该是主的TCP，但是，就像小学老师说的，我这个人明知的情况下就爱绕路

然后我就去主上放行了tcp 53 ，啊哈哈哈哈~

<img src="5-实现DNS子域委派和转发.assets/image-20230221173203631.png" alt="image-20230221173203631" style="zoom:50%;" /> 

等等，看看之前没同步的，能否再retry

![image-20230221172645050](5-实现DNS子域委派和转发.assets/image-20230221172645050.png)

坐等10分钟，不管是从服务来啦，还是10M重试，都差不多了，15分钟吧

要是不成功，这个版本号就太讨厌了。

![image-20230221174838933](5-实现DNS子域委派和转发.assets/image-20230221174838933.png)

可以了，看来它还是知道这个同步没成功，会拉也好，会重试也好，这个点需要继续验证的，否则业务处理故障会模糊的。



### 结论：主从：①是从服务器需要访问主的tcp53；②主服务器需要访问从的udp53。

进一步测试

![image-20230221184450506](5-实现DNS子域委派和转发.assets/image-20230221184450506.png)



![image-20230221184847595](5-实现DNS子域委派和转发.assets/image-20230221184847595.png)

看来从服务器需要访问主的tcp和udp 53，都要访问的

从上的日志倒没有具体的UDP 和TCP的 字眼

![image-20230221184951766](5-实现DNS子域委派和转发.assets/image-20230221184951766.png)



放开主的tcp

![image-20230221185151584](5-实现DNS子域委派和转发.assets/image-20230221185151584.png)







![image-20230221185309163](5-实现DNS子域委派和转发.assets/image-20230221185309163.png)

![image-20230221185331690](5-实现DNS子域委派和转发.assets/image-20230221185331690.png)

上图没有提示了--在从服务器上，说明从服务器的消息是TCP的，正所谓TCP才会有一些完善的报错回显，可靠啊，而UDP正应了那句话，丢了就丢了。

![image-20230221185532684](5-实现DNS子域委派和转发.assets/image-20230221185532684.png) 

坐等同步，因为此时从服务器上的版本号肯定是低的，因为之前没同步过去啊。

![image-20230221185650163](5-实现DNS子域委派和转发.assets/image-20230221185650163.png)

![image-20230221185709739](5-实现DNS子域委派和转发.assets/image-20230221185709739.png)



1M？还是10M，哈哈，有懵逼了，应该是1M没成功啊，刚才firewall调整的1M的拉肯定失败，不过1M不是周期的嘛，1M也应该重新拉了啊，

![image-20230221185812705](5-实现DNS子域委派和转发.assets/image-20230221185812705.png)

反正之前失败1M周期到了没有拉--从没有拉

然后等10M再看吧，

我就不加版本号。

👇有了大概过了也不到10分钟

![image-20230221190205647](5-实现DNS子域委派和转发.assets/image-20230221190205647.png)



![image-20230221190237655](5-实现DNS子域委派和转发.assets/image-20230221190237655.png)

最新的两个A记录都过来了

![image-20230221190259428](5-实现DNS子域委派和转发.assets/image-20230221190259428.png)





























