# 05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….md





https://sq.sf.163.com/blog/article/218148356914737152



ä½¿ç”¨virtio_blké©±åŠ¨çš„ç¡¬ç›˜æ˜¾ç¤ºä¸º/dev/vdaï¼Œä½¿ç”¨IDEç¡¬ç›˜æ˜¾ç¤ºä¸º/dev/hadï¼Œä½¿ç”¨SATAç¡¬ç›˜æ˜¾ç¤º/dev/sda



![image-20251231160346471](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20251231160346471.png)

æˆ‘çš„æ˜¯vmware workstationçš„vmæ¥åškvmæµ‹è¯•çš„ï¼Œæ²¡æœ‰virtioæ˜¯è‡ªç„¶çš„ï¼Œå› ä¸ºvirtioæ˜¯kvmé‡Œçš„æŠ€æœ¯ã€‚



ä¸‹è½½åœ°å€

https://github.com/virtio-win/virtio-win-pkg-scripts?tab=readme-ov-file



# æµ‹è¯•virtioæ€§èƒ½

æµ‹è¯•å†™é€Ÿåº¦

```shell
fio --name=write \
    --filename=/tmp/fio_test \
    --rw=write \
    --bs=1M \
    --size=2G \
    --direct=1 \
    --iodepth=16
```

æµ‹è¯•è¯»é€Ÿåº¦

```shell
fio --name=read \
    --filename=/tmp/fio_test \
    --rw=read \
    --bs=1M \
    --direct=1 \
    --iodepth=16
```



å¦‚ä½•ç”¨ä¸åŒå·¥å…·æµ‹è¯•æœºå™¨æ€§èƒ½ï¼ŒåŒ…æ‹¬ç£ç›˜æ€§èƒ½ã€CPUã€å†…å­˜ã€ç½‘ç»œç­‰ï¼ŒåŒæ—¶å®‰å…¨å¯é åœ°æ“ä½œã€‚æˆ‘ä»¬é‡ç‚¹å…ˆè®²ç£ç›˜ï¼Œç„¶åæ‰©å±•åˆ°æ•´æœºæ€§èƒ½æµ‹è¯•ã€‚

------

## ç£ç›˜æ€§èƒ½æµ‹è¯•å·¥å…·

### **(A) hdparm**

- **ç”¨é€”**ï¼šé¡ºåºè¯»æµ‹è¯•ã€ç¼“å­˜è¯»æµ‹è¯•
- **å‘½ä»¤ç¤ºä¾‹**ï¼š

```bash
# æµ‹è¯•ç£ç›˜ç¼“å­˜è¯»å–é€Ÿåº¦ï¼ˆä¸è®¿é—®ç£ç›˜ï¼‰
hdparm -T /dev/sda

# æµ‹è¯•å®é™…ç£ç›˜é¡ºåºè¯»å–é€Ÿåº¦
hdparm -t /dev/sda
```

- **ç‰¹ç‚¹**ï¼š
  - éç ´åæ€§ï¼Œå¿«é€Ÿ
  - åªæµ‹è¯»å–ï¼Œä¸æµ‹å†™å…¥
  - é¡ºåºè¯»ï¼Œä¸é€‚åˆåæ˜ éšæœº I/O æ€§èƒ½

------

### **(B) dd**

- **ç”¨é€”**ï¼šé¡ºåºè¯»å†™æµ‹è¯•ï¼Œå¯ä»¥æµ‹è¯•å†™å…¥æ€§èƒ½
- **å‘½ä»¤ç¤ºä¾‹**ï¼š

```bash
# é¡ºåºå†™æµ‹è¯•ï¼ˆæ³¨æ„ä¸è¦å†™åˆ°ç³»ç»Ÿç›˜ï¼‰ è·³è¿‡buffer ç›´æ¥å†™ç£ç›˜
dd if=/dev/zero of=/tmp/testfile bs=1M count=1024 oflag=direct

# é¡ºåºå†™æµ‹è¯•ï¼ˆæ³¨æ„ä¸è¦å†™åˆ°ç³»ç»Ÿç›˜ï¼‰é»˜è®¤ä½¿ç”¨ç³»ç»Ÿbuffer
dd if=/dev/zero of=/tmp/testfile bs=1M count=1024

 
# é¡ºåºè¯»æµ‹è¯•ï¼Œè·³è¿‡ç³»ç»Ÿcacheç›´æ¥è¯»ç£ç›˜ã€‚
dd if=/tmp/testfile of=/dev/null bs=1M iflag=direct

# é¡ºåºè¯»æµ‹è¯• ä½¿ç”¨ç³»ç»Ÿcache
dd if=/tmp/testfile of=/dev/null bs=1M
```

- **ç‰¹ç‚¹**ï¼š
  - ç®€å•ã€å¯æµ‹å†™å…¥å’Œè¯»å–
  - å¯ä»¥ç›´æ¥æ§åˆ¶å—å¤§å°ã€æ–‡ä»¶å¤§å°
  - å†™åˆ°ç³»ç»Ÿç›˜å±é™©ï¼Œè¦ç”¨ `/tmp` æˆ–ç‹¬ç«‹æµ‹è¯•ç›˜

![image-20251231170708577](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20251231170708577.png)

------

### **(C) fioï¼ˆæ¨èï¼‰**

- **ç”¨é€”**ï¼šä¸“ä¸š I/O å‹åŠ›æµ‹è¯•ï¼Œæ”¯æŒé¡ºåº/éšæœºè¯»å†™ã€å¤šé˜Ÿåˆ—æ·±åº¦
- **ç¤ºä¾‹å‘½ä»¤**ï¼šç»•è¿‡ç¼“å­˜--direct=1

```bash
# é¡ºåºå†™ï¼Œå¼‚æ­¥ I/Oï¼Œ16 é˜Ÿåˆ—æ·±åº¦ï¼Œ
fio --name=seq_write --filename=/tmp/fio_test \
    --rw=write --bs=1M --size=2G \
    --direct=1 --iodepth=16 --ioengine=libaio

# é¡ºåºè¯»ï¼Œå¼‚æ­¥ I/Oï¼Œ16 é˜Ÿåˆ—æ·±åº¦ï¼Œç»•è¿‡ç¼“å­˜
fio --name=seq_read --filename=/tmp/fio_test \
    --rw=read --bs=1M --size=2G \
    --direct=1 --iodepth=16 --ioengine=libaio

# éšæœºå†™ï¼Œå¼‚æ­¥ I/Oï¼Œ32 é˜Ÿåˆ—æ·±åº¦ï¼Œ4KB å—
fio --name=rand_write --filename=/tmp/fio_test \
    --rw=randwrite --bs=4k --size=2G \
    --direct=1 --iodepth=32 --ioengine=libaio

# éšæœºè¯»ï¼Œå¼‚æ­¥ I/Oï¼Œ32 é˜Ÿåˆ—æ·±åº¦ï¼Œ4KB å—
fio --name=rand_read --filename=/tmp/fio_test \
    --rw=randread --bs=4k --size=2G \
    --direct=1 --iodepth=32 --ioengine=libaio

# éšæœºè¯»å†™æ··åˆï¼Œå¼‚æ­¥ I/Oï¼Œ32 é˜Ÿåˆ—æ·±åº¦ï¼Œ70% è¯» / 30% å†™
fio --name=rand_rw --filename=/tmp/fio_test \
    --rw=randrw --bs=4k --size=2G \
    --rwmixread=70 --direct=1 --iodepth=32 --ioengine=libaio

```

- **ç‰¹ç‚¹**ï¼š
  - å¯ç²¾ç»†æ§åˆ¶ I/O æ¨¡å¼ã€å—å¤§å°ã€å¹¶å‘æ·±åº¦
  - å¯è¾“å‡ºè¯¦ç»†æ€§èƒ½æŒ‡æ ‡ï¼ˆIOPSã€å»¶è¿Ÿã€å¸¦å®½ï¼‰
  - å¯å®‰å…¨æµ‹è¯•ï¼Œåªè¦å†™åˆ°æ™®é€šæ–‡ä»¶æˆ–ç‹¬ç«‹ç£ç›˜

------

ä¸¤æ¬¡æµ‹è¯•ï¼Œç»“è®ºï¼šç¼“å­˜ä¸ºç‹

â‘ è·³è¿‡ç¼“å†²

![image-20251231174632508](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20251231174632508.png)

â‘¡é€šè¿‡ç¼“å†²

![image-20251231174802145](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20251231174802145.png)



â‘¢è·³è¿‡ç¼“å†²

![image-20251231174853069](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20251231174853069.png)

â‘£ä¸è·³è¿‡ç¼“å†²

![image-20251231174915595](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20251231174915595.png)





## æ¨¡æ¿clone

linux æ²¡å•¥é—®é¢˜ä¸éœ€è¦å¤„ç†å•¥å°±å¯ä»¥å½“æ¨¡æ¿ï¼Œ

windowså½“æ¨¡æ¿ï¼Œè¦æ³¨æ„ä¸»æœºåå’ŒSIDï¼Œè¦æ¸…ç†æ‰ï¼Œå†åšæ¨¡æ¿ğŸ‘‡è¿™é‡Œç”¨vm002è¿™å°win2016æ¥åšï¼š

![image-20260104113647638](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20260104113647638.png)



<img src="05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20260104112408748.png" alt="image-20260104112408748" style="zoom:50%;" />



<img src="05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20260104113734028.png" alt="image-20260104113734028" style="zoom:50%;" />



```shell
virt-clone -o vm002 -n vm006-win2016 -f /var/lib/libvirt/images/vm006-win2016.qcow2
```



![image-20260104115703437](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20260104115703437.png)



#### ç›´æ¥åˆ é™¤å…‰é©±ï¼ˆå¦‚æœä¸éœ€è¦å®‰è£…å…‰ç›˜ï¼‰

```
virsh edit vm006-win2016
```

- åˆ é™¤ `<disk device='cdrom'>` å¯¹åº”çš„æ•´ä¸ª `<disk>` èŠ‚ç‚¹
- ä¿å­˜é€€å‡º
- å¯åŠ¨è™šæ‹Ÿæœºå³å¯



### win2008r2cloneçš„é—®é¢˜

![image-20260104164933701](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20260104164933701.png)

![image-20260104170735272](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20260104170735272.png)



![image-20260104171027985](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20260104171027985.png)



ä½†å…¶å®æ–°ç‰ˆæœ¬çš„æœºå™¨æ¯”å¦‚rokcy 9.7 virtsh listå°±ä¸ä¾é libvirtdæœåŠ¡äº†

![image-20260104174125786](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20260104174125786.png)



![image-20260104174436808](05.KVMè™šæ‹Ÿæœºç®¡ç†VirtIOé©±åŠ¨å®‰è£….assets/image-20260104174451994.png)



------

## ä¸€ã€ä¸€å¥è¯ç»“è®ºï¼ˆé‡ç‚¹ï¼‰

> **`virsh list` ä¸æ˜¯â€œå¿…é¡»â€ä¾èµ– `libvirtd.service`**
>
> åœ¨ **æ–°ç‰ˆæœ¬ libvirt** é‡Œï¼š
>
> ğŸ‘‰ **`virsh` å®é™…è¿çš„æ˜¯ `virtqemud`ï¼ˆè€Œä¸æ˜¯ libvirtdï¼‰**
>
> æ‰€ä»¥ä½ ç°åœ¨çœ‹åˆ°çš„æ˜¯ï¼š
>
> - âŒ `libvirtd.*` å…¨éƒ¨ dead
> - âœ… `virsh list --all` æ­£å¸¸è¿”å›

**è¿™æ˜¯â€œæ­£ç¡®ä¸”å¥åº·â€çš„çŠ¶æ€ï¼Œä¸æ˜¯å¼‚å¸¸ã€‚**

------

## äºŒã€ä½ ç°åœ¨å¤„åœ¨å“ªä¸ªæ—¶ä»£ï¼Ÿ

ä½ è¿™å°æœºå™¨å±äºï¼š

> **libvirt â€œæ‹†åˆ†å®ˆæŠ¤è¿›ç¨‹â€æ—¶ä»£ï¼ˆRHEL / Rocky / Alma 8+ï¼‰**

### è€æ¶æ„ï¼ˆä½ ä»¥ä¸ºçš„ï¼‰

```text
virsh
  â†“
libvirtd
  â†“
qemu-kvm
```

------

### æ–°æ¶æ„ï¼ˆä½ å®é™…ç”¨çš„ï¼‰

```text
virsh
  â†“
libvirt client library
  â†“
virtqemud      â† ç®¡ç†è™šæœº
virtnetworkd  â† ç®¡ç†ç½‘ç»œ
virtstoraged  â† ç®¡ç†å­˜å‚¨
  â†“
qemu-kvm
```

ğŸ‘‰ **`libvirtd` å·²ç»é€€å±…äºŒçº¿ï¼ˆlegacyï¼‰**

------

## ä¸‰ã€é€æ¡è§£é‡Šä½ è¿™æ®µè¾“å‡ºï¼ˆé‡ç‚¹å¯¹å·å…¥åº§ï¼‰

### 1ï¸âƒ£ virsh ä¸ºä»€ä¹ˆèƒ½åˆ—å‡ºè™šæœºï¼Ÿ

```bash
virsh list --all
```

è¿”å›æ­£å¸¸ï¼š

```text
1    vm001           running
```

è¯´æ˜ï¼š

- `virsh` æˆåŠŸè¿æ¥åˆ°äº† **libvirt socket**
- åç«¯æœ‰ **virtqemud** åœ¨å“åº”

------

### 2ï¸âƒ£ libvirtd.socket ä¸ºå•¥æ˜¯ deadï¼Ÿ

```text
libvirtd.socket  Active: inactive (dead)
```

è¿™æ˜¯å› ä¸ºï¼š

- **virtqemud å·²ç»åœ¨ç›‘å¬ qemu çš„ socket**
- systemd ä¸å†è‡ªåŠ¨æ‹‰èµ· `libvirtd`

è¿™æ˜¯ **å®˜æ–¹è®¾è®¡è¡Œä¸º**ï¼Œä¸æ˜¯ bug

------

### 3ï¸âƒ£ â€œTriggers: libvirtd.serviceâ€ æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

```text
Triggers: â— libvirtd.service
```

æ„æ€æ˜¯ï¼š

> **å¦‚æœæœ‰äººéè¦è¿ legacy socketï¼Œsystemd æ‰ä¼šæ‹‰èµ· libvirtd**

ä½†ä½ ç°åœ¨ï¼š

- virsh èµ°çš„æ˜¯ **æ–° socket**
- virt-manager ä¹Ÿæ˜¯

ğŸ‘‰ **æ‰€ä»¥ libvirtd æ°¸è¿œä¸ä¼šè¢«æ‹‰èµ·**

------

## å››ã€éªŒè¯ä½ çœŸæ­£ä¾èµ–çš„æ˜¯è°ï¼ˆå»ºè®®ä½ äº²è‡ªè·‘ï¼‰

### ğŸ” çœ‹ virtqemud çŠ¶æ€

```bash
systemctl status virtqemud
```

ä½ å¤§æ¦‚ç‡ä¼šçœ‹åˆ°ï¼š

```text
Active: active (running)
```

------

### ğŸ” çœ‹ virsh å®é™…è¿çš„ URI

```bash
virsh uri
```

é€šå¸¸ä¼šæ˜¯ï¼š

```text
qemu:///system
```

è¿™åœ¨æ–°æ¶æ„ä¸‹ï¼š

ğŸ‘‰ **é»˜è®¤èµ° virtqemud**

------

### ğŸ” çœ‹ socket

```bash
ss -lx | grep libvirt
```

ä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š

```text
/run/libvirt/virtqemud-sock
```

è€Œä¸æ˜¯ `libvirtd-sock`

------

## äº”ã€ä¸ºä»€ä¹ˆå¾ˆå¤šæ–‡æ¡£è¿˜åœ¨è¯´â€œä¾èµ– libvirtdâ€ï¼Ÿï¼ˆå†å²åŒ…è¢±ï¼‰

å› ä¸ºï¼š

- **90% çš„ä¸­æ–‡æ•™ç¨‹è¿˜åœç•™åœ¨ CentOS 7**
- é‚£ä¸ªæ—¶ä»£åªæœ‰ `libvirtd`

ä½†ç°åœ¨ï¼š

| ç³»ç»Ÿ        | æ¨è          |
| ----------- | ------------- |
| CentOS 7    | libvirtd      |
| Rocky 8 / 9 | **virtqemud** |
| Ubuntu 22+  | virtqemud     |

------

## å…­ã€ä½ è¿™ä¸ªçŠ¶æ€åˆ°åº•â€œå¯¹ä¸å¯¹â€ï¼Ÿ

### âœ… éå¸¸å¯¹ï¼Œè€Œä¸”æ˜¯ **æœ€ä½³å®è·µçŠ¶æ€**

ä½ çš„ç°çŠ¶ï¼š

- libvirtdï¼šå…³ç€
- virtqemudï¼šåœ¨è·‘
- virshï¼šèƒ½ç”¨
- VMï¼šæ­£å¸¸è¿è¡Œ

ğŸ‘‰ **è¿™æ˜¯ libvirt å®˜æ–¹æ¨èå½¢æ€**

------

## ä¸ƒã€ä»€ä¹ˆæ—¶å€™ä½ â€œå¿…é¡»â€å¯ libvirtdï¼Ÿ

åªæœ‰è¿™å‡ ç§æƒ…å†µï¼š

1. **è€å·¥å…·åªæ”¯æŒ libvirtd**
2. **ç¬¬ä¸‰æ–¹ç›‘æ§ç¡¬ç¼–ç  legacy socket**
3. **æè€ç‰ˆæœ¬ virt-manager**

å¦åˆ™ï¼š

> **ä¸å»ºè®®å†ä¸»åŠ¨å¯ libvirtd**

------

