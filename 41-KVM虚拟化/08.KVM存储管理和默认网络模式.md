# 08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.md



# 1ã€VMware Linux â†’ KVM æ­£ç¡®è¿ç§»æµç¨‹



è¦è½¬æ¢çš„æœºå™¨æ˜¯R5ï¼Œæœ‰å¿«ç…§2ä¸ªï¼Œè¿™é‡Œå°±è¦æ³¨æ„äº†ï¼Œæœ‰å¿«ç…§çš„è¦åˆå¹¶ï¼Œåˆå¹¶æ³•æœ‰2ï¼Œç”¨å…‹éš†æœ€å¿«~

![image-20260115163904597](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260115163904597.png)







### 1ï¸âƒ£ åœ¨ VMware è™šæ‹Ÿæœºä¸­å‡†å¤‡å†…æ ¸æ”¯æŒ

1. ç¡®è®¤å†…æ ¸é‡Œ **virtio é©±åŠ¨ + LVM** å¯ç”¨ï¼š

```bash
lsinitrd /boot/initramfs-$(uname -r).img | grep -i virtio
```

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260115164121305.png" alt="image-20260115164121305" style="zoom:50%;" />

å¯è§æ²¡æœ‰kvmçš„virtioé©±åŠ¨ï¼Œæ‰€ä»¥å³ä½¿è½¬æˆqcow2ï¼Œå¯åŠ¨ä¹Ÿæ˜¯è®¤ä¸åˆ°ç›˜çš„ã€‚

1. å®‰è£…å¿…è¦å·¥å…·ï¼š

```bash
yum -y install epel-release
yum install -y dracut-tools dracut dracut-config-generic lvm2
```

1. é‡æ–°ç”Ÿæˆ initramfsï¼ŒåŠ å…¥ virtio å’Œ LVM é©±åŠ¨ï¼š

```bash
dracut -f -v --add-drivers "virtio virtio_pci virtio_blk virtio_scsi" --add "lvm" /boot/initramfs-kvm.img $(uname -r)
cp -a  /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.bak
cp -a /boot/grub2/grub.cfg //boot/grub2/grub.cfg.bak
mv /boot/initramfs-kvm.img /boot/initramfs-$(uname -r).img
grub2-mkconfig -o /boot/grub2/grub.cfg
```

âœ… è¿™æ ·ç¡®ä¿ KVM å¯åŠ¨æ—¶èƒ½è¯†åˆ« virtio ç£ç›˜å’Œ LVM å·ã€‚

------

###  2ï¸âƒ£ ä» VMware å¯¼å‡ºé•œåƒå¹¶è½¬æ¢

R5è¿™ä¸ªVMæœ‰2å¿«ç…§ï¼Œç„¶åæ–°æ•°æ®å…¶å®éƒ½æ˜¯è½åœ¨æœ€è¿‘çš„ä¸€ä¸ªå¿«ç…§2é‡Œçš„

##### åˆå¹¶å¿«ç…§çš„æ–¹æ³•1-ä½¿ç”¨clié’ˆå¯¹æœ€åçš„ä¸€ä¸ªå¿«ç…§å°±

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260115165901973.png" alt="image-20260115165901973" style="zoom:50%;" />

ä¸‹è½½å¯¹åº”æ“ä½œç³»ç»Ÿçš„ VDDK åï¼Œè§£å‹å¹¶åœ¨ `bin` ç›®å½•ä¸‹å³å¯æ‰¾åˆ° `vmware-vdiskmanager`

https://developer.broadcom.com/sdks/vmware-virtual-disk-development-kit-vddk/latest



```
# vmware-vdiskmanager.exe -r æœ€åä¸€ä¸ªå¿«ç…§ 

vmware-vdiskmanager.exe -r "D:\Virtual Machines\R4\RockeyLinux-cl3-000002.vmdkâ€œ -t 0 "E:\all.vmdk"

# è¿™é‡Œå¾ˆå‘ï¼Œä¸€å®šè¦ç”¨æœ€åä¸€ä¸ªå¿«ç…§å»ä½œä¸ºæ•´åˆçš„çº¿ç´¢ï¼Œå¦åˆ™å¾’åŠ³ï¼›è¦ä¸ä½ å°±å…‹éš†å½“å‰çŠ¶æ€ä¸ºä¸€ä¸ªæ–°çš„VMï¼Œæ•ˆæœå’Œè¿™ä¸ªcliä¸€æ ·çš„æ•ˆæœã€‚
```

![image-20260119093843441](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119093843441.png)

![image-20260119094423862](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119094423862.png)



##### åˆå¹¶å¿«ç…§çš„æ–¹æ³•2-å…‹éš†å®Œæ•´çš„å½“å‰çŠ¶æ€

> å³é”®-å…‹éš†-è™šæ‹Ÿæœºå½“å‰çŠ¶æ€-åˆ›å»ºå®Œæ•´å…‹éš†

![image-20260119094452899](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119094452899.png)

ä¸¤ç§æ–¹æ³•åšå‡ºæ¥çš„vmdkæ˜¯ä¸€æ ·çš„ï¼Œè™½ç„¶md5ä¸åŒï¼Œä½†ä¸œè¥¿æ˜¯ä¸€æ ·çš„ï¼ˆé’ˆå¯¹ä¸¤ä¸ªvmdkåˆ†åˆ«è¿›è¡Œè½¬æ¢å’Œå¼€æœºï¼‰



æŠŠè¿™ä¸ªåˆå¹¶åçš„vmdkä¼ åˆ°linuxé‡Œè¿›è¡Œè½¬æ¢

```bash
qemu-img convert -f vmdk -O qcow2 æºVM.vmdk vm_trans.qcow2
```

![image-20260119100113600](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119100113600.png)



![image-20260119101439624](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119101439624.png)



------

### 3ï¸âƒ£ æ”¾åˆ° libvirt ç›®å½•å¹¶è°ƒæ•´æƒé™

```bash
cp vm_trans.qcow2 /var/lib/libvirt/images/
chown qemu.qemu /var/lib/libvirt/images/vm_trans.qcow2
chmod 600 /var/lib/libvirt/images/vm_trans.qcow2
```



------

### 4ï¸âƒ£ åˆ›å»º KVM è™šæ‹Ÿæœº

```bash
# --machine pc-q35-rhel9.0.0 æ˜¯å¯¹çš„ ï¼Œä½†è¦destroyå†startæ‰èƒ½åœ¨virt-manageræ‰“å¼€, ç¬¬äºŒæ¬¡å¼„å‘ç°ä¹Ÿä¸ä¸€å®šè¦è¿™ä¹ˆå¼„ä¸€ä¸‹
# ä¸èƒ½ç”¨--extra-args å‚æ•°åªèƒ½ä¸ --locationï¼ˆç½‘ç»œ/æœ¬åœ°ä»‹è´¨å®‰è£…ï¼‰æˆ– --kernel/--initrd é…åˆä½¿ç”¨ï¼Œè€Œä¸èƒ½ç”¨äº --importï¼ˆå¯¼å…¥ç°æœ‰ç£ç›˜é•œåƒï¼‰ï¼›
# ä¹Ÿä¸èƒ½ç”¨-boot

# ä»¥ä¸‹cli ä¸€æŠŠæˆå‹ğŸ‘‡ï¼šå°±æ˜¯consoleè¿›ä¸å»äº†ï¼Œè¦ç”¨vncè¿›å»æˆ–ç”¨virt-manager
virt-install \
--name r5-1 \
--memory 2048 \
--vcpus 2 \
--cpu host-model \
--machine pc-q35-rhel9.0.0 \
--os-variant rocky9 \
--disk path=/var/lib/libvirt/images/r5.qcow2,bus=virtio,cache=none \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--graphics vnc \
--console pty,target_type=serial \
--import &

```

> å¯é€‰ï¼šå¦‚æœå®¿ä¸»æœºæ”¯æŒ `pc-q35-rhel9.0.0`ï¼Œå¯ä»¥åœ¨ XML ä¸­æ‰‹åŠ¨ä¿®æ”¹ `<type machine='pc-q35-rhel9.0.0'>hvm</type>`ï¼Œ**ä½†ä¸ä¸€å®šéœ€è¦åœ¨ virt-install å‘½ä»¤é‡ŒæŒ‡å®š**ã€‚--è¿™ä¸ªå°±ç®—äº†å§ï¼Œæ¨èç”¨ä¸Šé¢çš„cliç›´æ¥æŒ‡å®šã€‚

------

![image-20260119102747660](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119102747660.png)

ä¸¤ä¸ªwarningæ²¡äº‹ï¼Œä¸€ä¸ªæ˜¯x11ï¼Œæœ¬æ¥æˆ‘å°±ä¸ç”¨è¯´åœ¨è¿œç«¯ç”¨x11ï¼Œæˆ‘æ˜¯windowså®‰è£…x11ï¼Œcmdé‡Œçš„virt-managerè¿œç¨‹è¿æ¥è¿‡å»çš„ã€‚ç”Ÿäº§ä¸­ä¹Ÿä¸ä¼šæœ‰ä»€ä¹ˆæœºå™¨ç»™ä½ x11ã€‚

ç¬¬äºŒä¸ªwariningæ˜¯consoleè¿›ä¸å»ï¼Œè¿™ä¸ªæ˜¯vmwareçš„vmdkè½¬è¿‡æ¥çš„ï¼Œæœ¬æ¥å°±æ²¡æœ‰consoleé…ç½®ï¼Œæ‰€ä»¥è¦guiè¿›å»ï¼Œäº‹åå¢è¡¥å€’æ˜¯å¯ä»¥çš„ã€‚



éªŒè¯å…‹éš†æ•´åˆçš„vmdkæ˜¯å¦å’Œcliæ•´åˆçš„vmdkä¸€æ ·

![image-20260119112649911](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119112649911.png)

å¼€æœºè¿›å»ï¼Œå‘ç°ä¸‰ä¸ªç³»ç»Ÿé‡Œ(vmdkã€cliåˆå¹¶çš„vmdkã€å…‹éš†åˆå¹¶çš„vmdk)çš„root/ä¸‹éƒ½æœ‰ä¹‹å‰åˆ›å»ºçš„f001æ–‡ä»¶

![image-20260119113250255](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119113250255.png)



# 2ã€å†å¢è¡¥ä¸€ä¸ªconsoleæ–¹ä¾¿åé¢ç»´æŠ¤

ä½ è¿™ä¸ªåœºæ™¯æ˜¯ **VM å·²å®‰è£…ç³»ç»Ÿ â†’ æƒ³å¼€ä¸²å£ console**ï¼Œå”¯ä¸€å¯é çš„æ–¹å¼æ˜¯ï¼š

### 1ï¸âƒ£ é€šè¿‡ grub é…ç½® kernel args

1. å…ˆå¯åŠ¨ VMï¼ˆç”¨ VNC æˆ–é»˜è®¤ graphicsï¼‰
2. ç™»å½•ç³»ç»Ÿ
3. æ‰§è¡Œï¼š

```shell
cp -a /boot/grub2/grub.cfg /boot/grub2/grub.cfg.bak.$(date +%F-%H%M)
cp -a /etc/default/grub /etc/default/grub.bak.$(date +%F-%H%M)
grubby --info=ALL > ~/kernel_args_bak.$(date +%F-%H%M)  # è¿™é‡Œæ˜¯å‚æ•°è®°å½•ä¸‹ï¼Œå¦‚æœ‰æœ‰é—®é¢˜æ‰‹åŠ¨åˆ é™¤åŠ ä¸Šå»çš„å‚æ•°ï¼Œæ­£å¸¸æ²¡å•¥é—®é¢˜ï¼Œå°±è¿™ä¹ˆæ•²å°±è¡Œï¼Œå·²éªŒè¯å¤šæ¬¡ã€‚
#grubby --update-kernel=ALL --remove-args="console=ttyS0,115200n8"


sudo grubby --update-kernel=ALL --args="console=ttyS0,115200n8"
sudo systemctl enable serial-getty@ttyS0.service
sudo systemctl start serial-getty@ttyS0.service
```

1. é‡å¯ VMï¼š

```
virsh reboot r5-1
```

1. å†ç”¨ï¼š

```
virsh console r5-1
```

âœ… ä½ å°±èƒ½çœ‹åˆ°ç™»å½•æç¤º



**å…·ä½“æ“ä½œæˆªå›¾å¦‚ä¸‹ğŸ‘‡**

![image-20260119113712504](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119113712504.png)



![image-20260119113841319](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119113841319.png)

å¯åŠ¨å°±OK

![image-20260119113856616](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260119113856616.png)





# 3ã€ä»¥ä¸‹æ˜¯åå¤æµ‹è¯•è¿‡ç¨‹è®°å½•ï¼Œç•™ç€



## æ“ä½œè®°å½•1

å°†vmdkè½¬æˆqcow2

æŠŠwindowsçš„vmware workstationé‡Œçš„è™šæ‹Ÿæœºçš„vmå¤åˆ¶åˆ°linuxé‡Œ

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109113508132.png" alt="image-20260109113508132" style="zoom:50%;" />

è¿™é€‰æ‹©ä»…å¤„ç†baseé•œåƒçœ‹çœ‹æ•ˆæœï¼Œåº”è¯¥æ˜¯æœ‰é—®é¢˜çš„

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109114037182.png" alt="image-20260109114037182" style="zoom:50%;" />

å…ˆè¯•è¯•çœ‹

```shell
qemu-img convert -f vmdk -O qcow2 RockeyLinux-cl3.vmdk vm_trans_01.qcow2
cp vm_trans_01.qcow2  /var/lib/libvirt/images/
chmod 600 /var/lib/libvirt/images/vm_trans_01.qcow2
chown qemu.qemu vm_trans_02.qcow2


# --machine pc-q35-rhel9.0.0 æ˜¯å¯¹çš„ ï¼Œä½†è¦destroyå†startæ‰èƒ½åœ¨virt-manageræ‰“å¼€
virt-install \
--name vmware-trans-kvm \
--memory 2048 \
--vcpus 2 \
--cpu host-model \
--machine pc-q35-rhel9.0.0 \
--os-variant rocky9 \
--disk path=/var/lib/libvirt/images/vmware-trans-kvm.qcow2,bus=virtio,cache=none \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--graphics vnc \
--console pty,target_type=serial \
--import &

```

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109113644521.png" alt="image-20260109113644521" style="zoom:50%;" />

![image-20260109113928309](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109113928309.png)

å¼€ä¸äº†æœºå™¨ï¼Œæ¢æ–¹æ¡ˆ



![image-20260109182407864](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109182407864.png)

```cmd
# vmware-vdiskmanager.exe -r æœ€åä¸€ä¸ªå¿«ç…§ 

vmware-vdiskmanager.exe -r "D:\Virtual Machines\R4\RockeyLinux-cl3-000002.vmdkâ€ -t 0 "E:\all.vmdk"


# è¿™é‡Œå¾ˆå‘ï¼Œä¸€å®šè¦ç”¨æœ€åä¸€ä¸ªå¿«ç…§å»ä½œä¸ºæ•´åˆçš„çº¿ç´¢ï¼Œå¦åˆ™å¾’åŠ³ï¼›è¦ä¸ä½ å°±å…‹éš†å½“å‰çŠ¶æ€ä¸ºä¸€ä¸ªæ–°çš„VMï¼Œæ•ˆæœå’Œè¿™ä¸ªcliä¸€æ ·çš„æ•ˆæœã€‚

```

![image-20260109155103150](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109155103150.png)







## **æ“ä½œè®°å½•2ï¼ˆåœ¨ Rocky Linux 9 VMware å†…ï¼‰**

1. å®‰è£… dracut-toolsï¼š

```
yum install -y dracut-tools
```

1. æ£€æŸ¥ virtio é©±åŠ¨æ˜¯å¦å¯ç”¨ï¼š

```
lsmod | grep virtio
```

å¦‚æœæ²¡åŠ è½½ï¼š

```
modprobe virtio_pci
modprobe virtio_blk
modprobe virtio_scsi
```

1. å¤‡ä»½åŸ initramfsï¼š

```
cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.bak
```

1. ç”Ÿæˆæ”¯æŒ KVM/virtio çš„ initramfsï¼š

```
dracut -f -v --add-drivers "virtio virtio_pci virtio_blk virtio_scsi" /boot/initramfs-$(uname -r)-kvm.img $(uname -r)
```

1. éªŒè¯ virtio é©±åŠ¨æ˜¯å¦åœ¨ initramfsï¼š

```
lsinitrd /boot/initramfs-$(uname -r)-kvm.img | grep virtio
```

1. æ›¿æ¢ç³»ç»Ÿé»˜è®¤ initramfsï¼š

```
mv /boot/initramfs-$(uname -r)-kvm.img /boot/initramfs-$(uname -r).img
```

1. å…³é—­ VMware ç³»ç»Ÿï¼Œè½¬ QCOW2ï¼š

```
qemu-img convert -f vmdk -O qcow2 all.vmdk vwware_trans_kvm.qcow2
```

1. åœ¨ KVM ä¸Šå¯¼å…¥ï¼š

```
virt-install \
  --name vm_trans_kvm \
  --memory 2048 \
  --vcpus 2 \
  --cpu host-model \
  --disk path=/var/lib/libvirt/images/vm_kvm.qcow2,bus=virtio,cache=none,format=qcow2 \
  --network bridge=br0,model=virtio \
  --graphics none \
  --console pty,target_type=serial \
  --import \
  --os-variant rocky9
```

------

ğŸ’¡ **æ€»ç»“**ï¼š

- Rocky Linux 9 å†…æ ¸è‡ªå¸¦ KVM æ¨¡å—ï¼Œä¸éœ€è¦ `kmod-kvm*`
- æ ¸å¿ƒå°±æ˜¯é‡å»º initramfs å¹¶åŠ å…¥ virtio é©±åŠ¨
- è½¬ QCOW2 åï¼Œvirt-install ç”¨ `bus=virtio` å°±èƒ½å¯åŠ¨

------





æˆ‘çš„ root å’Œ swap éƒ½åœ¨ **LVM** é‡Œï¼š

```
/dev/mapper/rl-root â†’ / (xfs)
/dev/mapper/rl-swap â†’ swap
```

æ‰€ä»¥ VMware è½¬ KVM åé»‘å± / dracut emergency shell çš„åŸå› å°±æ˜¯ï¼š

1. KVM ä¸‹ç£ç›˜æ”¹æˆäº† **virtio**ï¼Œåå­—å˜äº†ï¼Œä¾‹å¦‚ `/dev/vda`ã€‚
2. initramfs éœ€è¦ **åŒ…å« virtio_blk / virtio_scsi + lvm2**ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ¿€æ´»å·ç»„ `rl`ã€‚
3. å½“å‰ initramfs å¯èƒ½æ˜¯åŸ VMware ç”Ÿæˆçš„ï¼Œæˆ–è€…ç”Ÿæˆæ–¹å¼ä¸å®Œå…¨åŒ¹é… KVM ä¸‹çš„è®¾å¤‡ï¼Œæ‰€ä»¥æ‰¾ä¸åˆ° `/dev/mapper/rl-root`ã€‚

------

ğŸ’¡ **è§£å†³æ–¹æ¡ˆ**

1. åœ¨åŸ VMware ç³»ç»Ÿé‡Œï¼Œç”Ÿæˆæ”¯æŒ KVM çš„ initramfsï¼š

```bash
# å®‰è£…å¿…è¦å·¥å…·
yum install -y dracut dracut-config-generic lvm2

# é‡æ–°ç”Ÿæˆ initramfsï¼ŒåŠ å…¥ virtio + lvm é©±åŠ¨
dracut -f -v --add-drivers "virtio virtio_pci virtio_blk virtio_scsi" --add "lvm" /boot/initramfs-kvm.img $(uname -r)


```

1. åœ¨ KVM ä¸Šï¼ŒæŠŠæ–°çš„ initramfs è®¾ç½®ä¸ºé»˜è®¤å¯åŠ¨ï¼š  è¿™æˆ‘ç”¨çš„è¿˜æ˜¯è¦†ç›–

- åœ¨ virt-install æˆ– virt-manager é‡Œé€‰æ‹©ä½ çš„ç£ç›˜ `virtio`
- åœ¨ domain XML é‡ŒæŒ‡å®š kernel/initrdï¼ˆå¦‚æœä½¿ç”¨ `--import` å¯ä»¥ä¿æŒé»˜è®¤å¯åŠ¨ï¼‰

1. å¦‚æœè¿˜é»‘å±ï¼Œå¯ä»¥ä¸´æ—¶åœ¨ kernel å‘½ä»¤è¡ŒåŠ ä¸Šï¼š

```
rd.lvm.lv=rl/root
```

è¿™æ · dracut ä¼šæ¿€æ´» LVM å¹¶æ‰¾åˆ° rootã€‚

------

âš¡ **æ³¨æ„**

- ä¸è¦ç”¨ VMware åŸæ¥çš„ initramfsï¼Œå¿…é¡»åœ¨åŒ…å« virtio é©±åŠ¨çš„ç¯å¢ƒé‡Œç”Ÿæˆã€‚
- ç£ç›˜å¿…é¡»æ˜¯ `virtio` ç±»å‹ï¼Œå¦åˆ™ LVM root æ‰¾ä¸åˆ°ä¹Ÿå¯åŠ¨ä¸äº†ã€‚

------

æˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ª **å®Œæ•´æ“ä½œæµç¨‹**ï¼Œä» VMware VM ç”Ÿæˆ qcow2ã€ä¿®æ”¹ initramfsã€ç„¶åç›´æ¥åœ¨ KVM ä¸Šå¯åŠ¨ï¼Œä¸é»‘å±ã€‚

ä½ å¸Œæœ›æˆ‘å†™å—ï¼Ÿ







```
æˆ‘ç°åœ¨åšäº†

yum install -y dracut-tools dracut dracut-config-generic lvm2

modprobe virtio_pci
modprobe virtio_blk
modprobe virtio_scsi

lsmod | grep virtio # ç¡®è®¤ä¸‹


dracut -f -v --add-drivers "virtio virtio_pci virtio_blk virtio_scsi" --add "lvm" /boot/initramfs-kvm.img $(uname -r)

mv /boot/initramfs-kvm.img /boot/initramfs-$(uname -r).img

lsinitrd /boot/initramfs-$(uname -r)-kvm.img | grep -E 'virtio|lvm'  # ç¡®è®¤ä¸‹

grub2-mkconfig -o /boot/grub2/grub.cfg



virt-install \
--name vmware-trans-kvm \
--memory 2048 \
--vcpus 2 \
--cpu host-model \
--machine pc-q35-rhel9.0.0 \
--os-variant rocky9 \
--disk path=/var/lib/libvirt/images/vmware-trans-kvm.qcow2,bus=virtio,cache=none \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--graphics vnc \
--console pty,target_type=serial \
--import &

virsh destroy vmware-trans-kvm
virsh start vmware-trans-kvm

æå®š

```



## æ“ä½œè®°å½•3

åˆ«äººçš„æ“ä½œï¼Œ

å¯å–ç‚¹ï¼šfile qemu-imgï¼Œæ¨èæ£€æŸ¥ç”¨

å‚è€ƒç‚¹ï¼š--boot hd ä¸æ¨èç”¨

![image-20260121091626049](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121091626049.png)







# ç£ç›˜æ‰©å®¹



 

## CLI

```shell
# æŸ¥çœ‹vmå¯¹åº”çš„ç£ç›˜
virsh dumpxml xxx |grep qcow2
virsh domblklist xxx

# å…³æœº-ç”Ÿäº§ç¯å¢ƒæ¨è
virsh shutdown xxx
æˆ–è€…
virsh destroy xxx


# åšå¿«ç…§â˜…
virsh snapshot-create-as xxx xxx_snap_$(date +%F)
# åšå¤‡ä»½â˜…
cp -a /var/lib/libvirt/images/xxx.qcow2 /var/lib/libvirt/images/xx_bak_$(date +%F).qcow2



# å…³æœºçŠ¶æ€ä¸‹ï¼Œå¯¹ç£ç›˜æ‰©å®¹
qemu-img resize /var/lib/libvirt/images/xxx.qcow2 +10G
# éªŒè¯
qemu-img info /var/lib/libvirt/images/xxx.qcow2

# å¼€æœº
virsh start xxx



# å¼€æœºçŠ¶æ€ä¸‹æŸ¥çœ‹ç£ç›˜ç©ºé—´ï¼Œä½†æ˜¯æ˜¯å¼€æœºçŠ¶æ€ä¸‹ï¼Œå…ƒæ•°æ®åº”è¯¥æ˜¯å’Œå…³æœºçŠ¶æ€ä¸‹çš„ä¸åŒçš„ã€‚
qemu-img info --force-share  /var/lib/libvirt/images/xxx.qcow2

# ä¸å…³æœº-åœ¨çº¿æ‰©å®¹vmçš„ç£ç›˜ï¼Œæ¯”å¦‚500Gï¼Œæ³¨æ„åªæ˜¯vmçš„ç£ç›˜vdaï¼Œä¸æ˜¯è¿›ä¸€æ­¥æ·±å…¥åˆ°vmçš„æ–‡ä»¶ç³»ç»Ÿ
virsh blockresize r5-1 vda 500G   
#è¿™ä¸ª500Gä¸€å®šè¦å°å¿ƒï¼Œè¦å†™å¤§äºå½“å‰ç£ç›˜çš„ç©ºé—´ï¼Œå¦åˆ™ç›´æ¥ggï¼Œé™¤éä½ æå‰åšäº†å¿«ç…§ï¼


virsh console xxx  # è¿›å»
# å®‰è£…çƒ­æ‰©å®¹åˆ†åŒºå·¥å…·
yum -y install cloud-utils-growpart
# çƒ­æ‰©åˆ†åŒº å°† vda2 æ‰©å±•åˆ°æ•´ä¸ªç£ç›˜å‰©ä½™ç©ºé—´
growpart /dev/vda 2
# lvmä¸€æŠŠæ¢­
lvextend -rl +100%free /dev/rl/root


```



## æˆªå›¾

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121102759826.png" alt="image-20260121102759826" style="zoom:50%;" /> 

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121102530991.png" alt="image-20260121102530991" style="zoom:50%;" /> 

![image-20260121100025138](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121100025138.png)

12Gçš„r5.qcow2ï¼Œè€ƒè™‘å½“å‰ç£ç›˜ç©ºé—´ï¼Œæ‰©äº†10GğŸ‘‡ï¼Œæ³¨æ„ï¼Œè¿™äº›éƒ½æ˜¯è™šçš„ï¼Œæ˜¯ç˜¦ç½®å¤‡(ç®€å•ç†è§£)ã€‚

![image-20260121100219011](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121100219011.png)

å¯åŠ¨ï¼Œè¿›å…¥è¿™é‡Œä¹‹å‰æå®šäº†consoleï¼Œæ‰€ä»¥ç›´æ¥consoleè¿›å»ï¼Œå¦åˆ™ç”¨GUI

![image-20260121100655315](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121100655315.png)

è¿›å»åå°±æ˜¯æ–‡å­—æ˜¾ç¤ºçš„å¯åŠ¨è¿‡ç¨‹ï¼Œctrl ]é€€å‡ºï¼Œæˆ–è€…ç»§ç»­ç­‰ç­‰éƒ½è¡Œã€‚

![image-20260121100814561](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121100814561.png)



è¿›å»å¯ä»¥çœ‹åˆ°22Gæœ‰äº†ï¼Œä½†æ˜¯è¦ç”¨èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯åˆ†åŒºå’Œlvmæ‰©å®¹

![image-20260121100932325](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121100932325.png)





å‘µå‘µ

![image-20260121110357863](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121110357863.png)

æŒ‚äº†

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121110425654.png" alt="image-20260121110425654" style="zoom:50%;" /> 





æ¢ä¸ªvmå†åšä¸€éåœ¨çº¿æ‰©å®¹

### çƒ­æ‰©å®¹

#### æ‰©ä¹‹å‰

å¤‡ä»½å’Œå¿«ç…§--ä¸€èˆ¬å°±å…³æœºåš

![image-20260121142613811](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121142613811.png)

![image-20260121142533280](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121142533280.png)



ä¸å…³æœºè¿™ä¹ˆåš

![image-20260121145309340](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121145309340.png)

å‚è€ƒæ–‡æœ«ç‹¬ç«‹ç« èŠ‚







#### å¼€å§‹æ‰©

![image-20260121134100191](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121134100191.png)



å°†12Gæ‰©å®¹åˆ°22GğŸ‘‡

![image-20260121134717112](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121134717112.png)

ç„¶åå†è¿›å»çœ‹ä¸‹æ€»ç£ç›˜ï¼Œå’Œæ‰©åˆ†åŒºå°±è¡Œäº†

growpart \[ç£ç›˜\] \[è¦æ‰©çš„åˆ†åŒºå·\]  # è¿™æ ·å°±åˆ†åŒºå°†å æ»¡æ€ä¹ˆç£ç›˜ğŸ‘‡ï¼ŒåŒæ—¶pvéƒ½ä¸è¦åŠ è‡ªåŠ¨çš„ã€‚å½“ç„¶å¯ä»¥ç”¨vgs pvsç¡®è®¤ä¸‹æ˜¯å¦æœ‰æ–°å¢çš„10Gä¾›æ‰©å®¹lvmã€‚

![image-20260121140639270](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121140639270.png)

ğŸ‘†ä¸Šå›¾å¯è§vda2åˆ†åŒºä»11Gæ‰©è‡³22Gäº†å·²ç»



![image-20260121141543487](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121141543487.png)![image-20260121141621321](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121141621321.png)

æå®š





------

# âœ… KVM ç”Ÿäº§çº§å…³æœºå¤‡ä»½ï¼ˆCold Backupï¼‰æ ‡å‡†æ“ä½œ

## é€‚ç”¨åœºæ™¯

- æ•°æ®åº“ / æ ¸å¿ƒä¸šåŠ¡
- éœ€è¦ **100% æ–‡ä»¶ç³»ç»Ÿ + åº”ç”¨ä¸€è‡´æ€§**
- å¯æ¥å—çŸ­æš‚åœæœº

------

## ä¸€ã€ç¡®è®¤ VM çŠ¶æ€ & ç£ç›˜

```bash
virsh list --all
virsh domblklist r5-2
```

å‡è®¾ç£ç›˜æ˜¯ï¼š

```
/var/lib/libvirt/images/RockeyLinux-cl4.qcow2
```

------

## äºŒã€ä¼˜é›…å…³æœºï¼ˆå¿…é¡»ï¼‰

```bash
virsh shutdown r5-2
```

ç­‰å¾…å…³æœºå®Œæˆï¼š

```bash
virsh list
```

æˆ–å¼ºæ ¡éªŒ(çŠ¶æ€ç²¾ç¡®åº¦é«˜ï¼Œä¸”é’ˆå¯¹å•å°vm)ï¼š

```bash
virsh domstate r5-2
```

å¿…é¡»çœ‹åˆ°ï¼š

```
shut off
```

â—**ä¸æ¨èç›´æ¥ destroyï¼ˆæ–­ç”µï¼‰**

------

## ä¸‰ã€å†·å¤‡ä»½ï¼ˆæœ€ç¨³çš„ä¸€æ­¥ï¼‰

### âœ… æ¨èæ–¹å¼ï¼ˆæ‡‚ qcow2ï¼Œç”Ÿäº§é¦–é€‰ï¼‰

```bash
mkdir -p /backup

qemu-img convert -O qcow2 \
  /var/lib/libvirt/images/RockeyLinux-cl4.qcow2 \
  /backup/r5-2-$(date +%F)-cold.qcow2
```

### ä¸ºä»€ä¹ˆä¸ç”¨ cpï¼Ÿ

- convert ä¼šï¼š
  - æ ¡éªŒ qcow2
  - åˆå¹¶æ½œåœ¨å¿«ç…§
  - è·³è¿‡ç©ºæ´å—
- è¾“å‡º **å¹²å‡€ã€ç‹¬ç«‹ã€å¯å¯åŠ¨é•œåƒ**

ğŸ‘‰ **è¿™æ˜¯â€œæ•™ç§‘ä¹¦çº§å†·å¤‡ä»½â€**

------

## å››ã€æ ¡éªŒå¤‡ä»½ï¼ˆå¿…é¡»ï¼‰

```bash
qemu-img info /backup/r5-2-2026-01-21-cold.qcow2
```

------

## äº”ã€å¯åŠ¨ VMï¼ˆæ¢å¤ä¸šåŠ¡ï¼‰

```bash
virsh start r5-2
```

------

## å…­ã€æ¢å¤éªŒè¯ï¼ˆå¼ºçƒˆå»ºè®®è‡³å°‘åšä¸€æ¬¡ï¼‰

```bash
virt-install \
  --name r5-2-cold-restore \
  --memory 2048 \
  --vcpus 2 \
  --disk path=/backup/r5-2-2026-01-21-cold.qcow2 \
  --import \
  --noautoconsole
```

------

## ä¸ƒã€ä½ å¯ä»¥ç›´æ¥å†™è¿›è§„èŒƒé‡Œçš„ç»“è®º

> **ç”Ÿäº§çº§å¤‡ä»½ä¼˜å…ˆçº§ï¼š**
> 1ï¸âƒ£ å…³æœºå†·å¤‡ï¼ˆcold backupï¼‰â­â­â­â­â­
> 2ï¸âƒ£ å¿«ç…§ + convertï¼ˆä¸åœæœºï¼‰â­â­â­â­
> 3ï¸âƒ£ freeze + cpï¼ˆåº”æ€¥ï¼‰â­â­

------











------

# âœ… KVMç”Ÿäº§çº§åœ¨çº¿ï¼ˆrunningï¼‰å¤‡ä»½æ–¹æ¡ˆ

## ï¼ˆå¿«ç…§ + qemu-img convertï¼Œæœ€ä½³å®è·µï¼‰

> ç›®æ ‡ï¼š
>
> - VM **ä¸åœæœº**
> - å¤‡ä»½ **100% å¯æ¢å¤ã€å¯å¯åŠ¨**
> - ä¸ä¾èµ– guest-agent
> - å¯¹ä¸šåŠ¡å½±å“æœ€å°

------

## ä¸€ã€å‰ç½®ç¡®è®¤ï¼ˆ1 æ¡å‘½ä»¤ï¼‰

```bash
virsh domblklist r5-2
```

ä½ åº”è¯¥èƒ½çœ‹åˆ°ç±»ä¼¼ï¼š

```
Target   Source
---------------------------------------
vda      /var/lib/libvirt/images/RockeyLinux-cl4.qcow2
```

ä¸‹é¢å‡è®¾ç£ç›˜å°±æ˜¯è¿™ä¸ªæ–‡ä»¶ã€‚

------

## äºŒã€æ­¥éª¤ 1ï¼šåˆ›å»º**ç£ç›˜å¿«ç…§**ï¼ˆå…³é”®ï¼‰

```bash
virsh snapshot-create-as r5-2 snap-backup-$(date +%F_%H%M) \
  --disk-only \
  --atomic
```

### è¿™ä¸€åˆ»å‘ç”Ÿäº†ä»€ä¹ˆï¼ˆä½ è¦å¿ƒé‡Œæœ‰æ•°ï¼‰ï¼š

- VM **ç»§ç»­è¿è¡Œ**
- åŸç£ç›˜ `RockeyLinux-cl4.qcow2` â†’ **å†»ç»“ä¸ºåªè¯»è§†å›¾**
- æ–°å†™å…¥ â†’ ä¸´æ—¶å¿«ç…§æ–‡ä»¶ï¼ˆå¢é‡ç›˜ï¼‰â˜… è¿™é‡Œå’Œvmwareçš„å¿«ç…§ä¸€æ ·ï¼Œå‡¡æ˜¯åšäº†å¿«ç…§ï¼Œæ–°æ•°æ®éƒ½æ˜¯å†™åˆ°å¿«ç…§é‡Œçš„ã€‚

âœ… è¿™æ˜¯â€œå®‰å…¨å¤‡ä»½ç‚¹â€

------

## ä¸‰ã€æ­¥éª¤ 2ï¼šå¯¼å‡º**å¹²å‡€å®Œæ•´å¤‡ä»½**ï¼ˆæ ¸å¿ƒï¼‰

```bash
mkdir -p /backup

qemu-img convert -O qcow2 \
  /var/lib/libvirt/images/RockeyLinux-cl4.qcow2 \
  /backup/r5-2-$(date +%F).qcow2
```

### ä¸ºä»€ä¹ˆè¿™ä¸€æ­¥æ¯” `cp` å¼ºï¼š

- ç†è§£ qcow2 ç»“æ„
- è‡ªåŠ¨åˆå¹¶å¿«ç…§é“¾
- ä¸¢å¼ƒç©ºæ´ cluster
- è¾“å‡º **ç‹¬ç«‹ã€å¯å¯åŠ¨é•œåƒ**

ğŸ“Œ è¿™ä¸ª `/backup/r5-2-*.qcow2`
å°±æ˜¯ä½ **çœŸæ­£æ„ä¹‰ä¸Šçš„â€œå¤‡ä»½â€**

------

## å››ã€æ­¥éª¤ 3ï¼šåˆ é™¤å¿«ç…§ï¼ˆå¿…é¡»ï¼Œæˆ–è€…ç•™æœ€è¿‘çš„2ä¸ªä¹Ÿè¡Œï¼‰

```bash
virsh snapshot-list r5-2
```

ç¡®è®¤å¿«ç…§ååï¼š

```bash
virsh snapshot-delete r5-2 snap-backup-XXXX --metadata 

# å¤œé‡Œ
virsh blockcommit r5-2 vda --active --verbose --pivot
```



æ•ˆæœï¼š

- VM IO å†™å›åŸç›˜
- æ€§èƒ½æ¢å¤
- å¿«ç…§æ–‡ä»¶å¯æ¸…ç†

â— **ç”Ÿäº§åŸåˆ™ï¼šå¿«ç…§ä¸ç•™è¿‡å¤œï¼Œå¤œé‡Œåœ¨deleteå¥½äº†ï¼Œä¸è¦è„±è£¤å­æ”¾å±--metadataåè¿˜å¤œé‡Œå†å»åˆå¹¶ï¼**

------

## äº”ã€éªŒè¯å¤‡ä»½ï¼ˆå¼ºçƒˆå»ºè®®ï¼‰

```bash
qemu-img info /backup/r5-2-2026-01-21.qcow2
```

çœ‹åˆ°ï¼š

- format: qcow2
- virtual size æ­£ç¡®

ğŸ‘‰ è¯´æ˜å¤‡ä»½å®Œæ•´

------

## å…­ã€æ¢å¤æ¼”ç»ƒï¼ˆä½ ä¸€å®šè¦ä¼šï¼‰

```bash
virt-install \
  --name r5-2-restore-test \
  --memory 2048 \
  --vcpus 2 \
  --disk path=/backup/r5-2-2026-01-21.qcow2 \
  --import \
  --noautoconsole
```

ğŸ‘‰ èƒ½å¯åŠ¨ = **è¿™å¥—å¤‡ä»½æ˜¯åˆæ ¼çš„**

------

## ä¸ƒã€ä½ å¯ä»¥ç›´æ¥è®°ä½çš„â€œæœ€ç»ˆ SOPâ€

```text
1. snapshot-create-as --disk-only --atomic
2. qemu-img convert
3. snapshot-delete
```

------

## å…«ã€å’Œä½ ä¹‹å‰é—®çš„æ–¹æ¡ˆå¯¹ç…§ï¼ˆç»™ä½ å®šæ€§ï¼‰

| æ–¹æ¡ˆ                   | å®šä½             |
| ---------------------- | ---------------- |
| freeze + cp            | ä¸´æ—¶çƒ­å¤‡         |
| snapshot               | å›æ»šç‚¹           |
| **snapshot + convert** | âœ… **ç”Ÿäº§çº§å¤‡ä»½** |

------

## ä¹ã€ç»™ä½ ä¸€å¥â€œä¸“å®¶çº§ç»“è®ºâ€

> **r5-2 è¿™ç§ running çš„ KVM VMï¼Œ
> ä¸åœæœºã€æœ€ç¨³ã€æœ€é€šç”¨çš„å¤‡ä»½æ–¹æ¡ˆï¼Œ
> å°±æ˜¯ï¼šç£ç›˜å¿«ç…§ + qemu-img convertã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥å¸®ä½ æŠŠå®ƒåšæˆï¼š

- âœ… **å¯ç›´æ¥ cron çš„è„šæœ¬ç‰ˆ**
- âœ… **å¸¦å¤±è´¥å›æ»šå’Œå‘Šè­¦çš„è¿ç»´ç‰ˆ**
- âœ… **å¤š VM æ‰¹é‡å¤‡ä»½æ¨¡æ¿**

ä½ è¯´ä¸€å£°ï¼Œæˆ‘ç›´æ¥ç»™ä½ æˆå“ã€‚







# å…³äºå¿«ç…§ä¸ä¸€å®šå¾ˆå¥½ç†è§£

è¯¾é¢˜ï¼šçœ‹çœ‹r5-2çš„å¿«ç…§

![image-20260121155524054](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121155524054.png)



![image-20260121155542904](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121155542904.png)

è¿™æ ·virsh snapshot-list xxçœ‹ğŸ‘†æ˜¯å…¨çš„

ä½†æ˜¯qemu-img infoğŸ‘‡åªèƒ½çœ‹åˆ°ä¸¤ä¸ªï¼Œ

![image-20260121155637212](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121155637212.png)

è€Œè¿™ä¸¤ä¸ªæ˜¯é’ˆå¯¹RockeyLinux-cl4.qcow2çš„å†…éƒ¨å¿«ç…§ï¼Œæ˜¯æ²¡æœ‰ç‹¬ç«‹çš„qcow2æ–‡ä»¶çš„

![image-20260121160522781](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121160522781.png)





![image-20260121160711371](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121160711371.png)



ä¸åŠ --disk-onlyæŒ‰ç†è¯´ä¸è½ç‹¬ç«‹æ–‡ä»¶ï¼Œæ€ä¹ˆè¿˜æ˜¯çœ‹ä¸åˆ°

![image-20260121160832135](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121160832135.png)

**æ‰¾åˆ°åŸå› äº†ï¼Œ**åªè¦ä½ ç”¨--diskonlyåˆ›å»ºè¿‡ä¸€æ¬¡ï¼Œé‚£ä¹ˆåé¢æ‰€æœ‰çš„ä¸ç®¡ä½ æ˜¯ä¸æ˜¯å†…éƒ¨å¿«ç…§ï¼Œqemu-img infoéƒ½ä¸ä¼šè®°å½•äº†

ä¸‹å›¾å°±æ˜¯cli

```
virsh snapshot-create-as vmware-trans-kvm vmware-trans-kvm-snap001
virsh snapshot-create-as vmware-trans-kvm vmware-trans-kvm-snap002
virsh snapshot-create-as vmware-trans-kvm vmware-trans-kvm-snap003
virsh snapshot-create-as vmware-trans-kvm vmware-trans-kvm-snap004
virsh snapshot-create-as vmware-trans-kvm vmware-trans-kvm-snap005

virsh snapshot-create-as vmware-trans-kvm vmware-trans-kvm-snap006 --disk-only  # æ­¤æ—¶å¤–éƒ¨å¿«ç…§è½ç‹¬ç«‹æ–‡ä»¶ï¼Œqemu-img info ä¸å†è®°å½•
virsh snapshot-create-as vmware-trans-kvm vmware-trans-kvm-snap007 # å› ä¸ºå‰é¢æœ‰è¿‡ä¸€æ¬¡å¤–éƒ¨å¿«ç…§ï¼Œæ‰€ä»¥åé¢å³ä½¿ç”¨å†…éƒ¨å¿«ç…§ä¹Ÿä¼šè®°å½•åœ¨qemu-img infoé‡Œäº†

```

![image-20260121162518835](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121162518835.png)



å†å›è¿‡å¤´æ¥çœ‹

![image-20260121162827212](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121162827212.png)

æ­£å› ä¸º1449é‚£ä¸€æ¡å¤–éƒ¨å¿«ç…§æ–‡ä»¶è½äº†ï¼Œæ‰€ä»¥åé¢çš„ ç®¡ä»–æ˜¯ä¸æ˜¯ å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨(ä¹Ÿå°±æ˜¯æ˜¯å¦åŠ --disk-only)éƒ½ä¸ä¼šè¢«qemu-infoè®°å½•äº†ã€‚

![image-20260121163558405](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121163558405.png)

ä½†æ˜¯è¯è¯´å›æ¥ï¼Œä½ çŸ¥ä¸çŸ¥é“è¿™äº›å†…ã€å¤– å¿«ç…§ï¼Œç‹¬ç«‹æ–‡ä»¶äºå¦å¯¹äºå¿«ç…§ç®¡ç†éƒ½æ²¡å•¥å¤§çš„å½±å“

![image-20260121164123935](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121164123935.png)

1ã€domblklistçœ‹çš„æ˜¯å†™å…¥å±‚

2ã€ç†è®ºä¸Šæˆ‘ä»¬åœ¨vmware-workstaionä¸Šçœ‹éƒ½çŸ¥é“åšäº†å¿«ç…§ï¼Œæ•°æ®éƒ½å†™åˆ°å¿«ç…§é‡Œï¼Œæ‰€ä»¥ç±»æ¯”åˆ°kvmçš„dombllklistä»£è¡¨çš„å†™å…¥åˆ°æœ€æ–°çš„å¿«ç…§é‡Œæ˜¯æ²¡æ¯›ç—…çš„

3ã€ä½†æ˜¯ä¸åŠ --disk-onlyå°±æ˜¯å†…éƒ¨å¿«ç…§ï¼Œdomblklistçœ‹ä¸åˆ°ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ç‹¬ç«‹çš„å†™å…¥å±‚ï¼Œè¿˜æ˜¯å†™åˆ°baseç£ç›˜é‡Œã€‚

**domblklist åæ˜ çš„æ˜¯å½“å‰å†™å…¥å±‚çš„ qcow2 æ–‡ä»¶**

**å†…éƒ¨å¿«ç…§åˆ›å»ºä¸æ”¹å˜å†™å…¥å±‚**

**disk-only å¿«ç…§åˆ›å»ºä¼šåˆ‡æ¢å†™å…¥å±‚åˆ°æ–°æ–‡ä»¶**

æ ¸å¿ƒç†è§£ï¼š**domblklist æ˜¾ç¤ºçš„æ°¸è¿œæ˜¯ VM å½“å‰å†™å…¥çš„æ–‡ä»¶ï¼Œä¸åŠ  disk-only å°±æ˜¯å†…éƒ¨å¿«ç…§ï¼Œå†™å…¥å±‚æ²¡å˜**

![image-20260121165920678](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121165920678.png)



```shell
# åˆ é™¤æ‰€æœ‰å¿«ç…§
for snap in $(virsh snapshot-list r5-2 --name);do virsh snapshot-delete r5-2 $snap ;done
for snap in $(virsh snapshot-list r5-2 --name);do virsh snapshot-delete r5-2 $snap ;done
```

![image-20260121165734256](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121165734256.png)





![image-20260121170918206](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121170918206.png)

**æ‰€ä»¥--metadataæ˜¯ç”¨åœ¨æ¸…ç†åƒåœ¾æ•°æ®ä¸Šçš„ï¼Œä¸æ˜¯ä½ å¸¸è§„åˆ å¿«ç…§çš„æ“ä½œã€‚**

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121171839802.png" alt="image-20260121171839802" style="zoom:60%;" /> 



## å¿«ç…§åˆå¹¶

vmwareé‡Œæˆ‘ä»¬ç”¨å…‹éš†ä¸€å°å°±å®ç°äº†ï¼Œä½†æ˜¯é‚£æ˜¯å…‹éš†å•Šï¼Œä¸æ˜¯åŸåœ°åˆå¹¶å•Š

vmware-vdiskmanager.exe -r æœ€åä¸€ä¸ªå¿«ç…§ ,è¿™æ ·å¯ä»¥åˆå¹¶å‡ºæ¥ï¼Œä¸è¿‡ä¹Ÿæ˜¯æ–°çš„vmdk

å…¶å®çœŸæ­£åˆå¹¶å¿«ç…§å°±æ˜¯åˆ é™¤å¿«ç…§ï¼Œå°±ä¼šè‡ªåŠ¨åˆå¹¶åˆ°basesç£ç›˜é‡Œï¼Œä½†æ˜¯ä¸Šé¢è®²è¿‡--metadataåˆ é™¤çš„åªæ˜¯å…ƒæ•°æ®ï¼Œå®é™…çš„å†™å…¥å±‚è¿˜åœ¨ï¼Œæˆ‘ä»¬è¿™é‡Œè®¨è®ºçš„æ˜¯å¤–éƒ¨å¿«ç…§æ–‡ä»¶ã€‚

æ‰€ä»¥é™¤äº†åˆ é™¤å¿«ç…§ è‡ªåŠ¨åˆå¹¶çš„æ–¹æ³•ï¼Œè¿˜æœ‰åˆ é™¤metadataåçš„æ‰‹åŠ¨åˆå¹¶æ–¹æ³•



1ã€å¤„ç†ä¸€ä¸ªæ•…éšœï¼Œè¿˜åŸæ— å¿«ç…§çŠ¶æ€

![image-20260121174135581](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121174135581.png)

ä½†æ˜¯å†å²æ“ä½œæœ‰é—®é¢˜ï¼Œå†™å…¥æ–‡ä»¶ä¸å¯¹ğŸ‘†ï¼Œæ­¤æ—¶å¼€æœºå¿…ç„¶æŠ¥é”™

![image-20260121174206663](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121174206663.png)

ç›´æ¥editå°±è¡Œ

![image-20260121174318566](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121174318566.png)

![image-20260121174451805](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121174451805.png)

éªŒè¯å¼€æœºok

![image-20260121174545250](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121174545250.png)



2ã€ç°åœ¨æ˜¯åˆå§‹æ— å¿«ç…§äº†

![image-20260121174848421](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121174848421.png)



3ã€åšå¿«ç…§-å¤–éƒ¨çš„

![image-20260121180817954](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121180817954.png)



![image-20260121180750652](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121180750652.png)

qemu-img info --backing-chainå¯è§å¿«ç…§é“¾ğŸ‘‡

![image-20260121181554832](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121181554832.png)



```shell
# æ‰‹åŠ¨åˆå¹¶
qemu-img commit /var/lib/libvirt/images/RockeyLinux-cl4.snap002

```

![image-20260121182027469](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121182027469.png)

ä½†æ˜¯è¿˜æ˜¯ä¼šå†™å…¥snap002
éœ€è¦editä¸€ä¸‹ï¼Œé¡¶å±‚å†™å…¥æ”¹æˆvirsh snapshot-list å¯è§çš„æœ€åä¸€ä¸ªå¤–éƒ¨ç‹¬ç«‹æ–‡ä»¶å¿«ç…§ï¼Œä¹Ÿå°±æ˜¯snap001ã€‚

![image-20260121182530908](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121182530908.png)

å†åˆ é™¤snap002



å†æ¥ï¼Œå¦‚æœæ˜¯å†…éƒ¨å¿«ç…§å‘¢ï¼Œå¾ˆå¥½ï¼Œä½†æ˜¯è¦å†åˆ é™¤å†…éƒ¨å¿«ç…§åæ‰‹åŠ¨åˆ·æ–°è…¾å‡ºç©ºé—´

![image-20260121183339870](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121183339870.png)









![image-20260121183715235](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121183715235.png)





# ä¸è¦ç”¨--metadata

![image-20260121183825889](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260121183825889.png)



# å…³äºä¸¤ç§å¿«ç…§çš„æ€»ç»“å’Œé—®é¢˜å¤„ç†



## 1ã€ç†è§£ä¸¤ç§å¿«ç…§

ä¸ç®¡æ˜¯å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨ï¼Œéƒ½å¯ä»¥åœ¨virsh snapshot-list vmxxé‡Œçœ‹åˆ°ï¼Œè¿™è¯å°±ä¸å…¨å¯¹ï¼Œå“ˆå“ˆ

1ã€è¦çŸ¥é“virsh snapshot-listçœ‹çš„éƒ½æ˜¯æœ‰metadataåœ¨çš„ï¼Œä½ åˆ æ‰äº†metadataï¼Œvirsh snapshot-listå°±çœ‹ä¸åˆ°äº†ï¼Œè¿™ä¹Ÿæ˜¯æ•…éšœç‚¹

2ã€å¦‚ä½•çŸ¥é“ä¸€ä¸ªvmçš„å¿«ç…§çš„å…¨è²Œï¼Œ

â‘ virsh snapshot-listçœ‹ä¸‹ï¼Œçœ‹åˆ°çš„å°±æ˜¯æ‰€æœ‰virshç®¡ç†çš„å…ƒæ•°æ®ï¼Œä½†æ˜¯çœ‹ä¸åˆ°ä»…åˆ æ‰å…ƒæ•°æ® ä½†æ˜¯å¿«ç…§æ–‡ä»¶è¿˜åœ¨çš„æƒ…å†µï¼Œvirsh snapshot-listæ˜¯çœ‹ä¸åˆ°çš„ï¼›

â‘¡é’ˆå¯¹å†…éƒ¨å¿«ç…§ï¼Œè¦çœ‹çœ‹qemu-img infoçœ‹çœ‹æœ‰æ²¡æœ‰å­¤å„¿å¿«ç…§å°±æ˜¯ä»…åˆ é™¤metadataçš„å¿«ç…§ï¼›

â‘¢é’ˆå¯¹å¤–éƒ¨å¿«ç…§ï¼Œè¦çœ‹çœ‹ll /var/lib/libvirt/images/ä¸‹æœ‰æ²¡æœ‰å­¤å„¿æ–‡ä»¶ï¼›

â‘£å¦‚æœè¿™ä¸ªvmç»å†è¿‡å†…éƒ¨å¿«ç…§-åˆåšè¿‡å¤–éƒ¨å¿«ç…§--å“ªæ€•åé¢ä½ å†åšè¿‡å†…éƒ¨å¿«ç…§ï¼Œé‚£ä¹ˆè¿™äº›è¢«å¤–éƒ¨å¿«ç…§å‰²è£‚çš„ä»¥åå‡ºç°çš„å†…éƒ¨å¿«ç…§éƒ½ä¸ä¼šåœ¨ç¬¬ä¸€ä¸ªbaseçš„qemu-imgé‡Œå‡ºç°äº†ï¼Œå°±ä¼šå‡ºç°åœ¨æœ€åä¸€ä¸ªå¤–éƒ¨å¿«ç…§æ–‡ä»¶é‡Œï¼Œä¹Ÿå°±æ˜¯è¯´å‰²è£‚çš„å†…éƒ¨å¿«ç…§æ˜¯ä¼šä½œä¸ºå‰ä¸€ä¸ªå¤–éƒ¨å¿«ç…§çš„å†…éƒ¨å¿«ç…§ã€‚

â‘¤ä¸ç®¡ä¸‰ä¸ƒäºŒåä¸€ï¼Œå†…éƒ¨å¿«ç…§åˆå¹¶æ€ä¹ˆåšï¼Œæœ‰å…ƒæ•°æ®ï¼Œæ­£å¸¸åˆ å¿«ç…§å°±èƒ½åˆå¹¶ï¼Œæ²¡æœ‰å…ƒæ•°æ®çš„å­¤å„¿å†…éƒ¨å¿«ç…§ä¸èƒ½ç›´æ¥qemu-img snapshot -d å»åˆ é™¤ï¼Œè¦qemu-img convert ç›¸å½“äºå…‹éš†ä¸€ä¸ªç‹¬ç«‹çš„ç£ç›˜æ–‡ä»¶äº†è¿™æ ·å°±èƒ½åˆå¹¶å“ªäº›å­¤å„¿å†…éƒ¨å¿«ç…§äº†ï¼›

â‘¥å¤–éƒ¨å¿«ç…§åˆå¹¶æ€ä¹ˆåšï¼Œqemu-img converå°±ä¸ä¸€å®šè¡Œå¾—é€šäº†ï¼Œé’ˆå¯¹å­¤å„¿å¤–éƒ¨å¿«ç…§è¦ç”¨qemu-img commitå»åˆå¹¶è¿›å»ã€‚

å½“ç„¶ï¼Œä¸€èˆ¬--disk-onlyæ¯”è¾ƒé€‚åˆåœ¨çº¿å¿«ç…§ï¼Œä¸åŠ ä¼šå½±å“ä¸šåŠ¡ã€‚

**ä¸€ä¸ªå¹²å‡€æ²¡æœ‰å¿«ç…§ä¿¡æ¯çš„åˆå§‹åŒ–**

![image-20260122112456753](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122112456753.png)

**å¯åŠ¨**

![image-20260122112609057](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122112609057.png)



**åš10ä¸ªå†…å¤–å¤¹æ‚çš„å¿«ç…§**ï¼Œbaseé‡Œå†™ä¸€ä¸ª0ï¼Œç„¶åæ¯ä¸ªå¿«ç…§äº†é‡Œ+1

![image-20260122112919092](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122112919092.png)

![image-20260122113451665](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122113451665.png)

ç»§ç»­

![image-20260122113734419](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122113734419.png)

![image-20260122113952526](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122113952526.png)

â‘ å…ˆä¸Šç»“è®ºï¼š 

1ã€snap001 002åœ¨qemu-info  baseé‡Œ

2ã€snap003 004æ˜¯ç‹¬ç«‹çš„æ–‡ä»¶

3ã€snap005 006åœ¨qemu-info 004é‡Œ

4ã€snap007 008æ˜¯ç‹¬ç«‹æ–‡ä»¶

5ã€snap009 010åœ¨qemu-info 008é‡Œ

â‘¡éªŒè¯OKğŸ‘‡

![image-20260122114708142](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122114708142.png)



## 2ã€åˆ¶é€ ç‚¹é—®é¢˜

åˆ é™¤ä¸€äº›å†…å¤–å¿«ç…§çš„metadata

![image-20260122133908395](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122133908395.png)

ç”±äºåªæ˜¯åˆ é™¤å…ƒæ•°æ®ï¼Œæ‰€ä»¥å¿«ç…§å±‚ä¸ç®¡æ˜¯å¤–éƒ¨çš„ç‹¬ç«‹æ–‡ä»¶è¿˜æ˜¯å†…éƒ¨çš„å¿«ç…§å±‚ï¼Œéƒ½åœ¨ã€‚æ•°æ®ä¹ŸOK

![image-20260122134902848](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122134902848.png)

ä¸€äº›å¿«ç…§çš„metadataæ²¡äº†ï¼Œä½†æ˜¯åˆ†å±‚è¿˜åœ¨ğŸ‘‡

![image-20260122135157126](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122135157126.png)![image-20260122135914436](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122135914436.png)





## 2ã€å¤–éƒ¨å†…éƒ¨å¿«ç…§é—®é¢˜å¤„ç†

å…³æœºå…ˆå•¦ï¼Œåˆå¹¶å¿«ç…§æœ¬èº«å°±è¦commitå½±å“ä¸šåŠ¡ï¼Œæ‰¾çª—å£ã€‚

```shell
qemu-img commit /var/lib/libvirt/images/RockeyLinux-cl4.snap002
```

![image-20260122142104853](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122142104853.png)

![image-20260122142125210](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122142125210.png)

![image-20260122142207284](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122142207284.png)

ç„¶åç§»èµ°å¤–éƒ¨å¿«ç…§

![image-20260122142609675](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122142609675.png)

å¤„ç†é¡¶å±‚å†™å…¥æ–‡ä»¶

åˆ æ‰è¿™äº›ğŸ‘‡

![image-20260122142840721](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122142840721.png)



<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122143009896.png" alt="image-20260122143009896" style="zoom:50%;" />



![image-20260122143131417](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122143131417.png)

é‡å¯éªŒè¯æ•°æ®æ˜¯å¦éƒ½åœ¨

![image-20260122143308753](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122143308753.png)

æ­¤æ—¶æ‰€æœ‰å¤–éƒ¨å¿«ç…§éƒ½åˆå¹¶äº†å·²ç»ï¼Œ

![image-20260122143827549](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122143827549.png)

ä½†æ˜¯å†…éƒ¨å¿«ç…§è¿˜éœ€è¦è¿›ä¸€æ­¥å¤„ç†åˆå¹¶ï¼Œçœ‹ä¸åˆ°çš„009 010 å…¶å®åœ¨å¤–éƒ¨008é‡Œå°±åˆè¿›å»äº†ï¼Œ007ä¹Ÿåˆè¿›å»ï¼Œ006å’Œ005éšç€004åˆcommitè¿›å»äº†ï¼Œ003ä¹Ÿcommitåˆè¿›å»äº†ï¼Œæ‰€ä»¥ä¿®å‰ªä¸€ä¸‹r5-2çš„å…ƒæ•°æ®

![image-20260122144150853](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122144150853.png)

ç°åœ¨å¤„ç†002

![image-20260122144334701](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122144334701.png)

snap002çš„æƒ…å†µæ˜¯å…ƒæ•°æ®æ²¡äº†ï¼Œä½†æ˜¯åœ¨baseé‡Œçš„åˆ†å±‚è¿˜åœ¨ã€‚

å°è¯•å†™ä¸ªæ•°æ®çœ‹çœ‹ï¼Œå‘ç°å†…éƒ¨å¿«ç…§å…¶å®ä¸ä¼šæ”¹å˜å†™å…¥å±‚ï¼Œè¿˜æ˜¯å†™å…¥baseã€‚è¿™ç‚¹å’Œå¤–éƒ¨å¿«ç…§ä¸€æ ·ï¼Œå¤–éƒ¨å¿«ç…§å°±å‡ºç°ä¸€ä¸ªå°±å˜æˆæ–°çš„é¡¶éƒ¨å†™å…¥å±‚ã€‚

![image-20260122150100710](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122150100710.png)



å¼€å§‹å¤„ç†snap002

![image-20260122150515253](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122150515253.png)



ä¹‹å‰åœ¨å¤–éƒ¨å¿«ç…§æ–‡ä»¶é‡Œçš„é‚£äº›å†…éƒ¨å¿«ç…§å±‚ä¼šéšç€ï¼Œè¿™äº›å¤–éƒ¨å¿«ç…§commitåˆå¹¶è¿›baseã€‚

æœ€ååœ¨baseé‡Œçš„å†…éƒ¨å¿«ç…§å±‚ï¼Œå¦‚æœæœ‰å…ƒæ•°æ®ä¸¢å¤±ï¼Œè¦ä¿®æ­£çš„åŒ–ï¼Œè¿˜æ˜¯è¦ç±»ä¼¼å…‹éš†ä¸€å°å‡ºæ¥ğŸ‘‡

```shell
virsh shutdown r5-2
qemu-img convert -O qcow2 RockeyLinux-cl4.qcow2 merge-r5-2.qcow2
```



![image-20260122154121763](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122154121763.png)

```shell
virt-install \
--name merge-r5-2 \
--memory 2048 \
--vcpus 2 \
--cpu host-model \
--machine pc-q35-rhel9.0.0 \
--os-variant rocky9 \
--disk path=/var/lib/libvirt/images/merge-r5-2.qcow2,bus=virtio,cache=none \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--graphics vnc \
--console pty,target_type=serial \
--import &

```



![image-20260122154404297](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122154404297.png)



![image-20260122154423167](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260122154423167.png)







