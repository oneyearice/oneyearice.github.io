# 08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.md



# 1ã€æ ¼å¼è½¬æ¢



## æ“ä½œè®°å½•1

å°†vmdkè½¬æˆqcow2

æŠŠwindowsçš„vmware workstationé‡Œçš„è™šæ‹Ÿæœºçš„vmå¤åˆ¶åˆ°linuxé‡Œ

![image-20260109113508132](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109113508132.png)

è¿™é€‰æ‹©ä»…å¤„ç†baseé•œåƒçœ‹çœ‹æ•ˆæœï¼Œåº”è¯¥æ˜¯æœ‰é—®é¢˜çš„

![image-20260109114037182](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109114037182.png)

å…ˆè¯•è¯•çœ‹

```shell
qemu-img convert -f vmdk -O qcow2 RockeyLinux-cl3.vmdk vm_trans_01.qcow2
cp vm_trans_01.qcow2  /var/lib/libvirt/images/
chmod 600 /var/lib/libvirt/images/vm_trans_01.qcow2
chown qemu.qemu vm_trans_02.qcow2


# --machine pc-q35-rhel9.0.0 æ˜¯å¯¹çš„ ï¼Œä½†è¦destroyå†startæ‰èƒ½åœ¨virt-manageræ‰“å¼€
virt-install \
--name vmware-trans-kvm \
--memory 2048 \
--vcpus 2 \
--cpu host-model \
--machine pc-q35-rhel9.0.0 \
--os-variant rocky9 \
--disk path=/var/lib/libvirt/images/vmware-trans-kvm.qcow2,bus=virtio,cache=none \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--graphics vnc \
--console pty,target_type=serial \
--import &

```

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109113644521.png" alt="image-20260109113644521" style="zoom:50%;" />

![image-20260109113928309](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109113928309.png)

å¼€ä¸äº†æœºå™¨ï¼Œæ¢æ–¹æ¡ˆ



![image-20260109182407864](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109182407864.png)

```cmd
# vmware-vdiskmanager.exe -r æœ€åä¸€ä¸ªå¿«ç…§ 

vmware-vdiskmanager.exe -r "D:\Virtual Machines\R4\RockeyLinux-cl3-000002.vmdk -t 0 "E:\all.vmdk"


# è¿™é‡Œå¾ˆå‘ï¼Œä¸€å®šè¦ç”¨æœ€åä¸€ä¸ªå¿«ç…§å»ä½œä¸ºæ•´åˆçš„çº¿ç´¢ï¼Œå¦åˆ™å¾’åŠ³ï¼›è¦ä¸ä½ å°±å…‹éš†å½“å‰çŠ¶æ€ä¸ºä¸€ä¸ªæ–°çš„VMï¼Œæ•ˆæœå’Œè¿™ä¸ªcliä¸€æ ·çš„æ•ˆæœã€‚

```

![image-20260109155103150](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260109155103150.png)







## **æ“ä½œè®°å½•2ï¼ˆåœ¨ Rocky Linux 9 VMware å†…ï¼‰**

1. å®‰è£… dracut-toolsï¼š

```
yum install -y dracut-tools
```

1. æ£€æŸ¥ virtio é©±åŠ¨æ˜¯å¦å¯ç”¨ï¼š

```
lsmod | grep virtio
```

å¦‚æœæ²¡åŠ è½½ï¼š

```
modprobe virtio_pci
modprobe virtio_blk
modprobe virtio_scsi
```

1. å¤‡ä»½åŸ initramfsï¼š

```
cp /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.bak
```

1. ç”Ÿæˆæ”¯æŒ KVM/virtio çš„ initramfsï¼š

```
dracut -f -v --add-drivers "virtio virtio_pci virtio_blk virtio_scsi" /boot/initramfs-$(uname -r)-kvm.img $(uname -r)
```

1. éªŒè¯ virtio é©±åŠ¨æ˜¯å¦åœ¨ initramfsï¼š

```
lsinitrd /boot/initramfs-$(uname -r)-kvm.img | grep virtio
```

1. æ›¿æ¢ç³»ç»Ÿé»˜è®¤ initramfsï¼š

```
mv /boot/initramfs-$(uname -r)-kvm.img /boot/initramfs-$(uname -r).img
```

1. å…³é—­ VMware ç³»ç»Ÿï¼Œè½¬ QCOW2ï¼š

```
qemu-img convert -f vmdk -O qcow2 all.vmdk vwware_trans_kvm.qcow2
```

1. åœ¨ KVM ä¸Šå¯¼å…¥ï¼š

```
virt-install \
  --name vm_trans_kvm \
  --memory 2048 \
  --vcpus 2 \
  --cpu host-model \
  --disk path=/var/lib/libvirt/images/vm_kvm.qcow2,bus=virtio,cache=none,format=qcow2 \
  --network bridge=br0,model=virtio \
  --graphics none \
  --console pty,target_type=serial \
  --import \
  --os-variant rocky9
```

------

ğŸ’¡ **æ€»ç»“**ï¼š

- Rocky Linux 9 å†…æ ¸è‡ªå¸¦ KVM æ¨¡å—ï¼Œä¸éœ€è¦ `kmod-kvm*`
- æ ¸å¿ƒå°±æ˜¯é‡å»º initramfs å¹¶åŠ å…¥ virtio é©±åŠ¨
- è½¬ QCOW2 åï¼Œvirt-install ç”¨ `bus=virtio` å°±èƒ½å¯åŠ¨

------





æˆ‘çš„ root å’Œ swap éƒ½åœ¨ **LVM** é‡Œï¼š

```
/dev/mapper/rl-root â†’ / (xfs)
/dev/mapper/rl-swap â†’ swap
```

æ‰€ä»¥ VMware è½¬ KVM åé»‘å± / dracut emergency shell çš„åŸå› å°±æ˜¯ï¼š

1. KVM ä¸‹ç£ç›˜æ”¹æˆäº† **virtio**ï¼Œåå­—å˜äº†ï¼Œä¾‹å¦‚ `/dev/vda`ã€‚
2. initramfs éœ€è¦ **åŒ…å« virtio_blk / virtio_scsi + lvm2**ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ¿€æ´»å·ç»„ `rl`ã€‚
3. å½“å‰ initramfs å¯èƒ½æ˜¯åŸ VMware ç”Ÿæˆçš„ï¼Œæˆ–è€…ç”Ÿæˆæ–¹å¼ä¸å®Œå…¨åŒ¹é… KVM ä¸‹çš„è®¾å¤‡ï¼Œæ‰€ä»¥æ‰¾ä¸åˆ° `/dev/mapper/rl-root`ã€‚

------

ğŸ’¡ **è§£å†³æ–¹æ¡ˆ**

1. åœ¨åŸ VMware ç³»ç»Ÿé‡Œï¼Œç”Ÿæˆæ”¯æŒ KVM çš„ initramfsï¼š

```bash
# å®‰è£…å¿…è¦å·¥å…·
yum install -y dracut dracut-config-generic lvm2

# é‡æ–°ç”Ÿæˆ initramfsï¼ŒåŠ å…¥ virtio + lvm é©±åŠ¨
dracut -f -v --add-drivers "virtio virtio_pci virtio_blk virtio_scsi" --add "lvm" /boot/initramfs-kvm.img $(uname -r)


```

1. åœ¨ KVM ä¸Šï¼ŒæŠŠæ–°çš„ initramfs è®¾ç½®ä¸ºé»˜è®¤å¯åŠ¨ï¼š  è¿™æˆ‘ç”¨çš„è¿˜æ˜¯è¦†ç›–

- åœ¨ virt-install æˆ– virt-manager é‡Œé€‰æ‹©ä½ çš„ç£ç›˜ `virtio`
- åœ¨ domain XML é‡ŒæŒ‡å®š kernel/initrdï¼ˆå¦‚æœä½¿ç”¨ `--import` å¯ä»¥ä¿æŒé»˜è®¤å¯åŠ¨ï¼‰

1. å¦‚æœè¿˜é»‘å±ï¼Œå¯ä»¥ä¸´æ—¶åœ¨ kernel å‘½ä»¤è¡ŒåŠ ä¸Šï¼š

```
rd.lvm.lv=rl/root
```

è¿™æ · dracut ä¼šæ¿€æ´» LVM å¹¶æ‰¾åˆ° rootã€‚

------

âš¡ **æ³¨æ„**

- ä¸è¦ç”¨ VMware åŸæ¥çš„ initramfsï¼Œå¿…é¡»åœ¨åŒ…å« virtio é©±åŠ¨çš„ç¯å¢ƒé‡Œç”Ÿæˆã€‚
- ç£ç›˜å¿…é¡»æ˜¯ `virtio` ç±»å‹ï¼Œå¦åˆ™ LVM root æ‰¾ä¸åˆ°ä¹Ÿå¯åŠ¨ä¸äº†ã€‚

------

æˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ª **å®Œæ•´æ“ä½œæµç¨‹**ï¼Œä» VMware VM ç”Ÿæˆ qcow2ã€ä¿®æ”¹ initramfsã€ç„¶åç›´æ¥åœ¨ KVM ä¸Šå¯åŠ¨ï¼Œä¸é»‘å±ã€‚

ä½ å¸Œæœ›æˆ‘å†™å—ï¼Ÿ







```
æˆ‘ç°åœ¨åšäº†

yum install -y dracut-tools dracut dracut-config-generic lvm2

modprobe virtio_pci
modprobe virtio_blk
modprobe virtio_scsi

lsmod | grep virtio # ç¡®è®¤ä¸‹


dracut -f -v --add-drivers "virtio virtio_pci virtio_blk virtio_scsi" --add "lvm" /boot/initramfs-kvm.img $(uname -r)

mv /boot/initramfs-kvm.img /boot/initramfs-$(uname -r).img

lsinitrd /boot/initramfs-$(uname -r)-kvm.img | grep -E 'virtio|lvm'  # ç¡®è®¤ä¸‹

grub2-mkconfig -o /boot/grub2/grub.cfg



virt-install \
--name vmware-trans-kvm \
--memory 2048 \
--vcpus 2 \
--cpu host-model \
--machine pc-q35-rhel9.0.0 \
--os-variant rocky9 \
--disk path=/var/lib/libvirt/images/vmware-trans-kvm.qcow2,bus=virtio,cache=none \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--graphics vnc \
--console pty,target_type=serial \
--import &

virsh destroy vmware-trans-kvm
virsh start vmware-trans-kvm

æå®š

```









------

## VMware Linux â†’ KVM æ­£ç¡®è¿ç§»æµç¨‹



è¦è½¬æ¢çš„æœºå™¨æ˜¯R5ï¼Œæœ‰å¿«ç…§2ä¸ªï¼Œè¿™é‡Œå°±è¦æ³¨æ„äº†ï¼Œæœ‰å¿«ç…§çš„è¦åˆå¹¶ï¼Œåˆå¹¶æ³•æœ‰2ï¼Œç”¨å…‹éš†æœ€å¿«~

![image-20260115163904597](08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260115163904597.png)







### 1ï¸âƒ£ åœ¨ VMware è™šæ‹Ÿæœºä¸­å‡†å¤‡å†…æ ¸æ”¯æŒ

1. ç¡®è®¤å†…æ ¸é‡Œ **virtio é©±åŠ¨ + LVM** å¯ç”¨ï¼š

```bash
lsinitrd /boot/initramfs-$(uname -r).img | grep -i virtio
```

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260115164121305.png" alt="image-20260115164121305" style="zoom:50%;" />

å¯è§æ²¡æœ‰kvmçš„virtioé©±åŠ¨ï¼Œæ‰€ä»¥å³ä½¿è½¬æˆqcow2ï¼Œå¯åŠ¨ä¹Ÿæ˜¯è®¤ä¸åˆ°ç›˜çš„ã€‚

1. å®‰è£…å¿…è¦å·¥å…·ï¼š

```bash
yum -y install epel-release
yum install -y dracut-tools dracut dracut-config-generic lvm2
```

1. é‡æ–°ç”Ÿæˆ initramfsï¼ŒåŠ å…¥ virtio å’Œ LVM é©±åŠ¨ï¼š

```bash
dracut -f -v --add-drivers "virtio virtio_pci virtio_blk virtio_scsi" --add "lvm" /boot/initramfs-kvm.img $(uname -r)
cp -a  /boot/initramfs-$(uname -r).img /boot/initramfs-$(uname -r).img.bak
cp -a /boot/grub2/grub.cfg //boot/grub2/grub.cfg.bak
mv /boot/initramfs-kvm.img /boot/initramfs-$(uname -r).img
grub2-mkconfig -o /boot/grub2/grub.cfg
```

âœ… è¿™æ ·ç¡®ä¿ KVM å¯åŠ¨æ—¶èƒ½è¯†åˆ« virtio ç£ç›˜å’Œ LVM å·ã€‚

------

###  2ï¸âƒ£ ä» VMware å¯¼å‡ºé•œåƒå¹¶è½¬æ¢

R5è¿™ä¸ªVMæœ‰2å¿«ç…§ï¼Œç„¶åæ–°æ•°æ®å…¶å®éƒ½æ˜¯è½åœ¨æœ€è¿‘çš„ä¸€ä¸ªå¿«ç…§2é‡Œçš„

##### åˆå¹¶å¿«ç…§çš„æ–¹æ³•1-ä½¿ç”¨clié’ˆå¯¹æœ€åçš„ä¸€ä¸ªå¿«ç…§å°±

<img src="08.KVMå­˜å‚¨ç®¡ç†å’Œé»˜è®¤ç½‘ç»œæ¨¡å¼.assets/image-20260115165901973.png" alt="image-20260115165901973" style="zoom:50%;" />

ä¸‹è½½å¯¹åº”æ“ä½œç³»ç»Ÿçš„ VDDK åï¼Œè§£å‹å¹¶åœ¨ `bin` ç›®å½•ä¸‹å³å¯æ‰¾åˆ° `vmware-vdiskmanager`

https://developer.broadcom.com/sdks/vmware-virtual-disk-development-kit-vddk/latest





```
# vmware-vdiskmanager.exe -r æœ€åä¸€ä¸ªå¿«ç…§ 

vmware-vdiskmanager.exe -r "D:\Virtual Machines\R4\RockeyLinux-cl3-000002.vmdk -t 0 "E:\all.vmdk"


# è¿™é‡Œå¾ˆå‘ï¼Œä¸€å®šè¦ç”¨æœ€åä¸€ä¸ªå¿«ç…§å»ä½œä¸ºæ•´åˆçš„çº¿ç´¢ï¼Œå¦åˆ™å¾’åŠ³ï¼›è¦ä¸ä½ å°±å…‹éš†å½“å‰çŠ¶æ€ä¸ºä¸€ä¸ªæ–°çš„VMï¼Œæ•ˆæœå’Œè¿™ä¸ªcliä¸€æ ·çš„æ•ˆæœã€‚

```



```bash
qemu-img convert -f vmdk -O qcow2 æºVM.vmdk vm_trans.qcow2
```

------

### 3ï¸âƒ£ æ”¾åˆ° libvirt ç›®å½•å¹¶è°ƒæ•´æƒé™

```bash
cp vm_trans.qcow2 /var/lib/libvirt/images/
chown qemu.qemu /var/lib/libvirt/images/vm_trans.qcow2
chmod 600 /var/lib/libvirt/images/vm_trans.qcow2
```

------

### 4ï¸âƒ£ åˆ›å»º KVM è™šæ‹Ÿæœº

```bash
virt-install \
  --name vm_trans \
  --memory 2048 \
  --vcpus 2 \
  --cpu host-model \
  --disk path=/var/lib/libvirt/images/vm_trans.qcow2,bus=virtio,cache=none \
  --network bridge=br1,model=virtio \
  --network bridge=br2,model=virtio \
  --graphics none \
  --console pty,target_type=serial \
  --import \
  --os-variant rocky10
```

> å¯é€‰ï¼šå¦‚æœå®¿ä¸»æœºæ”¯æŒ `pc-q35-rhel9.0.0`ï¼Œå¯ä»¥åœ¨ XML ä¸­æ‰‹åŠ¨ä¿®æ”¹ `<type machine='pc-q35-rhel9.0.0'>hvm</type>`ï¼Œ**ä½†ä¸ä¸€å®šéœ€è¦åœ¨ virt-install å‘½ä»¤é‡ŒæŒ‡å®š**ã€‚

------

### âš¡ æ ¸å¿ƒåŸåˆ™

1. **å…ˆåœ¨ VMware é‡Œç”Ÿæˆæ”¯æŒ virtio çš„ initramfs** â†’ è½¬ QCOW2
2. **QCOW2 æ–‡ä»¶æƒé™æ­£ç¡®ï¼Œå½’å± qemu:qemu**
3. virt-install é‡Œç”¨ `host-model` CPUï¼Œé¿å… `host` æŠ¥åºŸå¼ƒè­¦å‘Š
4. å¦‚æœ initramfs ä¸åŒ…å« virtioï¼Œå¯åŠ¨å°±ä¼šé»‘å± / æ‰¾ä¸åˆ°ç£ç›˜

------

æˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€ä¸ª**æµç¨‹å›¾**ï¼Œä¸€çœ¼å°±èƒ½çœ‹åˆ°æ•´ä¸ªä» VMware åˆ° KVM çš„æ­£ç¡®é¡ºåºï¼Œé¿å…é»‘å±é—®é¢˜ã€‚

ä½ å¸Œæœ›æˆ‘ç”»å—ï¼Ÿ
