# 04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.md



# 1ã€æŸ¥çœ‹æ”¯æŒçš„osçš„ä¸¤ä¸ªcli 

```shell
virt-install --osinfo list
osinfo-query os
```

![image-20251223150350946](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251223150350946.png)



 è¿™æ˜¯win2016 2008è¿™ä¸‹ğŸ‘‡

![image-20251223150616911](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251223150616911.png)



![image-20251223150820271](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251223150820271.png)



# 2ã€linuxæ— GUIå®‰è£…è¿‡ç¨‹

åœ¨å‰é¢çš„02ç« èŠ‚é‡Œæœ‰è®²è¿‡æ— guiå’Œæ¡¥æ¥çš„æ“ä½œï¼Œè¿™é‡Œæ•´åˆä¸€ä¸‹ï¼Œå¹¶å¢åŠ äº†ksçš„å…¨è‡ªåŠ¨å®‰è£…å®æ“ã€‚

## 2.1 å®¿ä¸»æœºç½‘å¡é…ç½®å¥½



### â‘ ä¿®æ”¹å®¿ä¸»ç½‘å¡ä¸ºeth0 eth1(å¯é€‰)

1ã€ä¿®æ”¹grubæ–‡ä»¶

```shell
sed -ri.bak '/^GRUB_CMDLINE_LINUX=/s@(.*)"$@\1 net.ifnames=0 biosdevname=0"@' /etc/default/grub
```

2ã€æ›´æ–° grub é…ç½®

```shell
# åˆ¤æ–­BIOSè¿˜æ˜¯UEFI
[ -d /sys/firmware/efi ] && echo "UEFI" || echo "BIOS"
# BIOS ç³»ç»Ÿ
grub2-mkconfig -o /boot/grub2/grub.cfg
# UEFI ç³»ç»Ÿ
grub2-mkconfig -o /boot/efi/EFI/rocky/grub.cfg

# UEFI
EFI_DIR=`find /boot/efi/ -name "grub.cfg" | awk -F"/" '{print $5}'`

# Rockyã€Almalinuxã€CentOSã€openEulerã€AnolisOSã€OpenCloudOSã€Kylin Serverã€Uos Server
grub2-mkconfig -o /boot/efi/EFI/${EFI_DIR}/grub.cfg

# Ubuntuã€Debian
grub-mkconfig -o /boot/efi/EFI/${EFI_DIR}/grub.cfg
```

3ã€ä½¿ç”¨udevå›ºå®šç½‘å¡åç§°ï¼Œå¥½åƒå‰ä¸¤éƒ¨å¯ä»¥çœç•¥

```shell
cat <<EOF > /etc/udev/rules.d/50-persistent-net.rules
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="ç¬¬ä¸€å—ç½‘å¡çš„mac", NAME="eth0"
SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="xx:xx:xx:xx:xx:xx", NAME="eth1"
EOF

```

4ã€é‡å¯reboot





ä½ çš„ç›®æ ‡æ‹“æ‰‘ï¼ˆæœ€ç»ˆå½¢æ€ï¼‰

```
        å¤–ç½‘
         |
       eth0
         |
       br1  <---- å®¿ä¸»å¤–ç½‘ IP
      /   \
   vnet0  å®¿ä¸»
     |
   vm001(å¤–ç½‘)

--------------------------------

       å†…ç½‘
         |
       eth1
         |
       br2  <---- å®¿ä¸»å†…ç½‘ IP
      /   \
   vnet1  å®¿ä¸»
     |
   vm001(å†…ç½‘)
```

### â‘¡å¤–ç½‘æ¡¥ br1ï¼ˆå®¿ä¸»æ‹¿å¤–ç½‘ IPï¼‰

```shell
cat  <<EOF > /etc/NetworkManager/system-connections/br1.nmconnection
[connection]
id=br1
uuid=è¿™é‡Œä½¿ç”¨uuidgenç”Ÿæˆï¼Œåœ¨vimé‡Œè¾“å…¥:r!uuidgenå³å¯
type=bridge
interface-name=br1
autoconnect=true

[bridge]
stp=false

[ipv4]
method=auto

[ipv6]
method=ignore
EOF
```

------

### â‘¢ eth0 ä½œä¸º br1 ä»å£ï¼ˆä¸æ‹¿ IPï¼‰

```shell
cat  <<EOF >  /etc/NetworkManager/system-connections/eth0.nmconnection
[connection]
id=eth0
uuid=è¿™é‡Œä½¿ç”¨uuidgenç”Ÿæˆï¼Œåœ¨vimé‡Œè¾“å…¥:r!uuidgenå³å¯
type=ethernet
interface-name=eth0
autoconnect=true
master=br1
slave-type=bridge

[ethernet]

[ipv4]
method=disabled

[ipv6]
method=ignore

[proxy]
EOF
```

------

### â‘£ å†…ç½‘æ¡¥ br2ï¼ˆå®¿ä¸»æ‹¿å†…ç½‘ IPï¼‰

```shell
cat  <<EOF > /etc/NetworkManager/system-connections/br2.nmconnection
[connection]
id=br2
uuid=è¿™é‡Œä½¿ç”¨uuidgenç”Ÿæˆï¼Œåœ¨vimé‡Œè¾“å…¥:r!uuidgenå³å¯
type=bridge
interface-name=br2
autoconnect=true

[bridge]
stp=false

[ipv4]
method=manual
addresses=10.100.1.1/24

[ipv6]
method=ignore

EOF
```

------

### â‘¤ eth1åŠ å…¥ br2ï¼ˆä¸æ‹¿ IPï¼‰

```shell
cat  <<EOF >  /etc/NetworkManager/system-connections/eth1.nmconnection
[connection]
id=eth1
uuid=è¿™é‡Œä½¿ç”¨uuidgenç”Ÿæˆï¼Œåœ¨vimé‡Œè¾“å…¥:r!uuidgenå³å¯
type=ethernet
interface-name=eth1
master=br2
slave-type=bridge
autoconnect=true

[ethernet]

[ipv4]
method=disabled

[ipv6]
method=ignore

[proxy]

EOF
```



### â‘¥ ä¿®æ”¹ç½‘å¡æ–‡ä»¶çš„æƒé™

```shell
chmod 600 /etc/NetworkManager/system-connections/*
```



------

### ğŸ” æ¿€æ´»é¡ºåºï¼ˆ**éå¸¸é‡è¦**ï¼‰

âš ï¸ å»ºè®® **æœ¬åœ°æ§åˆ¶å°æ“ä½œï¼Œä¸è¦ SSH**ï¼Œå¦‚æœæ²¡æ³•æœ¬åœ°æ§åˆ¶å°ï¼Œé‚£å°±ä¸‹é¢çš„4æ¡å‘½ä»¤ä¸€æŠŠæ•²ï¼Œä¸€å®šè¦ä¿è¯å‰é¢çš„æ­£ç¡®ã€‚

```shell
nmcli connection reload
nmcli connection up br1
nmcli connection up eth0
nmcli connection up br2
nmcli connection up eth1
```

æ£€æŸ¥ï¼š

```bash
ip a
brctl show   # æ²¡æœ‰å°±ï¼šyum -y install epel-release && dnf -y install bridge-utils
```

ä½ åº”è¯¥çœ‹åˆ°ï¼š

- `br1` æœ‰å¤–ç½‘ IP
- `br2` æœ‰å†…ç½‘ IP
- `em1/em2` **æ²¡æœ‰ IP**
- `vnetX` è‡ªåŠ¨æŒ‚åœ¨å¯¹åº” bridge





## 2.2 ksæ–‡ä»¶å’Œisoå‡†å¤‡å¥½

```
[root@localhost data]# pwd
/data
[root@localhost data]# tree
.
â”œâ”€â”€ isos
â”‚Â Â  â””â”€â”€ Rocky-10.1-x86_64-minimal.iso
â””â”€â”€ ks
    â””â”€â”€ ks-rocky10.cfg

2 directories, 2 files
[root@localhost data]# 

```

```shell
[root@localhost data]# cat /data/ks/ks-rocky10.cfg 
# ===============================
# åŸºç¡€å®‰è£…æ–¹å¼
# ===============================
text
reboot
cdrom

# ===============================
# è¯­è¨€ / é”®ç›˜ / æ—¶åŒº
# ===============================
lang en_US.UTF-8
keyboard us
timezone Asia/Shanghai

# ===============================
# ç½‘ç»œï¼ˆDHCPï¼Œå®‰è£…åå¯æ”¹é™æ€IPï¼‰
# ===============================
# network --bootproto=dhcp --device=eth0 --onboot=on

# ===============================
# ç½‘ç»œï¼ˆé™æ€ IPï¼Œç”Ÿäº§ç¯å¢ƒï¼‰
# ===============================

# eth0 - å¤–ç½‘ï¼ˆé»˜è®¤è·¯ç”±ï¼‰
network --device=eth0 --bootproto=static --ip=192.168.126.100 --netmask=255.255.255.0 --gateway=192.168.126.2 --nameserver=192.168.126.2 --onboot=on --activate

# eth1 - å†…ç½‘
network --device=eth1 --bootproto=static --ip=123.0.0.1 --netmask=255.255.255.0 --onboot=on --activate


# ===============================
# Root å¯†ç 
# ===============================
rootpw --plaintext ChangeMe123!

# ===============================
# SELinux / é˜²ç«å¢™
# ===============================
selinux --disabled
firewall --disabled

# ===============================
# å¯åŠ¨å™¨
# ===============================
bootloader --location=mbr

# ===============================
# ç£ç›˜åˆ†åŒºï¼ˆLVMï¼‰ æ³¨æ„vdaè·Ÿæ€»çº¿çš„å…³ç³»
# ===============================
zerombr
ignoredisk --only-use=vda
clearpart --all --initlabel

part biosboot --fstype=biosboot --size=2
part /boot --fstype=xfs --size=1024
part swap --size=2048

part pv.01 --grow
volgroup vg0 pv.01

logvol / --vgname=vg0 --percent=100 --name=root --fstype=xfs


# ===============================
# è½¯ä»¶åŒ…
# ===============================
%packages --ignoremissing
@^minimal-environment
@core

curl
bash-completion
net-tools
chrony
rsyslog
lsof

-audio
-plymouth
%end

# ===============================
# å®‰è£…åé…ç½®
# ===============================
%post --log=/root/ks-post.log

# è®¾ç½®æ—¶é’Ÿ
systemctl enable chronyd
systemctl start chronyd

# å°† RTC è®¾ç½®ä¸º UTCï¼ŒåŒæ—¶ç«‹å³ä¿®æ­£ç³»ç»Ÿæ—¶é—´ï¼Œä¿è¯ç³»ç»Ÿæ—¶é—´å’Œæœ¬åœ°æ—¶åŒºæ˜¾ç¤ºæ­£ç¡®
timedatectl set-local-rtc 0 --adjust-system-clock


# å¯ç”¨ä¸²å£æ§åˆ¶å° (KVM console)
systemctl enable serial-getty@ttyS0.service

# SSH åŸºç¡€åŠ å›º
sed -i 's/^#UseDNS yes/UseDNS no/' /etc/ssh/sshd_config
sed -i 's/^GSSAPIAuthentication yes/GSSAPIAuthentication no/' /etc/ssh/sshd_config
systemctl restart sshd

# ç¡®ä¿ä¼ ç»Ÿç½‘å¡å‘½åï¼Œvirsh-installé‡Œå¸¦ä¸Šäº†æ— éœ€è¿™é‡Œæ‰“å¼€,è€Œä¸”å¯¹äºrokcy10ä¹Ÿè¦ä¼˜åŒ–udev/rules.d/ä¸‹çš„æ–‡ä»¶ï¼Œå¤‡ç€ä¸ç”¨äº†ã€‚
# sed -ri.bak '/^GRUB_CMDLINE_LINUX=/s@(.*)"$@\1 net.ifnames=0 biosdevname=0"@' /etc/default/grub
# grub2-mkconfig -o /boot/grub2/grub.cfg
# cat <<EOF > /etc/udev/rules.d/50-persistent-net.rules
# SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="ç¬¬ä¸€å—ç½‘å¡çš„mac", NAME="eth0"
# SUBSYSTEM=="net", ACTION=="add", ATTR{address}=="xx:xx:xx:xx:xx:xx", NAME="eth1"
# EOF


# æé«˜æ–‡ä»¶å¥æŸ„
cat >> /etc/security/limits.conf <<EOF
* soft nofile 1048576
* hard nofile 1048576
* soft nproc  65535
* hard nproc  65535
EOF

# sysctl å¸¸ç”¨ä¼˜åŒ–
cat > /etc/sysctl.d/99-prod.conf <<EOF
net.ipv4.ip_forward = 0
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_tw_recycle = 0
net.core.somaxconn = 65535
fs.file-max = 2097152
vm.swappiness = 10
EOF

sysctl --system

%end


```

å¸¦æ³¨é‡Šç‰ˆğŸ‘‡ todo

```
ç•¥ï¼Œå¤åˆ¶ç»™GPT è®©ä»–æ³¨é‡Šå°±å¥½
```

### 1ï¸âƒ£æ£€æŸ¥ksæ–‡ä»¶

![image-20251223185545997](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251223185545997.png)

```shell
yum -y install pykickstart
ksvalidator ks-rocky.cfg
```

![image-20251223185639297](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251223185639297.png)



------

### 2ï¸âƒ£ åˆ›å»ºä¸€ä¸ªå° ISO æ–‡ä»¶ï¼ŒåªåŒ…å« KS æ–‡ä»¶

```shell
root@localhost ~]# 
[root@localhost ~]# tree /data/
/data/
â”œâ”€â”€ isos
â”‚Â Â  â””â”€â”€ Rocky-10.1-x86_64-minimal.iso
â””â”€â”€ ks
    â”œâ”€â”€ ks-rocky10.cfg
    â””â”€â”€ ks-rocky10.iso

2 directories, 3 files

```

 KS æ–‡ä»¶åœ¨å®¿ä¸»æœº `/data/ks/ks-rocky10.cfg`ï¼š

```
mkdir -p /tmp/ks-iso
cp /data/ks/ks-rocky10.cfg /tmp/ks-iso/

# åˆ›å»º ISOï¼ŒæŒ‚è½½ç‚¹ä¸ºæ ¹ç›®å½•ï¼Œâ€œinst.ks=cdrom:/ks-rocky10.cfgâ€
genisoimage -output /data/ks/ks-rocky10.iso -volid ks -joliet -rock /tmp/ks-iso
```

![image-20251223174146310](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251223174146310.png)

#### å‚æ•°è§£æ

1. **`genisoimage`**
   - ç”Ÿæˆ ISO æ–‡ä»¶çš„å‘½ä»¤ï¼Œç›¸å½“äºæŠŠä¸€ä¸ªç›®å½•æ‰“åŒ…æˆå…‰ç›˜é•œåƒã€‚
   - Rocky 10 / RHEL 10 çš„å®‰è£…å™¨å¯ä»¥è¯†åˆ« ISO ä¸Šçš„ KS æ–‡ä»¶ã€‚
2. **`-output /data/ks/ks-rocky10.iso`**
   - æŒ‡å®šç”Ÿæˆçš„ ISO æ–‡ä»¶è·¯å¾„å’Œæ–‡ä»¶åã€‚
   - è¿™é‡Œä¼šåœ¨å®¿ä¸»æœº `/data/ks/` ä¸‹ç”Ÿæˆ `ks-rocky10.iso`ã€‚
3. **`-volid ks`**
   - è®¾ç½® ISO å·æ ‡ï¼ˆvolume IDï¼‰ï¼Œç±»ä¼¼å…‰ç›˜çš„åå­—ã€‚
   - å¯ä»¥éšä¾¿å–ï¼Œä½†æœ€å¥½ç®€çŸ­ï¼Œä¸è¦æœ‰ç©ºæ ¼ã€‚
4. **`-joliet`**
   - å…è®¸ ISO æ–‡ä»¶ä¸­ä½¿ç”¨ Windows é£æ ¼é•¿æ–‡ä»¶åï¼ˆæœ€å¤š 64 ä¸ªå­—ç¬¦ï¼‰ï¼Œå…¼å®¹æ€§æ›´å¥½ã€‚
   - å¯¹ Linux å®‰è£…æ¥è¯´å¯é€‰ï¼Œä½†åŠ ä¸Šæ²¡æœ‰åå¤„ã€‚
5. **`-rock`**
   - å¼€å¯ Rock Ridge æ‰©å±•ï¼Œè®© ISO æ”¯æŒ Linux çš„æ–‡ä»¶æƒé™å’Œé•¿æ–‡ä»¶åã€‚
   - ä¿è¯ Linux è™šæ‹Ÿæœºå¯ä»¥æ­£ç¡®è¯»å–æ–‡ä»¶æƒé™ã€‚
6. **`/tmp/ks-iso`**
   - æŒ‡å®šè¦æ‰“åŒ…çš„æºç›®å½•ï¼Œè¿™é‡Œæ˜¯ä½ å­˜æ”¾ `ks-rocky10.cfg` çš„ç›®å½•ã€‚
   - ISO ä¼šæŠŠè¿™ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶ä½œä¸ºå…‰ç›˜æ ¹ç›®å½•æ‰“åŒ…è¿›å»ã€‚



## 2.3 å®‰è£…å‘½ä»¤å®Œå…¨ç¦»çº¿ç‰ˆ(ks)ï¼š

å®‰è£…kvmç›¸å…³å·¥å…·ï¼Œå¯åŠ¨kvmå®ˆæŠ¤è¿›ç¨‹

```shell
yum -y install qemu-kvm libvirt virt-install virt-viewer
systemctl enable --now libvirtd
```

é«˜çº§ç‰ˆéªŒè¯OKï¼ˆrocky9.7ï¼Œrocky10éƒ½OKï¼‰ğŸ‘‡é«˜çº§åœ¨è¿›å»ç½‘å¡æ˜¯eth0 eth1 ä¸”é…åˆksé‚£è¾¹ç›´æ¥ç»™eth0 1 é…ç½®å¥½IPï¼Œè¿›å»å°±èƒ½ç”¨ï¼Œç»“åˆæ— GUIå®‰è£…å¿«ã€‚

```shell
virt-install \
--name vm001 \
--memory 2048 \
--vcpus 2 \
--cpu host \
--disk path=/var/lib/libvirt/images/vm001.qcow2,size=15,bus=virtio,cache=none \
--os-variant rocky10 \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--graphics none \
--console pty,target_type=serial \
--location /data/isos/Rocky-10.1-x86_64-minimal.iso \
--disk path=/data/ks/ks-rocky10.iso,device=cdrom \
--extra-args "inst.ks=cdrom:/ks-rocky10.cfg net.ifnames=0 biosdevname=0 inst.text console=ttyS0,115200n8"
```

åŸºç¡€ç‰ˆå·²éªŒè¯OKğŸ‘‡

```shell
virt-install \
--name vm001 \
--memory 2048 \
--vcpus 2 \
--cpu host \
--disk path=/var/lib/libvirt/images/vm001.qcow2,size=15,bus=virtio,cache=none \
--os-variant rocky10 \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--graphics none \
--console pty,target_type=serial \
--location /data/isos/Rocky-10.1-x86_64-minimal.iso \
--disk path=/data/ks/ks-rocky10.iso,device=cdrom \
--extra-args "inst.ks=cdrom:/ks-rocky10.cfg inst.text console=ttyS0,115200n8"
```



æ³¨æ„ï¼švmçš„æ—¶é—´ã€ç½‘å¡eth0

å…³é”®ç‚¹ï¼š

1. ç¬¬äºŒä¸ª `--disk` æŠŠ KS ISO ä½œä¸º CD-ROM æŒ‚è½½åˆ°è™šæ‹Ÿæœºã€‚
2. `inst.ks=cdrom:/ks-rocky10.cfg` â†’ è·¯å¾„æ˜¯ **ISO æ ¹ç›®å½•ä¸‹çš„ KS æ–‡ä»¶å**ã€‚
3. `inst.text` â†’ æ–‡æœ¬æ¨¡å¼å®‰è£…ã€‚
4. `console=ttyS0,115200n8` â†’ ä¸²å£è¾“å‡ºã€‚



**ä»¥ä¸Šçš„å®‰è£…å‘½ä»¤é…åˆä¸Šé¢ksï¼Œå®æ“æˆåŠŸï¼Œå…³é”®é˜¶æ®µæˆªå›¾å¦‚ä¸‹ï¼Œæ³¨ä¸åŒçš„ç³»ç»Ÿå®‰è£…kså¯èƒ½ä¸åŒã€‚**

![image-20251224103720442](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251224103720442.png)





![image-20251224103809220](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251224103809220.png)



![image-20251224103830634](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251224103830634.png)



![image-20251224103845809](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251224103845809.png)



![image-20251224103859474](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251224103859474.png)



![image-20251224104051993](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251224104051993.png)

è¾“å…¥ctrl + ]é€€åˆ°å®¿ä¸»æœºå±‚é¢ å†æ¬¡è¿›å…¥vish console <è™šæ‹Ÿæœºçš„åç§°>å°±å¯ä»¥äº†



# 3ã€è™šæ‹Ÿæœºåˆå§‹åŒ–(ç½‘ç»œæ¡¥æ¥)

## ğŸ–¥ï¸ è™šæ‹Ÿæœº vm001 æ€ä¹ˆæ¡¥æ¥

- ç½‘å¡1 â†’ bridge = `br1`
- ç½‘å¡2 â†’ bridge = `br2`



å¥½çš„ï¼Œæˆ‘å¸®ä½ æ•´ç†ä¸€ä¸‹ **KVM ä¸‹ç¼–è¾‘ VMï¼ˆä»¥ vm001 ä¸ºä¾‹ï¼‰æ¡¥æ¥ç½‘å¡çš„å®Œæ•´æ­¥éª¤**ï¼Œé€‚ç”¨äºå‘½ä»¤è¡Œå’Œ `virt-manager` ä¸¤ç§æ–¹å¼ã€‚

------

## **æ–¹æ³•ä¸€ï¼šå‘½ä»¤è¡Œé…ç½®ï¼ˆvirsh / XMLï¼‰**

1. **æŸ¥çœ‹è™šæ‹Ÿæœºå½“å‰ç½‘ç»œ**

```bash
virsh domiflist vm001
bridge link
```

è¾“å‡ºç¤ºä¾‹ï¼šå¯ä»¥çœ‹åˆ°forwardingçŠ¶æ€ï¼Œå…¶å®å®¿ä¸»æœºå“ªé‡Œbrå·²ç»å…³é—­stpäº†ï¼Œæ‰€ä»¥å¿…ç„¶æ˜¯forwardingäº†ã€‚

![image-20251224111005296](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251224111005296.png)



è¿™é‡Œå¯èƒ½è¦å€ŸåŠ©guiè¿›åˆ°vm001é‡Œé…ç½®IPåœ°å€

![image-20251218173344993](02.KVMæ¶æ„å’Œå®‰è£….assets/image-20251218173344993.png)

```shell
[root@vm001 system-connections]# cp -a enp1s0.nmconnection enp7s0.nmconnection
[root@vm001 system-connections]# ll
total 8
-rw-------. 1 root root 229 Dec 12 03:30 enp1s0.nmconnection
-rw-------. 1 root root 229 Dec 12 03:30 enp7s0.nmconnection

[root@vm001 system-connections]# vi enp7s0.nmconnection
[root@vm001 system-connections]# cat enp7s0.nmconnection
[connection]
id=enp7s0
uuid=b8696dcd-ecd1-4463-a56a-38c35f31c43e
type=ethernet
autoconnect=true
interface-name=enp7s0

[ethernet]

[ipv4]
method=manual
addresses=123.1.1.2/24
dns=1.1.1.1


[ipv6]
addr-gen-mode=eui64
method=auto

[proxy]
[root@vm001 system-connections]#



[root@vm001 system-connections]# nmcli conn reload
[root@vm001 system-connections]# nmcli conn up enp7s0
Connection successfully activated (D-Bus active path: /org/freedesktop/NetworkManager/ActiveConnection/4)

[root@vm001 system-connections]# nmcli conn
NAME                UUID                                  TYPE      DEVICE
enp1s0              8ff79451-b5b0-3351-8f96-e5390579b2cc  ethernet  enp1s0
enp7s0              b8696dcd-ecd1-4463-a56a-38c35f31c43e  ethernet  enp7s0
lo                  9a306733-1a3d-446c-bc83-739178574d38  loopback  lo
Wired connection 1  51a49b21-e774-3cb6-b0bd-fbe9196eb95c  ethernet  --

[root@vm001 system-connections]# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host noprefixroute
       valid_lft forever preferred_lft forever
2: enp1s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 52:54:00:3b:74:51 brd ff:ff:ff:ff:ff:ff
    altname enx5254003b7451
    inet 192.168.126.130/24 brd 192.168.126.255 scope global dynamic noprefixroute enp1s0
       valid_lft 1522sec preferred_lft 1522sec
    inet6 fe80::5054:ff:fe3b:7451/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
3: enp7s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether 52:54:00:5a:a1:87 brd ff:ff:ff:ff:ff:ff
    altname enx5254005aa187
    inet 123.1.1.2/24 brd 123.1.1.255 scope global noprefixroute enp7s0
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe5a:a187/64 scope link noprefixroute
       valid_lft forever preferred_lft forever
[root@vm001 system-connections]# ping 123.1.1.2
PING 123.1.1.2 (123.1.1.2) 56(84) bytes of data.
64 bytes from 123.1.1.2: icmp_seq=1 ttl=64 time=0.407 ms
^C

[root@vm001 system-connections]# nmcli conn delete 'Wired connection 1'
Connection 'Wired connection 1' (51a49b21-e774-3cb6-b0bd-fbe9196eb95c) successfully deleted.
[root@vm001 system-connections]# nmcli conn
NAME    UUID                                  TYPE      DEVICE
enp1s0  8ff79451-b5b0-3351-8f96-e5390579b2cc  ethernet  enp1s0
enp7s0  b8696dcd-ecd1-4463-a56a-38c35f31c43e  ethernet  enp7s0
lo      9a306733-1a3d-446c-bc83-739178574d38  loopback  lo
[root@vm001 system-connections]#


# æŸ¥çœ‹åŒç½‘å¡åŒè·¯ç”±ã€‚
[root@vm001 system-connections]# ip route show
default via 192.168.126.2 dev enp1s0 proto dhcp src 192.168.126.130 metric 100
123.1.1.0/24 dev enp7s0 proto kernel scope link src 123.1.1.2 metric 101
192.168.126.0/24 dev enp1s0 proto kernel scope link src 192.168.126.130 metric 100


```

------





------

## ğŸ§ª éªŒè¯ä½ é¡ºåºå¯¹ä¸å¯¹ï¼ˆä¸€ä¸ªå‘½ä»¤ï¼‰

```bash
bridge link
```

ä½ ä¼šçœ‹åˆ°ï¼š

```
ens33 master br1 state forwarding
ens36 master br2 state forwarding
```

å¦‚æœé¡ºåºé”™äº†ï¼ŒçŠ¶æ€ä¼šæ˜¯ï¼š

- `disabled`
- `blocking`
- æˆ–åå¤ flap

------

## âœ… æœ€ä½³å®è·µï¼ˆä½ å¯ä»¥è®°ä½è¿™ä¸€æ¡ï¼‰

> **å‡¡æ˜¯ master / slave ç»“æ„ï¼ˆbridgeã€bondã€teamï¼‰ï¼š**
>
> **æ°¸è¿œå…ˆ up masterï¼Œå† up slave**

------

## ğŸ§  å†è¡¥ä¸€å¥ï¼ˆè¿ç»´ç»éªŒï¼‰

åœ¨ç”Ÿäº§ä¸Šæˆ‘ä»¬ä¸€èˆ¬ï¼š

```bash
nmcli conn reload
nmcli conn up br1
nmcli conn up br2
# ç¡®è®¤æ²¡é—®é¢˜
nmcli conn up em1
nmcli conn up em2
```

ä¸­é—´ç•™ **å‡ ç§’è§‚å¯Ÿ**ï¼Œé¿å…â€œå…¨ç½‘ä¸€æŠŠæ¢­â€ã€‚









# 4ã€winowså®‰è£…

virtioæ˜¯kvmçš„é©±åŠ¨æŠ€æœ¯ï¼Œç®€å•ç†è§£å°±æ˜¯åŠè™šæ‹ŸåŒ–æŠ€æœ¯é€ä¼ åˆ°ç‰©ç†æœºï¼ŒåŠ é€Ÿioï¼Œæœ‰å’Œç£ç›˜æ‰“äº¤é“çš„virtio_blkï¼Œä¹Ÿæœ‰å’Œç½‘å¡æ‰“äº¤é“çš„virtio_netï¼Œæœ‰ç»™linuxçš„ç”¨çš„ï¼Œåˆç»™windowç”¨çš„ã€‚



windowsçš„è¦ä¸‹è½½ï¼Œç”¨æœ€æ–°ç‰ˆå°±å¥½ã€‚

https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/



è¦åå°è·‘&ï¼Œé˜²æ­¢å®‰è£…å‡ºé—®é¢˜ã€‚

å®‰è£…åæ— ç½‘å¡ï¼Œæ‰‹åŠ¨æ·»åŠ é©±åŠ¨ç‰ˆğŸ‘‡

```shell
virt-install \
--name vm002 \
--memory 4096 \
--vcpus 4 \
--cpu host \
--machine q35 \
--disk path=/var/lib/libvirt/images/vm002.qcow2,size=20,bus=virtio,cache=writeback \
--os-variant win2k16 \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--console pty,target_type=serial \
--cdrom=/data/isos/cn_windows_server_2016_x64_dvd_9718765.iso \
--disk path=/data/isos/virtio-win-0.1.285.iso,device=cdrom &
```

```
virt-install \
--name vm002 \                       # è™šæ‹Ÿæœºåç§°ï¼ˆlibvirt ä¸­çš„å”¯ä¸€æ ‡è¯†ï¼‰
--memory 4096 \                      # åˆ†é… 4GB å†…å­˜ï¼ŒWin2016 æœ€ä½å¯ç”¨ã€è¾ƒç¨³
--vcpus 4 \                          # åˆ†é… 4 ä¸ª vCPU
--cpu host \                         # ç›´é€šå®¿ä¸» CPU æŒ‡ä»¤é›†ï¼Œæ€§èƒ½æœ€å¥½ï¼ˆç”Ÿäº§æ¨èï¼‰
--machine q35 \                      # ä½¿ç”¨ Q35 èŠ¯ç‰‡ç»„ï¼Œæ”¯æŒ PCIeï¼ŒWin æ›´å‹å¥½
--disk path=/var/lib/libvirt/images/vm002.qcow2,size=20,bus=virtio,cache=writeback \  
                                      # ç³»ç»Ÿç›˜ï¼š20Gï¼Œvirtio ç£ç›˜ï¼ˆéœ€é©±åŠ¨ï¼‰ï¼Œwriteback æ€§èƒ½/ç¨³å®šæ€§å¹³è¡¡
--network bridge=br1,model=e1000 \   # ç½‘å¡1ï¼šæ¡¥æ¥ br1ï¼ŒIntel e1000ï¼ˆWindows å®‰è£…é˜¶æ®µå…é©±ï¼‰
--network bridge=br2,model=e1000 \   # ç½‘å¡2ï¼šæ¡¥æ¥ br2ï¼ŒåŒç½‘å¡ï¼ˆå†…å¤–ç½‘/ä¸šåŠ¡ç½‘ï¼‰
--os-variant win2k16 \               # æŒ‡å®š Windows Server 2016ï¼Œä¼˜åŒ–é»˜è®¤è®¾å¤‡å‚æ•°
--cdrom /data/isos/cn_windows_server_2016_x64_dvd_9718765.iso \  
                                      # Windows Server 2016 å®‰è£… ISO
--disk path=/data/isos/virtio-win-0.1.285.iso,device=cdrom
                                      # VirtIO é©±åŠ¨å…‰ç›˜ï¼ˆå®‰è£…ååŠ è½½ç£ç›˜/ç½‘å¡é©±åŠ¨ç”¨ï¼‰

```



<img src="04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251225184039559.png" alt="image-20251225184039559" style="zoom: 33%;" />

ç£ç›˜è¯†åˆ«ä¸å‡ºæ¥ï¼Œè¦é©±åŠ¨åŠ è½½é€‰æ‹©ä¸Šé¢æŒ‚è½½çš„virtio-win-0.1.285.isoé‡Œçš„amdé‡Œçš„2k16ï¼Œå°±å¯ä»¥ç»§ç»­å®‰è£…äº†

![image-20251226152722259](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251226152722259.png)



![image-20251226152737330](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251226152737330.png)



![image-20251226152757474](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251226152757474.png)



ç­‰ä¸€ä¼švirt-managerçš„ç•Œé¢æŒ‰éœ€é‡è¿ä¸€ä¸‹å°±å¥½äº†

![image-20251226162153373](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251226162153373.png)



è¿˜æ²¡å®Œï¼Œéœ€è¦å®‰è£…virtioç½‘å¡é©±åŠ¨ï¼ŒåŒæ ·åœ¨ç¬¬äºŒå—é©±åŠ¨isoé‡Œæ‰¾åˆ°NetKVM/win2k16/amd64å®‰è£…å°±è¡Œäº†ã€‚

![image-20251226163942116](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251226163942116.png)



![image-20251226164228583](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251226164228583.png)

ç½‘ç»œOK

![image-20251226164253354](04.KVMå®ç°è‡ªåŠ¨åŒ–åˆ›å»ºè™šæ‹Ÿæœº.assets/image-20251226164253354.png)









# 5ã€cache=ä»€ä¹ˆï¼Ÿ

**åœ¨ KVM ä¸Šï¼šLinux VM å¿…é¡»ç”¨ `cache=none`ï¼ŒWindows VM å¿…é¡»ç”¨ `cache=writeback` æ‰ç¨³ã€‚**

## ç»“è®ºå…ˆç»™ä½ ä¸€å¥è¯

> **Linux ç”¨ `cache=none`ï¼Œæ˜¯ä¸ºäº†â€œé¿å…åŒé‡ç¼“å­˜ï¼ˆdouble cacheï¼‰â€ï¼ŒæŠŠç¼“å­˜è´£ä»»äº¤è¿˜ç»™æœ€æ‡‚ä¸šåŠ¡çš„åœ°æ–¹ã€‚**
>
> **Windows VM å¿…é¡»ç”¨ `cache=writeback`ï¼Œå¦åˆ™åŒæ­¥å†™ç›´æ¥æ‰“åˆ°å®¿ä¸»ç£ç›˜ä¼šå¯¼è‡´ç³»ç»Ÿå¡é¡¿å’ŒæœåŠ¡æŠ–åŠ¨ã€‚**

------

## è¿™ä»¶äº‹çš„æ ¸å¿ƒï¼š**Double Cacheï¼ˆåŒé‡ç¼“å­˜ï¼‰**

åœ¨ KVM åœºæ™¯ä¸‹ï¼Œå¦‚æœä¸ç”¨ `cache=none`ï¼ŒI/O è·¯å¾„æ˜¯è¿™æ ·çš„ï¼š

```text
Linux Guest Page Cache
        â†“
QEMU / Host Page Cache
        â†“
ç£ç›˜
```

ä¹Ÿå°±æ˜¯è¯´ï¼š

- **Guest æœ‰ä¸€ä»½é¡µç¼“å­˜**
- **Host ä¹Ÿæœ‰ä¸€ä»½é¡µç¼“å­˜**
- åŒä¸€ä»½æ•°æ®ï¼Œè¢«ç¼“å­˜äº†ä¸¤æ¬¡

------

## Double Cache åœ¨ Linux åœºæ™¯ä¸‹çš„é—®é¢˜

### 1ï¸âƒ£ æµªè´¹å†…å­˜ï¼ˆè¿™æ˜¯æœ€ç›´æ¥çš„ï¼‰

- Guest è®¤ä¸ºï¼šè¿™é¡µæˆ‘ç¼“å­˜ç€
- Host ä¹Ÿè®¤ä¸ºï¼šè¿™é¡µæˆ‘ç¼“å­˜ç€

ç»“æœï¼š

- 1GB æ•°æ®
- å®é™…å ç”¨ 2GB å†…å­˜

åœ¨ Linux Server ä¸Šï¼Œè¿™æ˜¯**ä¸å¯æ¥å—çš„æµªè´¹**ã€‚

------

### 2ï¸âƒ£ Linux æœ¬æ¥å°±â€œéå¸¸ä¼šç¼“å­˜â€

Linux çš„ page cache ç‰¹ç‚¹ï¼š

- LRU ç²¾ç»†
- å›æ”¶ç­–ç•¥æˆç†Ÿ
- èƒ½æ ¹æ® I/O æ¨¡å¼åŠ¨æ€è°ƒæ•´
- åº”ç”¨ï¼ˆMySQL / Redis / Webï¼‰éƒ½å›´ç»•å®ƒè®¾è®¡

ğŸ‘‰ **Linux Guest æ¯” Host æ›´â€œæ‡‚â€è¿™äº›æ•°æ®è¯¥ä¸è¯¥ç¼“å­˜**

------

### 3ï¸âƒ£ cache=none çš„æœ¬è´¨ï¼šæŠŠæƒåŠ›äº¤è¿˜ç»™ Guest

```bash
cache=none
```

ç­‰ä»·äºï¼š

```text
Host ä¸ç¼“å­˜
Guest å…¨æƒè´Ÿè´£
```

I/O è·¯å¾„å˜æˆï¼š

```text
Linux Guest Page Cache
        â†“
ç£ç›˜
```

è¿™åœ¨ Linux ä¸–ç•Œé‡Œæ˜¯**è®¾è®¡ä¸Šæ›´å¹²å‡€ã€æ›´ä¸€è‡´çš„æ¨¡å‹**ã€‚

------

## ä¸ºä»€ä¹ˆ Linux èƒ½â€œé©¾é©­â€ cache=noneï¼Ÿ

å…³é”®ä¸æ˜¯ KVMï¼Œè€Œæ˜¯ **Linux I/O æ¨¡å‹æœ¬èº«å°±ä¸ºè¿™ç§æ¨¡å¼è®¾è®¡è¿‡**ã€‚

### ä¸€ä»¶å…·ä½“äº‹å®

Linux åŸç”Ÿå°±å¤§é‡ä½¿ç”¨ï¼š

```text
O_DIRECT
```

ä¾‹å¦‚ï¼š

- æ•°æ®åº“ï¼ˆMySQL / PostgreSQLï¼‰
- Ceph OSD
- Elasticsearch
- å¤§è§„æ¨¡æ–‡ä»¶æœåŠ¡

è¿™äº›åœºæ™¯æœ¬æ¥å°±ï¼š

- ä¸ç”¨é¡µç¼“å­˜
- è‡ªå·±ç®¡ç† I/O
- è¿½æ±‚ç¡®å®šæ€§

ğŸ‘‰ `cache=none` å¯¹ Linux æ¥è¯´ **ä¸æ˜¯æ–°ä¸œè¥¿**

------

## é‚£æ€§èƒ½å‘¢ï¼Ÿä¼šä¸ä¼šæ…¢ï¼Ÿ

åœ¨ Linux ä¸‹ï¼š

- é¡ºåº I/Oï¼šå·®åˆ«ä¸å¤§
- éšæœº I/Oï¼šå–å†³äº workload
- é«˜å¹¶å‘ï¼š**cache=none åè€Œæ›´ç¨³å®š**

å› ä¸ºï¼š

- æ²¡æœ‰ host cache æŠ¢å†…å­˜
- æ²¡æœ‰åŒé‡å›æ”¶
- å»¶è¿Ÿæ›²çº¿æ›´å¹³æ»‘

------

## ç»™ä½ ä¸€ä¸ªå¯ä»¥â€œæ•™åˆ«äººâ€çš„æ€»ç»“

> **Linux ç”¨ cache=noneï¼Œä¸æ˜¯ä¸ºäº†å¿«ï¼Œ
> è€Œæ˜¯ä¸ºäº†ï¼š
>
> - é¿å…åŒé‡ç¼“å­˜
> - å‡å°‘å†…å­˜æµªè´¹
> - è®©æœ€æ‡‚æ•°æ®çš„ Linux è‡ªå·±åšç¼“å­˜å†³ç­–**

------

## ä¸€å¥è¯æ”¶å°¾ï¼ˆä½ è¿™ç±»ä¸“å®¶åœºåˆç”¨ï¼‰

> **cache=none æ˜¯ Linux ä¸–ç•Œçš„â€œå·¥ç¨‹æ´ç™–â€ï¼š
> ä¸å¤šç®¡é—²äº‹ï¼ŒæŠŠç¼“å­˜äº¤ç»™è¯¥ç®¡çš„äººã€‚**

å¦‚æœä½ æ„¿æ„ï¼Œä¸‹ä¸€æ­¥æˆ‘å¯ä»¥åªè®²ä¸€ä»¶äº‹ï¼š

- **ä¸ºä»€ä¹ˆæ•°æ®åº“ Linux VM å‡ ä¹ä¸€å®šé€‰ cache=none**
- æˆ– **ä¸ºä»€ä¹ˆ Ceph OSD å¿…é¡» cache=none**

ä½ æŒ‘ä¸€ä¸ªå°±è¡Œã€‚





å¥½ï¼Œè¿™æ¬¡æˆ‘ä¸“é—¨è®²**Windows åœ¨ KVM ä¸Šä¸ºä»€ä¹ˆä¸èƒ½ç”¨ `cache=none`**ï¼Œæˆ‘åªè®²ä¸€ä»¶äº‹ï¼Œå½»åº•è®²é€ï¼Œä¸å‘æ•£ã€‚

------

## ä¸€å¥è¯ç»“è®º

> **Windows åœ¨ KVM ä¸‹ä¸èƒ½ç”¨ `cache=none`ï¼Œå› ä¸ºå®ƒå¯¹åŒæ­¥å†™ï¼ˆsync writeï¼‰å’Œå»¶è¿ŸæŠ–åŠ¨æåº¦æ•æ„Ÿï¼Œhost cache è¢«ç»•è¿‡ä¼šå¯¼è‡´ VM å¡é¡¿ã€æœåŠ¡å‡æ­»ç”šè‡³æ›´æ–°å¤±è´¥ã€‚**

------

## æ ¸å¿ƒåŸå› ï¼šWindows çš„ I/O æ¨¡å‹ä¸ KVM I/O è·¯å¾„

åœ¨ Windows ä¸‹ï¼ŒI/O è·¯å¾„å¦‚ä¸‹ï¼š

```text
Windows Guest
   â†“
Virtio / emulated driver
   â†“
QEMU / libvirt
   â†“
Host å—è®¾å¤‡
   â†“
ç‰©ç†ç£ç›˜
```

### ğŸ”¹ Windows ä¸åŒæ­¥å†™

- NTFS é»˜è®¤ä¼šå¤§é‡ä½¿ç”¨ **åŒæ­¥å†™ï¼ˆFILE_FLAG_WRITE_THROUGH / flushï¼‰**
- æ¯æ¬¡å†™å…¥éƒ½è¦æ±‚æ•°æ®â€œçœŸæ­£è½ç›˜â€ï¼Œä¸èƒ½å»¶è¿Ÿ
- åº”ç”¨ï¼ˆSQL Serverã€Exchangeã€æ¸¸æˆæœã€AD ç­‰ï¼‰ä¹Ÿæ™®éå‘èµ·å¤§é‡ sync I/O

------

### ğŸ”¹ `cache=none` çš„å½±å“

```text
--disk cache=none
```

æ•ˆæœï¼š

- Host ä¸åšä»»ä½•é¡µç¼“å­˜
- æ¯ä¸ªåŒæ­¥å†™éƒ½ç›´æ¥æ‰“åˆ°ç‰©ç†ç£ç›˜
- å¦‚æœå®¿ä¸»å­˜å‚¨æœ‰ä»»ä½• I/O æŠ–åŠ¨æˆ–å»¶è¿Ÿï¼ŒWindows ç«‹åˆ»é˜»å¡

------

### ğŸ”¹ çœŸå®è¡¨ç°ï¼ˆç”Ÿäº§ä¸­å¸¸è§ï¼‰

1. **ç³»ç»Ÿå¡é¡¿ / å‡æ­»**

- é¼ æ ‡èƒ½åŠ¨ï¼Œä½†æ‰€æœ‰æœåŠ¡æ— å“åº”
- é«˜ I/O æœŸé—´ Windows å…¨é¢é˜»å¡

1. **æ›´æ–° / è¡¥ä¸æ…¢**

- Windows Update å¡ä½
- å…³æœº / é‡å¯é˜¶æ®µç­‰å¾…ç£ç›˜å“åº”ï¼Œå¯èƒ½å‡ ååˆ†é’Ÿ

1. **æ•°æ®åº“ / é«˜å¹¶å‘åº”ç”¨æŠ–åŠ¨**

- SQL Server / MySQL for Windows
- å»¶è¿Ÿçªå‘ï¼ŒTPS / tick rate é£™å‡ï¼Œæ€§èƒ½ä¸‹é™

------

## äºŒã€ä¸ºä»€ä¹ˆ Linux èƒ½æ‰›ï¼ŒWindows æ‰›ä¸ä½ï¼Ÿ

- Linux å†…æ ¸ I/O è°ƒåº¦æ›´æ¿€è¿›ã€æ›´å®¹å¿å»¶è¿Ÿ
- Linux çš„ O_DIRECT / page cache æ¨¡å‹å…è®¸åº”ç”¨è‡ªå·±ç®¡ç† I/O
- Windows æ›´ä¿å®ˆï¼Œå¯¹å»¶è¿Ÿéå¸¸æ•æ„Ÿ

> æ ¸å¿ƒå°±æ˜¯ï¼š**Windows ä¾èµ–å®¿ä¸»ç¼“å­˜æ¥â€œå¹³æ»‘ I/Oâ€ï¼Œcache=none ä¼šç›´æ¥æ‰“ç¢è¿™ä¸ªç¼“å†²**

------

## ä¸‰ã€ç”Ÿäº§çº§ç»“è®º

| OS      | å»ºè®® cache æ¨¡å¼  | åŸå›                                   |
| ------- | ---------------- | ------------------------------------- |
| Linux   | none / writeback | Linux è‡ªå·±ç®¡ç†ç¼“å­˜ï¼ŒåŒé‡ç¼“å­˜æµªè´¹å†…å­˜  |
| Windows | writeback        | é¿å… I/O æŠ–åŠ¨ï¼Œä¿éšœç³»ç»Ÿç¨³å®šå’Œåº”ç”¨æ€§èƒ½ |

------

## å››ã€å£è¯€ï¼ˆæ–¹ä¾¿è®°å¿†ï¼‰

> **Linux æ‰› noneï¼ŒWindows æ‰›ä¸ä½ï¼›
> å°å­˜å‚¨åˆ« noneï¼Œwriteback æ‰ç¨³ã€‚**

------

## äº”ã€æ€»ç»“ä¸€å¥è¯

> **Windows VM åœ¨ KVM ä¸Šå¿…é¡»æ˜¾å¼å†™ `cache=writeback`ï¼Œé»˜è®¤ `none` ä¼šå¯¼è‡´ç³»ç»Ÿå‡æ­»å’ŒæœåŠ¡ä¸ç¨³å®šï¼Œè¿™æ˜¯â€œé“å¾‹â€ã€‚**

------

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ ç”»ä¸€å¼ **Windows vs Linux åœ¨ cache=none ä¸‹ I/O è·¯å¾„ç¤ºæ„å›¾**ï¼Œç›´è§‚å±•ç¤ºä¸ºä»€ä¹ˆ Windows å¡ã€Linux æ‰›å¾—ä½ã€‚









# 6ã€å®‰è£…å‘½ä»¤å®Œå…¨ç¦»çº¿ç‰ˆ(æ¨¡æ¿)ï¼š



## æ–¹æ³•1ï¼šç£ç›˜å¯¼å…¥æ³•

ä¹‹å‰2.3é‚£é‡Œç”¨çš„æ˜¯kså®ç°ç¬¬äºŒé˜¶æ®µçš„é…ç½®å®‰è£…ï¼Œè€Œè¿™é‡Œæ˜¯åŸºäºä¹‹å‰å®‰è£…å¥½çš„vmç›´æ¥åˆ›å»ºçš„ã€‚

```shell
# æŸ¥çœ‹è¦åšæˆæ¨¡æ¿çš„vmæ˜¯ä»€ä¹ˆæ ·çš„èµ„æºï¼Œå½“ç„¶è¿™äº›èµ„æºéƒ½æ˜¯å¯è°ƒçš„
[root@localhost images]# ll -h /var/lib/libvirt/images/
total 12G
-rw-------. 1 qemu qemu 16G Dec 25 18:44 vm001.qcow2
-rw-------. 1 root root 21G Dec 29 12:00 vm002.qcow2
[root@localhost images]# 
[root@localhost images]# virsh dumpxml vm001 |grep -Ei 'os id=|cpu|memory'
      <libosinfo:os id="http://rockylinux.org/rocky/9"/>
  <memory unit='KiB'>2097152</memory>
  <currentMemory unit='KiB'>2097152</currentMemory>
  <vcpu placement='static'>4</vcpu>
  <cpu mode='host-model' check='partial'/>
[root@localhost images]# 
[root@localhost images]# qemu-img info /var/lib/libvirt/images/vm001.qcow2 |grep size
virtual size: 15 GiB (16106127360 bytes)
disk size: 2.2 GiB
cluster_size: 65536
    disk size: 2.2 GiB
        extent size hint: 1048576
# æœ€ç»ˆåšæˆæ¨¡æ¿
[root@localhost images]# cp /var/lib/libvirt/images/vm001.qcow2 /var/lib/libvirt/images/rocky9-tmp-4c2g15g.qcow2
[root@localhost images]# ll -h /var/lib/libvirt/images/
total 14G
-rw-------. 1 root root 16G Dec 30 15:54 rocky9-tmp-4c2g15g.qcow2
-rw-------. 1 qemu qemu 16G Dec 25 18:44 vm001.qcow2
-rw-------. 1 root root 21G Dec 29 12:00 vm002.qcow2



```



åˆ©ç”¨æ¨¡æ¿åˆ›å»ºvm

å¤åˆ¶ç£ç›˜

```
cp /var/lib/libvirt/images/rocky9-tmp-4c2g15g.qcow2 /var/lib/libvirt/images/vm003.qcow2
```

é…ç½®æœºå™¨å¼€æœºå³å¯

```shell
virt-install \
--name vm003 \
--memory 2048 \
--vcpus 2 \
--cpu host \
--os-variant rocky9 \
--disk path=/var/lib/libvirt/images/vm003.qcow2,bus=virtio,cache=none \
--network bridge=br1,model=virtio \
--network bridge=br2,model=virtio \
--graphics none \
--console pty,target_type=serial \
--import

```



## æ–¹æ³•2ï¼švm cloneæ³• (æ¨è)



```shell
virt-clone -o vm001 -n vm005 -f /var/lib/libvirt/images/vm005.qcow
virtsh start vm005
```

-o vm001   ç”¨å­˜åœ¨çš„vm

-n vm005   åˆ›å»ºçš„æ–°çš„vm

-f xxx  	   æ–°vmçš„ç£ç›˜è·¯å¾„ï¼Œè¯¥æ–‡ä»¶æ— éœ€äº‹å…ˆåˆ›å»º

æ‰€ä»¥éœ€è¦ä¸€ä¸ªæ¨¡æ¿vmï¼Œ

1ã€å¸¸ç”¨é…ç½® å‡ æ ¸å‡ Gå¤šå¤§ç£ç›˜ï¼Œçœçš„åé¢å†æ”¹

2ã€å†…æ ¸ä¼˜åŒ–

3ã€æ—¶é—´æ—¶åŒº

