# ç¬¬2èŠ‚. ç½‘ç»œæ¶æ„

ç½‘å·¥ï¼Œç•¥







# å·¥ä½œæ¡ˆä¾‹-å¦‚ä½•ç›‘ç®¡å¼€å‘å†…ç½‘çš„urlè®¿é—®



è¿™æ˜¯ä¸€ä¸ªè¿‡ç¨‹è®°å½•ï¼Œæ²¡æœ‰æ•´ç†ï¼Œå¤‡å¿˜ç”¨çš„





ä¼ ç»Ÿé˜²ç«å¢™é‡Œçš„urlåŠŸèƒ½ï¼Œå¼€æºå¦‚ä½•å®ç°å‘¢



å…³é”®è¯squidï¼Œæ¶æ„æ­å»ºopnsence



**ç³»ç»Ÿå­¦ä¹ **https://www.cnblogs.com/weq0805/p/15242170.html#_lab2_0_0



å­¦ä¹ è®°å½•



squidä½œä¸ºopnsenseçš„ä¸€ä¸ªæ’ä»¶ï¼Œæ‰€ä»¥è¦å…¨é¢è¿æ¥è¿™ä¸ªæ’ä»¶ï¼Œè¿˜æ˜¯è¦è¿›è¡Œ**ç³»ç»Ÿå­¦ä¹ **

1ã€squidä½œä¸ºæ­£ä»£ä½¿ç”¨çš„ï¼Œåä»£å°±æ˜¯nginxã€haproxyã€f5ã€lvsç›´æµï¼›è€Œæ­£ä»£åšä»£ç†çš„ç”¨æˆ·clients

2ã€squidè™½è¯´æ˜¯æ­£å‘ä»£ç†ï¼Œä½†æ˜¯ä¹Ÿæœ‰åä»£ï¼Œå®ƒçš„åä»£å°±æ˜¯æŒ‡çš„æœ¬åœ°åŠ é€Ÿç¼“å­˜ï¼Œè®¿é—®è¿‡çš„ç½‘é¡µç«™ç‚¹å°±æœ‰ç¼“å­˜ï¼Œä¸‹æ¬¡ç”¨æˆ·ç›´æ¥è¯»å–ï¼Œæ— éœ€å»äº’è”ç½‘ç´¢å–ã€‚è¿™å°±æ˜¯squidåä»£çš„ä½“ç°ã€‚

3ã€è‚¯å®šæ˜¯é€æ˜æ¨¡å¼è½åœ°æ‹‰ï¼Œä¸ç”¨ç”¨ä¼ ç»Ÿçš„clientä¹Ÿå°±æ˜¯pcä¸Šè®¾ç½®ä»£ç†çš„æ–¹å¼çš„ï¼Œä¸è¿‡æ‰‹æœºç«¯ä¹Ÿè®¸å¯ä»¥çµæ´»æµ‹è¯•æŠŠè¿™ä¸ªä¼ ç»Ÿæ¨¡å¼ç”¨èµ·æ¥ã€‚æ©çµæ´»è¿˜æ˜¯ä¼ ç»Ÿæ¨¡å¼ï¼Œä¸ç„¶æ‰‹æœºè¿˜å¾—ç½‘å…³ä¸Šé…ç½®PBRã€‚æˆ–è€…é˜²ç«å¢™é…ç½®PBRä¹‹ç±»çš„ã€‚







æŒ‰ç…§ä¸Šé¢çš„ç½‘ç«™èµ°

1ã€systemctlæœåŠ¡è‡ªå·±å¼„





2ã€é€æ˜ä»£ç†çš„dnsè‡ªå·±å¤„ç†

dnsåŒæ ·é…ç½®squidçš„å†…ç½‘IPï¼Œ192.168.127.144

ä½†æ˜¯è¯·æ±‚å¤±è´¥ï¼ŒæŸ¥æ‰¾åŸå› ï¼Œæ‰¾åˆ°äº†ğŸ‘‡



è¿™é‡Œå°†dnsè¯·æ±‚è½¬å‘çš„å“¦VMçš„è™šæ‹Ÿç½‘å…³

![image-20241009092823661](2-ç½‘ç»œæ¶æ„.assets/image-20241009092823661.png)



é€šè¿‡æŠ“åŒ…å¯è§ï¼Œdnsè¯·æ±‚å‡ºå»çš„ipæ˜¯å†…ç½‘IP127æ®µçš„ï¼Œ126.2å›åŒ…è¿›ä¸äº†æ¥çš„ï¼ŒVMçš„hostç½‘ç»œã€‚

![image-20241009092858030](2-ç½‘ç»œæ¶æ„.assets/image-20241009092858030.png)



åªéœ€è¦iptables åšSNATå°±è¡Œäº†

![image-20241009093201608](2-ç½‘ç»œæ¶æ„.assets/image-20241009093201608.png)

è¿™ä¸å°±OKäº†å˜›ï¼Œæ‰€ä»¥ä¸è¦åŠ ç­æï¼Œä¸è¦åŠ ç­æï¼Œè´ªç‹¼å…¥å‘½çš„äººï¼Œä¸ç®¡å¹²ä»€ä¹ˆéƒ½è¦æ³¨æ„èŠ‚åˆ¶ï¼šæ‰“æ¸¸æˆã€çœ‹å°è¯´ã€ç©ã€ç ”ç©¶æŠ€æœ¯ã€å­¦ä¹ ï¼Œå”‰å­¦ä¹ ä¸ä¼šï¼Œçœ‹æ¥å­¦ä¹ å…»äººå•Šï¼Œå“ˆå“ˆå“ˆã€‚å­¦ä¹ ä¹Ÿä¼šçš„ï¼Œæ˜¨å¤©è¦æ˜¯ç»§ç»­ä¸ä¸‹ç­ç ”ç©¶çŠ¶æ€å°±ä¸å¥½ï¼Œåˆä¼¤èº«ã€‚æ‰€ä»¥è´ªç‹¼å…¥å‘½ä¸€å®šè¦å°å¿ƒã€‚

![image-20241009093230191](2-ç½‘ç»œæ¶æ„.assets/image-20241009093230191.png)





å†æŠŠdnså¾—iptablesæ”¹æˆæœ¬åœ°3128ç«¯å£å»ï¼Œå°è¯•æ¨¡æ‹Ÿä¼ ç»Ÿæ¨¡å¼ä¹Ÿå°±æ˜¯client windowsé…ç½®ä»£ç†--sock5è‚¯å®šæ˜¯äº†ï¼Œå› ä¸ºä¼ ç»Ÿæ¨¡å¼ä¹Ÿæ˜¯æŠŠdnsä»£ç†å‡ºå»å¾—---10.2é‚£è¾¹æŠ“åŒ…çœ‹åˆ°äº†ã€‚

å…³äºä¼ ç»Ÿæ¨¡å¼å’Œé€æ˜æ¨¡å¼çš„dnså¤„ç†

1ã€ä¼ ç»Ÿæ¨¡å¼ï¼Œä»£ç†é‡Œçš„å†™æ³•å…¶å®å°±æ˜¯sock5ï¼ŒåŒ…å«udpçš„ï¼Œæ‰€ä»¥dnsä¹Ÿæ˜¯èµ°çš„3128squidï¼Œsuqidæœºå™¨å†ç»™ä½ å»10.2æœ¬åœ°dnsè¯·æ±‚çš„

2ã€é€æ˜æ¨¡å¼ï¼Œiptables è½¬çš„ï¼Œæ‰€ä»¥å‡ºå»å°†udp 53è½¬åˆ°æœ¬åœ°10.2çš„dnsï¼ŒåŒæ—¶å‡ºå‘ä¹Ÿè¦åšSNATï¼Œå¦åˆ™å¤–ç•Œæ²¡æœ‰å†…ç½‘hostç½‘ç»œçš„IPè·¯ç”±çš„ã€‚è¿™é‡Œçš„å¤–ç•Œæ˜¯VMWork Stationçš„è™šæ‹Ÿç½‘å…³

3ã€ç½‘ç»œç»“æ„ï¼šwindows-192.168.127.143-----hostç½‘ç»œ-----192.168.127.144-squidä»£ç†-192.168.126.134-----NATç½‘ç»œ-----192.168.126.2è™šæ‹Ÿç½‘å…³ä¹Ÿæ˜¯è™šæ‹Ÿdns-------192.168.10.2DNS

4ã€å“ˆå“ˆç½‘ç»œç»“æ„ä¸Šçš„æ¯”è¾ƒæ™šï¼Œæ²¡äº‹ï¼ŒåŸºæœ¬éƒ½æ˜¯å¸¸è§„ç»“æ„ã€‚



ç»§ç»­æŠ¥é”™

![image-20241009094357823](2-ç½‘ç»œæ¶æ„.assets/image-20241009094357823.png)

å¯èƒ½æ˜¯MSSæ²¡è®¾ç½®ï¼Œä¸æ˜¯

å¯èƒ½æ˜¯squidçš„ http_port 192.168.229.60:3128 transparent  é…ç½®æœ‰é…ç½®

![image-20241009102656077](2-ç½‘ç»œæ¶æ„.assets/image-20241009102656077.png)



æä¸å®šï¼Œé€æ˜æ¨¡å¼è¿˜æ˜¯æœ‰é—®é¢˜ï¼Œå›å»å¼€å¯opnsenceçœ‹äººå®¶çš„squidæ˜¯æ€ä¹ˆç©çš„çš„ï¼Œé‚£é‡Œæˆ‘æ˜¯æŠ˜è…¾å¥½äº†çš„



ç„¶åçœ‹åˆ°AVé˜²ç—…æ¯’

https://docs.opnsense.org/manual/how-tos/proxyicapantivirus.html

AVä¹Ÿéœ€è¦é€æ˜ä»£ç†ï¼Œè¿™é‡Œæ˜¯è€çš„opnsenceé›†æˆweb proxyæ—¶å€™çš„è¯´æ˜ï¼Œæ­£å¥½å¯ä»¥æ‹¿æ¥å¯¹ç…§squid web proxyæ’ä»¶æ—¶ä»£çš„é…ç½®é¡¹ğŸ‘‡

https://docs.opnsense.org/manual/how-tos/cachingproxy.html









è¿™ä¸€ç¯‡ä¹Ÿè¦çœ‹

https://cloud-atlas.readthedocs.io/zh-cn/latest/web/proxy/squid/introduce_squid.html











## æ’æ’­ï¼šdnsçš„å‘ï¼Œä¹Ÿè®¸ä¸ç®—å‘

ä½†æ˜¯ä¼šå¹²æ‰°ä½ çš„æ’æŸ¥æ•…éšœï¼Œè¿™ä¹Ÿæ˜¯è‡´å‘½çš„ï¼Œä½ ä¼šäººä¸ºæ˜¯dnsç›¸åº”æ…¢ï¼Œå…¶å®ä¸æ…¢ã€‚



### 1ã€ç°è±¡

windows cmd  nslookup 2så»¶è¿Ÿ

windows cmd dig æ— å»¶è¿Ÿ



linux nslookupæˆ–dig éƒ½æ— å»¶è¿Ÿ



ä¸Šæˆªå›¾

windows nslookup æ¯æ¬¡éƒ½æ…¢

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241009170624622.png" alt="image-20241009170624622" style="zoom:50%;" />

windows dig æ¯æ¬¡éƒ½å¿«

![image-20241009170758697](2-ç½‘ç»œæ¶æ„.assets/image-20241009170758697.png)



linux ä¸ç®¡æ˜¯nslookupè¿˜æ˜¯digéƒ½ok

![image-20241009170849026](2-ç½‘ç»œæ¶æ„.assets/image-20241009170849026.png)



![image-20241009170901704](2-ç½‘ç»œæ¶æ„.assets/image-20241009170901704.png)



### æ’æŸ¥ï¼Œå»dns serveræŠ“åŒ…å¯è§

![image-20241009170936105](2-ç½‘ç»œæ¶æ„.assets/image-20241009170936105.png)

windowsçš„nslookup æ¯æ¬¡ä¼šå¤šå‡ºä¸€æ­¥PTRåè§£

è€Œwindowsçš„digï¼Œlinuxçš„nslookupã€digéƒ½æ²¡æœ‰è¿™ä¸ªPTR

![image-20241009171028128](2-ç½‘ç»œæ¶æ„.assets/image-20241009171028128.png)





ä¸ºä»€ä¹ˆåŒä¸€å°PC nslooklup  10.100.8.2 æœ‰PTRï¼Œnslookup  192.168.10.2æ²¡æœ‰PTRï¼Œ

**å› ä¸ºä¸‹å›¾çš„Unkownå°±æ˜¯åŸå› ã€‚å»ç»™10.100.8.2é…ç½®hostnameå°±è¡Œäº†**   PS: digä¸ç®¡ä»€ä¹ˆOSéƒ½ä¸ä¼šï¼Œç„¶ålinuxçš„nslookupä¹Ÿä¸ä¼š

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241009171814148.png" alt="image-20241009171814148" style="zoom:50%;" />





è¡¥ä¸Šdnsmasqçš„/etc/hostsçš„Aè®°å½•åŒæ—¶ä¹Ÿæ˜¯PTRè®°å½•å°±è¡Œäº†

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241009172245024.png" alt="image-20241009172245024" style="zoom:50%;" />





æå®šï¼Œä¸å¡äº†

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241009172438493.png" alt="image-20241009172438493" style="zoom:50%;" />









**>> ç»§ç»­squidè¯»æ–‡**

https://cloud-atlas.readthedocs.io/zh-cn/latest/web/proxy/squid/squid_socks_peer.html#sockssquid

è¿™é‡Œè°ƒä¸€ä¸‹ï¼Œå†™é”™äº†ğŸ‘‡

![image-20241010134828542](2-ç½‘ç»œæ¶æ„.assets/image-20241010134828542.png)



ç„¶åè¯»æ–‡

https://cloud-atlas.readthedocs.io/zh-cn/latest/web/proxy/squid/squid_gfwlist.html

é‡Œé¢æåˆ°çš„gfwlistæ˜¯å›½å¤–IPåœ°å€ï¼Œè€Œä¸”txté‡Œä¹Ÿæ˜¯å¤„ç†è¿‡çš„ï¼Œçœ‹ä¸åˆ°å…·ä½“ipåœ°å€

è¿˜ä¸å¦‚ç”¨å›½å†…IP LISTï¼Œå¯¹å§é™¤æ­¤ä¹‹å¤–çš„å°±èµ°èŠ‚ç‚¹å‡ºå»

https://gitee.com/haiyangyu/CN_ISP_RIB/tree/master







ç»§ç»­å¤„ç†squidçš„é€æ˜æ¨¡å¼

å‘ç°æŒ‰ç…§

https://www.cnblogs.com/weq0805/p/15242170.html

é…ç½® é€æ˜æ¨¡å¼  3128ç›‘å¬ç«¯å£å°±æ²¡äº†

é—®äº†GPTæ‰çŸ¥é“è¦çœ‹cacheçš„log

![image-20241010144721976](2-ç½‘ç»œæ¶æ„.assets/image-20241010144721976.png)



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241010144746371.png" alt="image-20241010144746371" style="zoom:50%;" />





ç„¶åè¿™ä¸ªæŠ¥é”™ forward-proxy ports å¥½åƒåœ¨ä¸Šé¢çš„æ–‡é‡Œä¹Ÿæœ‰

![image-20241010144901052](2-ç½‘ç»œæ¶æ„.assets/image-20241010144901052.png)





è¿™é‡Œæœ‰ä¸ªç‚¹å°±æ˜¯

1ã€opsenseé‡Œæ˜¯æ²¡æœ‰ ä¸¤ä¸ªç«¯å£çš„ï¼Œå°±æ˜¯ä¸Šå›¾çš„8080å’Œ3128ï¼Œå°±æ˜¯ä¸é€æ˜å’Œé€æ˜çš„ä¸¤ä¸ªç«¯å£ ä¸¤è¡Œé…ç½®

![image-20241010145705688](2-ç½‘ç»œæ¶æ„.assets/image-20241010145705688.png)



2ã€ç„¶åè‡ªå·±çš„æ­å»ºçš„squidåº”è¯¥æ˜¯è¦äº›ä¸¤è¡Œï¼Œè€Œä¸”ç«¯å£ä¸èƒ½ä¸€æ ·

è¿˜æ˜¯é€šè¿‡cache.logå¯è§ï¼Œé‡å¯æœåŠ¡ï¼Œé…ç½®ä¸€æ ·çš„ç«¯å£

![image-20241010150444517](2-ç½‘ç»œæ¶æ„.assets/image-20241010150444517.png)



![image-20241010150459900](2-ç½‘ç»œæ¶æ„.assets/image-20241010150459900.png)



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241010150519856.png" alt="image-20241010150519856" style="zoom:50%;" />

æ‰€ä»¥ä¸Šå›¾çš„3128ä¸èƒ½ä¸€æ ·ï¼Œè¿™é‡Œä¸çŸ¥é“opnsenseæ€ä¹ˆåšåˆ°ä¸å†™ç¬¬ä¸€è¡Œçš„3128çš„



**æ­¤æ—¶http://çš„å°±å¯ä»¥è®¿é—®äº†**ï¼Œä¸ä¼šå‡ºç°squidçš„invliadé¡µé¢äº†ğŸ‘‡è¿™æ˜¯å½“æ—¶çš„æŠ¥é”™ï¼š

![image-20241010151037991](2-ç½‘ç»œæ¶æ„.assets/image-20241010151037991.png)

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241010150917897.png" alt="image-20241010150917897" style="zoom:50%;" />

è¿™æ ·é…ç½®ï¼Œç¬¬äºŒè¡Œä¸ç”Ÿæ•ˆçš„ï¼Œä¸è¿‡3128èƒ½å¤Ÿèµ·æ¥ï¼Œç„¶åå°±æ˜¯ä¸Šä¸Šå›¾çš„æŠ¥é”™





ç„¶åç»§ç»­æŠ˜è…¾httpsçš„é—®é¢˜ğŸ‘‡ï¼Œé‚£å°±æœ‰çš„æŠ˜è…¾äº†ï¼Œä¸è¿‡opnsenseå·²ç»okï¼Œæ€è·¯å°±æ˜¯è‡ªç­¾åï¼Œç„¶ååŒæ ·ç«¯å£è¦é”™å¼€å’Œhttpçš„3128ï¼Œäººå®¶ç”¨é¢3129

![image-20241010151855572](2-ç½‘ç»œæ¶æ„.assets/image-20241010151855572.png)







### åˆ æ‰squidï¼Œé‡æ–°ç¼–è¯‘å¸¦ä¸Šssl

![image-20241010152912299](2-ç½‘ç»œæ¶æ„.assets/image-20241010152912299.png)

```bash
./configure --prefix=/usr/local/squid --sysconfdir=/etc --enable-arp-acl --enable-linux-netfilter --enable-linux-tproxy --enable-async-io=100 --enable-err-language="Simplify_Chinese" --enable-underscore --enable-poll --enable-gnuregex --enable-ssl
```







**æ’æ’­ï¼Œå¦ˆçš„ä¸çŸ¥å’‹å›äº‹gitbookå¤ªæ…¢äº†ï¼Œéš¾é“æ˜¯æœ‰æ”¶è´¹ç‰ˆçš„åŸå› ï¼Ÿ**

![image-20241010154123220](2-ç½‘ç»œæ¶æ„.assets/image-20241010154123220.png)

å°±ğŸ‘†è¿™ä¸ªå…±äº«å†²çªä¸Šé¢ä¼šå¡ç‰¹å–µå‡ ä¸ªå°æ—¶ï¼Œï¼Œï¼Œä¹‹å‰è¿˜æ²¡è¿™ä¹ˆä¹…ï¼Œå…±äº«å†²çªæ¯æ¬¡éƒ½å‡ºç°å•Šï¼Œæ€ä¹ˆå¯èƒ½æ˜¯è¿™ä¸ªé—®é¢˜ã€‚







![image-20241010155849518](2-ç½‘ç»œæ¶æ„.assets/image-20241010155849518.png)

sslå°±æœ‰äº†ğŸ‘†



ç„¶åè¿˜æ˜¯æŒ‰ä»–çš„èµ°ä¸€éï¼Œå½“ç„¶systemdè‡ªå·±å¼„ã€‚

https://www.cnblogs.com/weq0805/p/15242170.html

æœåŠ¡èµ·æ¥åï¼ŒæŒ‰ä»–çš„èµ°ssl

https://cloud-atlas.readthedocs.io/zh-cn/latest/web/proxy/squid/squid_transparent_proxy.html

ä¸è¿‡è¯è¯´å›æ¥ï¼Œè¿™ä¹ˆå¤šæ¬¡sslçš„è¯ä¹¦ï¼Œnginxçš„httpdçš„mysqlçš„haproxyçš„ï¼Œä¸ç®¡æ˜¯opensslçš„è¿˜æ˜¯makefileçš„ï¼Œè¿˜æ˜¯opnsenseè‡ªå·±çš„å›¾å½¢ç•Œé¢çš„ï¼Œè¿˜æ˜¯openvpnçš„ï¼Œéƒ½æœ‰åœ¨ç”¨ï¼Œä½†æ˜¯å¥½åƒcliéƒ½ç•¥æœ‰ä¸åŒï¼ŒåŸºæœ¬ä¸€è‡´ã€‚å¥½è®¨åŒå•Š

è¦ä¸ï¼Œè¿™å°±æ€»ç»“ä¸‹å§

### sslè‡ªç­¾åçš„å„ç§cliæ±‡æ€»

1ã€sshé‚£ä¼šä¸æ˜¯åŸºäºkeyï¼Œè€Œæ˜¯åŸºäºåŒå‘éå¯¹ç§°åŠ å¯†çš„ã€‚

```bash
1ã€å»ºç«‹CAï¼šgenrsaç”Ÿæˆcaç§é’¥--cakeyï¼›åˆ©ç”¨cakeyè‡ªç­¾åè¯ä¹¦--è‡ªå·±ç»™è‡ªå·±é¢å‘è¯ä¹¦
(umask 077;openssl genrsa -out private/cakey.pem 4096)
openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650 <<EOF
CN
beijing
beijing
ming
devops
ca.ming.com
admin@ming.com
EOF
a.
touch /etc/pki/CA/index.txt    #  å­˜æ”¾å·²ç»é¢å‘çš„è¯ä¹¦ä¿¡æ¯
echo 0F > /etc/pki/CA/serial   #  å­˜æ”¾ä¸‹ä¸€ä¸ªé¢å‘è¯ä¹¦çš„åºåˆ—å·ï¼Œ0Fæ”¹æˆ01ä»ç¬¬ä¸€ä¸ªå·å¼€å§‹åˆ†



2ã€æä¸€ä¸ªè¯ä¹¦ç”³è¯·æ–‡ä»¶

mkdir /etc/httpd/conf.d/ssl
cd /etc/httpd/conf.d/ssl
(umask 066;openssl genrsa -out httpd.key 1024)  #1024å¯èƒ½æœ‰é—®é¢˜msyqlé‚£ä¼šçš„ç»éªŒå‘Šè¯‰æˆ‘è¦4096ä¿æŒä¸€è‡´
openssl req -new -key httpd.key -out httpd.csr <<EOF
CN
beijing
beijing
ming
devops
ca.ming.com
admin@ming.com


EOF

scp /etc/httpd/conf.d/ssl/httpd.csr CAServer:/etc/pki/CA       # æŠŠcsrç”³è¯·æ–‡ä»¶ä¼ åˆ°CAä¸Šï¼Œåœ¨CAä¸Šæ ¹æ®csræ–‡ä»¶æ¥é¢å‘è¯ä¹¦ï¼Œä¹Ÿå°±æ˜¯å¯¹å…¶åŠ å¯†ã€‚


3ã€é’ˆå¯¹ç”³è¯·æ–‡ä»¶è¿›è¡Œé¢å‘è¯ä¹¦-ä¹Ÿå°±æ˜¯ç­¾å-ä¹Ÿå°±æ˜¯ç”¨CAçš„ç§é’¥è¿›è¡ŒåŠ å¯†

openssl ca -in /etc/pki/CA/httpd.csr -out /etc/pki/CA/certs/httpd.crt -days 100

scp /etc/pki/CA/certs/httpd.crt root@httpdServer:/etc/httpd/conf.d/ssl    # æŠŠè¯ä¹¦å¤åˆ¶åˆ°serverä¸Š
scp /etc/pki/CA/cacert.pem root@httpdServer:/etc/httpd/conf.d/ssl      # æŠŠcaè‡ªå·±çš„è¯ä¹¦ä¹Ÿå¤åˆ¶å€’serverä¸Šï¼Œæ­¤ä¸¾ç›¸å½“äºwindowsé¢„åŠ è½½äº†å—ä¿¡ä»»çš„æ ¹è¯ä¹¦æ–‡ä»¶ã€‚

```



2ã€apacheé‚£ä¼š

```
CAä¸ŠğŸ‘‡
cd /etc/pki/CA
mkdir certs
mkdir crl
mkdir newcerts
mkdir private
mkdir ssl

(umask 077;openssl genrsa -out private/cakey.pem 4096)
openssl req -new -x509 -key /etc/pki/CA/private/cakey.pem -out /etc/pki/CA/cacert.pem -days 3650



touch /etc/pki/CA/index.txt    #  å­˜æ”¾å·²ç»é¢å‘çš„è¯ä¹¦ä¿¡æ¯
echo 0F > /etc/pki/CA/serial   #  å­˜æ”¾ä¸‹ä¸€ä¸ªé¢å‘è¯ä¹¦çš„åºåˆ—å·ï¼Œ0Fæ”¹æˆ01ä»ç¬¬ä¸€ä¸ªå·å¼€å§‹åˆ†


serverä¸ŠğŸ‘‡
mkdir /etc/httpd/conf.d/ssl
cd /etc/httpd/conf.d/ssl
(umask 066;openssl genrsa -out httpd.key 2048)  #1024å¯èƒ½æœ‰é—®é¢˜msyqlé‚£ä¼šçš„ç»éªŒå‘Šè¯‰æˆ‘è¦4096ä¿æŒä¸€è‡´

openssl req -new -key httpd.key -out httpd.csr 
scp /etc/httpd/conf.d/ssl/httpd.csr CAServer:/etc/pki/CA       # æŠŠcsrç”³è¯·æ–‡ä»¶ä¼ åˆ°CAä¸Šï¼Œåœ¨CAä¸Šæ ¹æ®csræ–‡ä»¶æ¥é¢å‘è¯ä¹¦ï¼Œä¹Ÿå°±æ˜¯å¯¹å…¶åŠ å¯†ã€‚


CAä¸ŠğŸ‘‡
openssl ca -in /etc/pki/CA/httpd.csr -out /etc/pki/CA/certs/httpd.crt -days 100 -extensions v3_req

scp /etc/pki/CA/certs/httpd.crt root@httpdServer:/etc/httpd/conf.d/ssl    # æŠŠè¯ä¹¦å¤åˆ¶åˆ°serverä¸Š
scp /etc/pki/CA/cacert.pem root@httpdServer:/etc/httpd/conf.d/ssl      # æŠŠcaè‡ªå·±çš„è¯ä¹¦ä¹Ÿå¤åˆ¶å€’serverä¸Šï¼Œæ­¤ä¸¾ç›¸å½“äºwindowsé¢„åŠ è½½äº†å—ä¿¡ä»»çš„æ ¹è¯ä¹¦æ–‡ä»¶ã€‚

```



3ã€nginxé‚£ä¼šmakefileæ–‡ä»¶å¼„çš„

ä¸è¿‡nginxé‚£é‡Œå°±çœ‹åˆ°ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸åƒhttpdé‚£ä¼š3ä¸ªæ–‡ä»¶ï¼Œæœ¬è´¨ä¸€æ ·çš„ï¼Œå› ä¸ºnginxé‚£ä¼šæ—¢åšCAä¹Ÿåšserveræ‰€ä»¥å°±2ä¸ªå°±è¡Œäº†ã€‚



è¿™é‡Œç»§ç»­å¼„squidçš„sslå§

![image-20241011093957713](2-ç½‘ç»œæ¶æ„.assets/image-20241011093957713.png)

è¿™ä¸ªæ²¡é—®é¢˜

ä¸è¿‡æˆ‘æ²¡æœ‰ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œ

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241011094034589.png" alt="image-20241011094034589" style="zoom:50%;" />

ä¸ç”¨å¤šæƒ³ï¼Œé‡æ–°ç¼–è¯‘squidå§ï¼Œä½ çœ‹çœ‹opnsenseäººå®¶çš„squidå°±æœ‰è¿™ä¸ªå‘½ä»¤

![image-20241011094156211](2-ç½‘ç»œæ¶æ„.assets/image-20241011094156211.png)



é‡æ–°ç¼–è¯‘ï¼ŒæŒ‰äººå®¶ç½‘å…³æç¤ºï¼Œå¯¹ï¼Œæˆ‘å°±æ˜¯çœ‹çœ‹è¿™ä¸ªï¼Œçœ‹çœ‹å®˜ç½‘ï¼Œå†çœ‹çœ‹opnsenseæ’ä»¶çš„ã€‚

https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit

![image-20241011094207130](2-ç½‘ç»œæ¶æ„.assets/image-20241011094207130.png)



æˆ‘çš„ç¼–è¯‘å¦‚ä¸‹ï¼Œå¤šå¸¦äº†ä¸€ä¸ª--enable-sslä¹Ÿæ˜¯å‚è€ƒçš„opnsenseå’Œä¸Šé¢ä¸€ä¸ªè¿æ¥é‡Œçš„ã€‚

![image-20241011094813055](2-ç½‘ç»œæ¶æ„.assets/image-20241011094813055.png)



ç„¶åsquidæ˜¯ç§é’¥å’Œè‡ªç­¾ååœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œçš„ï¼Œæ‰€ä»¥ä»httpdçš„3ä¸ªæ–‡ä»¶ åˆ° nginxçš„ä¸¤ä¸ªæ–‡ä»¶ å†åˆ° squidçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œå†åˆ°openvpnçš„clientä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ã€‚

![image-20241011101402594](2-ç½‘ç»œæ¶æ„.assets/image-20241011101402594.png)

ä¸è¿‡openvpn  serverè¿˜æ˜¯3ä¸ªæ–‡ä»¶+ dh.pem ä¸€å…±4ä¸ªæ–‡ä»¶åˆ†å¼€æ¥çš„ï¼Œclientä¹‹æ‰€ä»¥ä¸€å°±æ˜¯å†™åœ¨ä¸€èµ·äº†è€Œå·²ã€‚

![image-20241011101304103](2-ç½‘ç»œæ¶æ„.assets/image-20241011101304103.png)



æŒ‰è¿™ä¸ªæ¥ï¼š

https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit

å…ˆä¿®æ”¹opensslé…ç½®æ–‡ä»¶

![image-20241011102008556](2-ç½‘ç»œæ¶æ„.assets/image-20241011102008556.png)

![image-20241011102131995](2-ç½‘ç»œæ¶æ„.assets/image-20241011102131995.png)



![image-20241011102241490](2-ç½‘ç»œæ¶æ„.assets/image-20241011102241490.png)



è¿™é‡Œä¸æ˜¯csrçš„ç”³è¯·ï¼Œæ‰€ä»¥v3çš„cliå˜äº†ä¸€ä¸‹

```bash
openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -x509 -extensions v3_ca -keyout myCA.pem  -out myCA.pem

```

ä¸è¿‡csré¢å‘serverè¯ä¹¦çš„æ—¶å€™æ‰æœ‰alt_nameä¹Ÿå°±æ˜¯**subject Alternative name**

caé‡Œæ˜¯æ²¡æœ‰çš„ã€‚ã€‚ã€‚







ç„¶åå†

![image-20241011101717032](2-ç½‘ç»œæ¶æ„.assets/image-20241011101717032.png)



ç»§ç»­å§ï¼Œè¿™æ¬¡é‡æ–°ç¼–è¯‘åå°±æœ‰è¿™ä¸ªæ–‡ä»¶äº†ğŸ‘‡

![image-20241011102727429](2-ç½‘ç»œæ¶æ„.assets/image-20241011102727429.png)



ä½†æ˜¯å®˜ç½‘å®ƒå†™é”™äº†

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241011102918757.png" alt="image-20241011102918757" style="zoom:50%;" />

æ”¹æˆhttpså’Œ3129å’Œé»˜è®¤çš„3128åŒºåˆ†å¼€æ¥ï¼Œ**ä¹Ÿè¦åŠ ä¸Šinterceptçš„**ï¼Œ

ç„¶åæ³¨æ„é‡æ–°ç¼–è¯‘åçš„log æ–‡ä»¶æƒé™ç»™åˆ°

![image-20241011104008019](2-ç½‘ç»œæ¶æ„.assets/image-20241011104008019.png)



ç„¶åé‡å¯å°±èƒ½çœ‹åˆ°cache.logäº†ï¼Œé€šè¿‡å®ƒå°±èƒ½å‘ç°å“ªé‡Œå‡ºé—®é¢˜äº†

![image-20241011104046315](2-ç½‘ç»œæ¶æ„.assets/image-20241011104046315.png)



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241011104158463.png" alt="image-20241011104158463" style="zoom:50%;" />





![image-20241011104429137](2-ç½‘ç»œæ¶æ„.assets/image-20241011104429137.png)

å†è¯•

ä¸è¡Œï¼Œè¿˜æ˜¯æ‰‹åŠ¨æ•²ä¸€ä¸‹å§



![image-20241011104805864](2-ç½‘ç»œæ¶æ„.assets/image-20241011104805864.png)



ç„¶åç”±äºsquidæœåŠ¡ä¸€ç›´é”²è€Œä¸èˆçš„å°è¯•ï¼Œæ‰€ä»¥ä¸éœ€è¦é‡å¯ï¼Œå°±èµ·æ¥äº†ï¼Œå°±çœ‹åˆ°3128 3129ç«¯å£äº†

![image-20241011104910276](2-ç½‘ç»œæ¶æ„.assets/image-20241011104910276.png)



è¿™ä¸å°±å¯ä»¥äº†å˜›

![image-20241011105829563](2-ç½‘ç»œæ¶æ„.assets/image-20241011105829563.png)



ç»§ç»­æŠŠè¯ä¹¦æä¸€ä¸‹ï¼Œä¸ç„¶è¿˜æ˜¯ä¸è¡Œ

![image-20241011110028416](2-ç½‘ç»œæ¶æ„.assets/image-20241011110028416.png)



è¯ä¹¦å°±å¯¼å‡ºxx.derç„¶åå¯¼å…¥åˆ°windowsé‡Œå°±è¡Œäº†

![image-20241011110317700](2-ç½‘ç»œæ¶æ„.assets/image-20241011110317700.png)



![image-20241011110503943](2-ç½‘ç»œæ¶æ„.assets/image-20241011110503943.png)





æå®šï¼

![image-20241011110750136](2-ç½‘ç»œæ¶æ„.assets/image-20241011110750136.png)





![image-20241011133356854](2-ç½‘ç»œæ¶æ„.assets/image-20241011133356854.png)

è§‚å¯Ÿcache.logè¿˜æœ‰æŠ¥é”™ï¼Œå°±å¤„ç†

![image-20241011133418679](2-ç½‘ç»œæ¶æ„.assets/image-20241011133418679.png)

æŠ¥é”™è§£å†³







è‡ªæ­¤ï¼Œopnsenseçš„squidæ’ä»¶ï¼Œç‹¬ç«‹å‡ºæ¥ è½åœ°å®ç°ğŸ‘†



æ„å‘³ç€ï¼šæˆ‘åªè¦åœ¨ç½‘ç»œæ ¸å¿ƒæ—æŒ‚ä¸€å°squidï¼Œç„¶åå°†ç½‘å…³æŒ‡è¿‡å»ï¼Œç„¶åç”¨æˆ·PCåŠ è½½è‡ªç­¾åSSLï¼Œå°±å¯ä»¥ç›‘æ§æ‰€æœ‰ä¸Šç½‘å†…å®¹ï¼Œâ‘ è¿™å¥—æ–¹æ¡ˆè½åœ¨å¼€å‘å†…ç½‘é«˜å¯†ç¯å¢ƒ â‘¡æ€§èƒ½éœ€è¦æµ‹è¯•çš„ã€‚



ä»¥ä¸‹é…ç½®cliå†å²è®°å½•ï¼Œçœ‹ä¸åˆ°vimé‡Œçš„

```bash

cd /squid
mkdir /squid
cd /squid/


wget https://www.squid-cache.org/Versions/v6/squid-6.10.tar.xz

yum -y install gcc gcc-c++ make

tar -xvf squid-6.10.tar.xz

cd squid-6.10


./configure --prefix=/usr/local/squid --sysconfdir=/etc --enable-arp-acl --enable-linux-netfilter --enable-linux-tproxy --enable-async-io=100 --enable-err-language="Simplify_Chinese" --enable-underscore --enable-poll --enable-gnuregex

ğŸ‘†è¿™é‡Œç¼ºå¤±sslçš„åŠŸèƒ½


lscpu
make -j 4 && make install


ln -s /usr/local/squid/sbin/squid /usr/local/sbin   ğŸ‘ˆPATHå˜é‡

squid -h
which squid

ll
ll `which squid`
ll /usr/local/squid/sbin/squid
id squid
useradd -h
useradd -M -s /sbin/nologin squid   ğŸ‘ˆ  æœåŠ¡çš„å¯åŠ¨ç”¨æˆ·
id squid
chown -R squid.squid /usr/local/squid/var/  ğŸ‘ˆ æ—¥å¿—ç”Ÿæˆçš„æƒé™
ll /usr/local/squid/var/
ll /usr/local/squid/var/ -R
vim /etc/squid.conf
squid -k parse   ğŸ‘ˆ æ²¡å•¥ç”¨çš„æ£€æŸ¥é…ç½®è¯­æ³•ï¼Œå…¶å®è¿˜å¾—é cache.logçœ‹æŠ¥é”™
vim /etc/squid.conf
squid -k parse
vim /etc/squid.conf
squid -k parse
squid -z
squid
ps auxf |grep -v grep |grep squid
ss -tlnup |grep squid
netstat -anpt |grep squid
netstat -anpt
ss -tlnup
squid -k parse

ll /usr/local/squid/var/run/squid*
ll /usr/local/squid/var/run/squid.pid
cat /usr/local/squid/var/run/squid.pid
ps auxf |grep -v grep |grep squid

cat /etc/squid.conf
ll /usr/local/squid/sbin/squid
squid -h

ğŸ‘‡ç¼–å†™systemdçš„è¿‡ç¨‹

ss -tlnup
/etc/init.d/squid
/etc/init.d/squid restart
/etc/init.d/squid status
cat /etc/init.d/squid
ll /usr/local/squid/var/run/squid.pid
/etc/init.d/squid stop
ss -tlnup |grep squid
/etc/init.d/squid kill
/etc/init.d/squid stop
ss -tlnup |grep squid
squid -k kill
touch /usr/local/squid/var/run/squid.pid
/etc/init.d/squid stop
ll /usr/local/squid/var/run/squid.pid
ss -tlnup |grep squid
/etc/init.d/squid stop
ss -tlnup |grep squid
ll /usr/local/squid/var/run/squid.pid
touch /usr/local/squid/var/run/squid.pid
squid -k kill
pgrep suqid
pgrep squid
kill 86542
pgrep squid
kill -9 86542
pgrep squid
service squid start
service squid status
service squid stop
service squid status
service squid start
service squid status
pgrep squid
kill -9 `pgrep squid`
pgrep squid
squid -k
squid -h
rpm -c nginx
rpm -qc nginx
rpm -ql nginx
cd /usr/lib/systemd/system/
ll
ls
rm -rf /etc/init.d/
vim squid.serviec
vim squid.service
vim nginx.service
vim squid.service
netstat -natp | grep squid
systemctl daemon-reload
systemctl start squid
systemctl status squid
systemctl enable squid
systemctl status squid
systemctl stop squid
ps auxf |grep -v grep |grep squid
ss -tlnup |grep squid
systemctl status squid
systemctl reload squid
systemctl retart squid
systemctl restart squid
systemctl status squid
systemctl reload squid
ss -tlnup |grep squid
ps auxf |grep -v grep |grep squid
cat squid.service
netstat -natp | grep squid
cat /usr/local/squid/var/run/squid.pid
cat nginx.service
cat /usr/local/squid/var/run/squid.pid
cat squid.service
squid -h
cat /usr/local/squid/var/run/squid.pid
squi
cat /usr/local/squid/var/run/squid.pid
squid -k shutdown
cat /usr/local/squid/var/run/squid.pid
systemctl status squid
systemctl restart squid
systemctl status squid
systemctl start squid
systemctl status squid
systemctl stop squid
systemctl status squid
systemctl start squid
systemctl status squid
netstat -natp | grep squid
echo $?
systemctl stop squid
cat nginx.service
cat squid.service
systemctl stop squid
netstat -natp | grep squid
echo $?
netstat -natp | grep squid || exit 0
cd /run/
echo $?

cd /usr/lib/systemd/system
ll
cat nginx.service
cat squid.service
nginx -h
cat nginx.service
cat squid.service
systemctl start squid
ll /usr/local/squid/var/run/squid.pid
ss -tlnup
vim squid.service
ll /usr/local/squid/var/run/squid.pid
squid -k shutdown
ll /usr/local/squid/var/run/squid.pid
vim squid.service
systemctl status squid
systemctl start squid
systemctl daemon-reload
systemctl start squid
systemctl status squid
systemctl stop squid
systemctl start squid
squid -k parse
cd /usr/local/squid/var/cache/squid
ll
vim /etc/squid.conf
systemctl restart squid
systemctl status squid
iptables -vnL
systemctl status docker
iptables -vnL
docker ps
ip a
nmcli conn
route -n
ss -tlnup
tail -f /usr/local/squid/var/logs/access.log
ps auxf |grep -v grep |grep squid
ss -tlnup |grep 3128
ss -tlnup |grep squid
ss -tlnup |grep 3218
ss -tlnup |grep squid
ps auxf |grep -v grep |grep squid
ss -tlnup |grep 95991
ss -tlnup |grep 95
ss -tlnup
ps auxf |grep -v grep |grep squid
tail -f /usr/local/squid/var/logs/access.log
ss -tlnup |grep 3128
ps auxf |grep -v grep |grep squid
ss -tlnup |grep 3128
ss -tlnup
ss -tlnup |grep 3128
tail -f /usr/local/squid/var/logs/access.log
ss -tlnup
tail -f /var/log/nginx/access.log
systemctl status squid
cat /usr/lib/systemd/system/squid.service
cat /etc/squid.conf
cat /etc/squid.conf |grep log
tail -f /usr/local/squid/var/logs/access.log
cat /usr/local/squid/var/logs/access.log
cat /usr/local/squid/var/logs/access.log |grep name
cat /usr/local/squid/var/logs/access.log |grep query
cat /usr/local/squid/var/logs/access.log |grep www.baidu.com
tail -f /usr/local/squid/var/logs/access.log
iptables -vnL
iptables -A -s 192.168.127.0/24 -j DROP
iptables -A INPUT -s 192.168.127.0/24 -j DROP
iptables -vnL
ss -tlnup
tail -f /usr/local/squid/var/logs/access.log
tail -f /usr/local/squid/var/logs/cache.log
tail -f /usr/local/squid/var/logs/access.log
history |grep config
vim squid.service
tail -f /usr/local/squid/var/logs/access.log
top
ps axuf
ps axuf |grep make
ps axuf |grep make -j 4
ps axuf |grep 'make -j 4'
df -h
ll /usr/local/squid/var/run/squid.pid
watch ll /usr/local/squid/var/run/squid.pid
ll /usr/local/squid/var/run/squid.pid
vim /etc/sysctl.conf
echo 'net.ipv4.ip_forward = 1' >> /etc/sysctl.conf   ğŸ‘ˆé…ç½®è·¯ç”±è½¬å‘ï¼Œä¼ ç»Ÿæ¨¡å¼ä¸éœ€è¦ã€‚é€æ˜æ¨¡å¼æ‰éœ€è¦
cat /etc/sysctl.conf
sysctl -p
ip a
iptables -vnL
iptables -t nat -I PREROUTING -i ens33 -s 192.168.0.0/16 -p tcp --dport 80 -j REDIRECT --to 3128
iptables -vnL
iptables -vnL -T NAT
iptables -vnL -t NAT
iptables -vnL -t nat
iptables -t nat -I PREROUTING -i ens33 -s 192.168.0.0/16 -p tcp --dport 443 -j REDIRECT --to 3128
iptables -vnL -t nat
iptables -vnL
iptables -vnL -t nat
iptables -vnL
iptables -F
iptables -t nat
iptables -vnL -t nat
iptables -vnL
iptables -vnL -t nat
iptables -P FORWARD ACCE
iptables -P FORWARD ACCEPT
iptables -vnL -t nat
iptables -vnL
iptables -vnL -t nat
ip a
systemctl restart iptables
systemctl restart docker
iptables -vnL
iptables -vnL -t nat
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 443 -j REDIRECT --to 3128  è¿™é‡Œå…¶å®è¦æ”¹æˆ3129æ‰å¯¹ï¼Œä¸€å¼€å§‹ä¸çŸ¥é“ã€‚
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 80 -j REDIRECT --to 3128
iptables -vnL -t nat
iptables -vnL
iptables -vnL -t nat
iptables -vnL
iptables -F
iptables -vnL
iptables -vnL -t nat
iptables -vnL
iptables -vnL -t nat
ip a
route -n
iptables -vnL
iptables -t nat -vnL
ss -tlnup
sysctl -p
iptables -F
iptables -F -t nat
iptables -vnL
iptables -vnL -t nat
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 80 -j REDIRECT --to 3128
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 443 -j REDIRECT --to 3128
iptables -t nat -vnL
vim /etc/squid.conf
systemctl restart squid
systemctl status squid
ss -tlnup
squid -k parse
ps auxf |grep -v grep |grep squid
vim /etc/squid.conf
systemctl restart squid
iptables -vnL -t nat
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j REDIRECT --to 192.168.126.2:53
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j REDIRECT --to 192.168.126.2 --port 53
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j REDIRECT --to 192.168.126.2:533
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j REDIRECT --to 192.168.126.2:53
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j REDIRECT --to
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j DNAT --to-destination 192.168.126.2:53   ğŸ‘ˆdnsé…ç½®å¯¹çš„ï¼Œå°±æ˜¯éœ€è¦åŠ ä¸€ä¸ªå‡ºå‘çš„SNATã€‚ä¸‹é¢æœ‰ã€‚
iptables -vnL -t nat
ip a
iptables -vnL -t nat
cat /etc/resolv.conf
dig
dig www.baidu.com @192.168.126.2
iptables -vnL -t nat
dig www.baidu.com @192.168.127.144
iptables -vnL
ip a
iptables -vnL -t nat
tcpdump -nni
tcpdump -nn
tcpdump -nn host 192.168.10.2
tcpdump -nn host 192.168.127.144
tcpdump -nn udp host 192.168.127.144
tcpdump -nn udp and host 192.168.127.144
iptables -vnL
iptables -vnL -t nat
ss -tlnp
ss -tlnup
ip a
tcpdump -nni eth1 udp 53
tcpdump -nni eth1 udp port 53
tcpdump -nnvvvvvi eth1 udp port 3128
tcpdump -nnvvvvvi eth1 port 3128
iptables -vnL
iptables -vnL -t nat
tcpdump -nnvvvvvi eth1 port 3128
iptables -F
history |grep iptables
iptables -vnL -t nat
systemctl restart iptables
iptables -
iptables -h
iptables -Z
iptables -vnL -t nat
iptables -Z -t nat
iptables -vnL -t nat
ifconfig
tcpdump -nnvvvvvi eth0 port 3128
tcpdump -nnvvvvvi eth0
tcpdump -nnvvvvvi eth0 host 192.168.126.2
iptables -vnL
route -n
iptables -vnL -t nat
iptables -vnL
iptables -A POSTROUTING -j MASQUERADE
iptables -t nat -A POSTROUTING -j MASQUERADE
iptables -vnL -t nat
-A FORWARD -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j TCPMSS --set-mss 1356
iptable -A FORWARD -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j TCPMSS --set-mss 1356
iptables -A FORWARD -p tcp -m tcp --tcp-flags FIN,SYN,RST,ACK SYN -j TCPMSS --set-mss 1356   # æœ€åä¸éœ€è¦
iptables -vnL
iptables -vnL -t nat
iptables -vnL -t nat -z
iptables -t nat -z
iptables -t nat -Z
iptables -vnL -t nat -Z
iptables -vnL -t nat
ss -tlnup
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
vim /etc/squid.conf
systemctl restart squid
systemctl status squid
ss -tlnup
vim /etc/squid.conf
getenforce
systemctl status firewalld
systemctl status iptables
sudo lsof -i :3128
vim /etc/squid.conf
systemctl restart squid
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
systemctl status squid
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
iptables -vnL
iptables -vnL -t nat
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
systemctl status squid
ss -tlnup
vim /etc/squid.conf
docker ps
docker stop gitlab
ss -tlnup
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
vim /etc/squid.conf
top
systemctl restart squid
ss -tlnup
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
cat /etc/squid.conf
squid -k parse
vim /etc/squid.conf
iptables -vnL
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
vim /etc/squid.conf
ip a
vim /etc/squid.conf
sockstat -l
yum search sockstat
ss -tlnup
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
history |grep configure
vim /etc/squid.conf
systemctl restart squid
ss -tlnup
iptables -vnL
iptables -vnL -t nat
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j DNAT --to-destination 192.168.126.2:53
iptables -vnL -t nat
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j DNAT -port 3128
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j DNAT -to-port 3128
history |grep iptables |grep 3128
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j REDIREECT --to 3128
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j REDIRECT --to 3128
iptables -vnL -t nat
iptables -h
iptables -vnL -t nat
iptables -I -t nat
iptables -vnL
iptables -vnLI
iptables -vnLa
iptables -vnLA
iptables -h
iptables -vnL
iptables -vnL -t nat
iptables -vnL -t nat --line-numbers
iptables -t nat -D 2
iptables -D PREROUTING 2 -t nat
iptables -D PREROUTING 3,4 -t nat
iptables -D PREROUTING 3-4 -t nat
iptables -D PREROUTING 3 -t nat
iptables -D PREROUTING 34-t nat
iptables -D PREROUTING 4 -t nat
iptables -vnL -t nat
iptables -vnL -t nat --line-numbers
iptables -t nat -I 3 PREROUTING -s 192.168.0.0/16 -p udp --dport 80 -j REDIREECT --to 3128
iptables -t nat -I PREROUTING 3 -s 192.168.0.0/16 -p udp --dport 80 -j REDIREECT --to 3128
history |grep iptables |grep 3128
iptables -t nat -I 3 PREROUTING -s 192.168.0.0/16 -p tcp --dport 80 -j REDIREECT --to 3128
iptables -t nat -I PREROUTING 3 -s 192.168.0.0/16 -p tcp --dport 80 -j REDIREECT --to 3128
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 80 -j REDIREECT --to 3128
iptables -t nat -I PREROUTING 3 -s 192.168.0.0/16 -p tcp --dport 80 -j REDIRECT --to 3128
iptables -vnL -t nat
iptables -vnL -t nat --line-numbers
iptables -t nat -D PREROUTING 2
iptables -vnL -t nat
history |grep iptables |grep 126.2
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p udp --dport 53 -j DNAT --to-destination 192.168.126.2:53
iptables -vnL -t nat
vim /etc/squid.conf
systemctl restart squid
yum search squid
cat /usr/lib/systemd/system/squid.service
dig
dig www.bing.com @10.100.8.2
nslookup
nslookup www.bing.com 10.100.8.2
while true;do nslookup www.bing.com 10.100.8.2;done
nslookup www.bing.com 10.100.8.2
dig www.bing.com @10.100.8.2
ip a
docker s
docker ps
docker ps -a
systemctl status squid
ss -tlnpu
cd /etc/squid/certs/
ll
cat openssl
ll
rm -rf openssl
ll
openssl req -new -newkey rsa:4096 -sha256 -days 3650 -nodes -x509 -keyout myCA.pem -out myCA.pem
ll
cat myCA.pem
ll
openssl x509 -in myCA.pem -text -noout
openssl x509 -in myCA.pem -outform DER -out myCA.der
ll
sz myCA.*
**0100000063f694
â–’**0100000063f694
â–’
cd /etc/squid/certs/
ll
sz
sz myCA.*
**0800000000022d
â–’**0800000000022d
â–’
ll
squid -v   ğŸ‘ˆç±»å‹nginx -v
/usr/lib64/squid/security_file_certgen -c -s /var/lib/ssl_db -M 4MB
find / -name security_file_certgen
rm -rf /usr/local/squid/
cd /squid/
ll
cd squid-6.10
ll
cd ..
l
ll
rm -rf squid-6.10
ll
tar xvf squid-6.10.tar.xz
ll
cd squid-6.10
ll
./configure --prefix=/usr/local/squid --sysconfdir=/etc --enable-arp-acl --enable-linux-netfilter --enable-linux-tproxy --enable-async-io=100 --enable-err-language="Simplify_Chinese" --enable-underscore --enable-poll --enable-gnuregex --with-openssl --enable-ssl-crtd --enalbe-ssl
ll
./configure --prefix=/usr/local/squid --sysconfdir=/etc --enable-arp-acl --enable-linux-netfilter --enable-linux-tproxy --enable-async-io=100 --enable-err-language="Simplify_Chinese" --enable-underscore --enable-poll --enable-gnuregex --with-openssl --enable-ssl-crtd --enable-ssl  ğŸ‘ˆç¼–è¯‘çš„é€‰é¡¹ï¼Œé‡ç‚¹åé¢ä¸‰ä¸ªéœ€è¦å¼€å¯ã€‚
make -j 4 && make install
vim /etc/squid.conf
cd cd /etc/squid
cd /etc/squid
ll
rm -rf certs/
ll
mkdir ssl_cert
ll
chown squid:squid ssl_cert
ll
cd ..
ll -d
ll -d squid
cd squid
ll
cd ssl_cert/
ll
cd ..
ll
chmod 700 ssl_cert   # é…ç½®æ–‡ä»¶éœ€è¦æœ‰æƒé™è¯»å–
ll
cd ssl_cert/
ll
openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -x509 -extensions v3_ca -keyout myCA.pem -out myCA.pem
ll
rpm -ql openssl
rpm -qc openssl
rpm -ql openssl
rpm -ql openssl |grep cnf
rpm -ql openssl |grep conf
rpm -ql openssl |grep cnf
rpm -qf /etc/pki/tls/openssl.cnf
vim /etc/pki/tls/openssl.cnf   # æ²¡å¿…è¦ï¼Œè¿™é‡Œæ˜¯csrç”³è¯·serverè¯ä¹¦çš„æ—¶å€™é…ç½®alter_nameçš„ã€‚ç”¨æ¥æµè§ˆå™¨æ˜¾ç¤ºå®‰å…¨çš„ï¼Œä¸è¿‡squidè¿™é‡Œä¸éœ€è¦ã€‚
ll
rm -rf myCA.pem
openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -x509 -extensions v3_ca -keyout myCA.pem -out myCA.pem  # ç§é’¥å’Œè¯ä¹¦åœ¨ä¸€ä¸ªæ–‡ä»¶çš„äº§ç”Ÿæ–¹å¼ã€‚
ll
openssl x509 -in myCA.pem -text -noout  # æ˜æ–‡æŸ¥çœ‹è¯ä¹¦çš„æ–¹å¼
find / -name security_file_certgen
vim /etc/pki/tls/openssl.cnf
vim /etc/squid.conf
squid -k parse
squid -v
ll /usr/local/squid/
tree /usr/local/squid/
systemctl restart squid
systemctl status squid
ss -tlnup
ll
systemctl status squid
ll /usr/local/squid/sbin/squid
ll /usr/local/ -d
ll /usr/local/squid/ -d
history |grep chown
ll /usr/local/squid/var/
chown -R squid.squid /usr/local/squid/var/
systemctl restart squid
ss -tlnu
ll /var/lib/ -d
chmod +w /var/lib/
ll /var/lib/ -d
chmod o+w /var/lib/
ll /var/lib/ -d
systemctl restart squid
ss -tlnu
security_file_certgen
find / -name security_file_certgen
vim /etc/squid.conf
/usr/local/squid/libexec/security_file_certgen -c -s /var/lib/ssl_db -M 4MB  ğŸ‘ˆåˆå§‹åŒ–dbä¸ç„¶squidé…ç½®sslèµ·ä¸æ¥ï¼Œä¸è¿‡äººå®¶ä¼šä¸æ–­å°è¯•åˆå§‹åŒ–ï¼Œæ‰‹åŠ¨æ•²äº†è¿™æ¡å°±è¡Œäº†ã€‚
ss -tlnu
iptables -vnL
iptables -vnL -t nat
systemctl stop docker
iptables -vnL -t nat
iptables -F
iptables -vnL -t nat
history |grep iptables
iptables -t nat -A POSTROUTING -j MASQUERADE   ğŸ‘ˆå‡ºå‘SNAT
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 80 -j REDIRECT --to 312
iptables -D PREROUTING
iptables -vnL -t nat
iptables -vnL -t nat --line-numbers
history |grep iptables |grep -D
history |grep iptables |grep '-D'
history |grep iptables |grep '\-D'
iptables -t nat -D PREROUTING 1
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 80 -j REDIRECT --to 3128
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 443 -j REDIRECT --to 3129
iptables -vnL -t nat
iptables -vnL -t nat --line-numbers
iptables -t nat -D PREROUTING 1
iptables -vnL -t nat --line-numbers
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 80 -j REDIRECT --to 3128  ğŸ‘ˆ httpæ‰“åˆ°3128
iptables -vnL
iptables -t nat -I PREROUTING -s 192.168.0.0/16 -p tcp --dport 443 -j REDIRECT --to 3129  ğŸ‘ˆhttpsçš„æ‰“åˆ°3129
iptables -vnL -t nat
ll
sz myCA.pem
**0800000000022d
â–’**0800000000022d
â–’
ll
openssl x509 -in myCA.pem -outform DER -out myCA.der  ğŸ‘ˆwindowsè®¤.deråç¼€
ll
sz myCA.der
**0800000000022d
â–’**0800000000022d
â–’
ll
history
history |awk '{for(i=5;i<=NF;i++){printf("%s ",$i)};printf("\n")}'
history |awk '{for(i=5;i<=NF;i++){printf("%s ",$i)};printf("\n")}' |grep -Ev 'll'
history |awk '{for(i=5;i<=NF;i++){printf("%s ",$i)};printf("\n")}' |grep -Ev 'll|history'
history |awk '{for(i=5;i<=NF;i++){printf("%s ",$i)};printf("\n")}'
[root@mysql-2 ssl_cert]#

```



**è¿™æ˜¯æ‰€æœ‰éƒ½okåçš„cnfğŸ‘‡**

```bash
[root@mysql-2 ssl_cert]# cat /etc/squid.conf
#
# Recommended minimum configuration:
#

# Example rule allowing access from your local networks.
# Adapt to list your (internal) IP networks from where browsing
# should be allowed
acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.16.0.0/12          # RFC 1918 local private network (LAN)
acl localnet src 192.168.0.0/16         # RFC 1918 local private network (LAN)
acl localnet src fc00::/7               # RFC 4193 local private network range
acl localnet src fe80::/10              # RFC 4291 link-local (directly plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# This default configuration only allows localhost requests because a more
# permissive Squid installation could introduce new attack vectors into the
# network by proxying external TCP connections to unprotected services.
http_access allow localhost

# The two deny rules below are unnecessary in this default configuration
# because they are followed by a "deny all" rule. However, they may become
# critically important when you start allowing external requests below them.

# Protect web applications running on the same server as Squid. They often
# assume that only local users can access them at "localhost" ports.
http_access deny to_localhost

# Protect cloud servers that provide local users with sensitive info about
# their server via certain well-known link-local (a.k.a. APIPA) addresses.
http_access deny to_linklocal

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

# For example, to allow access from your local networks, you may uncomment the
# following rule (and/or add rules that match your definition of "local"):
# http_access allow localnet

# And finally deny all other access to this proxy
http_access allow all
http_access deny all

# Squid normally listens to port 3128
http_port 8080
http_port 3128 intercept
https_port 3129 intercept ssl-bump cert=/etc/squid/ssl_cert/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s /var/lib/ssl_db -M 4MB
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all


# Uncomment and adjust the following to add a disk cache directory.
#cache_dir ufs /usr/local/squid/var/cache/squid 100 16 256
cache_effective_user squid
cache_effective_group squid
# Leave coredumps in the first cache dir
coredump_dir /usr/local/squid/var/cache/squid

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
[root@mysql-2 ssl_cert]#

```



è¿™æ˜¯æœåŠ¡

```bash
[root@mysql-2 squid]# cat /usr/lib/systemd/system/squid.service
[Unit]
Description=Squid Web Proxy
After=network.target

[Service]
Type=forking
PIDFile=/usr/local/squid/var/run/squid.pid
ExecStart=/usr/local/squid/sbin/squid
ExecStop=/usr/local/squid/sbin/squid -k shutdown
#ExecReload=kill -HUP $(cat /usr/local/squid/var/run/squid.pid)
ExecReload=/bin/sh -c 'kill -HUP $(cat /usr/local/squid/var/run/squid.pid)'

#ExecReload=/usr/local/squid/sbin/squid -k reconfigure
#ExecStartPre=/bin/sh -c 'netstat -natp | grep squid &> /dev/null || exit 0'
#ExecStartPost=/bin/sh -c 'echo "squid is starting..."'
ExecStopPost=/bin/sh -c 'rm -f /usr/local/squid/var/run/squid.pid'

[Install]
WantedBy=multi-user.target

[root@mysql-2 squid]#

```

æ³¨æ„ä¸Šå›¾çš„kill è¦æ¯”reconfiureæœ‰ç”¨ï¼Œé€Ÿåº¦å¿«ï¼Œè€Œä¸”è¦ç”¨/bin/sh -cå»è¿è¡Œï¼Œå¦åˆ™æŠ¥é”™æ‰¾ä¸åˆ°pidæ–‡ä»¶ã€‚

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241012145949455.png" alt="image-20241012145949455" style="zoom:33%;" />











è¿˜æœ‰ä¸€ä¸ªè¡¥å……ï¼Œç¼“å­˜çš„æ“ä½œğŸ‘‡ï¼Œå½“ç„¶ä¸è¦ç”¨squidå»å¯åŠ¨å“¦ï¼Œåªæ˜¯çœ‹squid -zé‚£ä¸€è¡Œ

![image-20241011141108254](2-ç½‘ç»œæ¶æ„.assets/image-20241011141108254.png)

æˆ‘çš„æ“ä½œ

![image-20241011141148553](2-ç½‘ç»œæ¶æ„.assets/image-20241011141148553.png)

ä¸Šå›¾åˆå§‹åŒ–ä¹ŸæŠ¥é”™äº†ï¼Œé‚£å°±stop æ‰squidç»§ç»­

![image-20241011141926727](2-ç½‘ç»œæ¶æ„.assets/image-20241011141926727.png)



æ­¤æ—¶cacheç¼“å­˜å°±åˆå§‹åŒ–äº†

![image-20241011141941757](2-ç½‘ç»œæ¶æ„.assets/image-20241011141941757.png)

å¯åŠ¨squidæ˜¯OKçš„ï¼ŒåŒæ—¶çœ‹æ—¥å¿—å¯è§ç¼“å­˜çš„ä¿¡æ¯

![image-20241011142151721](2-ç½‘ç»œæ¶æ„.assets/image-20241011142151721.png)

å…¶å®æ€è·¯æ˜¯å¯¹çš„ï¼Œå› ä¸ºä½ sslå¸è½½é™ä½äº†ç”¨æˆ·çš„é€Ÿåº¦ï¼Œä½ åˆç¼“å­˜å°†è¿™ä¸ªé€Ÿåº¦åˆè¡¥å›å»äº†ã€‚







ä¸‹åˆç ”ç©¶ä¸‹è¿‡æ»¤é…ç½®å§



### URL-acl

1ã€é¦–å…ˆæˆ‘è¦ç‹¬ç«‹çš„è¿‡æ»¤æ–‡ä»¶

æœ‰çš„è¿˜æ˜¯å‚è€ƒhttps://www.cnblogs.com/weq0805/p/15242170.html

![image-20241011142609478](2-ç½‘ç»œæ¶æ„.assets/image-20241011142609478.png)



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241011143747208.png" alt="image-20241011143747208" style="zoom: 33%;" />



çœ‹ç€ä¸é”™ï¼Œè¯•è¯•

ç„¶åè€ƒè™‘æ–‡ä»¶çš„é¢‘ç¹ä¿®æ”¹å’Œç”Ÿæ•ˆï¼Œéœ€è¦ä¿®æ”¹reloadåº•å±‚cliï¼Œç”¨kill -HUPè€Œä¸ç”¨ -k reconfigure-å¤ªæ…¢äº†

![image-20241012150101691](2-ç½‘ç»œæ¶æ„.assets/image-20241012150101691.png)





### æ³¨æ„urlè¿‡æ»¤åŸŸåå’Œipçš„ä¸¤ä¸ªurléƒ½è¦å†™

å¦åˆ™å°±æ˜¯åŸŸåçš„https://xxx.yy.zz/123  å¹²æ‰äº†ï¼Œä½†æ˜¯xxx.yy.zzå¯¹åº”çš„ip http://a.b.c.d/123æ²¡å¹²æ‰ã€‚

ç™½åå•å’Œé»‘åå• è¦é’ˆå¯¹ä¸€ä¸ªurlè¦å†™åŸŸåçš„urlå’Œipçš„urlä¸¤è¡Œçš„



chromeçš„æ— ç—•æ¨¡å¼æ˜¯ä¸æ˜¯æœ‰ä»€ä¹ˆç‰¹æ®Šæ€§ï¼Œ

firefox å’Œ firefox æ— ç—• éƒ½å¯ä»¥æ‰“å¼€http://xxx.yy.zz/annoucement

chrome å¯ä»¥ï¼Œchromeæ— ç—•ä¸è¡Œ 

https://blog.csdn.net/u010059669/article/details/135158912

è¿™å°±æ˜¯åŸå› ğŸ‘†

![](2-ç½‘ç»œæ¶æ„.assets/image-20241012175845837.png)

ä¹Ÿå°±æ˜¯æ— ç—•çš„é—®é¢˜ğŸ‘‡å…³é”®è¿™ä¸ªhttpupgradeæ˜¯chromeçš„ä¼˜åŒ–ï¼Œä½†æ˜¯åœ¨æ— ç—•ä¸‹éœ€è¦ç‚¹å‡» ç»§ç»­è®¿é—®ï¼Œè€Œè¿™ä¸ªç‚¹å‡»çš„åŠ¨ä½œ ç»“åˆ squidè¿‡æ»¤å°±æ— æ³• ç»§ç»­ç‚¹å‡»äº†ï¼Œç›´æ¥å°±å¹²æ‰äº†ã€‚æ‰€æœ‰ è¦å…³é—­è¿™ä¸ªhttpgradeè¯•è¯•ã€‚

![image-20241012175919621](2-ç½‘ç»œæ¶æ„.assets/image-20241012175919621.png)

ç¬¬äºŒä¸ªæ˜¯httpsçš„ï¼Œå›é€€æˆç¬¬ä¸€ä¸ª307äº†

![image-20241012180005728](2-ç½‘ç»œæ¶æ„.assets/image-20241012180005728.png)



ä¹‹å‰æ˜¯æ²¡æœ‰è¿™ä¸€æ­¥çš„ï¼Œç°åœ¨chromeçš„æ— ç—•åŠ äº†ä¸ªè¿™ä¸ªğŸ‘†ã€‚ 307æ˜¯HTTPSå›é€€httpçš„ä»£ç ï¼Œä¸æ˜¯æ˜¯httpå‡åˆ°httpsğŸ‘‡

![image-20241012180353463](2-ç½‘ç»œæ¶æ„.assets/image-20241012180353463.png)



å°è¯•å…³é—­è¿™ä¸ªæ— ç—•æ¨¡å¼çš„httpupgradesï¼Œæ— ç—•ç”¨ä¸äº†æ’ä»¶çš„ã€‚

https://blog.csdn.net/u010059669/article/details/135158912



ä¸Šé¢çš„é—®é¢˜ï¼Œä»€ä¹ˆé—®é¢˜ï¼šå°±æ˜¯squidåšäº†ipå’ŒåŸŸåçš„  urlè¿‡æ»¤å firefox æœ‰ç—• å’Œ æ— ç—• éƒ½å¯ä»¥æ‰“å¼€ï¼Œè€Œchrome æœ‰ç—•å¯ä»¥ï¼Œæ— ç—•NGçš„é—®é¢˜è§£å†³äº†ï¼Œå°±æ˜¯æœ‰ç—•çš„æ¨¡å¼ä¸‹æ²¡æœ‰192.168.200.18:443è¿™ä¹ˆä¸€ä¸ªconnectï¼Œè€Œæ— ç—•å­˜åœ¨ï¼Œchromeçš„æ— ç—•éœ€è¦åŠ ä¸€ä¸ªIP:443çš„æ”¾è¡Œ



è¿™æ˜¯chromeæ— ç—•ä¸‹è®¿é—®http://xxn.it/announcementçš„æƒ…å†µï¼Œæ³¨æ„ä¸‹å›¾æ˜æ˜¾çœ‹åˆ°æ˜¯httpsçš„ï¼Œè¦æ³¨æ„æ˜¯è‡ªå·±è·³è¿‡å»çš„ï¼Œå’Œæˆ‘æ— å…³ï¼Œä¹Ÿæ— éœ€å…³æ³¨è¿™ä»¶äº‹æƒ…ã€‚

![image-20241014102302005](2-ç½‘ç»œæ¶æ„.assets/image-20241014102302005.png)



é€šè¿‡è§‚å¯Ÿaccess.logå‘ç°æœ‰ä¸€æ¡

![image-20241014102419994](2-ç½‘ç»œæ¶æ„.assets/image-20241014102419994.png)



äºæ˜¯åœ¨è¿‡æ»¤urlçš„æ–‡ä»¶é‡Œè¡¥ä¸€ä¸ªIPå’Œ443å°±å¯ä»¥å¼¹å‡ºè¿™ä¸ªç‚¹å‡»ç»§ç»­çš„é¡µé¢äº†

![image-20241014102530022](2-ç½‘ç»œæ¶æ„.assets/image-20241014102530022.png)

æ­¤æ—¶ç»§ç»­å°±OKäº†ï¼Œè‡ªæ­¤å®Œæˆæ— ç—•ä¸‹çš„urlæ”¾è¡Œä¼˜åŒ–ã€‚



ç„¶åè¿˜æ¢³ç†ä¸€ä¸ªè¿™ä¸ªé—®é¢˜

å°±æ˜¯é¡µé¢ç‚¹å‡»é¦–é¡µå¯ä»¥è¿›å»ï¼Œé¦–é¡µå…¶å®æ˜¯squidç™½åå•é‡Œæ²¡æœ‰æ”¾è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯denyçš„å˜›ï¼ŒåŸå› æ˜¯è®¿é—®urlçš„æ—¶å€™åŠ è½½äº†éƒ¨åˆ†çš„é¦–é¡µèµ„æºã€‚æ‰€ä»¥å¯ä»¥æ‰“å¼€äº›



squidåªæ”¾è¡Œäº†

![image-20241014104244296](2-ç½‘ç»œæ¶æ„.assets/image-20241014104244296.png)



é€šè¿‡å…ˆæ‰“å¼€http://lxxn.it/announcement

å†ç‚¹å‡»é¡µé¢çš„é¦–é¡µå°±è¿›å»äº†

è™½ç„¶squidç¦æ­¢äº†logæœ‰ï¼Œ

![image-20241014104227199](2-ç½‘ç»œæ¶æ„.assets/image-20241014104227199.png)



ä½†æ˜¯å…¶å®ä¹‹å‰è®¿é—®å­é¡µé¢çš„æ—¶å€™å°±åŠ è½½äº†å¥½å¤šğŸ‘‡ï¼Œæ‰€ä»¥å¯ä»¥ç«™å†…ç‚¹å‡»è¿›å»ï¼Œä½†æ˜¯

![image-20241014104358236](2-ç½‘ç»œæ¶æ„.assets/image-20241014104358236.png)

ä½†æ˜¯é‡æ–°å‘èµ·å°±ä¸è¡Œäº†ğŸ‘‡

â‘ æ‰“å¼€squidæ”¾è¡Œçš„url okçš„

![image-20241014105006658](2-ç½‘ç»œæ¶æ„.assets/image-20241014105006658.png)





â‘¡ç„¶åç‚¹å‡»é¡µé¢ä¸Šçš„é¦–é¡µå°±è¿›å…¥äº†squidæ²¡æœ‰æ”¾å¼€çš„é¡µé¢

![image-20241014105107793](2-ç½‘ç»œæ¶æ„.assets/image-20241014105107793.png)



â‘¢å†æ¬¡ç›´æ¥è®¿é—®è¿™ä¸ªé¡µé¢å¯è§æ˜¯ä¸è¡Œçš„

![image-20241014105158038](2-ç½‘ç»œæ¶æ„.assets/image-20241014105158038.png)



æ€»ä¹‹è¿™å—å·®å¼ºäººæ„å§ï¼Œæˆ‘è¯´å·®å¼ºäººæ„ï¼Œä¸ä»£è¡¨ åˆ«äººå¯ä»¥è¿™ä¹ˆè¯´ï¼Œç‰¹åˆ«æ˜¯ä¸æ‡‚ç»†èŠ‚çš„äººï¼Œé¢bï¼ˆï¿£â–½ï¿£ï¼‰dã€€å¥½åƒä¹Ÿæ²¡äººè·Ÿæˆ‘è¿™ä¹ˆè¯´ã€‚ã€‚ã€‚







# å·¥ä½œæ¡ˆä¾‹-å¦‚ä½•ç›‘ç®¡å¼€å‘å†…ç½‘çš„HTTPSçš„payloadä¹Ÿå°±æ˜¯å†…å®¹è¿‡æ»¤





https://www.cnblogs.com/studio313/archive/2011/09/22/2184969.html



https://www.theopensourcerer.com/2014/04/how-to-install-a-squid-dansguardian-content-filter-on-ubuntu-server/![image-20241014140817595](2-ç½‘ç»œæ¶æ„.assets/image-20241014140817595.png)

æˆ‘ä¹ŸåŠ ä¸Šäº†è¿™ä¸€æ®µï¼Œé™¤äº†200 MBè¦æœ‰ç©ºæ ¼ä»¥å¤–è¿˜éœ€è¦åˆ é™¤log_fqdn offè¿™ä¸€å¥è¿‡å¤±çš„å‘½ä»¤ï¼Œå…¶ä»–éƒ½æ²¡æœ‰å½±å“squidçš„å¯åŠ¨ã€‚ä½†æ„¿èƒ½å¤Ÿèµ·åˆ°ä¼˜åŒ–çš„ä½œç”¨ã€‚

æµ‹è¯•äº†ä¸‹logfile_roate 10 æœ‰æ•ˆæœğŸ‘‡

![image-20241014141543395](2-ç½‘ç»œæ¶æ„.assets/image-20241014141543395.png)





dansguardianå¤ªè€äº†ï¼Œåº”è¯¥æ˜¯æ”¶è´¹äº†å§ï¼Œæ‰€ä»¥æ¢æˆc-icapç»§ç»­ç ”ç©¶

https://c-icap.sourceforge.net/

![image-20241014152711820](2-ç½‘ç»œæ¶æ„.assets/image-20241014152711820.png)

æŒºå¥½ï¼Œå¤©ç”Ÿä¸€å®¶ğŸ‘†squidå’Œicapï¼Œopnsenseé‚£é‡Œå¥½åƒå«o-c-icapå¥½åƒï¼Œå›å¤´æŠ˜è…¾opnsenseçš„æ—¶å€™å†è¯´ï¼Œè¦å¼„çš„ï¼

çœ‹çœ‹githubä¸Šç»´æŠ¤å¾ˆè›®æ–°çš„

https://github.com/c-icap/c-icap-server

yumåçš„serviceæ–‡ä»¶é‡Œçš„å¯åŠ¨ç”¨æˆ·å’Œç»„è¦æ³¨é‡Šæ‰ï¼Œå¦åˆ™èµ·ä¸æ¥ã€‚ã€‚ã€‚ã€‚è€Œä¸”nginxå’Œsquidéƒ½æ˜¯forkçš„å½¢å¼å¯åŠ¨çš„ä¹Ÿä¸ä¸€æ ·ã€‚å…ˆrootå§



![image-20241014162612113](2-ç½‘ç»œæ¶æ„.assets/image-20241014162612113.png)





https://blog.csdn.net/liangzhao_jay/article/details/12575839

https://cloud.tencent.com/developer/ask/sof/116943622

https://www.egirna.com/blog/news-2/how-to-configure-squid-proxy-with-icap-10

ğŸ‘‡è¿™ä¸ªæ˜¯é‡ç‚¹

https://wiki.squid-cache.org/ConfigExamples/ContentAdaptation/C-ICAP



opnsenseæ˜¯ squid+c-icap+clamav+redisçš„ï¼Œå¥½å¤æ‚

ä¸è¿‡clamavæ—¢ç„¶èƒ½æ‰«ç—…æ¯’ï¼Œåº”è¯¥å°±èƒ½æ‰«ftpã€pdfã€ä¹‹ç±»çš„æ­£å¸¸æ–‡ä»¶å•Šã€‚

https://www.cnblogs.com/gaoyuechen/p/9019098.htmlè¿™æ˜¯clamavè½¯ä»¶å•ç‹¬çš„

è¯•ä¸‹ğŸ‘†å®‰è£…è¯•éªŒä¸‹

![image-20241015171128319](2-ç½‘ç»œæ¶æ„.assets/image-20241015171128319.png)

è¯´è¿™ä¸ªæ˜¯é»˜è®¤ç—…æ¯’åº“

![image-20241015171429314](2-ç½‘ç»œæ¶æ„.assets/image-20241015171429314.png)



![image-20241015172638635](2-ç½‘ç»œæ¶æ„.assets/image-20241015172638635.png)



å‡çº§ç—…æ¯’åº“çš„cliåœ¨clamav-develåŒ…é‡Œï¼Œ

![image-20241015172709166](2-ç½‘ç»œæ¶æ„.assets/image-20241015172709166.png)

æœ‰äº†ğŸ‘‡

![image-20241015172725677](2-ç½‘ç»œæ¶æ„.assets/image-20241015172725677.png)

https://wiki.ubuntu.org.cn/ClamAV

ä½†æ˜¯ç—…æ¯’åº“å‡ä¸Šå»ä¹Ÿå°±æ˜¯ä¸‹è½½ä¸‹æ¥ï¼Œæœ‰å¯èƒ½å¯¼è‡´oomçš„

æˆ‘è¿™é‡Œä¸åŠ å†…å­˜äº†ï¼Œåˆ æ‰ä¸€ä¸ªåº“æµ‹è¯•

![image-20241015174919895](2-ç½‘ç»œæ¶æ„.assets/image-20241015174919895.png)

æ—¢ç„¶èƒ½æ‰«å‡ºæ¥æ–‡ä»¶ï¼Œç½‘ç»œæµé‡é‡Œçš„æ—¥å¿—ä¹Ÿè®¸ä¹Ÿæœ‰è¿™ç§æ–‡ä»¶åç§°å§ã€‚





https://blog.csdn.net/lionzl/article/details/7749334

è¿™ä¸ªä¸é”™ğŸ‘†

squid ã€ c-icapã€clamavä¹‹é—´é…åˆï¼Œè‚¯å®šè¦ç¼–è¯‘çš„æ—¶å€™å¸¦ä¸Šä¸€äº›æ¨¡å—çš„

![image-20241015175552749](2-ç½‘ç»œæ¶æ„.assets/image-20241015175552749.png)

ä¸è¿‡å¯æƒœï¼Œä»–æ²¡æœ‰å¸¦ä¸Šsslï¼Œæ‰€ä»¥ä»–æ²¡æ³•å¯¹ssl ä¹Ÿå°±æ˜¯httpsæ€æ¯’

è¿™æ˜¯ğŸ‘‡opnsenseçš„ç¼–è¯‘é€‰é¡¹

![image-20241015182702677](2-ç½‘ç»œæ¶æ„.assets/image-20241015182702677.png)



ç„¶åyum å®‰è£…squid ä¸€æ ·é€‰é¡¹å¤šå¤š

![image-20241015182832418](2-ç½‘ç»œæ¶æ„.assets/image-20241015182832418.png)

å°±æ˜¯ç‰ˆæœ¬ä½äº†äº›



https://wiki.ubuntu.org.cn/ClamAV

clamavè¦æœ‰confï¼Œçœ‹æ¥æ˜¯clamav-daemonäº†ï¼Œå¯æƒœæˆ‘ä»¬æ‰¾åˆ°è¿™ä¸ªåŒ…

![image-20241015175844783](2-ç½‘ç»œæ¶æ„.assets/image-20241015175844783.png)



ç«Ÿç„¶æœ‰squidclamavè¿™ä¸ªï¼Œçœ‹åå­—å°±æ˜¯é›†æˆå¥½çš„å’¯ï¼Œç®—äº†ï¼Œæˆ‘è¿˜æ˜¯åˆ†å¼€æ¥å­¦å§

![image-20241015180004958](2-ç½‘ç»œæ¶æ„.assets/image-20241015180004958.png)



![image-20241015180327512](2-ç½‘ç»œæ¶æ„.assets/image-20241015180327512.png)

ğŸ‘†è¯´æ˜å®‰è£…2ä¸ªåŒ…å…¶å®é™„å¸¦å®‰è£…äº†å¾ˆå¤šçš„ã€‚



https://blog.csdn.net/ygm_linux/article/details/60882597

è¿™ä¸ªä¹Ÿä¸é”™ğŸ‘†





https://www.clamav.net/

è¿™ä¸ªæ˜¯å®˜ç½‘ğŸ‘†ï¼Œçœ‹ç€é…·å€’æ˜¯æŒºé…·ï¼Œå°±æ˜¯æœ‰ç‚¹åƒç—…æ¯’ã€‚ã€‚ã€‚



https://docs.clamav.net/appendix/CvdPrivateMirror.html?highlight=squid#use-an-http-proxy

![image-20241015182312286](2-ç½‘ç»œæ¶æ„.assets/image-20241015182312286.png)



![image-20241015182422386](2-ç½‘ç»œæ¶æ„.assets/image-20241015182422386.png)





<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241015183502984.png" alt="image-20241015183502984" style="zoom: 33%;" />





ç¥äº†è¿™ä¹ˆå¤šæ”»ç•¥ï¼Œæ‰¾ä¸€å¤©æ—¶é—´å¼€å¹²



## å®éªŒ

èµ°ä¸€éhttps://blog.csdn.net/lionzl/article/details/7749334

yum å®‰è£…squidå°±è¡Œ

ç”±äºæˆ‘è¿™æœ‰ä¸€ä¸ªä¹‹å‰ç¼–è¯‘çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥ln -sä¸‹å°±å¥½äº†

![image-20241016100045502](2-ç½‘ç»œæ¶æ„.assets/image-20241016100045502.png)

è¿˜å¾—å¼„è¯ä¹¦ï¼Œå”‰~ï¼Œä¸ç”¨ï¼Œç›´æ¥æŠŠä¹‹å‰ç¼–è¯‘çš„é…ç½®æ–‡ä»¶å¤åˆ¶è¿‡æ¥å°±è¡Œäº†ã€‚

```
Icap client for squidé…ç½®ï¼š
icap_enable on
icap_preview_enable on
icap_preview_size 128
icap_send_client_ip on
icap_service service_avi_req reqmod_precache 0 icap://localhost:1344/srv_clamav
icap_service service_avi respmod_precache 1 icap://localhost:1344/srv_clamav
icap_class class_antivirus service_avi
icap_access class_antivirus allow all
icap_class class_antivirus_req service_avi_req
icap_access class_antivirus_req allow all
```

ç»§ç»­https://blog.csdn.net/lionzl/article/details/7749334



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016114616504.png" alt="image-20241016114616504" style="zoom:33%;" />



yumçš„clamçš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼Œä¸æ˜¯ç®­å¤´æŒ‡çš„é‚£ä¸ªï¼Œè€Œæ˜¯freshclam.confæ‰æ˜¯ï¼Œä¸Šå›¾è¡Œå†…å®¹åœ¨è¯¥æ–‡ä»¶é‡Œéƒ½æœ‰

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016114722272.png" alt="image-20241016114722272" style="zoom:44%;" />



æ—¢ç„¶æœ‰é…ç½®æ–‡ä»¶ï¼Œè¯´æ˜æœ‰æœåŠ¡å•Šï¼Œçœ‹æ¥æˆ‘è¿˜å°‘å®‰è£…ä¸€ä¸ªæœåŠ¡

![image-20241016115520738](2-ç½‘ç»œæ¶æ„.assets/image-20241016115520738.png)

ç¥äº†~ installä¼šç»™ä½ è‡ªåŠ¨å¯¹åº”è¿‡å»ï¼Œsearchæ²¡æœ‰ã€‚

privodesæœ‰çš„ï¼Œé è°±

![image-20241016115913908](2-ç½‘ç»œæ¶æ„.assets/image-20241016115913908.png)

ç»“è®ºï¼šsearchçš„åç§°è¦å¯¹ï¼Œprovides ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ç»™ä½ è½¬æ¢ä½ åœ¨clamavåé¢è¡¥ä¸€ä¸ª-serverï¼Œäººå®¶è‡ªåŠ¨è¯†åˆ«äº†ã€‚



çœ‹è¿™ä¸ªhttps://www.cnblogs.com/hkgan/p/17346628.html





äº†è§£ä¸‹logå’Œç—…æ¯’åº“

![image-20241016141255339](2-ç½‘ç»œæ¶æ„.assets/image-20241016141255339.png)



![image-20241016141345108](2-ç½‘ç»œæ¶æ„.assets/image-20241016141345108.png)



systemctl status clamav-freshclamé‡Œä¹Ÿæœ‰ï¼Œä¸è¿‡çœ‹ä¸å…¨å’¯ï¼Œå› ä¸ºä¸€äº›åŠ¨ä½œpre postéƒ½æ˜¯å¯åŠ¨åæˆ–stopåçš„åŠ¨ä½œè®°å½•æ˜¯ç”±å±æ˜¾å®½åº¦çš„ğŸ‘‡dailyçš„å°±ä¸Šæ»šæ‰äº†ã€‚

![image-20241016141504399](2-ç½‘ç»œæ¶æ„.assets/image-20241016141504399.png)



ç„¶åå¼„c-icap

èµ·ä¸æ¥ï¼Œå‘ç°æ˜¯clamdæ²¡èµ·æ¥



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016152746441.png" alt="image-20241016152746441" style="zoom: 40%;" />

æ²¡èµ·æ¥å°±çœ‹ä¸‹https://www.cnblogs.com/hkgan/p/17346628.html

![image-20241016152911441](2-ç½‘ç»œæ¶æ„.assets/image-20241016152911441.png)

å†çœ‹çœ‹

![image-20241016154017457](2-ç½‘ç»œæ¶æ„.assets/image-20241016154017457.png)



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016154044368.png" alt="image-20241016154044368" style="zoom:50%;" />





æ‰¾åˆ°åŸå› äº†ğŸ‘‡ï¼Œsockæ²¡ç»™ï¼Œ

![image-20241016155311263](2-ç½‘ç»œæ¶æ„.assets/image-20241016155311263.png)

ç„¶åæ¢å¤serviceæ–‡ä»¶å§ï¼Œä¸Šå›¾ğŸ‘†æ˜¯æ’é”™å¤åˆ¶äº†ä¸€ä»½serviceæ–‡ä»¶å»æ‰äº†é‡Œé¢çš„å˜é‡ã€‚

ç”¨ä¼ å‚çš„æ–¹å¼æ¥å¯åŠ¨clamdæœåŠ¡

![image-20241016155419226](2-ç½‘ç»œæ¶æ„.assets/image-20241016155419226.png)

æœ‰è¿›æ­¥ï¼Œä½†æ˜¯

![image-20241016155548223](2-ç½‘ç»œæ¶æ„.assets/image-20241016155548223.png)

kaillæ‰ä¹‹å‰çš„è¿›ç¨‹ï¼Œrestartå°±è¡Œäº†ï¼Œå¯èƒ½ä¹‹å‰æœ‰æ‰‹åŠ¨çš„æ®‹ç•™ï¼Ÿåº”è¯¥æ˜¯çš„ï¼Œå¤ç°äº†å°±æ˜¯æ‰‹åŠ¨ç”¨serviceé‡Œçš„cliå¯åŠ¨åï¼Œctrl cé€€å‡ºï¼Œå†ç”¨serviceå¯åŠ¨ï¼Œå°±è¿™æ ·äº†ï¼Œæ­£å¸¸ç°è±¡ã€‚å¹²å‡€çš„è¿›ç¨‹ systemctl startå°±è¡Œäº†



okäº†

![image-20241016160131493](2-ç½‘ç»œæ¶æ„.assets/image-20241016160131493.png)



ç„¶åå¯åŠ¨c-icapæœåŠ¡å‘ç°

![image-20241016160654045](2-ç½‘ç»œæ¶æ„.assets/image-20241016160654045.png)

è¿˜æ˜¯è¦æ³¨é‡Šæ‰ Service antivirus_module srv_clamav.so  æ‰èƒ½èµ·æ¥

å¯èƒ½æ˜¯æ¨¡å—ç¼ºå¤±

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016160742818.png" alt="image-20241016160742818" style="zoom:43%;" />





<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016160810744.png" alt="image-20241016160810744" style="zoom:50%;" />





![image-20241016161042890](2-ç½‘ç»œæ¶æ„.assets/image-20241016161042890.png)





![image-20241016161138360](2-ç½‘ç»œæ¶æ„.assets/image-20241016161138360.png)

è¯•è¯•



![image-20241016161522412](2-ç½‘ç»œæ¶æ„.assets/image-20241016161522412.png)



çœ‹æ¥ä¸æ˜¯xxx.soæ–‡ä»¶ï¼Œè¿˜éœ€è¦ç¼–è¯‘çš„ğŸ‘†

çœ‹çœ‹yumçš„ï¼Œä¹‹å‰æˆ‘æ˜¯yumçš„

![image-20241016161748128](2-ç½‘ç»œæ¶æ„.assets/image-20241016161748128.png)

è£…ä¸€ä¸‹c-icap-modulesæ¨¡å—

æœç„¶æœ‰äº†å¾ˆå¤š

![image-20241016161827348](2-ç½‘ç»œæ¶æ„.assets/image-20241016161827348.png)

åˆ æ‰tmpå§ï¼Œå“ˆå“ˆä¸è¦è‡ªå·±ç¼–è¯‘äº†

å¦‚æœè‡ªå·±å®‰è£…å‘¢ï¼Œè¯•è¯•

![image-20241016162744095](2-ç½‘ç»œæ¶æ„.assets/image-20241016162744095.png)



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016162804635.png" alt="image-20241016162804635" style="zoom:40%;" />



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016162945055.png" alt="image-20241016162945055" style="zoom:40%;" />







![image-20241016163346084](2-ç½‘ç»œæ¶æ„.assets/image-20241016163346084.png)



æ€»ä¹‹å†æ¬¡åˆ›å»ºm4æ–‡ä»¶å¤¹ï¼Œç„¶åæ³¨é‡Šåˆ° ç‰ˆæœ¬çš„åˆå§‹åŒ–æ–¹å¼(å¤§æ¦‚)ï¼Œæ‰“å¼€0.3.2è‡ªå®šä¹‰ç‰ˆæœ¬å°±è¡Œäº†

![image-20241016163423911](2-ç½‘ç»œæ¶æ„.assets/image-20241016163423911.png)



<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016163635852.png" alt="image-20241016163635852" style="zoom:40%;" />





![image-20241016163522691](2-ç½‘ç»œæ¶æ„.assets/image-20241016163522691.png)

configureæ–‡ä»¶å°±æœ‰äº†ï¼Œå¯ä»¥ç¼–è¯‘å®‰è£…äº†



 æˆ‘è¿˜æ˜¯æŒ‡å®šä¸€ä¸ªprefixå§

![image-20241016163927710](2-ç½‘ç»œæ¶æ„.assets/image-20241016163927710.png)



çœ‹çœ‹yumçš„å°±çŸ¥é“ç¼–è¯‘å®‰è£…å¤§æ¦‚è¦å“ªäº›åŒ…äº†

![image-20241016164051137](2-ç½‘ç»œæ¶æ„.assets/image-20241016164051137.png)



ç»§ç»­æ‰‹åŠ¨ç¼–è¯‘

![image-20241016164118650](2-ç½‘ç»œæ¶æ„.assets/image-20241016164118650.png)

ä¼°è®¡è¿™é‡Œå°±æ˜¯å…³é”®äº†ï¼Œè‚¯èƒ½æ˜¯è¿™ä¸ª é€‰é¡¹ä¸€æŒ‡å®šï¼Œå°±æ¨¡å—å®‰è¿›å»äº†ï¼Œå¤§æ¦‚å§

é€šè¿‡./configure -hå¯è§ prefixä¸æ˜¯çæŒ‡å®šçš„ï¼Œè€Œæ˜¯è¦çŸ¥é“c-icapå®‰è£…prefixé‡Œå»çš„

![image-20241016164308171](2-ç½‘ç»œæ¶æ„.assets/image-20241016164308171.png)



ç§»èµ°ä¸¤ä¸ªyumå®‰è£…çš„æ¨¡å—ï¼Œå¾…ä¼šçœ‹ç¼–è¯‘å®‰è£…æ˜¯å¦è¡¥è¿›æ¥

![image-20241016164406137](2-ç½‘ç»œæ¶æ„.assets/image-20241016164406137.png)



æ²¡æ‰¾æ‰“configçš„é€‰é¡¹ï¼Œä½†æ˜¯æ‰¾åˆ°äº†c-icapçš„é€‰é¡¹ï¼Œè¯•è¯•

![image-20241016164619633](2-ç½‘ç»œæ¶æ„.assets/image-20241016164619633.png)



![image-20241016165236902](2-ç½‘ç»œæ¶æ„.assets/image-20241016165236902.png)

ç„¶åmake && make installæŠ¥é”™

![image-20241016165515410](2-ç½‘ç»œæ¶æ„.assets/image-20241016165515410.png)

ç„¶åmake ç»§ç»­æŠ¥é”™

![image-20241016165543571](2-ç½‘ç»œæ¶æ„.assets/image-20241016165543571.png)

æ”¾å¼ƒï¼Œå°±ç”¨yumå§ã€‚ã€‚ã€‚



ç„¶åæ”¹ä¸€ä¸‹é…ç½®æ–‡ä»¶é‡Œçš„æ¨¡å—ï¼Œæ‰¾ä¸åˆ°çš„å°±ç”¨çœ‹ç€åƒçš„æ›¿æ¢è¯•è¯•ï¼Œç»“æœï¼Œä¸è¡Œ

çªç„¶å‘ç°c-icap yumå®‰è£…çš„ æ²¡æœ‰å¯åŠ¨ --with-clamavã€‚ã€‚ã€‚ã€‚ã€‚æˆ‘æ—¥ï¼Œyumå‘æˆ‘

![image-20241016170755920](2-ç½‘ç»œæ¶æ„.assets/image-20241016170755920.png)

å…ˆç»§ç»­ç”¨yumçš„c-icapè¯•è¯•çœ‹

æ€ä¹ˆè¯•ï¼Œå°±æ˜¯æ‰¾srv_clamav.soè¿™ä¸ªæ¨¡å—

ç®—äº† ç¼–è¯‘å§ï¼Œä¸æ˜¯ç¼–è¯‘c-icap-modulesï¼Œè€Œæ˜¯ä½¿ç”¨--with-clamav ç¼–è¯‘c-icap



### é‡æ–°ç¼–è¯‘å®‰è£…c-icap

https://c-icap.sourceforge.net/download.html

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241016171800185.png" alt="image-20241016171800185" style="zoom: 50%;" />



![image-20241016172717497](2-ç½‘ç»œæ¶æ„.assets/image-20241016172717497.png)







![image-20241016172945712](2-ç½‘ç»œæ¶æ„.assets/image-20241016172945712.png)



![image-20241016172916717](2-ç½‘ç»œæ¶æ„.assets/image-20241016172916717.png)



å¾—å†ä¸‹ä¸€ä¸ªc-icap-modules-0.5.7

![image-20241016173427649](2-ç½‘ç»œæ¶æ„.assets/image-20241016173427649.png)

å¼€æ

```bash
./configure --enable-static --prefix=/usr/local/c-icap/

make -j 4 && make install
```

![image-20241016173548763](2-ç½‘ç»œæ¶æ„.assets/image-20241016173548763.png)



![image-20241016173627189](2-ç½‘ç»œæ¶æ„.assets/image-20241016173627189.png)



æ²¡æŠ¥é”™

![image-20241016173644650](2-ç½‘ç»œæ¶æ„.assets/image-20241016173644650.png)

æ–‡ä»¶æœ‰äº†

![image-20241016173715887](2-ç½‘ç»œæ¶æ„.assets/image-20241016173715887.png)

çœ‹çœ‹æ¨¡å—æ–‡ä»¶ï¼Œå› ä¸ºæ˜¯--enable-staticçš„ï¼Œæ‰€ä»¥æœ‰å¾ˆå¤šxx.soï¼Œä½†æ˜¯æ²¡æœ‰clamavçš„ï¼Œè‚¯å®šå•Šï¼Œäººå®¶å®˜ç½‘éƒ½è¯´äº†è¦ç¬¬äºŒä¸ªåŒ…

![image-20241016174118841](2-ç½‘ç»œæ¶æ„.assets/image-20241016174118841.png)





å¤§ä¸äº†å‚è€ƒyumå®‰è£…å¾—æœåŠ¡è‡ªå·±å†™ä¸€ä¸ª

ç„¶åç»§ç»­å®‰è£…ç¬¬äºŒä¸ªmodulesåŒ…

![image-20241016174313194](2-ç½‘ç»œæ¶æ„.assets/image-20241016174313194.png)



![image-20241016174533444](2-ç½‘ç»œæ¶æ„.assets/image-20241016174533444.png)



```bash
./configure --with-c-icap=/usr/local/c-icap/ --with-clamav=/usr/sbin/clamd
```

![image-20241016174517241](2-ç½‘ç»œæ¶æ„.assets/image-20241016174517241.png)

å¥½åƒå¤±è´¥äº†

![image-20241016174623556](2-ç½‘ç»œæ¶æ„.assets/image-20241016174623556.png)

é‚£ä¹ˆå°±clamavä¹Ÿç¼–è¯‘å®‰è£…ä¸€ä¸‹å•Šï¼Ÿ

![image-20241016175142589](2-ç½‘ç»œæ¶æ„.assets/image-20241016175142589.png)



![image-20241016175424613](2-ç½‘ç»œæ¶æ„.assets/image-20241016175424613.png)



https://blog.csdn.net/lionzl/article/details/7749334

```bash
./configure --prefix=/usr/local/clamav --with-dbdir=/usr/clamav
```

ä¸è¡Œäº†ï¼Œè¦å®‰è¿™ä¸ªæ¥ğŸ‘‡

https://docs.clamav.net/manual/Installing/Installing-from-source-Unix.html

å®‰è£…ä¾èµ–

```bash
python3 -m pip install  cmake pytest
æ”¹ç”¨ 

    dnf install -y \
      gcc gcc-c++ make python3 python3-pip valgrind \
      bzip2-devel check-devel json-c-devel libcurl-devel libxml2-devel \
      ncurses-devel openssl-devel pcre2-devel sendmail-devel zlib-devel
  
  
yum install cmake
dnf install -y cargo rust

```

![image-20241016180526955](2-ç½‘ç»œæ¶æ„.assets/image-20241016180526955.png)



æ”¹ç”¨yumå®‰è£…



![image-20241016180936510](2-ç½‘ç»œæ¶æ„.assets/image-20241016180936510.png)





![image-20241016183236727](2-ç½‘ç»œæ¶æ„.assets/image-20241016183236727.png)



```bash
yum -y install bindgen
```



è¿˜å‰©ä¸€ä¸ªäº†

![image-20241016183402820](2-ç½‘ç»œæ¶æ„.assets/image-20241016183402820.png)



```bash
yum -y install bindgen
```

![image-20241016183437998](2-ç½‘ç»œæ¶æ„.assets/image-20241016183437998.png)



éƒ½è£…å¥½äº†ï¼Œè¿˜æ˜¯ä¸è¡Œ

![image-20241016193922448](2-ç½‘ç»œæ¶æ„.assets/image-20241016193922448.png)



![image-20241017091419941](2-ç½‘ç»œæ¶æ„.assets/image-20241017091419941.png)



![image-20241017091510777](2-ç½‘ç»œæ¶æ„.assets/image-20241017091510777.png)



![image-20241017091537698](2-ç½‘ç»œæ¶æ„.assets/image-20241017091537698.png)



![image-20241017091621066](2-ç½‘ç»œæ¶æ„.assets/image-20241017091621066.png)



json-cæä¸å®šï¼Œç»§ç»­

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241017092951635.png" alt="image-20241017092951635" style="zoom:50%;" />





ç°åœ¨å°±æœ‰äº†

![image-20241017093019735](2-ç½‘ç»œæ¶æ„.assets/image-20241017093019735.png)



ç»§ç»­

![image-20241017093049629](2-ç½‘ç»œæ¶æ„.assets/image-20241017093049629.png)



![image-20241017093104467](2-ç½‘ç»œæ¶æ„.assets/image-20241017093104467.png)





![image-20241017094209487](2-ç½‘ç»œæ¶æ„.assets/image-20241017094209487.png)



https://blog.csdn.net/cnm_King/article/details/136546478

![image-20241017094244210](2-ç½‘ç»œæ¶æ„.assets/image-20241017094244210.png)



yum updateå§

ä¸è¡Œå†è¯•è¯•è¿™ä¸ª

https://rockylinux.pkgs.org/9/rockylinux-crb-x86_64/sendmail-milter-devel-8.16.1-11.el9.x86_64.rpm.html



update ç£ç›˜çˆ†äº†ï¼ŒæŒ‚äº†ã€‚ã€‚é‡æ–°å¼„







===

<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241018114539905.png" alt="image-20241018114539905" style="zoom:50%;" />





<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241018114805505.png" alt="image-20241018114805505" style="zoom:40%;" />







<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241018115833068.png" alt="image-20241018115833068" style="zoom:43%;" />







<img src="2-ç½‘ç»œæ¶æ„.assets/image-20241018120034841.png" alt="image-20241018120034841" style="zoom:33%;" />



ç®—äº†ï¼Œæ•™ç¨‹éƒ½å¤ªè€äº†ï¼Œè¿˜ç”¨ç”¨å®˜æ–¹çš„squidclamavè¿™ä¸ªç»„ä»¶å§ï¼Œè¿™ä¸‹å°±4ä¸ªè½¯ä»¶é…åˆã€‚ã€‚ã€‚

































# å¦‚ä½•ç†è§£salt ç›

ä¸åºŸè¯ï¼Œshow u the picture

![image-20241010173347460](2-ç½‘ç»œæ¶æ„.assets/image-20241010173347460.png)

æ€ä¹ˆæ ·ï¼Œopensslå’Œmkpasswdä¸¤ä¸ªcliå·¥å…·éƒ½å¯ä»¥çŸ¥é“å“ˆå¸Œç®—æ³•å’Œsaltçš„æƒ…å†µä¸‹ï¼Œé’ˆå¯¹æºæ•°æ®cisco12345ï¼Œç”Ÿæˆä¸€æ ·çš„å“ˆå¸Œå€¼ã€‚

mkpasswd çš„-Sæ˜¯salteï¼Œ-sæ˜¯stdinï¼Œä¹Ÿå°±æ˜¯å¯†ç ä¹Ÿå°±æ˜¯æºæ•°æ®è¢«åŠ å¯†çš„æ•°æ®

openssl æ²¡æœ‰-sæ¥åšstdinï¼Œä½†æ˜¯å¯ä»¥åˆ©ç”¨xargsç›´æ¥ä¸€è¡Œæå®šã€‚å¤§ä¸äº†æ˜æ–‡å˜›~~å“ˆå“ˆï¼Œå°±æ˜¯å±•ç¤ºç”¨çš„ã€‚





