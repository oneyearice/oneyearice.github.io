# 3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®



# haproxyçš„å¥åº·æ£€æŸ¥

å¦‚æœä¸åšå¥åº·æ£€æŸ¥ï¼Œè°ƒåº¦è¿˜æ˜¯ä¼šå¾€downæ‰çš„åç«¯è°ƒåº¦

![image-20240812093609770](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812093609770.png)

502 ç½‘å…³ä¸èƒ½è®¿é—®

504è¶…æ—¶

503æœåŠ¡æŒ‚äº†



```bash
backend web_servers
    server web1 192.168.126.133:80 check
    server web2 192.168.126.134:80 check
```



<img src="3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812094710397.png" alt="image-20240812094710397" style="zoom:50%;" /> 

é‡æ–°åŠ è½½é…ç½®ï¼Œæ­¤æ—¶å°±ä¼šè°ƒåº¦åˆ°downæ‰çš„åç«¯serverä¸Šäº†

![image-20240812094736102](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812094736102.png)



äºæ­¤åŒæ—¶ï¼Œæˆ‘æ‰“å¼€äº†æ‰€æœ‰åç«¯çš„checkï¼Œæ‰€ä»¥é¡µé¢ä¸Šå¯ä»¥çœ‹åˆ°ä¸€äº›æ£€æŸ¥çŠ¶å†µ

![image-20240812094851647](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812094851647.png)



é€šè¿‡æ‰“å¼€åç«¯çš„å¯¹åº”æœåŠ¡ï¼Œå°±å¯ä»¥ä¿®å¤å•¦

![image-20240812095009605](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812095009605.png)



ä¸è¿‡ç”±äºè¿™äº›éƒ½æ˜¯4å±‚æ£€æŸ¥ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å°±è¢«æ¬ºéª—

<img src="3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812095650760.png" alt="image-20240812095650760" style="zoom:50%;" />

æ¯”å¦‚å…³é—­nginxæœåŠ¡ï¼Œç”¨nc -l 80æ‰“å¼€ç›‘å¬80ï¼Œæ­¤æ—¶haproxyçš„å¥åº·æ£€æŸ¥ä¾ç„¶åˆ¤æ–­ä¸ºæ­£å¸¸çŠ¶æ€ã€‚



## é»˜è®¤checkçš„å‘¨æœŸæ˜¯

![image-20240812100507897](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812100507897.png)

é»˜è®¤æ£€æŸ¥å‘¨æœŸæ˜¯2sä¸€æ¬¡

![image-20240812100912999](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812100912999.png)



```bash
backend web_servers
    server web1 192.168.126.133:80 check inter 5000
    server web2 192.168.126.134:80 check inter 5000

```

![image-20240812101132428](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812101132428.png)



```bash
backend web_servers
    server web1 192.168.126.133:80 check inter 5000 fail 5 rise 5
    server web2 192.168.126.134:80 check inter 5000 fail 5 rise 5
# è¿™TMå°±è¦25sæ‰èƒ½åˆ¤å®šå‡ºæ¥æ•…éšœï¼Œå°±ç°å¸¸ä¸å¥½çš„å‚æ•°é…ç½®äº†
# rise 5 æ¬¡ inter 5000msï¼Œä¹Ÿå°±æ˜¯ 25sæ‰åˆ¤å®šèµ·ç«‹ï¼Œè¿™ä¹Ÿä¸å¥½ï¼Œä¼˜åŒ–ä¸º
backend web_servers
    server web1 192.168.126.133:80 check inter 1000 fail 2 rise 10
    server web2 192.168.126.134:80 check inter 1000 fail 2 rise 10
#1ç§’ä¸€æ¬¡æ£€æŸ¥
#2ç§’é’Ÿæ•…éšœå¯åˆ‡æ¢åˆ°å¥½çš„æœåŠ¡
#10æ¬¡æ£€æŸ¥okæ‰åˆ¤å®šæ•…éšœæœåŠ¡èŠ‚ç‚¹æ¢å¤äº†ï¼Œè¿™ä¸ªè¦èŠ±20säº†ã€‚
```

### åŠ ä¸Šæƒé‡

```bash
backend web_servers
    server web1 192.168.126.133:80 check inter 1000 fall 2 rise 10 weight 3
    server web2 192.168.126.134:80 check inter 1000 fall 2 rise 10

```

![image-20240812105303317](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812105303317.png)

é¡µé¢ä¸Šæ˜¾ç¤ºï¼Œ3:1çš„æƒé‡æ˜¾ç¤ºæ•ˆæœå¦‚ä¸‹ğŸ‘‡

<img src="3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812105558898.png" alt="image-20240812105558898" style="zoom:50%;" />





### backupå¤‡ç”¨

å°±æ˜¯æ‰€æœ‰åç«¯serveréƒ½æŒ‚äº†ï¼Œå°±è®©backupæ ‡è¯†çš„æœºå™¨ä¸Šçº¿



è¿™é‡Œå°±è®©haproxyè‡ªå·±ä½œä¸ºä¸€ä¸ªbackupå¤‡ç”¨nginxæœåŠ¡ï¼Œä»¥å¤‡ä¸æµ‹

æ³¨æ„ï¼šç”±äºhaproxyå ç”¨äº†80ï¼Œæ‰€ä»¥è‡ªå·±åšbackupç«™ç‚¹çš„nginxæœåŠ¡å°±æ”¹æˆ8080å¥½äº†ã€‚



è¿™ä¸ªbackupçš„ä½¿ç”¨åœºæ™¯æ˜¯å•¥å‘¢ï¼Œå¯ä»¥æ˜¯é“æ­‰æœåŠ¡å™¨ï¼Œå°±æ˜¯æ­£å¸¸ä¸šåŠ¡éƒ½æŒ‚äº†ï¼Œè¿™ä¸ªé¡µé¢å°±å†™ä¸Šsorry xxxx

```bash
backend web_servers
    server web1 192.168.126.133:80 check inter 1000 fall 2 rise 10 weight 3
    server web2 192.168.126.134:80 check inter 1000 fall 2 rise 10
    server web_backup 127.0.0.1:8080 check backup
```

æµ‹è¯•ï¼Œå½“åç«¯serveréƒ½æŒ‚äº†åï¼Œsorry server(ä¹Ÿå°±æ˜¯backup server)å°±å‡ºæ¥å•¦

![image-20240812111059082](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812111059082.png)



### disableç¦ç”¨åç«¯æœåŠ¡

```bash
backend web_servers
    server web1 192.168.126.133:80 check inter 1000 fall 2 rise 10
    server web2 192.168.126.134:80 check inter 1000 fall 2 rise 10 disabled
    server web_backup 127.0.0.1:8080 check
```

![image-20240812112657320](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812112657320.png)

è¿™æ ·ç¬¬äºŒå°åç«¯èŠ‚ç‚¹å°±ä¸ä¼šè¢«è°ƒåº¦äº†



## maxconnå¹¶å‘çš„æ•°å€¼

### å…¨å±€æ•°å€¼

![image-20240812113418333](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812113418333.png)

<img src="3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812113441177.png" alt="image-20240812113441177" style="zoom:50%;" />

åªæ‰¾åˆ°ä¸€ä¸ª10000å¹¶å‘çš„ï¼Œçœ‹æ¥è¿™æ˜¯é’ˆå¯¹çš„frontendå‰ç«¯çš„è®¾ç½®ã€‚åç«¯çš„1000æ²¡æ‰¾åˆ°ï¼Œä¼°è®¡æ˜¯é»˜è®¤å€¼ï¼Œæ˜¯å‰ç«¯â—10çš„å…³ç³»ã€‚



æ³¨é‡Šæ‰åï¼Œå°±çœ‹åˆ°é»˜è®¤å€¼äº†æ˜¯ä¸€ä¸ªå¥‡æ€ªçš„49973ï¼Œç„¶ååç«¯å¹¶å‘è‡ªåŠ¨å˜åŒ–4998ï¼Œå¥½åƒæ˜¯10:1çš„å…³ç³»ã€‚

![image-20240812113758435](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812113758435.png)





![image-20240812113654771](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812113654771.png)

### å•å°æ•°å€¼



![image-20240812114423804](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812114423804.png)



![image-20240812114443550](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812114443550.png)



## é‡å®šå‘redir



```bash
backend web_servers
    server web1 192.168.126.133:80 check inter 1000 fall 2 rise 10
    server web2 192.168.126.134:80 check inter 1000 fall 2 rise 10 maxconn 20000 redir http://www.bing.com
    server web_backup 127.0.0.1:8080 check

```



å½“è°ƒåº¦åˆ°ç¬¬äºŒå°çš„æ—¶å€™å°±ä¼šredirect bing.comäº†

![image-20240812115816885](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812115816885.png)



ä¸Šé¢æ˜¯å•ä¸ªçš„ï¼Œä¸‹é¢å…¨å±€çš„

```bash
backend web_servers
    redirect prefix http://www.bing.com
    server web1 192.168.126.133:80 check inter 1000 fall 2 rise 10
    server web2 192.168.126.134:80 check inter 1000 fall 2 rise 10 maxconn 20000
    server web_backup 127.0.0.1:8080 check

```

![image-20240812133224070](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812133224070.png)

è¿™æ ·å…¨éƒ¨åç«¯èŠ‚ç‚¹éƒ½è¢«é‡å®šå‘äº†ã€‚



httpsä¹Ÿæ˜¯å¯ä»¥çš„

![image-20240812133554626](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812133554626.png)





## ç½‘ç«™é…ç½®æ”¾åˆ°å­æ–‡ä»¶é‡Œå»

ä¸€ä¸ªç»´æŠ¤æ€è·¯ï¼Œå°±æ˜¯ ä¸»é…ç½®æ–‡ä»¶æ”¾ä¸€äº›å…¨å±€çš„é…ç½®å°±è¡Œäº†ï¼›ç«™ç‚¹é…ç½®æ”¾åˆ°ç‹¬ç«‹çš„å­é…ç½®æ–‡ä»¶ï¼Œä¸€ä¸ªç«™ç‚¹æ”¾ä¸€ä¸ªã€‚

![image-20240812135201873](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812135201873.png)



ç„¶åä¸»é…ç½®æ–‡ä»¶é‡Œåˆ æ‰frontendã€backendã€listençš„ç«™ç‚¹ï¼Œå½“ç„¶é™¤äº†åˆå§‹çš„listen statså¯ä»¥ç•™ç€ã€‚

![image-20240812135706132](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812135706132.png)



![image-20240812135729039](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812135729039.png)

ç„¶åè¦è®©haproxyè¯†åˆ«åˆ°è‡ªå·±å®šä¹‰çš„conf.dè¿™ä¸ªå­é…ç½®æ–‡ä»¶å¤¹ï¼ŒCLIé‡Œæœ‰ç±»ä¼¼çš„æ–¹æ³•ğŸ‘‡

![image-20240812135923751](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812135923751.png)

ä¸è¿‡æˆ‘å¸Œæœ›èƒ½æœ‰åƒnginxé‚£æ ·çš„include xxx/xx/xx/å°±å¥½äº†ã€‚

è¿˜æ˜¯æŒ‰haproxyè‡ªå¸¦çš„æ¥å§ï¼Œåœ¨serviceæ–‡ä»¶é‡ŒåŠ ä¸Š-f /etc/haproxy/conf.d/è¿™ä¸ªæ–‡ä»¶å¤¹è·¯å¾„

![image-20240812160139968](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812160139968.png)

ç„¶å

[root@realserver2 conf.d]# systemctl daemon-reload
[root@realserver2 conf.d]# systemctl restart haproxy



### å…³äºé…ç½®æ–‡ä»¶åç¼€åªèƒ½ç”¨cfg

![image-20240812162919878](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812162919878.png)

è§‚å¯ŸçŠ¶æ€é¡µå‘ç°msyqlå‰åç«¯æ²¡äº†

![image-20240812162941007](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812162941007.png)

æ”¹å›å»å°±æ¢å¤äº†

![image-20240812163043406](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812163043406.png)



![image-20240812163056530](3.Haproxyä»£ç†çš„å¥åº·æ€§æ£€æŸ¥å’Œå­é…ç½®ç­‰åŸºç¡€é…ç½®.assets/image-20240812163056530.png)









