# 7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.md



ACLæ‰æ˜¯HAproxyç›¸å¯¹äºnginxçš„ä¼˜åŠ¿

# ACL

![image-20241205140822420](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205140822420.png)

acl xxx xx xxx xxx #  è¿™äº›å­—æ®µä¸ä¸€å®šéƒ½æœ‰

åŒ¹é…è§„èŒƒï¼šæ¯”å¦‚headé‡Œå¸¦ä»€ä¹ˆå†…å®¹ï¼Œurlå¸¦ä»€ä¹ˆå…³é”®å­—ï¼Œå°¾åŒ…å«ä»€ä¹ˆã€‚

åŒ¹é…æ¨¡å¼ï¼šæ¯”å¦‚ç®€å•çš„åŒºåˆ†å¤§å°å†™

å…·ä½“æ“ä½œç¬¦ï¼šç›¸ç­‰è¿˜æ˜¯ä¸ç­‰

valueï¼šå…·ä½“çš„å€¼

![image-20241205140822421](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205140822421.png)

image_serviceå°±æ˜¯aclçš„name

hdr_domæ˜¯haproxyé‡Œçš„å›ºå®šç”¨æ³•ï¼Œæ˜¯ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œhdr_dom(host)å°±æ˜¯ä¸»æœºå¤´é‡Œhostå­—æ®µé‡Œ  åŒ…å« åé¢çš„value--mg.wang.comçš„æ„æ€ 

-i   å¿½ç•¥å¤§å°å†™



=============================

hostå­—æ®µæ˜¯åœ¨Request Headerså—é‡Œçš„ï¼Œç„¶åæ–°ç‰ˆHTTP/2 /3ä¸å«hostè€Œæ˜¯authorityå­—æ®µã€‚

![image-20241205142450879](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205142450879.png)



![image-20241205142532302](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205142532302.png)



============================



### hdrï¼šæŠ“å–headå¤´é‡Œçš„ä¸œè¥¿

![image-20241205141422393](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205141422393.png)

begå¼€å¤´endç»“å°¾diræ˜¯uriï¼Œrgeæ˜¯æ­£åˆ™ï¼Œsubæ˜¯åŒ…å«å­—ç¬¦ä¸²



<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205143636936.png" alt="image-20241205143636936" style="zoom:50%;" /> 

ğŸ‘‡ hdr_sub(User-Agent) -i curl wget è§£é‡Šï¼›hdr_subå°±çœ‹æ˜¯å¦åŒ…å«å­—ç¬¦ä¸²ï¼Œçœ‹User-Agentå­—æ®µé‡Œçš„æ˜¯å¦æœ‰curl **æˆ–**wget ä¸”ä¸åŒºåˆ†å¤§å°å†™ã€‚

å¦‚æœä½ ç”¨curlå’Œwgetè¯·æ±‚çš„å°±denyæ‰ğŸ‘‡

![image-20241205141627459](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205141627459.png)

ğŸ‘†é¢çš„å‡ ä¸ªéƒ½ä¸€ä¸ªæ„æ€éƒ½æ˜¯www.å¼€å¤´



ä¸Šå›¾çš„hdr_dom(host) å’Œ hdr(host) å¥½åƒæ²¡å•¥åŒºåˆ«å•Šï¼Œéƒ½æ˜¯hdr(headrå—é‡Œçš„)hostå­—æ®µå•Šï¼Œå‰ç½®æ˜¯åŸŸåï¼Œåè€…æ²¡è¯´åŸŸååˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œéƒ½æ˜¯beg æˆ– end xxxä¸ä¸€æ ·ç”¨å•Š

ç„¶å-må†™ä¸å†™éƒ½éƒ½ä¸€æ ·ï¼Œ-må°±æ˜¯-iç±»ä¼¼çš„ï¼Œ-iæ˜¯å¿½ç•¥å¤§å°å†™ï¼Œä¸å†™-må°±æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œå¦‚æœç”¨beg endè¿™ç§å°±éœ€è¦ç”¨-mæ¥é…åˆã€‚



### æŠ“å–éƒ¨åˆ†urlé‡Œçš„ä¸œè¥¿ï¼šbaseçš„ç”¨æ³•

![image-20241205145909128](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205145909128.png)

ğŸ‘†ğŸ‘‡è¿™å·®ä¸å¤šæ˜¯urlåŒ¹é…å°±æ˜¯nginxæ²¡æ³•å®ç°çš„

### æŠ“å–éƒ¨åˆ†urlé‡Œçš„ä¸œè¥¿ï¼špathçš„ç”¨æ³•

![image-20241205150458775](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205150458775.png)

ğŸ‘‡å»æ‰ä¸‹å›¾çš„xx/å°±èƒ½å¤Ÿæ»¡è¶³å‰é¢çš„åŒ¹é…äº†

![image-20241205151335469](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205151335469.png)

ğŸ‘†regå°±æ˜¯regexæ­£åˆ™

path_subæ˜¯å­ä¸²ï¼Œæ‰€è°“å­ä¸²å°±æ˜¯åªè¦åŒ…å«å°±åŒ¹é…åˆ°äº†ã€‚

path_dir jpegså°±æ˜¯å¿…é¡»æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶å¤¹ï¼Œæ¯”å¦‚www.ming.org/xxx/jpegs/xxx   xxxæœ‰æ²¡æœ‰éƒ½å¯ä»¥å’¯ã€‚



### æŠ“å–æ•´ä¸ªurlé‡Œçš„ä¸œè¥¿ï¼šurlçš„ç”¨æ³•

![image-20241205151616332](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205151616332.png)



### æŠ“å–ï¼šæºç›®IPå’Œç«¯å£ã€çŠ¶æ€ç ã€ä»¥åŠmethodä¸ƒå±‚åè®®é‡Œçš„åŠ¨ä½œ(GET/POSTç­‰)ğŸ‚

<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205152403346.png" alt="image-20241205152403346" style="zoom:50%;" /> 



## åŒ¹é…æ¨¡å¼



![image-20241205153003957](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153003957.png)

-uå°±æ˜¯aclä¸èƒ½åŒåï¼Œè¿™ç§å†™æ³•å°±ä¸è¡Œäº†

<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153042174.png" alt="image-20241205153042174" style="zoom:50%;" />

æœ¬æ¥å¤šä¸ªaclåŒåå°±æ˜¯å¹¶é›†ä¹Ÿå°±æ˜¯æˆ–çš„å…³ç³»ï¼Œsquidé‡Œå°±æ˜¯è¿™ä¹ˆç”¨çš„ã€‚



## æ“ä½œç¬¦



![image-20241205153230045](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153230045.png)





## valueå€¼



![image-20241205153303938](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153303938.png)



## aclç»„åˆ



![image-20241205153429093](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153429093.png)





# å®éªŒ-åŸºäºè®¿é—®åŸŸåæä¾›è°ƒåº¦



å‡è®¾ ä¸€ä¸ªç½‘ç«™æä¾›æ‰‹æœºç«¯è®¿é—®ï¼Œä¸€ä¸ªç½‘ç«™æä¾›ç”µè„‘ç«¯è®¿é—®



### æ¡ˆä¾‹01ï¼š

rocklinux9.3 å› å‡çº§opensslå¯¼è‡´sshèµ·ä¸æ¥çš„å¤„ç†è®°å½•

1ã€å…ˆç”¨telnetèµ·æ¥

```bash
dnf install telnet -y
dnf install telnet-server -y

systemctl start telnet.socket

ss -tlnup # æ£€æŸ¥23ç«¯å£èµ·æ¥äº†
```



2ã€æ”¹ç”¨telnetç™»å…¥ï¼Œå¸è½½opensshé‡æ–°å®‰è£…

```bash
dnf remove openssh-server openssh-clients openssh -y
dnf install openssh-server openssh-clients openssh -y
systemctl start sshd
systemctl status sshd
```





ç»§ç»­haproxyå®éªŒ



1ã€haproxyçš„é…ç½®ï¼Œç¼–è¯‘å®‰è£…å’Œå¸¦å­é…ç½®æ–‡ä»¶å¤¹å¯åŠ¨(å‚è§å‰æ–‡)

```bash
[root@server ~]# cat /etc/haproxy/conf.d/site.cfg
frontend www.ming.com
    bind 192.168.126.137:80
    acl pc_domain hdr_dom(host) -i www.ming.com
    acl mobile_domain hdr_dom(host) -i mobile.ming.com
    use_backend www_servers if pc_domain
    use_backend mobile_servers if mobile_domain
    #default_backend mobile_domain  # è¿™æ˜¯é»˜è®¤çš„è½¬å‘è§„åˆ™

backend mobile_servers
    server web1 192.168.126.135:80 check inter 1000 fall 2 rise 10
    
backend www_servers
    server web2 192.168.126.136:80 check inter 1000 fall 2 rise 10
```

2ã€åé¢ä¸¤ä¸ªæˆå‘˜çš„é…ç½®å¾ˆç®€å•ï¼Œå°±ç”¨nginx

```bash
web1
cat /usr/share/nginx/html/index.html
this is 135-mobile


web2
cat /usr/share/nginx/html/index.html
this is 136-pc


clientä¸Šç®€å•é…ç½®ä¸€ä¸ªhostsåšè§£æ
192.168.126.137 www.ming.com mobile.ming.com
```

3ã€æ£€æŸ¥æ•ˆæœ

<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211104623518.png" alt="image-20241211104623518" style="zoom:45%;" /> 



## å®éªŒ2-åŸºäºip

```bash
[root@server ~]# cat /etc/haproxy/conf.d/site.cfg
frontend www.ming.com
    bind 192.168.126.137:80
    acl lan1 src 192.168.126.1
    acl lan2 src 192.168.126.137
    use_backend www_servers if lan1
    use_backend mobile_servers if lan2

backend mobile_servers
    server web1 192.168.126.135:80 check inter 1000 fall 2 rise 10

backend www_servers
    server web2 192.168.126.136:80 check inter 1000 fall 2 rise 10
[root@server ~]#
[root@server ~]# systemctl reload haproxy

```

cmdæ˜¯192.168.126.1   å³è¾¹æ˜¯192.168.127.137

<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211105246025.png" alt="image-20241211105246025" style="zoom:50%;" /> <img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211105334058.png" alt="image-20241211105334058" style="zoom:50%;" />



### å®éªŒ3-æ‹’ç»

![image-20241211110157958](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211110157958.png)



### å®éªŒ4-åŠ¨é™åˆ†ç¦»

![image-20241211110549047](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211110549047.png)



# é¢„å®šä¹‰ä¹Ÿå«å†…ç½®acl

https://cbonte.github.io/haproxy-dconv/2.1/configuration.html#7.4



![image-20241211111053148](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211111053148.png)



### å†…ç½®aclï¼šç¦ç”¨traceæ–¹æ³•

è¿™ç§aclç›´æ¥ç”¨ï¼Œä¸ç”¨è‡ªå®šä¹‰æŠ“å“ªäº›æµé‡ 

![image-20241211111807294](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211111807294.png)

ä¸Šå›¾405æ˜¯å·²ç»ç©¿è¿‡haproxyåˆ°è¾¾äº†åç«¯çš„nginxäº†ï¼Œ405æ˜¯nginxä¸æ”¯æŒçš„åé¦ˆã€‚è€Œadministrativeæ˜¯haproxyæ‹’ç»äº†çš„ã€‚





### ç¦ç”¨abã€curlã€wget

![image-20241211112954502](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211112954502.png)



![image-20241211113451160](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211113451160.png)





## erroræŠ¥é”™æ–‡ä»¶



![image-20241211115456005](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211115456005.png)

![image-20241211115509936](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211115509936.png)



è¿™ä¸ªæŠ¥é”™é¡µé¢éœ€è¦å®Œå–„

é€šè¿‡curl -vå¯è§è¦è¡¥å……çš„éƒ¨åˆ†

![image-20241211115719564](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211115719564.png)

```bash
[root@server ~]# cat /etc/haproxy/errorfiles/403forbid.http
HTTP/1.1 403 Forbidden
content-length: 93
cache-control: no-cache
content-type: text/html

<html><body><h1>403 Forbidden</h1>
Request forbidden by administrative rules.
</body></html>

```



![image-20241211134259964](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211134259964.png)



ä¸ºä»€ä¹ˆhaproxyçš„è¿™ä¸ªerroré¡µé¢å¿…é¡»åŠ ä¸Šå“åº”åŒ…çš„å¤´å‘¢ï¼Œå› ä¸ºhaproxyä¸åƒnginxä¸€æ ·æ˜¯ä¸€ä¸ªwebæœåŠ¡å™¨ï¼Œå¿…é¡»æ‰‹åŠ¨è¡¥ä¸Šã€‚





<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211135341164.png" alt="image-20241211135341164" style="zoom:50%;" />



### å››å±‚aclæ§åˆ¶

<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211140731287.png" alt="image-20241211140731287" style="zoom:50%;" />



## haproxyåšsslè¯ä¹¦å¸è½½-è´Ÿæ‹…é‡ä¸€ç‚¹çš„ä¼š

<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211142243761.png" alt="image-20241211142243761" style="zoom:50%;" />



 ä¹Ÿå¯ä»¥haproxyå¸è½½sslï¼Œç„¶åhttp 80 åˆ°åç«¯

```bash
# é…ç½®HAProxyæ”¯æŒHttpsåè®®ï¼Œæ”¯æŒsslä¼šè¯
bind *:443 ssl crt /PATH/TO/SOME_PEM_FILE


# æŠŠ80ç«¯å£çš„è¯·æ±‚åˆ©ç”¨302é‡å®šå‘443
bind *:80
redirect scheme https if !{ ssl_fc }

# å‘åç«¯ä¼ é€’ç”¨æˆ·è¯·æ±‚çš„åè®®å’Œç«¯å£(frontendæˆ–backend)
http_request set-header X-Forwarded-Port %[dst_port]
http_request add-header X-Forwarded-Proto https if { ssl_fc }


# æŒ‡ä»¤crtåè¯ä¹¦æ–‡ä»¶ä¸ºPEMæ ¼å¼ï¼Œéœ€è¦åŒæ—¶åŒ…å«è¯ä¹¦å’Œæ‰€æœ‰ç§é’¥
cat demo.key demo.crt > demo.pem

```



è¯ä¹¦åˆ¶ä½œ

```bash
æ–¹æ³•

mkdir /etc/haproxy/certs/
cd /etc/haproxy/certs/
openssl genrsa -out haproxy.key 2048
openssl req -new -x509 -key haproxy.key -out haproxy.crt -subj "/CN=www.ming.com" -days 365
# æˆ–è€…ç”¨ä¸‹ä¸€æ¡å‘½ä»¤å®ç°ä¸Šé¢2æ¡å‘½ä»¤
openssl req -x509 -newkey rsa:2048 -subj "/CN=www.ming.com" -keyout haproxy.key -nodes -days 365 -out haproxy.crt

cat haproxy.key haproxy.crt > haproxy.pem  # åˆäºŒä¸ºä¸€
chmod 600 haproxy.pem  # å› ä¸ºåŒ…å«ç§é’¥äº†ï¼Œæ‰€ä»¥æ”¹æˆ600å®‰å…¨äº›
openssl x509 -in haproxy.pem -noout -text

æ–¹æ³•2
mkdir /etc/haproxy/certs/
cd /etc/pki/tls/certs
make /etc/haproxy/certs/haproxy.pem
umask 77 ; \
PEM1=`/bin/mktemp /tmp/openssl.XXXXX` ; \
PEM2=`/bin/mktemp /tmp/openssl.XXXXX` ; \
/usr/bin/openssl req -utf8 -newkey rsa:2048 -keyout $PEM1 -nodes -x509 -days 365 -out $PEM2 ; \
cat $PEM1 > /etc/haproxy/certs/haproxy.pem ; \
echo "" >> /etc/haproxy/certs/haproxy.pem ; \
cat $PEM2 >> /etc/haproxy/certs/haproxy.pem ; \
rm -f $PEM1 $PEM2

```





![image-20241211145542308](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211145542308.png)



![image-20241211145514868](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211145514868.png)



![image-20241211150941142](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211150941142.png)

æ­¤æ—¶httpså°±å¥½äº†

å†åŠ ä¸ªè·³è½¬

![image-20241211151514302](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211151514302.png)





![image-20241211153614181](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241211153614181.png)













