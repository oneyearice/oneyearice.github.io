# 5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ



# åŠ¨æ€ç®—æ³•

### roundbinç®—æ³•

é»˜è®¤çš„è°ƒåº¦ç®—æ³•

![image-20240827094218090](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827094218090.png)



### leastconnç®—æ³•

ç±»ä¼¼LVSçš„WLCç®—æ³•

![image-20240827094248190](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827094248190.png)



### randomç®—æ³•

![image-20240827095410216](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827095410216.png)



# å…¶ä»–ç®—æ³•ï¼š



# sourceç®—æ³•

![image-20240827095615478](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827095615478.png)

### source : map-baseå–æ¨¡æ³•

è¿™æ˜¯sourceä¸‹çš„é»˜è®¤çš„ç®—æ³•(ä¹Ÿå°±æ˜¯é…ç½®äº†balance sourceï¼Œhash-typeä¸é…ç½®ä¹Ÿæ˜¯map-basedäº†)ï¼Œåè€Œä¸å¥½



![image-20240827100125151](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827100125151.png)

ä¸èƒ½ä¿®æ”¹æƒé‡çš„ï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡socktä¿®æ”¹ğŸ‘†ï¼Œè€Œä¸‹é¢çš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³• æ˜¯åŠ¨æ€çš„ï¼Œå°±å¯ä»¥ä¿®æ”¹weightå€¼ã€‚

![image-20240827100603167](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827100603167.png)

å›¾ä¸­Aå°±æ˜¯æºIPåœ°å€ğŸ‘†



â€‹		ä½†æ˜¯éšç€åç«¯æœåŠ¡å™¨çš„å¢å‡ï¼Œæƒé‡å°±ä¼šå¢å‡ï¼Œä¼šå¯¼è‡´map-baseå–æ¨¡çš„ç»“æœå°±ä¸ä¸€æ ·äº†ï¼Œæ¯”å¦‚ ä¸Šå›¾ ä¸¤å°åç«¯æœåŠ¡çš„æƒé‡æ˜¯1å’Œ2ï¼Œå½“å‰è°ƒåº¦æ˜¯hash(SRC_IP) å¯¹3  å–æ¨¡ï¼Œä¹Ÿå°±æ˜¯0 1 2 ä¸‰ä¸ªç»“æœï¼Œ0å°±è°ƒåº¦åˆ°åç«¯æœåŠ¡å™¨1ï¼Œ1 2 å°±è°ƒåº¦åˆ°åç«¯æœåŠ¡å™¨2ä¸Šå»ï¼Œå¦‚æœæ–°å¢ä¸€å°æœåŠ¡å™¨ä¸”æƒé‡æ˜¯2ï¼Œé‚£ä¹ˆå°±æ˜¯å¯¹5å–æ¨¡ï¼Œç»“æœå°±æ˜¯ åŸæ¥hash(SRC_IP) å¯¹3 å–æ¨¡çš„ç»“æœæ¯”å¦‚æ˜¯0ï¼Œç°åœ¨å¯èƒ½ä¸å†æ˜¯0å¯èƒ½æ˜¯3 é‚£ä¹ˆå¯¹å…¶è°ƒåº¦å°±å˜äº†ï¼Œè€Œä¸”æ­¤æ—¶æ•´ä½“è°ƒåº¦éƒ½ä¼šå‘é€å˜åŒ–ï¼Œä¼šè¯ä¿æŒå°±ä¿æŒä¸ä½äº†ã€‚ 

â€‹		è¿™é‡Œå¯ä»¥è”ç³»nginxçš„ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è°ƒåº¦ï¼Œæ˜¯ä¸€å›äº‹ã€‚ä¸ç®¡æ˜¯åˆ†å¸ƒå¼ç«™ç‚¹çš„è°ƒåº¦ï¼Œè¿˜æ˜¯ç¼“å­˜ç©¿é€çš„é˜²æ­¢éƒ½æ˜¯ä¸€å›äº‹ï¼Œéƒ½æ˜¯ç”¨$request_uri consistentæ¥è§£å†³çš„ã€‚

![image-20240827104555260](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827104555260.png)







### source :  ä¸€è‡´æ€§å“ˆå¸Œ

![image-20240827112842808](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827112842808.png)



![image-20240827113225321](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827113225321.png)



![image-20240827113259029](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827113259029.png)



![image-20240827113432867](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827113432867.png)



è¿™æ˜¯åŠ¨æ€ç®—æ³•ï¼Œå°±å¯ä»¥é€šè¿‡socktä¿®æ”¹æƒé‡äº†ğŸ‘‡

![image-20240827120139150](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827120139150.png)



![image-20240827120155121](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827120155121.png)



### æµ‹è¯•source ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è°ƒåº¦

å¼€å§‹æºipä¸åŒï¼Œæ²¡æœ‰æµ‹å‡ºæ¥è¿˜

![image-20240827135621672](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827135621672.png)

å†æ¢åˆ«çš„IPæ¥æµ‹

![image-20240827135727754](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827135727754.png)

ç„¶åå°±å‡ºæ¥äº†ğŸ‘‡--ä¸åŒçš„IPä¸ä¸€å®šè°ƒåº¦åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä½†æ˜¯å¾ˆå¤šä¸åŒçš„IPä¸€å®šå¯ä»¥å¾—åˆ°æ•ˆæœï¼ŒæºIP ç»è¿‡hashåå†å¯¹ åç«¯æœåŠ¡å™¨çš„æƒé‡ä¹‹å å–æ¨¡ï¼Œç„¶åå†è°ƒåº¦ï¼Œå¤§æ¦‚è¦äº†è§£æˆè¿™æ ·å§ã€‚

![image-20240827135719489](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827135719489.png)





# uriç®—æ³•

åªæ”¯æŒHTTPåè®®ï¼Œä¸æ”¯æŒTCPï¼Œæƒ³æ¥ä¹Ÿæ˜¯uriå°±æ˜¯httpæŠ¥æ–‡é‡Œçš„å†…å®¹äº†ã€‚TCPåè®®é€šå¸¸å°±æ˜¯TCPå¤´éƒ¨å»æ‰çœ‹TCPçš„DATAè‡ªç„¶æ˜¯çœ‹ä¸åˆ°uriä¹Ÿå°±æ˜¯é“¾æ¥æ–‡ä»¶ç›®å½•çš„ã€‚

![image-20240827133657124](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827133657124.png)

åŒæ ·å¯¹äºuriä¸€æ ·æœ‰ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è°ƒåº¦ã€‚

å°±æ˜¯uriè®¿é—®çš„å›ºå®šï¼Œå°±ä¼šè°ƒåº¦åˆ°é‚£ä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå°±å’Œsource ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è°ƒèµ´ ä¸€æ ·å®ç°äº† ä¼šè¯ä¿æŒï¼Œæˆ–è€…å«ç¼“å­˜åˆ©ç”¨ï¼Œæˆ–è€…å«é˜²æ­¢ç¼“å­˜ç©¿é€ï¼Œæˆ–è€…å«åˆ†å¸ƒå¼ç«™ç‚¹çš„ä¼šè¯ä¿æŒã€‚

### uriå–æ¨¡ç®—æ³•é…ç½®

![image-20240827133828090](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827133828090.png)



### uriä¸€è‡´æ€§hashç®—æ³•é…ç½®

![image-20240827134416232](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827134416232.png)



### æµ‹è¯•uriä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è°ƒåº¦

![image-20240827140136709](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827140136709.png)



![image-20240827140231267](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827140231267.png)

![image-20240827140247385](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827140247385.png)

![image-20240827140304810](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827140304810.png)



![image-20240827140320434](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827140320434.png)

ç„¶åæ¢ä¸€ä¸ªuri å»curl

![image-20240827140631062](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827140631062.png)



![image-20240827140717545](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827140717545.png)



![image-20240827140733071](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827140733071.png)



![image-20240827140826123](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827140826123.png)



è¿™å°±å®ç°äº†ä¸åŒuriï¼Œè°ƒåº¦çš„æ•ˆæœï¼Œå½“ç„¶åŒsrcè°ƒåº¦ä¸€æ ·ï¼Œä¸åŒçš„uriä¸ä¸€å®šå°±è°ƒåº¦åˆ°ä¸åŒçš„åç«¯èŠ‚ç‚¹ï¼Œä½†æ˜¯å¤§é‡çš„ä¸åŒçš„uriä¸€å®šä¼šè°ƒåº¦å¼€æ¥çš„ã€‚åº•å±‚é€»è¾‘å°±æ˜¯ä¸ª2^32çš„ç¯ğŸ‘‡

<img src="5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827141004586.png" alt="image-20240827141004586" style="zoom:50%;" />





å†æµ‹è¯•ä¸‹

ä¸¤ä¸ªåç«¯èŠ‚ç‚¹åš10ä¸ªé¡µé¢å‡ºæ¥

![image-20240827141303744](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827141303744.png)

![image-20240827141731565](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827141731565.png)

è°ƒåº¦å°±æ˜¯åŸºäºuriçš„äº†ï¼Œ

![image-20240827141808856](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827141808856.png)



![image-20240827141841242](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827141841242.png)



å¤§å®¶éƒ½æ˜¯ä¸€æ ·ï¼Œåªæœ‰ç¬¬ä¸€ä¸ªuriè°ƒåº¦åˆ°134ä¸Šï¼Œå› ä¸ºéƒ½æ˜¯åŸºäºuriäº†ï¼Œä¸ç®¡ä»€ä¹ˆæºIPéƒ½ä¸€æ ·äº†ã€‚

![image-20240827141950068](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827141950068.png)

ä¹Ÿå¥‡æ€ªçš„ï¼Œä¸è¿‡éšæ„äº†

<font color=red>ä¸å¯¹ï¼Œuriè¦æ”¹æˆmode httpæ¥ç€ï¼Œæˆ‘æ²¡æ”¹ï¼</font>æ”¹ä¹‹

æ²¡å…³ç³»ï¼Œæˆ‘æœ‰defaultå°±æ˜¯mode httpï¼Œæ‰€ä»¥ä¸Šé¢å®éªŒæ²¡æœ‰ä½“ç°ï¼Œä½†æ˜¯å®é™…ä¹Ÿæ˜¯httpçš„ï¼Œåœ¨ä¸»é…ç½®æ–‡ä»¶é‡Œè®¾ç½®äº†

![image-20240827142638929](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827142638929.png)

æ­£å¥½å»æ‰è¿™ä¸ªmodeè§‚å¯Ÿä¸‹![image-20240827142820765](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827142820765.png)

æ­¤æ—¶è°ƒåº¦è™½ç„¶å†™çš„æ˜¯

![image-20240827142849483](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827142849483.png)

ä½†æ˜¯ç”±äºuriå¿…é¡»æ˜¯mode httpï¼Œæ‰€ä»¥ä¸ä¼šç”Ÿæ•ˆï¼Œå°±åˆå˜æˆäº†é»˜è®¤çš„roundbinç®—æ³•äº†ğŸ‘‡

![image-20240827142757430](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827142757430.png)



# url_paramç®—æ³•

![image-20240827144601130](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827144601130.png)

urié‡Œä¸€èˆ¬æ˜¯ä¸€ä¸ªxxx.phpåé¢è·Ÿä¸€ä¸ªé—®å¥½?key=valueå°±å¥½æ¯”sqlè¯­å¥é‡Œçš„where key=valueæŸ¥è¯¢ä¸€æ ·

åŒç†uriçš„ä¸œè¥¿è‚¯å®šæ˜¯è¦mode httpçš„

### url_paramå–æ¨¡ç®—æ³•é…ç½®

![image-20240827150857126](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827150857126.png)

è¿™ä¸ªuseridå°±æ˜¯urié‡Œçš„key=valueçš„é‚£ä¸ªkey

å¦‚æœkeyçš„å€¼ä¹Ÿå°±æ˜¯valueä¸€æ ·ï¼Œé‚£ä¹ˆè°ƒåº¦åˆ°åŒä¸€å°æœºå™¨ï¼Œå¦‚æœkeyçš„å€¼ä¸ä¸€æ ·ï¼Œé‚£ä¹ˆè°ƒåº¦åˆ°åˆ«çš„æœºå™¨--å½“ç„¶å¯èƒ½è¿˜æ˜¯åŒä¸€å°ï¼Œä½†æ˜¯keyçš„é‡èµ·æ¥å°±èƒ½åˆ†å¼€æ¥äº†ã€‚åº•å±‚è¿˜æ˜¯hash(value)å–æ¨¡æƒé‡ã€‚

### url_paramä¸€è‡´æ€§hashç®—æ³•é…ç½®

![image-20240827152459409](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827152459409.png)

ä¸Šå›¾useridå°±æ˜¯keyï¼Œä¸è¿‡å¯ä»¥æ˜¯å…¶ä»–çš„keyå’¯ï¼Œæ€»ä¹‹ä½ é¡µé¢é‡Œï¼Ÿé—®å· é—®çš„æ˜¯è°å°±å†™è°äº†ã€‚

å®éªŒè¦å†™phpå»æŸ¥DBï¼Œæ‰€ä»¥ä¸å¼„äº†ï¼Œå¤§æ¦‚æ„æ€å°±æ˜¯

![image-20240827153810675](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827153810675.png)



æµ‹ä¸€ä¸‹

![image-20240827153322507](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827153322507.png)

ä¸å¯¹ï¼Œmode httpæ²¡åŠ 

![image-20240827153407110](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827153407110.png)



å†æµ‹

![image-20240827153659558](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827153659558.png)



æ”¹å˜username=æµ‹è¯•æ•ˆæœï¼Œå¤šæ”¹å‡ æ¬¡å°±å‡ºæ•ˆæœäº†ï¼Œæ— éæ˜¯hashå’Œæƒé‡çš„é¬¼ğŸ‘‡å¯èƒ½ä¸åŒçš„uri_paramä¹Ÿè°ƒåº¦åˆ°ä¸€å°æœºå™¨çš„ã€‚

![image-20240827153859619](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827153859619.png)

ä¸è¿‡è¦å…·ä½“åšå‡º?username=xxxçš„sqlæŸ¥è¯¢æ•ˆæœï¼Œå°±è¦åšphpå’Œdbåº“äº†å§ï¼Œè¿™å°±ä¸æŠ˜è…¾äº†ã€‚





# hdrç®—æ³• 



å¤ä¹ ä¸‹headå¤´é‡Œçš„ä¸œè¥¿ï¼Œcurl å’Œ F12éƒ½å¯ä»¥çœ‹åˆ°

![image-20240827160314881](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827160314881.png)



<img src="5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827160357972.png" alt="image-20240827160357972" style="zoom:50%;" />





![image-20240827165926245](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827165926245.png)



### hdrå–æ¨¡ç®—æ³•é…ç½®å®ä¾‹

![image-20240827170005024](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827170005024.png)

balance hdr(è¿™é‡Œå°±å†™è¯·æ±‚å¤´ http headé‡Œçš„å­—æ®µå)ï¼Œæ¯”å¦‚user-agent(æµè§ˆå™¨ç±»å‹+ç‰ˆæœ¬ä¿¡æ¯)è¿™äº›ğŸ‘‡

<img src="5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827170333718.png" alt="image-20240827170333718" style="zoom:50%;" />



**æµ‹è¯•ä¸‹**ï¼Œå®éªŒéƒ½æ˜¯é…ç½®äº†hash-type consistentå“¦ï¼ŒåŒºåˆ«å°±æ˜¯å¼€å¯äº†ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è°ƒåº¦ï¼ŒåŒæ—¶ä¹Ÿæ”¯æŒè°ƒæ•´weightå€¼ã€‚å…¶å®å¦‚æœåç«¯æœåŠ¡å™¨ä»¥åŠå„è‡ªæƒé‡æ²¡æœ‰å˜åŒ–ï¼Œå¼€ä¸å¼€consistentæ²¡æœ‰åŒºåˆ«ï¼Œä½†æ˜¯ç”Ÿäº§ä¸­è‚¯å®šä¼šæœ‰æœºå™¨çš„å¢åŠ çš„ã€‚æ‰€ä»¥æ˜¯è¦å¼€çš„ã€‚

![image-20240827171101212](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827171101212.png)





![image-20240827171245465](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827171245465.png)



å‘ç°æµ‹ä¸å‡ºæ¥

![image-20240827171557261](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827171557261.png)

å¥½è¯´ï¼Œæ”¹æˆå¾ªç¯æµ‹

![image-20240827171614789](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827171614789.png)

å‡ºæ¥äº†å§ğŸ‘†å“ˆå“ˆï¼Œå‘ç°å…¶å®æ˜¯ä¸å‡è¡¡çš„ğŸ‘‡

![image-20240827171947069](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827171947069.png)

**è¿™ä¸ªå°±å¯ä»¥å®ç°æ‰‹æœºå’Œpcç”¨æˆ·åˆ†æµã€‚**







### hdrä¸€è‡´æ€§å“ˆå¸Œç®—æ³•è°ƒåº¦é…ç½®å®ä¾‹

![image-20240827173430471](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827173430471.png)





# rdp-cookieç®—æ³•

![image-20240827173543360](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827173543360.png)



### rdp-cookieå–æ¨¡ç®—æ³•é…ç½®å®ä¾‹

![image-20240827173559446](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827173559446.png)





### rdp-cookieä¸€è‡´æ€§hashç®—æ³•é…ç½®å®ä¾‹

![image-20240827173726771](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827173726771.png)





# ç®—æ³•æ€»ç»“



è®¾ç½®çš„æ—¶å€™10å’Œ10%çš„å†™æ³•éƒ½å¯ä»¥ï¼ŒåŒºåˆ«å°±æ˜¯10æ˜¯æ•°å€¼ï¼Œ10%æ˜¯initial 100çš„10%

![image-20240827182139917](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240827182139917.png)

é™æ€è¿˜æ˜¯åŠ¨æ€çš„æ„æ€å°±æ˜¯ æ˜¯å¦æ”¯æŒä¸Šé¢ğŸ‘†çš„æ–¹æ³•ï¼šsocaté€šè¿‡sockåŠ¨æ€çš„è®¾ç½®weightå€¼ä¸ºéä¸Šä¸‹çº¿çš„å€¼ã€‚

é™æ€ï¼šä»…å¯ä»¥è®¾ç½®0%å’Œ100%ã€‚

åŠ¨æ€ï¼šä»»ä½•å€¼ï¼Œå½“ç„¶æœ€å¤§256å’¯ã€‚



ç„¶åæ”¯æŒtcpçš„å¯ä»¥å°½å¯èƒ½é…ç½®æˆmode tcpï¼Œè¿™æ ·è½¬å‘æ•ˆç‡è‚¯å®šé«˜çš„

é™æ€ï¼š

static-rr    # tcp/http

first  		 # tcp/http



åŠ¨æ€ï¼š

roundrobin 	  # tcp/http

leastconn      	# tcp/http

random 			# tcp/http



ä»¥ä¸‹åŠ¨æ€è¿˜æ˜¯é™æ€å–å†³äºæ˜¯å¦åŠ ä¸Šconsistentå…³é”®å­—

source  		 # tcp/http

uri  				# http

url_param 	# http

hdr 				# http

rdp-cookie 	# tcp



**å„ç§ç®—æ³•çš„ä½¿ç”¨åœºæ™¯**

first  			# ä½¿ç”¨è¾ƒå°‘ï¼Œå…¸å‹çš„QoSæµé‡é˜Ÿåˆ—çš„é¥¿æ­»æœºåˆ¶



static-rr 	 # åšäº†sessionå…±äº«çš„é›†ç¾¤

roundronbin

random



leastconn  # æ•°æ®åº“

source  	# åŸºäºå®¢æˆ·ç«¯å…¬ç½‘IPçš„ä¼šè¯ä¿æŒ



uri     mode http 				# ç¼“å­˜æœåŠ¡å™¨ï¼ŒCDNæœåŠ¡å•†ï¼Œè…¾è®¯äº‘ï¼Œé˜¿é‡Œäº‘

url_param  mode http  	# å¯ä»¥å®ç°sessionä¿æŒ



hdr				# åŸºäºå®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡å¤´éƒ¨åšä¸‹ä¸€æ­¥å¤„ç†



rdp-cookie   # åŸºäºwindowsä¸»æœºï¼Œè¿˜ä¸é”™ï¼Œå°±æ˜¯è¯´3å°å ¡å’æœºï¼Œä¾›è¿œç¨‹ä½¿ç”¨ã€‚







ä»¥ä¸Šlvsä¸èƒ½å®ç°httpåè®®çš„è°ƒåº¦ç®—æ³•ï¼Œæ¯”å¦‚lvsä¸æ”¯æŒuri

nginxä¸æ”¯æŒurl_paramçš„ç®—æ³•ï¼Œå› ä¸ºï¼Œnginxçš„hash keyğŸ‘‡å–ä¸å‡ºæ¥urlé‡Œçš„?key=xxxï¼›é™¤éå†™ä»£ç æŠŠè¿™ä¸ªurlé‡Œçš„?key=xxxè½¬æ¢æˆå˜é‡ è¿™æ ·nginxå¯èƒ½å°±èƒ½è¯†åˆ«è¿›è¡Œè°ƒåº¦äº†ã€‚

![image-20240828093617423](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828093617423.png)



ç„¶åè¿˜æœ‰nginxçš„ip_hashä¹Ÿæ˜¯åªå–ipåœ°å€çš„å‰24ä½ï¼Œå’Œsourceä¸åŒï¼Œè¦å®ç°source ip è¦ç”¨nginxçš„hashæˆ–è€…haproxyçš„sourceã€‚

![image-20240828093931901](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828093931901.png)





# HAProxyçš„é«˜çº§åŠŸèƒ½



## åŸºäºcookieçš„ä¼šè¯ä¿æŒ



![image-20240828094131464](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828094131464.png)



ä¼šè¯ä¿æŒçš„æ–¹æ³•ï¼šâ‘ sessionç»‘å®šï¼›â‘¡é›†ç¾¤ä¹‹é—´sessionå¤åˆ¶ï¼›â‘¢sessionæœåŠ¡å™¨

![image-20240828095214856](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828095214856.png)



è¿™é‡Œæ˜¯cookieè¿˜æ˜¯ç”¨çš„sessonç»‘å®šæ€è·¯ï¼ŒåŒ…æ‹¬ä¸Šæ–‡çš„source ipä¹Ÿæ˜¯sessionç»‘å®šçš„æ€è·¯ï¼Œå°±æ˜¯åŒæ ·çš„ä¼šè¯éƒ½å¾€åŒä¸€ä¸ªæœåŠ¡å™¨è½¬å‘ï¼Œè¿™ä¸ªåŒæ ·çš„ä¼šè¯çš„åˆ¤å®šå°±æ˜¯â‘ source ipâ‘¡cookieã€‚





**é…ç½®é€‰é¡¹**

![image-20240828094241843](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828094241843.png)



cookieæœ¬è´¨å°±æ˜¯ä¸€ä¸ªé”®å€¼å¯¹key,valueï¼Œæ‰€ä»¥cookie WEBSRV insert nocache indirectçš„ WEBSRVå°±æ˜¯keyï¼Œè€Œè¿™ä¸ªkeyå¯¹åº”çš„valueï¼Œæ¯ä¸ªåç«¯æœåŠ¡å™¨éƒ½ä¸åŒ åœ¨æ¯è¡Œserver è¯­å¥é‡Œå®šä¹‰ï¼Œæ¯”å¦‚ğŸ‘‡çš„cookie we1 cookie web2 



**é…ç½®ç¤ºä¾‹**

![image-20240828094442374](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828094442374.png)

**cookieè°ƒåº¦çš„é€»è¾‘ğŸ‘‡**

![image-20240828100347171](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828100347171.png)

1ã€client--->haproxy---->web1ï¼›ä¸æ­¤åŒæ—¶haproxyæ‰“ä¸Šcookieï¼Œç„¶åé€šè¿‡set-cookieå­—æ®µï¼Œè¿”å›ç»™clientï¼Œclientæ”¶åˆ°set-cookieå…³é”®å­—ï¼Œå°±ä¼šæ‰“ä¸ŠæŠ¥æ–‡æºå¸¦çš„cookieä¿¡æ¯ä¹Ÿå°±æ˜¯key:valueï¼Œä¹Ÿå°±æ˜¯WEBSRV=web1ã€‚

2ã€ä¸‹æ¬¡clientå†æ¬¡è®¿é—®å°±ä¼šæºå¸¦cookieï¼Œhaproxyçœ‹åˆ°è¿™ä¸ªcookieå°±ä¼šè½¬å‘å¯¹åº”çš„serverã€‚



å‰é¢çš„ç« èŠ‚ä¹Ÿæœ‰å­¦è¿‡cookieï¼Œä¸è¿‡è¿™ä¸ªcookieæ˜¯serverè‡ªå·±ç»™ç”¨æˆ·å‘çš„ï¼Œæ˜¾ç„¶ä¸æ˜¯è¿™é‡Œçš„haproxyä»£ç†æ‰“çš„æ ‡ç­¾ã€‚ä½¿ç”¨åœºæ™¯ä¸ä¸€æ ·ã€‚

![image-20240828101309754](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828101309754.png)



**nocacheğŸ‘‡**

![image-20240828101713554](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828101713554.png)

1å’Œ2å°±æ˜¯ç”¨æˆ·ï¼ŒAå’ŒBæ˜¯æœåŠ¡å™¨ å‰é¢æ˜¯haproxy

CDNä¼šç¼“å­˜é¡µé¢ï¼ŒåŒ…æ‹¬cookieï¼›

äºæ˜¯cdnå‘è¿‡æ¥çš„è¯·æ±‚ç»Ÿç»Ÿéƒ½æ˜¯cookie(WEBSRV=web1)äº†ï¼Œä¹Ÿå°±ä¼šå¯¼è‡´1 å’Œ 2 å·²ç»è¯¥CDNå…¶å®å°±æ˜¯è¯¥ç¬¬åœ°åŒºæ¯”å¦‚ä¸€ä¸ªåŸå¸‚ä¸‹çš„æ‰€æœ‰å¯¹åº”ç«™ç‚¹è¯·æ±‚éƒ½è½¬å‘åˆ°åç«¯AæœåŠ¡å™¨å»äº†ã€‚

æ‰€ä»¥éœ€è¦nocacheã€‚



å“¦ï¼Œé“ç†æ˜¯è¿™ä¹ˆä¸ªé“ç†ï¼Œä½†æ˜¯æˆ‘çš„é—®é¢˜æ¥äº†ï¼Œhaproxyæ‰“çš„cookieä¸ºå•¥ä¸æ˜¯å‘ç»™1 å’Œ 2 ï¼Œç­‰ç­‰ï¼Œç„¶åç¡®å®æ˜¯å‘ç»™1 å’Œ 2ï¼Œåªæ˜¯CDNä¹Ÿèƒ½çœ‹åˆ°ä¹Ÿä¼šç¼“å­˜ï¼Œå¯¹å§ï¼Ÿå¥½åƒæ˜¯ã€‚





**å®éªŒåŠ æ·±ä¸‹ç†è§£**

![image-20240828105438023](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828105438023.png)



æ­¤æ—¶curl -Iv  å¯è§cookieå€¼äº†

![image-20240828103155483](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828103155483.png)





å¾ªç¯æµ‹ä¸€ä¸‹ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯sessionç»‘å®šä½äº†ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸ªclientéƒ½å‘å¾€åŒä¸€ä¸ªåç«¯äº†ã€‚

![image-20240828105522699](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828105522699.png)

æµ‹è¯•æ‰‹æ³•é—®é¢˜ï¼Œclientè¦æºå¸¦è¿™ä¸ªcookieæ‰èƒ½å‘½ä¸­çš„å•Šï¼Œä¸ç„¶clientéƒ½ä¸æºå¸¦ï¼Œè‡ªç„¶haproxyå°±ä¼šä¸æ–­åœ°set-cookieäº†ã€‚<img src="5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828105823987.png" alt="image-20240828105823987" style="zoom:50%;" /> è¯¥é€‰é¡¹è¦ç”Ÿæ•ˆï¼Œä½ clientå¾—æºå¸¦~

![image-20240828105624092](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828105624092.png)



curl æ¨¡æ‹Ÿä¿æŒ å’Œ æºå¸¦ cookieçš„æ–¹æ³•

```bash
curl -c cookie.txt 192.168.126.132

curl -b cookie.txt 192.168.126.132
```

è¿™æ˜¯ğŸ‘‡ç›´æ¥curl -b è‡ªå®šä¹‰ä¸ªcookieçš„æ–¹æ³•ï¼š

![image-20240828110316358](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828110316358.png)





**æºå¸¦cookieï¼Œhaproxyå°±ä¸ä¼šå†å‘é€set-cookieäº†**è¿™æ˜¯æºå¸¦çš„cookieï¼Œè€Œä¸æ˜¯haproxyå‘é€çš„set-cookie

![image-20240828111241018](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828111241018.png)



æµ‹è¯•æºå¸¦ä¸åŒçš„cookieï¼Œç»‘å®šåˆ°ä¸åŒçš„serverï¼Œè¿™å°±å®Œæˆäº†sessionç»‘å®š

![image-20240828111359053](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828111359053.png)

åŒæ ·æµ‹è¯•æ‰‹æ³•è¿˜å¯ä»¥è¿™æ ·ï¼Œä¸æ˜¯-bæŒ‡å®šï¼Œè€Œæ˜¯-c ä¿æŒhaproxyä¸‹å‘ä¸‹æ¥çš„ï¼Œç„¶å-båˆ©ç”¨ä¿æŒçš„cookieæ–‡ä»¶æ¥æµ‹è¯•

è¿™æ ·æµ‹è¯•è¿‡ç¨‹æ›´åŠ å®Œæ•´

![image-20240828111608325](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828111608325.png)



æ”¹ä¸€ä¸‹cookieçœ‹çœ‹æ•ˆæœ

![image-20240828111817887](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828111817887.png)



![image-20240828112925237](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828112925237.png)

å…ˆæ˜¯haproxyé€šè¿‡set-cookieå‘é€ç»™client

![image-20240828113047027](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828113047027.png)

ç„¶åclientå°±ä¼šå¸¦ä¸Šcookie

è¿™ä¸ªç„¶åçš„æ—¶é—´ï¼Œå°±æ˜¯ä¸‹æ¬¡clientè¯·æ±‚è¿™ä¸ªurlçš„æ—¶å€™

è‡ªç„¶å°±æ˜¯åˆ·æ–°é¡µé¢çš„æ—¶å€™å•¦

![image-20240828113215867](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828113215867.png)





# HAproxyçŠ¶æ€é¡µ





çŠ¶æ€é¡µé…ç½®é¡¹

![image-20240828113735114](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828113735114.png)



å¯ç”¨çŠ¶æ€é¡µç¤ºä¾‹

![image-20240828113747511](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240828113747511.png)



ç™»å½•çŠ¶æ€é¡µè¯´æ˜



```shell
vim /etc/haproxy/conf.d/status.cfg
listen status
	bind 0.0.0.0:8888
	stats enable
	stats hide-version
	stats uri /status 	# æ²¡æœ‰å†™statusé¡µçš„å…·ä½“è·¯å¾„ï¼Œæ‰€å“Ÿå°±æ˜¯é»˜è®¤å€¼ï¼Œè€Œé»˜è®¤å€¼å°±æ˜¯haproxy?stats
	stats refresh 10
	stats admin if TRUE

```



å¦‚æœç”¨è„šæœ¬å¤„ç†curlè¯·æ±‚åœ°å€éœ€è¦ç”¨å¼•å· å¼•ç”¨èµ·æ¥

```bash
curl  "http://192.168.126.132:8888/status;json;norefresh"
```

![image-20240903095810857](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240903095810857.png)

```bash
curl "http://192.168.126.132:8888/status;json;norefresh" |python -m json.tool
```

![image-20240903095832967](5.HaproxyåŠ¨æ€å…¶å®ƒè°ƒåº¦ç®—æ³•å’ŒçŠ¶æ€é¡µ.assets/image-20240903095832967.png)

