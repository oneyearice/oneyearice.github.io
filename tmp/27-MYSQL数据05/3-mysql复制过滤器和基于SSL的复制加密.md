# ç¬¬3èŠ‚. mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†

# éƒ¨åˆ†æ•°æ®å¤åˆ¶ï¼Œé‡‡ç”¨è¿‡æ»¤å™¨

ä¸¤ç§å®ç°æ–¹å¼ï¼š

1ã€ä»…å†™å…¥éœ€è¦å¤åˆ¶çš„æ•°æ®åº“ï¼ŒmasterèŠ‚ç‚¹é…ç½®

â€‹		ç¼ºç‚¹ï¼šbinlogä¸ä»…ä»…æ˜¯ç”¨æ¥å®ç°ä¸»ä»å¤åˆ¶ï¼Œæ›´å¤šæ˜¯ç”¨æ¥åšå¤‡ä»½çš„ä¸€ä¸ªå¢é‡è¿˜åŸç”¨çš„ã€‚è¿™æ ·è‚¯å®šä¸è¡Œï¼Œä½ æœ¬åœ°binlogéƒ½ä¸å…¨äº†ã€‚

2ã€slaveèŠ‚ç‚¹é…ç½®ï¼Œåœ¨rely-logä¸­ç»§æ—¥å¿—ä¸­æŒ‘å–å‡ºï¼Œå“ªäº›ç‰¹å®šæ•°æ®åº“çš„ç‰¹å®šè¡¨éœ€è¦åŒæ­¥åˆ°æœ¬åœ°ã€‚

â€‹		ç¼ºç‚¹ï¼šrely-logä¸­ç»§æ—¥å¿—é‡Œä¸œè¥¿æ˜¯å…¨çš„ï¼Œæ˜¯ä»masterå¤åˆ¶è¿‡æ¥äº†ï¼Œç„¶åå†sql threadè¿›è¡ŒæŒ‘é€‰çš„ï¼Œæ‰€ä»¥å·²ç»ä»masterå¤åˆ¶è¿‡æ¥ï¼Œæ„å‘³ç€ç½‘ç»œå’Œç£ç›˜IOå°±èŠ±è´¹å‡ºå»äº†ã€‚

â€‹		æ³¨æ„slaveè¿‡æ»¤éœ€è¦åœ¨æ‰€æœ‰çš„slaveä¸Šéƒ½è¦é…ç½®ä¸€è¾¹ã€‚





## æ–¹æ³•1ï¼šåªç”Ÿäº§ç‰¹å®šbinlog

```
masterä¸Šï¼š
-----------
vim /etc/my.cnf
  server-id=1
  log-bin
  # binlog-do-db = 
  binlog-ignore-db = hellodb
wr
systemctl restart mariadb

mysql > show master status;

å¯è§binlogé»‘åå•æ•°æ®åº“ğŸ‘‡
```

![image-20230814135651615](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814135651615.png)

æ­¤æ—¶hellodbçš„binlogéƒ½ä¸ä¼šç”Ÿäº§ï¼Œè‡ªç„¶å°±ä¸ä¼šå‚ä¸ä¸»ä»å¤åˆ¶äº†ï¼Œæµ‹è¯•ğŸ‘‡

![image-20230814135929346](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814135929346.png)

slaveé‚£è¾¹test003è¿˜åœ¨ï¼Œç¡®å®ä¸åŒæ­¥äº†

![image-20230814135954341](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814135954341.png)



å…¶ä»–æ•°æ®è¿˜æ˜¯åŒæ­¥çš„

![image-20230814140251345](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814140251345.png)

![image-20230814140303255](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814140303255.png)

æ­¤æ—¶å°±å®ç°äº†æ•°æ®çš„ä¸€ä¸ªè¿‡æ»¤è¿‡ç¨‹





## æ–¹æ³•2ï¼šslaveæœåŠ¡å™¨ä¸Šè¿›è¡Œè¿‡æ»¤

<img src="3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814140849855.png" alt="image-20230814140849855" style="zoom:40%;" />

```
slaveä¸Šï¼š
-------
vim /etc/my.cnf
  replicate-do-db=hellodb,db1  # è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªç™½åå•åªä»ä¸­ç»§æ—¥å¿—é‡Œå–å‡ºhelldb,db1ä¸¤ä¸ªåº“çš„binlogè¿›è¡Œsql threadå†™å…¥slaveæœ¬åœ°ã€‚
wr
systemctl restart mariadb


```

æ­¤æ—¶æ²¡æœ‰åŠ ç™½çš„å°±ä¸ä¼šå¤åˆ¶äº†ğŸ‘‡

![image-20230814142853544](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814142853544.png)



![image-20230814142904220](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814142904220.png)

åŠ ç™½çš„å°±ç»§ç»­å¤åˆ¶

![image-20230814143546438](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814143546438.png)



![image-20230814143602805](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814143602805.png)



![image-20230814143610666](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814143610666.png)

ä¸Šå›¾çš„"hellodb,db1"å‘ˆç°å‡ºæ¥çš„è²Œä¼¼æ˜¯ä¸¤ä¸ªdbç”¨é€—å·åˆ†å¼€ï¼Œå…¶å®ä¸ä¸€å®šçš„ï¼Œè¦å»my.cnfé‡Œçœ‹å¦‚æœæ˜¯replicate-do-db=hellodb,db1è¿™ç§å†™æ³•ï¼Œç³»ç»Ÿå¯èƒ½å°±åˆ¤å®šä¸ºä¸€ä¸ªå«"hellodb,db1"æ•°æ®åº“äº†ï¼Œé¬¼çŸ¥é“ï¼›å¦‚æœæ˜¯ä¸‹é¢çš„å†™æ³•ï¼Œç³»ç»Ÿå°±è™½ç„¶slave statusé‡Œæ˜¾ç¤ºè¿˜æ˜¯ä¸€æ ·"hellodb,db1"ï¼Œä½†æ˜¯ç¡®å®æ˜¯é€—å·åˆ†å¼€çš„ä¸¤ä¸ªæ•°æ®åº“äº†ã€‚

ç»“æœå°±æ˜¯åŠ ç™½çš„ä¹Ÿæ²¡æœ‰å¤åˆ¶ï¼Œä½†æ˜¯slave çŠ¶æ€æ—¶OKçš„å•Šï¼Œå¥‡æ€ªäº†ã€‚

å°±æ˜¯å†™çš„æ ¼å¼æœ‰é—®é¢˜ï¼Œä¸æ”¯æŒhellodb,db1è¿™ç§é€—å·çš„æ–¹å¼ï¼Œä¸€è¡Œä¸€ä¸ªï¼Œ

<img src="3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814144250082.png" alt="image-20230814144250082" style="zoom:50%;" />

æ­¤æ—¶slaveçš„çŠ¶æ€å€’æ—¶ç”¨é€—å·åˆ†å¼€çš„ï¼Œè²Œä¼¼å’Œä»¥å‰ä¸€æ ·ï¼Œä½†äº‹å®ä¸Šæ—¶ä¸¤ä¸ªdbäº†ï¼Œä»¥å‰æ—¶ä¸€ä¸ªdb

![image-20230814144356127](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814144356127.png)





![image-20230814144044470](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814144044470.png)

æ­¤æ—¶teståœ¨slaveé‚£è¾¹å°±ç¡®å®åŒæ­¥ ä¹Ÿåˆ æ‰äº†

![image-20230814144115664](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814144115664.png)



å†çœ‹ä¸€ä¸ªç°è±¡--å°±æ˜¯ç›®å‰çš„è¿‡æ»¤å™¨ï¼Œå¿…é¡»åˆ‡åˆ°use dbè¿›åˆ°å“ªä¸ªåº“é‡Œæ‰èƒ½åŒæ­¥ğŸ‘‡

![image-20230814150026822](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814150026822.png)

![image-20230814150107585](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814150107585.png)

ä½ çœ‹masteråœ¨noneä¸‹æ“ä½œçš„ï¼Œæ²¡æœ‰useè¿›åˆ°å¯¹åº”çš„åº“ï¼Œæ‰€ä»¥å°±æ²¡æœ‰åŒæ­¥ï¼Œä¸‹é¢å¯¹æ¯”æµ‹è¯•useä¸€ä¸‹å°±åŒæ­¥äº†ğŸ‘‡

![image-20230814150246283](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814150246283.png)

![image-20230814150253935](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814150253935.png)

å®é™…å·¥ä½œä¸­ä¸è¦ä½¿ç”¨è¿™ç§è·¨åº“æ“ä½œå°±å¥½ï¼Œ<font color=red>æ³¨æ„ä¸‹ï¼Œéƒ½ä½¿ç”¨use dbxxxè¿›åˆ°æŸä¸ªåº“é‡Œè¿›è¡Œæ“ä½œ</font>ã€‚





# æ•°æ®ä¸»ä»å¤åˆ¶å®‰å…¨åŠ å¯†ä¸‹



mysql -uroot -pxxxx -h xxxxè¿™ç§æ˜¯æ˜æ–‡çš„ï¼ŒæŠ“åŒ…å¯å¾—

![image-20230814153425676](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814153425676.png)



![image-20230814153437885](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814153437885.png)

å¯è§cliå’ŒæŸ¥çœ‹çš„ç»“æœæ•°æ®éƒ½èƒ½çœ‹å¾—åˆ°ã€‚





## åˆ©ç”¨SSLåŠ å¯†ï¼Œå°±æ˜¯è¦æœ‰SSLè¯ä¹¦

å®éªŒï¼Œåœ¨192.168.126.129å’Œ192.168.126.130ä¹‹é—´å®ç°åŠ å¯†

è¯ä¹¦æ€ä¹ˆç”³è¯·ï¼Œ

è¯ä¹¦æ˜¯ç”¨æ¥è¯æ˜å…¬é’¥çš„å®‰å…¨æ€§çš„ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½æœ‰è‡ªå·±çš„è¯ä¹¦ï¼Œå°†æ¥æ‰èƒ½åˆ©ç”¨è¯ä¹¦äº¤æ¢å½¼æ­¤çš„å…¬é’¥ï¼Œæ‰å¯ä»¥è¿›ä¸€ç¬”åˆ©ç”¨å…¬é’¥æ¥åŠ å¯†å¯¹ç§°å¯†é’¥ï¼Œè¿›è€Œå®ç°æ•°æ®ä¼ è¾“çš„å®‰å…¨ã€‚



mysqlçš„sslæ˜¯åšäº†åŒå‘è®¤è¯çš„ï¼Œå’Œå¹³æ—¶httpsä¸Šç½‘-åªåšæœåŠ¡å™¨çš„è®¤è¯ï¼Œä¸å¤ªä¸€æ ·ã€‚



1ã€caè‡ªå·±ç»™è‡ªå·±ç‰ˆæœ¬è¯ä¹¦ï¼šç”Ÿäº§ç§é’¥ï¼Œç”Ÿäº§è‡ªç­¾åè¯ä¹¦ï¼›

2ã€ç„¶ååœ¨é¢å‘è¯ä¹¦

3ã€è¿™æ¬¡åšéƒ½åœ¨ä¸€å°æœºå™¨ä¸Šåšå®Œï¼ŒåŒ…æ‹¬CAã€å„ä¸ªèŠ‚ç‚¹çš„è¯ä¹¦ç”Ÿæˆï¼Œç„¶ååˆ†å‘ä¸‹å»ã€‚

-----------------

```shell
mkdir /etc/my.cnf.d/ssl  # ä¸“é—¨æ”¾è¯ä¹¦ä¿¡æ¯ï¼Œåˆ©ç”¨ç°æˆçš„my.cnf.dæ–‡ä»¶å¤¹ï¼Œsslæ˜¯åˆ›å»ºçš„
cd /etc/my.cnf.d/ssl
```

æˆ‘ä»¬éœ€è¦3ä¸ªè¯ä¹¦ï¼šCAçš„è¯ä¹¦ã€ä¸»æœåŠ¡å™¨è¯ä¹¦ã€ä»èŠ‚ç‚¹è¯ä¹¦ã€‚

æœ‰è¯ä¹¦ï¼Œå°±å¾—æœ‰ç§é’¥ï¼Œ

```shell
â‘ ç”ŸæˆCAçš„ç§é’¥ï¼š
openssl genrsa 2048 > cakey.pem    # ä»¥å‰æ˜¯ä¸“é—¨ä¸€ä¸ªç›®å½•ï¼Œç°åœ¨ç®€å•æ”¾ä¸€èµ·å°±è¡Œ
å¯èƒ½æœ€å¥½åŠ ä¸ªå¯†ï¼Œæˆ–è€…æ”¹ä¸ªcakey.pemçš„æƒé™ï¼Œå®‰å…¨äº›ã€‚
```

![image-20230814163025210](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814163025210.png)

```
â‘¡åˆ©ç”¨ç§é’¥ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl req -new -x509 -key cakey.pem -out cacert.pem -days 3650

```

![image-20230814164039232](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814164039232.png)

![image-20230814164202761](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814164202761.png)

```shell
â‘¢ç”Ÿæˆmasterçš„ç§é’¥å’Œè¯ä¹¦ç”³è¯·æ–‡ä»¶
openssl req -newkey rsa:1024 -days 365 -nodes -keyout master.key > master.csr  # åˆ©ç”¨ä¸€æ¡å‘½ä»¤ç”Ÿæˆç§é’¥æ–‡ä»¶master.keyï¼Œå¹¶åˆ©ç”¨è¯¥keyç”Ÿæˆè¯ä¹¦ç”³è¯·æ–‡ä»¶ã€‚

æ³¨æ„ï¼1024å¾—æ”¹æˆ2048ï¼Œå¦åˆ™mysqlèµ·ä¸æ¥ã€‚å¯èƒ½æ˜¯ä¹‹å‰ç”¨å¾—2048çš„CAç§é’¥å§ã€‚
```

![image-20230814165624518](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814165624518.png)

```
â‘£æœ‰äº†è¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼Œå°±å¯ä»¥ç­¾åäº†--ä¹Ÿå°±æ˜¯é¢å‘è¯ä¹¦
openssl x509 -req -in master.csr -CA cacert.pem -CAkey cakey.pem -set_serial 01 > master.crt

åˆ©ç”¨CAçš„ä¿¡æ¯ï¼Œæ ¹æ®è¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼Œæ¥å®ç°ç”Ÿæˆè¯ä¹¦ã€‚
_set_serial 01  æŒ‡å®šè¯ä¹¦ç¼–å·ï¼Ÿ

```

![image-20230814170353681](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814170353681.png)

```shell
â‘¤åŒæ ·å†ç”Ÿæˆslaveçš„ç§é’¥å’Œè¯ä¹¦ç”³è¯·æ–‡ä»¶
openssl req -newkey rsa:2048 -days 365 -nodes -keyout slave.key > slave.csr  # åˆ©ç”¨ä¸€æ¡å‘½ä»¤ç”Ÿæˆç§é’¥æ–‡ä»¶slave.keyï¼Œå¹¶åˆ©ç”¨è¯¥keyç”Ÿæˆè¯ä¹¦ç”³è¯·æ–‡ä»¶ã€‚

æ³¨æ„ï¼š-days 365 å¥½åƒæ˜¯é»˜è®¤å°±æœ‰çš„ã€‚

```

![image-20230814173701688](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814173701688.png)



```shell
â‘¥åŒæ ·å†ç»™slaveèŠ‚ç‚¹é¢å‘è¯ä¹¦
openssl x509 -req -in slave.csr -CA cacert.pem -CAkey cakey.pem -set_serial 02 > slave.crt

åˆ©ç”¨CAçš„ä¿¡æ¯ï¼Œæ ¹æ®è¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼Œæ¥å®ç°ç”Ÿæˆè¯ä¹¦ã€‚
_set_serial 02  æŒ‡å®šè¯ä¹¦ç¼–å·
```

![image-20230814173838129](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814173838129.png)



åˆ°æ­¤å°±æœ‰äº†masterå’Œslaveçš„è¯ä¹¦å’Œç§é’¥äº†ï¼Œå°±å¯ä»¥åˆ©ç”¨è¯ä¹¦æ¥åŠ å¯†äº†

## å¼€å§‹ç»™mysqlé…ç½®sslè¯ä¹¦

é»˜è®¤æ˜¯æœªå¼€å¯sslåŠ å¯†çš„

![image-20230814174726652](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814174726652.png)

ä¸€äº›å’ŒåŠ å¯†ç›¸å…³çš„å˜é‡

![image-20230814174952359](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814174952359.png)

é¢˜å¤–è¯ï¼š%ssl%ä¸åŒºåˆ†å¤§å°å†™ã€‚

éœ€è¦æŒ‡ssl_ca  CAçš„è¯ä¹¦ï¼›ssl_certè‡ªå·±çš„è¯ä¹¦ï¼Œssl_keyè‡ªå·±çš„ç§é’¥ã€‚

```
vim /etc/my.cnf
  ssl-ca=/etc/my.cnf.d/ssl/cacert.pem
  ssl-cert=/etc/my.cnf.d/ssl/matser.crt
  ssl-key=/etc/my.cnf.d/ssl/master.key
  
```

![image-20230814180628985](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814180628985.png)

ä½†æ˜¯æœåŠ¡èµ·ä¸æ¥

![image-20230814180650916](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814180650916.png)

æŸ¥çœ‹æŠ¥é”™æ—¥å¿—

![image-20230814180710663](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814180710663.png)

å‘ç°æ˜¯SSL error: Unable to get certificate from '/etc/my.cnf.d/ssl/master.crt'

å¯èƒ½æ˜¯ä¹‹å‰çš„master.crtè¯ä¹¦æ–‡ä»¶ç”Ÿæˆçš„æœ‰é—®é¢˜ã€‚

ä¸€èˆ¬æ˜¯æ–‡ä»¶æƒé™é—®é¢˜ï¼Œä½†æ˜¯è¿™é‡Œä¸æ˜¯ï¼Œéœ€è¦ä¿®æ”¹ä¸€ä¸‹ç›¸å…³å‘½ä»¤ã€‚

https://stackoverflow.com/questions/42145925/mariadb-over-ssl-not-working-certificate-verify-failed

ğŸ‘†è¿™ç¯‡æ˜¯OKçš„ï¼Œåªä¸è¿‡sha1è¦å»æ‰å°±è¡Œäº†ï¼Œæˆ‘æ€€ç–‘åªè¦å°†ä¸Šé¢çš„clié‡Œçš„åç¼€æ”¹æˆpemå°±è¡Œäº†ï¼Œè¯•è¯•çœ‹ã€‚ä¸æ˜¯ï¼Œç ´æ¡ˆäº†ğŸ‘‡ï¼Œè¿˜æ˜¯ç”¨ä¸Šé¢çš„åŸcliæ”¹æˆ2048è·‘ä¸€éå†ã€‚



ä¸‹é¢å¯¹æ¯”æ’éšœæµ‹è¯•ï¼š

```shell
è¿™æ®µNGï¼š
-----------------
openssl genrsa 2048 > cakey.pem
openssl req -new -x509 -key cakey.pem -out cacert.pem -days 3650
openssl req -newkey rsa:1024 -days 365 -nodes -keyout master-key.pem > master-req.pem  # 1024 æ”¹æˆ2048å°±OKäº†

openssl x509 -req -in master-req.pem -CA cacert.pem -CAkey cakey.pem -set_serial 01 > master-cert.pem


```

```shell
è¿™æ®µOKï¼š
-----------------
openssl genrsa 2048 > cakey.pem
openssl req -new -x509 -nodes -days 3650 -key cakey.pem > cacert.pem
openssl req -newkey rsa:2048 -days 730 -nodes -keyout master-key.pem > master-req.pem

openssl x509 -req -in master-req.pem -days 730  -CA cacert.pem -CAkey cakey.pem -set_serial 01 > master-cert.pem

chown mysql.mysql *

```

å¦‚æœå¸¸è§„å°±æ˜¯èµ·ä¸ªserveråå­—ğŸ‘‡

```
openssl genrsa 2048 > ca-key.pem
openssl req -new -x509 -nodes -days 3650 -key ca-key.pem > ca-cert.pem
openssl req -newkey rsa:2048 -days 730 -nodes -keyout server-key.pem > server-req.pem
openssl rsa -in server-key.pem -out server-key.pem
openssl x509 -req -in server-req.pem -days 730  -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 > server-cert.pem
chown mysql.mysql *

```



sslè·¯å¾„é…ç½®ï¼Œé‡å¯æœåŠ¡OKåï¼Œæ­¤æ—¶statuså’Œshow variables like '%ssl%';å°±å¯è§

![image-20230815111527667](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230815111527667.png)

é€šè¿‡SSLç›¸å…³å˜é‡å¯è§ ä¸¤ä¸ªéƒ½YESäº†ï¼Œä¹Ÿæœ‰äº†ç›¸å…³è·¯å¾„ğŸ‘‡

<img src="3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230815111544230.png" alt="image-20230815111544230" style="zoom:50%;" />



æ­¤æ—¶å°±æŠŠsslçš„é…ç½®éƒ½å¼„äº†ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å¯ç”¨åŠ å¯†æ–¹å¼è¿æ¥ã€‚çè¯´ï¼Œä¸Šä¸Šå›¾statuså¯è§

![image-20230906104226492](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906104226492.png)

è¯´æ˜å°±å·²ç»å¯åŠ¨äº†ï¼Œè‡³äºæœ‰çš„ä½ç‰ˆæœ¬è¿˜éœ€è¦è¿™æ ·å¯ç”¨ï¼Œé‚£æ˜¯ä½ç‰ˆæœ¬å¤ªlowã€‚

ä¸ç®¡æ˜¯æœ¬åœ°ç™»å…¥è‡ªå·±è¿˜æ˜¯åˆ«äººè¿œç¨‹ç™»å…¥è‡ªå·±ï¼Œè¿˜æ˜¯æœ¬åœ°ç”¨socketæˆ–æ˜¯tcpå¥—æ¥å­—ç™»å…¥è‡ªå·±éƒ½æ˜¯è‡ªåŠ¨çš„å¯ç”¨äº†SSLçš„ï¼Œstatus å¯è§SSL Cipher in use is TLS_AES_256_GCM_SHA384çš„ã€‚

![image-20230906105636989](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906105636989.png)



ä½ç‰ˆæœ¬æ‰éœ€è¦é“¾æ¥çš„æ—¶å€™è°ƒç”¨é…ç½®é‡Œçš„sslè¯ä¹¦å’Œkey

```

mysql --ssl-ca=cacert.pem --ssl-cert=master.crt --ssl-key=master.key

```

![image-20230906113532587](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906113532587.png)

![image-20230906103846535](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906103846535.png)

ç„¶åå¼ºåˆ¶æŸä¸ªè´¦å·å¿…é¡»ä½¿ç”¨sslï¼Œé«˜ç‰ˆæœ¬é»˜è®¤å°±æ˜¯ä¼šç”¨sslï¼Œåº”è¯¥è¿™ä¹Ÿæ˜¯ä½ç‰ˆæœ¬æ‰éœ€è¦çš„æ“ä½œ

```mysql
grant replication slave on *.* to repluser2@'192.168.%.%' identified by 'cisco' require ssl;
```

![image-20230906112456314](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906112456314.png)

æ­¤æ—¶ä½¿ç”¨repluser2 ä½ç‰ˆæœ¬å°±éœ€è¦åŠ ä¸Šsslé€‰é¡¹ï¼Œé«˜ç‰ˆæœ¬ä¸éœ€è¦

![image-20230906112726708](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906112726708.png)





è¿›ä¸€æ­¥å®ç°ä¸»ä»å¤åˆ¶ç”¨SSLï¼Œå°†ä¹‹å‰åœ¨masterä¸Šä¸€å¹¶äº§ç”Ÿçš„slaveçš„è¯ä¹¦ä¹Ÿå¤åˆ¶åˆ°slaveä¸Š

![image-20230906110126468](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906110126468.png)

å…¶å®ç”¨è¿™ä¸ªä¸‰ä¸ªæ–‡ä»¶å°±è¡Œäº†

![image-20230906110204369](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906110204369.png)



<img src="3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906110347724.png" alt="image-20230906110347724" style="zoom:50%;" /> 

ä½†æ˜¯slaveè¿™æ ·èµ·ä¸æ¥ï¼

æŸ¥çœ‹æŠ¥é”™ï¼Œè¯´æ˜¯SSLè·¯å¾„ä¸å¯¹ï¼Œ

![image-20230906114502207](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906114502207.png)

å…¶å®æ˜¯æƒé™æ²¡æœ‰ï¼Œæ‹¿ä¸åˆ°sslæ–‡ä»¶

![image-20230906114423046](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906114423046.png)



![image-20230906114727784](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906114727784.png)

èµ·æ¥äº†ï¼Œä½†æ˜¯æœ‰é”™è¯¯

è¿™ä¸ªæŠ¥é”™æ˜¯ä¸»ä»å¤åˆ¶çš„æŠ¥é”™ï¼Œ

![image-20230906115223657](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906115223657.png)

ä¹Ÿå°±æ˜¯ä¸åŒæ­¥çš„æŠ¥é”™ï¼ŒæŒ‰ä¹‹å‰çš„å¤„ç†æ–¹æ³•è¯•è¯•

SLAVE IOéƒ½æ²¡æœ‰Yeså•Šï¼Œè§£å†³æ€è·¯æœ‰2

```
1ã€é‡æ–°ä»master dump å‡ºæ¥ä¸€ä»½ï¼Œè®°å¾—å¸¦--master-date=1é€‰é¡¹ï¼Œå¯¼å…¥åï¼Œå¯åŠ¨slaveå³å¯
2ã€åœ¨masterä¸Šçœ‹çœ‹å½“å‰çš„binlog ä½ç½®ï¼Œç›´æ¥åœ¨slaveä¸Šstop; reset slave all; å……å‹é…ç½®åŒæ­¥ä¿¡æ¯CHANGE TO ã€‚ã€‚ã€‚ã€‚;åœ¨start slaveè¯•è¯•ï¼Œå·®ä¸å¤šå°±èƒ½åŒæ­¥ï¼Œå½“ç„¶è¿™é‡Œæ¨èç”¨1è€Œä¸æ˜¯2.å› ä¸ºè¿™æ˜¯ä½ ä»æœ€æ–°çš„ä½ç½®å¤åˆ¶è¿‡æ¥çš„ï¼Œå‰é¢å¾ˆå¤šæ•°æ®éƒ½æ²¡æœ‰åŒæ­¥ï¼Œè€Œä¸”2è¿˜ä¸ä¸€å®šæˆåŠŸï¼Œå¯èƒ½æŠ¥é”™ğŸ‘‡å¦‚ä¸‹å›¾ï¼Œä¸è¿‡åªè¦æŒ‰æç¤ºæ”¹æˆ'mariadb-bin.000003' at 4 ä¹Ÿèƒ½åŒæ­¥ï¼Œå‘µå‘µï¼Œå®éªŒå°±æ— æ‰€è°“äº†ï¼ŒåŒæ­¥å°±è¡Œäº†ã€‚
```

![image-20230906154130117](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906154130117.png)

```
CHANGE MASTER TO  MASTER_HOST='192.168.126.129',  MASTER_USER='repluser',  MASTER_PASSWORD='cisco',  MASTER_PORT=3306,  MASTER_CONNECT_RETRY=10, MASTER_LOG_FILE='mariadb-bin.000003', MASTER_LOG_POS=4;
```

![image-20230906153758203](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906153758203.png)

æ­¤æ—¶æåŒæ­¥äº†å°±ï¼Œä½†æ˜¯SSLè¿˜æ²¡æœ‰åœ¨ä¸»ä»åŒæ­¥ç¯èŠ‚å¯ç”¨ï¼Œé»˜è®¤é…ç½®äº†sslåœ¨/etc/my.cnfé‡Œåªæ˜¯ç™»å…¥(è¿œç¨‹æœ¬åœ°ä¹Ÿå¥½ï¼Œsocker/tcpä¹Ÿå¥½)é»˜è®¤ä½¿ç”¨sslã€‚

```
SlaveæœåŠ¡å™¨é…ç½®
mysql>
CHANGE MASTER TO  MASTER_HOST='MASTERIP',  MASTER_USER='rep',  MASTER_PASSWORD='centos',
MASTER_LOG_FILE='mariadb-bin.0000xx',  MASTER_LOG_POS=xx,  #è¿™é‡Œå†™masterçš„
MASTER_SSL=1,
MASTER_SSL_CA = '/etc/my.cnf.d/ssl/cacert.pem',  
MASTER_SSL_CERT = '/etc/my.cnf.d/ssl/slave.crt',  
MASTER_SSL_KEY = '/etc/my.cnf.d/ssl/slave.key';
```

```
CHANGE MASTER TO  MASTER_HOST='192.168.126.129',  MASTER_USER='repluser',  MASTER_PASSWORD='cisco',
MASTER_LOG_FILE='mariadb-bin.000023',  MASTER_LOG_POS=691,
MASTER_SSL=1,
MASTER_SSL_CA = '/etc/my.cnf.d/ssl/cacert.pem',  
MASTER_SSL_CERT = '/etc/my.cnf.d/ssl/slave.crt',  
MASTER_SSL_KEY = '/etc/my.cnf.d/ssl/slave.key';
```

![image-20230906155554764](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906155554764.png)



![image-20230906155656281](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906155656281.png)



æˆ‘çœ‹åˆ«äººæ¼”ç¤ºé‡Œä¸å†™ä¸‰ä¸ªsslæ–‡ä»¶è·¯å¾„å”‰ï¼Œæˆ‘è¯•è¯•

```
CHANGE MASTER TO  MASTER_HOST='192.168.126.129',  MASTER_USER='repluser',  
MASTER_PASSWORD='cisco',
MASTER_LOG_FILE='mariadb-bin.000023',  
MASTER_LOG_POS=691,
MASTER_SSL=1;
```

ç»“æœä¸€æ ·çš„æŠ¥é”™ï¼Œè€Œä¸”ï¼Œäººå®¶ä¼šè‡ªåŠ¨å»æ‰¾åˆ°ä¸‰ä¸ªsslæ–‡ä»¶è·¯å¾„å¹¶ç»™ä½ æ˜¾ç¤ºå‡ºæ¥çš„--è¿™æ˜¯å› ä¸ºç¬¬ä¸€æ¬¡é…ç½®äº†ï¼Œè¿™ç‚¹å’Œè€ç‰ˆæœ¬ä¸ä¸€æ ·ã€‚æ”¾å±ï¼stop slave; reset slave all;exit systemctl restart mariadbå°±å¥½äº†ï¼Œä¸ç”¨é…ç½®è¯ä¹¦è·¯å¾„ï¼



![image-20230906160302206](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906160302206.png)



å°è¯•å»æ‰sslï¼Œå‘ç°å»ä¸æ‰ğŸ‘‡ï¼Œreset slave all;åå¹¶æœªé…ç½®sslï¼Œä¹Ÿä¸ºå¯ç”¨ï¼Œä½†æ˜¯å°±å¯ç”¨äº†YES

![image-20230906162023615](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906162023615.png)

æ‰‹åŠ¨å†™MASTER_SSL=0æ¥å…³é—­ï¼Œ

![image-20230906162126405](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906162126405.png)start slaveä¸€ä¸‹å‘ç°æŠ¥é”™å˜äº†

![image-20230906162155000](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906162155000.png)

é—®é—®GPT

![image-20230906162213129](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906162213129.png)

å®æµ‹æ“ä½œï¼Œæœ‰æ•ˆ

![image-20230906162258650](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906162258650.png)

![image-20230906162316647](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906162316647.png)



æ­¤æ—¶åœ¨å¼€å¯SSLçœ‹çœ‹

```
Last_IO_Error: error connecting to master 'repluser@192.168.126.129:3306' - retry-time: 10  maximum-retries: 100000  message: SSL connection error: error:00000000:lib(0)::reason(0)

è¿˜æ˜¯æŠ¥è¿™ä¸ªé”™ï¼Œ
masterä¸Šæ•²mariadb-admin flush-hostsä¹Ÿæ²¡æœ‰ç”¨ï¼

```

##### å¦‚ä½•æ¸…ç©ºsslæ–‡ä»¶è·¯å¾„ï¼Œéœ€è¦é‡å¯æœåŠ¡

stop slave; reset slave all;exit systemctl restart mariadbå°±å¥½äº†ï¼Œä¸ç”¨é…ç½®è¯ä¹¦è·¯å¾„ï¼

![image-20230906163449853](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906163449853.png)

![image-20230906163704230](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906163704230.png)

ä½ è¦è¯´ç”¨æˆ·repluser2æ˜¯åªèƒ½sslçš„ï¼Œ

![image-20230906163748263](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906163748263.png)

æ²¡äº‹ï¼Œæ¢ï¼Œï¼Œæ”¹æˆrepluserä¹Ÿä¸€æ ·ï¼Œè‡³å°‘è¿™é‡Œrepluser2 æˆåŠŸå°±è¯´æ˜å·²ç»ä½¿ç”¨äº†sslåŠ å¯†å¤åˆ¶äº†ã€‚

![image-20230906163907483](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906163907483.png)



é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¦ä¸è¦é…ç½®ï¼Œå¦‚æœé…ç½®äº†æ˜¯å¦åº”è¯¥é…ç½®masterè€Œä¸æ˜¯slaveå‘¢ï¼Œè¯•è¯•

ä¸è¡Œï¼Œä¸€æ ·æŠ¥é”™ï¼Œåªè¦é…ç½®sslä¸‰ä¸ªæ–‡ä»¶çš„è·¯å¾„ï¼Œå°±æœ‰é—®é¢˜

![image-20230906164032406](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906164032406.png)



![image-20230906164827162](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906164827162.png)

è¿™æ ·å°±å®ç°äº†å¸¦sslçš„ä¸»ä»å¤åˆ¶ï¼Œä¸Šå›¾hellodb002å¤åˆ¶OKï¼Œ001æ²¡æœ‰ï¼Œæ˜¯å› ä¸ºä¹‹å‰æœ‰ä¸ªç™½åå•

å»æ‰å°±å¥½äº†ğŸ‘‡

![image-20230906165005320](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906165005320.png)





å†æ¬¡å°è¯•ä¸€ä¸‹

å»æ‰é…ç½®é‡Œçš„sslè·¯å¾„ï¼Œæ”¹ä¸ºé…ç½®slaveçš„æ—¶å€™æŒ‡å®šsslæ–‡ä»¶

![image-20230906181110098](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230906181110098.png)

```
CHANGE MASTER TO  MASTER_HOST='192.168.126.129',  MASTER_USER='repluser',  MASTER_PASSWORD='cisco',
MASTER_LOG_FILE='mariadb-bin.000023',  MASTER_LOG_POS=691,
MASTER_SSL=1,
MASTER_SSL_CA = '/etc/my.cnf.d/ssl/cacert.pem',  
MASTER_SSL_CERT = '/etc/my.cnf.d/ssl/master.crt',  
MASTER_SSL_KEY = '/etc/my.cnf.d/ssl/master.key';

ä¸ç®¡æ˜¯masterçš„sslè¯ä¹¦è¿˜æ˜¯slaveçš„è¯ä¹¦éƒ½ä¸è¡Œï¼ŒæŠ¥é”™ä¸€æ ·ã€‚ç®—äº†ï¼Œå°±åœ¨/etc/my.cnfé‡Œé…ç½®å°±è¡Œäº†ï¼Œåˆ«åœ¨slaveé‡Œé…ç½®sslæ–‡ä»¶äº†ã€‚

CHANGE MASTER TO  MASTER_HOST='192.168.126.129',  MASTER_USER='repluser',  MASTER_PASSWORD='cisco',
MASTER_LOG_FILE='mariadb-bin.000023',  MASTER_LOG_POS=691,
MASTER_SSL=1,
MASTER_SSL_CA = '/etc/my.cnf.d/ssl/cacert.pem',  
MASTER_SSL_CERT = '/etc/my.cnf.d/ssl/slave.crt',  
MASTER_SSL_KEY = '/etc/my.cnf.d/ssl/slave.key';
```



