# ç¬¬6èŠ‚ Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜





# Dockerfileçš„ç¼–å†™



## å®˜æ–¹æ–‡æ¡£ï¼š

https://docs.docker.com/reference/dockerfile/

ä¸€è¡Œä¸€ä¸ªæŒ‡ä»¤

\# è¡¨ç¤ºæ˜¯æ³¨é‡Š



## é¦–å…ˆæŒ‡å®šåŸºç¡€é•œåƒ:FROM

```shell
cd /data/dockerfile/base/apline

touch Dockerfile

```



1ã€åŸºäºalpineæ¥

æ˜ç¡®ä¸‹è¾ƒæ–°çš„ç‰ˆæœ¬

![image-20240429154039336](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429154039336.png)

```shell
FROM alpine:3.19.1   # ä»è¯¥é•œåƒç»§æ‰¿
```

alpine:3.19.1 åˆæ˜¯ä»æ‹¿æ¥çš„å‘¢ï¼Ÿè¿™ä¸ªå°±è¦å»å®˜ç½‘æŸ¥çœ‹äº†

![image-20240429154719125](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429154719125.png)



![image-20240429154736097](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429154736097.png)



![image-20240429154752781](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429154752781.png)



å¯è§alpineçš„çˆ¶é•œåƒæ˜¯scratchæ¥ç€ã€‚è€Œä¸”ubuntuã€centosã€busyboxéƒ½æ˜¯fromçš„å¥¹ã€‚ç„¶åjdkï¼Œtomcatè¿™äº›APPåˆæ˜¯åŸºäºOSçš„ã€‚è¿™ä¸ªscratchå°±æ˜¯æ‰€æœ‰é•œåƒçš„ç¥–å…ˆï¼Œè¿™å°±æ˜¯ä¸€ä¸ªç©ºé•œåƒ![image-20240429161151287](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429161151287.png)

ã€‚



https://hub.docker.com/_/scratch

![image-20240429155846707](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429155846707.png)





å†çœ‹å›alpineçš„Dockerfile

![image-20240429162658367](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429162658367.png)

å‚è€ƒäººå®¶çš„alpineåˆ¶ä½œï¼Œå…¶å®å°±æ˜¯fromä¸€ä¸ªscratchåŸå§‹ç©ºé•œåƒï¼Œå†ADDä¸€ä¸ªè¿·ä½ rootfså°±è¡Œäº†è¿™ä¸ªrootfså…¶å®å°±æ˜¯OSçš„ç”¨æˆ·ç©ºé—´ï¼Œè€ŒOSçš„å†…æ ¸ç©ºé—´å°±æ˜¯ç”¨å®¿ä¸»æœºçš„ã€‚

â€‹		ä½ è¦è‡ªå·±æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªç±»ä¼¼alpineçš„é•œåƒï¼Œå°±å¯ä»¥å®šåˆ¶ä»¥ä¸‹è¿™ä¸ªrootfsæ–‡ä»¶

![image-20240429162955179](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429162955179.png)

ä¹Ÿå°±æ˜¯è¯´ç¡®å®è¿˜æœ‰è¿›ä¸€æ­¥ç¼©å‡çš„ç©ºé—´ã€‚



å»çœ‹çœ‹busyboxçš„Dockerfileï¼Œé‡Œé¢rootfsæ›´å°ã€‚

![image-20240429163517390](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429163517390.png)

<img src="6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429163550816.png" alt="image-20240429163550816" style="zoom:46%;" />



å…¶å®ï¼Œæ²¡å¿…è¦æŠ˜è…¾ï¼Œç›´æ¥å®˜æ–¹çš„åŸºç¡€é•œåƒæ‹¿æ¥ç”¨å°±è¡Œäº†

### æ—¢ç„¶æ²¡å¿…è¦æŠ˜è…¾é‚£ä¹ˆå°±æŠ˜è…¾ä¸‹å§ # éå¸¸è§„æ“ä½œ

ç›®æ ‡ï¼šé‡æ–°è‡ªå·±åšä¸€ä¸ªæœ€å°OSï¼Œå‚è€ƒbusyboxå’¯

![image-20240429173617863](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429173617863.png)



ç„¶åä¸‹è½½ä¸‹æ¥

![image-20240429173820449](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429173820449.png)



ç„¶åçœ‹çœ‹æ˜¯å¦è¦ä¿®æ”¹

![image-20240429174407133](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429174407133.png)

è¿˜æ˜¯è¦åŠ å‹ï¼Œå› ä¸ºæœ¬æ¥æˆ‘æƒ³ç›´æ¥ç”¨tar -r -f è¿½åŠ å·¥å…·è¿›å»ï¼Œä½†æ˜¯-rä¸æ”¯æŒå‹ç¼©æ ¼å¼ï¼Œå•å•ä¸€ä¸ªtaråŒ…ä¸å¸¦gzæ˜¯å¯ä»¥çš„

![image-20240429174942327](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429174942327.png)

è¿›ä¸€æ­¥ç¼©å‡cliæ–‡ä»¶ï¼Œå†åŠ ç‚¹æ¯”å¦‚curlå‘½ä»¤

![image-20240429175100483](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429175100483.png)

åˆ é™¤å°±æ€•è¿™äº›binæ–‡ä»¶ä¹‹é—´æœ‰ä¾èµ–å…³ç³»å°±ä¸å¥½å¼„äº†ï¼Œå…ˆä¸ç®¡ï¼Œåˆ é™¤æ²¡è§è¿‡çš„æ‰€æœ‰binæ–‡ä»¶

æä¸æ‡‚äº†ğŸ‘‡ï¼Œæ¯åˆ ä¸€ä¸ªå°±ä¼šå‡ºç°æ–°çš„æ–‡ä»¶æ¥å ç”¨ç©ºé—´

![image-20240429183620033](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240429183620033.png)

åˆ æ‰å·®ä¸å¤šäº†ï¼Œå†å¼„ä¸ªcurlè¿›å»è¯•è¯•

![image-20240430092936364](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430092936364.png)

![image-20240430092958639](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430092958639.png)

æ‰“åŒ…

![image-20240430094351076](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430094351076.png)

å®šåˆ¶çš„busybox.tar.gzåè€Œå˜å¤§äº†ï¼Œå‘µå‘µ

é¢„è§ˆä»¥ä¸‹åŒ…é‡Œå†…å®¹å½“ä½œæ£€æŸ¥

![image-20240430094500474](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430094500474.png)

![image-20240430100020262](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430100020262.png)

æ³¨é‡Šè¦å•ç‹¬ä¸€è¡Œï¼Œä¸èƒ½è·Ÿå†CLIåé¢

![image-20240430100117086](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430100117086.png)

è¿™æ ·å°±å¥½äº†

![image-20240430100206879](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430100206879.png)

![image-20240430100318621](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430100318621.png)

è¿™å°±æ˜¯LABELæ‰“è¿›å»çš„æ ‡ç­¾

ç„¶årunå°±æŠ¥é”™å•¦

![image-20240430100449964](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430100449964.png)

å› ä¸ºæˆ‘æŠŠshåˆ æ‰äº†ï¼Œå“ˆå“ˆå“ˆ



é‡åšï¼Œåªè¦shç­‰3ä¸ªbinæ–‡ä»¶

![image-20240430101041335](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430101041335.png)

æ‰“åŒ…åï¼Œbuild

![image-20240430101222329](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430101222329.png)

runä¸€ä¸‹

![image-20240430101459800](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430101459800.png)

å¯æƒœcurlè¿˜æ˜¯æ²¡æœ‰æŠŠä¾èµ–åº“å¼„å¥½ï¼Œæç¬‘çš„æ˜¯lsä¹Ÿè¢«æˆ‘åˆ æ‰äº†ï¼Œæå¾—æ²¡æ³•lsï¼Œç„¶åfindä¹Ÿæ²¡æœ‰ï¼Œcurlåˆ°åº•åœ¨å“ªä¹Ÿä¸çŸ¥é“ã€‚

å¥½äº†ï¼Œæ€»ä¹‹æ€è·¯å°±æ˜¯curlå’Œä¾èµ–éƒ½è¦æ‰“åŒ…ï¼Œç„¶åè¿‡ç¨‹å¦‚ä¸Šã€‚è¿™å°±æ˜¯å®šåˆ¶osçš„æ€è·¯ã€‚ä¸€èˆ¬osè¿˜æ˜¯ä¸è‡ªå·±æŠ˜è…¾çš„ã€‚



**å†æ¥ä¸€é**

![image-20240430101916340](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430101916340.png)



![image-20240430102205622](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430102205622.png)



![image-20240430102304457](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430102304457.png)

ä¸Šé¢é”™äº†ï¼Œcp -aæ˜¯å¤åˆ¶çš„è½¯è¿æ¥ï¼Œ

![image-20240430102446520](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430102446520.png)



**å†æ¥ä¸€éå§**

![image-20240430102800002](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430102800002.png)

å¾ˆå¥½æŠ¥åˆ«çš„ä¾èµ–åº“äº†ï¼Œæ‰€ä»¥ä½ çŸ¥é“äº†OSå®šåˆ¶è¿˜æ˜¯æŒºéº»çƒ¦çš„ï¼Œä¸åƒåŸºäºåˆ«äººçš„osï¼Œç›´æ¥å®‰è£…å·¥å…·å°±å¥½äº†ï¼Œæ¯”å¦‚commitæ–¹å¼æœ€ç®€å•ï¼Œ

ä¸è¿‡ä¸Šé¢çš„æƒ…å†µï¼Œæˆ‘ä¹Ÿå¯ä»¥ç”¨docker cp çš„æ–¹å¼æ¥å¤„ç†ï¼Œä¸è¿‡è¦å¤„ç†çš„å°±å¤šäº†å»äº†ğŸ‘‡

![image-20240430103005106](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430103005106.png)

å°è¯•æŠŠè¿™äº›lddä¾èµ–å¼„è¿›å»

![image-20240430103753353](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430103753353.png)

ä½†æ˜¯ç»§ç»­æµ‹è¯•å‘ç°ï¼Œè¿™äº›åº“å¼„è¿›æ¥ä¹ŸæŠŠshçš„ä¾èµ–æå‡ºé—®é¢˜äº†

![image-20240430105527475](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430105527475.png)

é‚£ä¹ˆå°±è¿™ä¸ªæ–‡ä»¶ä¸å¼„è¿›å»

å¯¹æ¯”äº†åŸæ¥shä¾èµ–çš„è¿™ä¸ªåº“å’Œcurlä¾èµ–çš„è¿™ä¸ªåº“å‘ç°ä¸ä¸€æ ·

![image-20240430105909577](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430105909577.png)

åº”è¯¥æ˜¯curlçš„ä¾èµ–æŠŠè¿™ä¸ªlibc.so.6è¦†ç›–äº†ï¼Œå¯¼è‡´shå¯åŠ¨ä¸äº†

ç”¨å®˜æ–¹çš„taråŒ…é‡Œçš„æºæ–‡ä»¶ï¼Œå°†è¿™ä¸ªåº“è¿˜åŸå›å»ï¼Œå¯è¡Œ~ä¸‹æ–‡**æ–¹æ³•1**å°±æ˜¯ä¸Šé¢æŠ˜è…¾çš„æ€»ç»“



### 

### æ–¹æ³•1ï¼šä»taråŒ…å…¥æ‰‹çš„é•œåƒå®šåˆ¶ï¼Œlddæ˜¯å…³é”®

è¿™ç§æ–¹æ³•å°±æ˜¯ä»scratchå¼€äº†ï¼Œå‘µå‘µï¼Œæ¯”è¾ƒå¼ï¼Œä¸€èˆ¬ä¸è¿™ä¹ˆç”¨ï¼Œå±äºéæ­£è§„æ–¹æ³•ã€‚

```shell
mkdir -p /data/dockerfile/os/busybox-my-base
cd /data/dockerfile/os/busybox-my-base
vim Dockerfile
FROM scratch
ADD busybox.tar.gz /       # è¿™å¥å…¶å®å°±æ˜¯è§£åŒ…ï¼Œè§£å¼€å¹¶è§£å‹ç¼©åˆ°å®¹å™¨é‡Œçš„/æ ¹è·¯å¾„ä¸‹
LABEL multi.label1="value1" \
	  multi.label2="value2" \
	  maintainer="oneyearice <oneyearice@gmail.com>" \
	  version=1.0 \
	  other="value3"
CMD ["sh"]
```

**ä»¥ä¸‹æ˜¯å®Œæ•´çš„ä¸€ä¸ªosè‡ªå®šä¹‰è¿‡ç¨‹**

éœ€æ±‚ï¼Œå°†busyboxé‡Œçš„cliåªä¿ç•™sh find ls å¹¶æ‰“å…¥curl

<img src="6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430111415867.png" alt="image-20240430111415867" style="zoom:40%;" />

æ‰¾åˆ°å®˜æ–¹Dockerfile

![image-20240430111455112](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430111455112.png)



å°±åœ¨Dockerfileæ–‡ä»¶çš„åŒçº§ç›®å½•ä¸‹æ‰¾åˆ°è¿™ä¸ªtaråŒ…

<img src="6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430111554714.png" alt="image-20240430111554714" style="zoom:45%;" />

ç»“æœæ˜¯ä¸ªè½¯è¿æ¥ï¼Œæ‰¾åˆ°æ­£ä¸»ï¼Œ

![image-20240430111638421](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430111638421.png)

å¤åˆ¶Rawè¿›è¡Œä¸‹è½½

downä¸‹æ¥

![image-20240430111724344](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430111724344.png)

è§£å‹

![image-20240430111758101](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430111758101.png)

å¹¶å°†åŸå‹ç¼©åŒ…ç§»å…¥ä¸Šå±‚ç›®å½•ï¼Œå¾…ä¼šä¼šç”¨é‡Œé¢çš„libåº“åšä¿®æ­£

è¿›å…¥binåˆ é™¤sh ls findä»¥å¤–çš„æ‰€æœ‰æ–‡ä»¶

![image-20240430111945922](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430111945922.png)



å¤åˆ¶curlä»¥åŠå…¶ä¾èµ–çš„åº“

![image-20240430112039319](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430112039319.png)

![image-20240430112151552](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430112151552.png)

![image-20240430112202798](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430112202798.png)

æ­¤æ—¶libé‡Œçš„ä¸œè¥¿æœ‰ä¸€ä¸ªshä¾èµ–çš„libc.so.6ä¹Ÿè¢«curlçš„ä¾èµ–è¦†ç›–äº†ï¼Œcurlçš„ä¾èµ–æ˜¯ä»å®¿ä¸»å¤åˆ¶è¿‡å»çš„ã€‚æ‰€ä»¥è¦è¿˜åŸï¼Œå¦åˆ™å®¹å™¨é‡Œçš„shç”¨ä¸äº†ï¼Œè¿å®¹å™¨éƒ½å¯åŠ¨ä¸äº†

![image-20240430112433456](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430112433456.png)

è¦†ç›–å›å»

![image-20240430112510064](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430112510064.png)



æ‰“åŒ…

![image-20240430112641935](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430112641935.png)

ç¼–å†™Dockerfile

buildåå†runå°±æå®šäº†

![image-20240430112827154](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430112827154.png)

![image-20240430113538875](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430113538875.png)

è´ªç‹¼ï¼Œä¸è®¡åæœï¼Œå‹‡å¾€ç›´å‰ï¼Œå¥½å§ï¼Œå°±æ˜¯å¥½ç´¯ã€‚

ä»¥ä¸Šå°±æ˜¯å®Œæˆäº†ä¸€ä¸ªbusyboxçš„OSå®šåˆ¶ï¼Œæ‰“å…¥curlå’Œå»æ‰Nå¤šcliçš„æ“ä½œã€‚ä¸è¿‡ä¸€èˆ¬ä¸ä¼šè¿™ä¹ˆåšçš„ï¼Œè¿™é‡Œåªæ˜¯æˆ‘çš„ä¸€ä¸ªæ“ä½œæ’é”™çš„è®°å½•è€Œå·²ï¼Œå­˜æ€è·¯éªŒè¯è¿‡ç¨‹ã€‚ä¹Ÿç®—å®Œæˆäº†



è¿™é‡Œè®°å½•ä¸‹imageså¤§å°ï¼Œå›å¤´ç”¨æ­£è§„æ–¹å¼å°†curlå°è£…è¿›busyboxï¼Œå†çœ‹çœ‹é‚£æ—¶çš„é•œåƒå¤§å°

![image-20240430113909039](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430113909039.png)

```shell
# å®¿ä¸»æœºä¸Šç¼–è¯‘å®‰è£…curl

wget https://curl.se/download/curl-8.7.1.tar.xz && \
    tar -xJf curl-8.7.1.tar.xz && \
    cd curl-8.7.1 && \
    ./configure --prefix=/opt/curl-static --enable-static --disable-shared  --with-ssl && \
    make && \
    make install


./configure --prefix=/usr/local/curl --disable-shared --enable-static --without-libidn --without-ssl --without-librtmp --without-gnutls --without-nss --without-libssh2 --without-zlib --without-winidn --disable-rtsp --disable-ldap --disable-ldaps --disable-ipv6

# ä»¥ä¸Šè¿˜ä¸æ˜¯å®Œå…¨é™æ€ç¼–è¯‘ï¼Œå¤åˆ¶åˆ°å®¹å™¨é‡Œè¿˜æ˜¯ç¼ºåº“
```

æˆ‘è§‰å¾—è¿˜æ˜¯åº”è¯¥æ‰¾ä¸€ä¸ªbinäºŒè¿›åˆ¶çš„ç‹¬ç«‹æ–‡ä»¶ï¼Œæˆ–lddå‡ºæ¥æ”¾å¥½ï¼Œbuildçš„æ—¶å€™COPYè¿›å»ã€‚



### æ–¹æ³•2ï¼šåˆ«äººçš„é•œåƒå¢åŠ ä¸€ä¸ªè½¯ä»¶ï¼Œlddä¹Ÿæ˜¯å…³é”®

**ä¸Šé¢çš„ç¼–è¯‘è€æ˜¯ä¾èµ–å…±äº«åº“ï¼Œç®—äº†ï¼Œæˆ‘ç›´æ¥lddå¼„ä¸€ä¸ªå‡ºæ¥å¾—äº†**

```shell

cd /data/dockerfile/os/busybox-curl/curl-static

# å¤åˆ¶å‡ºcurlçš„æ‰€æœ‰ä¾èµ–åº“
ldd `which curl` |awk -F '=>' '{print $2}' |awk -F '(' '{print $1}' |grep -E '/' |xargs -i bash -c 'cp -L {} ./'

mkdir lib
mv * lib

# å¤åˆ¶curlçš„binæ–‡ä»¶
mkdir bin
cp -L `which curl` lib

```

å¾—åˆ°ğŸ‘‡

![image-20240430145854982](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430145854982.png)

ç„¶åç¼–å†™Dockerfile

```shell
# ä½¿ç”¨ BusyBox åŸºç¡€é•œåƒ
FROM busybox

# å¤åˆ¶ç¼–è¯‘å¥½çš„ curl ç›®å½•åˆ°é•œåƒä¸­
COPY /curl-static /curl-static

# å°†curlçš„binæ–‡ä»¶å’Œåº“åˆå¹¶(ä¸è¦†ç›–çš„æ–¹å¼)è¿›å…¥é•œåƒçš„binå’Œlibé‡Œ
RUN cp -n /curl-static/bin/curl /bin/
RUn cp -n /curl-static/lib/* /lib/

# è®¾ç½®é»˜è®¤å‘½ä»¤
CMD ["sh"]
```

![image-20240430150946941](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430150946941.png)

æå®š

![image-20240430151014583](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430151014583.png)



### æ–¹æ³•3ï¼šä¸‹è½½ä¸€ä¸ªç‹¬ç«‹çš„binæ–‡ä»¶COPYè¿›å»

è¿™ç§æ›´ç®€å•ï¼Œå°±æ˜¯è¦æ‰¾åˆ°äººå®¶ä¸€ä¸ªbinæ–‡ä»¶å°±æ˜¯ç‹¬ç«‹çš„curlè¿™ç§ï¼Œall-in-oneå§

https://curl.se/download.html

æ‰¾åˆ°linuxç³»ç»Ÿä¸‹çš„binary

![image-20240430152404821](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430152404821.png)



![image-20240430152818634](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430152818634.png)

æå®š

![image-20240430152921492](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430152921492.png)





## LABELæŒ‡å®šé•œåƒå…ƒæ•°æ®

é•œåƒçš„è¯´æ˜ï¼šæ ‡ç­¾ã€ç‰ˆæœ¬ã€ä½œè€…ç­‰

```shell
#ä¸€è¡Œæ ¼å¼
LABEL multi.label1="valuel" multi.label2="value2" maintainer="oneyearice <oneyearice@gmail.com> other="value3"

#å¤šè¡Œæ ¼å¼
LABEL multi.label1="value1" \
	  multi.label2="value2" \
	  maintainer="oneyearice <oneyearice@gmail.com>" \
	  other="value3"
```

ä½œè€…çš„æŒ‡ä»¤æ—©æœŸæ˜¯

```shell
MAINTAINER <NAME>    # ç°åœ¨æ”¹æ‰äº†
LABEL maintainer="oneyearice <oneyearice@gmail.com>"
```





## RUNå‘½ä»¤

alpineé‡Œå®‰è£…å¸¸ç”¨å·¥å…·

![image-20240430160159876](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430160159876.png)

è¿™äº›é»˜è®¤æ²¡æœ‰ï¼Œç°åœ¨éœ€è¦å®‰è£…ä¸€ç‚¹ï¼Œè¿™ä¸ªæ¯”ä¸Šé¢busyboxé‡Œå®‰è£…curlè¦ç®€å•å¤šå’¯ã€‚

å…ˆæ›¿æ¢ä¸ºå›½å†…é•œåƒæº

![image-20240430160421794](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430160421794.png)

ç‚¹å‡»é—®å¥½å¾—åˆ°é•œåƒæºæ›¿æ¢ä¿¡æ¯

![image-20240430160504241](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430160504241.png)

å¤åˆ¶

```shell
sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories
```

å¥½åœ¨ä¸€èˆ¬linuxé‡Œæ²¡æœ‰vimä½†æ˜¯æœ‰sedå‘½ä»¤çš„ï¼Œalpineå®¹å™¨é•œåƒè‡ªç„¶æ˜¯sedå‘½ä»¤çš„ã€‚



ä¸Šé¢æ˜¯æ¸…åæºçš„ä½¿ç”¨ï¼Œæˆ‘ä¸‹é¢ç”¨ä¸­ç§‘å¤§çš„

https://mirrors.ustc.edu.cn/help/alpine.html

![image-20240430160750161](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430160750161.png)



```shell
sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
```

å…¶å®å¯ä»¥å…ˆrunä¸€ä¸ªalpineè¿›å»æ‰‹åŠ¨å®‰è£…çœ‹çœ‹ï¼Œè¿™æ ·æ¯”è¾ƒæ¸…æ¥šå…·ä½“è¿‡ç¨‹æ˜¯å¦ok

æ¯”å¦‚tcpingå…¶å®è¯´åˆ°åº•å°±æ˜¯tcptracerouteå†™å‡ºæ¥çš„è„šæœ¬ï¼Œä½ è‡ªå·±ä¹Ÿå¯ä»¥å†™å•ŠğŸ‘‡å†™å¥½äº†ï¼š

![image-20240430163016058](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430163016058.png)

```shell
FROM alpine:3.19.1
LABEL maintainer="oneyearice <oneyearice@gmail.com>"
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
# è·Ÿæ–°æºåå†å®‰è£…
# ä¸€ä¸ªRUNäº§ç”Ÿä¸€å±‚é•œåƒï¼Œ6ä¸ªå°±6å±‚é•œåƒï¼Œå±‚è¶Šå¤šï¼Œæ•ˆç‡è¶Šä½ï¼Œå‡å°‘å±‚çš„æ–¹å¼
RUN apk update
RUN apk add curl
RUN apk add vim
RUN apk add ss
RUN apk add telnet
RUN apk add tcptraceroute

# å°†ä¸Šé¢çš„6ä¸ªRUNåˆæˆä¸€ä¸ªRUNï¼Œå°±ä¸ä¼šæ‰“6å±‚é•œåƒäº†
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories && apk update && apk add curl vim tcptraceroute iproute2

```

apk update ç±»ä¼¼ ubuntuçš„apt update ä½†æ˜¯å®Œå…¨ä¸æ˜¯yum updateå“¦ï¼Œåˆ«æé”™å•¦ï¼Œå“ˆå“ˆã€‚

apk updateæ˜¯yum makecacheæ›´æ–°é•œåƒæº

apk upgradeæ˜¯yum updateï¼Œæ›´æ–°è½¯ä»¶

![image-20240430164009513](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430164009513.png)

apkç¡®å®å¥½æ¯”aptï¼Œè€Œaptçš„è€ç‰ˆæœ¬å°±æ˜¯apt-get

<img src="6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430164049841.png" alt="image-20240430164049841" style="zoom:50%;" />



searchä¸€ä¸‹telnetåŒ…åœ¨å“ªï¼Ÿ

![image-20240430170313069](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430170313069.png)

ä¹Ÿå¯ä»¥ç”¨busyboxé‡Œçš„telnet

![image-20240430170347651](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430170347651.png)

busyboxç‘å£«å†›åˆ€å•Šï¼Œè¿™ä¸ªå¼ï¼Œå¾ˆå¤šå‘½ä»¤éƒ½ä¸ç”¨æ‰¾ï¼Œç›´æ¥busyboxï¼Œä¸è¿‡alpineå°±æ˜¯åˆ©ç”¨çš„busybox

![image-20240430170849758](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430170849758.png)

å½“ç„¶ä¸æ˜¯FROM busyboxè€Œæ˜¯å®šåˆ¶çš„taråŒ…

<img src="6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430170915413.png" alt="image-20240430170915413" style="zoom:50%;" />





telnet å¦‚æœä¸ç”¨busyboxå°±ç”¨searchåˆ°çš„ï¼Œä¸è¿‡è¦å»æ‰åé¢çš„ç‰ˆæœ¬å¥½ä¹‹ç±»çš„

![image-20240430171347329](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430171347329.png)





```shell
FROM alpine:3.19.1
LABEL maintainer="oneyearice <oneyearice@gmail.com>"
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories
# è·Ÿæ–°æºåå†å®‰è£…
# ä¸€ä¸ªRUNäº§ç”Ÿä¸€å±‚é•œåƒï¼Œ6ä¸ªå°±6å±‚é•œåƒï¼Œå±‚è¶Šå¤šï¼Œæ•ˆç‡è¶Šä½ï¼Œå‡å°‘å±‚çš„æ–¹å¼
RUN apk update
RUN apk add curl
RUN apk add vim
RUN apk add ss
RUN apk add busybox
RUN apk add tcptraceroute

# å°†ä¸Šé¢çš„6ä¸ªRUNåˆæˆä¸€ä¸ªRUNï¼Œå°±ä¸ä¼šæ‰“6å±‚é•œåƒäº†
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories && apk update && apk --no-cache add curl vim busybox tcptraceroute iproute2

# ä½†æ˜¯å¦‚æœä¸€å±‚ï¼Œå°†æ¥é•œåƒå¤ç”¨è¿˜èƒ½å¤ç”¨å¾—åˆ°å—ï¼Ÿå¦‚æœå°†RUNçš„æ›¿æ¢é•œåƒæºã€å„ä¸ªå·¥å…·çš„å®‰è£…éƒ½å•è¡Œæ¥å†™ï¼Œå°†æ¥æ˜¯ä¸æ˜¯å…¶ä»–é•œåƒä¹Ÿèƒ½æ›´å¥½çš„å¤ç”¨å‘¢ï¼Œå¦åˆ™ä¸Šé¢è™½ç„¶æ•´åˆæˆä¸€æ¡RUNï¼Œä½†æ˜¯ä¸€ä¸ªåˆ†å±‚ï¼Œåˆ«äººå¦‚ä½•å¤ç”¨å‘¢ï¼Ÿ

# å¸¸è§„ä½¿ç”¨ä¸Šæ¥è€ƒè™‘è¿˜æ˜¯å†™æˆä¸€ä¸ªRUNæ¯”è¾ƒå¥½ï¼Œä¸åŒåŸºç¡€é•œåƒçš„å·¥å…·ä¹Ÿä¸å¤ªå¯èƒ½å¤ç”¨ï¼Œè€Œä¸”å¤ç”¨é‡Œé¢åˆ°åº•æ€ä¹ˆå¤ç”¨çš„ä¹Ÿä¸æ˜¯å¾ˆæ¸…æ¥šæ¯”å¦‚UinonFS(overlay2)ã€‚



```

![image-20240430172901141](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430172901141.png)

æ‰€ä»¥ä½ å†™åœ¨Dockerileé‡Œçš„RUN apk add xx xxx xxx xx å¦‚æœå‰é¢æ²¡æœ‰è¿™ä¸ªåŒ…ï¼Œå°±ç›´æ¥æŠ¥é”™äº†ã€‚

æ²¡åŠæ³•åªèƒ½å…ˆrunä¸€ä¸ªè¿›å»å®‰è£…æˆåŠŸäº†ï¼Œå†å†™é“Dockerfileé‡Œäº†ã€‚



apkæ²¡æœ‰ç±»ä¼¼ubuntué‡Œçš„apt cleanè¿™ä¸ªå‘½ä»¤ï¼Œæ‰€ä»¥è¦ç”¨apk --no-cacheæ¥å®‰è£…è½¯ä»¶ï¼Œè¿™æ ·å®‰è£…åå®‰è£…åŒ…å°±ä¼šè‡ªåŠ¨åˆ é™¤ã€‚ç®€ç§°ä¸ç¼“å­˜å®‰è£…ä¿¡æ¯ã€‚å‡å°‘é•œåƒçš„ç©ºé—´ã€‚

![image-20240430173319162](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430173319162.png)



å¯ä»¥å‚è€ƒåˆ«äººçš„å®‰è£…å·¥å…·é›†

![image-20240430174826254](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430174826254.png)



### ä¸€ä¸ªè‡ªç”¨çš„alpine:Dockerfile

ç»è¿‡ä¸Šé¢çš„ä¸æ–­æ ¡å¯¹ï¼Œä¸‹é¢å°±æ˜¯ä¸€ä¸ªç›¸å¯¹å®Œå–„çš„Dockerfileå•¦

```shell
FROM alpine:3.19.1
LABEL maintainer="oneyearice <oneyearice@gmail.com>"

# è·Ÿæ–°æºåå†å®‰è£…
RUN sed -i 's/dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g' /etc/apk/repositories && apk update && apk --no-cache add tzdata && ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && echo "Asia/Shanghai" > /etc/timezone && apk update && apk --no-cache add iotop gcc libgcc libc-dev libcurl libc-utils pcre-dev zlib-dev libnfs make pcre pcre2 zip unzip net-tools pstree wget libevent libevent-dev iproute2 vim curl tcptraceroute busybox-extras tcpdump

```

èµ¶å¿«å»è¯•è¯•å§

![image-20240430181443839](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430181443839.png)

build ç°å¸¸é¡ºåˆ©

![image-20240430181515081](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430181515081.png)

runèµ·æ¥çœ‹çœ‹

![image-20240430181703008](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430181703008.png)

ä¸€äº›ä¾èµ–pythonçš„å¯èƒ½ç”±äºpyæ²¡è£…å¥½å°±æŠ¥é”™ï¼Œå…¶ä»–è¿˜æ˜¯okçš„ğŸ‘†è¿™ä¸ªèŠ‚åå†æŠ˜è…¾ï¼Œæ— æ‰€è°“äº†~

æŠ“åŒ…ä¹Ÿæ˜¯okçš„

![image-20240430182034237](6-Dockerè‡ªåŠ¨åˆ¶ä½œé•œåƒå¸¸è§æŒ‡ä»¤è¯´æ˜.assets/image-20240430182034237.png)





