# ç¬¬5èŠ‚ Dockeré…ç½®ä¼˜åŒ–





docker å·¥ä½œæ˜¯åŸºäºé•œåƒï¼Œè€Œé•œåƒå­˜å‚¨çš„é©±åŠ¨ï¼Œé€šè¿‡docker infoå¯è§æ˜¯overlay2ã€‚

<img src="5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401113801442.png" alt="image-20240401113801442" style="zoom:50%;" />



![image-20240401114202132](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401114202132.png)



è¿™äº›å­˜å‚¨å¼•æ“ä¸ç®¡æ˜¯é‚£ç§ï¼Œéƒ½æ˜¯**è”åˆæ–‡ä»¶ç³»ç»Ÿ**

![image-20240401114700537](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401114700537.png)

æ¯”å¦‚ext4 xfsçš„æ–‡ä»¶ç³»ç»Ÿï¼Œç£ç›˜æŒ‚è½½åˆ°ç›®å½•ï¼Œæ˜¯ä¸å¯ä»¥é‡å¤æŒ‚è½½çš„ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç›®å½•ä½ ä¸¤ä¸ªç¡¬ç›˜æŒ‚è½½çš„æ—¶å€™ï¼Œå‰é¢ä¸€ä¸ªå°±è¢«é¡¶æ‰äº†ã€‚

è€Œdockerçš„è”åˆæ–‡ä»¶ç³»ç»Ÿæ—¶å¯ä»¥æŠŠå¤šä¸ªè®¾å¤‡(æ‰€è°“è®¾å¤‡å°±æ˜¯ç¡¬ç›˜ã€åˆ†åŒºã€lvmè¿™äº›)æŒ‚è½½åˆ°ä¸€ä¸ªç›®å½•ä¸‹ï¼Œå…¶æ•ˆæœå°±æ˜¯è¿™ä¸ªç›®å½•ä¸‹æ—¢å¯ä»¥çœ‹åˆ°è®¾å¤‡1ä¸Šçš„æ•°æ®ï¼Œä¹Ÿèƒ½çœ‹åˆ°è®¾å¤‡2ä¸Šçš„æ•°æ®ã€‚

â€‹		ä¸ºä»€ä¹ˆå¯ä»¥é‡‡ç”¨è”åˆæ–‡ä»¶ç³»ç»Ÿï¼Œå°±æ˜¯å› ä¸ºdockerçš„imageæ˜¯å¤šå±‚é•œåƒã€‚

![image-20240401115713714](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401115713714.png)

imageæ˜¯ä¸€å±‚å±‚æ„å»ºå‡ºæ¥çš„

å®¹å™¨ç”Ÿæˆï¼Œæ˜¯å¤åˆ¶ä¸€ä»½é•œåƒï¼Œå¹¶åœ¨å…¶ä¸Šåˆæ·»åŠ äº†ä¸€å±‚writableå¯è¯»å¯å†™å±‚ï¼Œè¿™å±‚å°±ç”¨æ¥å­˜æ”¾å®¹å™¨è‡ªå·±çš„æ•°æ®--æ¯”å¦‚LOGã€‚

docker stop xxx ï¼Œå°±æ˜¯æŠŠå¤åˆ¶è¿‡æ¥çš„imageå±‚åˆ äº†ï¼Œå…¶ä¸Šçš„å®¹å™¨å­æ·±æ·±çš„writableå±‚è¿˜åœ¨çš„ã€‚

![image-20240401120512888](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401120512888.png)



å®¹å™¨å¯åŠ¨çš„æ—¶å€™å…¶å®æ˜¯å¯ä»¥ä¿®æ”¹å­˜å‚¨é©±åŠ¨çš„

![image-20240401133623870](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401133623870.png)

ä¸è¿‡ï¼Œæƒ³æ¥ä¸€èˆ¬æ˜¯ä¸ä¼šå»æ”¹çš„ã€‚ç¡®è®¤æ˜¯overlay2å°±è¡Œäº†ã€‚ä¸‡ä¸€ä¸æ˜¯å°±æ¢dockerç‰ˆæœ¬~

æŸ¥çœ‹æ”¯æŒçš„æ–‡ä»¶ç³»ç»ŸğŸ‘‡æ³¨æ„aufsæ˜¯aufsï¼Œautofsæ˜¯autofsï¼Œä¸è¦çæ

![image-20240401134116982](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401134116982.png)



# dockerä¼˜åŒ–

## ä¸‹è½½æºï¼Œå…¶å®åº”è¯¥ç§æœ‰åº“ä½œç¼“å­˜æ¥å¼„æ¯”å¦‚nexus

å¯ä»¥ä½¿ç”¨é˜¿é‡Œçš„ä¸ªäººé•œåƒåŠ é€Ÿåœ°å€

![image-20240401135538590](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401135538590.png)



![image-20240401140127212](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401140127212.png)



å…¶å®æœ€å¥½æ˜¯ç”¨ç§æœ‰ç¼“å­˜åº“æ¯”å¦‚nexushttps://cloud.tencent.com/developer/article/1764866



### socketé€šä¿¡-docker-clientå’Œserverä¹‹é—´çš„é€šä¿¡

![image-20240401142344030](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401142344030.png)

é»˜è®¤èµ°çš„æœ¬åœ°socketæ–‡ä»¶ï¼Œæ— æ³•æ”¯æŒè¿œç«¯çš„è°ƒç”¨ã€‚

é…ç½®æ–¹æ³•ğŸ‘‡ä¸‹å›¾ç»¿æ¡†æ¡†ï¼›ä½†æ˜¯ç”¨çš„ä¸å¤ªå¤šã€‚ä¸€èˆ¬å°±æ˜¯æœ¬åœ°è¿æ¥ã€‚

![image-20240401142523157](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401142523157.png)

è¯¥é…ç½®æ–‡ä»¶ç±»ä¼¼clié‡Œçš„-Hé€‰é¡¹ï¼Œæ—¢æœ‰socketæ–‡ä»¶ä¹Ÿæœ‰tcpï¼Œå¯èƒ½å°±æ˜¯å†™ä¸¤ä¸ª-Hå’¯

![image-20240401143339943](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401143339943.png)

è¿˜å¯ä»¥æ”¹serviceæ–‡ä»¶

![image-20240401143508966](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401143508966.png)



**å…ˆé€šè¿‡ä¿®æ”¹daemon.jsonå»è¯•ä¸‹**

![image-20240401165325655](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401165325655.png)

ä½†æ˜¯æŠ¥é”™äº†ğŸ‘†



**æ¢ä¸ªæ€è·¯ï¼Œå»serviceæ–‡ä»¶é‡Œæ”¹æ”¹**

![image-20240401170558409](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401170558409.png)

ç„¶åæŠŠdaemon.jsoné‡Œçš„hostsé‚£è¡Œåˆ äº†ï¼Œä¿®æ”¹ä¸º

<img src="5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402171915073.png" alt="image-20240402171915073" style="zoom:50%;" />

å†reload å’Œ restart

![image-20240401172813797](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401172813797.png)

æ­¤æ—¶tcpå’Œsocketæ–‡ä»¶éƒ½å¥½äº†

![image-20240401172847800](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401172847800.png)



![image-20240401173610011](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240401173610011.png)





æ­¤æ—¶å°±å¯ä»¥è¿œç«¯client è°ƒç”¨ server äº†ï¼Œä¹Ÿå°±æ˜¯docker cli è¿æ¥ docker serverå¼•èµ·å è°ƒç”¨å‘½ä»¤äº†

![image-20240402173332905](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402173332905.png)

ç„¶åè¿œç¨‹è·‘ä¸€ä¸ªnginxçœ‹çœ‹ï¼Œæ­¤æ—¶å®¹å™¨éƒ½æ˜¯é€€å‡ºçš„

![image-20240402173559934](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402173559934.png)

å»è¿œç«¯windowsçš„cmdé‡Œæ‰§è¡Œè¿œç¨‹cliï¼Œrunä¸€ä¸ªnginx

![image-20240402173718678](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402173718678.png)

ç„¶åå»serverçœ‹ä¸‹docker ps

![image-20240402173933777](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402173933777.png)

è¿™å°±å®ç°äº†è¿œç¨‹æ‰§è¡Œdocker cli

åŒæ—¶curl ç§ç§ï¼Œå› ä¸ºæ˜¯å®¹å™¨é‡Œçš„ipæ²¡æœ‰æš´éœ²å‡ºæ¥å‘¢ï¼Œæ‰€ä»¥ipsectçœ‹åˆ°ipåå®¿ä¸»æœºä¸Šcurlä¸‹ğŸ‘‡

![image-20240402174041031](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402174041031.png)

è¦æ³¨æ„docker engineä¹Ÿå°±æ˜¯æœåŠ¡ç«¯åœ¨å“ªï¼Œå®¹å™¨å°±è¿è¡Œåœ¨å“ªé‡Œï¼Œå®¢æˆ·éƒ½çš„cliåªæ˜¯ä¸€ä¸ªè¿æ¥è°ƒç”¨å·¥å…·ï¼Œå¾ˆå¥½ç†è§£ï¼Œå¥½æ¯”mysql è¿œç¨‹æ‰§è¡Œå‘½ä»¤ä¸€æ ·ã€‚



å°†æ¥åœ¨K8Sé‡Œçš„è·¨ä¸»æœºçš„è¿œç¨‹dockerè°ƒç”¨å¯èƒ½å°±æ˜¯ç”¨çš„è¿™ä¸ªã€‚ç›®å‰dockerå­¦ä¹ é˜¶æ®µè¿˜ç”¨ä¸åˆ°ã€‚

<img src="5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402180552713.png" alt="image-20240402180552713" style="zoom:50%;" />



<img src="5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402180924506.png" alt="image-20240402180924506" style="zoom:50%;" />



çœ‹æ¥æ˜¯æŸ¥ä¸åˆ°å°±å¾€ä¸‹ä¸€ä¸ªåœ°å€æŸ¥æ‰¾ã€‚



ç°åœ¨éƒ½æ˜¯systemdäº†ğŸ‘‡<img src="5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402181155813.png" alt="image-20240402181155813" style="zoom:55%;" />

ä¸ç”¨æ”¹äº†ï¼Œä»¥å‰æ˜¯è¿™ä¹ˆæ”¹çš„ğŸ‘‡ä¹Ÿæ˜¯daemon.jsoné‡Œ

<img src="5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402181223650.png" alt="image-20240402181223650" style="zoom:80%;" />







### è¿˜æœ‰è¿™ä¸ªå®¹å™¨å’Œé•œåƒå­˜æ”¾çš„è·¯å¾„-è¿ç§»å°±æ˜¯å¤åˆ¶ç²˜è´´è¯¥è·¯å¾„

![image-20240402181409786](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240402181409786.png)

é»˜è®¤æ˜¯è¿™é‡ŒğŸ‘†ï¼Œè¿™ä¹ˆæ”¹ğŸ‘‡æ”¹åˆ°å•ç‹¬çš„é«˜æ€§èƒ½ssdä¸Šå»ï¼Œå‰æ–‡è®²è¿‡äº†ï¼Œç›®å½•ä¸è¯¥ç›´æ¥æŒ‚åˆ°æ–°ç£ç›˜ä¸Šå»ï¼Œæˆ–è€…è¯¥ç›®å½•è¿™ä¸ªç›®å½•æŒ‚è¿‡å»ä¹Ÿè¡ŒğŸ‘‡

åœ¨æ—§ç‰ˆæœ¬çš„ Docker ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ `"graph"` æŒ‡å®š Docker å­˜å‚¨å®¹å™¨å’Œé•œåƒçš„è·¯å¾„ã€‚ä½†æ˜¯åœ¨è¾ƒæ–°çš„ Docker ç‰ˆæœ¬ä¸­ï¼Œè¯¥é€‰é¡¹å·²è¢«åºŸå¼ƒï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ `data-root`ã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥å°è¯•å°† `"graph":"/data/docker"` æ›¿æ¢ä¸º `"data-root":"/data/docker"`ã€‚

ä¿®æ”¹åçš„é…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

```
jsonCopy code{
  "registry-mirrors":["https://si7y70hh.mirror.aliyuncs.com/"],
  "data-root":"/data/docker"
}
```

ä¿®æ”¹å®Œæˆåä¿å­˜æ–‡ä»¶ï¼Œå¹¶å°è¯•é‡æ–°å¯åŠ¨ Docker æœåŠ¡ã€‚æ‚¨å¯ä»¥æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```shell
bashCopy codesystemctl daemon-reload
systemctl restart docker
```

è¿˜å¯ä»¥åœ¨serviceæ–‡ä»¶é‡Œé…ç½®

![image-20240403094352046](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240403094352046.png)

systemctl daemon-reloadä¸‹ï¼Œå†é‡å¯ä¸€ä¸‹systemctl restart docker

æ­¤æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–‡ä»¶å¤¹ï¼Œä½†æ˜¯docker imagesé‡Œæ˜¯ç©ºçš„äº†ï¼Œdocker ps -aä¹Ÿæ˜¯ç©ºçš„ï¼Œä¹‹å‰é€€å‡ºçš„é‚£äº›å®¹å™¨éƒ½æ²¡äº†ã€‚

![image-20240403094723888](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240403094723888.png)

åŸæ¥çš„å®¹å™¨å’Œé•œåƒçš„æ–‡ä»¶éƒ½æ²¡è¿‡å»

![image-20240403095136140](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240403095136140.png)

![image-20240403095416380](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240403095416380.png)



### max-concurrent-dowload|uploadï¼ŒåŒæ—¶æ‹‰å»å’Œä¸Šä¼ çš„é™åˆ¶

![image-20240407160040343](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407160040343.png)

è¿™ä¸ªæ“ä½œä¼šæ¶‰åŠmax-concurrent-dowloadå‚æ•°çš„é™åˆ¶ï¼Œä½†ä¸æ˜¯å®Œå…¨æ¶‰åŠï¼Œå¦‚æœimagesåœ¨æœ¬åœ°å°±ä¸ç”¨æ‹…å¿ƒï¼ŒçŸ¥è¯†é™åˆ¶äº†å’Œdocker ä»“åº“ä¹‹é—´çš„ä¸‹è½½/ä¸Šä¼ çš„å¹¶å‘æ•°ã€‚





### æ—¥å¿—çš„é—®é¢˜

1ã€å®¹å™¨çš„æ—¥å¿—éƒ½æ˜¯é»˜è®¤æ”¾åœ¨ç¡¬ç›˜ä¸Šçš„

2ã€æ—¥å¿—çš„å¤§å°è¦é™åˆ¶ä¸‹

3ã€æ—¥å¿—æ–‡ä»¶ä¹Ÿæ˜¯è½åœ¨å®¹å™¨å’Œé•œåƒå­˜æ”¾çš„è·¯å¾„/var/lib/dockerä¸‹çš„

é€šè¿‡docker infoå¯è§ï¼ŒğŸ‘‡å½“ç„¶æˆ‘çš„è·¯å¾„æ”¹è¿‡çš„

![image-20240407162310329](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407162310329.png)

logå°±åœ¨docker rootä¸‹çš„containeræ–‡ä»¶å¤¹é‡Œçš„æ¯ä¸ªå®¹å™¨æ–‡ä»¶å¤¹é‡Œã€‚

![image-20240407162632176](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407162632176.png)



![image-20240407162713268](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407162713268.png)

é™åˆ¶é…ç½®

![image-20240407162944133](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407162944133.png)

æ—¥å¿—çš„æœ€å¤§å€¼å’Œæ»šåŠ¨è¦†ç›–ğŸ‘†



### dockeræ—¥å¿—è¶Šæ¥è¶Šå¤§æŠŠç¡¬ç›˜æ’‘æ»¡äº†ï¼Œå¦‚ä½•è§£å†³

1ã€ä¸Šå›¾ğŸ‘†é™åˆ¶+æ»šåŠ¨æ—¥å¿—

2ã€dockerä¹Ÿæ˜¯åœ¨å®¹å™¨å’Œé•œåƒçš„ç›®å½•ä¸‹çš„ä¹Ÿå°±æ˜¯/var/lib/docker/ï¼Œå°†è¿™ä¸ªç›®å½•æŒ‚åˆ°å•ç‹¬çš„ç£ç›˜å°±è¡Œäº†ã€‚

3ã€[å‘¨æœŸæ¸…é™¤æ— ç”¨çš„é•œåƒå’Œå®¹å™¨ğŸ‘‡](#1)



curlä¼ªè£…æµè§ˆå™¨ï¼Œä¹Ÿå°±æ˜¯ä¼ªè£…è®¿é—®æ–¹å¼-Aå¯ä»¥-Hä¹Ÿè¡Œ

![image-20240407171220746](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407171220746.png)





### å®éªŒ

#### 1ã€å…ˆè·‘ä¸€ä¸ªnginx

![image-20240407171513771](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407171513771.png)



#### 2ã€ç„¶åcurlè®¿é—®è¿™ä¸ªå®¹å™¨çš„ip![image-20240407171550512](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407171550512.png)

![image-20240407171619823](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407171619823.png)



<img src="5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407171633114.png" alt="image-20240407171633114" style="zoom:50%;" />



![image-20240407171727841](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407171727841.png)



è¿™å°±ä½¿ç”¨curl ä¼ªè£…äº†ä¸€ä¸ªç”¨æˆ·è®¿é—®æ–¹å¼--user-agent



#### 3ã€æ‰¾åˆ°æœ‰è¯¥user-agentå…³é”®è¯çš„æ—¥å¿—

æ€»ä¹‹å°±åœ¨è¿™äº›æ–‡ä»¶é‡Œ

![image-20240407172254206](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407172254206.png)

å¾ˆè´±çš„grep -rå°±è¡Œäº†ï¼Œä¸è¦ç”¨-R

![image-20240407173417843](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407173417843.png)

-Ræ˜¯ä¼šç»§ç»­æœç´¢è½¯è¿æ¥çš„ï¼Œæ¯”å¦‚ä¸Šå›¾çš„ç¬¬ä¸€ä¸ªNo such file or directoryå°±æ˜¯ä¸€ä¸ªln -sğŸ‘‡è¿™ç§æœç´¢ä¸€èˆ¬æ²¡å¿…è¦

![image-20240407173521193](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407173521193.png)

![image-20240407180954931](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407180954931.png)

å°†æ¥æ—¥å¿—ä¼šè¶Šæ¥è¶Šå¤§ï¼Œè€Œä¸”ä¸ä»…ä»…æ—¥å¿—ï¼Œimageså’Œå®¹å™¨ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œä¹‹å‰çš„å¤„ç†æ–¹å¼æœ‰ä¸€ç§(æ˜¯åœ¨runnerä¸Šçš„æ“ä½œå¯èƒ½ä¼šç®€å•çš„ï¼‰ï¼Œ

<span id=1>æ¸…é™¤æ— ç”¨çš„é•œåƒå®¹å™¨æ…ç”¨</span>

![image-20240407181257657](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407181257657.png)



### live-restore

![image-20240407183134092](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407183134092.png)



å¦‚æœdockeræœåŠ¡é‡å¯äº†ï¼Œå®¹å™¨ä¼šä¸ä¼šé‡å¯ï¼Ÿä¸ä¼šï¼Œdockeré‡å¯ï¼Œå®¹å™¨å°±åœæ‰äº†ğŸ‘‡![image-20240407184241248](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240407184241248.png)



![image-20240408092457691](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240408092457691.png)



![image-20240408092652340](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240408092652340.png)

åä¹‹åˆ é™¤é…ç½®æ–‡ä»¶é‡Œçš„live-restoreï¼Œé‡å¯dockeråï¼Œæ‰€æœ‰å®¹å™¨å°±åœäº†

<img src="5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240408092839909.png" alt="image-20240408092839909" style="zoom:50%;" />

![image-20240408092903232](5.Dockeré…ç½®ä¼˜åŒ–.assets/image-20240408092903232.png)







