# 3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.md





```bash
[root@server keepalived-2.3.2]# vim /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.126.100/24  # å°†vipæ”¹åˆ°æ­£ç¡®çš„ç½‘æ®µé‡Œï¼Œç„¶åä¸åŠ /24é»˜è®¤å°±æ˜¯/32çš„ã€‚
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}


```

ç½‘å¡ä¸€èˆ¬è§„åˆ’æ˜¯ä¸€å°æœåŠ¡å™¨3å—ç½‘å¡

![image-20241216180145623](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241216180145623.png)

ä¸€ä¸ªå¯¹å¤–ã€ä¸€ä¸ªå¯¹å†…ã€ä¸€ä¸ªåšå¿ƒè·³çº¿

VIPä¸€èˆ¬æ˜¯å¯¹å¤–ä½œä¸ºä¸šåŠ¡æ‰¿æ¥çš„ï¼Œä¸è¿‡ä¹Ÿå¯ä»¥å‘ç½‘ç»œé‡Œç”¨æ¥åšå†…éƒ¨çš„ç½‘å…³ï¼Œä¸è¿‡åœ¨linux APPè¿ç»´ä½“ç³»é‡ŒVIPè‚¯å®šæ˜¯å¯¹å¤–äº†ï¼Œè°ç”¨linuxåšè·¯ç”±å™¨å•Šï¼Œè¯¶ï¼Œç­‰ç­‰ï¼Œä¸å¥½è¯´å“¦ï¼Œå“ˆå“ˆã€‚





å…¶å®ä¹ŸæŒºç®€å•çš„ï¼Œå°±æ˜¯å®‰è£…åï¼Œé…ç½®ç®€åŒ–ä¸‹ï¼Œç„¶åæˆ‘æ˜¯rockyä¹Ÿä¸ç”¨ç®¡ä»€ä¹ˆvrrp_strictï¼ŒVIPå°±æ˜¯é€šçš„ï¼Œç„¶åçœ‹çœ‹MACçš„åˆ‡æ¢ä¹Ÿæ˜¯ä¸æ»‘çš„

<img src="3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217113938982.png" alt="image-20241217113938982" style="zoom:50%;" />

126.100çš„MACä»ä¸€å°keepalivedæœºå™¨å˜æˆäº†å¦ä¸€å°äº†ğŸ‘†



![image-20241217114103103](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217114103103.png)

![image-20241217114041221](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217114041221.png)





## ç‹¬ç«‹çš„å¿ƒè·³çº¿é…ç½®

ç‹¬ç«‹çš„å¿ƒè·³çº¿ï¼Œæ„å‘³ç€VIPä¹Ÿè¦ç»‘åˆ°ç‹¬ç«‹çš„æ¥å£äº†

```bash
[root@server keepalived-2.3.2]# vim /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

vrrp_instance VI_1 {
    state MASTER  # ä¹Ÿå°±æ˜¯æ ‡è¯†ä¸€ä¸‹ï¼Œä»¥åçœŸæ­£çš„MASTERéƒ½æ˜¯ä¼˜å…ˆçº§ç«é€‰å‡ºæ¥çš„
    interface eth0
    virtual_router_id 51
    priority 100  # ä¼˜å…ˆçº§æ¯”å¤§
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}


```

![image-20241217140734959](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217140734959.png)





**å¿ƒè·³çº¿ç‹¬ç«‹ç½‘å¡ğŸ‘‡ç„¶åè®¾ç½®ä¼˜å…ˆçº§ï¼Œé»˜è®¤å°±æ˜¯å¼€å¯æŠ¢å çš„**

```shell
#MASTERä¸Š

! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

vrrp_instance VI_1 {
    state MASTER
    interface eth1  # å¿ƒè·³ç½‘å¡
    virtual_router_id 51
    priority 120
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}


#SLAVEä¸Š

! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

vrrp_instance VI_1 {
    state SLAVE
    interface eth1  # å¿ƒè·³ç½‘å¡
    virtual_router_id 51
    priority 100
    advert_int 1  # å¿ƒè·³ç»„æ’­å‘é€æ—¶é—´ï¼Œæ£€æµ‹æ—¶é—´1sä¹Ÿæ˜¯é»˜è®¤å€¼ã€‚
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}

```

![image-20241217142739354](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217142739354.png)

æ­¤æ—¶å¿ƒè·³å°±ç‹¬ç«‹æ¥å£å‘é€äº†ğŸ‘†



linux arpçœ‹æ³•-nè¾ƒå¥½

![image-20241217143729061](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217143729061.png)



### è„‘è£‚

å¿ƒè·³çº¿å‰ªæ‰ å°±è„‘è£‚äº†ï¼›

è®¤è¯å¯†ç ä¸ä¸€è‡´ï¼Œä¹Ÿè„‘è£‚äº†ï¼›

interface eth1  ï¼Œå¦ä¸€ä¸ªé…ç½®interface eth0 å°±è„‘è£‚äº†ï¼›

ä¸€æ—¦è„‘è£‚ï¼Œå¯¹äºclientç«¯æ¥è®²ï¼Œå°±æ˜¯ä¸¤ä¸ªä¸€æ ·çš„IPåœ°å€å­˜æ´»äº†ï¼Œå¯èƒ½å¯¼è‡´ä¸šåŠ¡ä¸é€šã€‚





## keepaliveçš„æ—¥å¿—ç‹¬ç«‹å¤„ç†

é»˜è®¤å°±æœ‰æ—¥å¿—çš„ï¼Œåœ¨/var/log/messageé‡Œçš„

![image-20241217162044308](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217162044308.png)



ç‹¬ç«‹å‡ºæ¥

```bash
# ä¿®æ”¹logè®¾å¤‡æ˜¯æ—¥å¿—ç‹¬ç«‹å‡ºæ¥
vim /apps/keepalived/etc/sysconfig/keepalived
KEEPALIVED_OPTIONS="-D -S 6"

# ç„¶åå»syslogé…ç½®æ–‡ä»¶é‡Œå°†local6è®¾å¤‡å¯¹æ¥çš„æ—¥å¿—å­˜ä¸‹æ¥å•ç‹¬ã€‚
vim /etc/rsyslog.conf
local6.*        /var/log/keepalived.log
```

![image-20241217162321995](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217162321995.png)

![image-20241217163442686](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217163442686.png)

ğŸ‘†é»˜è®¤æ˜¯LOG_DAEMONï¼Œä¹Ÿé»˜è®¤æ”¾åˆ°/var/log/messageé‡Œäº†ã€‚ä¸ºå•¥å‘¢ï¼Œå› ä¸ºğŸ‘‡*.å°±æ˜¯é»˜è®¤æ²¡æŒ‡å®šçš„éƒ½æ”¾è¿›å»äº†

![image-20241217162757073](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217162757073.png)

è¿™å°±okäº†

![image-20241217163923001](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217163923001.png)





## keepaliveå­é…ç½®æ–‡ä»¶-ä¸šåŠ¡é…ç½®ç‹¬ç«‹å­˜æ”¾

å’Œhaproxyã€nginxä¸€æ ·ï¼Œå­é…ç½®æ–‡ä»¶ä¸€èˆ¬æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ç«™ç‚¹é…ç½®æ–‡ä»¶å•ç‹¬å­˜æ”¾ã€‚

å’Œnginxä¸€æ ·åŠ ä¸€ä¸ªincludeï¼Œå’Œhaproxyä¸ä¸€æ ·çš„æ˜¯haproxyæ˜¯serviceæ–‡ä»¶é‡Œçš„-fæŒ‡å®šæ¥ç€ã€‚



keepaliveå­é…ç½®æ–‡ä»¶ä¹Ÿå°±æ˜¯ç”¨æ¥å­˜æ”¾VIPé…ç½®çš„ï¼Œä¹Ÿç®—ç‹¬ç«‹ä¸šåŠ¡ç‹¬ç«‹é…ç½®

![image-20241217170427973](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217170427973.png)

ä¸šåŠ¡é€»è¾‘æ›´æ¸…æ™°ğŸ‘†

```bash
[root@server ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

include /apps/keepalived/etc/keepalived/conf.d/*.conf
```

```bsah
mkdir /apps/keepalived/etc/keepalived/conf.d/
```



MASTER:

```bash
vim /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state MASTER
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}


```

SLAVE:

```bash
[root@server ~]# vim /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state SLAVE
    interface eth1
    virtual_router_id 51
    priority 90
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}

```



![image-20241217165538136](3.Keepalivedå®ç°VRRPåè®®é…ç½®å’Œæ—¥å¿—åŠç‹¬ç«‹å­é…ç½®æ–‡ä»¶.assets/image-20241217165538136.png)

