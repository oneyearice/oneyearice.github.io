# 2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.md



# keepalived

https://keepalived.org/doc/



![img](1.é«˜å¯ç”¨é›†ç¾¤å’ŒVRRPåè®®.assets/software_design.png)



IPVSå°±æ˜¯LVSï¼ŒKEEPALIVEå†…ç½®äº†VRRPå’ŒLVS

keepalivedé€šè¿‡IPVS ç»„ä»¶å’Œå†…æ ¸é‡Œçš„IPVS(lvs)è¿›è¡Œäº¤äº’ã€‚ä»¥å‰ç”¨ipadminå»ç®¡ç†ipvså®ç°LVSçš„è§„åˆ™æ·»åŠ ã€‚ç°åœ¨keepaliveè½¯ä»¶å°±ç›´æ¥æ·»åŠ -æœ‰é…ç½®æ¥å£ã€‚

VRRPå®ç°VIPæ¼‚ç§»çš„IPçš„

netlink  reflectoræ˜¯ä½œä¸º ç”¨æˆ·ç©ºé—´ å’Œ  å†…æ ¸ç©ºé—´ äº¤äº’çš„ç»„ä»¶ï¼Œå®ç°vip



keepaliveç”±äºå†…ç½®äº†lvsï¼Œæ‰€ä»¥ä¹Ÿæ¶µç›–äº†LBçš„åŠŸèƒ½ï¼Œå¦åˆ™ä¸€èˆ¬æ„ä¹‰ä¸Škeepaliveåªæ˜¯ä¸€ä¸ªHAä¸æ˜¯LBã€‚



checkers å®ç°å¥åº·æ€§æ£€æµ‹ï¼Œå››å±‚ 7å±‚ç­‰æ£€æµ‹

<img src="1.é«˜å¯ç”¨é›†ç¾¤å’ŒVRRPåè®®.assets/image-20241213155408120.png" alt="image-20241213155408120" style="zoom:50%;" />



watchdog æ£€æŸ¥ç»„ä»¶æ˜¯å¦OK





<img src="1.é«˜å¯ç”¨é›†ç¾¤å’ŒVRRPåè®®.assets/image-20241213160354301.png" alt="image-20241213160354301" style="zoom:50%;" />









## keepaliveç¼–è¯‘å®‰è£…



![image-20241216145522103](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216145522103.png)



![image-20241216150019486](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216150019486.png)



![image-20241216150116298](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216150116298.png)



![image-20241216150233488](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216150233488.png)



![image-20241216150332844](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216150332844.png)



![image-20241216150402853](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216150402853.png)





```bash
yum install -y gcc curl openssl-devel libnl3-devel net-snmp-devel

curl -LO https://keepalived.org/software/keepalived-2.3.2.tar.gz
tar xf keepalived-2.3.2.tar.gz  -C /usr/local/src
cd /usr/local/src/keepalived-2.3.2/

# ç¼–è¯‘çš„æ—¶å€™è¦åŠ ä¸Šç¦ç”¨é˜²ç«å¢™è§„åˆ™ï¼Œè¿™é‡Œç‰¹æ„ä¸åŠ ç„¶åå»é…ç½®æ–‡ä»¶é‡Œå¤„ç†
./configure --prefix=/apps/keepalived
make -j 4 && make install

# å¥½åƒç¼–è¯‘åserviceæ–‡ä»¶ä¹Ÿæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œå¦‚æœæ²¡æœ‰å°±æ‰‹åŠ¨cpè¿‡å»ä¸€æ ·çš„ã€‚
cp -a /usr/local/src/keepalived-2.3.2/keepalived/keepalived.service /lib/systemd/system/

# æŠ¥é”™ç¼ºå°‘é…ç½®æ–‡ä»¶
cp /apps/keepalived/etc/keepalived/keepalived.conf.sample /apps/keepalived/etc/keepalived/keepalived.conf

systemctl enable --now keepalived
```

![image-20241216151939070](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216151939070.png)



![image-20241216152438799](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216152438799.png)

ç„¶åå»æºç é‡Œæ‰¾æ‰¾serviceæ–‡ä»¶

![image-20241216153007977](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216153007977.png)

EnvironmentFileç¯å¢ƒå˜é‡ï¼Œé‡Œå°±æ˜¯ExecStartå¯åŠ¨çš„$KEEPALIVED_OPTIONSå‚æ•°å˜é‡ã€‚

![image-20241216153658463](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216153658463.png)

æŠ¥é”™ï¼š

![image-20241216154636956](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216154636956.png)



![image-20241216154953070](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216154953070.png)

ä¸Šå›¾å¯è§å¤šäº†å¾ˆå¤šIPåœ°å€å‡ºæ¥ï¼Œå°±æ˜¯VIPäº†

![image-20241216155312190](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216155312190.png)

ä»¥å‰éƒ½è¯´ä¸é€šï¼Œç°åœ¨å°±æ˜¯é€šçš„ï¼Œå“ˆå“ˆå“ˆ

![image-20241216155432146](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216155432146.png)

ä¹Ÿå¯èƒ½æ˜¯æˆ‘æ²¡æœ‰iptableså¯¼è‡´çš„ğŸ‘†

å¦‚æœä¸é€šå°±æ³¨é‡Šæ‰ä¸‹å›¾çš„vrrp_strict

![image-20241216155904948](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216155904948.png)



ç¬¬äºŒå°keepaliveçš„çš„æœåŠ¡ä¹Ÿèµ·æ¥äº†ï¼Œè¿™ä¸ªåº”è¯¥æ²¡å•¥å¤§ç¢å§ğŸ‘‡

![image-20241216161122298](2.Keepalivedç¼–è¯‘å®‰è£…å’ŒGlobalå…¨å±€é…ç½®.assets/image-20241216161122298.png)

ä½†æ˜¯ç¬¬äºŒå°ä¸Šé¢æ€ä¹ˆæ²¡è§ç€å¤šä¸ªVIPå•Šï¼Œéš¾é“è‡ªåŠ¨å‘ç°MASTERäº†ï¼Ÿ

åº”è¯¥å°±æ˜¯pingé€šäº†ä¹‹å‰ä¸€å°çš„VIPï¼Œæ‰€ä»¥å®ƒè‡ªå·±å°±ä½œä¸ºSLAVEäº†





## é…ç½®æ–‡ä»¶



```bash
[root@server keepalived-2.3.2]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived  # å¹å·å°±æ˜¯æ­¤è¡Œä¸å¯ä½œç”¨ï¼Œå’Œ#ä¸€æ ·å’¯

global_defs {
   notification_email {
     acassen@firewall.loc
     failover@firewall.loc
     sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc
   smtp_server 192.168.200.1
   smtp_connect_timeout 30
   router_id LVS_DEVEL
   vrrp_skip_check_adv_addr
   vrrp_strict
   vrrp_garp_interval 0
   vrrp_gna_interval 0
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.200.16
        192.168.200.17
        192.168.200.18
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}

virtual_server 192.168.200.100 443 {
    delay_loop 6
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP

    real_server 192.168.201.100 443 {
        weight 1
        SSL_GET {
            url {
              path /
              digest ff20ad2481f97b1754ef3e12ecd3a9cc
            }
            url {
              path /mrtg/
              digest 9b3a0c85a887a256d6939da88aabd8cd
            }
            connect_timeout 3
            retry 3
            delay_before_retry 3
        }
    }
}

virtual_server 10.10.10.2 1358 {
    delay_loop 6
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP

    sorry_server 192.168.200.200 1358

    real_server 192.168.200.2 1358 {
        weight 1
        HTTP_GET {
            url {
              path /testurl/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334d
            }
            url {
              path /testurl2/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334d
            }
            url {
              path /testurl3/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334d
            }
            connect_timeout 3
            retry 3
            delay_before_retry 3
        }
    }

    real_server 192.168.200.3 1358 {
        weight 1
        HTTP_GET {
            url {
              path /testurl/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334c
            }
            url {
              path /testurl2/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334c
            }
            connect_timeout 3
            retry 3
            delay_before_retry 3
        }
    }
}

virtual_server 10.10.10.3 1358 {
    delay_loop 3
    lb_algo rr
    lb_kind NAT
    persistence_timeout 50
    protocol TCP

    real_server 192.168.200.4 1358 {
        weight 1
        HTTP_GET {
            url {
              path /testurl/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334d
            }
            url {
              path /testurl2/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334d
            }
            url {
              path /testurl3/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334d
            }
            connect_timeout 3
            retry 3
            delay_before_retry 3
        }
    }

    real_server 192.168.200.5 1358 {
        weight 1
        HTTP_GET {
            url {
              path /testurl/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334d
            }
            url {
              path /testurl2/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334d
            }
            url {
              path /testurl3/test.jsp
              digest 640205b7b0fc66c1ea91c463fac6334d
            }
            connect_timeout 3
            retry 3
            delay_before_retry 3
        }
    }
}

```

ä¸Šé¢ä¸‰å¤§å—

å…¶ä¸­virtual_serveråªæ˜¯LVSçš„é…ç½®ï¼Œå¦‚æœkeepaliveä¸æ˜¯ç»™LVSåšHAçš„ï¼Œå°±æ²¡æœ‰å¿…è¦é…ç½®virtual_serverçš„é…ç½®äº†ã€‚

æœ€æ ¸å¿ƒçš„å°±æ˜¯ä¸Šé¢ä¸¤å—ï¼šå…¨å±€å’Œvrrpé…ç½®



å…ˆåˆ æ‰lvsçš„å¾—åˆ°ç²¾ç®€çš„cfg

```bash
[root@server keepalived-2.3.2]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   notification_email {
     acassen@firewall.loc  # å†™äº†ä¹Ÿç™½å†™ï¼Œå‘ä¸å‡ºå»ï¼Œå› ä¸ºï¼šæ²¡æœ‰è¾“å…¥æˆæƒè®¤è¯çš„é…ç½®åœ°æ–¹ã€‚
     failover@firewall.loc
     sysadmin@firewall.loc
   }
   notification_email_from Alexandre.Cassen@firewall.loc  # å‘ä»¶äººï¼Œä¸Šé¢æ˜¯æ”¶ä»¶äºº
   smtp_server 192.168.200.1
   smtp_connect_timeout 30
   
   router_id LVS_DEVEL
   vrrp_skip_check_adv_addr
   vrrp_strict
   vrrp_garp_interval 0
   vrrp_gna_interval 0
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.200.16
        192.168.200.17
        192.168.200.18
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}

[root@server keepalived-2.3.2]#

```



é‚®ç®±çš„æ²¡å¿…è¦é…ç½®äº†ï¼Œåˆ æ‰

```bash
[root@server keepalived-2.3.2]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id ka001  # routeidå’¯,å¯ä»¥æ‹¿ä¸»æœºåæ¥æ ‡è¯†
   vrrp_skip_check_adv_addr  # è·³è¿‡é»˜è®¤çš„é€šå‘Šæ£€æŸ¥ï¼Œæé«˜æ€§èƒ½ã€‚
   vrrp_strict  # ä¸¥æ ¼çš„é…ç½®ï¼ŒåŠ äº†ä¼šå¯¼è‡´ä¸šåŠ¡èµ·ä¸æ¥ï¼Œå¥½æ¯”selinuxã€‚
   vrrp_garp_interval 0  # arpåè®®ï¼Œå‘é€ä¸å»¶è¿Ÿï¼Ÿ
   vrrp_gna_interval 0  # na IPV6çš„åœ°å€arpå’¯ï¼Œä¸å»¶è¿Ÿï¼Ÿ
   vrrp_mcast_grop4 224.0.0.18  # ç»„æ’­åœ°å€ï¼Œæ”¹å•æ’­æ­¤å¤„å¤±æ•ˆï¼Œå¯ä»¥è€ƒè™‘ä¿®æ”¹ç»„æ’­åœ°å€å®‰å…¨èµ·è§æˆ–åŠ è®¤è¯
   vrrp_iptables  # æ­¤é¡¹å’Œvrrp_strictåŒæ—¶å¼€å¯ï¼Œåˆ™ä¸ä¼šæ·»åŠ iptablesè§„åˆ™ã€‚å…³é”®è¿˜å¾—çœ‹ç‰ˆæœ¬ï¼Œå…·ä½“æµ‹è¯•ä¸‹ã€‚
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.200.16
        192.168.200.17
        192.168.200.18
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}


```

è¿›ä¸€æ­¥ç®€åŒ–é…ç½®

```
[root@server keepalived-2.3.2]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id ka001  # routeidå’¯,å¯ä»¥æ‹¿ä¸»æœºåæ¥æ ‡è¯†
}

vrrp_instance VI_1 {
    state MASTER
    interface eth0
    virtual_router_id 51
    priority 100
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    virtual_ipaddress {
        192.168.200.16
        192.168.200.17
        192.168.200.18
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}


```

