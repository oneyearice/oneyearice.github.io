# 4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.md



![image-20241217171247882](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241217171247882.png)

å¿ƒè·³çº¿æ•…éšœï¼Œå°±æ˜¯ä¸¤å¤´keepaliveçš„å¿ƒè·³çº¿æ¥å£éƒ½å¸¦ç”µçš„ï¼Œæ‰€ä»¥æ‰èƒ½è¯´helloåŒ…æ¢æµ‹æœºåˆ¶éƒ½è®¤ä¸ºæ˜¯OKçš„ï¼Œæ‰èƒ½å‡ºç°è„‘è£‚ã€‚

arping å‘ç°ä¸€ä¸ªVIPä¸¤ä¸ªMACå°±å¯ä»¥åˆ¤æ–­å‡ºè„‘è£‚äº†ã€‚



æ¨¡æ‹Ÿè„‘è£‚

<img src="4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241217172455899.png" alt="image-20241217172455899" style="zoom:70%;" />



å°†eth1æ”¹æˆNATï¼Œæ­¤æ—¶è„‘è£‚äº§å‡ºï¼Œä»VIPå¯¹å¤–æœåŠ¡çš„clienté‚£é‡Œ è¿›è¡Œ arpingå¯ä»¥çœ‹åˆ°ğŸ‘‡

![image-20241217173042720](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241217173042720.png) 



å¿ƒè·³çº¿ ç†è®ºä¸Š æœ€å¥½ä¹Ÿæ˜¯åšbondï¼Œç„¶åkeepalivedé‡Œçš„cfgæ–‡ä»¶é‡Œå°±è¦äº›bondæ¥å£

<img src="4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241217173417106.png" alt="image-20241217173417106" style="zoom:57%;" /> 

ä¸Šå›¾å†™é”™äº†å“¦ğŸ‘†ï¼ŒSLAVEæ”¹æˆBACKUP



æ®è¯´æœ‰æ–°çš„é˜²ç«å¢™å†…ç½®çš„å·¥å…·ï¼Ÿ

![image-20241217173751394](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241217173751394.png)





# æŠ¢å 

![image-20241217175205479](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241217175205479.png)



```bash
# ä¸»å¤‡æœºçš„ä¸»é…ç½®æ–‡ä»¶éƒ½ä¸€æ ·
[root@server ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}
include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@server ~]#

=============================================================================
# ä¸»å¤‡æœºçš„å­é…ç½®æ–‡ä»¶
# ä¸»æœºï¼š
[root@server ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    nopreempt
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}


# å¤‡æœºï¼š
[root@server ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 90
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    # Allow packets addressed to the VIPs above to be received
    accept
}



```

æ­¤æ—¶ä¸»æŒ‚äº†ï¼Œå†èµ·æ¥ï¼Œå°±ä¸ä¼šæŠ¢å äº†ã€‚





### å»¶è¿ŸæŠ¢å 

![image-20241218144704527](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241218144704527.png)

![image-20241218144932463](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241218144932463.png)

è¿™å°±æ˜¯â‘ BACKUPâ‘¡preempt_delayåšåˆ°å»¶è¿ŸæŠ¢å ã€‚



## å•æ’­



1ã€è§‚å¯Ÿæ‹“æ‰‘

<img src="4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241218145726185.png" alt="image-20241218145726185" style="zoom:50%;" />

1ã€å…¬æœ‰äº‘ä¸Šï¼Œé™åˆ¶å¤šæ’­ä¹Ÿå°±æ˜¯ç»„æ’­çš„ å¯èƒ½ï¼Œæ‰€ä»¥è¦æ”¹å•æ’­

2ã€æœ¬åœ°SWåšå¿ƒè·³äº¤æ¢æœºçš„é›†ä¸­å¼çš„ä¸­ç»§æ¡¥æ¥ï¼Œä½†æ˜¯ç»„æ’­æŠ¥æ–‡äº¤æ¢æœºçš„è½¬å‘å¼åŒä¸€ä¸ªVLANä¸‹çš„ç«¯å£é˜²æ´ªçš„ï¼Œç†ç”±å°±æ˜¯æ²¡æœ‰å“ªä¸ªæºMACåœ°å€å¼224.0.0.xè¿™ç§çš„ï¼Œæ‰€ä»¥CAMè¡¨é‡Œä¹Ÿæ²¡æœ‰çš„ä¸€å®šã€‚æ‰€ä»¥ä¼šæ³›æ´ªçš„

3ã€äºæ˜¯å•æ’­çš„éœ€æ±‚å°±åº”è¿è€Œç”Ÿäº†ã€‚





```bash

# ä¸»é…ç½®æ–‡ä»¶å·®ä¸å¤š

# ä¸»èŠ‚ç‚¹
[root@server ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}
include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@server ~]#


# ä»èŠ‚ç‚¹ï¼š
[root@server ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.137
   vrrp_mcast_group4 230.0.0.0
}
include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@server ~]#


======================================
# å­é…ç½®æ–‡ä»¶

# ä¸»ï¼š

[root@server ~]# vim /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    #nopreempt
    preempt_delay 60
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }
    unicast_src_ip 10.1.1.1
    unicast_peer{
        10.1.1.2
    }
    # Allow packets addressed to the VIPs above to be received
    accept
}



# å¤‡ï¼š
[root@server ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 90
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    unicast src_ip 10.1.1.2
    unicast_peer{
        10.1.1.1
    }
    # Allow packets addressed to the VIPs above to be received
    accept
}

```





![image-20241218151401738](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241218151401738.png)

ä¸Šå›¾ğŸ‘†src_ipå†™é”™äº†æ”¹æˆ10.1.1.1



![image-20241218151411250](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241218151411250.png)



è§‚å¯Ÿå¯è§ï¼ŒæŠ¢å å»¶è¿Ÿï¼Œç„¶åä¹Ÿæ˜¯å•æ’­äº†ã€‚

![image-20241218152640706](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241218152640706.png)

æœ‰äº†å•æ’­é…ç½®ï¼Œç»„æ’­å³ä½¿é…ç½®ä¸Šå»ä¹Ÿä¸ä¼šç”Ÿæ•ˆäº†ã€‚

æ³¨æ„äº‹é¡¹ï¼šå•æ’­ä¸èƒ½å’Œvrrp_strictåŒæ—¶é…ç½®ï¼Œä¸è¿‡vrrpt_strictå¥½åƒä¸æ¨èå¼€å¯ã€‚

![image-20241218161z345411](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241218161345411.png)





## accept

<img src="4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241218162242916.png" alt="image-20241218162242916" style="zoom:50%;" />



## é‚®ä»¶é€šçŸ¥

1ã€å°±æ˜¯èŠ‚ç‚¹æŒ‚äº†ï¼Œåˆ‡æ¢å•¦ï¼Œè™½ç„¶ä¸å½±å“ä¸šåŠ¡ï¼Œä½†æ˜¯é€šçŸ¥è¿˜æ˜¯è¦å‘ä¸€ä¸‹çš„ï¼Œæ¯”å¦‚ä¸»ä»åˆ‡æ¢äº†ï¼Œå‘ç”Ÿæ—¶é—´å¼å¤œé‡Œ2ç‚¹ï¼Œé‚£ä¹ˆé€šçŸ¥å°±è¦åšåˆ°æ—©ä¸Š9ç‚¹å‘å‡ºæ¥ï¼Œè®©è¿ç»´å¤„ç†

### keepaliveé€šçŸ¥è„šæœ¬

é»˜è®¤ä»¥ç”¨æˆ·keepalived_scriptèº«ä»½æ‰§è¡Œè„šæœ¬ï¼Œå¦‚æœæ­¤ç”¨æˆ·ä¸å­˜åœ¨ï¼Œå°±ç”¨rootæ‰§è¡Œè„šæœ¬ã€‚

å¯ä»¥ç”¨ä¸‹é¢æŒ‡ä»¤æŒ‡å®šè„šæœ¬æ‰§è¡Œç”¨æˆ·çš„èº«ä»½

```bash
global_defs {
	......
	script_user <user>
	......
}
```



### é€šçŸ¥è„šæœ¬ç±»å‹

å½“å‰èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹æ—¶è§¦å‘çš„è„šæœ¬

```shell
notify_master <STRING>|<QUOTED-STRING>
```

å½“å‰èŠ‚ç‚¹è½¬ä¸ºå¤‡èŠ‚ç‚¹æ—¶è§¦å‘çš„è„šæœ¬

```bash
notify_backup <STRING>|<QUOTED-STRING>
```

å½“å‰èŠ‚ç‚¹è½¬ä¸ºâ€å¤±è´¥â€œçŠ¶æ€æ—¶è§¦å‘çš„è„šæœ¬

```bash
notify_fault <STRING>|<QUOTED-STRING>
```

é€šç”¨æ ¼å¼çš„é€šçŸ¥è§¦å‘æœºåˆ¶ï¼Œä¸€ä¸ªè„šæœ¬å¯å®Œæˆä»¥ä¸Šä¸‰ç§çŠ¶æ€çš„è½¬æ¢æ—¶çš„é€šçŸ¥

```bash
notify <STRING>|<QUOTED-STRING>
```

å½“åœæ­¢VRRPæ—¶è§¦å‘çš„è„šæœ¬

```bash
notify_stop <STRING>|<QUOTED-STRING>
```



### è„šæœ¬çš„è°ƒç”¨æ–¹æ³•

åœ¨vrrp_instance VL_1è¯­å¥å—çš„æœ«å°¾åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼Œè¿™ä¸ªè„šæœ¬çš„æ€è·¯æ˜¯ï¼š

å®šä¹‰çš„åç§°notify_xxx   ï¼Œ åé¢å°±æ˜¯è„šæœ¬notify.shï¼Œå†åé¢å°±æ˜¯ä¼ å‚è¿›å»ï¼Œæ‰€ä»¥notify.shæ˜¯ä¸€ä¸ªç»¼åˆè„šæœ¬ï¼Œé€šè¿‡ä¼ é€’ä¸é€šå‚æ•°å®ç°å„è‡ªçš„åŠŸèƒ½ï¼Œæ¯”å¦‚å˜æˆmasterï¼Œå˜æˆbackupï¼Œfaultæ•…éšœçš„è„šæœ¬åŠ¨ä½œã€‚

```bash
notify_master "/xxx/xxx/xx/notify.sh master"
notify_backupr "/xxx/xx/xx/notify.sh backup"
notify_fault "/xxx/xx/xx/notify.sh fault"
```

```

[root@server ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 90
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    unicast src_ip 10.1.1.2
    unicast_peer{
        10.1.1.1
    }

    notify_master "/apps/keepalived/bin/notify.sh master"
    notify_backup "/apps/keepalived/bin/notify.sh backup"
    notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept
}

[root@server ~]# ll /apps/keepalived/etc/keepalived/bin
-rwxr-xr-x 1 root root 2094 Dec 19 10:15 /apps/keepalived/etc/keepalived/bin
[root@server ~]# systemctl restart keepalived


```



### å®æˆ˜æ¡ˆä¾‹1ï¼šå®ç°keepalivedçŠ¶æ€åˆ‡æ¢çš„é€šçŸ¥è„šæœ¬

ä»¥ä¸‹è„šæœ¬æ”¯æŒRHELå’ŒUbuntuç³»ç»Ÿ

```bash
#åœ¨æ‰€æœ‰keepalivedèŠ‚ç‚¹é…ç½®å¦‚ä¸‹ï¼š
cat /etc/keepavlied/notify.sh
#!/bin/bash
#
#*******
#è„šæœ¬è§„èŒƒçš„å¼€ç¯‡æ®µè½ï¼Œç•¥
#
#********


contact='root@xxxx.com'
email_send='yyyyy@qq.com'
email_passwd='1212jiojsfojfi'
email_smtp_server='smtp.qq.com'

. /etc/os-release

msg_error() {
  echo -e "\033[1;31m$1\033[0m"
}

msg_info() {
  echo -e "\033[1;32m$1\033[0m"
}

msg_warn() {
  echo -e "\033[1;33m$1\033[0m"
}

color () {
    RES_COL=60
    MOVE_TO_COL="echo -en \\033[${RES_COL}G"
    SETCOLOR_SUCCESS="echo -en \\033[1;32m"
    SETCOLOR_FAILURE="echo -en \\033[1;31m"
    SETCOLOR_WARNING="echo -en \\033[1;33m"
    SETCOLOR_NORMAL="echo -en \E[0m"
    echo -n "$1" && $MOVE_TO_COL
    echo -n "["
    if [ $2 = "success" -o $2 = "0" ] ;then
        ${SETCOLOR_SUCCESS}
        echo -n $"  OK  "    
    elif [ $2 = "failure" -o $2 = "1"  ] ;then 
        ${SETCOLOR_FAILURE}
        echo -n $"FAILED"
    else
        ${SETCOLOR_WARNING}
        echo -n $"WARNING"
    fi
    ${SETCOLOR_NORMAL}
    echo -n "]"
    echo 
}


install_sendemail () {
    if [[ $ID =~ rhel|centos|rocky ]];then
        rpm -q sendemail &> /dev/null ||  yum install -y sendemail
    elif [ $ID = 'ubuntu' ];then
        dpkg -l |grep -q sendemail  || { apt update; apt install -y libio-socket-ssl-perl libnet-ssleay-perl sendemail ; } 
    else
        color "ä¸æ”¯æŒæ­¤æ“ä½œç³»ç»Ÿï¼Œé€€å‡º!" 1
        exit
    fi
}

# tls=yesæ”¹æˆnoé˜²æ­¢sslæŠ¥é”™
send_email () {
    local email_receive="$1"
    local email_subject="$2"
    local email_message="$3"
    sendemail -f $email_send -t $email_receive -u $email_subject -m $email_message -s $email_smtp_server -o message-charset=utf-8 -o tls=yes -xu $email_send -xp $email_passwd
    [ $? -eq 0 ] && color "é‚®ä»¶å‘é€æˆåŠŸ!" 0 || color "é‚®ä»¶å‘é€å¤±è´¥!" 1 
}

notify() {
    if [[ $1 =~ ^(master|backup|fault)$ ]];then
        mailsubject="$(hostname) to be $1, vip floating"
        mailbody="$(date +'%F %T'): vrrp transition, $(hostname) changed to be $1"
        send_email "$contact" "$mailsubject" "$mailbody"
   else
        echo "Usage: $(basename $0) {master|backup|fault}"
        exit 1
   fi
}

install_sendemail 
notify $1




```





<img src="4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241218183309861.png" alt="image-20241218183309861" style="zoom: 33%;" />



ç¬¬ä¸€å°

![image-20241219103734057](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219103734057.png)

ç¬¬äºŒå°

![image-20241219103805171](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219103805171.png)



<img src="4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219104100681.png" alt="image-20241219104100681" style="zoom:50%;" />





VIPæ¼‚ç§»çš„å‘Šè­¦å°±OKäº†ã€‚



**Virtual Server è™šæ‹ŸæœåŠ¡å™¨ å®šä¹‰æ ¼å¼**

![image-20241219144417286](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219144417286.png)



**è™šæ‹ŸæœåŠ¡å™¨ç»„**

![image-20241219144429901](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219144429901.png)



**è™šæ‹ŸæœåŠ¡å™¨é…ç½®**

![image-20241219144550979](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219144550979.png)

keepaliveå†…åµŒäº†å¥åº·æ€§æ£€æŸ¥--dely_loop è¯­å¥å®ç°çš„ğŸ‘†

persistence_timeout ä¸‹æ¬¡è°ƒåº¦è¿˜æ˜¯å¾€ä¹‹å‰çš„åç«¯å®ä¾‹è°ƒåº¦ï¼Œä¿æŒè¿æ¥ï¼Œä¼šè¯ä¿æŒï¼Œå¯ä»¥è¿™ä¹ˆæè¿°å§ï¼Œä¸ç„¶è°ƒåº¦åˆ°åˆ«çš„æœºå™¨ä¼šè¯å°±ä¸ä¸€è‡´äº†ï¼Œå¯èƒ½éœ€è¦å„ä¸ªå®ä¾‹ä¹‹é—´çš„ä¼šè¯åŒæ­¥æœºåˆ¶äº†ã€‚

sorry_serverå°±æ˜¯åç«¯rs(real server)éƒ½æŒ‚äº†çš„ä¸€ä¸ªå¯¹å¤–å…¬å‘Šé¡µé¢æœåŠ¡

weightæƒé‡ï¼Œå¦‚æœè°ƒåº¦æ˜¯wrr wlc è¿™ç§å¸¦weightçš„å°±èµ·ä½œç”¨äº†ã€‚



**åº”ç”¨å±‚æ£€æµ‹**

![image-20241219145132530](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219145132530.png)



**èŒƒä¾‹**

![image-20241219145342224](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219145342224.png)

HTTP_GETé‡Œçš„å°±æ˜¯å¥åº·æ£€æŸ¥ï¼Œå¦‚æœæ£€æŸ¥ä¸æ˜¯200ç»“æœï¼Œå°±å°†å…¶ä»è°ƒåº¦åˆ—è¡¨é‡Œç§»é™¤ã€‚





dræ¨¡å‹ï¼Œå› ä¸ºåç«¯æœåŠ¡å™¨ä¹Ÿå¾—æœ‰ç”¨è¿™ä¸ªVIPï¼Œrså’Œlvsè¦ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Œé˜²æ­¢IPå†²çªã€‚NATæ¨¡å¼ä¸éœ€è¦ã€‚è¿™é‡Œè®²çš„LVSçš„æ¦‚å¿µäº†ã€‚





**åœ¨åç«¯å®ä¾‹ä¸Šé…ç½®ğŸ‘‡**

```bash
#!/bin/bash

vip=192.168.126.100
mask='255.255.255.255'
dev=lo:1
rpm -q httpd &> /dev/null || yum -y install httpd &>/dev/null
service httpd start &> /dev/null && echo "The httpd Server is Ready!"
echo "www.ming.org `hostname -I`" > /var/www/html/index.html

case $1 in
start)
    echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore
    echo 1 > /proc/sys/net/ipv4/conf/lo/arp_ignore
    echo 2 > /proc/sys/net/ipv4/conf/all/arp_announce
    echo 2 > /proc/sys/net/ipv4/conf/lo/arp_announce
    ifconfig $dev $vip netmask $mask #broadcast $vip up
    #route add -host $vip dev $dev
    echo "The RS Server is Ready!"
    ;;
stop)
    ifconfig $dev down
    echo 0 > /proc/sys/net/ipv4/conf/all/arp_ignore
    echo 0 > /proc/sys/net/ipv4/conf/lo/arp_ignore
    echo 0 > /proc/sys/net/ipv4/conf/all/arp_announce
    echo 0 > /proc/sys/net/ipv4/conf/lo/arp_announce
    echo "The RS Server is Canceled!"
    ;;
*)
    echo "Usage: $(basename $0) start|stop"
    exit 1
    ;;
esac
```



![image-20241219180545878](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219180545878.png)



![image-20241219180715885](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219180715885.png)





**åŠ å…¥vsé…ç½®**,å°±æŠŠé…ç½®æ¨¡æ¿é‡Œçš„vsè¯­å¥å—å¤åˆ¶å‡ºæ¥æ”¹æ”¹å°±è¡Œäº†

```bash
virtual_server 192.168.126.100 80 {
    delay_loop 6
    lb_algo wrr
    lb_kind DR  # dræ¨¡å‹ä¸‹é¢çš„rsä¹Ÿå¿…é¡»ç”¨80ç«¯å£ï¼Œå’Œä¸Šé¢vsä¿æŒä¸€è‡´ï¼›NATæ¨¡å¼å¿…é¡»ä¸€è‡´ï¼Œtunnelå’Œdrä¸€æ ·ã€‚
    persistence_timeout 50
    protocol TCP
    sorry_server 127.0.0.1 80
	
	
    real_server 192.168.126.138 80 {
        weight 2
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
    real_server 192.168.126.139 80 {
        weight 1
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
}


```



<img src="4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219163403263.png" alt="image-20241219163403263" style="zoom:45%;" />





<img src="4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219163624288.png" alt="image-20241219163624288" style="zoom:50%;" />





```bash
# ä¸»cfg

[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@ka01 ~]#



# å­cfgï¼š

[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    #nopreempt
    preempt_delay 10
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }
    unicast_src_ip 10.1.1.1
    unicast_peer{
        10.1.1.2
    }

    notify_master "/apps/keepalived/bin/notify.sh master"
    notify_backup "/apps/keepalived/bin/notify.sh backup"
    notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept
}

virtual_server 192.168.126.100 80 {
    delay_loop 6
    lb_algo wrr
    lb_kind DR  # dræ¨¡å‹ä¸‹é¢çš„rsä¹Ÿå¿…é¡»ç”¨80ç«¯å£ï¼Œå’Œä¸Šé¢vsä¿æŒä¸€è‡´ï¼›NATæ¨¡å¼å¿…é¡»ä¸€è‡´ï¼Œtunnelå’Œdrä¸€æ ·ã€‚
    persistence_timeout 50
    protocol TCP
    sorry_server 127.0.0.1 80


    real_server 192.168.126.138 80 {
        weight 2
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
    real_server 192.168.126.139 80 {
        weight 1
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
}

[root@ka01 ~]#

```



```bash
[root@ka02 ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.137
   vrrp_mcast_group4 230.0.0.0
}
include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@ka02 ~]#
[root@ka02 ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 90
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    unicast src_ip 10.1.1.2
    unicast_peer{
        10.1.1.1
    }

    notify_master "/apps/keepalived/bin/notify.sh master"
    notify_backup "/apps/keepalived/bin/notify.sh backup"
    notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept
}

virtual_server 192.168.126.100 80 {
    delay_loop 6
    lb_algo wrr
    lb_kind DR  # dræ¨¡å‹ä¸‹é¢çš„rsä¹Ÿå¿…é¡»ç”¨80ç«¯å£ï¼Œå’Œä¸Šé¢vsä¿æŒä¸€è‡´ï¼›NATæ¨¡å¼å¿…é¡»ä¸€è‡´ï¼Œtunnelå’Œdrä¸€æ ·ã€‚
    persistence_timeout 50
    protocol TCP
    sorry_server 127.0.0.1 80


    real_server 192.168.126.138 80 {
        weight 2
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
    real_server 192.168.126.139 80 {
        weight 1
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
}



```



yum install ipvsadmåæ£€æŸ¥LVSè½¬å‘è§„åˆ™æ˜¯å¦OK



ä¸»ä¸Šæ˜¯VIP 192.168.126.100 è½åœ¨å…¶ä¸Šçš„ï¼Œè½¬å‘è§„åˆ™ä¹ŸOK

![image-20241219181325003](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219181325003.png)

ä»ä¸ŠVIP 192.168.126.100æ²¡æœ‰è½åœ¨å…¶ä¸Šï¼Œè½¬å‘è§„åˆ™è™½åœ¨ä½†ä¸ä¼šç”Ÿæ•ˆçš„ï¼Œä¹Ÿæ˜¯OKçš„ï¼Œæ­£å¸¸ç°è±¡å¦‚æ­¤

![image-20241219181546616](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219181546616.png)







**é—®é¢˜1ï¼šæ²¡æœ‰2:1çš„wrr**

![image-20241219182322375](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219182322375.png)

 

æ‰¾åˆ°äº†ï¼Œåšäº†ä¼šè¯ä¿æŒåˆ°åŒä¸€å°åç«¯å®ä¾‹äº†ğŸ‘‡

<img src="4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219182700678.png" alt="image-20241219182700678" style="zoom:50%;" />

é—®é¢˜è§£å†³ï¼š

![image-20241219182734469](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219182734469.png)





**é—®é¢˜2ï¼š**

keepalive001ä¸Šcurl VIPæ²¡ååº”ï¼Œä¸»èŠ‚ç‚¹æ‰¿è½½VIP ï¼Œä¸èƒ½curlè‡ªå·±ï¼Ÿ

![image-20241219182419809](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219182419809.png)

ä»èŠ‚ç‚¹ä¸æ‰¿è½½VIPï¼Œå¯ä»¥curl VIPï¼Œæœ‰è¿™è¯´æ³•ï¼Ÿ

![image-20241219182455875](4.Keepalivedè„‘è£‚ç°åƒå•æ’­é€šä¿¡éæŠ¢å å¼åŠé‚®ä»¶é€šçŸ¥å®ç°.assets/image-20241219182455875.png)

















