# ç¬¬2èŠ‚. mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶



# è¡¥å……å‡ ä¸ªé€‰é¡¹

![image-20230810134026214](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810134026214.png)

### 5ä¸ªå†™ç£ç›˜çš„åŠæ—¶æ€§ï¼š

sync_binlog=1     binlogçš„åŠæ—¶å†™ç£ç›˜ï¼Œ

innodb_flush_log_at_trx_commit=1       äº‹åŠ¡çš„åŠæ—¶å†™ç£ç›˜ï¼Œå½“ç„¶ä¸æ˜¯è¯´åŠæ—¶å°±ä¸€å®šæ˜¯å¥½çš„ï¼Œä¹Ÿè¦è€ƒè™‘IOçš„è´Ÿæ‹…ã€‚

sync_master_infoæ˜¯  å¤šå°‘æ¬¡ äº‹ä»¶å master.infoçš„ä¿¡æ¯ å†™ç£ç›˜

sync_relay_log   å¤šå°‘æ¬¡ ååŒæ­¥åˆ°relaylogç£ç›˜æ–‡ä»¶ï¼Œåº”è¯¥ä¹Ÿæ˜¯æŒ‡relay-log.infoæ–‡ä»¶å§ã€‚

sync_relay_log_info    å¤šå°‘æ¬¡äº‹åŠ¡å ååŒæ­¥åˆ°relay-log.infoç£ç›˜æ–‡ä»¶ã€‚



skip-slave-start=ON  # è¦çŸ¥é“ä¸€ä¸ªäº‹å®--é‡å¯mariadbæœåŠ¡åï¼Œslaveçš„ä¸¤ä¸ªçº¿ç¨‹IOå’ŒSQLéƒ½æ˜¯OKçš„ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡æ‰‹åŠ¨start slave;åé¢éƒ½ä¸ç”¨ç®¡çš„ï¼Œéƒ½æ˜¯éšæœåŠ¡å¯åŠ¨å°±å¯åŠ¨çš„ã€‚è¿™ä¸ªç‰¹æ€§å°±æ˜¯ä¾èµ–äºskip-slave-startè¿™ä¸ªé€‰é¡¹ï¼Œå¦‚æœç½®ä¸ºONï¼Œå°±ä¸ä¼šéšæœåŠ¡å¯åŠ¨äº†ï¼Œåˆ°æ—¶å€™å°±åªèƒ½æ‰‹åŠ¨æ¯æ¬¡start slaveäº†ã€‚







# ä¸»-ä¸» å¤åˆ¶ï¼Œéœ€è¦è°ƒåº¦å›ºå®šåˆ†é…æˆä¸»-ä»



ä¸»-ä¸»å‰é¢ä¸€ç¯‡å°±è®²è¿‡äº†ï¼Œè¿™ç§çš„å¥½å¤„ï¼Œæ˜¯å¤šæ´»å—ï¼Œæ— éœ€ä»èŠ‚ç‚¹æå‡ è¿™ä¹ˆä¸€ä¸ªåŠ¨ä½œã€‚



æ‰€è°“ä¸»ä¸»ï¼Œå…¶å®æ˜¯äº’ä¸ºä¸»ä»ï¼ŒA-B ä¸¤ä¸ªæœºå™¨ï¼ŒAæ˜¯Bçš„ä¸»ï¼Œåˆæ˜¯Bçš„ä»ï¼ŒBä¸€æ ·ã€‚



---

ä¸è¿‡æœ‰äººå°±æ˜¯è¦çœŸæ­£æ„ä¹‰ä¸Šçš„ä¸»ä¸»ï¼Œå¤šæ´»ï¼ŒA/Aï¼Œç±»ä¼¼ASAçš„A/Aï¼Œäººå®¶å°±æ˜¯è¦å¹¶å‘å†™ï¼Œæˆ‘é‚£ä¸ªå»ï¼Œæ€ä¹ˆæï¼Œè¿™ä¹ˆæã€‚

![image-20230810140651676](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810140651676.png)

æ‰€è°“çš„å¹¶å‘å†™ï¼ŒA/Aï¼Œå…¶å®å°±æ˜¯é€šè¿‡

![image-20230810141138154](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810141138154.png)

auto_incrementï¼šä¹Ÿå°±æ˜¯å¥‡å¶åŒºåˆ†ï¼Œä¸åŒçš„ä¸»èµ·å§‹ä¸é€šï¼Œé—´éš”ä¸€æ ·ï¼Œé”™å¼€åºå·äº†å°±ã€‚

ç„¶åå†é…åˆå‰ç½®è°ƒåº¦å™¨ï¼Œæ¯”å¦‚ï¼Œæ¥äº†2æ¡å†™æ“ä½œï¼Œè°ƒåº¦å™¨å°±ç›´æ¥å¹¶å‘çš„æ‰”ç»™2ä¸ªä¸»ï¼Œè€Œ2ä¸ªä¸»å¤„ç†çš„æ—¶å€™åˆæ˜¯é”™å¼€PRIä¸»é”®IDçš„ï¼Œäºæ˜¯å°±å®ç°äº†å¤šä¸»ã€‚



```
èŠ‚ç‚¹Aä¸Š
------
yum -y remove mariadb-server
rm -rf /var/lib/mysql/*
cp -a /etc/my.cnf /etc/my.cnf.bak

yum -y install mariadb-server
vim /etc/my.cnf
	[mysqld]
	server-id=1
	log-bin
	auto_increment_offset=1
	auto_increment_increment=2
wr

systemctl start mariadb

mysql > grant replication slave on *.* to repluser@'192.168.126.%' identified by 'cisco';


```

```
èŠ‚ç‚¹Bä¸Š
------
yum -y remove mariadb-server
rm -rf /var/lib/mysql/*
cp -a /etc/my.cnf /etc/my.cnf.bak

yum -y install mariadb-server
vim /etc/my.cnf
	[mysqld]
	server-id=2
	log-bin
	auto_increment_offset=2
	auto_increment_increment=2
wr

systemctl start mariadb

 // mysql > grant replication slave on *.* to repluser@'192.168.126.%' identified by 'cisco';   # è¿™å¥å°±ä¸ç”¨æ•²äº†ï¼Œç›´æ¥å¤åˆ¶è¿‡æ¥ä»Aã€‚
 
 mysql > 
 CHANGE MASTER TO
 MASTER_HOST='192.168.126.129',
 MASTER_USER='repluser',
 MASTER_PASSWORD='cisco',
 MASTER_PORT=3306,
 MASTER_CONNECT_RETRY=10,
 MASTER_LOG_FILE='mariadb-bin.000001', MASTER_LOG_POS=330;   # å»Açœ‹ä¸‹show master logs;å°†binglogæ–‡ä»¶å’Œposä½ç½®å¤åˆ¶è¿‡æ¥ã€‚ä¸è¿‡è¿™ä¸ªè¦é…åˆmysqldump ä»Aå¤‡ä»½è¿˜åŸåˆ°Bï¼Œå¦‚æœä¸æƒ³è¿™ä¹ˆéº»çƒ¦ï¼Œç›´æ¥å°†è¿™é‡Œçš„binglogè®¾ç½®æˆç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç¬¬ä¸€ä¸ªä½ç½®ä¸€èˆ¬æ˜¯330å·¦å³ã€‚å¯ä»¥åˆ·æ–°ä¸€ä¸ªbinlogï¼Œçœ‹çœ‹åˆå§‹å€¼å¤šå°‘ã€‚æ”¾å±ï¼è¿™æ ·ä»å¤´å¤åˆ¶ç›´æ¥æŠ¥é”™ï¼å“ˆå“ˆå› ä¸ºå¤åˆ¶çš„æ—¶å€™å¯ä¸ä¼šæƒ³mysqldumpå‡ºæ¥çš„æœ‰IFåˆ¤æ–­å­˜åœ¨å°±DROPçš„è¯­å¥ï¼Œä¸»ä»å¤åˆ¶å¦‚æœå­˜åœ¨å°±ç›´æ¥æŠ¥é”™å¡ä½äº†ã€‚
 
 æ‰€ä»¥è¿™é‡Œçš„binlogå’Œposéœ€è¦å…ˆå»masterä¸Šshow master logs;å¤åˆ¶è¿‡æ¥çš„ï¼Œç„¶åmasterå‰é¢çš„æ•°æ®éœ€è¦dumpè¿‡æ¥çš„ã€‚
 

```

æŠ¥é”™å•¦

![image-20230810161837911](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810161837911.png)

```
è¿˜æ˜¯å»Aä¸Šdumpå§

mysqldump -A --single-transaction --master-data=1 > /data/all.sql
scp /data/all.sql root@192.168.126.130:/data/
```

![image-20230810162257932](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810162257932.png)

```
å»Bä¸Šè¿˜åŸä¸‹
msyql > stop slave;
mysql < /data/all.sql
msql > show databaes;   å¯è§hellodbåŒæ­¥è¿‡æ¥äº†
mysql > start slave;
mysql > show slave status\G;   è¿™å›å°±OKäº†ã€‚

```

![image-20230810162412356](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810162412356.png)

![image-20230810162422644](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810162422644.png)

è¿™å°±å¥½äº†ï¼Œæœç„¶æ˜¯primaryä¸»é”®å¯èƒ½ä¸è®©å†™å¥‡æ•°å§ï¼Œå› ä¸º/etc/my.cnfé‡Œæ˜¯åšäº†å¶æ•°é™åˆ¶

<img src="2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810162621208.png" alt="image-20230810162621208" style="zoom:50%;" />



æœç„¶ä¸ªå±ï¼Œå†ä»”ç»†çœ‹çœ‹æŠ¥é”™ï¼Œæ˜¯dupicate

![image-20230810163449550](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810163449550.png)

è¿™å°±æ˜¯å·²ç»è¯´ä¸»ä»å¤åˆ¶çš„æ—¶å€™ï¼Œå·²ç»æœ‰çš„æ•°æ®åº“ï¼Œé‡Œé¢çš„è¡¨ï¼Œå†æ¬¡å†™çš„æ—¶å€™å°±æŠ¥é”™äº†ï¼Œ

ä½†æ˜¯mysqldump å‡ºæ¥çš„all.sqlé‡Œå…¶å®ä¹Ÿæ˜¯å¤§é‡çš„sqlè¯­è¨€ï¼Œä½†æ˜¯äººå®¶æ˜¯å†™äº†IF æ¡ä»¶åˆ¤æ–­çš„ï¼Œå¦‚æœå­˜åœ¨è¿™ä¸ªè¡¨æ ¼å°±DROPçš„å•Šï¼Œå“ˆå“ˆï¼Œå¯¹å§mydqldumpæ˜¯å…ˆé“²é™¤åè¿˜åŸå•Šï¼Œæ‰€ä»¥ä¸ä¼šæŠ¥é”™å•ŠğŸ‘‡

![image-20230810163920576](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810163920576.png)

è€Œå¤åˆ¶å°±ä¸æ˜¯å•¦ï¼Œå­˜åœ¨çš„å°±å†²çªäº†ã€‚ç°åœ¨çŸ¥é“ä¸ºä»€ä¹ˆæ¯æ¬¡éƒ½dumpè€Œä¸æ˜¯ä»å¤´åšå¤åˆ¶äº†å§ã€‚



ç°åœ¨ä¼ ç»Ÿçš„ä¸»-ä»å°±OKï¼Œæµ‹è¯•ä¸€ä¸‹

![image-20230810171520308](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810171520308.png)

![image-20230810171509543](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810171509543.png)





## ç„¶åæŠŠèŠ‚ç‚¹Bä¹Ÿå°±æ˜¯slaveä¹Ÿå˜æˆmaster

```
Bä¸Šä¹Ÿå°±æ˜¯slaveï¼š
------
mysql > show master logs;


```

![image-20230810171541654](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810171541654.png)

```
Aä¸Šä¹Ÿå°±æ˜¯masterï¼š
---------
 
mysql > 
 CHANGE MASTER TO
 MASTER_HOST='192.168.126.130',
 MASTER_USER='repluserB',
 MASTER_PASSWORD='cisco',
 MASTER_PORT=3306,
 MASTER_CONNECT_RETRY=10,
 MASTER_LOG_FILE='mariadb-bin.000002', MASTER_LOG_POS=2539205;
 
 ä¸Šé¢çš„binglogæ–‡ä»¶å’Œposä½ç½®å°±æ˜¯Bä¸Šçœ‹åˆ°çš„å¤åˆ¶è¿‡æ¥çš„ï¼Œæ•²å®ŒAå°±æ˜¯ä»äº†ï¼Œå½“ç„¶è¿˜å¾—start slaveä¸€ä¸‹ï¼›
 
mysql > start slave;
mysql > show slave status\G;
```

ç„¶åå°±æŠ¥é”™äº†

![image-20230810172640127](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810172640127.png)

å¥‡äº†æ€ªäº†ï¼Œç”¨æˆ·ç¡®è®¤åŒæ­¥è¿‡å»äº†å•Šï¼Œå¯†ç é€šè¿‡å“ˆå¸Œå€¼éƒ½èƒ½åˆ¤æ–­æ˜¯ä¸€è‡´çš„ğŸ‘‡

![image-20230810172745859](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810172745859.png)





![image-20230810172705241](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810172705241.png)



ä¸ç®¡å…ˆåœ¨Bä¸Šæ–°å»ºä¸€ä¸ªç”¨æˆ·è¯•è¯•

```
åœ¨Bä¸Š
-----
 grant replication slave on *.* to repluserB@'192.168.126.%' identified by 'cisco';
```

![image-20230810173046337](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810173046337.png)



![image-20230810173136519](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810173136519.png)



é ï¼å¥½äº†ï¼Œéš¾é“ç”¨æˆ·è¦å•ç‹¬åˆ›å»ºå’¯ï¼Œå¥½å§ã€‚éš¾é“ä¸»ä¸»ï¼Œå¤åˆ¶ç”¨æˆ·å¿…é¡»å„è‡ªå•ç‹¬åˆ›å»ºã€‚ä¸æ˜¯ï¼Œåé¢æˆ‘åˆæŠŠAçš„å¤åˆ¶ç”¨æˆ·æ¢å›å»åˆå¯ä»¥äº†ã€‚æ„Ÿè§‰æ˜¯è¿™ä¸ªç”¨æˆ·æ²¡æœ‰åœ¨Bä¸Šç”Ÿæ•ˆã€‚

<img src="2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810174357148.png" alt="image-20230810174357148" style="zoom:50%;" />

å¥½åƒflush privileges;å°±å¥½äº†ï¼Œä¸è¿‡æˆ‘è®°å¾—æˆ‘åˆ·è¿‡å•Šï¼Œä¼°è®¡å°±æ˜¯æ²¡ç”Ÿæ•ˆå½“æ—¶ï¼Œç„¶åè¿‡ä¸€ä¼šç”Ÿæ•ˆäº†ï¼Œæˆ–è€…æ˜¯åˆ›å»ºrepluserBçš„æ—¶å€™ç›¸å½“äºåˆåˆ·äº†ä¸€æ¬¡ï¼Œæˆ‘å½“æ—¶åº”è¯¥å¤šåˆ·å‡ æ¬¡çš„ï¼Œ(ï¿£â–½ï¿£)"ã€‚



![image-20230810174556864](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810174556864.png)





A->B å’ŒA<-B åŒå‘åŒæ­¥å°±éƒ½æµ‹è¯•åˆ°äº†ğŸ‘‡

![image-20230810173356188](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810173356188.png)



![image-20230810173427835](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810173427835.png)





## æ¨¡æ‹Ÿå†™è¡¨çœ‹çœ‹æ˜¯å¦å†²çª-ä¸»ä¸»çš„æ—¶å€™

```
Aä¸Š
-----
mysql > use hellodb
mysql > create table test (id int auto_increment primary key, name char(10));

mysql > desc test;

```



![image-20230810175251661](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810175251661.png)

æ­¤æ—¶Bä¸Šä¹Ÿæœ‰äº†

![image-20230810175344445](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810175344445.png)



```
é€šè¿‡xshelçš„æ‰¹é‡ä¸‹å‘cliï¼Œç»™Aå’ŒBåŒäº‹æ•²å…¥insert

insert test (name) values ('wang');

```

![image-20230810180052019](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810180052019.png)



è¿™æ ·å°±åŒæ—¶é”®å…¥äº†sql insert

![image-20230810180224614](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810180224614.png)



![image-20230810180533473](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810180533473.png)

ä¸å†²çªï¼Œå·¦è¾¹Aæ˜¯1ï¼Œå³è¾¹Bæ’å…¥çš„æ˜¯2å¶æ•°ï¼Œå¥‡å¶é”™å¼€æ¥çš„ã€‚



![image-20230810193755718](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810193755718.png)

è¿˜æ˜¯ä¸€æ ·å·¦è¾¹1 3 5 ï¼Œå³è¾¹2 4 6



åˆ›å»ºè¡¨ï¼Œç†åº”å†²çª

![image-20230810194117844](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810194117844.png)

ä½†æ˜¯é«˜ç‰ˆæœ¬ç¡®å®ä¸ä¼šäº†ï¼Œä¸çŸ¥é“æ€ä¹ˆå®ç°çš„ã€‚



æˆ‘ç†è§£ä¸€å®šæ˜¯æœ‰ä¸€ä¸ªè¢«å›é€€äº†ï¼Œå†…éƒ¨å¿½ç•¥äº†ï¼Œå»æ‰¾æ‰¾ç›¸å…³èµ„æ–™ã€‚



![image-20230810195508311](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810195508311.png)

ä¸­æ–‡ä¼šç¿»è¯‘æ‰äº†ä¸€å†™ é‡è¦çš„ ä¸“ä¸šè¯æ±‡ï¼Œå°±æ˜¯äººå®¶èµ·çš„åå­—å§ï¼Œé€šè¿‡è‹±æ–‡å»é—®å¾—åˆ°è‹±æ–‡çš„å›ç­”

![image-20230810200423244](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810200423244.png)

é€šè¿‡GPTæ‰¾åˆ°äº†å…³é”®ä¿¡æ¯ï¼Œç„¶åé€šè¿‡å…³é”®ä¿¡æ¯å»å®˜ç½‘å†æ‰¾

![image-20230810200534191](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810200534191.png)

https://mariadb.com/kb/en/about-galera-replication/

![image-20230810200504940](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810200504940.png)

ç„¶åçœ‹çœ‹é»˜è®¤çš„å€¼å°±æ˜¯1ğŸ‘‡

![image-20230810200251384](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810200251384.png)

ç¡®è®¤äº†ğŸ‘†

è¿˜æœ‰è¿™ä¸€ç¯‡ä¹Ÿå†™çš„ä¸é”™

https://galeracluster.com/library/documentation/certification-based-replication.html

![image-20230810201309719](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810201309719.png)





è™½ç„¶ä¸»ä¸»ç°åœ¨é«˜ç‰ˆæœ¬æœ‰write set replication APIè¾…åŠ©ï¼Œä½†æ˜¯ç”Ÿäº§ä¸­æ˜¯ä¸å¯èƒ½ç›´æ¥ç”¨çš„ï¼Œä¼šåœ¨ä¸»ä¸»å‰é¢åŠ ä¸Šè°ƒåº¦å™¨çš„ï¼Œåªå¾€ä¸€ä¸ªä¸»èŠ‚ç‚¹ä¸Šå†™æ•°æ®ï¼Œå¦ä¸€ä¸ªè™½ç„¶æ˜¯ä¸»ï¼Œæœ¬è´¨ä¸Šæ˜¯åšæŸ¥è¯¢æ“ä½œçš„ï¼Œè¿™æ ·çš„ä¸»ä¸»å¥½å¤„å°±æ˜¯å½“ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå¦ä¸€å°å¯ä»¥å¿«é€Ÿæ›¿ä»£ï¼Œä¸ç”¨åƒä»¥å‰ä»é‚£æ ·è¿˜è¦è´¹åŠ²åœ°æ“ä½œä¸€ä¸‹æ‰èƒ½æå‡ä¸ºä¸»ã€‚



## å¦‚æœæ˜¯ä¸‰ä¸ªç¯å½¢æŒ‡ä¸»ï¼Œå¦‚æœæ˜¯4ä¸ªç¯å½¢æŒ‡ä¸»

éƒ½æ˜¯ä¸²èµ·æ¥ï¼Œå¤´å°¾ç›¸è¿ï¼Œæœ¬è´¨ä¸Šå’Œä¸»ä¸»ä¸€æ ·åœ°ï¼Œæ— éæ˜¯ä»2ä¸ªä¸²ï¼Œå˜æˆäº†3ä¸ªï¼Œ4ä¸ªç¯å‹ç½¢äº†ã€‚

<img src="2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811095641090.png" alt="image-20230811095641090" style="zoom:33%;" />

ä¸Šå›¾ğŸ‘†æ˜¯ä¸»ä¸»åœ°é—´éš”ï¼Œå¦‚æœæ˜¯3ä¸ªä¸²èµ·æ¥ï¼Œ

å°†auto_increment_increment=3å°±è¡Œäº†ï¼›å°±æ˜¯1 4 7 ï¼Œ2 5 8ï¼Œ3 6 9ã€‚







# åŒæ­¥è™½å¥½ï¼Œå¼‚æ­¥è½åœ°ï¼ŒåŠåŒæ­¥ä¸ºä¼˜





![image-20230811114333273](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811114333273.png)





åŒæ­¥å’Œå¼‚æ­¥å‰é¢è®²è¿‡äº†ï¼Œè¿™é‡Œè¡¥å……ä¸€ä¸‹åŠåŒæ­¥ï¼Œæ‰€è°“åŠåŒæ­¥å°±æ˜¯ï¼Œåªè¦ä¼—å¤šä»èŠ‚ç‚¹ä¸­ï¼Œæœ‰ä¸€ä¸ªå›å¤äº†(ä¸‹å›¾ä¸­ç¬¬4æ­¥)ï¼Œmasterå°±å›å¤proxyï¼Œè¿›è€Œå›ç»™ç”¨æˆ·ã€‚ç›¸å½“äºä¸€æ¬¡updateåœ¨ç”¨æˆ·é‚£è¾¹å°±å®Œæˆäº†ï¼Œä¸å¿…åƒåŒæ­¥é‚£æ ·ç­‰å¤ªä¹…ã€‚

![image-20230811113517163](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811113517163.png)





é»˜è®¤æ˜¯ä¸æ”¯æŒåŠåŒæ­¥çš„ï¼Œéœ€è¦å®‰è£…æ’ä»¶ï¼Œå¥½åƒç¡®å®æ•°æ®åº“é‡Œä¹Ÿæœ‰å¾ˆå¤šæ’ä»¶ã€‚



![image-20230811114353849](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811114353849.png)

ä¸‹é¢å¼€å§‹å®éªŒ

1ã€æ‹“æ‰‘ï¼šmaster--å¸¦ ä¸¤ä¸ª slaveï¼Œä¸€ä¸ªslaveæ–­å¼€ç½‘ç»œæ¨¡æ‹ŸæœªåŒæ­¥ï¼Œç„¶åmasterä¹Ÿèƒ½å®Œæˆè®°ä¸€æ¬¡updataäº¤äº’ã€‚

2ã€å¼€å§‹

```shell
masterä¸Š
--------
vim /etc/my.cnf
	serer-id=1
	log-bin
wr
systemctl restart mariadb
mysql > show master logs;  # è®°ä¸€ä¸‹binlogçš„ç¼–å·å’Œposå¤åˆ¶åˆ°ä¸‹é¢CHANGE MASTER clié‡Œ
mysql > grant replication slave on *.* to repluser@'192.168.126.%' identified by 'cisco';

```

![image-20230811141426902](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811141426902.png)

å·¦ä¸€  masterï¼› ä¸­é—´ slave1ï¼›  å³ä¸€ slave2ï¼›

```
slave1ä¸Š
---------
vim /etc/my.cnf
	server-id=2
wr
systemctl restrat mariadb
msyqll >  CHANGE MASTER TO
 MASTER_HOST='192.168.126.129',
 MASTER_USER='repluser',
 MASTER_PASSWORD='cisco',
 MASTER_PORT=3306,
 MASTER_CONNECT_RETRY=10,
 MASTER_LOG_FILE='mariadb-bin.000003', MASTER_LOG_POS=781;
```



é‡åˆ°ä¸€ä¸ªæŠ¥é”™

![image-20230811142109616](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811142109616.png)

é‡å¯æœåŠ¡åï¼Œå°±å¯ä»¥äº†ï¼Œæˆ‘æ—¥ï¼Œè‚¯å®šæœ‰ä»€ä¹ˆæ®‹ç•™å¯¼è‡´ç›´æ¥ æˆæƒçš„æ–¹å¼æ— æ³•åˆ›å»ºç”¨æˆ·äº†ã€‚

å¥½åƒæœ‰æ—¶å€™flushä¸€ä¸‹å¯ä»¥ï¼Œæœ‰æ—¶å€™flush ä¹Ÿä¸è¡Œï¼Œä¸‹å›¾æ˜¯OKçš„æˆªå›¾

![image-20230811143854513](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811143854513.png)



é‡åˆ°æŠ¥é”™ï¼Œstop slaveè¿˜ä¸è¡Œï¼Œè¿˜å¿…é¡»resetï¼

![image-20230811144913529](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811144913529.png)

slave2ä¸€æ ·è¦resetä¸€ä¸‹ï¼Œå› ä¸ºä¹‹å‰æœ‰åšäº†å…¶ä»–å®éªŒ

![image-20230811145032803](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811145032803.png)



ç„¶åä¸¤å°slaveå°±éƒ½å¥½å•¦ğŸ‘‡

![image-20230811145116317](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811145116317.png)



![image-20230811145052016](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811145052016.png)



### ä¸‹é¢åšåŠåŒæ­¥å•¦ï¼Œå®‰è£…æ’ä»¶ï¼šrpl_semi_sync_master



![image-20230811145725441](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811145725441.png)

é«˜ç‰ˆæœ¬éƒ½æ˜¯wsrep-write set replicationè¿™ç§APIäº†ã€‚

![image-20230811145830046](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811145830046.png)

ä¸ç®¡ï¼Œç¡¬ä¸Šï¼Œç›´æ¥çœ‹å˜é‡SHOW GLOBAL VARIABLES LIKE '%semi%'ï¼›æœ‰å”‰~æˆ‘æ—¥

![image-20230811150708036](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811150708036.png)

ä¼°è®¡è¿™ä¸ªæ’ä»¶åç§°å˜äº†ï¼Œè¢«é›†æˆåˆ°åˆ«çš„æ’ä»¶é‡Œäº†ï¼Œå¯èƒ½å°±æ˜¯wsrepè¿™ä¸ª

ç„¶åçœ‹æ’ä»¶çš„æ–¹æ³•

![image-20230811150843432](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811150843432.png)



### è€ç‰ˆæœ¬è§†é¢‘æˆªå›¾

masterä¸Šå®‰è£…masterå­—çœ¼çš„æ’ä»¶

![image-20230811151217504](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811151217504.png)

ğŸ‘†å®‰è£…åï¼ŒğŸ‘‡çœ‹çœ‹

![image-20230811151259208](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811151259208.png)

çœ‹åˆ°è¿™æˆ‘çŒœè¿™ä¸ªrpl_semi_sync_masterå°±æ˜¯è¢«é«˜ç‰ˆæœ¬é‡Œçš„ğŸ‘‡è¿™ä¸ªå–ä»£äº†

![image-20230811151405662](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811151405662.png)

éƒ½æ˜¯REPLICATION

å…ˆä¸ç®¡wsrepè¿™ä¸ªäº‹ï¼Œå…ˆçœ‹è€ç‰ˆæœ¬çš„æ“ä½œæµç¨‹

æ’ä»¶rpl_semi_sync_masteræœ‰äº†ï¼Œä½†æ˜¯è¿˜éœ€è¦å¯ç”¨ï¼Œé€šè¿‡å˜é‡çœ‹çœ‹çŠ¶æ€ğŸ‘‡ã€‚

![image-20230811151750216](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811151750216.png)

è¿™ä¸ª\_enabledæ˜¯å¯ç”¨ä¸å¦ï¼›\_timeout 10000æ˜¯ä¸‡ä¸€ä¸»--ä»åŒæ­¥ä»è¿Ÿè¿Ÿæ²¡æœ‰å›åº”ï¼Œä¸»ä¹Ÿå°±ç­‰è¿™ä¹ˆä¹…10000æ˜¯10sï¼Œå°±ä¼šå¾€client/proxyé‚£è¾¹å›åº”äº†ã€‚



### å¯ç”¨ä¸€ä¸‹-åœ¨maserä¸Šçš„åŠåŒæ­¥

![image-20230811152156617](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811152156617.png)

ç„¶åçœ‹çœ‹çŠ¶æ€å˜é‡

![image-20230811152320710](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811152320710.png)

å¯è§ğŸ‘†ONäº†ï¼Œç„¶åclienté‚£è¾¹è¿˜æ²¡æœ‰ä½¿ç”¨åŠåŒæ­¥çš„æ’ä»¶ï¼Œä¹Ÿæ²¡æœ‰å¼€å¯ï¼Œæ‰€ä»¥clientæ˜¯0ã€‚

å›åˆ°æˆ‘çš„å®éªŒï¼Œæˆ‘ç”¨çš„é«˜ç‰ˆæœ¬çš„mariadbï¼Œæˆ‘è¯•è¯•è’™ä¸€ä¸‹ï¼Œæˆ‘ä¼°è®¡æ’ä»¶ä¸ç”¨å®‰è£…

ç›´æ¥setä¸€ä¸‹é•¿å¾—åƒçš„å˜é‡onè¯•è¯•ğŸ‘‡

![image-20230811152631138](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811152631138.png)



![image-20230811152659241](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811152659241.png)

æœç„¶ï¼Œæ–°ç‰ˆæœ¬æ— éœ€å®‰è£…ä»€ä¹ˆåŠåŒæ­¥æ’ä»¶äº†ï¼Œè‡³äºè¿™äº›ä¸ªå˜é‡çš„åŠŸèƒ½æ¥æºäºå“ªä¸ªæ’ä»¶ï¼Œæˆ–è€…æ˜¯ä¸æ˜¯  è¢«å–ä»£äº†ï¼Œå†è¯´å›å¤´æˆ‘å»ç¿»ä¸€ç¿»ä¸€èµ„æ–™

![image-20230811152811973](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811152811973.png)

![image-20230811153915807](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811153915807.png)

https://jira.mariadb.org/browse/MDEV-17908ğŸ‘†

å®˜ç½‘ä¸Šä¹Ÿè¯´äº†

https://mariadb.com/kb/en/semisynchronous-replication/

![image-20230811154154394](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811154154394.png)

å¥½åƒä¹Ÿæ²¡å°†æ˜¯é›†æˆåˆ°wsrepé‡Œï¼Œå‘µå‘µï¼Œä¸ç®¡äº†ã€‚



### å¯ç”¨ä¸€ä¸‹-åœ¨slaveä¸ŠåŠåŒæ­¥

#### è€ç‰ˆæœ¬å…·ä½“å°±æ˜¯10.3.3ä¹‹å‰

![image-20230811154448232](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811154448232.png)

ç„¶åshow plugins;çœ‹ä¸‹ğŸ‘‡

![image-20230811154522054](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811154522054.png)

#### é«˜ç‰ˆæœ¬å°±ä¸ç”¨å®‰è£…äº†ï¼Œé»˜è®¤å°±æœ‰åŠåŒæ­¥åŠŸèƒ½



#### ä¸ç®¡æ˜¯è€è¿˜æ˜¯æ–°ç‰ˆæœ¬ï¼Œå¯ç”¨éƒ½æ˜¯è¦å¯ç”¨çš„ï¼Œå¯ç”¨çš„å˜é‡å’ŒæŸ¥çœ‹çŠ¶æ€çš„å˜é‡éƒ½æ˜¯ä¸€æ ·çš„ã€‚

![image-20230811154947696](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811154947696.png)



slave2ä¸€æ ·å¯ç”¨ä¸€ä¸‹

![image-20230811155128177](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811155128177.png)



#### æœ€åè¿˜éœ€è¦é‡å¯slaveçš„çº¿ç¨‹ï¼Œstop slave,start slave

è®°ä½ï¼ä¸æ˜¯reset salveã€‚æˆ‘æ—¥ä½ å¥¶ï¼Œæƒ³è¦reset è¿˜å¾—å…ˆstopï¼Œä¸è¿‡resetä¹Ÿä¸ä¼šçœŸçš„æ¸…ç©ºå°±æ˜¯äº†ï¼Œåªæ˜¯é‡æ–°è®¾ç½®çš„æ—¶å€™æœ‰æ—¶å€™éœ€è¦resetä¸€ä¸‹ã€‚

![image-20230811155940043](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811155940043.png)

![image-20230811160020421](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811160020421.png)



### å¼€å§‹æµ‹è¯•åŒæ­¥æœºåˆ¶

1ã€å½“å‰çŠ¶æ€æ˜¯åŒæ­¥OK

![image-20230811161156450](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811161156450.png)

![image-20230811161208206](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811161208206.png)

![image-20230811161223892](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811161223892.png)



2ã€ç„¶ååŠåŒæ­¥ä¸æ˜¯å·²ç»é…ç½®ä¸”masterä¸Šè®¤åˆ°2ä¸ªclientäº†å—ï¼Œæ‰€ä»¥å°†ä¸¤ä¸ªslaveéƒ½åœæœï¼Œè¿™æ ·å°±ä¸€ä¸ªåŒæ­¥éƒ½ä¸ä¼šå‘ç”Ÿï¼Œç†è®ºä¸Šmasterå°±é‡åˆ°sqlå†™å…¥ï¼Œå°±ä¼šå¡ä½ï¼Œå°±ä¸ä¼šå›åº”cliet/proxyäº†ã€‚ä½†æ˜¯ä¹Ÿä¸ä¼šæ°¸ä¹…å¡åœ¨é‚£ï¼Œå› ä¸ºæœ‰è¶…æ—¶æ—¶é—´10s

![image-20230811161502827](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811161502827.png)

æµ‹è¯•

slave2 åœæœ

![image-20230811161531323](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811161531323.png)

slave1 æ­£å¸¸

masteråˆ›åº“ä¹‹ç±»çš„å†™å…¥æ­£å¸¸

![image-20230811161627896](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811161627896.png)



å†ç»§ç»­å°†slave1åœæœ

æ­¤æ—¶master åˆ›åº“å¡ä½ï¼Œæ—¶é—´å¡äº†10s

![image-20230811161722136](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811161722136.png)

OKï¼

ç„¶åçœ‹çœ‹çŠ¶æ€ï¼Œå°±æœ‰å˜åŒ–äº†

![image-20230811161813426](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811161813426.png)

è¦çŸ¥é“åŸæ¥æ˜¯0éƒ½æ˜¯åŸºæœ¬ä¸Š

<img src="2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811161846863.png" alt="image-20230811161846863" style="zoom:33%;" />



å†ä¸€ä¸ªslaveåªè¦å¯åŠ¨mysqlï¼Œä¹Ÿä¼šè‡ªåŠ¨åŒæ­¥è¿‡æ¥ï¼Œå› ä¸ºslaveæ˜¯é»˜è®¤ ç¬¬ä¸€æ¬¡æ‰‹åŠ¨ï¼Œåé¢éƒ½æ˜¯éšæœåŠ¡å¯åŠ¨è€Œå¯åŠ¨çš„ã€‚

![image-20230811162046082](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811162046082.png)



ä½†æ˜¯æˆ‘å‘ç°åŠåŒæ­¥æ²¡æœ‰å¯åŠ¨ï¼Œclientè¿˜æ˜¯0

![image-20230811162329944](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811162329944.png)



![image-20230811162353744](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811162353744.png)

å“¦ï¼Œä¸æ˜¯çš„ï¼Œæ˜¯ä¹‹å‰setè®¾ç½®çš„globalå˜é‡ï¼Œæ‰€ä»¥é‡å¯æœåŠ¡åå¤±æ•ˆäº†ï¼Œ![image-20230811162458084](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811162458084.png)

å»é…ç½®æ–‡ä»¶é…ç½®ä¸‹ã€‚

```
slaveä¸Š
-------
vim /etc/my.cnf
rpl_semi_sync_slave_enabled
wr
systemctl restart mariadb

jiu ok la~ æ­¤æ—¶masterä¸Šshowå¾—åˆ°clientäº†
```



![image-20230811162709259](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811162709259.png)

ç›¸åï¼Œset global rpl_semi_sync_slave_enabled=ON;æ˜¯éœ€è¦stop å’Œstart slaveçš„ğŸ‘‡

![image-20230811162727305](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811162727305.png)





è¿™æ˜¯æœ€ç»ˆçš„æ•ˆæœ

![image-20230811163147474](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811163147474.png)

slaveä¸Šå€’æ˜¯éƒ½æ˜¯0å“¦ï¼Œå‘µå‘µ

![image-20230811163212861](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811163212861.png)



è¿™äº›å˜é‡çš„æ„æ€ï¼Œå»å®˜ç½‘çœ‹å’¯

https://mariadb.com/kb/en/full-list-of-mariadb-options-system-and-status-variables/

![image-20230811164518591](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811164518591.png)

ä¸€å †ï¼Œæ‰€ä»¥dbaè¯´ç™½äº†å°±æ˜¯è¦å»å­¦ä¹ è¿™ä¸ªå‡ åƒä¸ªå˜é‡~



#### å¤åˆ¶å»¶è¿Ÿæ¼”ç¤ºä¸‹

1ã€slaveä¸Šåˆ æ‰hellodbåº“

2ã€masterä¸Šåœ¨hellodbé‡Œæ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ï¼Œåˆ›å»ºå¤§é‡æ•°æ®

3ã€æ­¤æ—¶slaveä¸Šå°±ä¼šå› ä¸ºæ²¡æœ‰hellodbåº“ï¼Œè€Œå‡ºç°åŒæ­¥å¤±è´¥ï¼Œ

4ã€åœ¨slaveä¸Šè¡¥é½hellodbåº“ï¼Œç„¶åstop startä¸€ä¸‹slaveã€‚åŠæ—¶show slave status\G;çœ‹çœ‹å»¶è¿Ÿã€‚

å¼€å§‹ğŸ‘‡



![image-20230811170810349](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811170810349.png)



![image-20230811170845104](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811170845104.png)



![image-20230811170904016](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811170904016.png)



reset ç”¨äº†å°±çœŸçš„æ¸…æ‰é¢äº†ğŸ‘‡è¿masterçš„binlogæ–‡ä»¶ç¼–å·éƒ½æ²¡äº†ã€‚

![image-20230811171231101](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811171231101.png)



å¯¹æ¯”slave2çš„æ­£å¸¸æƒ…å†µ

![image-20230811171303467](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811171303467.png)





ç¡®å®reseté€ æˆçš„ï¼Œç¿»çœ‹äº†ä¸Šå›¾çš„å†å²æˆªå›¾ï¼Œé‡æ–°æˆªäº†ä¸Šä¸‹æ–‡

![image-20230811172920834](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811172920834.png)



ä½†æ˜¯æˆ‘åœ¨slave2ä¸Šåå¤æµ‹è¯•ï¼Œéƒ½æ²¡æœ‰çœ‹åˆ°resetçš„è¿™ç§æ•ˆæœäº†ï¼Œéœ€è¦æ‰‹åŠ¨

```
stop slave;

reset slave;

CHANGE MASTER TO  MASTER_HOST='192.168.126.129',  MASTER_USER='repluser',  MASTER_PASSWORD='cisco',  MASTER_PORT=3306,  MASTER_CONNECT_RETRY=10,  MASTER_LOG_FILE='mariadb-bin.000003', MASTER_LOG_POS=781;

start slave;
```

![image-20230811173358482](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811173358482.png)

åæ­£èƒ½æå¥½ä¹Ÿæ˜¯äº†ï¼Œå‘µå‘µã€‚æ„Ÿè§‰slave å¤åˆ¶è¿˜æœ‰ç‚¹å‘ã€‚





å…¶å®å¾ˆå¥½ç†è§£å§ï¼Œå°±æ˜¯åŒæ­¥çš„binlogæ˜¯

![image-20230811173528340](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811173528340.png)

å¦‚æœæ²¡æœ‰hellodbåº“ï¼Œæ²¡æœ‰testlogè¡¨ï¼Œå°±ä¸è¡Œï¼Œæ‰€ä»¥åŒæ­¥çš„å“ªä¸ªï¼Œä½ å°†ä¸Šå›¾å¾€ä¸Šç¿»ä¸€ç¿»çœ‹çœ‹ä»masteré‚£è¾¹å¤åˆ¶çš„binlogèµ·ç‚¹ï¼Œå¦‚æœè¿™ä¸ªposå§‹ç»ˆåœ¨hellodb.testlogåˆ›å»ºä¹‹åï¼Œé‚£ä¹ˆæŠ¥é”™å¿…ç„¶å§‹ç»ˆéƒ½åœ¨ã€‚

ä½ åªæœ‰å°†å¤åˆ¶çš„ä½ç½®POSç‚¹æå‰å»è¦†ç›–åˆ°åº“è¡¨çš„åˆ›å»ºæ‰èƒ½æ¶ˆé™¤æŠ¥é”™ã€‚æˆ‘ä¸ç®¡ä½ resetæ˜¯æ€ä¹ˆæ¸…ç©ºäº†masterçš„bingloä½ç½®--å…¶å®å°±æå‰äº†å—ï¼Œä¹Ÿä¸ç®¡ä½ æœ‰æ—¶å€™reset slaveåˆä¸æ¸…ç©ºï¼Œæˆ‘åªç®¡å¤åˆ¶çš„postä½ç½®æ˜¯å¦ç¬¦åˆé€»è¾‘å¯¹å§ã€‚



ä½ çœ‹å“¦ï¼Œè¿™ä¸ªç°è±¡å°±å¯¹äº†

ä¸‹é¢æ˜¯ä¸€ä¸ªæ•´å›¾å“¦ï¼Œå—é™å±å¹•æ‰åˆ†å¼€æ¥çš„

![image-20230811174049897](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811174049897.png)



resetåï¼Œstart çš„ç¬é—´æ˜¯ä¸¤ä¸ªYESå°±æ˜¯OKçš„

![image-20230811174120171](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811174120171.png)

ä½†æ˜¯åˆç¬é—´æŠ¥é”™äº†

![image-20230811174141867](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811174141867.png)

å¾ˆç®€å•å•Šï¼Œå°±æ˜¯ï¼Œæˆ‘è¯´çš„å¤åˆ¶çš„ä¸»ä¸Šçš„postç‚¹åˆè¯»å–äº†ç¼“å­˜è®°å½•--ç±»ä¼¼çš„å§ï¼Œæ²¡æœ‰ä»å¤´å¼€å§‹è¯»å–ã€‚



è¯´äº†è¿™ä¹ˆå±è¯ï¼Œå…¶å®å°±ä¸€å¥è¯ï¼Œæ“ä½œä¸Šè®²â˜…å°±æ˜¯è¦

```
stop slave;

reset slave;

CHANGE MASTER TO  MASTER_HOST='192.168.126.129',  MASTER_USER='repluser',  MASTER_PASSWORD='cisco',  MASTER_PORT=3306,  MASTER_CONNECT_RETRY=10, MASTER_LOG_FILE='mariadb-bin.000003', MASTER_LOG_POS=781;

start slave;
```

MASTER_LOG_FILE='mariadb-bin.000003', MASTER_LOG_POS=781ä¸€å®šè¦ç¡®å®æ˜¯å¦åˆé€‚ï¼

â˜…å…¶å®è§„èŒƒæ“ä½œå°±æ˜¯å…ˆmysqldumpå‡ºæ¥masterçš„æ•°æ®ï¼Œè¿˜åŸåˆ°slaveåï¼Œå†åšslaveçš„å¤åˆ¶ã€‚



å†è¯´å›æ¥ï¼Œä½ è¦çœ‹å¤åˆ¶å»¶è¿Ÿï¼Œç®€å•å•Šï¼Œç›´æ¥POSæŒ‡åˆ°å‰é¢å»å°±è¡Œå•¦ğŸ‘‡

![image-20230811175634613](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811175634613.png)

é‚£ä¹ˆé—®é¢˜æ¥äº†3395æ˜¯ç§’ï¼Œè¿˜æ˜¯è®°å½•è¿˜æ˜¯ï¼Œå•¥ï¼Œç®€å• å®˜ç½‘å˜é‡èµ°ä¸€æ³¢ï¼Œä½ éº»ç—¹ï¼Œåˆ«å­¦äº†ï¼Œsecondes_behindï¼Œä½ è·Ÿæˆ‘è®²å»æŸ¥èµ„æ–™ã€‚(â—Ë‡âˆ€Ë‡â—)ï¼Œè€Œä¸”æ˜ç¡®å‘Šè¯‰ä½ æ²¡æœ‰è¿™ä¸ªå˜é‡çš„ã€‚



![image-20230811180459693](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230811180459693.png)



