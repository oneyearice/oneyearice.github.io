# ç¬¬2èŠ‚. mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶



# è¡¥å……å‡ ä¸ªé€‰é¡¹

![image-20230810134026214](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810134026214.png)

### 5ä¸ªå†™ç£ç›˜çš„åŠæ—¶æ€§ï¼š

sync_binlog=1     binlogçš„åŠæ—¶å†™ç£ç›˜ï¼Œ

innodb_flush_log_at_trx_commit=1       äº‹åŠ¡çš„åŠæ—¶å†™ç£ç›˜ï¼Œå½“ç„¶ä¸æ˜¯è¯´åŠæ—¶å°±ä¸€å®šæ˜¯å¥½çš„ï¼Œä¹Ÿè¦è€ƒè™‘IOçš„è´Ÿæ‹…ã€‚

sync_master_infoæ˜¯  å¤šå°‘æ¬¡ äº‹ä»¶å master.infoçš„ä¿¡æ¯ å†™ç£ç›˜

sync_relay_log   å¤šå°‘æ¬¡ ååŒæ­¥åˆ°relaylogç£ç›˜æ–‡ä»¶ï¼Œåº”è¯¥ä¹Ÿæ˜¯æŒ‡relay-log.infoæ–‡ä»¶å§ã€‚

sync_relay_log_info    å¤šå°‘æ¬¡äº‹åŠ¡å ååŒæ­¥åˆ°relay-log.infoç£ç›˜æ–‡ä»¶ã€‚



skip-slave-start=ON  # è¦çŸ¥é“ä¸€ä¸ªäº‹å®--é‡å¯mariadbæœåŠ¡åï¼Œslaveçš„ä¸¤ä¸ªçº¿ç¨‹IOå’ŒSQLéƒ½æ˜¯OKçš„ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€æ¬¡æ‰‹åŠ¨start slave;åé¢éƒ½ä¸ç”¨ç®¡çš„ï¼Œéƒ½æ˜¯éšæœåŠ¡å¯åŠ¨å°±å¯åŠ¨çš„ã€‚è¿™ä¸ªç‰¹æ€§å°±æ˜¯ä¾èµ–äºskip-slave-startè¿™ä¸ªé€‰é¡¹ï¼Œå¦‚æœç½®ä¸ºONï¼Œå°±ä¸ä¼šéšæœåŠ¡å¯åŠ¨äº†ï¼Œåˆ°æ—¶å€™å°±åªèƒ½æ‰‹åŠ¨æ¯æ¬¡start slaveäº†ã€‚







# ä¸»-ä¸» å¤åˆ¶ï¼Œéœ€è¦è°ƒåº¦å›ºå®šåˆ†é…æˆä¸»-ä»



ä¸»-ä¸»å‰é¢ä¸€ç¯‡å°±è®²è¿‡äº†ï¼Œè¿™ç§çš„å¥½å¤„ï¼Œæ˜¯å¤šæ´»å—ï¼Œæ— éœ€ä»èŠ‚ç‚¹æå‡ è¿™ä¹ˆä¸€ä¸ªåŠ¨ä½œã€‚



æ‰€è°“ä¸»ä¸»ï¼Œå…¶å®æ˜¯äº’ä¸ºä¸»ä»ï¼ŒA-B ä¸¤ä¸ªæœºå™¨ï¼ŒAæ˜¯Bçš„ä¸»ï¼Œåˆæ˜¯Bçš„ä»ï¼ŒBä¸€æ ·ã€‚



---

ä¸è¿‡æœ‰äººå°±æ˜¯è¦çœŸæ­£æ„ä¹‰ä¸Šçš„ä¸»ä¸»ï¼Œå¤šæ´»ï¼ŒA/Aï¼Œç±»ä¼¼ASAçš„A/Aï¼Œäººå®¶å°±æ˜¯è¦å¹¶å‘å†™ï¼Œæˆ‘é‚£ä¸ªå»ï¼Œæ€ä¹ˆæï¼Œè¿™ä¹ˆæã€‚

![image-20230810140651676](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810140651676.png)

æ‰€è°“çš„å¹¶å‘å†™ï¼ŒA/Aï¼Œå…¶å®å°±æ˜¯é€šè¿‡

![image-20230810141138154](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810141138154.png)

auto_incrementï¼šä¹Ÿå°±æ˜¯å¥‡å¶åŒºåˆ†ï¼Œä¸åŒçš„ä¸»èµ·å§‹ä¸é€šï¼Œé—´éš”ä¸€æ ·ï¼Œé”™å¼€åºå·äº†å°±ã€‚

ç„¶åå†é…åˆå‰ç½®è°ƒåº¦å™¨ï¼Œæ¯”å¦‚ï¼Œæ¥äº†2æ¡å†™æ“ä½œï¼Œè°ƒåº¦å™¨å°±ç›´æ¥å¹¶å‘çš„æ‰”ç»™2ä¸ªä¸»ï¼Œè€Œ2ä¸ªä¸»å¤„ç†çš„æ—¶å€™åˆæ˜¯é”™å¼€PRIä¸»é”®IDçš„ï¼Œäºæ˜¯å°±å®ç°äº†å¤šä¸»ã€‚



```
èŠ‚ç‚¹Aä¸Š
------
yum -y remove mariadb-server
rm -rf /var/lib/mysql/*
cp -a /etc/my.cnf /etc/my.cnf.bak

yum -y install mariadb-server
vim /etc/my.cnf
	[mysqld]
	server-id=1
	log-bin
	auto_increment_offset=1
	auto_increment_increment=2
wr

systemctl start mariadb

mysql > grant replication slave on *.* to repluser@'192.168.126.%' identified by 'cisco';


```

```
èŠ‚ç‚¹Bä¸Š
------
yum -y remove mariadb-server
rm -rf /var/lib/mysql/*
cp -a /etc/my.cnf /etc/my.cnf.bak

yum -y install mariadb-server
vim /etc/my.cnf
	[mysqld]
	server-id=2
	log-bin
	auto_increment_offset=2
	auto_increment_increment=2
wr

systemctl start mariadb

 // mysql > grant replication slave on *.* to repluser@'192.168.126.%' identified by 'cisco';   # è¿™å¥å°±ä¸ç”¨æ•²äº†ï¼Œç›´æ¥å¤åˆ¶è¿‡æ¥ä»Aã€‚
 
 mysql > 
 CHANGE MASTER TO
 MASTER_HOST='192.168.126.129',
 MASTER_USER='repluser',
 MASTER_PASSWORD='cisco',
 MASTER_PORT=3306,
 MASTER_CONNECT_RETRY=10,
 MASTER_LOG_FILE='mariadb-bin.000001', MASTER_LOG_POS=330;   # å»Açœ‹ä¸‹show master logs;å°†binglogæ–‡ä»¶å’Œposä½ç½®å¤åˆ¶è¿‡æ¥ã€‚ä¸è¿‡è¿™ä¸ªè¦é…åˆmysqldump ä»Aå¤‡ä»½è¿˜åŸåˆ°Bï¼Œå¦‚æœä¸æƒ³è¿™ä¹ˆéº»çƒ¦ï¼Œç›´æ¥å°†è¿™é‡Œçš„binglogè®¾ç½®æˆç¬¬ä¸€ä¸ªæ–‡ä»¶çš„ç¬¬ä¸€ä¸ªä½ç½®ä¸€èˆ¬æ˜¯330å·¦å³ã€‚å¯ä»¥åˆ·æ–°ä¸€ä¸ªbinlogï¼Œçœ‹çœ‹åˆå§‹å€¼å¤šå°‘ã€‚æ”¾å±ï¼è¿™æ ·ä»å¤´å¤åˆ¶ç›´æ¥æŠ¥é”™ï¼å“ˆå“ˆå› ä¸ºå¤åˆ¶çš„æ—¶å€™å¯ä¸ä¼šæƒ³mysqldumpå‡ºæ¥çš„æœ‰IFåˆ¤æ–­å­˜åœ¨å°±DROPçš„è¯­å¥ï¼Œä¸»ä»å¤åˆ¶å¦‚æœå­˜åœ¨å°±ç›´æ¥æŠ¥é”™å¡ä½äº†ã€‚
 
 æ‰€ä»¥è¿™é‡Œçš„binlogå’Œposéœ€è¦å…ˆå»masterä¸Šshow master logs;å¤åˆ¶è¿‡æ¥çš„ï¼Œç„¶åmasterå‰é¢çš„æ•°æ®éœ€è¦dumpè¿‡æ¥çš„ã€‚
 

```

æŠ¥é”™å•¦

![image-20230810161837911](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810161837911.png)

```
è¿˜æ˜¯å»Aä¸Šdumpå§

mysqldump -A --single-transaction --master-data=1 > /data/all.sql
scp /data/all.sql root@192.168.126.130:/data/
```

![image-20230810162257932](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810162257932.png)

```
å»Bä¸Šè¿˜åŸä¸‹
msyql > stop slave;
mysql < /data/all.sql
msql > show databaes;   å¯è§hellodbåŒæ­¥è¿‡æ¥äº†
mysql > start slave;
mysql > show slave status\G;   è¿™å›å°±OKäº†ã€‚

```

![image-20230810162412356](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810162412356.png)

![image-20230810162422644](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810162422644.png)

è¿™å°±å¥½äº†ï¼Œæœç„¶æ˜¯primaryä¸»é”®å¯èƒ½ä¸è®©å†™å¥‡æ•°å§ï¼Œå› ä¸º/etc/my.cnfé‡Œæ˜¯åšäº†å¶æ•°é™åˆ¶

<img src="2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810162621208.png" alt="image-20230810162621208" style="zoom:50%;" />



æœç„¶ä¸ªå±ï¼Œå†ä»”ç»†çœ‹çœ‹æŠ¥é”™ï¼Œæ˜¯dupicate

![image-20230810163449550](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810163449550.png)

è¿™å°±æ˜¯å·²ç»è¯´ä¸»ä»å¤åˆ¶çš„æ—¶å€™ï¼Œå·²ç»æœ‰çš„æ•°æ®åº“ï¼Œé‡Œé¢çš„è¡¨ï¼Œå†æ¬¡å†™çš„æ—¶å€™å°±æŠ¥é”™äº†ï¼Œ

ä½†æ˜¯mysqldump å‡ºæ¥çš„all.sqlé‡Œå…¶å®ä¹Ÿæ˜¯å¤§é‡çš„sqlè¯­è¨€ï¼Œä½†æ˜¯äººå®¶æ˜¯å†™äº†IF æ¡ä»¶åˆ¤æ–­çš„ï¼Œå¦‚æœå­˜åœ¨è¿™ä¸ªè¡¨æ ¼å°±DROPçš„å•Šï¼Œå“ˆå“ˆï¼Œå¯¹å§mydqldumpæ˜¯å…ˆé“²é™¤åè¿˜åŸå•Šï¼Œæ‰€ä»¥ä¸ä¼šæŠ¥é”™å•ŠğŸ‘‡

![image-20230810163920576](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810163920576.png)

è€Œå¤åˆ¶å°±ä¸æ˜¯å•¦ï¼Œå­˜åœ¨çš„å°±å†²çªäº†ã€‚ç°åœ¨çŸ¥é“ä¸ºä»€ä¹ˆæ¯æ¬¡éƒ½dumpè€Œä¸æ˜¯ä»å¤´åšå¤åˆ¶äº†å§ã€‚



ç°åœ¨ä¼ ç»Ÿçš„ä¸»-ä»å°±OKï¼Œæµ‹è¯•ä¸€ä¸‹

![image-20230810171520308](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810171520308.png)

![image-20230810171509543](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810171509543.png)





## ç„¶åæŠŠèŠ‚ç‚¹Bä¹Ÿå°±æ˜¯slaveä¹Ÿå˜æˆmaster

```
Bä¸Šä¹Ÿå°±æ˜¯slaveï¼š
------
mysql > show master logs;


```

![image-20230810171541654](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810171541654.png)

```
Aä¸Šä¹Ÿå°±æ˜¯masterï¼š
---------
 
mysql > 
 CHANGE MASTER TO
 MASTER_HOST='192.168.126.130',
 MASTER_USER='repluserB',
 MASTER_PASSWORD='cisco',
 MASTER_PORT=3306,
 MASTER_CONNECT_RETRY=10,
 MASTER_LOG_FILE='mariadb-bin.000002', MASTER_LOG_POS=2539205;
 
 ä¸Šé¢çš„binglogæ–‡ä»¶å’Œposä½ç½®å°±æ˜¯Bä¸Šçœ‹åˆ°çš„å¤åˆ¶è¿‡æ¥çš„ï¼Œæ•²å®ŒAå°±æ˜¯ä»äº†ï¼Œå½“ç„¶è¿˜å¾—start slaveä¸€ä¸‹ï¼›
 
mysql > start slave;
mysql > show slave status\G;
```

ç„¶åå°±æŠ¥é”™äº†

![image-20230810172640127](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810172640127.png)

å¥‡äº†æ€ªäº†ï¼Œç”¨æˆ·ç¡®è®¤åŒæ­¥è¿‡å»äº†å•Šï¼Œå¯†ç é€šè¿‡å“ˆå¸Œå€¼éƒ½èƒ½åˆ¤æ–­æ˜¯ä¸€è‡´çš„ğŸ‘‡

![image-20230810172745859](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810172745859.png)





![image-20230810172705241](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810172705241.png)



ä¸ç®¡å…ˆåœ¨Bä¸Šæ–°å»ºä¸€ä¸ªç”¨æˆ·è¯•è¯•

```
åœ¨Bä¸Š
-----
 grant replication slave on *.* to repluserB@'192.168.126.%' identified by 'cisco';
```

![image-20230810173046337](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810173046337.png)



![image-20230810173136519](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810173136519.png)



é ï¼å¥½äº†ï¼Œéš¾é“ç”¨æˆ·è¦å•ç‹¬åˆ›å»ºå’¯ï¼Œå¥½å§ã€‚éš¾é“ä¸»ä¸»ï¼Œå¤åˆ¶ç”¨æˆ·å¿…é¡»å„è‡ªå•ç‹¬åˆ›å»ºã€‚ä¸æ˜¯ï¼Œåé¢æˆ‘åˆæŠŠAçš„å¤åˆ¶ç”¨æˆ·æ¢å›å»åˆå¯ä»¥äº†ã€‚æ„Ÿè§‰æ˜¯è¿™ä¸ªç”¨æˆ·æ²¡æœ‰åœ¨Bä¸Šç”Ÿæ•ˆã€‚

<img src="2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810174357148.png" alt="image-20230810174357148" style="zoom:50%;" />

å¥½åƒflush privileges;å°±å¥½äº†ï¼Œä¸è¿‡æˆ‘è®°å¾—æˆ‘åˆ·è¿‡å•Šï¼Œä¼°è®¡å°±æ˜¯æ²¡ç”Ÿæ•ˆå½“æ—¶ï¼Œç„¶åè¿‡ä¸€ä¼šç”Ÿæ•ˆäº†ï¼Œæˆ–è€…æ˜¯åˆ›å»ºrepluserBçš„æ—¶å€™ç›¸å½“äºåˆåˆ·äº†ä¸€æ¬¡ï¼Œæˆ‘å½“æ—¶åº”è¯¥å¤šåˆ·å‡ æ¬¡çš„ï¼Œ(ï¿£â–½ï¿£)"ã€‚



![image-20230810174556864](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810174556864.png)





A->B å’ŒA<-B åŒå‘åŒæ­¥å°±éƒ½æµ‹è¯•åˆ°äº†ğŸ‘‡

![image-20230810173356188](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810173356188.png)



![image-20230810173427835](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810173427835.png)





## æ¨¡æ‹Ÿå†™è¡¨çœ‹çœ‹æ˜¯å¦å†²çª-ä¸»ä¸»çš„æ—¶å€™

```
Aä¸Š
-----
mysql > use hellodb
mysql > create table test (id int auto_increment primary key, name char(10));

mysql > desc test;

```



![image-20230810175251661](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810175251661.png)

æ­¤æ—¶Bä¸Šä¹Ÿæœ‰äº†

![image-20230810175344445](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810175344445.png)



```
é€šè¿‡xshelçš„æ‰¹é‡ä¸‹å‘cliï¼Œç»™Aå’ŒBåŒäº‹æ•²å…¥insert

insert test (name) values ('wang');

```

![image-20230810180052019](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810180052019.png)



è¿™æ ·å°±åŒæ—¶é”®å…¥äº†sql insert

![image-20230810180224614](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810180224614.png)



![image-20230810180533473](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810180533473.png)

ä¸å†²çªï¼Œå·¦è¾¹Aæ˜¯1ï¼Œå³è¾¹Bæ’å…¥çš„æ˜¯2å¶æ•°ï¼Œå¥‡å¶é”™å¼€æ¥çš„ã€‚



![image-20230810193755718](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810193755718.png)

è¿˜æ˜¯ä¸€æ ·å·¦è¾¹1 3 5 ï¼Œå³è¾¹2 4 6



åˆ›å»ºè¡¨ï¼Œç†åº”å†²çª

![image-20230810194117844](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810194117844.png)

ä½†æ˜¯é«˜ç‰ˆæœ¬ç¡®å®ä¸ä¼šäº†ï¼Œä¸çŸ¥é“æ€ä¹ˆå®ç°çš„ã€‚



æˆ‘ç†è§£ä¸€å®šæ˜¯æœ‰ä¸€ä¸ªè¢«å›é€€äº†ï¼Œå†…éƒ¨å¿½ç•¥äº†ï¼Œå»æ‰¾æ‰¾ç›¸å…³èµ„æ–™ã€‚



![image-20230810195508311](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810195508311.png)

ä¸­æ–‡ä¼šç¿»è¯‘æ‰äº†ä¸€å†™ é‡è¦çš„ ä¸“ä¸šè¯æ±‡ï¼Œå°±æ˜¯äººå®¶èµ·çš„åå­—å§ï¼Œé€šè¿‡è‹±æ–‡å»é—®å¾—åˆ°è‹±æ–‡çš„å›ç­”

![image-20230810200423244](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810200423244.png)

é€šè¿‡GPTæ‰¾åˆ°äº†å…³é”®ä¿¡æ¯ï¼Œç„¶åé€šè¿‡å…³é”®ä¿¡æ¯å»å®˜ç½‘å†æ‰¾

![image-20230810200534191](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810200534191.png)

https://mariadb.com/kb/en/about-galera-replication/

![image-20230810200504940](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810200504940.png)

ç„¶åçœ‹çœ‹é»˜è®¤çš„å€¼å°±æ˜¯1ğŸ‘‡

![image-20230810200251384](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810200251384.png)

ç¡®è®¤äº†ğŸ‘†

è¿˜æœ‰è¿™ä¸€ç¯‡ä¹Ÿå†™çš„ä¸é”™

https://galeracluster.com/library/documentation/certification-based-replication.html

![image-20230810201309719](2-mysqlä¸»ä¸»å’ŒåŠåŒæ­¥å¤åˆ¶.assets/image-20230810201309719.png)



