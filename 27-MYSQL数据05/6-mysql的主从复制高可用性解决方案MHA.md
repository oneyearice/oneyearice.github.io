# ç¬¬6èŠ‚. mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA

æˆ‘ä¸ºä»€ä¹ˆè¦ç”¨è¿™ä¸ªä¸œè¥¿å‘¢ï¼Œä¸€ä¸ªperl è¯­è¨€å†™çš„ä¸œè¥¿ï¼Œæœ€æ–°ç‰ˆæœ¬2012å¹´ï¼Œéš¾é“æ˜¯å› ä¸ºå…è´¹å®ç”¨å¤Ÿç”¨ï¼Ÿå¥½å§



# MHAæ¶æ„

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915153246355.png" alt="image-20230915153246355" style="zoom:50%;" />



managerèŠ‚ç‚¹ï¼Œç®¡ç†ç€å¤šä¸ªä¸»ä»ï¼ŒæŸä¸€å †ä¸»ä»çš„masteræŒ‚äº†ï¼Œå°±ä¼šæŠŠåœ¨é‚£å †ä¸»ä»é‡Œçš„æ‰¾ä¸€ä¸ªslaveæå‡ä¸ºmasterã€‚



managerç®¡ç†èŠ‚ç‚¹ï¼Œæ˜¯å•ç‚¹ï¼Œä½†æ˜¯é—®é¢˜ä¸å¤§ï¼Œå› ä¸ºç”¨æˆ·è®¿é—®çš„ä¸šåŠ¡ä¸èµ°å®ƒèµ°ï¼Œå®ƒæŒ‚äº†ï¼Œä¸å½±å“ä¸šåŠ¡ï¼›é™¤éè¿æ°”å¥½ï¼ŒmanageræŒ‚äº†çš„æ—¶é—´æ®µé‡Œï¼ŒæŸä¸ªä¸»ä»çš„ä¸»ä¹ŸæŒ‚äº†ï¼Œæ­¤æ—¶ç”±äºæ²¡æœ‰ç®¡ç†èŠ‚ç‚¹ï¼Œæ‰€ä»¥å°±æ— æ³•è‡ªåŠ¨æå‡slaveï¼Œæ‰€ä»¥ä¹Ÿå°±å¯¼è‡´ä¸šåŠ¡å‡ºé—®é¢˜äº†ï¼ŒæŒ‰ä¼ ç»Ÿçš„æ€è·¯å†™æ˜¯è¦åˆ†æµåˆ°masterä¸Šçš„ï¼Œæ­¤æ—¶masteréƒ½æ²¡äº†ï¼Œæ‰€ä»¥ä¸šåŠ¡æ”¶åˆ°äº†å½±å“ã€‚





# MHAçš„å·¥ä½œåŸç†ä»‹ç»



å…ˆå¤ä¹ ä¸€ä¸‹ä¸»ä»çš„åº•å±‚

![image-20230915155137252](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915155137252.png)

![image-20230915155216625](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915155216625.png)

**å†æ¥ç†è§£ä¸‹å›¾MHAçš„æ€è·¯**

![image-20230915160342811](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915160342811.png)

1ã€ä¸‰æ ¹æŸ±å­ä»£è¡¨ä»€ä¹ˆ

2ã€æŸ±å­ä¹‹é—´çš„è½å·®ï¼Œå°±æ˜¯binlogè½å·®

3ã€slave(i)è¿™ä¸ªiæ˜¯å˜é‡ï¼Œå°±æ˜¯å¾ˆå¤šä¸ªslaveçš„æ„æ€ï¼Œu known~ï¼Œè¿™äº›ä¸å¤ªä¼˜ç§€çš„slave(i)ä»¬ï¼Œä¸ä»…ä»…ä»masteré‚£æ‹¿åˆ°çš„binglogæ¯”æœ€ä¼˜ç§€çš„lastest slaveè¦å°‘ä¸€æˆª<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915160652170.png" alt="image-20230915160652170" style="zoom:25%;" />ï¼Œè€Œä¸”å†™åˆ°æœ¬åœ°è¿˜å†™çš„æ…¢<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915160720348.png" alt="image-20230915160720348" style="zoom:25%;" />ã€‚

4ã€æ‰€ä»¥çŸ®å­å½“ä¸­é€‰å°†å†›å’¯ï¼Œæ–°çš„masteré€‰å‡ºæ¥åï¼Œ

5ã€æƒ³åŠæ³•è¡¥é½DeadMasterå’ŒLatestSlaveä¹‹é—´çš„binlogå·®ï¼Œæ€ä¹ˆæƒ³åŠæ³•ï¼šâ‘ deadä¸æ˜¯æœºå™¨deadåªæ˜¯æœåŠ¡deadå°±å»æ‰¾binlogæ–‡ä»¶ï¼›â‘¡binlogæ˜¯å¦æœ‰å¼‚åœ°å¤‡ä»½ï¼›â‘¢æ²¡æœ‰å¼‚åœ°ï¼Œæœ¬åœ°é‡å¯çœ‹çœ‹ä¹Ÿè¡Œå•Šå¯¹ä¸å¯¹ï¼Œæ€»ä¹‹æ‰¾åˆ°dead masterä¸Šçš„binlogï¼Œè¡¥é½åˆ°LatestSlaveä¸Šï¼Œä¸è¿‡è¿™äº›ç†è®ºä¸Šéƒ½æ˜¯MHAå®ç°çš„ï¼Œæ‰€ä»¥MHAä¸å¤ªå¯èƒ½è¯´ç»™ä½ å¼‚åœ°å–å¤‡ä»½ï¼Œä¹Ÿä¸å¤ªå¯èƒ½ç»™ä½ é‡å¯deadmasteræœºå™¨ï¼Œæ‰€ä»¥MHAèƒ½è‡ªåŠ¨å¤„ç†çš„åº”è¯¥å°±æ˜¯æœºå™¨æ²¡æ­»mysqlæœåŠ¡æ­»çš„çš„æƒ…å†µå»å»binlogæ–‡ä»¶ã€‚

6ã€slave(i)åŒæ­¥ä¹‹å‰å¯èƒ½ä¹Ÿè¦åšä¸¤ä¸ªäº‹æƒ…ï¼šâ‘ SQL Threadè¿›ç¨‹èµ°å®Œï¼ŒæŠŠå·²ç»æ‹¿åˆ°çš„binlogå†™åˆ°æœ¬åœ°æ–‡ä»¶é‡Œï¼›â‘¡æŠŠå’ŒLastest Slaveä¹‹é—´çš„å·®è·é€šè¿‡I/O Threadè¡¥é½ï¼›ç„¶åå°±ç»§ç»­åŒæ­¥ã€‚

![image-20230915162106756](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915162106756.png)

çœ‹å®ƒæ„æ€ï¼Œ

![image-20230915162137293](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915162137293.png)

è¿™ä¹ˆéº»çƒ¦çš„å—ï¼Œéš¾é“ä¸æ˜¯slave æ‰€æœ‰çš„saveåŒ…æ‹¬æœ€ä¼˜çš„é‚£ä¸ªslaveï¼Œç»Ÿç»Ÿä»deadmasteråŒæ­¥Xï¼Œå”‰ä¸å¯¹ï¼ŒåŒæ­¥å„è‡ªçš„å·®å¼‚binlogå˜›ã€‚



ä¼°è®¡æ˜¯æ€•deadmasterè¿æœºå™¨éƒ½æŒ‚äº†ï¼Œsshä¸Šä¸å»ï¼ŒMHAçš„manageæ‹¿ä¸åˆ°binlogï¼Œå°±åšä¸äº†Xï¼Œæ‰€ä»¥æ‰æœ‰äº†<font color=red>i1-->i2-->X</font>è¿™ä¹ˆä¸€ä¸ªå…ˆååŒæ­¥çš„è¿‡ç¨‹ï¼Œå°±æ˜¯æ¯æ¬¡åŒæ­¥çš„åŠ¨ä½œä¸å¤§ï¼Œèƒ½æˆåŠŸçš„åŒæ­¥å…ˆåšäº†ã€‚

i1å°±æ˜¯æœ¬åœ°çš„sqlçº¿ç¨‹å°†relylogå†™åˆ°åº“é‡Œï¼Œi2å°±æ˜¯slaveä»¬ä»æœ€ä¼˜çš„slaveå»å–å·®å¼‚binlogï¼›Xå°±æ˜¯deadMasterä¸Šå–binlogè¿™ä¸ªå¯èƒ½å°±ä¸ä¸€å®šæˆåŠŸã€‚



**æ‰€ä»¥MHAè¦åˆ©ç”¨åˆ°sshï¼Œscpè¿™äº›åè®®**



![image-20230915170454483](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915170454483.png)



managerå·¥å…·åŒ…éœ€è¦epelæºï¼Œnodeå·¥å…·åŒ…ä¸éœ€è¦epelæºã€‚

managerå·¥å…·åŒ…å®‰è£…åœ¨managerèŠ‚ç‚¹ä¸Šï¼Œnodeå·¥å…·åŒ…å®‰è£…åœ¨ç›‘æ§çš„ä¸»ä»èŠ‚ç‚¹ä¸Šå’ŒmanagerèŠ‚ç‚¹ä¸Šã€‚



![image-20230915171241325](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915171241325.png)

åŠåŒæ­¥å¤åˆ¶ï¼Œé»˜è®¤æ˜¯å¼‚æ­¥ä¼šå­˜åœ¨slaveå’Œmasterå·®å¼‚è¶Šæ¥è¶Šå¤§çš„å¯èƒ½ï¼Œè€ŒåŠåŒæ­¥ï¼Œå°±èƒ½ä¿è¯åªè¦æœ‰ä¸€å°slaveå›åº”æˆ‘masteräº†ï¼Œmasterå°±å›ç­”clientäº†ã€‚å‚è§ ç¬¬äºŒåä¸ƒç«  MYSQLæ•°æ®05-ç¬¬2èŠ‚

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915172140195.png" alt="image-20230915172140195" style="zoom: 33%;" />

masterä½œä¸ºåŠåŒæ­¥çš„ä¸€ä¸ªå…³é”®ç‚¹ï¼Œå®ƒçš„è¡Œä¸ºå°±æ˜¯åªè¦æ”¶åˆ°ä¸€å°slaveçš„å“åº”å°±ä¼šå›åº”clientã€‚é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œè¿™ç§è¡Œä¸ºä¸‹ï¼Œslave(i)ä»¬æ˜¯å¦æ˜¯ä¿è¯ä¸€å®šæœ‰ä¸€å°æ˜¯æœ€ä¼˜çš„ï¼Œä¼šä¸ä¼šå‡ºç°ä¸åŒçš„æ•°æ®åˆ†æ•£åˆ°ä¸åŒçš„slaveä¸Šï¼Œä¸ä¼šï¼åŒæ­¥çš„æœºåˆ¶å°±æ˜¯binlogçš„postiä½ç½®ï¼ŒæŒ‰åºå¤åˆ¶çš„ï¼Œæ‰€ä»¥æŸå°slaveå›åº”äº†masterï¼Œé‚£ä¹ˆè¿™å°slaveä¸€å®šå·²ç»å–åˆ°äº†æœ€æ–°çš„æ•°æ®äº†ï¼  å‘¼~~~



ç®€å•äº†è§£ğŸ‘‡

![image-20230915174020653](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915174020653.png)

MHAæœ‰ä¸ªé…ç½®æ–‡ä»¶ï¼š

â€‹		å…¶ä¸­globalé…ç½®ï¼šå°±æ˜¯ä¸ºå„ä¸ªä¸»ä»(å®ƒå«åšapplication)æä¾›é»˜è®¤çš„ç»Ÿä¸€é…ç½®æ¨¡æ¿

â€‹		å¦‚æœæƒ³ä¸ºå•ä¸ªæŸä¸ªä¸»ä»ï¼Œé…ç½®ï¼Œå°±é’ˆå¯¹ä»–ä»¬é…ç½®applicationå…³é”®å­—çš„é…ç½®ã€‚





**åœ¨ç®¡ç†èŠ‚ç‚¹ä¸Šå®‰è£…ä¸¤ä¸ªåŒ… mha4mysql-manager mha4mysql-node**

**åœ¨è¢«ç®¡ç†èŠ‚ç‚¹å®‰è£… mha4mysql-node**



**åœ¨ç®¡ç†èŠ‚ç‚¹å»ºç«‹é…ç½®æ–‡ä»¶**

```
vim /etc/mastermha/app1.cnf  # app1å°±æ˜¯åº”ç”¨1ï¼Œå°±æ˜¯å¯¹åº”ä¸€ç»„ä¸»ä»ï¼Œå¦å»ºä¸€ä¸ªapp2.cnfå°±æ˜¯å¯¹åº”ç¬¬äºŒç»„ä¸»ä»
[server default]
user=mhauser  # ç”¨æ¥æå‡slaveä¸ºmasterçš„è´¦å·ï¼Œå°±æ˜¯éœ€è¦ç™»å…¥mysqlå»ä¿®æ”¹é…ç½®çš„ã€‚
password=cisco
manager_workdir=/data/mastermha/app1/
manager_log=/data/mastermha/app1/manager.log
remote_workdir=/data/mastermha/app1/  # è¿œç«¯ä¸»æœºä¸Šçš„å­˜æ”¾è·¯å¾„
ssh_user=root  # binlogåˆ©ç”¨ssh scpæ‹·è´è¿‡æ¥
repl_user=repluser  # ä¸»ä»å¤åˆ¶çš„è´¦å·ä¹Ÿè¦
repl_password=cisco
ping_interval=1  # 1s pingæ¢æµ‹ä¸»æœåŠ¡å™¨æ˜¯å¦åœ¨çº¿

[server1]
hostname=192.168.126.129
candidate_master=1
[server2]
hostname=192.168.126.130
candidate_master=1
[server3]
hostname=192.168.126.131

```



**åœ¨Masterä¸Šé…ç½®**

```mysql
vim /etc/my.cnf
[mysqld]  log-bin
server_id=1
skip_name_resolve=1  # åœ¨MHAé‡Œå¿…é¡»è¦é…ç½®ï¼Œå¦åˆ™é»˜è®¤MHAè¡Œä¸ºæ˜¯åšipåœ°å€åå‘è§£æï¼Œå¯¼è‡´ç”¨æˆ·IDè¯†åˆ«å‡ºé—®é¢˜ã€‚

mysql>show master logs
mysql>grant replication slave on *.* to repluser@'192.168.8.%' identified  by â€˜cisco';  # ä¸»ä»å¤åˆ¶è´¦å·å’Œæˆæƒ
mysql>grant all on *.* to mhauser@'192.168.8.%â€™identified byâ€˜cisco';  # mhaçš„ç®¡ç†è´¦å·ï¼Œç”¨æ¥æå‡slaveä¸ºmasterï¼Œéœ€è¦ä¿®æ”¹é…ç½®çš„ã€‚

```

**åœ¨slaveä¸Š**

```mysql
vim /etc/my.cnf  
[mysqld]  
server_id=2  #ä¸åŒèŠ‚ç‚¹æ­¤å€¼å„ä¸ç›¸åŒ  
log-bin  # ä»èŠ‚ç‚¹æœ¬æ¥æ— éœ€binlogï¼Œä½†æ˜¯å°†æ¥è¦æå‡ä¸ºmasterï¼Œæ‰€ä»¥éœ€è¦äº‹å…ˆå¼€å¯binlog
read_only
relay_log_purge=0  # é»˜è®¤ä¼šæ¸…é™¤ä¸­ç»§æ—¥å¿—ï¼Œè¿™é‡Œä¸æ¸…æ¥šï¼Œå°†æ¥å¯èƒ½æ¢å¤ä½¿ç”¨ã€‚
skip_name_resolve=1

mysql>CHANGE MASTER TO MASTER_HOST=â€˜MASTER_IPâ€™,
     MASTER_USER='repluser', MASTER_PASSWORD=â€˜ciscoâ€™,
     MASTER_LOG_FILE='mariadb-bin.000001', MASTER_LOG_POS=245;

```



**åœ¨æ‰€æœ‰èŠ‚ç‚¹å®ç°ç›¸äº’ä¹‹é—´ssh keyéªŒè¯**



**MHAéªŒè¯å’Œå¯åŠ¨**

```shell
masterha_check_ssh --conf=/etc/mastermha/app1.cnf  # æ£€æŸ¥ssh keyéªŒè¯æ˜¯å¦OK

masterha_check_repl --conf=/etc/mastermha/app1.cnf  # æ£€æŸ¥ä¸»ä»å¤åˆ¶æ˜¯å¦OK

masterha_manager --conf=/etc/mastermha/app1.cnf  # å¯åŠ¨MHAé›†ç¾¤ï¼Œæ­¤æ—¶å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ã€‚
```



**æ’é”™æ—¥å¿—**

```bash
/data/mastermha/app1/manager.log  # æ¯”å¦‚æœåŠ¡èµ·ä¸æ¥ï¼Œå¯ä»¥çœ‹çœ‹æ—¥å¿—ã€‚
```



# å®éªŒ

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230915163006650.png" alt="image-20230915163006650" style="zoom:33%;" />



4å°å°±å¤Ÿäº†

## å‘½å

```bash
hostnamectl hostname mha-manager
hostnamectl hostname master
hostnamectl hostname slave1
hostnamectl hostname slave2
```

![image-20230918135342055](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918135342055.png)



## é…ç½®ä¸»ä»

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918135809257.png" alt="image-20230918135809257" style="zoom:50%;" /> 





â€‹	

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918140406451.png" alt="image-20230918140406451" style="zoom:50%;" /> 



<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918140439574.png" alt="image-20230918140439574" style="zoom:50%;" /> 





![image-20230918145914330](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918145914330.png)



![image-20230918150149962](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918150149962.png)



masterä¸Šåˆ›å»ºäº†ä¸¤ä¸ªè´¦å·ï¼Œslave é…ç½®çš„æ—¶å€™å°±ä»binlogçš„åˆå§‹poså¼€å§‹(é€šè¿‡flush logsåˆ·æ–°binlogå¯çŸ¥åˆå§‹ä½ç½®åœ¨å“ªæˆ‘çš„æ˜¯389)ï¼›å°±å¯ä»¥æŠŠè¿™ä¸¤ä¸ªè´¦å·å¸¦è¿‡å»ï¼Œä¸è¿‡æœ€å¥½æ‰‹åŠ¨é…ç½®å§ã€‚

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918150937522.png" alt="image-20230918150937522" style="zoom:33%;" />





![image-20230918150843474](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918150843474.png)



![image-20230918151619497](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918151619497.png)



![image-20230918151700440](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918151700440.png)



ä¿®æ”¹ä¸€ä¸‹ï¼Œæˆ‘çš„æ“ä½œæ˜¯åœ¨masterä¸‹flush logs;  show master log;ç„¶åæ‰‹åŠ¨åœ¨slaveé‚£è¾¹åˆ›å»ºè´¦å·ï¼Œmasteræˆ‘ä»¬æœ¬æ¬¡å®éªŒå°±å½“ä½œæ˜¯å¹²å‡€ï¼Œæˆ–è€…ä¸ç”¨åŒæ­¥ä¹‹å‰çš„æ•°æ®ã€‚

![image-20230918151945325](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918151945325.png)

```
CHANGE MASTER TO
 MASTER_HOST='192.168.126.129',
 MASTER_USER='repluser',
 MASTER_PASSWORD='cisco',
 MASTER_PORT=3306,
 MASTER_LOG_FILE='mariadb-bin.000030',
 MASTER_LOG_POS=389,
 MASTER_CONNECT_RETRY=10;  # è¿™ä¸ªå°±æ˜¯é»˜è®¤å€¼
START SLAVE;

```

![image-20230918152227124](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918152227124.png)

è¿™æ ·slave2ä¹Ÿå°±åŒæ­¥äº†ï¼Œslave1ä¸€æ ·çš„ï¼Œç•¥



ä¸¤ä¸ªslaveç¡®è®¤ä¸‹ read_onlyå˜é‡

![image-20230918152801544](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918152801544.png)

![image-20230918153543626](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918153543626.png)



è¿™ä¸ªåªè¯»ï¼Œmhaåé¢å°±è€Œå·²ç›´æ¥æ”¹äº†ï¼Œå¥½åƒæ˜¯é€šè¿‡set è®¾ç½®å˜é‡ï¼Œè€Œread_onlyæœ¬èº«å°±æ˜¯å˜é‡ï¼Œæ‰€ä»¥mhaå¯ä»¥ç›´æ¥ä¿®æ”¹ä¸ºOFFçš„ã€‚   æˆ‘å°±æƒ³é—®äº†ï¼Œä¸èƒ½ä¿®æ”¹/etc/my.cnfå—ï¼Œsshéƒ½æœ‰äº†ï¼Œä¼°è®¡åº•å±‚ä¸æ˜¯ç”¨èµ°çš„ä¿®æ”¹é…ç½®æ–‡ä»¶çš„é€»è¾‘ã€‚



## å®‰è£…mhaåŒ…

ç›´æ¥yumå¯æ²¡æœ‰çš„ï¼Œéƒ½æ˜¯è€è½¯ä»¶äº†ï¼Œä¸è¿‡å¯ä»¥ç”¨çš„ã€‚

https://code.google.com/archive/p/mysql-master-ha/downloads

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918154907664.png" alt="image-20230918154907664" style="zoom:50%;" /> 



<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918155331957.png" alt="image-20230918155331957" style="zoom:50%;" /> 



![image-20230918160032283](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918160032283.png)

è·³è¿‡æŠ¥é”™è¯•è¯•

![image-20230918162424219](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918162424219.png)





![image-20230918162513191](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918162513191.png)

å¯èƒ½å°‘ä¸€ä¸ªperl-Log-DispatchåŒ…



slaveèŠ‚ç‚¹å®‰è£…æ²¡é—®é¢˜

![image-20230918163930265](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918163930265.png)





## åŸºäºkeyçš„sshé…ç½®



![image-20230918164508402](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918164508402.png)



![image-20230918164529292](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918164529292.png)



è¿™é‡Œå·æ‡’ï¼Œç›´æ¥åšæˆ4ä¸ªæœºå™¨ ä¸¤ä¸¤ ssh key äº’é€šï¼Œæ‰€ä»¥æ“ä½œå¦‚ä¸‹

![image-20230918165024911](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918165024911.png)



è¿™æ ·å°±å®ç°äº†ssh-key

![image-20230918165418387](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918165418387.png)



![image-20230918170932840](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918170932840.png)



ä¸€ä¸ªä¸»ä»å¯¹åº”ä¸€ä¸ªapp1.cnfé…ç½®æ–‡ä»¶ğŸ‘‡

![image-20230918171041065](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918171041065.png)



![image-20230918171226331](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918171226331.png)



![image-20230918171213483](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918171213483.png)





![image-20230918171329566](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918171329566.png)

ä¸Šå›¾ğŸ‘†å°±è¡¨ç¤ºï¼Œè¿™ä¸ªåŒ…å®‰è£…æœ‰é—®é¢˜äº†ï¼Œè¿˜æ˜¯ä¹‹å‰çš„æŠ¥é”™ï¼Œä¸èƒ½è·³è¿‡äº†å°±ã€‚





![image-20230918175615667](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918175615667.png)

ç®—äº†ç®—äº†ï¼ŒğŸ‘†æŒ‰è¿™ä¸ªè·‘ä¸€è¾¹è¿˜æ˜¯æŠ¥é”™

![image-20230918175650129](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918175650129.png)

ä¼°è®¡å°±æ˜¯el5çš„ç‰ˆæœ¬ï¼Œå¤ªè€äº†ï¼Œç®—äº†ï¼Œæ”¾å¼ƒè¿™ä¸ªå·¥å…·äº†ï¼Œä¹Ÿå°±åªèƒ½åœ¨centos5\6ä¸Šè·‘è·‘äº†ã€‚

ä»¥ä¸‹æ˜¯è§†é¢‘é‡Œçš„è€æ¿ä¸èƒ½ç»§ç»­æ¼”ç¤ºï¼Œä¸è¿‡è§†é¢‘ï¼Œåº”è¯¥æ˜¯centos7ï¼Œæ‰€ä»¥centos7ä¹Ÿèƒ½ç”¨å’¯ï¼Œè¿˜ä¸é”™

![image-20230918180715403](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918180715403.png)



### ![image-20230918181147791](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918181147791.png)

...ä¸­é—´çœç•¥...

![image-20230918181304173](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918181304173.png)



æœ€åå°±æ‰§è¡Œmhaè¿è¡ŒğŸ‘‡ï¼Œä»warningæ¶ˆæ¯å¯è§ï¼Œæ˜¯æœ‰ä¸€ä¸ªé»˜è®¤çš„cnfå­˜æ”¾è·¯å¾„çš„ï¼Œæˆ‘ä»¬è¿™é‡Œæ‰‹å·¥æŒ‡å®šçš„ã€‚

![image-20230918181647357](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918181647357.png)

è¿™ä¸ªç¨‹åºæ˜¯ä¸€ä¸ªå‰å°æ‰§è¡Œçš„ç¨‹åºï¼Œå°±æ˜¯ä¸€ç›´ç›¯ç€é›†ç¾¤ï¼Œåªè¦masteræŒ‚äº†ï¼Œå°±æå‡ä¸€ä¸ªslaveã€‚åªè¦masteræ­£å¸¸ï¼Œè¿™ä¸ªmhaç¨‹åºå°±å¡åœ¨è¿™é‡Œã€‚



![image-20230918182142006](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918182142006.png)





### åšmysqlé›†ç¾¤çš„æ—¶é—´ä¹Ÿè¦åŒæ­¥

æœ€å¥½ç”¨ntpä¸€çº§chronyd







## æ¨¡æ‹Ÿæµ‹è¯•é›†ç¾¤çš„HA

![image-20230918182617497](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918182617497.png)



æ­¤æ—¶ç›´æ¥downæ‰masterï¼Œç„¶åçœ‹managerä¸Š

![image-20230918182900966](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918182900966.png)

å‘ç°æ­¤æ—¶managerå·²ç»æ¨å‡ºäº†



ç„¶åçœ‹çœ‹æ—¥å¿—

![image-20230918183217959](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918183217959.png)

æœ€åå¯è§ä»192.168.37.17åˆ‡æ¢åˆ°äº†192.168.37.17è¿™å°æ–°çš„masterã€‚

![image-20230918183339479](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918183339479.png)



æ­¤æ—¶192.168.37.37ç”±äºæ˜¯masterï¼Œshow slave status\G;å°±æ˜¯ç©ºä¿¡æ¯äº†ã€‚ç„¶åread_onlyå°±é€šè¿‡setçš„æ–¹å¼ä¿®æ”¹äº†å˜é‡ä¸ºOFFäº†ï¼Œä½†æ˜¯é…ç½®æ–‡ä»¶æ˜¯ä¸ä¼šæ”¹çš„-->è¿™å°±å¸¦æ¥äº†åªè¦é‡å¯æœåŠ¡å°±ä¼šå˜æˆread_only=onäº†ï¼Œéœ€è¦æ‰‹åŠ¨å»æ”¹ä¸€æ”¹çš„ã€‚



æ­¤æ—¶192.168.37.27å°±æŒ‡å‘äº†æ–°çš„master37

![image-20230918183706720](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230918183706720.png)

æŒºå¥½çš„ä¸€ä¸ªè½¯ä»¶mhaï¼Œæ€ä¹ˆä¸æ›´æ–°äº†ï¼Œrocky9ï¼Œç›´æ¥æ— æ³•å®‰è£…manageräº†ã€‚ã€‚ã€‚å›å¤´å†ææ

æ¥ä¸Šé¢ä¸»ä»åˆ‡æ¢ï¼ŒåŸæ¥çš„masteræŒ‚äº†ï¼Œç„¶åslaveå‡ä¸ºmasterï¼Œç„¶åä¸šåŠ¡OKäº†ï¼Œå»ä¿®å¤è€çš„masterï¼Œç„¶åå°†å…¶é…ç½®ä¸ºslaveå³å¯ã€‚ç„¶åé‡æ–°åœ¨managerä¸Šè¿è¡Œç®¡ç†å‘½ä»¤masterha_manager --conf=/etc/mha/app1.cnf



**ç„¶åè¿™é‡Œçš„mhaä¸èƒ½è§£å†³proxySQLè¯»å†™åˆ†ç¦»çš„åœºæ™¯ï¼Œå› ä¸ºä¸»ä»è‡ªåŠ¨åˆ‡ï¼Œä½†æ˜¯proxySQLçš„åˆ†ç»„æˆ‘è®°å¾—æ˜¯å†™æ­»çš„hostgroupå°±å›ºå®šäº†ï¼Œæ¯”å¦‚10ç»„é‡Œå°±æ˜¯å†™æ“ä½œå±‚ï¼Œ10ç»„é‡ŒåŠ å…¥å¾—å°±æ˜¯masteräº†ï¼Œè¿™ä¸ªåœ°æ–¹å°±å­˜åœ¨è‡ªåŠ¨åˆ‡å¾—éœ€æ±‚ï¼Œè€Œmhaæ–¹æ¡ˆé‡Œæ²¡æœ‰æåˆ°ï¼Œæ‰€ä»¥mhaä¹Ÿä¸æ˜¯å¾ˆå¥½å¾—ä¸€ä¸ªæ–¹æ¡ˆã€‚**





# é‡ç‚¹å­¦ä¹ Galera Clusterè¿™ä¸ªå·¥å…·

![image-20230919102757658](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230919102757658.png)

mhaè¿˜æ˜¯å•ä¸»å¤šä»ï¼Œæ€»å½’æœ‰æ•°æ®æ²¡æœ‰åŒæ­¥ä¸¢å¤±çš„å¯èƒ½ï¼›å¤šä¸»å¯èƒ½æ‰æ˜¯æ›´æè‡´çš„æ–¹æ¡ˆï¼Œpercanaã€mariadbã€mysqléƒ½æœ‰å„è‡ªçš„å¤šä¸»æ–¹æ¡ˆã€‚



å¤šä¸»å­˜åœ¨çš„å†²çªå¦‚ä½•è§£å†³çš„ï¼Ÿä¸‹ä¸€ç¯‡è¯´æ˜



calera cluster è‡³å°‘3ä¸ªmasterï¼Œæ¯ä¸ªæœºå™¨éƒ½å¯ä»¥è¯»å’Œå†™





![image-20230919103146104](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230919103146104.png)





å¤šä¸»æ¶æ„ï¼Œå¯¹äºclientæ¥è®²ï¼Œåˆ°åº•è®¿é—®è°å‘¢ï¼Ÿ

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230919103318721.png" alt="image-20230919103318721" style="zoom:33%;" />



è¿™é‡Œæ˜¯ä¸æ˜¯å°±æ¶‰åŠè´Ÿè½½å‡è¡¡å•¦ï¼Œä¸è¿‡è¿˜å¯ä»¥è½»é‡åŒ–çš„ç”¨keepalivedçš„VIPè™šæ‹ŸIPæ¥åš--åªä¸è¿‡å°±æ˜¯å•èŠ‚ç‚¹è¯»å†™äº†-åº”è¯¥ã€‚è€ŒLBå°±æ˜¯é’ˆå¯¹ä¸åŒsessionå¯ä»¥åšåˆ°è´Ÿè½½åˆ†æ‹…çš„ã€‚







https://galeracluster.com/library/documentation/certification-based-replication.html

![../_images/certificationbasedreplication.png](6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/certificationbasedreplication.png)

å›¾ä¸­å…³é”®å­—ï¼šglobal trx idå°±æ˜¯  å…¨å±€äº‹åŠ¡IDï¼Œå…³äºGTIDå‰æ–‡ä¹Ÿè®²è¿‡ğŸ‘‡<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230919104859863.png" alt="image-20230919104859863" style="zoom: 33%;" />

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230919104851682.png" alt="image-20230919104851682" style="zoom:50%;" />



**ä¸Šå›¾è¯´æ˜äº†å¦‚ä½•ä¿è¯å¤šä¸»é›†ç¾¤ä¸‹çš„æ•°æ®ä¸€è‡´æ€§ï¼š**

1ã€clientå¾€å¤šä¸»--Galera Clusteré›†ç¾¤é‡Œå†™æ•°æ®ï¼Œå¤šä¸»è‡³å°‘æ˜¯ä¸‰ä¸»äº†ï¼Œå›¾ä¸­ç®€å•ç”»æˆäº†2ä¸ªserverç¤ºæ„ï¼›

2ã€client update æ•°æ®ï¼Œä¸ç®¡æ˜¯LBè¿˜æ˜¯keepaliveéƒ½æ˜¯å‘é€åˆ°ä¸€ä¸ªmasterä¸Šçš„ï¼›

3ã€è¿™ä¸ªmasterï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­serverï¼Œå°±å¼€å§‹å¤„ç†å•¦ï¼ŒOKï¼Œåå°±æäº¤ï¼Œå› ä¸ºæ¶‰åŠäº‹åŠ¡ï¼Œè¿˜éœ€è¦æäº¤ï¼›

4ã€æäº¤èƒ½å¦çœŸæ­£æäº¤æˆåŠŸï¼Œè¿˜ä¸ä¸€å®šçš„ï¼Œå¾€ä¸‹çœ‹ï¼Œæ­¤æ—¶å°±ä¼šè§¦å‘replicate writesetåº”è¯¥ä¹Ÿå«write set replication (wsrep)å†™é›†å¤åˆ¶è¿™ä¸ªåŠŸèƒ½ï¼Œ

ç„¶åæ‰€æœ‰çš„serverå°±éƒ½æ”¶åˆ°ä¸€ä¸ªGTIDå…¨å±€äº‹åŠ¡IDï¼Œç„¶åå°±å¼€å§‹å¤„ç†

5ã€æ¥æ”¶åˆ°updateçš„serverå°±æ£€æŸ¥ï¼Œæ£€æŸ¥ä¸é€šè¿‡å°±rollback_cbå›æ»šï¼Œé€šè¿‡å°±æ˜¯commit_cbæäº¤åˆ°dbé‡Œå»ã€‚

åŒæ—¶ï¼›åˆ«çš„serverä¹Ÿä¼šæ£€æŸ¥ï¼Œä¸é€šè¿‡å°±discard--ç”±äºæ•°æ®ä¸æ˜¯æœ¬åœ°æäº¤çš„æ˜¯åˆ«çš„serverçš„ï¼Œæ‰€ä»¥ç›´æ¥discardï¼Œå¦‚æœé€šè¿‡ï¼Œå°±åº”ç”¨æ•°æ®apply_cbå°±æ˜¯updateä¸€ä¸‹ï¼Œç„¶åcommit_cbæäº¤äº‹åŠ¡ã€‚



æœ‰æ—¶é—´å¯ä»¥çœ‹çœ‹è¿™ä¸ª

https://mariadb.com/kb/en/getting-started-with-mariadb-galera-cluster/

å…¶ä¸­æåˆ°äº†

<img src="6-mysqlçš„ä¸»ä»å¤åˆ¶é«˜å¯ç”¨æ€§è§£å†³æ–¹æ¡ˆMHA.assets/image-20230919110401293.png" alt="image-20230919110401293" style="zoom:44%;" />

æ‰€ä»¥æˆ‘çš„å®éªŒç¯å¢ƒæ˜¯é»˜è®¤å°±æœ‰çš„åº”è¯¥ï¼Œæ— éœ€å®‰è£…ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥å®‰è£…å§ã€‚



**Galera Clusterå®˜æ–¹æ–‡æ¡£**

[http://galeracluster.com/documentation-webpages/galera-documentation.pdf ](http://galeracluster.com/documentation-webpages/galera-documentation.pdf) [http://galeracluster.com/documentation-webpages/index.html ](http://galeracluster.com/documentation-webpages/index.html) https://mariadb.com/kb/en/mariadb/getting-started-with-mariadb-galera-cluster/

**Galera ClusteråŒ…æ‹¬ä¸¤ä¸ªç»„ä»¶**

â€‹	Galera replication library (galera-3)

â€‹	WSREPï¼šMySQL extended with the Write Set Replication

**WSREPå¤åˆ¶å®ç°**

â€‹	PXCï¼šPercona XtraDB Clusterï¼Œæ˜¯Perconaå¯¹Galeraçš„å®ç°

â€‹	MariaDB Galera Cluster

å‚è€ƒä»“åº“å›½å¤–çš„æ…¢ï¼šhttps://mirrors.tuna.tsinghua.edu.cn/mariadb/mariadb-5.5.X/yum/centos7-amd64/

æ³¨æ„ï¼šéƒ½è‡³å°‘éœ€è¦ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œä¸èƒ½å®‰è£…mariadb-server







