# ç¬¬3èŠ‚. mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†

# éƒ¨åˆ†æ•°æ®å¤åˆ¶ï¼Œé‡‡ç”¨è¿‡æ»¤å™¨

ä¸¤ç§å®ç°æ–¹å¼ï¼š

1ã€ä»…å†™å…¥éœ€è¦å¤åˆ¶çš„æ•°æ®åº“ï¼ŒmasterèŠ‚ç‚¹é…ç½®

â€‹		ç¼ºç‚¹ï¼šbinlogä¸ä»…ä»…æ˜¯ç”¨æ¥å®ç°ä¸»ä»å¤åˆ¶ï¼Œæ›´å¤šæ˜¯ç”¨æ¥åšå¤‡ä»½çš„ä¸€ä¸ªå¢é‡è¿˜åŸç”¨çš„ã€‚

2ã€slaveèŠ‚ç‚¹é…ç½®ï¼Œåœ¨rely-logä¸­ç»§æ—¥å¿—ä¸­æŒ‘å–å‡ºï¼Œå“ªäº›ç‰¹å®šæ•°æ®åº“çš„ç‰¹å®šè¡¨éœ€è¦åŒæ­¥åˆ°æœ¬åœ°ã€‚

â€‹		ç¼ºç‚¹ï¼šrely-logä¸­ç»§æ—¥å¿—é‡Œä¸œè¥¿æ˜¯å…¨çš„ï¼Œæ˜¯ä»masterå¤åˆ¶è¿‡æ¥äº†ï¼Œç„¶åå†sql threadè¿›è¡ŒæŒ‘é€‰çš„ï¼Œæ‰€ä»¥å·²ç»ä»masterå¤åˆ¶è¿‡æ¥ï¼Œæ„å‘³ç€ç½‘ç»œå’Œç£ç›˜IOå°±èŠ±è´¹å‡ºå»äº†ã€‚

â€‹		æ³¨æ„slaveè¿‡æ»¤éœ€è¦åœ¨æ‰€æœ‰çš„slaveä¸Šéƒ½è¦é…ç½®ä¸€è¾¹ã€‚





## æ–¹æ³•1ï¼šåªç”Ÿäº§ç‰¹å®šbinlog

```
masterä¸Šï¼š
-----------
vim /etc/my.cnf
  server-id=1
  log-bin
  # binlog-do-db = 
  binlog-ignore-db = hellodb
wr
systemctl restart mariadb

mysql > show master status;

å¯è§binlogé»‘åå•æ•°æ®åº“ğŸ‘‡
```

![image-20230814135651615](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814135651615.png)

æ­¤æ—¶hellodbçš„binlogéƒ½ä¸ä¼šç”Ÿäº§ï¼Œè‡ªç„¶å°±ä¸ä¼šå‚ä¸ä¸»ä»å¤åˆ¶äº†ï¼Œæµ‹è¯•ğŸ‘‡

![image-20230814135929346](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814135929346.png)

slaveé‚£è¾¹test003è¿˜åœ¨ï¼Œç¡®å®ä¸åŒæ­¥äº†

![image-20230814135954341](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814135954341.png)



å…¶ä»–æ•°æ®è¿˜æ˜¯åŒæ­¥çš„

![image-20230814140251345](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814140251345.png)

![image-20230814140303255](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814140303255.png)

æ­¤æ—¶å°±å®ç°äº†æ•°æ®çš„ä¸€ä¸ªè¿‡æ»¤è¿‡ç¨‹





## æ–¹æ³•2ï¼šslaveæœåŠ¡å™¨ä¸Šè¿›è¡Œè¿‡æ»¤

<img src="3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814140849855.png" alt="image-20230814140849855" style="zoom:40%;" />

```
slaveä¸Šï¼š
-------
vim /etc/my.cnf
  replicate-do-db=hellodb,db1  # è¿™é‡Œå®šä¹‰äº†ä¸€ä¸ªç™½åå•åªä»ä¸­ç»§æ—¥å¿—é‡Œå–å‡ºhelldb,db1ä¸¤ä¸ªåº“çš„binlogè¿›è¡Œsql threadå†™å…¥slaveæœ¬åœ°ã€‚
wr
systemctl restart mariadb


```

æ­¤æ—¶æ²¡æœ‰åŠ ç™½çš„å°±ä¸ä¼šå¤åˆ¶äº†ğŸ‘‡

![image-20230814142853544](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814142853544.png)



![image-20230814142904220](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814142904220.png)

åŠ ç™½çš„å°±ç»§ç»­å¤åˆ¶

![image-20230814143546438](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814143546438.png)



![image-20230814143602805](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814143602805.png)



![image-20230814143610666](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814143610666.png)

ä¸Šå›¾çš„"hellodb,db1"å‘ˆç°å‡ºæ¥çš„è²Œä¼¼æ˜¯ä¸¤ä¸ªdbç”¨é€—å·åˆ†å¼€ï¼Œå…¶å®ä¸ä¸€å®šçš„ï¼Œè¦å»my.cnfé‡Œçœ‹å¦‚æœæ˜¯replicate-do-db=hellodb,db1è¿™ç§å†™æ³•ï¼Œç³»ç»Ÿå¯èƒ½å°±åˆ¤å®šä¸ºä¸€ä¸ªå«"hellodb,db1"æ•°æ®åº“äº†ï¼Œé¬¼çŸ¥é“ï¼›å¦‚æœæ˜¯ä¸‹é¢çš„å†™æ³•ï¼Œç³»ç»Ÿå°±è™½ç„¶slave statusé‡Œæ˜¾ç¤ºè¿˜æ˜¯ä¸€æ ·"hellodb,db1"ï¼Œä½†æ˜¯ç¡®å®æ˜¯é€—å·åˆ†å¼€çš„ä¸¤ä¸ªæ•°æ®åº“äº†ã€‚

ç»“æœå°±æ˜¯åŠ ç™½çš„ä¹Ÿæ²¡æœ‰å¤åˆ¶ï¼Œä½†æ˜¯slave çŠ¶æ€æ—¶OKçš„å•Šï¼Œå¥‡æ€ªäº†ã€‚

å°±æ˜¯å†™çš„æ ¼å¼æœ‰é—®é¢˜ï¼Œä¸æ”¯æŒhellodb,db1è¿™ç§é€—å·çš„æ–¹å¼ï¼Œä¸€è¡Œä¸€ä¸ªï¼Œ

<img src="3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814144250082.png" alt="image-20230814144250082" style="zoom:50%;" />

æ­¤æ—¶slaveçš„çŠ¶æ€å€’æ—¶ç”¨é€—å·åˆ†å¼€çš„ï¼Œè²Œä¼¼å’Œä»¥å‰ä¸€æ ·ï¼Œä½†äº‹å®ä¸Šæ—¶ä¸¤ä¸ªdbäº†ï¼Œä»¥å‰æ—¶ä¸€ä¸ªdb

![image-20230814144356127](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814144356127.png)





![image-20230814144044470](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814144044470.png)

æ­¤æ—¶teståœ¨slaveé‚£è¾¹å°±ç¡®å®åŒæ­¥ ä¹Ÿåˆ æ‰äº†

![image-20230814144115664](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814144115664.png)



å†çœ‹ä¸€ä¸ªç°è±¡--å°±æ˜¯ç›®å‰çš„è¿‡æ»¤å™¨ï¼Œå¿…é¡»åˆ‡åˆ°use dbè¿›åˆ°å“ªä¸ªåº“é‡Œæ‰èƒ½åŒæ­¥ğŸ‘‡

![image-20230814150026822](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814150026822.png)

![image-20230814150107585](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814150107585.png)

ä½ çœ‹masteråœ¨noneä¸‹æ“ä½œçš„ï¼Œæ²¡æœ‰useè¿›åˆ°å¯¹åº”çš„åº“ï¼Œæ‰€ä»¥å°±æ²¡æœ‰åŒæ­¥ï¼Œä¸‹é¢å¯¹æ¯”æµ‹è¯•useä¸€ä¸‹å°±åŒæ­¥äº†ğŸ‘‡

![image-20230814150246283](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814150246283.png)

![image-20230814150253935](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814150253935.png)

å®é™…å·¥ä½œä¸­ä¸è¦ä½¿ç”¨è¿™ç§è·¨åº“æ“ä½œå°±å¥½ï¼Œæ³¨æ„ä¸‹ï¼Œéƒ½ä½¿ç”¨use dbxxxè¿›åˆ°æŸä¸ªåº“é‡Œè¿›è¡Œæ“ä½œã€‚









# æ•°æ®ä¸»ä»å¤åˆ¶å®‰å…¨åŠ å¯†ä¸‹



mysql -uroot -pxxxx -h xxxxè¿™ç§æ˜¯æ˜æ–‡çš„ï¼ŒæŠ“åŒ…å¯å¾—

![image-20230814153425676](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814153425676.png)



![image-20230814153437885](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814153437885.png)

å¯è§cliå’ŒæŸ¥çœ‹çš„ç»“æœæ•°æ®éƒ½èƒ½çœ‹å¾—åˆ°ã€‚



## åˆ©ç”¨SSLåŠ å¯†ï¼Œå°±æ˜¯è¦æœ‰SSLè¯ä¹¦

å®éªŒï¼Œåœ¨192.168.126.129å’Œ192.168.126.130ä¹‹é—´å®ç°åŠ å¯†

è¯ä¹¦æ€ä¹ˆç”³è¯·ï¼Œ

è¯ä¹¦æ˜¯ç”¨æ¥è¯æ˜å…¬é’¥çš„å®‰å…¨æ€§çš„ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½æœ‰è‡ªå·±çš„è¯ä¹¦ï¼Œå°†æ¥æ‰èƒ½åˆ©ç”¨è¯ä¹¦äº¤æ¢å½¼æ­¤çš„å…¬é’¥ï¼Œæ‰å¯ä»¥è¿›ä¸€ç¬”åˆ©ç”¨å…¬é’¥æ¥åŠ å¯†å¯¹ç§°å¯†é’¥ï¼Œè¿›è€Œå®ç°æ•°æ®ä¼ è¾“çš„å®‰å…¨ã€‚



mysqlçš„sslæ˜¯åšäº†åŒå‘è®¤è¯çš„ï¼Œå’Œå¹³æ—¶httpsä¸Šç½‘-åªåšæœåŠ¡å™¨çš„è®¤è¯ï¼Œä¸å¤ªä¸€æ ·ã€‚



1ã€caè‡ªå·±ç»™è‡ªå·±ç‰ˆæœ¬è¯ä¹¦ï¼šç”Ÿäº§ç§é’¥ï¼Œç”Ÿäº§è‡ªç­¾åè¯ä¹¦ï¼›

2ã€ç„¶ååœ¨é¢å‘è¯ä¹¦

3ã€è¿™æ¬¡åšéƒ½åœ¨ä¸€å°æœºå™¨ä¸Šåšå®Œï¼ŒåŒ…æ‹¬CAã€å„ä¸ªèŠ‚ç‚¹çš„è¯ä¹¦ç”Ÿæˆï¼Œç„¶ååˆ†å‘ä¸‹å»ã€‚

```
mkdir /etc/my.cnf.d/ssl  # ä¸“é—¨æ”¾è¯ä¹¦ä¿¡æ¯ï¼Œåˆ©ç”¨ç°æˆçš„my.cnf.dæ–‡ä»¶å¤¹ï¼Œsslæ˜¯åˆ›å»ºçš„
cd /etc/my.cnf.d/ssl
```

æˆ‘ä»¬éœ€è¦3ä¸ªè¯ä¹¦ï¼šCAçš„è¯ä¹¦ã€ä¸»æœåŠ¡å™¨è¯ä¹¦ã€ä»èŠ‚ç‚¹è¯ä¹¦ã€‚

æœ‰è¯ä¹¦ï¼Œå°±å¾—æœ‰ç§é’¥ï¼Œ

```
â‘ ç”ŸæˆCAçš„ç§é’¥ï¼š
openssl genrsa 2048 > cakey.pem    # ä»¥å‰æ˜¯ä¸“é—¨ä¸€ä¸ªç›®å½•ï¼Œç°åœ¨ç®€å•æ”¾ä¸€èµ·å°±è¡Œ
å¯èƒ½æœ€å¥½åŠ ä¸ªå¯†ï¼Œæˆ–è€…æ”¹ä¸ªcakey.pemçš„æƒé™ï¼Œå®‰å…¨äº›ã€‚
```

![image-20230814163025210](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814163025210.png)

```
â‘¡åˆ©ç”¨ç§é’¥ç”Ÿæˆè‡ªç­¾åè¯ä¹¦
openssl req -new -x509 -key cakey.pem -out cacert.pem -days 3650

```

![image-20230814164039232](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814164039232.png)

![image-20230814164202761](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814164202761.png)

```
â‘¢ç”Ÿæˆmasterçš„ç§é’¥å’Œè¯ä¹¦ç”³è¯·æ–‡ä»¶
openssl req -newkey rsa:1024 -days 365 -nodes -keyout master.key > master.csr  # åˆ©ç”¨ä¸€æ¡å‘½ä»¤ç”Ÿæˆç§é’¥æ–‡ä»¶master.keyï¼Œå¹¶åˆ©ç”¨è¯¥keyç”Ÿæˆè¯ä¹¦ç”³è¯·æ–‡ä»¶ã€‚

```

![image-20230814165624518](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814165624518.png)

```
â‘£æœ‰äº†è¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼Œå°±å¯ä»¥ç­¾åäº†--ä¹Ÿå°±æ˜¯é¢å‘è¯ä¹¦
openssl x509 -req -in master.csr -CA cacert.pem -CAkey cakey.pem -set_serial 01 > master.crt

åˆ©ç”¨CAçš„ä¿¡æ¯ï¼Œæ ¹æ®è¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼Œæ¥å®ç°ç”Ÿæˆè¯ä¹¦ã€‚
_set_serial 01  æŒ‡å®šè¯ä¹¦ç¼–å·ï¼Ÿ

```

![image-20230814170353681](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814170353681.png)

```
â‘¤åŒæ ·å†ç”Ÿæˆçš„ç§é’¥å’Œè¯ä¹¦ç”³è¯·æ–‡ä»¶
openssl req -newkey rsa:1024 -days 365 -nodes -keyout slave.key > slave.csr  # åˆ©ç”¨ä¸€æ¡å‘½ä»¤ç”Ÿæˆç§é’¥æ–‡ä»¶slave.keyï¼Œå¹¶åˆ©ç”¨è¯¥keyç”Ÿæˆè¯ä¹¦ç”³è¯·æ–‡ä»¶ã€‚

æ³¨æ„ï¼š-days 365 å¥½åƒæ˜¯é»˜è®¤å°±æœ‰çš„ã€‚

```

![image-20230814173701688](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814173701688.png)



```
â‘¥åŒæ ·å†ç»™slaveèŠ‚ç‚¹é¢å‘è¯ä¹¦
openssl x509 -req -in slave.csr -CA cacert.pem -CAkey cakey.pem -set_serial 02 > slave.crt

åˆ©ç”¨CAçš„ä¿¡æ¯ï¼Œæ ¹æ®è¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼Œæ¥å®ç°ç”Ÿæˆè¯ä¹¦ã€‚
_set_serial 01  æŒ‡å®šè¯ä¹¦ç¼–å·ï¼Ÿ
```

![image-20230814173838129](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814173838129.png)



åˆ°æ­¤å°±æœ‰äº†masterå’Œslaveçš„è¯ä¹¦å’Œç§é’¥äº†ï¼Œå°±å¯ä»¥åˆ©ç”¨è¯ä¹¦æ¥åŠ å¯†äº†

## å¼€å§‹ç»™mysqlé…ç½®sslè¯ä¹¦

é»˜è®¤æ˜¯æœªå¼€å¯sslåŠ å¯†çš„

![image-20230814174726652](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814174726652.png)

ä¸€äº›å’ŒåŠ å¯†ç›¸å…³çš„å˜é‡

![image-20230814174952359](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814174952359.png)

é¢˜å¤–è¯ï¼š%ssl%ä¸åŒºåˆ†å¤§å°å†™ã€‚

éœ€è¦æŒ‡ssl_ca  CAçš„è¯ä¹¦ï¼›ssl_certè‡ªå·±çš„è¯ä¹¦ï¼Œssl_keyè‡ªå·±çš„ç§é’¥ã€‚

```
vim /etc/my.cnf
  ssl-ca=/etc/my.cnf.d/ssl/cacert.pem
  ssl-cert=/etc/my.cnf.d/ssl/matser.crt
  ssl-key=/etc/my.cnf.d/ssl/master.key
  
```

![image-20230814180628985](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814180628985.png)

ä½†æ˜¯æœåŠ¡èµ·ä¸æ¥

![image-20230814180650916](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814180650916.png)

æŸ¥çœ‹æŠ¥é”™æ—¥å¿—

![image-20230814180710663](3-mysqlå¤åˆ¶è¿‡æ»¤å™¨å’ŒåŸºäºSSLçš„å¤åˆ¶åŠ å¯†.assets/image-20230814180710663.png)

å‘ç°æ˜¯SSL error: Unable to get certificate from '/etc/my.cnf.d/ssl/master.crt'

å¯èƒ½æ˜¯ä¹‹å‰çš„master.crtè¯ä¹¦æ–‡ä»¶ç”Ÿæˆçš„æœ‰é—®é¢˜ã€‚



