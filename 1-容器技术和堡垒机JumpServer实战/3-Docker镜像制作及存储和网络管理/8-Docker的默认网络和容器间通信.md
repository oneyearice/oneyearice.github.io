# ç¬¬8èŠ‚ Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡



### ç½‘ç»œç®€è¿°

å®¹å™¨å¯åŠ¨éƒ½ä¼šè·å–docker0ä¸€ä¸ªç½‘æ®µçš„IPï¼Œé»˜è®¤éƒ½æ˜¯172.17.0.0/16

![image-20240528133910440](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528133910440.png)



åŒä¸»æœºä¸‹ä¸åŒå®¹å™¨äº’è®¿ï¼Œå› ä¸ºIPæ˜¯åŠ¨æ€è·å–çš„ï¼Œå­˜åœ¨å˜åŠ¨çš„å¯èƒ½

ä¸åŒä¸»æœºä¸‹å®¹å™¨ä¹‹é—´äº’è®¿ï¼Œé¦–å½“å…¶å†²çš„å°±æ˜¯IPæ®µé»˜è®¤ä¸€æ ·ï¼Œå‡ºéƒ½å‡ºä¸æ¥ã€‚å¬ä¸æ‡‚å•Šï¼Œä»€ä¹ˆå«å‡ºä¸æ¥ï¼Œå°±æ˜¯è·¯ç”±å•Šï¼ŒåŒç½‘æ®µä¸ä¼šæ‰¾GWï¼Œä¸èµ°GWæ€ä¹ˆå‡ºæœ¬åœ°å±€åŸŸç½‘å‘¢ã€‚



å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œè¯¥ç½‘å¡åœ¨å®¿ä¸»æœºè¡¨ç°ä¸ºvethxxxxï¼Œåœ¨å®¹å™¨é‡Œè¡¨ç°ä¸ºeth0#ifxxx;  ä¸€ä½“ä¸¤é¢ å°±è¿™ä¹ˆç†è§£å°±è¡Œäº†ï¼Œå®˜æ–¹ç§°ä¹‹ä¸ºveth pairã€‚

![image-20240528141955478](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528141955478.png)



<img src="8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528142927753.png" alt="image-20240528142927753" style="zoom:50%;" />



docker0ç›¸å½“äºä¸€ä¸ªäº¤æ¢æœºï¼Œeth0--veth   éƒ½æ¡¥æ¥ä¸Šå»ã€‚è¿™æ ·å®¹å™¨ä¹‹é—´æ²Ÿé€šï¼Œèµ°docker0ï¼Œå®¹å™¨å‡ºå®¿ä¸»çš„æµé‡ä¹Ÿèµ°docker0ä¸è¿‡è¿˜å¾—è¿‡ä¸€å±‚SNATå‡ºå»ã€‚





### ç¡®è®¤æŸä¸ªvethè™šæ‹Ÿç½‘å¡æ‰€å±å®¹å™¨

**1ã€è¿›å…¥å®¹å™¨**

çœ‹ç¼–å·å¯¹åº”å…³ç³»å°±è¡Œäº†ï¼Œå®¿ä¸»ä¸Šçœ‹9å¯¹åº”åˆ°å®¹å™¨çš„8ï¼Œå°±æ˜¯ç¼–å·å¯¹åº”çš„ã€‚

![image-20240528152533265](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528152533265.png)

ä¹Ÿè¦æ³¨æ„è¿™ä¸ªveth-pairï¼Œä¸€ä½“ä¸¤é¢çš„ MAC æ˜¯ä¸ä¸€æ ·çš„ï¼›

ç„¶ådocker0å’Œvethæ˜¯æ¡¥æ¥å…³ç³»ã€‚

![image-20240528152829486](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528152829486.png)





**2ã€ä¸è¿›å®¹å™¨**

ä½†è¦æ³¨æ„ï¼šä¼šå¯¼è‡´ è¿›å…¥å¤šå±‚ bashï¼Œå¦‚æœæ“ä½œä¸å½“

```shell
docker inspect --format '{{.State.Pid}}' <container_id>
nsenter -t <PID> -n ip link
```

![image-20240528153501437](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528153501437.png)

æ‰€ä»¥è¿™ä¸ªæ–¹æ³•

<img src="8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528153536947.png" alt="image-20240528153536947" style="zoom: 44%;" />

å…¶å®å°±æ˜¯è¿›å…¥äº†å‘½åç©ºé—´äº†



**å…¶ä»–å·¥å…·çœ‹çœ‹docker0æŒ‚äº†å‡ ä¸ªå®¹å™¨æˆ–è€…å‡ ä¸ªveth**



è¿™ä¸ªå¯ä»¥ç›´è§‚çœ‹åˆ°dockeré‡ŒæŒ‚çš„å®¹å™¨çš„NAMEå’Œå®¹å™¨é‡Œçš„IPå’ŒMACï¼Œè¿˜ä¸é”™ğŸ‘‡

![image-20240528155538716](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528155538716.png)



è¿™ä¸ªå°±æ˜¯ä¸ªæ’ç‰ˆçœ‹çš„èˆ’æœè€Œå·²ï¼Œip a çœ‹åˆ°çš„docker0è‡ªç„¶æ˜¯æ¡¥æ¥åˆ°æ‰€æœ‰çš„vethxxxçš„ã€‚

![image-20240528155915368](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528155915368.png)



![image-20240528160430743](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528160430743.png)





åŒå®¿ä¸»å®¹å™¨ä¹‹é—´çš„pingå°±æ˜¯é»˜è®¤é€šçš„ğŸ‘‡

![image-20240528160748969](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528160748969.png)



# è§£å†³å®¹å™¨IPä¸å›ºå®šçš„é—®é¢˜

èƒŒæ™¯ï¼š

1ã€å®¹å™¨runèµ·æ¥äº†ï¼ŒIPä¸ç¡®å®šï¼Œrunèµ·æ¥äº†IPæ˜¯ä¸æ˜¯ä¹Ÿä¼šå—dhcpçš„é‡Šæ”¾å‘¨æœŸå½±å“çš„å’¯ã€‚

2ã€å¦‚æœä½ å…¬å¸å†…ç½‘æœ‰172.17æ®µï¼Œé‚£ä¹ˆå®¹å™¨å¦‚æœè¦å’Œè¿™ä¸ªæ®µäº’é€šï¼Œå°±ä¸è¡Œäº†ã€‚



éœ€æ±‚ï¼šè§£å†³è¿™ä¸ªä¸å›ºå®šçš„é—®é¢˜å’¯ï¼Œç„¶åå°±å¯ä»¥æ›´å¥½çš„è‡ªåŠ¨åŒ–å’¯ã€‚ä»¥åŠæ›´æ¢å®¹å™¨çš„ç½‘æ®µã€‚















# å·¥ä½œæ¡ˆä¾‹

linuxå¸¸pingè„šæœ¬



**æ–¹æ³•1ï¼š**

```shell
ping 10.100.8.29 | awk '{ print $0 " " strftime("%F %H:%M:%S",systime()) }'  >> test.ping
```

![image-20240528175906802](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528175906802.png)

æ³¨æ„è¿™ç§ç›´æ¥ >> é‡å®šå‘åˆ° æ–‡ä»¶ï¼Œå¤§æ¦‚æ˜¯60ä¸ªpingåŒ…ä¸€èµ·å†™å…¥æ–‡ä»¶çš„ã€‚ä¸æ˜¯æ¯ä¸ªåŒ…å†™ä¸€ä¸ªçš„ï¼Œç›¸å½“äºé»˜è®¤çš„æœ‰ä¸€ä¸ªI/Oä¼˜åŒ–å§



**æ–¹æ³•2ï¼š**

```shell
ping 223.5.5.5 |& while read -r line;do echo "$(date) $line";done >> ping.log

ping 223.5.5.5 |& while read -r line;do echo "$(date) $line" >> /tmp/123.ping;done
```

![image-20240528180042025](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528180042025.png)

è¿™ç§æ–¹å¼å†™å…¥æ–‡ä»¶å¾ˆåŠæ—¶ï¼Œä¸€ä¸ªpingåŒ…å°±æ˜¯ä¸€ä¸ªã€‚

æ—¶é—´æ ¼å¼ä¼˜åŒ–ä¸‹

```
ping 223.5.5.5 |& while read -r line;do echo "$(date +%F_%H:%M:%S) $line" >> /tmp/ping.test ;done
```

![image-20240528180530420](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528180530420.png)





ç„¶åæ”¹æˆè„šæœ¬ï¼ŒåšæˆæœåŠ¡ï¼Œå¯ä»¥å®ç°å¼‚å¸¸åœæ­¢åçš„æœåŠ¡è‡ªåŠ¨èµ·æ¥ï¼Œä¹ŸåŒ…æ‹¬é‡å¯æœºå™¨è‡ªåŠ¨èµ·æ¥ã€‚

![image-20240528181218892](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528181218892.png)



![image-20240528181230987](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528181230987.png)



**åšæˆæœåŠ¡**



```shell
vim /etc/systemd/system/pingtest.service
```



```shell
[Unit]
Description=Ping Test Service
After=network.target

[Service]
User=root
Type=simple
ExecStart=/path/to/pingtest.sh 8.8.8.8
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```



```shell
systemctl daemon-reload
```



```shell
systemctl start pingtest.service
systemctl enable pingtest.service
```



```shell
systemctl status pingtest.service
```



**æµ‹è¯•kill åè‡ªåŠ¨èµ·æ¥**

æ‰¾åˆ°main pid

![image-20240528182214861](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528182214861.png)



kill -9ä¼šè‡ªåŠ¨èµ·æ¥

![image-20240528182515101](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528182515101.png)



kill ä¹Ÿä¼šèµ·æ¥

![image-20240528182823247](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528182823247.png)



stopçº¯äººå·¥åœæ­¢è‡ªç„¶ä¸ä¼šèµ·æ¥å’¯ï¼Œå¦åˆ™ä½ æ€ä¹ˆæŒºæœåŠ¡~

![image-20240528183043114](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528183043114.png)

æ³¨æ„statusé‡Œå¯ä»¥çœ‹åˆ°ä¸€äº›æœåŠ¡å™¨å¯åŠ¨æ—¥å¿—çš„å«æ—¶é—´ã€‚



