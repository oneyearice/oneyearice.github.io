# ç¬¬8èŠ‚ Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡



### ç½‘ç»œç®€è¿°

å®¹å™¨å¯åŠ¨éƒ½ä¼šè·å–docker0ä¸€ä¸ªç½‘æ®µçš„IPï¼Œé»˜è®¤éƒ½æ˜¯172.17.0.0/16

![image-20240528133910440](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528133910440.png)



åŒä¸»æœºä¸‹ä¸åŒå®¹å™¨äº’è®¿ï¼Œå› ä¸ºIPæ˜¯åŠ¨æ€è·å–çš„ï¼Œå­˜åœ¨å˜åŠ¨çš„å¯èƒ½

ä¸åŒä¸»æœºä¸‹å®¹å™¨ä¹‹é—´äº’è®¿ï¼Œé¦–å½“å…¶å†²çš„å°±æ˜¯IPæ®µé»˜è®¤ä¸€æ ·ï¼Œå‡ºéƒ½å‡ºä¸æ¥ã€‚å¬ä¸æ‡‚å•Šï¼Œä»€ä¹ˆå«å‡ºä¸æ¥ï¼Œå°±æ˜¯è·¯ç”±å•Šï¼ŒåŒç½‘æ®µä¸ä¼šæ‰¾GWï¼Œä¸èµ°GWæ€ä¹ˆå‡ºæœ¬åœ°å±€åŸŸç½‘å‘¢ã€‚



å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªè™šæ‹Ÿç½‘å¡ï¼Œè¯¥ç½‘å¡åœ¨å®¿ä¸»æœºè¡¨ç°ä¸ºvethxxxxï¼Œåœ¨å®¹å™¨é‡Œè¡¨ç°ä¸ºeth0#ifxxx;  ä¸€ä½“ä¸¤é¢ å°±è¿™ä¹ˆç†è§£å°±è¡Œäº†ï¼Œå®˜æ–¹ç§°ä¹‹ä¸ºveth pairã€‚

![image-20240528141955478](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528141955478.png)



<img src="8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528142927753.png" alt="image-20240528142927753" style="zoom:50%;" />



docker0ç›¸å½“äºä¸€ä¸ªäº¤æ¢æœºï¼Œeth0--veth   éƒ½æ¡¥æ¥ä¸Šå»ã€‚è¿™æ ·å®¹å™¨ä¹‹é—´æ²Ÿé€šï¼Œèµ°docker0ï¼Œå®¹å™¨å‡ºå®¿ä¸»çš„æµé‡ä¹Ÿèµ°docker0ä¸è¿‡è¿˜å¾—è¿‡ä¸€å±‚SNATå‡ºå»ã€‚





### ç¡®è®¤æŸä¸ªvethè™šæ‹Ÿç½‘å¡æ‰€å±å®¹å™¨

**1ã€è¿›å…¥å®¹å™¨**

çœ‹ç¼–å·å¯¹åº”å…³ç³»å°±è¡Œäº†ï¼Œå®¿ä¸»ä¸Šçœ‹9å¯¹åº”åˆ°å®¹å™¨çš„8ï¼Œå°±æ˜¯ç¼–å·å¯¹åº”çš„ã€‚

![image-20240528152533265](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528152533265.png)

ä¹Ÿè¦æ³¨æ„è¿™ä¸ªveth-pairï¼Œä¸€ä½“ä¸¤é¢çš„ MAC æ˜¯ä¸ä¸€æ ·çš„ï¼›

ç„¶ådocker0å’Œvethæ˜¯æ¡¥æ¥å…³ç³»ã€‚

![image-20240528152829486](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528152829486.png)





**2ã€ä¸è¿›å®¹å™¨**

ä½†è¦æ³¨æ„ï¼šä¼šå¯¼è‡´ è¿›å…¥å¤šå±‚ bashï¼Œå¦‚æœæ“ä½œä¸å½“

```shell
docker inspect --format '{{.State.Pid}}' <container_id>
nsenter -t <PID> -n ip link
```

![image-20240528153501437](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528153501437.png)

æ‰€ä»¥è¿™ä¸ªæ–¹æ³•

<img src="8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528153536947.png" alt="image-20240528153536947" style="zoom: 44%;" />

å…¶å®å°±æ˜¯è¿›å…¥äº†å‘½åç©ºé—´äº†



**å…¶ä»–å·¥å…·çœ‹çœ‹docker0æŒ‚äº†å‡ ä¸ªå®¹å™¨æˆ–è€…å‡ ä¸ªveth**



è¿™ä¸ªå¯ä»¥ç›´è§‚çœ‹åˆ°dockeré‡ŒæŒ‚çš„å®¹å™¨çš„NAMEå’Œå®¹å™¨é‡Œçš„IPå’ŒMACï¼Œè¿˜ä¸é”™ğŸ‘‡

![image-20240528155538716](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528155538716.png)



è¿™ä¸ªå°±æ˜¯ä¸ªæ’ç‰ˆçœ‹çš„èˆ’æœè€Œå·²ï¼Œip a çœ‹åˆ°çš„docker0è‡ªç„¶æ˜¯æ¡¥æ¥åˆ°æ‰€æœ‰çš„vethxxxçš„ã€‚

![image-20240528155915368](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528155915368.png)



![image-20240528160430743](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528160430743.png)





åŒå®¿ä¸»å®¹å™¨ä¹‹é—´çš„pingå°±æ˜¯é»˜è®¤é€šçš„ğŸ‘‡

![image-20240528160748969](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528160748969.png)



# è§£å†³å®¹å™¨IPä¸å›ºå®šçš„é—®é¢˜

**èƒŒæ™¯ï¼š**

1ã€å®¹å™¨runèµ·æ¥äº†ï¼ŒIPä¸ç¡®å®šï¼Œrunèµ·æ¥äº†IPæ˜¯ä¸æ˜¯ä¹Ÿä¼šå—dhcpçš„é‡Šæ”¾å‘¨æœŸå½±å“çš„å’¯ã€‚

2ã€å¦‚æœä½ å…¬å¸å†…ç½‘æœ‰172.17æ®µï¼Œé‚£ä¹ˆå®¹å™¨å¦‚æœè¦å’Œè¿™ä¸ªæ®µäº’é€šï¼Œå°±ä¸è¡Œäº†ã€‚



**éœ€æ±‚ï¼š**

è§£å†³è¿™ä¸ªä¸å›ºå®šçš„é—®é¢˜å’¯ï¼Œç„¶åå°±å¯ä»¥æ›´å¥½çš„è‡ªåŠ¨åŒ–å’¯ã€‚ä»¥åŠæ›´æ¢å®¹å™¨çš„ç½‘æ®µã€‚



**è½å®ï¼š**



## ä¿®æ”¹docker0çš„dhcpçš„åœ°å€æ®µ



æ–¹æ³•1ï¼š

```shell
vim /etc/docker/daemon.json
{
	"bip": "172.19.0.0/16"  # è¿™é‡Œå†™é”™å•¦ï¼Œè¿™å†™hostå’Œæ©ç è€Œä¸æ˜¯å­ç½‘ï¼Œæ”¹æˆ0.1å°±è¡Œ
}
```

![image-20240530150122996](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530150122996.png)



æ”¹å®Œä»¥åï¼Œå“ªæ€•åˆ æ‰é‡å¯ç”µè„‘ï¼Œè¿™ä¸ªipå°±æ˜¯ä½ æ”¹åçš„æ ·å­äº†ï¼Œä¸ä¼šæ¢å¤åˆ°å‡ºå‚é»˜è®¤å€¼çš„ã€‚

å¯èƒ½çŒœæµ‹æ˜¯ï¼Œè€ƒè™‘åˆ°ä»¥å‰å·²ç»æœ‰å®¹å™¨åœ¨äº†ï¼Œä¸ç®¡æ˜¯upè¿˜æ˜¯exitedçš„ï¼Œå“ªæ€•ä½ åˆ é™¤äº†ï¼Œä¹Ÿç»™ä½ ç•™å­˜ä¸Šä¸€æ¬¡ä¿®æ”¹çš„è®°å½•ã€‚

å¦‚æœä½ æƒ³æ¢å¤å‡ºå‚IPï¼Œé‚£ä¹ˆå°±æ‰‹åŠ¨å†™æˆ172.17.0.1/16ï¼Œé‡å¯dockerï¼Œé¡¶å¤šåœ¨åˆ æ‰é…ç½®...ä¸è¿‡æ— æ‰€è°“äº†ã€‚







æ–¹æ³•2ï¼š

```shell
vim /lib/systemd/system/docker.service
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --bip=172.19.100.0/24
```

![image-20240530134834951](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530134834951.png)

æ–¹æ³•2æ²¡æœ‰æˆåŠŸ

![image-20240530151945083](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530151945083.png)







## æ¡¥æ¥åˆ°è‡ªå®šä¹‰çš„ç½‘æ¡¥

é»˜è®¤æ˜¯dockerçš„å†…å¤–ç½‘å¡éƒ½æ˜¯æ¡¥æ¥åˆ°docker0è¿™ä¸ªè™šæ‹Ÿç½‘æ¡¥çš„ï¼Œç°åœ¨æ”¹æ‰ã€‚



### 1ã€é¦–å…ˆåˆ›å»ºç½‘æ¡¥

```shell
yum -y install bridge-utils
brctl addbr br0
ip a a 172.20.100.1/24 dev br0
brctl show

```

![image-20240530164736771](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530164736771.png)

å‘ç°docker100è¿˜æ²¡æœ‰IPåœ°å€ï¼Œç„¶ådocker0å’Œdocker100éƒ½æ˜¯UPçš„ã€‚



![image-20240530165028628](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530165028628.png)



### 2ã€ä¿®æ”¹æœåŠ¡å¯åŠ¨æ–‡ä»¶

```shell
vim /lib/systemd/system/docker.service
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -b docker 100

```



### 3ã€é‡è½½å’Œé‡å¯

```
systemctl daemon-reload
systemctl restart docker
```



### 4ã€æŸ¥çœ‹ç¡®è®¤

```shell
ps -ef |grep dockerd

docker run --rm busybox hostname -i
```



![image-20240530165826921](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530165826921.png)



![image-20240530170035918](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530170035918.png)



å†åˆ›å»ºå®¹å™¨ï¼Œå°±ä¼šæ¡¥æ¥åˆ°docker100ä¸Šäº†

![image-20240530170154779](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530170154779.png)



![image-20240530170329555](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530170329555.png)



**åœ¨æ£€æŸ¥ä¸‹å®¹å™¨é‡Œé¢æ˜¯å¦å¯ä»¥pingé€šå¤–é¢**
![image-20240530170805223](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530170805223.png)

å¯ä»¥çš„ï¼Œé€šè¿‡æŠ“docker100çš„åŒ…ä¹Ÿå¯ä»¥çœ‹åˆ°

![image-20240530170824991](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530170824991.png)

å°è¯•æŠ“å®¹å™¨çš„å®¿ä¸»è™šæ‹Ÿæ¥å£çš„åŒ…

å…ˆå®šä½è¿™ä¸ªå®¹å™¨idçš„å†…å¤–IPæ˜¯å¤šå°‘ï¼Œå½“ç„¶æˆ‘ä»¬é€šè¿‡ä¸Šé¢æŠ“åŒ…å·²ç»çŸ¥é“æ˜¯172.20.100.2äº†ã€‚

![image-20240530171202335](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530171202335.png)

æ‰€ä»¥è¿™ä¸€æ¬¡é€šè¿‡è¿™ä¸ªå‘½ä»¤docker network inspectå¾—çŸ¥ä»€ä¹ˆå®¹å™¨çš„é‡Œé¢çš„ipæ˜¯ä»€ä¹ˆå

å†æ£€æŸ¥è¿™ä¸ªå®¹å™¨é‡Œçš„æ¥å£åç§°

### å¦‚ä½•çŸ¥é“exec å®¹å™¨çš„æ¥å£åç§°

1ã€æ¯”å¦‚æˆ‘è¦ä½¿ç”¨è¿™ä¸ªbd98e2b01c59å®¹å™¨æ¥åšæŠ“åŒ…

å°±å¯ä»¥é€šè¿‡exec -it xxxx  ip a çŸ¥é“æ¥å£å¯¹ï¼Œå°±çŸ¥é“æŠ“å¤–é¢çš„å“ªä¸ªæ¥å£çš„åŒ…äº†

![image-20240530171526764](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530171526764.png)



2ã€ç„¶åè¿˜å¯ä»¥é€šè¿‡ï¼Œ

docker network inspect ä½ è¦æ“ä½œå®¹å™¨çš„idå»ç¡®è®¤å¾…ä¼šæŠ“åŒ…çœ‹åˆ°çš„å†…ç½‘IPæ˜¯å•¥

![image-20240530171357089](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530171357089.png)



3ã€ç„¶åå¼€å§‹tcpdump é‚£ä¸ªæ¥å£

![image-20240530172016350](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530172016350.png)



![image-20240530172143088](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530172143088.png)



ç„¶åå°±çœ‹åˆ°åŒ…äº†

![image-20240530172156224](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530172156224.png)



æ­¤æ—¶ä¿®äº†å®¹å™¨é‡Œçš„ipï¼Œä¹Ÿèƒ½å¤Ÿç»™é€šå¤–é¢æ¥ï¼Œè¯´æ˜ä½ ä¿®æ”¹äº†docker100ä¸ºæ‰€æœ‰å®¹å™¨æ¡¥æ¥çš„è™šæ‹Ÿç½‘æ¡¥ï¼Œé‚£ä¹ˆSNATæ˜¯è‡ªåŠ¨ç»™ä½ åšäº†çš„ï¼Œæ— éœ€é…ç½®çš„

å¯ä»¥é€šè¿‡iptables -vnL -t natç¡®è®¤çš„

![image-20240530172500497](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530172500497.png)



**åˆ é™¤è‡ªå®šä¹‰çš„ç½‘æ¡¥**

![image-20240531140449815](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531140449815.png)

ip link downæ‰åï¼Œç½‘å¡ä¿¡æ¯è¿˜æ˜¯å°‘äº†å¾ˆå¤šä¸œè¥¿çš„ï¼Œä¸Šä¸‹ä¸¤å›¾docker1çš„ä¿¡æ¯éƒ½æ˜¯å…¨çš„ã€‚

![image-20240531140519798](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531140519798.png)

æ­¤æ—¶å†brctl delbr docker1å°±å¯ä»¥äº†

```shell
ip link set docker1 down
brctl delbr docker1
```



### ä½¿ç”¨nmcliåˆ›å»ºç½‘æ¡¥æ‰èƒ½å­˜å¾—ä½

ä¸Šé¢çš„btctlåˆ›å»ºçš„ç½‘æ¡¥ï¼Œé‡å¯å°±æ²¡äº†ï¼Œè¿™é‡Œæ”¹å†™ä¸ºnmcliæ¥å®ç°

```shell
nmcli conn add type bridge ifname docker100 con-name docker100
nmcli conn modify docker100 ipv4.address 172.16.100.254/24 ipv4.method manual ipv4.gateway xxx    ipv4.dns 192.168.10.2
```



![image-20240531141124479](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531141124479.png)



![image-20240531141526138](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531141526138.png)



ç”±äºä¹‹å‰åˆ›å»ºè¿‡å¯¼è‡´å†²çª

![image-20240531143147932](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531143147932.png)

è¿™ä¸ªåœ¨/var/log/messageé‡Œä¹Ÿçœ‹å¾—åˆ°ï¼Œ<span id=1>éœ€è¦åˆ é™¤/var/lib/docker/networké‡Œçš„db</span>

â€‹		ä¸Šå›¾è¿™ä¸ªæ•…éšœæ˜¯ï¼šä¹‹å‰brctlåˆ›å»ºäº†docker100ï¼Œé‡å¯ådocker100æ²¡äº†ï¼Œç”±äºdocker100æ²¡äº†dockeræœåŠ¡ä¹Ÿå°±èµ·ä¸æ¥äº†ï¼›æ­¤æ—¶æˆ‘åˆç”¨nmcli åˆ›å»ºäº†æ–°çš„brigeåŒæ ·ä¹Ÿå«docker100ï¼Œæˆ‘è¯•å›¾é‡å¯dockeræœåŠ¡ï¼Œç»“æœå°±æŠ¥äº†ä¸Šå›¾çš„é”™è¯¯ï¼Œè¯´æ˜dockerè‡ªå·±é‡Œé¢æœ‰ä¸€ä¸ªdocker100çš„åå­—çš„ç½‘æ¡¥äº†ï¼Œä¸€å®šæ˜¯ä»ä¹‹å‰çš„brctlçš„docker100å¯¹ç­‰è¿‡çš„ï¼Œè§£å†³æ–¹æ³•å°±æ˜¯ï¼Œrm -rf /var/lib/docker/netwokr/åˆ æ‰è¿™ä¸ªç½‘ç»œçš„é…ç½®ï¼Œå…¶å®é‡Œé¢æœ‰ä¸€ä¸ªdbæ–‡ä»¶çš„ã€‚

â€‹		æ­¤æ—¶å†é‡å¯dockerå°±OKäº†ã€‚è‡ªæ­¤å°±å®Œæˆäº†bridgeçš„nmlcliçš„é…ç½®ï¼Œä»¥ä¾¿é‡å¯ä¸ä¸¢å¤±ã€‚



**åŒæ ·æ”¹å›å»ï¼Œåˆ é™¤**

æ”¹å›å»ï¼Œ

![image-20240531154228513](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531154228513.png)

å†åˆ æ‰bridgeç½‘å¡

![image-20240531154135379](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531154135379.png)

é—®é¢˜æ¥äº†ï¼Œæ­¤æ—¶å†æ–°å»ºä¸€ä¸ªdocker100ï¼Œdockerå†æ”¹æˆ-b docker100èƒ½å¦èµ·æ¥ã€‚é¢„åˆ¤èµ·ä¸æ¥ï¼Œç†ç”±å¦‚ä¸Šï¼Œ[å°±æ˜¯è¦åˆ æ‰dockerçš„networké‡Œçš„db](#1)ã€‚

å…¶å®ç†ç”±å°±æ˜¯ï¼Œdelå¯ä»¥åˆ ï¼Œä½†æ˜¯æ­¤æ—¶dockeræœåŠ¡ä¸èƒ½é‡å¯ï¼Œå¯ä»¥stopä¹Ÿå¯ä»¥ä¸åŠ¨å®ƒå°±è®©ä»–activeç€ï¼Œ[å°±æ˜¯ä¸èƒ½restartï¼](#2)ï¼Œå¦åˆ™networkæ•°æ®åœ¨/var/lib/docker/network/files/local-kv.dbé‡Œé¢äº§ç”Ÿï¼›å¯¼è‡´å†æ¬¡åˆ›å»ºçš„docker100å’Œé‡Œé¢çš„ç”Ÿæˆçš„docker100æ•°æ®åŒåï¼Œä½†å…¶å®ä¸æ˜¯ä¸€ä¸ªä¸œè¥¿äº†ã€‚

è§£å†³è¿™ç§å†²çªçš„æ–¹æ³•å°±æ˜¯ï¼š

```shell
rm -rf /var/lib/docker/network/files/local-kv.db
systemctl restart docker

ä½†æ˜¯æœ‰é£é™©ï¼Œå°±æ˜¯dockerçš„æ‰€æœ‰çš„ç½‘ç»œä¿¡æ¯å°±æ²¡äº†åº”è¯¥
```

åˆ é™¤è™šæ‹Ÿç½‘æ¡¥docker100çš„æ­£ç¡®æ“ä½œå°±æ˜¯ 

```shell
systemctl stop docker
nmcli conn del docker100
```



```shell
systemctl stop docker
nmcli conn del docker100

nmcli conn add type bridge ifname docker100 con-name docker100
nmcli conn modify docker100 ipv4.address 172.16.100.254/24 ipv4.method manual
nmcli conn up docker100

systemctl restart docker

è¿™ç§æ“ä½œç½‘æ¡¥åˆ æ‰å†åˆ›å»ºï¼Œdockerçš„/var/lib/docker/network/ä¸‹æ— æ®‹ç•™ï¼Œè¿˜ä¼šèµ·å¾—æ¥çš„ã€‚
```



ä»¥ä¸‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„å…¨è¿‡ç¨‹æ¼”ç¤ºæˆªå›¾

1ã€æ­¤æ—¶dockeræœåŠ¡ok

![image-20240531160247208](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531160247208.png)



2ã€ç›´æ¥del docker100

3ã€å†è¡¥ä¸€ä¸ªdocker100å›å»

4ã€é‡å¯dockerï¼Œæ˜¯èµ·çš„æ¥çš„

![image-20240531160717667](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531160717667.png)



![image-20240531161014040](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531161014040.png)



![image-20240531161153458](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531161153458.png)



æ•…éšœç‚¹ï¼š<span id=2>docker100ä¸åœ¨çš„æƒ…å†µä¸‹ä¸èƒ½å¯åŠ¨dockerf</span>ï¼Œå¦åˆ™dockerä¼šè‡ªåŠ¨ç”Ÿæˆdocker100çš„æ•°æ®ï¼Œå¯¼è‡´ä½ nmlicå†æ¬¡åˆ›å»ºdocker100çš„æ—¶å€™äº§ç”Ÿå†²çªã€‚å€’æ˜¯èµ·ä¸æ¥ã€‚

![image-20240531161821165](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531161821165.png)







### ä½¿ç”¨busyboxæ¥æµ‹è¯•

![image-20240531164104370](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531164104370.png)



![image-20240531164319072](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531164319072.png)

é€šè¿‡helpå¯è§ï¼š

1ã€-fæ˜¯è¦ç”¨çš„ï¼Œç”¨æ¥ä¿è¯å®¹å™¨é‡Œæ˜¯å‰å°ï¼Œä»è€Œå®¿ä¸»ä¸Šrun -d ä¸ä¼šExited

2ã€Home directory default . è¡¨ç¤º index.htmlè¦åˆ›å»ºåœ¨è¿è¡Œhttpdç¨‹åºçš„å·¥ä½œç›®å½•å°±æ˜¯å½“å‰æ–‡ä»¶å¤¹



![image-20240531164736840](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531164736840.png)

ç„¶åå®¿ä¸»curlçœ‹çœ‹ï¼Œå¯è§å†…å®¹å°±æ˜¯test indexã€‚

![image-20240531164926905](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531164926905.png)

å†ç”¨åˆ«çš„å®¹å™¨æµ‹è¯• OK

![image-20240531165736401](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531165736401.png)

å…¶å®æ²¡æœ‰curlï¼Œç”¨wgetä¹Ÿè¡Œï¼š**wgetæ¨¡æ‹Ÿcurl**

![image-20240531165902477](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531165902477.png)



busyboxçš„httpd -vå°±æ˜¯å¸¦è®¿é—®æ—¥å¿—

<img src="8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531170124605.png" alt="image-20240531170124605" style="zoom:50%;" />



ä½†æ˜¯é—®é¢˜æ˜¯è¿™ä¸ªwebçš„å®¹å™¨é‡Œçš„IPä¸æ˜¯å›ºå®šçš„ï¼Œå“‡é ç»ˆäºå›åˆ°æ­£é¢˜äº†ï¼Œæˆ‘å“­å“¦~~~~

### è§£å†³å®¹å™¨IPä¸å›ºå®šçš„é—®é¢˜

å°±æ˜¯ä¸ç”¨IPï¼Œç”¨åå­—...

1ã€é¦–å…ˆserverè¿è¡Œçš„æ—¶å€™è¦å¸¦--nameçš„ï¼Œæœ‰åå­—å°±æ˜¯å›ºå®šçš„ä¿¡æ¯äº†

2ã€ç„¶åå…¶ä»–å®¹å™¨å°±--link å‚æ•°runå°±ä¼šè‡ªåŠ¨å†™hostså§ï¼Œä¸è¿‡å®¿ä¸»æ€ä¹ˆå¼„å‘¢ï¼Ÿ



**å®éªŒå¼€å§‹**

æ‰€è°“serverå…¶å®å°±æ˜¯è¢«è®¿é—®çš„é‚£ä¸€æ–¹äº†ã€‚

```shell
docker run -d --name web001 busybox httpd -v -f
```

![image-20240531171823140](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531171823140.png)

æ˜¾ç„¶è¿˜éœ€è¦è¡¥ä¸€ä¸ªç«¯å£æš´éœ²

å†è¡¥ä¸€ä¸ªindex.htmlæ–‡ä»¶

![image-20240531172228067](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531172228067.png)



è¿™æ ·å°±å¯ä»¥äº†

![image-20240531172449592](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531172449592.png)

åˆæˆä¸€ä¸ªdocker runè¯•è¯•ï¼Œæ…¢æ…¢æ¥å˜›ï¼Œå°±æ˜¯ç©ï¼Œä¸è¦æ‰æ€¥å®éªŒæœ¬èº«ï¼Œå› ä¸ºå®éªŒæœ¬èº«ä¸ä»£è¡¨ä½ å·¥ä½œå¹²æ´»åšäº‹æƒ…çš„é‚£ä¸ªåœºæ™¯ï¼Œä½ é‡åˆ°çš„é—®é¢˜è§£å†³å¾—è¶Šå¤šï¼Œä½ å°±è¶Šå‘å¾—èœœæ±è‡ªçœï¼Œå“¦æ˜¯è‡ªçœå“¦ï¼Œå°±ä¼šæ›´åŠ èƒ½holdçŒªï¼ŒåŠ æ²¹~



```shell
docker run -d --name web001 -p 8080:80 busybox sh -c 'echo 12345 > index.html;httpd -v -f'
```



![image-20240531180253627](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531180253627.png)



![image-20240531182729129](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531182729129.png)

ä»0å¼€å§‹è®¡æ•°çš„ğŸ‘†ï¼Œæ‰€æœ‰å°±æ˜¯ä¸¢äº†16ä¸ªã€‚

![image-20240531183228497](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531183228497.png)



ä¸çŸ¥é“ä¸ºå•¥ï¼Œæˆ‘æ„Ÿè§‰è¿™æ˜¯å‘ã€‚



ä¸çŸ¥é“å“‡

![image-20240531183733290](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240531183733290.png)

























# å·¥ä½œæ¡ˆä¾‹-linuxçš„pingæµ‹

linuxå¸¸pingè„šæœ¬ï¼Œ



**æ–¹æ³•1ï¼š**

```shell
ping 10.100.8.29 | awk '{ print $0 " " strftime("%F %H:%M:%S",systime()) }'  >> test.ping
```

![image-20240528175906802](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528175906802.png)

æ³¨æ„è¿™ç§ç›´æ¥ >> é‡å®šå‘åˆ° æ–‡ä»¶ï¼Œå¤§æ¦‚æ˜¯60ä¸ªpingåŒ…ä¸€èµ·å†™å…¥æ–‡ä»¶çš„ã€‚ä¸æ˜¯æ¯ä¸ªåŒ…å†™ä¸€ä¸ªçš„ï¼Œç›¸å½“äºé»˜è®¤çš„æœ‰ä¸€ä¸ªI/Oä¼˜åŒ–å§



**æ–¹æ³•2ï¼š**

```shell
ping 223.5.5.5 |& while read -r line;do echo "$(date) $line";done >> ping.log

ping 223.5.5.5 |& while read -r line;do echo "$(date) $line" >> /tmp/123.ping;done
```

![image-20240528180042025](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528180042025.png)

è¿™ç§æ–¹å¼å†™å…¥æ–‡ä»¶å¾ˆåŠæ—¶ï¼Œä¸€ä¸ªpingåŒ…å°±æ˜¯ä¸€ä¸ªã€‚

æ—¶é—´æ ¼å¼ä¼˜åŒ–ä¸‹

```
ping 223.5.5.5 |& while read -r line;do echo "$(date +%F_%H:%M:%S) $line" >> /tmp/ping.test ;done
```

![image-20240528180530420](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528180530420.png)





ç„¶åæ”¹æˆè„šæœ¬ï¼ŒåšæˆæœåŠ¡ï¼Œå¯ä»¥å®ç°å¼‚å¸¸åœæ­¢åçš„æœåŠ¡è‡ªåŠ¨èµ·æ¥ï¼Œä¹ŸåŒ…æ‹¬é‡å¯æœºå™¨è‡ªåŠ¨èµ·æ¥ã€‚

![image-20240528181218892](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528181218892.png)



![image-20240528181230987](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528181230987.png)



**åšæˆæœåŠ¡**



```shell
vim /etc/systemd/system/pingtest.service
```



```shell
[Unit]
Description=Ping Test Service
After=network.target

[Service]
User=root
Type=simple
ExecStart=/path/to/pingtest.sh 8.8.8.8
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```



```shell
systemctl daemon-reload
```



```shell
systemctl start pingtest.service
systemctl enable pingtest.service
```



```shell
systemctl status pingtest.service
```



**æµ‹è¯•kill åè‡ªåŠ¨èµ·æ¥**

æ‰¾åˆ°main pid

![image-20240528182214861](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528182214861.png)



kill -9ä¼šè‡ªåŠ¨èµ·æ¥

![image-20240528182515101](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528182515101.png)



kill ä¹Ÿä¼šèµ·æ¥

![image-20240528182823247](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528182823247.png)



stopçº¯äººå·¥åœæ­¢è‡ªç„¶ä¸ä¼šèµ·æ¥å’¯ï¼Œå¦åˆ™ä½ æ€ä¹ˆåœæœåŠ¡~

![image-20240528183043114](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528183043114.png)

æ³¨æ„statusé‡Œå¯ä»¥çœ‹åˆ°ä¸€äº›æœåŠ¡å™¨å¯åŠ¨æ—¥å¿—çš„å«æ—¶é—´ã€‚



ç³»ç»Ÿmessageä¹Ÿå¯ä»¥çœ‹

![image-20240528183549863](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240528183549863.png)





ä»¥ä¸Šå°±æ˜¯ç®€å•çš„ä¸€ä¸ªåšæ³•ï¼Œæˆ–è€…ä¸å†™æœåŠ¡ç”¨screenå»åšä¹Ÿä¸é”™ï¼Œ

ä¸è¿‡æ­£è§„è¿˜æ˜¯è¦ä¸Šç›‘æ§çš„ï¼Œæ¯”å¦‚ç”¨zabbix-agentå»å®ç°ï¼Œè¿™ä¸ªå‰æ–‡ä¹Ÿæœ‰ã€‚







# æ¡ˆä¾‹2ï¼Œå¦‚ä½•åšä¸ªè¿œç«¯èŠ‚ç‚¹çš„PINGæµ‹ç›‘æ§



å…¶å®å’Œæ–—æ•°ä¸€æ ·ï¼Œä¹Ÿæ˜¯çœ‹ä¸‰æ–¹å››æ­£



ä¸¾ä¾‹ï¼Œä½ è¦ç›‘æ§ä»ä¸Šæµ·åˆ°æ´›æ‰çŸ¶çš„äº‘ä¸»æœºçš„pingæµ‹ã€‚å°±éœ€è¦å‡º5å¼ å›¾ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªä¸‰æ–¹å››æ­£

â‘ å…¬å¸zabbix-----æ´›æ‰çŸ¶èŠ‚ç‚¹

â‘¡proxy1ä»£ç†----åˆ°æ´›æ‰çŸ¶èŠ‚ç‚¹

â‘¢proxy2ä»£ç†----åˆ°æ´›æ‰çŸ¶èŠ‚ç‚¹

â‘£å…¬å¸zabbix----åˆ°proxy1èŠ‚ç‚¹

â‘¤å…¬å¸zabbix----åˆ°proxy2èŠ‚ç‚¹



**çœ‹å›¾**

![image-20240530115548153](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530115548153.png)



æœ‰äº†è¿™ä¸ªæ€»ç»“ï¼Œä»¥ååšç›‘æ§ï¼ŒåŸºæœ¬ä¸Šå¦‚æœé‡è¦çš„èŠ‚ç‚¹ï¼Œå°±å¯ä»¥ä¸€æ­¥åˆ°ä½å…¨é¢ç›‘æ§ä½ã€‚







### æ¡ˆä¾‹-ipsecvpn

äº‘ä¸Šçš„VPNçš„ç½‘å…³å…¶å®æ˜¯PATå‡ºæ¥çš„ï¼Œè¦IDCçš„SSGå¼€å¯NAT-Tæ¥è§£å°çš„ã€‚



https://cshihong.github.io/2019/04/17/IPSec%20VPN%E7%9A%84NAT%E7%A9%BF%E8%B6%8A-NAT-T-%E5%8E%9F%E7%90%86/

æ–‡ç« ä¸­çš„è¿™ä¸ªä¼ è¾“æ¨¡å¼åŒæ ·ä¸èƒ½è½¬æ¢ç«¯å£çš„

![image-20240530184126020](8-Dockerçš„é»˜è®¤ç½‘ç»œå’Œå®¹å™¨é—´é€šä¿¡.assets/image-20240530184126020.png)

