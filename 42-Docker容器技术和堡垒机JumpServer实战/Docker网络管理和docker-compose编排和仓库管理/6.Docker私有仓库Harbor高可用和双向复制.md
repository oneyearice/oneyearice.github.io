# ç¬¬6èŠ‚ Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶



# Harborçš„è‡ªåŠ¨å¯åŠ¨

å‰ä¸€ç¯‡å‘ç° rebootå®¿ä¸»åï¼ŒHarborçš„9ä¸ªå§ å®¹å™¨æ²¡æœ‰å…¨éƒ¨èµ·å¾—æ¥ï¼Œå½“æ—¶å¤„ç†æ–¹å¼å°±æ˜¯

1ã€dockerçš„daemon.jsoné‡Œè¦æœ‰live-restore:trueçš„é…ç½®

2ã€rebootåç”±äºHarborçš„docker-compose.ymlé‡Œçš„é™¤äº†logå®¹å™¨ä»¥å¤–ï¼Œå…¶ä»–éƒ½æ˜¯æœ‰depends_onçš„ï¼Œæ‰€ä»¥å¯åŠ¨æ¬¡åºæ²¡æœ‰

![image-20240620171456351](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620171456351.png)

![image-20240620172915344](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620172915344.png)

![image-20240620173026479](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620173026479.png)

![image-20240620173210923](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620173210923.png)

è¿™å°±æ˜¯æˆ‘è¦çš„æ•ˆæœäº†ğŸ‘†

åˆ°è¿™å¯ä»¥åˆ¤æ–­ä¸‹

1ã€ä»ä¸Šå¾€ä¸‹å¯åŠ¨æ¥ç€

2ã€harhor-log é¦–å…ˆå¯åŠ¨

3ã€registryï¼Œå…¶æ¬¡å¯åŠ¨ï¼Œä½†æ˜¯logå¯åŠ¨å¦‚æœé€Ÿåº¦æ…¢äº†ï¼Œregistryä¹Ÿè®¸å°±å¯åŠ¨ä¸äº†äº†ï¼Œå› ä¸ºæŸ¥çœ‹docker-comose.ymlé‡Œæ²¡æœ‰å»¶è¿Ÿè®¾ç½®

4ã€rebootçœ‹çœ‹å“ªäº›èµ·ä¸æ¥

![image-20240620173713751](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620173713751.png)

è¿™æ¬¡å°±ä¸€ä¸ªjobserviceæ²¡èµ·æ¥

å†reboot

![image-20240620174019388](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620174019388.png)

è¿™æ¬¡å°±ä¸€ä¸ªlogèµ·æ¥äº†ï¼Œä½ çœ‹ä¸ç¨³å®šçš„

å°±æ˜¯logå¯åŠ¨æ…¢äº†ï¼Œä¾èµ–å®ƒçš„å…¶ä»–æœåŠ¡å¯åŠ¨çš„æ—¶å€™logæ²¡èµ·æ¥å‘¢ï¼Œå°±ggäº†ã€‚



ç„¶årestart dockerä¸€ä¸‹å°±åŸºæœ¬éƒ½å¥½äº†ï¼Œè¿™æ˜¯å› ä¸ºæœ‰daemon.jsoné‡Œçš„live-restoreå’Œcomposeé‡Œçš„restart alwaysç»“åˆçš„æ•ˆæœå§ã€‚

![image-20240620174233665](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620174233665.png)



# Harborå®‰è£…åå¯åŠ¨é—®é¢˜

1ã€éƒ¨åˆ†å¯åŠ¨OKï¼Œä¸ç¨³å®š

â€‹          å¦‚ä¸Šæ‰€è¿°

2ã€æ•°æ®å­˜æ”¾é»˜è®¤å®šä¹‰åœ¨äº†/dataä¸‹

â€‹			![image-20240620174756960](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620174756960.png)



![image-20240620174916232](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620174916232.png)



ä¸è¿‡openvpnçš„imageåªæ‰¾åˆ°æ‰¾ä¸ªåç§°çš„æ–‡ä»¶ï¼Œä½†æ˜¯imageæ–‡ä»¶å¤§å°å¯¹ä¸ä¸Šï¼Œå¯èƒ½è¿˜åœ¨å…¶ä»–åœ°æ–¹

![image-20240620175512532](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620175512532.png)



å¯ä»¥è‡ªå®šä¹‰harborçš„æ•°æ®æŒä¹…åŒ–ç›®å½•

![image-20240620175833877](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620175833877.png)

ç„¶åè¿è¡Œ./prepareè„šæœ¬

![image-20240620180537723](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620180537723.png)

å°±è‡ªå®šäº†harborçš„æ•°æ®å·çš„åœ°æ–¹ï¼Œä½†æ˜¯éœ€è¦é‡æ–°docker-compose down / upäº†

è€Œä¸”æ–°çš„æ•°æ®æŒä¹…åŒ–ç›®å½•é‡Œæ˜¯ç©ºçš„ï¼Œ

![image-20240620180837510](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620180837510.png)

æ³¨æ„down upæ‰è¡Œï¼Œrestartä¸è¡Œ



![image-20240620181049358](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620181049358.png)



ç„¶åå°±å‘ç°ä¹‹å‰ä¸Šä¼ çš„é•œåƒæ²¡äº†

![image-20240620181132515](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620181132515.png)



=============å¯»æ‰¾harborä¸Šä¼ çš„imageåˆ°åº•æ”¾åœ¨å“ªäº†ğŸ‘‡======================

åŸæ¥çš„openvpnè¿˜åœ¨æ—§çš„è·¯å¾„é‡Œï¼Œå½“ç„¶å›¾ä¸­çš„openpvnåªæ˜¯åç§°ä¸æ˜¯image

![image-20240620181237889](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620181237889.png)

imageåœ¨registryé‡Œä¸è¿‡åå­—æ˜¯hashå€¼äº†ï¼Œè€Œä¸”ä¸å¤ªå¥½æ‰¾ï¼Œæ¯”å¦‚æˆ‘ä¸Šä¼ ä¸€ä¸ª500MBçš„é•œåƒï¼Œä»–ä¼šå‹ç¼©åˆ°141MBğŸ‘‡

![image-20240621145250706](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621145250706.png)

ç„¶åå°±æ˜¯æ‰¾æ‰¾ä¸ªæ–‡ä»¶åˆ°åº•åœ¨ä»€ä¹ˆåœ°æ–¹

![image-20240621145505224](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621145505224.png)

å…³æ³¨layerå±‚æ–‡ä»¶

![image-20240621145532676](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621145532676.png)

é€šè¿‡æœç´¢ï¼Œdu -sh *è§‚å¯Ÿæ–‡ä»¶å¤§å°ï¼Œå‘ç°141MBä¹Ÿè¢«æ‹†åˆ†æˆåˆ†å±‚é•œåƒäº†

ä½†å®é™…æ–‡ä»¶ç¡®ä¸åœ¨è¿™äº›è·¯å¾„é‡Œï¼Œåœ¨è¿™é‡ŒğŸ‘‡ï¼Œä¸Šä¼ çš„é•œåƒæ•´ä½“æ˜¯åœ¨regsitryå¤§æ–‡ä»¶å¤¹é‡Œé¢

![image-20240621145823968](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621145823968.png)

æ‰¾åˆ°ä¸€ä¸ª

![image-20240621145930951](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621145930951.png)



**æ‰€ä»¥ç»“è®ºæ¥äº†**ï¼šä½ ä¸Šä¼ ä¸€ä¸ª500MBçš„imageï¼Œharboré¦–å…ˆç»™ä½ æ‹†åˆ† åˆ†å±‚ï¼Œç„¶åç»™ä½ å‹ç¼©åˆ†åˆ«å­˜æ”¾ã€‚é¡µé¢ä¸Šçœ‹åˆ°çš„å°±æ˜¯141MBçš„å‹ç¼©åå¤§å°ã€‚ä¼ ç»Ÿè§‚å¿µæ˜¯æˆ‘ä¸Šä¼ ä¸€ä¸ªé•œåƒï¼Œæˆ‘å¯ä»¥ä»åå°ä¹Ÿå°±æ˜¯åº•å±‚linuxå»æ‰¾åˆ°è¿™ä¸ªé•œåƒç„¶åå¯¼å‡ºæ¥ï¼Œå¯¹ä¸èµ·è¿™ç§æ–¹å¼harborä¸æ”¯æŒäº†ï¼Œå› ä¸ºimageè¢«æ‹†åˆ†äº†ï¼Œåªèƒ½é€šè¿‡cliå»pullä¸‹æ¥äº†ã€‚



=============å¯»æ‰¾harborä¸Šä¼ çš„imageåˆ°åº•æ”¾åœ¨å“ªäº†ğŸ‘†======================



æ”¹å›å»ä¸Šä¼ çš„é•œåƒå°±å›æ¥äº†

![image-20240620181512946](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620181512946.png)

å¯ä»¥çœ‹å‡ºæ¥ï¼Œdownæ˜¯ä»ymlæ–‡ä»¶é‡Œ ï¼Œä»ä¸‹å¾€ä¸Šdownçš„ï¼Œupå°±æ˜¯ä»ä¸Šå¾€ä¸‹upçš„ã€‚

![image-20240620181454232](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620181454232.png)





![image-20240620182444676](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240620182444676.png)



## è¨€å½’æ­£ä¼ å¼€å¯è‡ªå¯åŠ¨å’‹è§£å†³



### æ–¹æ³•1ï¼Œå†™ä¸ªserviceæ–‡ä»¶



```shell
[root@harbor ~]#vim /lib/systemd/system/harbor.service
[unit]
Description=Harbor
After=docker.service systemd-networkd.service systemd-resolved.service
Requires=docker.service
Documentation=http://github.com/vmware/harbor

[Service]
Type=simple
Restart=on-failure
RestartSec=5
ExecStart=/usr//bin/docker-compose -f /apps/harbor/docker-compose.yml up
ExecStop=/usr/bin/docker-compose -f /apps/harbor/docker-compose.yml down

[Install]
WantedBy=multi-user.target


[root@harbor ~]#systemctl daemon-reload
[root@harbor ~]#systemctl enable harbor

```

å¦‚æœå°†ä¸Šé¢çš„up downæ”¹æˆstartå’Œstopåè€Œä¸çµäº†--å°±æ˜¯èµ·ä¸æ¥ã€‚

![image-20240621100427366](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621100427366.png)

rebootè¯•è¯•

![image-20240621101010282](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621101010282.png)





### æ–¹æ³•2ï¼Œå†™rc.loalå’¯



```shell
vim /etc/rc.local
#! /bin/bash
cd /apps/harbor
/usr/bin/docker-compose up

ä¿å­˜é€€å‡ºğŸ‘‡ä¿®æ”¹æ‰§è¡Œæƒé™
chmod +x /etc/rc.local
```







# Harborçš„HA

Harboræœ€å…³é”®è¿˜æ˜¯é•œåƒåˆ«ä¸¢äº†å°±è¡Œã€‚



## 1ã€ä¸å¤ªå®Œç¾çš„å…±äº«å­˜å‚¨

<img src="6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621154316783.png" alt="image-20240621154316783" style="zoom:30%;" />





å‰é¢é¡¶ä¸€ä¸ªLBï¼Œæ¯”å¦‚nginxï¼Œlvsã€httpproxy

åé¢æ˜¯å‡ ä¸ªHarobråšå®ä¾‹ï¼Œ

ä½†æ˜¯æ•°æ®ä¸æ”¾åœ¨Harborä¸Šäº†ï¼Œå•ç‹¬æ”¾åˆ°åé¢ï¼Œä¾›å‡ ä¸ªHarborå…±äº«å­˜å‚¨ã€‚

æ•°æ®ç”¨NASï¼ŒNFSæ¥åšï¼›ç„¶åNFSè¦åšå¥½å¤‡ä»½ï¼Œæ¯”å¦‚rsyncçš„å®æ—¶å¤‡ä»½...ä¸çŸ¥é“ä¼šä¸ä¼šé™ä½IOé™ä½ä¸šåŠ¡æ•ˆç‡å•Šã€‚

æ€»ä¹‹è¿™ä¸ªæ–¹æ¡ˆä¸å¤ªä¼˜ç§€~



å°±æ˜¯è¿™ä¸ªdata_volumeç›®å½•æ˜¯è¿œç¨‹æŒ‚è½½çš„

![image-20240621153108398](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621153108398.png)



## 2ã€åŸºäºé•œåƒå¤åˆ¶

<img src="6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621154424637.png" alt="image-20240621154424637" style="zoom:33%;" />



å°±æ˜¯å­˜å‚¨æ—¶å•ç‹¬çš„ï¼Œä½†æ˜¯äº’ç›¸å¤åˆ¶çš„ï¼›ç±»ä¼¼mysql åŒä¸»A/Aæ¨¡å‹ã€‚

å‰ç«¯è¿˜æ˜¯LBï¼Œæ¯”å¦‚nginxï¼Œ

åé¢æ˜¯å‡ ä¸ªHarboråšå®ä¾‹ï¼Œæ•°æ®ä¹Ÿæ˜¯è·Ÿç€Harborèµ°çš„ã€‚ä¸ç”¨å…±äº«æ•°æ®å­˜å‚¨ã€‚



ç¬¬ä¸€ç§æ–¹æ¡ˆå°±æ˜¯å…±äº«å­˜å‚¨NFS NASçš„æ­å»ºäº†ï¼Œé‡ç‚¹æ—¶ç¬¬äºŒç§æ–¹æ¡ˆçš„å­¦ä¹ 



Harborä¹‹é—´çš„æ•°æ®å­˜å‚¨çš„å¤åˆ¶ï¼Œå…¶ç²’åº¦æ›´ç²¾ç»†--å°±æ˜¯å¤šä¸ªé¡¹ç›®ï¼ŒæŒ‡å®šå“ªå‡ ä¸ªåšHAï¼Œæ˜¯å¯ä»¥è¿™æ ·çš„ã€‚

![image-20240621154929634](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621154929634.png)

æœ‰äº›æµ‹è¯•çš„å¯èƒ½å°±æ²¡å¿…è¦åšHAã€‚





# å®éªŒå¼€å§‹

æç¬¬äºŒå°Harbor

å½“ç„¶ç›‘å¬ç«¯å£2å°éƒ½å¾—æ”¹æ”¹ï¼Œç¬¬ä¸€å°é¡µä¸ç”¨æ”¹ï¼Œåˆ°æ—¶å€™LBé‚£è¾¹é¡¶å‰é¢å°±è¡Œäº†

## 1ã€docker çš„é…ç½®åŒæ­¥ä¸‹

![image-20240621161201567](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621161201567.png)

è®°å¾—é‡å¯æœåŠ¡

systemctl enable docker

systemctl start docker



## 2ã€å®‰è£…docker-compose

```shell
wget https://github.com/docker/compose/releases/download/v2.27.1/docker-compose-linux-x86_64

mv docker-compose-linux-x86_64 /usr/local/bin/docker-compose

chmod +x /usr/local/bin/docker-compose
```



## 3ã€ç„¶åå°±å¼€æ•´harbor

```shell

#ä¸‹è½½
wget https://github.com/goharbor/harbor/releases/download/v2.11.0/harbor-offline-installer-v2.11.0.tgz

#è§£å‹
tar xf harbor-offline-installer-v2.11.0.tgz

#ä¿®æ”¹
cd harbor
mv harbor.yml.tmpl harbor.yml

vim harbor.yml
æ³¨é‡Šä¸‹ğŸ‘‡ï¼š
#https:
#  # https port for harbor, default is 443
#  port: 443
#  # The path of cert and key files for nginx
#  certificate: /your/certificate/path
#  private_key: /your/private/key/path
#  # enable strong ssl ciphers (default: false)
#  # strong_ssl_ciphers: false

...
ä¿®æ”¹
hostname: harbor.oneyearice.org   # æ®è¯´æ˜¯HAçš„æ—¶å€™ä¸¤ä¸ªHarborå¿…é¡»ç”¨IPï¼Œæˆ‘å…ˆä¸ç”¨
data_volume: /data/harbor
...
...

#åˆå§‹åŒ–
./install.sh

# æ­¤æ—¶docker-compose pså°±å¯ä»¥çœ‹åˆ°harborå·²ç»èµ·æ¥äº†ï¼Œwebæ‰“å¼€çœ‹çœ‹æ˜¯okçš„å°±è¡Œ
admin/Harbor12345   é»˜è®¤è´¦å·å¯†ç 

#å†™serviceå®ç°å¼€å¯å’Œå¼‚å¸¸é€€å‡ºæ—¶è‡ªå¯åŠ¨
[root@server ~]# cat /lib/systemd/system/harbor.service
[unit]
Description=Harbor
After=docker.service systemd-networkd.service systemd-resolved.service
Requires=docker.service
Documentation=http://github.com/vmware/harbor

[Service]
Type=simple
Restart=on-failure
RestartSec=5
ExecStart=/usr/local/bin/docker-compose -f /apps/harbor/docker-compose.yml up
ExecStop=/usr/local/bin/docker-compose -f /apps/harbor/docker-compose.yml down

[Install]
WantedBy=multi-user.target


#åŠ è½½
systemctl daemon-reload
systemctl enable harbor
docker-compose down  # å…ˆåœæ‰ä¹‹å‰çš„docker-composeæ‰‹åŠ¨upçš„æœåŠ¡ï¼Œå†ç»Ÿä¸€ä½¿ç”¨s
systemctl restart harbor  # å†ç»Ÿä¸€ä½¿ç”¨serviceæ¥å¯åŠ¨å’Œåœæ­¢ï¼Œå¦åˆ™serviceè¿˜ç®¡ä¸äº†ä¹‹å‰æ‰‹åŠ¨å¯åŠ¨çš„æœåŠ¡ã€‚


#è¿™æ ·å°±å°±okäº†
```



## 4ã€é…ç½®HA



æ³¨æ„ï¼Œå¯èƒ½éœ€è¦å°†2å°Harborçš„åˆå§‹åŒ–ymlé‡Œçš„hostnameæ”¹æˆIPåœ°å€ï¼Œå½“ç„¶æˆ‘è§‰å¾—æ²¡å¿…è¦ï¼Œå…ˆä¸æ”¹ã€‚

å¦‚æœæ”¹å°±éœ€è¦./prepareåå†systemctl restart harborçš„ã€‚



ç°åœ¨æœ‰ä¸¤å°Harbor ä¸€å°192.168.126.132 ï¼›ä¸€å°192.168.126.133



### 1ã€å…ˆæ–°å»ºéœ€è¦åŒæ­¥çš„é¡¹ç›®ï¼šä¸¤è¾¹éƒ½è¦åˆ›å»ºï¼Œæœ€å¥½åŒå



![image-20240621171325435](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621171325435.png)



![image-20240621171514654](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621171514654.png)

æ³¨æ„ç¬¬äºŒå°ä¸Šçš„é¡¹ç›®åç§°å°‘å†™äº†8ï¼Œä½†æ˜¯ä¸è¦ç»ï¼Œå¾…ä¼š132ç›´æ¥å¯ä»¥æŠŠK888sè¿é¡¹ç›®å¸¦é•œåƒä¸€èµ·æ¨è¿‡æ¥ğŸ‘†



### 2ã€å…¶æ¬¡å°±è¦åšä¸¤éå•å‘å¤åˆ¶ï¼Œå®ç°åŒå‘

å…³é”®è¯ï¼šä»“åº“ç®¡ç†--ä»€ä¹ˆé¡¹ç›®è¿›è¡ŒåŒæ­¥  ã€ å¤åˆ¶ç®¡ç†--æ€ä¹ˆä¸ªåŒæ­¥æ³•



![image-20240621172824198](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621172824198.png)

å¯è§ğŸ‘†ä¸ä»…ä»…æ”¯æŒharborçš„åŒæ­¥ï¼Œè¿˜æ”¯æŒä»å…¶ä»–åœ°æ–¹æ¯”å¦‚AWSï¼Œæ¯”å¦‚gitlabä¹‹é—´çš„åŒæ­¥ã€‚

ä¹Ÿæ”¯æŒdockerå®˜æ–¹çš„registryåŒæ­¥--è¿™ä¸ªæ˜¯æŒ‡registryè¿™ä¸ªç§æœ‰æ–¹æ¡ˆå§ï¼Œè¿˜æ˜¯è¯´hub.docker.comå•Šï¼Œåº”è¯¥ä¸æ˜¯è¯´hub.docker.com

å…¶å®æˆ‘å€’æ²¡å¸Œæœ›æœ‰ä¸€ä¸ªç±»ä¼¼ç¼“å­˜ä»£ç†çš„åŠŸèƒ½ï¼Œå°±æ˜¯ä»è¿™ä¸ªharborä¸‹è½½çš„å…¬å…±é•œåƒéƒ½ç¼“å­˜ï¼Œä¸‹æ¬¡å…¶ä»–äººä¸‹è½½ä¹Ÿèƒ½å¤Ÿåˆ©ç”¨ç¼“å­˜ã€‚nexuså€’æ˜¯ç”¨çš„æ¯”è¾ƒå¤šã€‚



**ç›®æ ‡å**å°±æ˜¯åŒæ­¥çš„å¯¹æ–¹Harborçš„é¡¹ç›®å

è‚¯å®šå†™IPäº†ï¼Œå¦åˆ™åŸŸåä¸€æ ·å°±å‡ºé—®é¢˜ï¼Œä¸è¿‡æˆ‘ä¸Šé¢harbor.ymlåˆå§‹åŒ–çš„é…ç½®é‡Œ éƒ½ç”¨çš„ä¸€ä¸ªharbor.oneyearice.orgåŸŸåæˆ‘è§‰å¾—ä¸ç¢äº‹ï¼Œæ‰€ä»¥æ²¡æ”¹ï¼Œç»§ç»­çœ‹çœ‹å‘—~~

![image-20240621173307800](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621173307800.png)

è®¿é—®IDå’Œå¯†ç ï¼Œä¸¥æ ¼æ¥è®²ï¼Œæ˜¯å¯¹æ–¹ä»“åº“é¡¹ç›®é‡Œçš„æˆå‘˜IDå’Œå¯†ç æ¥ç€ï¼Œä¸è¿‡adminæ˜¯éƒ½æœ‰äº†ã€‚

å› ä¸ºæ²¡æœ‰å¯åŠ¨SSLï¼Œæ‰€ä»¥å»æ‰å‹¾é€‰

![image-20240621175435914](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621175435914.png)

æŠ¥é”™äº†ï¼Œå›å¤´å»ä¿®æ”¹hostnameä¸ºIPå§

![image-20240621175544466](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621175544466.png)

![image-20240621175559056](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621175559056.png)

![image-20240621175624082](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621175624082.png)

ä¸¤å°é™¤äº†IPä¸åŒï¼Œæ“ä½œéƒ½æ¥ä¸€éğŸ‘†

ä½ çœ‹ï¼Œ192.168.126.133ä¸€æ”¹ä¸ºIPï¼ŒğŸ‘‡132å»è¿æ¥å°±å¥½äº†ï¼Œæˆ‘ä¼°è®¡è¿™ä¸ªhostnameåæœ‰å…«ä¹å†™åˆ°nginxçš„serverå—äº†ï¼Œä½ å†™åŸŸåçš„ç»“æœå°±æ˜¯ä½ è¦ç”¨åŸŸåå»è®¿é—®ã€‚

![image-20240621175720450](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621175720450.png)

æŸ¥ä¸€ä¸‹nginxçš„é…ç½®å‘—

æ²¡æ‰¾åˆ°.....

![image-20240621180351896](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621180351896.png)



### çº é”™:

**ç®—äº† ä¸¤è¾¹éƒ½æ”¹æˆIPå§ï¼Œå°±æ˜¯è¯´HAçš„æ—¶å€™ä¸¤å°harbor.ymlé‡Œéƒ½è¦ç”¨IP**



ç°åœ¨ä¸¤éå°±éƒ½OKäº†ï¼ŒğŸ‘‡å›¾çš„é¡¹ç›®åç§°ä¸å¿…äº‹å…ˆå­˜åœ¨ï¼Œä¸è¿‡æœ€å¥½ä¸è¦çæŠ˜è…¾ï¼Œè¿™é‡Œä»…ä»…é¡ºä¾¿è®²æ¸…æ¥šè€Œå·²ã€‚

![image-20240621180558661](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621180558661.png)

å¥½åƒSSLä¸å»æ‰ä¹Ÿè¡Œã€‚ã€‚ã€‚

<img src="6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621180728808.png" alt="image-20240621180728808" style="zoom:50%;" />

è¿˜æ˜¯å»æ‰å§ï¼Œä¸‡ä¸€åé¢å¤åˆ¶çš„æ—¶å€™éªŒè¯SSLå°±éº»çƒ¦äº†



![image-20240621180820722](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621180820722.png)



![image-20240621181023720](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621181023720.png)



### 3ã€ç»§ç»­é…ç½®æ€ä¹ˆåŒæ­¥

ä¹Ÿå°±æ˜¯å¤åˆ¶ç®¡ç†

![image-20240621181351531](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240621181351531.png)

æ–°ç‰ˆæ˜¯æœ‰pullå’Œpushçš„ï¼Œè€ç‰ˆçš„åªæœ‰push

è¿˜æ˜¯ç”¨pushï¼Œæ¨ï¼Œç”¨æ¨å¯ä»¥åšåˆ°å®æ—¶åŒæ­¥ï¼Œå› ä¸ºpullæ‹‰åº”è¯¥ä¸èƒ½å®æ—¶çš„å»çŸ¥é“ä»€ä¹ˆæ—¶å€™å»æ‹‰ã€‚å°±æ˜¯æœ¬åœ°é•œåƒä¸€å˜å°±pushè¿‡å»ï¼Œä½†æ˜¯è¦å®æ—¶æ‹‰ï¼Œå°±å¾—çŸ¥é“å¯¹ç«¯é•œåƒçš„å®æ—¶å˜åŒ–äº†ä¸æ–¹ä¾¿å¯èƒ½ã€‚ç†è®ºä¸Šæ˜¯å¯ä»¥è®©å¯¹ç«¯å°†é•œåƒå˜åŒ–çš„ä¿¡æ¯å‘è¿‡æ¥çš„ï¼Œä½†æ˜¯å®é™…åº”ç”¨å°±ä¸å¥½è¯´ï¼Œæ‰€ä»¥è¿˜æ˜¯æœ±æ°¸pushå§ã€‚

![image-20240624102515003](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624102515003.png)

å¦‚å›¾ğŸ‘†å¯è§pullæ‹‰æ˜¯æ²¡æœ‰è§¦å‘äº‹ä»¶çš„ï¼Œæ²¡æ³•åšåˆ°å®æ—¶





ç®€å•é…ä¸€ä¸‹

![image-20240624094405872](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624094405872.png)

æ­¤æ—¶å·²ç»å®ç°äº†192.168.126.132--->192.168.126.133çš„å•å‘å¤åˆ¶ã€‚

æµ‹è¯•ä¸‹

â‘ å†å¼€ä¸€ä¸ªæœºå™¨192.168.126.134ï¼Œå¹¶ä¿®æ”¹dockeré…ç½®æ–‡ä»¶ï¼ŒåŠ ä¸€ä¸‹æ²¡æœ‰sslçš„å¿½ç•¥é…ç½®

![image-20240624095413653](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624095413653.png)

è¿™é‡Œä¸´æ—¶ğŸ‘†é…ç½®äº†ä¸¤ä¸ªHarborçš„ipåœ°å€ï¼Œåé¢åŠ äº†nginxåå°±åˆ æ‰2ä¸ªipï¼Œæ”¹æˆ1ä¸ªnginxçš„ä»£ç†ipå°±è¡Œäº†ã€‚



â‘¡ä¸¤ä¸ªHarboréƒ½ç™»å…¥ä¸€ä¸‹ğŸ‘‡

![image-20240624100229343](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624100229343.png)



PSï¼šå¯†ç æ˜¯æ˜æ–‡å­˜æ”¾çš„

![image-20240624100015151](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624100015151.png)



æ¨ä¸€ä¸ªbusyboxä¸Šå»

![image-20240624100725250](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624100725250.png)



æ­¤æ—¶133é‚£å°harborä¹Ÿå°±è‡ªåŠ¨å¤åˆ¶è¿‡å»äº†

![image-20240624100700127](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624100700127.png)

æ³¨æ„133ä¸Šçš„K888Sæ˜¯äº‹å…ˆä¸å­˜åœ¨çš„ã€‚ä¸Šæ–‡é¡µæåˆ°äº†ï¼Œè€Œä¸”logä¹Ÿçœ‹å¾—åˆ°ğŸ‘‡ï¼Œå°±æ˜¯ä»“åº“ç®¡ç†é‚£é‡Œå†™å•¥å°±æ¨äº†å•¥ä¼°è®¡ã€‚

![image-20240624101351300](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624101351300.png)



æ­¤æ—¶ç”±äº133æ²¡æœ‰pushåˆ°132çš„ å¤åˆ¶è§„åˆ™ ï¼Œæ‰€ä»¥ 

![image-20240624102645013](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624102645013.png)

è¿™ä¸ªbusybox:v002åªä¼šå­˜åœ¨äº133ä¸Šï¼Œä½†æ˜¯ç”±äºå“ˆå¸Œå€¼ä¸€æ ·çš„ï¼Œåªæ˜¯æ”¹äº†ä¸ªtagï¼Œæ‰€ä»¥harborç»™ä½ åˆå¹¶äº†

![image-20240624102953374](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624102953374.png)

![image-20240624103003433](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624103003433.png)



å†æ¨ä¸€ä¸ªalpineä¸Šåˆ°133å»

![image-20240624103039901](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624103039901.png)



ç„¶åå°†133-->132çš„åå‘å¤åˆ¶ç»™åšäº†

![image-20240624103222864](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624103222864.png)

ç„¶åå‘ç°æ­¤æ—¶132ä¸Šæ²¡æœ‰ç«‹é©¬å‡ºç°alpineå’Œbusybox:v002çš„ä¸¤ä¸ªé•œåƒã€‚



åº”è¯¥æ˜¯è§¦å‘åŠ¨ä½œæ²¡æœ‰ï¼Œæ‰€ä»¥133ä¸Špushä¸€ä¸ªå†

éšä¾¿æ¨ä¸€ä¸ªå­˜åœ¨éƒ½è¡Œ

![image-20240624103533635](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624103533635.png)

æ­¤æ—¶132å°±æ‹¿åˆ°133æ‰€æœ‰çš„å¤šå‡ºæ¥çš„é•œåƒäº†ï¼Œä¸å¯¹ï¼Œè¿˜å°‘äº†ä¸€ä¸ªbusybox:v002ğŸ‘‡

![image-20240624103559165](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624103559165.png)

å†æ¨ä¸€ä¸ªnginxåˆ°133çœ‹çœ‹

![image-20240624103744521](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624103744521.png)

å¥½nginxå·²ç»å¤åˆ¶åˆ°132äº†

å†çœ‹çœ‹busybox:v002

è¿˜æ˜¯æ²¡æœ‰

![image-20240624103823382](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624103823382.png)

### æ‰€ä»¥å¤åˆ¶çš„äº‹ä»¶è§¦å‘è§„åˆ™æ˜¯ğŸ‘‡

pushå“ªä¸ªimageå°±å¤åˆ¶å“ªä¸ªimageçš„ï¼Œä¸ä¼šè¯´ä¸€ä¸ªimageAè§¦å‘æ‰€æœ‰çš„å·®å¼‚åŒ–çš„images



æ‰€ä»¥å†æ¨ä¸€æ¬¡éœ€è¦åŒæ­¥çš„é‚£ä¸ªimageåˆ°133

![image-20240624104005686](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624104005686.png)

æ­¤æ—¶133å°±ä¼šè§¦å‘åŒæ­¥åˆ°133äº†

![image-20240624104030793](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624104030793.png)





åˆ é™¤ï¼Œåœ¨132ä¸Šåˆ é™¤é•œåƒ

![image-20240624104856576](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624104856576.png)

æ­¤æ—¶133ä¸Šé•œåƒçš„åç§°æ–‡ä»¶å¤¹è¿˜åœ¨ï¼Œä½†æ˜¯é‡Œé¢çš„ä¸œè¥¿ç¡®å®æ²¡äº†

![image-20240624104935025](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624104935025.png)

![image-20240624104944032](6.Dockerç§æœ‰ä»“åº“Harboré«˜å¯ç”¨å’ŒåŒå‘å¤åˆ¶.assets/image-20240624104944032.png)



### 
