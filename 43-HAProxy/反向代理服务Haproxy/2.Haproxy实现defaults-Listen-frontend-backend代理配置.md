# 2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.md





å‰é¢çš„å°ç»“ä»‹ç»äº†haproxyçš„å…¨å±€çš„ä¸€äº›é…ç½®ï¼Œä¸‹é¢æ­£å¼æ¥æ”¶proxyæœ¬èº«çš„ä»£ç†é…ç½®

# Proxiesé…ç½®



![image-20240807171644906](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240807171644906.png)



defaultså°±æ˜¯é»˜è®¤é…ç½®ï¼Œå¯ä»¥å†™æ˜å¯¹å“ªäº›ç»„nameï¼Œç”Ÿæ•ˆä¸ºdefaulté…ç½®ã€‚



## defaulté…ç½®

![image-20240807172059997](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240807172059997.png)

redispathæ¯”è¾ƒé‡è¦çš„ï¼Œä½†æ˜¯åˆ¤æ–­æœåŠ¡å™¨æŒ‚æ‰æ˜¯å¦é è°±éƒ½å¸¦è¿›ä¸€æ­¥ç ”ç©¶ã€‚

abortoncloseè¿™ä¸ªï¼ŒæœåŠ¡å…¶è´Ÿè½½é«˜äº†ï¼Œæ–­æ‰å½“å‰é˜Ÿåˆ—å¤„ç†æ¯”è¾ƒä¹…çš„è¿æ¥ï¼Œè¿™ä¸ªæ¯”è¾ƒä¹…çš„åˆ¤æ–­åˆæ˜¯å•¥ï¼Ÿå¯èƒ½ä¸æ˜¯å¤ªé è°±çš„å‚æ•°æœºåˆ¶ã€‚

http-keep-aliveï¼Œæœ‰äººè¯´æ˜¯ä¼šè¯ä¿æŒï¼›åº”è¯¥ä¸å¯¹ï¼Œæˆ‘ç†è§£ï¼šæ˜¯é•¿è¿æ¥çš„æ„æ€ï¼Œä¸æ˜¯ä¼šè¯ä¿æŒï¼›é•¿è¿æ¥ä¸»è¦æ˜¯ä¸ºäº†èŠ‚çœtcpå»ºè¿ä¸‰æ¬¡æ¡æ‰‹çš„å¼€é”€ã€‚

åŒæ ·è¿æ¥å»ºç«‹åœ¨é‚£ï¼Œä¸€ç›´ä¸ç”¨ä¹Ÿæœ‰é—®é¢˜ï¼Œäºæ˜¯å°±æœ‰äº†ä¸‹é¢çš„timeout http-keep-alive 120sçš„è€åŒ–æ—¶é—´ã€‚å°±æ˜¯å¼•å…¥ä¸€ä¸ªæªæ–½ï¼Œå¿…ç„¶ä¹Ÿä¼šå¸¦æ¥ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œäºæ˜¯è¿˜è¦è§£å†³é‚£ä¸ªå¸¦æ¥çš„é—®é¢˜æ‰èƒ½å·®ä¸å¤šåšå¥½äº‹æƒ…ã€‚è¿™æ˜¯å®‡å®™æ³•åˆ™ï¼›



forwardforï¼Œä¿ç•™å®¢æˆ·ç«¯çœŸå®IPï¼Œè¿™ä¸ªæåˆ°ä¿ç•™ä¸€è¯ï¼ŒåŸºæœ¬ä¸Šå°±æ˜¯å› ä¸ºproxyåšäº†ä¸¤å¤´æ¬ºéª—ï¼Œå°±æ˜¯ä¸¤æ®µTCPè¿æ¥äº†ï¼Œæ‰€ä»¥æ‰æœ‰æ‰“ä¸ŠçœŸå®IPå­—æ®µçš„è¯´æ³•ã€‚



mode http | tcp   ï¼ŒæŒ‡å®šé»˜è®¤æ˜¯å“ªå±‚ä»£ç†ã€‚å¦‚æœé»˜è®¤ä½¿ç”¨httpï¼Œé‚£ä¹ˆé…ç½®æ–‡ä»¶ä¸‹æ–‡çš„å…·ä½“çš„æ¯”å¦‚mysqlçš„ä»£ç†å°±è¦ç‰¹åˆ«å†™ä¸Šmode tcpæ¥ä»£ç†3306äº†ã€‚

â€‹		æ¯”å¦‚å®‰è£…åçš„haproxyçš„çŠ¶æ€é¡µğŸ‘‡çš„è¯­å¥å—é‡Œçš„mode httpå°±å¯ä»¥åˆ æ‰ï¼Œå› ä¸ºå¯ä»¥ç”¨defaulté‡Œçš„7å±‚ä»£ç†ã€‚

![image-20240808093627837](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808093627837.png)



**timeout connect 120s**  å®¢æˆ·ç«¯è¯·æ±‚ä»haproxyåˆ°åç«¯serveræœ€é•¿tcpè¿æ¥è¶…æ—¶æ—¶é—´(**tcpè¿æ¥ä¹‹å‰çš„ç­‰å¾…æ—¶é—´**)ï¼Œé»˜è®¤å•ä½ms

**timeout server 600s**  å®¢æˆ·ç«¯è¯·æ±‚ä»haproxyåˆ°åç«¯serverè¯·æ±‚å¤„ç†è¶…æ—¶æ—¶é•¿(**tcpè¿æ¥ä¹‹åçš„æ•°æ®å¤„ç†å“åº”è¶…æ—¶æ—¶é—´**)ï¼Œå¦‚æœè¶…æ—¶ä¼šå‡ºç°502é”™è¯¯ï¼Œå»ºè®®è®¾ç½®å¤§ç‚¹ï¼Œé˜²æ­¢502æŠ¥é”™ã€‚é»˜è®¤å•ä½ms

**timeout client 600s**  è®¾ç½®haproxyä¸å®¢æˆ·ç«¯çš„æœ€é•¿éæ´»åŠ¨æ—¶é—´ï¼Œå»ºè®®ä¸timeout serverç›¸åŒã€‚é»˜è®¤å•ä½msã€‚

**timeout check 5s** æ£€æµ‹åç«¯æœåŠ¡å™¨çš„è¶…æ—¶æ—¶é—´ã€‚



**default-server inter 1000 weight 3**  çœ‹ç€åƒä¸€ä¸ªæ•´ä½“æ€§çš„è®¾ç½®ï¼Œ1000msä¸€æ¬¡çš„å¥åº·æ£€æŸ¥ï¼Œè¯­å¥å—é‡Œçš„æœåŠ¡å™¨ä»¬éƒ½æ˜¯æƒé‡3ã€‚





æŸ¥çœ‹å¸®åŠ©å»å®˜ç½‘å°±è¡Œ

https://docs.haproxy.org/3.0/configuration.html#3



ç„¶åå®‰è£…åå€’æ˜¯æœ‰ä¸€ä¸ªmanå¸®åŠ©ï¼Œä¸è¿‡çœ‹è¦è¿™ä¹ˆçœ‹

![image-20240808103205444](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808103205444.png)



haproxyé‡Œçš„frontendå°±æ˜¯nginxå’Œhttpé‡Œçš„vipå’Œç«¯å£ï¼›Backendå°±æ˜¯Realserveråç«¯æœåŠ¡å™¨ã€‚

![image-20240808104528342](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808104528342.png)

é…ç½®æ–‡ä»¶é‡Œ2ä¸­å†™æ³•

1ã€frontendå’ŒBackendåˆ†å¼€æ¥å†™ï¼Œå®ç°å¤šå¯¹å¤šçš„æ•ˆæœ

2ã€å¦‚æœä¸€ä¸ªå‰ç«¯å°±å¯¹åº”ä¸€ä¸ªåç«¯ï¼Œé‚£ä¹ˆå°±å†™æˆlistençš„æ ¼å¼ä¹Ÿå°±æ˜¯å‰åç«¯å†™åœ¨ä¸€ä¸ªè¯­å¥å—é‡Œã€‚

https://docs.haproxy.org/3.0/configuration.html#4.1

![image-20240808105410125](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808105410125.png)

è¿™å°±æ˜¯ä¸€äº›æŒ‡ä»¤åªèƒ½æ”¾åœ¨ä¸€äº›åœ°æ–¹ğŸ‘†ã€‚



# listençš„å†™æ³•ï¼Œå°±æ˜¯å‰ç«¯åç«¯å†™ä¸€èµ·

```bash
vim /etc/haproxy/haproxy.cfg
# æ–‡æœ«åŠ ä¸Š
listen www.ming.com
    bind 0.0.0.0:80
    server web1 192.168.126.133:80
    server web2 192.168.126.134:80
    
# ä¿å­˜åreload
systemctl reload nginx
```

![image-20240808114647156](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808114647156.png)

haproxyå¯ä»¥reloadæ˜¯å› ä¸ºå½“åˆå†™äº†serviceæ–‡ä»¶

![image-20240808114723576](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808114723576.png)

nginxä¹Ÿæœ‰reloadçš„ğŸ‘‡

![image-20240808114946056](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808114946056.png)



haproxyé…ç½®bindåå°±ç›‘å¬ç›¸åº”çš„ç«¯å£äº†

<img src="2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808115558100.png" alt="image-20240808115558100" style="zoom:50%;" />

![image-20240808115546749](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808115546749.png)

LVSé‚£è¾¹æ˜¯å†…æ ¸ç›‘å¬ï¼Œss -tlnupæ˜¯çœ‹ä¸åˆ°çš„ï¼›è€Œhaproxyæ˜¯ä¸ƒå±‚APPï¼Œç›‘å¬çš„ç«¯å£ï¼Œss æ˜¯å¯è§çš„ã€‚



æ­¤æ—¶å°±å¯ä»¥æµ‹è¯•äº†

![image-20240808115939527](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808115939527.png)

å¯è§è°ƒåº¦é»˜è®¤è¿˜æ˜¯è½®è¯¢çš„ï¼Œ1ï¼š1çš„ã€‚



ç„¶åè§‚å¯Ÿåç«¯æ—¥å¿—ä¹Ÿå¯ä»¥çœ‹åˆ°æ˜¯ä¸¤ä¸ªtcp







ç„¶åss -ntçœ‹çœ‹é•¿è¿æ¥ï¼Œä¸è¿‡é…åˆå¤§æ–‡ä»¶+é™é€Ÿçœ‹æœ€ä½³ï¼Œè¿˜è¦æ³¨æ„ss -ntå¯è§å³ä½¿wgetæ–‡ä»¶å®Œæˆäº†ï¼Œæœ€ç»ˆtcpæ–­å¼€è¦ç»§ç»­æ™šä¸ª20så·¦å³çš„ã€‚

### wgetçš„clié™é€Ÿå’Œnginxé‚£å¤´é™é€ŸğŸ‘‡

![image-20240808135415443](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808135415443.png)



![image-20240808135501643](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808135501643.png)



![image-20240808135614461](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808135614461.png)

```bash
[roo@realserver2 haproxy]# wget --limit-rate=1k  192.168.126.132:80/test
```

![image-20240808140015628](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808140015628.png)



æ­¤æ—¶haproxyå’Œåç«¯æœåŠ¡å™¨çš„é•¿è¿æ¥å°±ä¸€ç›´éƒ½åœ¨çš„ï¼Œ**ä»€ä¹ˆæ—¶å€™clientä¸‹è½½å®Œäº†ï¼Œä»€ä¹ˆæ—¶å€™haproxyå’Œåç«¯çš„é•¿è¿æ¥å°±æ²¡äº†** è¿™ç‚¹å’Œnginxæ˜¯ä¸ä¸€æ ·çš„ã€‚nginxæ˜¯å¿«é€Ÿä»åç«¯æ‹‰ä¸‹èµ„æº(åº”è¯¥æ˜¯ç¼“å­˜åœ¨æœ¬åœ°ï¼Œä¸è¿‡è¿™ä¸ªç¼“å­˜ä¸æ˜¯æ¯æ¬¡éƒ½èƒ½åˆ©ç”¨çš„ï¼Œå¥½åƒæ¯æ¬¡clientå‘èµ·éƒ½è¦æ¥ä¸€éï¼Œå…³äºç¼“å­˜å‚è§nginxç¼“å­˜ç« èŠ‚38ç« ç¬¬ä¸€èŠ‚é‡Œæœ‰è¯¦ç»†è®²è§£)ï¼Œç„¶åæ…¢æ…¢çš„å‘ç»™clientçš„ã€‚

![image-20240808140447293](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808140447293.png)



å°†haproxyæ”¹æˆnginxï¼ŒåŒæ ·ä¸‹è½½æµ‹è¯•

nginxçš„ç›¸å…³é…ç½®

<img src="2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808140749649.png" alt="image-20240808140749649" style="zoom:50%;" />

<img src="2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808140855627.png" alt="image-20240808140855627" style="zoom:50%;" />



ç„¶åæµ‹è¯•ä¸‹

è´Ÿè½½è°ƒåº¦OK

![image-20240808140923072](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808140923072.png)

ä¹Ÿæ˜¯é»˜è®¤1ï¼š1

ä¸‹è½½æµ‹è¯•

1ã€clientè‡ªå·±é™é€Ÿ

![image-20240808141152787](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808141152787.png)

2ã€è§‚å¯Ÿnginxå’Œåç«¯realserverçš„tcpï¼Œå‘ç°å¾ˆå¿«å°±æ²¡æœ‰tcpçš„è¿æ¥äº†ï¼Œç„¶åclientè¿˜åœ¨é‚£æ…¢æ…¢ä¸‹ç€ã€‚

![image-20240808141227555](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808141227555.png)

3ã€ç»“è®ºï¼š

nginxå’Œhaproxyå­˜åœ¨ ä¸‹è½½ç¼“å­˜çš„åŒºåˆ«

â‘ client wget --limit-rate é™é€Ÿä¸‹è½½

â‘¡å¦‚æœæ˜¯nginxï¼Œé‚£ä¹ˆé™é€Ÿåªå‘ç”Ÿåœ¨client---nginxä»£ç†ä¹‹é—´ï¼Œåç«¯åˆ°nginxä»£ç†æ˜¯é£é€Ÿçš„ä¹Ÿå°±æ˜¯ä¸é™é€Ÿçš„å¾ˆå¿«å°±ä¸‹å®Œäº†ã€‚

â€‹		ç„¶åï¼Œå¦‚æœæ˜¯nginx ä»£ç†é…ç½®é‡Œåšé™é€Ÿï¼Œæ˜¯client---nginx-----realserverï¼Œnginxä¸­é—´ä»£ç†ä¸Šåšçš„é™é€Ÿï¼Œæ•ˆæœä¸€æ ·çš„ï¼Œåç«¯åˆ°nginxçš„èµ„æºä¸‹è½½éƒ½æ˜¯é£é€Ÿå°±ä¸‹å®Œäº†ã€‚

â€‹		è¿™æ˜¯å®æµ‹çš„ç»“è®ºï¼šå°±æ˜¯client----nginx----realserver,  clientè‡ªå·±é™é€Ÿ æˆ–è€… nginxé…ç½®serverå—é‡Œé…ç½®äº†limit_rateæ¥é™é€Ÿï¼Œéƒ½æ˜¯é™åˆ¶çš„clientåˆ°nginxä¹‹é—´çš„é€Ÿåº¦ï¼Œè€Œnginxä»realserverä¸Šçš„èµ„æºæ˜¯ä¸é™é€Ÿçš„ï¼›

â€‹		ç„¶ånginxæœ‰ç¼“å­˜åŠŸèƒ½å—ï¼Ÿé»˜è®¤æ˜¯æ²¡æœ‰çš„ï¼Œéœ€è¦é…ç½®å‚è§38ç« ç¬¬ä¸€èŠ‚å†…å®¹ï¼Œclientå†æ¬¡å‘èµ·ä¸‹è½½ï¼ŒåŒæ ·nginxä»£ç†è¦å¾€åç«¯å†æ¬¡é‡æ–°è¯·æ±‚èµ„æºçš„ï¼Œæ—¶é—´éƒ½æ˜¯ä¸€æ ·çš„ã€‚

â‘¢å¦‚æœæ˜¯haproxyï¼Œclient---haproxy----åç«¯æœåŠ¡å™¨ï¼Œclient é™é€Ÿè¯·æ±‚èµ„æºï¼Œhaproxyå’Œåç«¯çš„èµ„æºè¯·æ±‚ä¸€æ ·æ˜¯æ…¢æ…¢ä¸‹è½½çš„ï¼Œä¸ä¼šå…ˆé£é€Ÿä¸‹è½½æ¥ç„¶åæ…¢æ…¢å‘ç»™clientï¼Œè¿™ç‚¹å’Œnginxä¸ä¸€æ ·ã€‚

â‘£æ‰€ä»¥è¡¨ç°å½¢å¼å°±æ˜¯ï¼Œnginxä»£ç†ï¼Œä½ clientå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œç„¶ååœ¨åç«¯ä¸Šçœ‹tcpè¿æ¥ï¼Œå¯èƒ½å°±çœ‹ä¸åˆ°äº†ï¼Œå› ä¸ºå¾ˆå¿«å°±å®Œæˆäº†nginxå’Œåç«¯æœåŠ¡å™¨çš„äº¤äº’äº†ã€‚è€Œhaproxyæ˜¯ä¸€ç›´å¯ä»¥åœ¨åç«¯æœåŠ¡ä¸Šçœ‹åˆ°tcpè¿æ¥çš„ï¼Œå› ä¸ºä»€ä¹ˆæ—¶å€™clientä¸‹å®Œï¼Œä»€ä¹ˆæ—¶å€™haproxyå’Œåç«¯æœåŠ¡å™¨çš„tcpè¿æ¥ä»€ä¹ˆæ—¶å€™æ‰ä¼šæ–­å¼€ã€‚





**ubuntuåŠ ç½‘å¡ï¼Œæ¿€æ´»æ“ä½œ**

<img src="2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808160824442.png" alt="image-20240808160824442" style="zoom:50%;" /> 



![image-20240808160836508](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808160836508.png)





```bash
[root@realserver2 docker]# haproxy -c -f /etc/haproxy/haproxy.cfg
```

![image-20240808181329462](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808181329462.png)





# frontendå’Œbackendåˆ†å¼€æ¥å†™



ä¸šåŠ¡å¤æ‚ï¼Œå¤šå¯¹å¤šå°±éœ€è¦ç”¨frontendå’Œbackendï¼Œç®€å•ä¸€å¯¹ä¸€å°±ç”¨ä¸Šé¢çš„listené…ç½®å—å°±è¡Œäº†



```bash
frontend www.ming.com
    bind 192.168.126.132:80
    use_backend web_servers

backend web_servers
    server web1 192.168.126.133:80
    server web2 192.168.126.134:80

```



![image-20240808183025588](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808183025588.png)

æŠ¥é”™ä¿®æ”¹ğŸ‘‡

![image-20240808183132168](2.Haproxyå®ç°defaults-Listen-frontend-backendä»£ç†é…ç½®.assets/image-20240808183132168.png)











