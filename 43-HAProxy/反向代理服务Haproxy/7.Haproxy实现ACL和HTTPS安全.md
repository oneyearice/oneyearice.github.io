# 7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.md



ACLæ‰æ˜¯HAproxyç›¸å¯¹äºnginxçš„ä¼˜åŠ¿

# ACL

![image-20241205140822420](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205140822420.png)

acl xxx xx xxx xxx #  è¿™äº›å­—æ®µä¸ä¸€å®šéƒ½æœ‰

åŒ¹é…è§„èŒƒï¼šæ¯”å¦‚headé‡Œå¸¦ä»€ä¹ˆå†…å®¹ï¼Œurlå¸¦ä»€ä¹ˆå…³é”®å­—ï¼Œå°¾åŒ…å«ä»€ä¹ˆã€‚

åŒ¹é…æ¨¡å¼ï¼šæ¯”å¦‚ç®€å•çš„åŒºåˆ†å¤§å°å†™

å…·ä½“æ“ä½œç¬¦ï¼šç›¸ç­‰è¿˜æ˜¯ä¸ç­‰

valueï¼šå…·ä½“çš„å€¼

![image-20241205140822421](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205140822421.png)

image_serviceå°±æ˜¯aclçš„name

hdr_domæ˜¯haproxyé‡Œçš„å›ºå®šç”¨æ³•ï¼Œæ˜¯ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶ï¼Œhdr_dom(host)å°±æ˜¯ä¸»æœºå¤´é‡Œhostå­—æ®µé‡Œ  åŒ…å« åé¢çš„value--mg.wang.comçš„æ„æ€ 

-i   å¿½ç•¥å¤§å°å†™



=============================

hostå­—æ®µæ˜¯åœ¨Request Headerså—é‡Œçš„ï¼Œç„¶åæ–°ç‰ˆHTTP/2 /3ä¸å«hostè€Œæ˜¯authorityå­—æ®µã€‚

![image-20241205142450879](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205142450879.png)



![image-20241205142532302](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205142532302.png)



============================



### hdrï¼šæŠ“å–headå¤´é‡Œçš„ä¸œè¥¿

![image-20241205141422393](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205141422393.png)

begå¼€å¤´endç»“å°¾diræ˜¯uriï¼Œrgeæ˜¯æ­£åˆ™ï¼Œsubæ˜¯åŒ…å«å­—ç¬¦ä¸²



<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205143636936.png" alt="image-20241205143636936" style="zoom:50%;" /> 

ğŸ‘‡ hdr_sub(User-Agent) -i curl wget è§£é‡Šï¼›hdr_subå°±çœ‹æ˜¯å¦åŒ…å«å­—ç¬¦ä¸²ï¼Œçœ‹User-Agentå­—æ®µé‡Œçš„æ˜¯å¦æœ‰curl **æˆ–**wget ä¸”ä¸åŒºåˆ†å¤§å°å†™ã€‚

å¦‚æœä½ ç”¨curlå’Œwgetè¯·æ±‚çš„å°±denyæ‰ğŸ‘‡

![image-20241205141627459](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205141627459.png)

ğŸ‘†é¢çš„å‡ ä¸ªéƒ½ä¸€ä¸ªæ„æ€éƒ½æ˜¯www.å¼€å¤´



ä¸Šå›¾çš„hdr_dom(host) å’Œ hdr(host) å¥½åƒæ²¡å•¥åŒºåˆ«å•Šï¼Œéƒ½æ˜¯hdr(headrå—é‡Œçš„)hostå­—æ®µå•Šï¼Œå‰ç½®æ˜¯åŸŸåï¼Œåè€…æ²¡è¯´åŸŸååˆæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Œéƒ½æ˜¯beg æˆ– end xxxä¸ä¸€æ ·ç”¨å•Š

ç„¶å-må†™ä¸å†™éƒ½éƒ½ä¸€æ ·ï¼Œ-må°±æ˜¯-iç±»ä¼¼çš„ï¼Œ-iæ˜¯å¿½ç•¥å¤§å°å†™ï¼Œä¸å†™-må°±æ˜¯ç²¾ç¡®åŒ¹é…ï¼Œå¦‚æœç”¨beg endè¿™ç§å°±éœ€è¦ç”¨-mæ¥é…åˆã€‚



### æŠ“å–éƒ¨åˆ†urlé‡Œçš„ä¸œè¥¿ï¼šbaseçš„ç”¨æ³•

![image-20241205145909128](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205145909128.png)

ğŸ‘†ğŸ‘‡è¿™å·®ä¸å¤šæ˜¯urlåŒ¹é…å°±æ˜¯nginxæ²¡æ³•å®ç°çš„

### æŠ“å–éƒ¨åˆ†urlé‡Œçš„ä¸œè¥¿ï¼špathçš„ç”¨æ³•

![image-20241205150458775](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205150458775.png)

ğŸ‘‡å»æ‰ä¸‹å›¾çš„xx/å°±èƒ½å¤Ÿæ»¡è¶³å‰é¢çš„åŒ¹é…äº†

![image-20241205151335469](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205151335469.png)

ğŸ‘†regå°±æ˜¯regexæ­£åˆ™

path_subæ˜¯å­ä¸²ï¼Œæ‰€è°“å­ä¸²å°±æ˜¯åªè¦åŒ…å«å°±åŒ¹é…åˆ°äº†ã€‚

path_dir jpegså°±æ˜¯å¿…é¡»æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æ–‡ä»¶å¤¹ï¼Œæ¯”å¦‚www.ming.org/xxx/jpegs/xxx   xxxæœ‰æ²¡æœ‰éƒ½å¯ä»¥å’¯ã€‚



### æŠ“å–æ•´ä¸ªurlé‡Œçš„ä¸œè¥¿ï¼šurlçš„ç”¨æ³•

![image-20241205151616332](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205151616332.png)



### æŠ“å–ï¼šæºç›®IPå’Œç«¯å£ã€çŠ¶æ€ç ã€ä»¥åŠmethodä¸ƒå±‚åè®®é‡Œçš„åŠ¨ä½œ(GET/POSTç­‰)ğŸ‚

<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205152403346.png" alt="image-20241205152403346" style="zoom:50%;" /> 



## åŒ¹é…æ¨¡å¼



![image-20241205153003957](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153003957.png)

-uå°±æ˜¯aclä¸èƒ½åŒåï¼Œè¿™ç§å†™æ³•å°±ä¸è¡Œäº†

<img src="7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153042174.png" alt="image-20241205153042174" style="zoom:50%;" />

æœ¬æ¥å¤šä¸ªaclåŒåå°±æ˜¯å¹¶é›†ä¹Ÿå°±æ˜¯æˆ–çš„å…³ç³»ï¼Œsquidé‡Œå°±æ˜¯è¿™ä¹ˆç”¨çš„ã€‚



## æ“ä½œç¬¦



![image-20241205153230045](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153230045.png)





## valueå€¼



![image-20241205153303938](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153303938.png)



## aclç»„åˆ



![image-20241205153429093](7.Haproxyå®ç°ACLå’ŒHTTPSå®‰å…¨.assets/image-20241205153429093.png)





# å®éªŒ



å‡è®¾ ä¸€ä¸ªç½‘ç«™æä¾›æ‰‹æœºç«¯è®¿é—®ï¼Œä¸€ä¸ªç½‘ç«™æä¾›ç”µè„‘ç«¯è®¿é—®





