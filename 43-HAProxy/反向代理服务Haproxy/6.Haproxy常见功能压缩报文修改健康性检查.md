# 6.Haproxy常见功能压缩报文修改健康性检查



# haproxy如何携带用户信息

正常后端服务器看到的IP都是haproxy的IP地址

client IP就是192.168.126.133👇

![image-20240903103325184](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903103325184.png)

后端server看到的就是haproxy中过来的IP地址👇

![image-20240903103334452](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903103334452.png)









## **haproxy透传** 



**1、option forwardfor 实现7层透传**

![image-20240903105522542](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903105522542.png)



一般写到主配置文件的里默认值语块就行了

![image-20240903113519659](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903113519659.png)



请求

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903105539067.png" alt="image-20240903105539067" style="zoom:50%;" />



可见x-forward-for

![image-20240903105749476](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903105749476.png)



后端nginx需要修改log格式才能看到这个参数

![image-20240903112722264](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903112722264.png)

log_format的格式有个规律：就是比如，要抓取抓包里看到的x-forwarded-for字段，写到log里就要

1、http头部标识$http，

2、然后-换成_下划线，

3、全部小写



此时后端就可以看到真实的用户IP了👇

![image-20240903112955717](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903112955717.png)



总结

![image-20240904102918252](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904102918252.png)

需要注意的是，header 大小写，还有减号-，在后端nginx日志里都转成 小写，和下划线。

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904103408040.png" alt="image-20240904103408040" style="zoom:50%;" />

后端nginx日志里转小写和下划线👇

![image-20240904103509338](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904103509338.png)



总结，补充：

![image-20240904105417822](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904105417822.png)



![image-20240904105539496](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904105539496.png)





**2、四层透传-不推荐的方式，其实是mode tcp而不是lvs那种四层透传**

```bash
#haproxy配置：
listen web_http_nodes
	bind 192.168.126.132:80
	mode tcp
	balance roundrobin
    server web1 www.testtttt.com:80 send-proxy check inter 1000 fall 2 rise 10  # 比常规的转发cli多一个send-proxy,会造成大量PROXY TCP4 a.b.c.d a.b.c.d xxxxx 报文 
    

--------------------------------------------

#后端服务器的nginx配置：在访问日志中通过变量$proxy_protocol_addr 记录透传过来的客户端IP
http {
	log_format main '$remote_addr - $remote_user [$time_local] "$request" "$proxy_protocol_addr"'
	server {
		listen 80 proxy_protocol;  # 启动此项，将无法直接访问此网站，只能通过四层代理访问
		server_name www.testtttt.com;
	}
}
```



实操过程处理截图，含故障注意点：

​		就是send-proxy的配置，要么server xxx 都配置上，要么都不配，否则会导致send-proxy配置的那个后端请求失败，可能是初始实验理解不到位，其实就是后端nginx没有配置proxy_protocol。继续往下看就行了。不要太纠结。纠结的话，实验敲一下就行了。

比如错误案例

haproxy的配置👇

![image-20240903162857648](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903162857648.png)

对应的后端126.134的nginx的配置👇

![image-20240903162934576](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903162934576.png)

不过好像无法复现了，现在上面配置也不会报错了，

可以复现，就是上图的listen 80后的proxy_protocol去掉，就能看到了(看到这些大量的haproxy 发过来的PROXY TCP4)，不仅如此，而且此时如果观察log可见，其实也已经可以携带了client IP了。👇只不过，就是页面还不正常。

![image-20240904094250960](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904094250960.png)

同样抓包可见，需要知道的是上图除了192.168.126.1高亮的那一行是HTTP包👇，其他的都是TCP包--这些192.168.126.132频繁发给192.168.126.134的包是没有像下图一样携带什么IP信息来着。

![image-20240904094735994](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904094735994.png)



比较好奇的是continuation关键字

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904095819605.png" alt="image-20240904095819605" style="zoom:50%;" />



然后，再在后端nginx服务，加了proxy_protocol后就不能直接访问了

![image-20240904092706153](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904092706153.png)

只能通过proxy进行访问了，此时页面正常，但是log里就看不到这个真实的IP了，以及的频繁的PROXY TCP4 也看不到了--但是这个频繁的报文只是看不到，其实抓包可见还是一直再发送的

但是log和抓包都看不到continuation这个报文，以及真实的客户端IP也看不到了，不过只需要再来一步

就是log日志里写上$proxy_protocol变量就行了

![image-20240904100219004](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904100219004.png)



![image-20240904100247326](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904100247326.png)

此时log里有了

![image-20240904100235153](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904100235153.png)

抓包依旧没有，抓包看来就是后端nginx配置正确了，抓包反而看不到了，哈哈，应该是有的，否则log里不可能看到。果然，抓包工具显示问题，再敲一下回车就出来了

![image-20240904101839543](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904101839543.png)



但这种方式其实也是2个TCP，haproxy越是说做4层透传，LVS才是。



也可以两个方式都用上，就是mode tcp及支持x-forward-for，也支持proxy_protocol_addr

![image-20240918112307178](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918112307178.png)



![image-20240918112333197](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918112333197.png)





然后去后端nginx配置

![image-20240918112400702](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918112400702.png)



![image-20240918112421413](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918112421413.png)



看看log就两种携带真实客户IP的方式都生效了

![image-20240918112516224](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918112516224.png)







![image-20240903103518611](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903103518611.png)



![image-20240903114342124](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903114342124.png)





# 报文修改



## 理论

代理可以修改的报文一般就是自己发出去的报文，也就是②和④两个包

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918115328273.png" alt="image-20240918115328273" style="zoom:50%;" />

http-request就是②的改包

http-response就是④的改包



![image-20240918115444171](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918115444171.png)



![image-20240918115744923](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918115744923.png)



![image-20240918115844886](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918115844886.png)





![image-20240918115900514](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918115900514.png)



![image-20240918115922390](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918115922390.png)



![image-20240918115948026](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918115948026.png)



**老版本了解下就行：**



![image-20240918133127414](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918133127414.png)





## 实验



1、先看未修改之前的head

![image-20240918154242063](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918154242063.png)

👆大段大段每秒一个的都是健康检测的，而拼手速抓到的就是192.168.126.1 去curl出来的包，这个包是可以看到当前的header有哪些，其中client-real-ip是自定义的x-forward-for👇

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918154706620.png" alt="image-20240918154706620" style="zoom:50%;" />



命令参数配置位置说明：

![image-20240918161348420](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918161348420.png)



PS：√! 和 √的区别，就是能用但是有限制，需要点进去看详情的意思。然后就点进去瞧一瞧

![image-20240918162318894](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918162318894.png)



这段话就不太好看懂，拆分开来意思大概如下：

1、default默认的就是不带名字的，就是http-request这个指令不能配置在匿名的default下

这就是匿名的👇defaults

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918162841766.png" alt="image-20240918162841766" style="zoom:50%;" />



而这是命名的default，既然是命名的就需要调用的

1、命名方法，和调用方法

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918164430430.png" alt="image-20240918164430430" style="zoom:50%;" />



2、所以http-request，如果配置在defaults里，是要用命名的defaults的，

3、而命名的defaults xxx，如何被listen，以及frontend和backend调用

就是用这种方式，或者写在前后端或listen语句块前面就行

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918164736700.png" alt="image-20240918164736700" style="zoom:50%;" />

4、但是这个http-request写到default xxx里，是不能同时被frontend和backend调用的，也就是不能被listen调用。

5、但是http-requst却可以直接写到listen里，好奇怪....不研究了



实验，实验

## 给后端转发的时候添加header字段

### 写到frontend里

![image-20240918170634668](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918170634668.png)

此时后端抓包就能看见了👇

![image-20240918170710009](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918170710009.png)



### 写到backend里

![image-20240918171227295](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918171227295.png)

同样生效

![image-20240918171255289](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918171255289.png)



### 写到listen里

![image-20240918171739826](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918171739826.png)

生效的

![image-20240918171801157](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918171801157.png)





## 给后端转发的时候修改header字段

删除hosts信息，一样不影响转发和用户请求。

![image-20240918172653545](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918172653545.png)



<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918172607220.png" alt="image-20240918172607220" style="zoom:50%;" />



![image-20240918172620239](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918172620239.png)





## 给后端转发的时候删除header字段

![image-20240918174717444](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918174717444.png)



除了真实的用户IP地址信息，其他确实可以删除

![image-20240918174754677](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918174754677.png)

不过删的太多会报错

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918175724536.png" alt="image-20240918175724536" style="zoom:50%;" />





**写到backend里去看看x-forward-for能否被删除**

还是不能删除x-forward-for

![image-20240918175118967](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918175118967.png)



![image-20240918175132594](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918175132594.png)

不过此时用户以及curl报错了

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918175712413.png" alt="image-20240918175712413" style="zoom:50%;" />





说明x-forward-for是送出去的时候打上真实用户IP的动作实在http-request之后的。正要想删这个字段，就别打上就行了，本来默认就不携带，哈哈。





## 给用户回包的时候增删改字段



![image-20240918180006652](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918180006652.png)



比如正常的响应头里会暴露真实的web服务器的信息，如上图的server:nginx/1.26.1

隐藏掉

![image-20240918180302609](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240918180302609.png)









