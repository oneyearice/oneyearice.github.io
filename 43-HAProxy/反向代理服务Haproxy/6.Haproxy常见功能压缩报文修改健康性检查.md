# 6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥



# haproxyå¦‚ä½•æºå¸¦ç”¨æˆ·ä¿¡æ¯

æ­£å¸¸åç«¯æœåŠ¡å™¨çœ‹åˆ°çš„IPéƒ½æ˜¯haproxyçš„IPåœ°å€

client IPå°±æ˜¯192.168.126.133ğŸ‘‡

![image-20240903103325184](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903103325184.png)

åç«¯serverçœ‹åˆ°çš„å°±æ˜¯haproxyä¸­è¿‡æ¥çš„IPåœ°å€ğŸ‘‡

![image-20240903103334452](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903103334452.png)









**haproxyé€ä¼ **



1ã€option forwardfor å®ç°7å±‚é€ä¼ 

![image-20240903105522542](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903105522542.png)



ä¸€èˆ¬å†™åˆ°ä¸»é…ç½®æ–‡ä»¶çš„é‡Œé»˜è®¤å€¼è¯­å—å°±è¡Œäº†

![image-20240903113519659](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903113519659.png)



è¯·æ±‚

<img src="6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903105539067.png" alt="image-20240903105539067" style="zoom:50%;" />



å¯è§x-forward-for

![image-20240903105749476](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903105749476.png)



åç«¯nginxéœ€è¦ä¿®æ”¹logæ ¼å¼æ‰èƒ½çœ‹åˆ°è¿™ä¸ªå‚æ•°

![image-20240903112722264](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903112722264.png)

log_formatçš„æ ¼å¼æœ‰ä¸ªè§„å¾‹ï¼šå°±æ˜¯æ¯”å¦‚ï¼Œè¦æŠ“å–æŠ“åŒ…é‡Œçœ‹åˆ°çš„x-forwarded-forå­—æ®µï¼Œå†™åˆ°logé‡Œå°±è¦

1ã€httpå¤´éƒ¨æ ‡è¯†$httpï¼Œ

2ã€ç„¶å-æ¢æˆ_ä¸‹åˆ’çº¿ï¼Œ

3ã€å…¨éƒ¨å°å†™



æ­¤æ—¶åç«¯å°±å¯ä»¥çœ‹åˆ°çœŸå®çš„ç”¨æˆ·IPäº†ğŸ‘‡

![image-20240903112955717](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903112955717.png)





å››å±‚é€ä¼ 

```bash
#haproxyé…ç½®ï¼š
listen web_http_nodes
	bind 192.168.126.132:80
	mode tcp
	balance roundrobin
    server web1 www.testtttt.com:80 send-proxy check inter 1000 fall 2 rise 10  # æ¯”å¸¸è§„çš„è½¬å‘cliå¤šä¸€ä¸ªsend-proxy,ä¼šé€ æˆå¤§é‡PROXY TCP4 a.b.c.d a.b.c.d xxxxx æŠ¥æ–‡
    
#nginxé…ç½®ï¼šåœ¨è®¿é—®æ—¥å¿—ä¸­é€šè¿‡å˜é‡$proxy_protocol_addr è®°å½•é€ä¼ è¿‡æ¥çš„å®¢æˆ·ç«¯IP
http {
	log_format main '$remote_addr - $remote_user [$time_local] "$request" "$proxy_protocol_addr"'
	server {
		listen 80 proxy_protocol;  # å¯åŠ¨æ­¤é¡¹ï¼Œå°†æ— æ³•ç›´æ¥è®¿é—®æ­¤ç½‘ç«™ï¼Œåªèƒ½é€šè¿‡å››å±‚ä»£ç†è®¿é—®
		server_name www.testtttt.com;
	}
}
```



å®æ“è¿‡ç¨‹å¤„ç†æˆªå›¾ï¼Œå«æ•…éšœæ³¨æ„ç‚¹ï¼šå°±æ˜¯send-proxyè¦ä¹ˆserver xxx éƒ½é…ç½®ä¸Šï¼Œè¦ä¹ˆéƒ½ä¸é…ï¼Œå¦åˆ™ä¼šå¯¼è‡´send-proxyé…ç½®çš„é‚£ä¸ªåç«¯è¯·æ±‚å¤±è´¥

æ¯”å¦‚é”™è¯¯æ¡ˆä¾‹

haproxyçš„é…ç½®ğŸ‘‡

![image-20240903162857648](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903162857648.png)

å¯¹åº”çš„åç«¯126.134çš„nginxçš„é…ç½®ğŸ‘‡

![image-20240903162934576](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903162934576.png)

ä¸è¿‡å¥½åƒæ— æ³•å¤ç°äº†ï¼Œç°åœ¨ä¸Šé¢é…ç½®ä¹Ÿä¸ä¼šæŠ¥é”™äº†











![image-20240903150004217](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903150004217.png)





![image-20240903150042503](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903150042503.png)















![image-20240903103518611](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903103518611.png)



![image-20240903114342124](6.Haproxyå¸¸è§åŠŸèƒ½å‹ç¼©æŠ¥æ–‡ä¿®æ”¹å¥åº·æ€§æ£€æŸ¥.assets/image-20240903114342124.png)

