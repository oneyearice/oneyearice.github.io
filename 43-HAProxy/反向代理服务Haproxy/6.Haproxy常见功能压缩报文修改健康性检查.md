# 6.Haproxy常见功能压缩报文修改健康性检查



# haproxy如何携带用户信息

正常后端服务器看到的IP都是haproxy的IP地址

client IP就是192.168.126.133👇

![image-20240903103325184](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903103325184.png)

后端server看到的就是haproxy中过来的IP地址👇

![image-20240903103334452](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903103334452.png)









## **haproxy透传** 



**1、option forwardfor 实现7层透传**

![image-20240903105522542](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903105522542.png)



一般写到主配置文件的里默认值语块就行了

![image-20240903113519659](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903113519659.png)



请求

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903105539067.png" alt="image-20240903105539067" style="zoom:50%;" />



可见x-forward-for

![image-20240903105749476](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903105749476.png)



后端nginx需要修改log格式才能看到这个参数

![image-20240903112722264](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903112722264.png)

log_format的格式有个规律：就是比如，要抓取抓包里看到的x-forwarded-for字段，写到log里就要

1、http头部标识$http，

2、然后-换成_下划线，

3、全部小写



此时后端就可以看到真实的用户IP了👇

![image-20240903112955717](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903112955717.png)



总结

![image-20240904102918252](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904102918252.png)

需要注意的是，header 大小写，还有减号-，在后端nginx日志里都转成 小写，和下划线。

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904103408040.png" alt="image-20240904103408040" style="zoom:50%;" />

后端nginx日志里转小写和下划线👇

![image-20240904103509338](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904103509338.png)



总结，补充：

![image-20240904105417822](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904105417822.png)



![image-20240904105539496](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904105539496.png)





**2、四层透传-不推荐的方式，其实是mode tcp而不是lvs那种四层透传**

```bash
#haproxy配置：
listen web_http_nodes
	bind 192.168.126.132:80
	mode tcp
	balance roundrobin
    server web1 www.testtttt.com:80 send-proxy check inter 1000 fall 2 rise 10  # 比常规的转发cli多一个send-proxy,会造成大量PROXY TCP4 a.b.c.d a.b.c.d xxxxx 报文 
    

--------------------------------------------

#后端服务器的nginx配置：在访问日志中通过变量$proxy_protocol_addr 记录透传过来的客户端IP
http {
	log_format main '$remote_addr - $remote_user [$time_local] "$request" "$proxy_protocol_addr"'
	server {
		listen 80 proxy_protocol;  # 启动此项，将无法直接访问此网站，只能通过四层代理访问
		server_name www.testtttt.com;
	}
}
```



实操过程处理截图，含故障注意点：

​		就是send-proxy的配置，要么server xxx 都配置上，要么都不配，否则会导致send-proxy配置的那个后端请求失败

比如错误案例

haproxy的配置👇

![image-20240903162857648](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903162857648.png)

对应的后端126.134的nginx的配置👇

![image-20240903162934576](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903162934576.png)

不过好像无法复现了，现在上面配置也不会报错了，

可以复现，就是上图的listen 80后的proxy_protocol去掉，就能看到了(看到这些大量的haproxy 发过来的PROXY TCP4)，不仅如此，而且此时如果观察log可见，其实也已经可以携带了client IP了。👇只不过，就是页面还不正常。

![image-20240904094250960](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904094250960.png)

同样抓包可见，需要知道的是上图除了192.168.126.1高亮的那一行是HTTP包👇，其他的都是TCP包--这些192.168.126.132频繁发给192.168.126.134的包是没有像下图一样携带什么IP信息来着。

![image-20240904094735994](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904094735994.png)



比较好奇的是continuation关键字

<img src="6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904095819605.png" alt="image-20240904095819605" style="zoom:50%;" />



然后，再在后端nginx服务，加了proxy_protocol后就不能直接访问了

![image-20240904092706153](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904092706153.png)

只能通过proxy进行访问了，此时页面正常，但是log里就看不到这个真实的IP了，以及的频繁的PROXY TCP4 也看不到了--但是这个频繁的报文只是看不到，其实抓包可见还是一直再发送的

但是log和抓包都看不到continuation这个报文，以及真实的客户端IP也看不到了，不过只需要再来一步

就是log日志里写上$proxy_protocol变量就行了

![image-20240904100219004](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904100219004.png)



![image-20240904100247326](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904100247326.png)

此时log里有了

![image-20240904100235153](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904100235153.png)

抓包依旧没有，抓包看来就是后端nginx配置正确了，抓包反而看不到了，哈哈，应该是有的，否则log里不可能看到。果然，抓包工具显示问题，再敲一下回车就出来了

![image-20240904101839543](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240904101839543.png)



但这种方式其实也是2个TCP，haproxy越是说做4层透传，LVS才是。









![image-20240903103518611](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903103518611.png)



![image-20240903114342124](6.Haproxy常见功能压缩报文修改健康性检查.assets/image-20240903114342124.png)



