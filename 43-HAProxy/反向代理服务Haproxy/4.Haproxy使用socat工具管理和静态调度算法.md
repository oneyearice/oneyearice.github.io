# 4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.md



# socatå·¥å…·

ç”¨æ¥å‘é€æ¶ˆæ¯ç»™socketæ–‡ä»¶

![image-20240812165740216](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812165740216.png)



![image-20240812165932352](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812165932352.png)

è¿™é‡Œhelpçœ‹åˆ°æ˜¯ä»…ä»…haproxy.sockæ”¯æŒçš„æŒ‡ä»¤ï¼Œä¸æ˜¯æ‰€æœ‰socketæ–‡ä»¶æ”¯æŒè¿™ç§æ–¹å¼ã€‚



![image-20240812170601374](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812170601374.png)



![image-20240812170758118](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812170758118.png)

## é€šè¿‡haproxyçš„socketæŸ¥çœ‹å’Œé…ç½®

```bash
[root@realserver2 conf.d]# echo help | socat stdio /var/lib/haproxy/haproxy.sock
The following commands are valid at this level:
  abort ssl ca-file <cafile>              : abort a transaction for a CA file
  abort ssl cert <certfile>               : abort a transaction for a certificate file
  abort ssl crl-file <crlfile>            : abort a transaction for a CRL file

ã€‚ã€‚ã€‚ ã€‚ã€‚ã€‚

  set severity-output [none|number|string]: set presence of severity level in feedback information

ã€‚ã€‚ã€‚
  show backend                            : list backends in the current running config

```



![image-20240812173242635](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812173242635.png)

### é€šè¿‡è¿™ä¸ªæ¯”å¦‚å¯ä»¥æŸ¥çœ‹è¿æ¥æ•°

1ã€wget --limit-rate é™é€ŸæŸ¥çœ‹é•¿è¿æ¥

![image-20240812175629310](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812175629310.png)

2ã€ab å¹¶å‘æ¥åˆ¶é€ è¿æ¥æ•°

![image-20240812175728541](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812175728541.png)



### **æŸ¥çœ‹åç«¯æœåŠ¡å™¨çš„çŠ¶æ€**

![image-20240812175930865](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812175930865.png)



### æŸ¥çœ‹è°ƒåº¦æƒé‡

![image-20240812180611956](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812180611956.png)

æ³¨æ„ï¼š3(initial 3) å°±æ˜¯ç°åœ¨æ˜¯3ï¼Œæœ€åˆä¹Ÿæ˜¯3çš„æƒé‡ã€‚è¯´æ˜å¯èƒ½ä¼šå˜åŒ–çš„ã€‚æ¯”å¦‚é€šè¿‡socketä¿®æ”¹æ‰ã€‚



```bash
echo "get weight web_servers/web1" |socat stdio /var/lib/haproxy/haproxy.sock

echo "set weight web_servers/web1 10" |socat stdio /var/lib/haproxy/haproxy.sock
```

![image-20240812181039155](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240812181039155.png)

æ­¤æ—¶å°±é€šè¿‡sockä¿®æ”¹äº†è°ƒåº¦çš„æ¯”ä¾‹

æµ‹è¯•å¦‚ä¸‹ï¼Œç¡®å®æ˜¯10æ¯”1çš„è°ƒåº¦ğŸ‘‡

![image-20240813093845349](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813093845349.png)



è¿™ä¸ªhaproxyå°±æ˜¯å¯ä»¥é€šè¿‡sockå»ä¿®æ”¹ï¼Œè€Œä¸ç”¨ä¿®æ”¹é…ç½®æ–‡ä»¶å†reloadï¼Œ

è€Œå®é™…æ“ä½œï¼šreloadä¸ç”Ÿæ•ˆçš„æ—¶å€™ä¹Ÿä¸æŠ¥é”™ï¼Œæ¥ç€restartå°±æŠ¥é”™ï¼›

å¦‚æœé…ç½®æ–‡ä»¶ä¿®æ”¹okï¼Œç›´æ¥reloadå°±å¾ˆnice



### ä¸‹çº¿ä¸Šçº¿ï¼šweight 0 å°±æ˜¯åœæœºç»´æŠ¤äº†

è¿™ç§æ–¹å¼çš„åˆ‡æ¢éƒ½ä¸ä¼šå‡ºç°503æŠ¥é”™

1ã€å¦‚æœæ˜¯åç«¯æœåŠ¡èŠ‚ç‚¹æŒ‚äº†ä¸€ä¸ªï¼Œæ­¤æ—¶å¥åº·æ£€æŸ¥ä¸€èˆ¬è®¾ç½®ä¹Ÿå°±æ˜¯1ç§’ 2æ¬¡ å°±åˆ¤å®šä¸ºæ•…éšœä¹Ÿå·®ä¸å¤šäº†

![image-20240813105828142](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813105828142.png)

![image-20240813105842399](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813105842399.png)

2ã€è€Œç”¨socat ä¼ cliç»™sockçš„æ–¹å¼ï¼Œä¸šåŠ¡åˆ‡æ¢ä¸æ»‘æµç•…

ä¸è¿‡ä¹Ÿå¯¹ï¼Œæ•…éšœæ£€æµ‹æœ¬æ¥å°±æ˜¯æœ‰ä¸€ä¸ªåˆ¤æ–­è¿‡ç¨‹ï¼Œè€Œsocatå±äºå¼ºåˆ¶ä¸‹çº¿åˆ‡æ¢è‡ªç„¶æ— ç¼ã€‚



![image-20240813103052172](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813103052172.png)



![image-20240813103142040](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813103142040.png)



ç„¶åå°†æ‰€æœ‰åç«¯èŠ‚ç‚¹éƒ½è®¾ç½®ä¸º0çš„æƒé‡ï¼Œæ­¤æ—¶å°±ä¼šè°ƒåº¦åˆ°backupèŠ‚ç‚¹äº†



![image-20240813103853756](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813103853756.png)



![image-20240813103935843](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813103935843.png)



è¿™æ˜¯ä¸»é…ç½®æ–‡ä»¶

![image-20240813104012467](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813104012467.png)



è¿™æ˜¯å­é…ç½®æ–‡ä»¶

![image-20240813104045628](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813104045628.png)



è¿™æ˜¯servicesæ–‡ä»¶ï¼Œè¦åˆ©ç”¨èµ·æ¥å­é…ç½®æ–‡ä»¶ï¼Œå°±éœ€è¦å†serviceé‡Œä¿®æ”¹içš„

![image-20240813104124438](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813104124438.png)

ä½†æ˜¯haproxy -c -f è¿™ä¸ªcliåªèƒ½æ£€æŸ¥ä¸»é…ç½®æ–‡ä»¶çš„è¯­æ³•äº†å°±

![image-20240813104210183](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813104210183.png)





**å¤šçº¿ç¨‹haproxyä¸‹socatå‘é€çš„æƒ…å†µ**

â€‹		haproxyæœ¬æ¥æ˜¯å¤šè¿›ç¨‹çš„ä¸åƒç°åœ¨æ˜¯å¤šçº¿ç¨‹çš„ï¼Œæ‰€ä»¥ä»¥å‰å­˜åœ¨è¿™ä¹ˆä¸ªæƒ…å†µï¼š

â€‹		ä¸åŒçš„é“¾æ¥è¯·æ±‚ä¹Ÿæ˜¯è½åœ¨ä¸åŒçš„è¿›ç¨‹ä¸Šçš„ã€‚æ‰€ä»¥socatå‘é€ä¿¡å·å®ç°éœ€æ±‚çš„æ—¶å€™ä¸èƒ½ç›´æ¥ğŸ‘‡è¿™ä¹ˆå‘é€äº†å°±ã€‚

![image-20240822151312971](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822151312971.png)

â€‹		éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œå°†sockå’Œè¿›ç¨‹ç»‘å®šï¼Œæ­¤åsocatå‘ç»™å“ªä¸ªsocketå°±æ˜¯å“ªä¸ªè¿›ç¨‹äº†ã€‚

![image-20240822151458422](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822151458422.png)

â€‹		è€Œç°åœ¨haproxyä¼˜åŒ–ä¸ºå¤šçº¿ç¨‹äº†ï¼Œä¸€ä¸ªsocketå°±æ˜¯å¯¹åº”ä¸€ä¸ªè¿›ç¨‹ï¼Œç„¶åå¤šä¸ªçº¿ç¨‹éƒ½æ˜¯åœ¨è¿™ä¸ªè¿›ç¨‹ä¸‹çš„ï¼Œæ‰€ä»¥ä½ å¾€ä¸€ä¸ªsocketå‘é€å°±èƒ½å‘é€åˆ°å…¨éƒ¨çº¿ç¨‹äº†ã€‚å…¶å®æœ¬è´¨è¿˜æ˜¯ä¸€ä¸ªè¿›ç¨‹ä¸‹çš„æ‰€æœ‰çº¿ç¨‹å…±äº«å†…å­˜ç©ºé—´çš„ã€‚





### é™æ€ç®—æ³•å’ŒåŠ¨æ€ç®—æ³•

é™æ€ç®—æ³•ï¼šä¸å…³å¿ƒåç«¯æœåŠ¡å™¨è´Ÿè½½çŠ¶æ€ï¼Œä»€ä¹ˆè¿æ¥æ•°ï¼Œèµ„æºæ˜¯å¦å¯Œè£•ï¼Œä¸ç®¡ç»Ÿç»Ÿï¼Œå°±å®šæ­»äº†æ€ä¹ˆè°ƒåº¦ï¼›

åŠ¨æ€ç®—æ³•ï¼šä¼šæ ¹æ®åç«¯æœåŠ¡å™¨çš„è´Ÿè½½æƒ…å†µï¼ŒåŠ¨æ€è·³è½¬è°ƒåº¦æœºåˆ¶ã€‚

haproxyé‡Œçš„é™æ€ç®—æ³•æœºåˆ¶ï¼Œä¸æ”¯æŒ ä¸Šé¢æåˆ°çš„echo "get weight web_servers/web1 0" socat stdio /var/lib/haproxy/haproxy.sockè¿™ç§ç”¨æ³•çš„ã€‚ ä¹Ÿä¸æ˜¯ä¸€ç‚¹éƒ½ä¸æ”¯æŒï¼Œå¯ä»¥æ”¹æˆ0ï¼Œå°±æ˜¯ä»…æ”¯æŒä¸Šçº¿ä¸‹çº¿ã€‚



çœ‹æ¥é»˜è®¤å°±æ˜¯åŠ¨æ€ç®—æ³•ï¼Œæ”¯æŒset å…¶ä»–æ•°å€¼ã€‚



cliçš„è¡¥å……ï¼š

![image-20240822154101375](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822154101375.png)



![image-20240822154358516](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822154358516.png)





**å°å®éªŒï¼šä¸Šä¸‹çº¿åç«¯æœåŠ¡å™¨çš„è„šæœ¬**ï¼š

ä¸¤å°åç«¯æœåŠ¡å™¨æ”¹ä¸ºdocker

![image-20240822161236527](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822161236527.png)



![image-20240822161247345](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822161247345.png)



132æœ¬èº«ä¹Ÿæ˜¯haproxyï¼Œç®€å•æ¨¡æ‹Ÿç”¨æˆ·curlä¸‹

![image-20240822161710449](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822161710449.png)



ç®€å•çš„webå‡çº§è„šæœ¬ğŸ‘‡

```bash
#!/bin/bash

WEB_SERVERS="
192.168.126.133
192.168.126.134
"
BACKEND=web_servers
APP=nginx
IMAGE=$APP:latest
DELAY=15

for i in $WEB_SERVERS;do
	echo "set server $BACKEND/$i state maint" |socat stdio /var/lib/haproxy/haproxy.sock
	ssh $i docker rm -f $APP
	ssh $i "echo Docker $i WEBSITE $i v1.0 > /data/www/index.html"
	ssh $i docker run -d -p 80:80 -v /data/www:/usr/share/nginx/html --name $APP $IMAGE
	sleep $DELAY
	echo "set server $BACKEND/$i state ready" |socat stdio /var/lib/haproxy/haproxy.sock
done
```



è¿˜å¾—åšä¸€ä¸‹sshçš„keyç™»å…¥

```bash
ssh-keygen

ssh-copy-id 192.168.126.133

ssh-copy-id 192.168.126.134
```

![image-20240822162115928](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822162115928.png)



![image-20240822162137293](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822162137293.png)



![image-20240822162152405](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822162152405.png)



éªŒè¯keyç™»å…¥

![image-20240822162243420](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822162243420.png)



å†ä¿®æ”¹ä»¥ä¸‹é…ç½®æ–‡ä»¶

![image-20240822173313383](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240822173313383.png)

å°†åç§°æ”¹ä¸ºipï¼Œè¿™æ ·ä¸Šé¢çš„åˆ‡æ¢è„šæœ¬å°±å¯ä»¥ç”¨äº†











# å…³äºå¹³æ»‘å‡çº§

## nginxæœ¬èº«çš„å¹³æ»‘å‡çº§

å…³é”®å­—ï¼š-USE2ï¼Œ-WINCH

å…¶å®å®˜æ–¹æ—©å°±é’ˆå¯¹Nginxå¹³æ»‘å‡çº§åšè¶³äº†åŠŸå¤«ï¼ŒåŸºæœ¬åŸç†å°±æ˜¯ï¼Œå¯åŠ¨æ–°çš„Nginx(master+worker)è¿›ç¨‹ï¼Œä¹‹åç»™æ—§çš„masterè¿›ç¨‹å‘é€-USER2æŒ‡ä»¤ï¼Œè¿™æ ·å°±èƒ½åŒæ—¶è®©æ–°ç‰ˆå’Œæ—§ç‰ˆæœ¬è¿›ç¨‹åŒæ—¶æ¥æ”¶å¤„ç†è¯·æ±‚ã€‚ä¹‹åæˆ‘ä»¬å†å‘é€-WINCHç»™æ—§è¿›ç¨‹ï¼Œè®©å®ƒåœæ­¢å·¥ä½œæœåŠ¡(å…³é—­æ‰€æœ‰æ—§workerè¿›ç¨‹ï¼Œä½†æ˜¯æ—§çš„masterè¿›ç¨‹æ²¡å…³ï¼Œé˜²æ­¢åé¢ä½ é‡åˆ°é—®é¢˜å›æ»š). å¦‚æœç¡®è®¤æ–°Nginxæ²¡é—®é¢˜ï¼Œé‚£ä¹ˆå†æ‰‹åŠ¨Killæ—§çš„masterè¿›ç¨‹å³å¯å®Œæˆå¹³æ»‘å‡çº§.

https://mojun.me/2022/09/20/nginx-reload-in-prod/

https://bbs.huaweicloud.com/forum/thread-0245111487078556005-1-1.html

## å¼€å§‹æµ‹è¯•å®éªŒ



### 1ã€æ¨¡æ‹Ÿç”¨æˆ·é•¿è¿æ¥

![image-20240813141422435](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813141422435.png)

![image-20240813151451546](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813151451546.png)

### **2ã€æŸ¥çœ‹æ—§ç‰ˆæœ¬1.24çš„è¿›ç¨‹ä¿¡æ¯**

![image-20240813142551828](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813142551828.png)

ä¸»è¿›ç¨‹IDæ˜¯1682ï¼Œå­è¿›ç¨‹IDæ˜¯1683å’Œ1684ï¼Œä¸¤ä¸ªå­è¿›ç¨‹ä¹Ÿæ˜¯ä»é…ç½®æ–‡ä»¶é‡Œé‡Œworker_processess auto;æ¥çš„ï¼Œå› ä¸º2æ ¸CPUï¼Œæ‰€ä»¥autoæˆäº†2ä¸ªworkerè¿›ç¨‹ã€‚



æŸ¥çœ‹æ—§ç‰ˆæœ¬çš„ç¼–è¯‘å‚æ•°ï¼Œå½“ç„¶æˆ‘è¿™é‡Œæ˜¯yumçš„ï¼Œä¸è¿‡ä¹Ÿæœ‰ç¼–è¯‘çš„æ®‹ç•™ï¼Œæœ‰ç‚¹å°´å°¬

å¯èƒ½æ˜¯ç”¨çš„yumï¼Œç¼–è¯‘çš„æ²¡ç”¨

![image-20240813144040827](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813144040827.png)

è¿™å°±èƒ½è¯´æ˜æ˜¯ç”¨çš„yumçš„äº†å§ï¼ŒrpmæŸ¥åˆ°è¿™ä¸ªbinæ–‡ä»¶æ˜¯æ¥è‡ªåŒ…çš„ã€‚

è¿™æ®µæ— æ‰€è°“ï¼Œæ˜¯æˆ‘è‡ªå·±çš„ç¯å¢ƒä¸å¹²å‡€å¯¼è‡´çš„ï¼Œä¸è¿‡æŸ¥ç¡®è®¤å°±è¿™ä¹ˆæŸ¥



yumçš„nginxçš„ç¼–è¯‘å‚æ•°å°±å¤šäº†

![image-20240813144232406](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813144232406.png)



### 3ã€äºŒè¿›åˆ¶æ–‡ä»¶å¤‡ä»½

mv nginx nginx.old

![image-20240813150715184](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813150715184.png)

### **4ã€å‡†å¤‡å¥½æ–°ç‰ˆæœ¬**

ç¼–è¯‘å‚æ•°å°±ç”¨å¸¸è§„çš„å°±å¥½ï¼Œå¦‚æœæ˜¯è€çš„nginxæ˜¯ç¼–è¯‘å®‰è£…å°±ç›´æ¥nginx -Vé‚£é‡Œå¤åˆ¶è¿‡æ¥å°±è¡Œäº†ï¼Œyumçš„æ²¡å¿…è¦ï¼Œå°±æ˜¯ç”¨å¸¸è§„çš„å‚æ•°å°±è¡Œã€‚

```bash
cd /tmp/
curl -LO https://nginx.org/download/nginx-1.26.1.tar.gz
tar xvf nginx-1.26.1.tar.gz -C /usr/local/share/
cd /usr/local/share/
ll
cd nginx-1.26.1/

# è¿™é‡Œçš„prefixå¯èƒ½è¦ä¿®æ”¹ï¼Œç¬¬ä¸€æ¬¡æˆ‘æ²¡æ”¹ä¹Ÿæˆäº†å¥‡æ€ªã€‚ã€‚ é‡å¯æœåŠ¡çš„æ—¶å€™ nginxäºŒè¿›åˆ¶é‡Œåªä¼šè®¤/apps/nginxè¿™ä¸ªæ ¹ç›®å½•ï¼Œä¼šæ‰¾ä¸åˆ°å¾ˆå¤šlogå’Œcfgæ–‡ä»¶çš„
./configure --prefix=/apps/nginx \
--user=nginx \
--group=nginx \
--with-http_ssl_module \
--with-http_v2_module \
--with-http_realip_module \
--with-http_stub_status_module \
--with-http_gzip_static_module \
--with-pcre \
--with-stream \
--with-stream_ssl_module \
--with-stream_realip_module


make # make installæ²¡å¿…è¦ï¼Œåªéœ€è¦ä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶
# åªéœ€è¦ä¸€ä¸ªobj/nginx äºŒè¿›åˆ¶æ–‡ä»¶å…¶å®
echo $?

# ä»¥ä¸Šåˆæ­¥å®‰è£…å¥½äº†æ–°ç‰ˆ1.26çš„nginx

```





### 5ã€æ‹·è´æ–°çš„äºŒè¿›åˆ¶nginxï¼Œè¦†ç›–ä¹‹å‰æ—§ç‰ˆæœ¬çš„nginx

ä¹‹å‰å·²ç»å¤‡ä»½äº†ç¬¬ä¸‰æ­¥ï¼Œæ‰€ä»¥ç›´æ¥ç”¨æ–°çš„nginxäºŒè¿›åˆ¶æ”¾åˆ°è€çš„nginxè·¯å¾„ä¸‹ï¼Œè¿™é‡Œç”¨è½¯è¿æ¥

![image-20240813182318231](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813182318231.png)

ä¸Šå›¾å¤‡ä»½äº†è€ç‰ˆæœ¬çš„nginxäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œç„¶åä»ä»…ä»…makeå‡ºæ¥çš„objs/ä¸‹å¤åˆ¶è¿‡å»nginxæ–°ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚



æ­¤æ—¶ç¯å¢ƒå˜é‡å·²ç»okäº†

![image-20240813150844058](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813150844058.png)

å·²ç»æ˜¯æ–°çš„nginxäº†



### 6ã€å‘é€å…³é”®ä¿¡å·-USR2

```bash
kill -USR2 1682  # æ—¢å¯ä»¥å‡çº§ï¼Œä¹Ÿå¯ä»¥é™çº§ï¼Œè¿˜å¯ä»¥åŒçº§åˆ«æ–°å»ºä¸»è¿›ç¨‹

# è¿™æ¡cliæ•²ä¸‹å»ï¼Œä¼šè´Ÿè½½å‡è¡¡åˆ°ä¸¤ä¸ªç‰ˆæœ¬çš„nginxçš„ï¼Œåªä¸è¿‡ç¼–è¯‘çš„äºŒè¿›åˆ¶nginxçš„prefixå°±æ˜¯è®¾ç½®çš„è€ç‰ˆæœ¬çš„nginxçš„ä¸»ç›®å½•ï¼Œæ‰€ä»¥è¿™é‡Œè´Ÿè½½å‡è¡¡çš„æ•ˆæœå°±çœ‹ä¸æ¸…äº†ï¼Œå› ä¸ºé¡µé¢éƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸ç”¨make installçš„åŸå› ï¼Œåªæ˜¯ç”¨äº†äºŒè¿›åˆ¶ï¼Œå¦‚æœæµ‹è¯•å°±è¦çœ‹è´Ÿè½½å‡è¡¡çš„åˆ°ä¸¤ä¸ªç‰ˆæœ¬çš„æ•ˆæœï¼Œå¯ä»¥makeçš„prefixåˆ°åˆ«çš„è·¯å¾„ï¼Œç„¶ååœ¨make installä¸€ä¸‹çœ‹çœ‹ï¼Œæ˜å„¿å¼„å§ã€‚  å¥½åƒä¸æ˜¯ï¼Œé…ç½®æ–‡ä»¶è·¯å¾„ ä¸ä¼šå˜ã€‚ã€‚ã€‚
```

å‘é€kill -USR2 xxx(æ—§ç‰ˆnginxä¸»è¿›ç¨‹)è¿›è¡Œæ›¿æ¢ï¼Œæ­¤æ—¶ä¼šå¤šå‡ºä¸€ä¸ªnginxä¸»è¿›ç¨‹å’Œ2ä¸ªå­è¿›ç¨‹

![image-20240813151228055](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813151228055.png)

è€Œä¸”ä»å›¾ä¸Šçœ‹ï¼Œæ–°çš„nginxé«˜ç‰ˆæœ¬çš„ä¸»è¿›ç¨‹è²Œä¼¼æŒ‚è½½è€ç‰ˆæœ¬å‘¢çš„ä¸»è¿›ç¨‹ä¸‹çš„ã€‚

æ­¤æ—¶ client ç”¨æˆ·çš„ä¸‹è½½é•¿è¿æ¥æ²¡æœ‰æ–­

![image-20240813151510397](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813151510397.png)

ä¸‹è½½è¿›åº¦è¿˜åœ¨

![image-20240813151524800](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813151524800.png)



æµ‹è¯•éƒ½æ˜¯è®¿é—®çš„è€çš„nginxçš„é¡µé¢ï¼Œè‚¯å®šçš„ï¼Œå¯åŠ¨çš„é…ç½®æ–‡ä»¶è·¯å¾„éƒ½æ˜¯è€çš„ï¼Œå†…å®¹ä¹Ÿä¸€æ ·ã€‚

![image-20240813153135276](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813153135276.png)





### 7ã€å‘é€-winchä¿¡å·ï¼Œåœæ­¢æ—§ç‰ˆæœ¬æ¥æ”¶æ–°çš„è¯·æ±‚

ç¡®è®¤å‡çº§æˆåŠŸï¼Œ-WINCH ä¿¡å· åœæ­¢æ—§ç‰ˆmasteræ¥æ”¶æ–°çš„è¯·æ±‚(æ­¤æ—¶æ—§ç‰ˆæœ¬nginx masterè¿›ç¨‹æ²¡æ­»ï¼Œåªæ˜¯åœæ­¢æ¥æ”¶æ–°çš„è¯·æ±‚)

![image-20240813153432028](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240813153432028.png)



### 8ã€å›é€€





### 9ã€quit









- ä¸»è¿›ç¨‹æ”¯æŒçš„ä¿¡å·

| TERM,INT | ç«‹åˆ»é€€å‡º                                                     |
| -------- | ------------------------------------------------------------ |
| QUIT     | ç­‰å¾…å·¥ä½œè¿›ç¨‹ç»“æŸåœ¨é€€å‡º                                       |
| KILL     | å¼ºå­ç»ˆæ­¢è¿›ç¨‹                                                 |
| HUP      | é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨æ–°çš„çš„é…ç½®å¯åŠ¨å·¥ä½œè¿›ç¨‹ï¼Œå¹¶é€æ­¥å…³é—­æ—§è¿›ç¨‹ |
| USR1     | é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶                                             |
| USR2     | å¯åŠ¨æ–°çš„ä¸»è¿›ç¨‹ï¼Œå®ç°çƒ­å‡çº§                                   |
| WINCH    | é€æ­¥å…³é—­å·¥ä½œè¿›ç¨‹                                             |

- å·¥ä½œè¿›ç¨‹æ”¯æŒçš„ä¿¡å·ï¼š

| TERMï¼ŒINT | ç«‹åˆ»é€€å‡º                 |
| --------- | ------------------------ |
| QUIT      | ç­‰å¾…è¯·æ±‚å¤„ç†ç»“æŸåå†é€€å‡º |
| USR1      | é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶         |





### ä¸‹é¢æ˜¯é«˜ç‰ˆæœ¬åšäº†makeinstallçš„å®éªŒ



![image-20240814103727049](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814103727049.png)

è¿™é‡Œæœ‰ä¸ªåä»£çš„ç¼“å­˜å¼€äº†ï¼Œæ‰€ä»¥è¿›ç¨‹åˆ©å„å¤šäº†ä¸¤ä¸ªcacheã€‚



ç„¶åå‡†å¥½å¤‡å¥½make installçš„nginx 1.26.0ç‰ˆæœ¬

![image-20240814103834320](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814103834320.png)



ç„¶åç”¨æˆ·åšä¸€ä¸ªé•¿è¿æ¥ä¹Ÿå°±æ˜¯é™é€Ÿä¸‹è½½ï¼Œå†åšä¸€ä¸ªå¾ªç¯curl

![image-20240814105845123](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814105845123.png)

![image-20240814104210183](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814104210183.png)



æ³¨æ„ç¼–è¯‘çš„æ–°ç‰ˆæœ¬çš„nginxçš„prefixæ˜¯ --prefix=/apps/nginx ï¼Œæ‰€ä»¥ä¸€å®šå’Œç°åœ¨çš„è€ç‰ˆæœ¬çš„nginxçš„å·¥ä½œè·¯å¾„æ˜¯ä¸ä¸€æ ·çš„ï¼Œ

![image-20240814104321291](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814104321291.png)

æ‰€ä»¥é…ç½®æ–‡ä»¶é¦–å½“å…¶å†²çš„ä¸åŒï¼Œäºæ˜¯é¦–é¡µä¹Ÿä¸åŒäº†ï¼Œå€Ÿæ­¤å¯ä»¥è§‚å¯Ÿkill -USR2åçš„æ–°è€ä¸¤ä¸ªç‰ˆæœ¬nginxåŒæ—¶å·¥ä½œçš„æ•ˆæœ--è´Ÿè½½åˆ†æ‹…

ç„¶åï¼š

å¤‡ä»½è€ç‰ˆæœ¬çš„nginxäºŒè¿›åˆ¶

å¤åˆ¶æ–°ç‰ˆæœ¬çš„nginxäºŒè¿›åˆ¶è¿›å»

![image-20240814105826967](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814105826967.png)



åœ¨kill -usr2å‰å…ˆçœ‹ä¸‹è¿›ç¨‹

![image-20240814105914044](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814105914044.png)



![image-20240814105935146](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814105935146.png)

å‘ç° cache loader processæ²¡äº†ï¼Œä¸ç®¡

æ•²å…¥kill -USR2åå‘ç°æ–°ç‰ˆæœ¬çš„ä¸»è¿›ç¨‹æŒ‚è½½äº†è€ç‰ˆæœ¬çš„ä¸»è¿›ç¨‹ä¸‹ğŸ‘‡ä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆé…ç½®æ–‡ä»¶çš„è·¯å¾„æ²¡æœ‰å˜ä¸º/apps/nginxï¼Œ

![image-20240814110405976](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814110405976.png)



æ­¤æ—¶ç”¨æˆ·é‚£è¾¹çœ‹çœ‹

![image-20240814110512597](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814110512597.png)

![image-20240814110523094](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814110523094.png)



è€æ ·å­ï¼Ÿï¼Ÿï¼Ÿæ˜¯å•¥ï¼Œå› ä¸ºç‰ˆæœ¬å‡ä¸Šå»äº†ï¼Œè€Œä¸”é…ç½®æ–‡ä»¶çš„è·¯å¾„è¿˜æ˜¯è€çš„ï¼Œè‡ªç„¶ä¸ä¼šå‡ºç°æœŸå¾…çš„è´Ÿè½½åˆ†æ‹…äº†ã€‚



å†é™çº§é™å›å»

![image-20240814110619760](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814110619760.png)



![image-20240814110700674](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814110700674.png)

å†å‡å›å»

![image-20240814111120048](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814111120048.png)



![image-20240814111153195](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814111153195.png)



![image-20240814111202095](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814111202095.png)

æ­¤æ—¶ åŸæ¥çš„é•¿è¿æ¥çš„ç«¯å£éƒ½æ²¡å˜è¿‡ï¼Œå°±æ˜¯æ²¡æ–­è¿‡äº†



åŠ ä¸Šæ­¤æ—¶é•¿è¿æ¥çš„ç”¨æˆ·å®Œæˆäº†æ•°æ®äº¤äº’ï¼Œè€çš„è¿›ç¨‹å°±ä¼šè‡ªåŠ¨é€€å‡ºäº†

![image-20240814111314421](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814111314421.png)



![image-20240814111356677](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814111356677.png)



![image-20240814112022144](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814112022144.png)

è¿™ä¹ˆçœ‹éš¾é“ç¼–è¯‘çš„nginxäºŒè¿›åˆ¶é‡Œæ˜¯ä¸å¸¦é‚£ä¸ªä»€ä¹ˆprefix=/apps/nginxçš„ï¼Ÿè¿˜æ˜¯è¢«systemctlç»™æ¥ç®¡äº†

![image-20240814112116570](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814112116570.png)

å¯¹çš„ï¼Œå°±æ˜¯è¿™ä¸ªæ„æ€ã€‚å»æ‰-c /etc/nginx/nginx.confï¼Œç”¨è€ç‰ˆæœ¬nginxäºŒè¿›åˆ¶è¿˜èƒ½systemctl restart nginxèµ·å¾—æ¥ï¼Œæ–°ç‰ˆæœ¬å°±èµ·ä¸æ¥äº†ã€‚

![image-20240814113209519](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814113209519.png)



![image-20240814113222892](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814113222892.png)



æ–°ç‰ˆæœ¬çš„nginxå¯åŠ¨åï¼Œé»˜è®¤å°±æ˜¯èµ°çš„/apps/nginxçš„

![image-20240814113348503](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814113348503.png)



![image-20240814113407265](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814113407265.png)



é‡æ–°ç¼–è¯‘ä¸ºè€ç‰ˆæœ¬çš„prefix

![image-20240814113616622](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814113616622.png)

![image-20240814113946380](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814113946380.png)



è¿˜æ˜¯æœ‰ä¸€äº›é—®é¢˜

![image-20240814114220514](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814114220514.png)

ä¸è¿‡æœ‰è¿›ä¸€æ­¥è¿›ç¨‹ï¼Œè¯´æ˜å°±æ˜¯ç¼–è¯‘çš„æ—¶å€™æ²¡æœ‰æŒ‡å¯¹é…ç½®æ–‡ä»¶è·¯å¾„ğŸ‘†ä»”ç»†çœ‹/etc/nginx/conf/nginx.confæ˜¯ä¸å­˜åœ¨ï¼Œ

è™½ç„¶--prefixä¸€æ ·ï¼Œä½†æ˜¯yumçš„nginxçš„cfgæ˜¯åœ¨/etc/nginx/nginx.confæ¯”ä½ ç¼–è¯‘çš„ä¸€å±‚çº§çš„ã€‚

![image-20240814114152576](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814114152576.png)

å†æ¥ï¼Œä¸çƒ¦äº†ï¼Œç›´æ¥å¤åˆ¶

![image-20240814115212825](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814115212825.png)

æŠ¥é”™äº†ç²¾ç®€ä¸‹ï¼ŒæŠŠåé¢çš„--with-cc-opå…¨éƒ¨åˆ æ‰è¯•è¯•

![image-20240814115553281](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814115553281.png)









## æ‰€ä»¥æ€»ç»“ä¸‹

### 1ã€nginxçš„å¹³æ»‘çƒ­å‡çº§æ³¨æ„äº‹é¡¹

â‘ åªéœ€è¦äºŒè¿›åˆ¶nginxæ–‡ä»¶ï¼Œ

â‘¡ç¼–è¯‘çš„æ—¶å€™è¦ç”¨åŸæ¥nginx -Vçœ‹åˆ°çš„å‚æ•°ï¼Œå¯é€‚å½“åˆ å‡ï¼Œæ¯”å¦‚yumçš„nginx -Vé‚£ä¸ªä½ ç¼–è¯‘å¯èƒ½ä¼šå¡å¾ˆä¹…ï¼Œä¸Šå›¾åˆ æ‰æœ€åä¸€å¤§æ®µå•å¼•å·çš„é€‰é¡¹å°±è¡Œäº†ã€‚æµ‹è¯•OKï¼›

â‘¡å¦‚æœåŸæ¥ä¹Ÿæ˜¯ç¼–è¯‘å®‰è£…çš„ï¼Œé‚£ä¹ˆæ­£å¥½ï¼Œå°±ç”¨åŸæ¥çš„-Vçš„ç¼–è¯‘å‚æ•°å…¨ç›˜å¤åˆ¶è¿‡æ¥ã€‚

â‘¡å¦‚æœç¼–è¯‘çš„æ—¶å€™å‚æ•°ä¸åŒï¼Œä¹Ÿä¼šè¢«systemdçš„serviceæ–‡ä»¶æ¥ç®¡ï¼Œ-cå°±ä¼šæ”¹äº†ä½ çš„é…ç½®æ–‡ä»¶ï¼Œæ‰€ä»¥ä¹Ÿä¸ä¼šé‡åˆ°é—®é¢˜

â‘¢å¦‚æœä¸¤ä¸ªæ–°è€ç‰ˆæœ¬éƒ½æ˜¯cliå¯åŠ¨çš„ï¼Œé‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œ-c ä¸æŒ‡å®šï¼Œå°±æ˜¯é»˜è®¤ç¼–è¯‘çš„æ—¶å€™çš„é…ç½®æ–‡ä»¶äº†ï¼Œæ­¤æ—¶å°±ä¼šå¯¼è‡´é—®é¢˜ã€‚

â‘£ä½ è‚¯å®šå¸Œæœ›ç‰ˆæœ¬å‡çº§ï¼Œä¸šåŠ¡æ–‡ä»¶é…ç½®æ–‡ä»¶æ•°æ®æ–‡ä»¶ä¸å˜ï¼Œæ‰€ä»¥å°±æ˜¯è¦ç”¨è€çš„ç‰ˆæœ¬å‘¢çš„ç¼–è¯‘é€‰é¡¹

â‘¤ä½†æ˜¯å¦‚æœä½ å°±æ˜¯è¦ä¸¤ä¸ªç‰ˆæœ¬å‘¢ä¸åŒçš„å·¥ä½œè·¯å¾„ï¼Œåšå‡ºæ¥å¤åˆ¶åˆ†æ‹…çš„æ•ˆæœï¼Œä¸‹åˆç»§ç»­



### è¯•ä¸‹ç”¨cliå¯åŠ¨nginxï¼Œä¸¤ç‰ˆæœ¬ä¸åŒé¡µé¢çš„çƒ­å‡çº§è´Ÿè½½æ•ˆæœ

1ã€å…ˆå¯åŠ¨nginxï¼Œè¿™æ˜¯æ–°ç‰ˆæœ¬äº†

![image-20240814133955488](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814133955488.png)

ç›®å½•åœ¨/apps/nginxä¸‹ï¼Œé¡µé¢å°±æ˜¯

<img src="4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814134033346.png" alt="image-20240814134033346" style="zoom:50%;" /> 



2ã€è¦†ç›–æ‰nginxäºŒè¿›åˆ¶ï¼Œç”¨è€ç‰ˆæœ¬

![image-20240814134248941](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814134248941.png)



æ­¤æ—¶é•¿è¿æ¥æŒ‚èµ·æ¥ï¼Œwhile curlç»§ç»­



![image-20240814134558377](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814134558377.png)

![image-20240814134615882](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814134615882.png)



![image-20240814135156337](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814135156337.png)

åˆå‡ºç°äº†kill ä¸å‡ºæ¥æ•ˆæœäº†

å¥½åƒå¿…é¡»æ˜¯systemctlå¯åŠ¨çš„æ–¹å¼æ‰ä¼šæ¥æ”¶kill -USR2ä¿¡å·



é‚£å°±è¿™æ ·ï¼Œç”¨ä¿®æ”¹åçš„serviceæ–‡ä»¶æ¥å¯åŠ¨å§

![image-20240814141340017](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814141340017.png)

è¿™æ ·å°±æ˜¯nginxäºŒè¿›åˆ¶é‡Œå½“åˆç¼–è¯‘çš„prefixæ˜¯å•¥å°±ç”¨å•¥äº†ï¼Œä¹Ÿèƒ½æ¥æ”¶USR2ä¿¡æ¯äº†

ç„¶åå…³é—­æ‰€æœ‰nginxè¿›ç¨‹ï¼Œå†ç”¨systemctl start nginxå¯åŠ¨ï¼Œ

![image-20240814143000890](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143000890.png)

æ­¤æ—¶æ˜¯nginx 1.24ç‰ˆæœ¬

ä¸‹é¢å‡†å¤‡å¥½1.26ç‰ˆçš„äºŒè¿›åˆ¶ï¼Œ

![image-20240814143052297](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143052297.png)



![image-20240814143211009](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143211009.png)



![image-20240814143411862](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143411862.png)



æ­¤æ—¶ç»ˆäºçœ‹åˆ°äº† æ–° è€  ä¸¤ä¸ª nginxçš„è´Ÿè½½åˆ†æ‹…æ•ˆæœ

<img src="4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143648184.png" alt="image-20240814143648184" style="zoom:50%;" />

æ•´ä½“çœ‹æ¥è¿˜æ˜¯æ–°çš„nginxè¿›ç¨‹å¤šç‚¹



![image-20240814143732908](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143732908.png)

é•¿è¿æ¥ä¹Ÿä¸ä¼šæ–­

![image-20240814143745050](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143745050.png)



ç„¶åå‘é€winchä¿¡å·

![image-20240814143824542](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143824542.png)

ä¸å·¥ä½œçš„workerå­è¿›ç¨‹éƒ½ç›´æ¥å…³é—­ï¼Œè¿˜åœ¨é•¿è¿æ¥çš„å°±shutting down

æ­¤æ—¶ss -nt è§‚å¯Ÿ é•¿è¿æ¥è¿˜æ˜¯ä¸å˜çš„

![image-20240814143908666](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143908666.png)



quitæ•²ä¸€ä¸‹

![image-20240814143949204](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814143949204.png)



å…³é—­clientç«¯çš„é•¿è¿æ¥ï¼Œå°±å½“ä¸‹å®Œäº†å§

![image-20240814144021333](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814144021333.png)



![image-20240814144011297](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814144011297.png)



ç»“æœnginx æ‰€æœ‰è¿›ç¨‹æ²¡äº†ã€‚ã€‚ã€‚å“ˆå“ˆå“ˆï¼Œæƒ¨è´¥~~æ¯æ¬¡éƒ½èƒ½åšå‡ºä¸ä¸€æ ·çš„bugå“¦~

![image-20240814144119648](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814144119648.png)





å†æ¥

![image-20240814144426565](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814144426565.png)



å‘é€USR2åï¼Œä¸¤ä¸ªç‰ˆæœ¬åŒæ—¶å·¥ä½œï¼Œè´Ÿè½½ä¸å‡è¡¡åˆ†æ‹…

åŒæ—¶é•¿è¿æ¥ä¸æ–­ç«¯å£å­©å­å•Š

![image-20240814144614296](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814144614296.png)





<img src="4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814144537486.png" alt="image-20240814144537486" style="zoom:50%;" />





å‘é€WINCHç»™ä¸»è¿›ç¨‹ï¼Œæ­¤æ—¶é•¿è¿æ¥ä¾ç„¶ä¸å˜ï¼Œä½†æ˜¯è¯·æ±‚è°ƒåº¦ä¸åœ¨å‘ç»™è¢«åˆ‡æ¢çš„ç‰ˆæœ¬äº†ï¼Œè¿™é‡Œæ˜¯é™çº§æ“ä½œäº†ã€‚ä»1.26åˆ‡åˆ°1.24çš„ã€‚

![image-20240814144804029](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814144804029.png)



<img src="4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814144846551.png" alt="image-20240814144846551" style="zoom:50%;" />



å…³é—­clientçš„ä¸‹è½½ï¼Œè§‚å¯Ÿnginxè¿›ç¨‹ï¼Œå‘ç°å­˜åœ¨ä¸¤ä¸ªä¸»è¿›ç¨‹ï¼Œ

![image-20240814144954988](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814144954988.png)



å…³é—­è¢«åˆ‡æ¢çš„ä¸»è¿›ç¨‹ï¼Œå¸Œæœ›è¿™ä¸€æ¬¡ä¸ä¼šå…¨éƒ¨å…³æ‰

![image-20240814145043338](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814145043338.png)

å¤±è´¥ã€‚ã€‚ã€‚ã€‚

çœ‹çœ‹å“ªé‡Œå‡ºé—®é¢˜äº†ã€‚



ç”¨äººå®¶æœ¬æ¥çš„ä¹Ÿå°±æ˜¯yumçš„serviceæ–‡ä»¶æ²¡é—®é¢˜

![image-20240814145648731](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814145648731.png)

ç ”ç©¶ä¸‹

1ã€ä¸Šé¢ä¸ºå•¥é‚£ä¹ˆ-QUITå…¨éƒ¨killæ‰äº†

2ã€å¦‚ä½•curlçš„æ—¶å€™çœ‹åˆ°å½“å‰ç‰ˆæœ¬å‘¢ï¼Ÿå°±æ˜¯æµ‹è¯•ä¸ç”¨ä¸åŒå·¥ä½œç›®å½•ï¼Œè€Œæ˜¯ç”¨åŒä¸€ä¸ªserviceé‡Œé¢æŒ‡å®šçš„é…ç½®æ–‡ä»¶å»çœ‹nginxçš„ç‰ˆæœ¬



å…¶å®æˆ‘è¿˜å¯ä»¥è¿™æ ·

å°±æ˜¯ä¸­é—´æ’å…¥ä¸€ä¸ªæ‰‹åŠ¨ä¿®æ”¹serviceæ–‡ä»¶çš„è¿‡ç¨‹







![image-20240814150612488](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814150612488.png)

ä¼°è®¡å°±æ˜¯PIDFileçš„é—®é¢˜

![image-20240814150627496](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814150627496.png)



æ³¨é‡Šæ‰PIDFileå“ªä¸€è¡Œ å†è¯•è¯•

![image-20240814150709628](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814150709628.png)

æœç„¶ğŸ‘†

ä½†æ˜¯ä¸€æ—¦æ²¡æœ‰è¿™ä¸ªPIDFileï¼Œå°±æ²¡æ³•å®ç°å¹³æ»‘åˆ‡æ¢ï¼Œå°±ä¼šæŠ¥é”™ï¼Œå°±æ˜¯QUITå‘è¿‡å»ï¼Œå…¨éƒ¨å°±killäº†ã€‚





è§£å†³1ã€ä¸Šé¢ä¸ºå•¥é‚£ä¹ˆ-QUITå…¨éƒ¨killæ‰äº†è¿™ä¸ªé—®é¢˜

å°±æ˜¯PIDFileä¸¤ä¸ªæ–°è€nginxç‰ˆæœ¬è¦ä¸€ç›´ï¼Œæ‰å¥½USR2å§ï¼Œæˆ‘æ¥è¯•è¯•

å¸Œæœ›è¿™æ˜¯æœ€åä¸€æ¬¡æµ‹è¯•ï¼Œä¸è¿‡æœ€å¼€å§‹çš„å·²ç»å¯ä»¥å®ç°éœ€æ±‚ï¼Œåªä¸è¿‡æ¶‰åŠyumå®‰è£…cliå®‰è£…ï¼Œkill -USR2æ²¡æ•ˆæœï¼Œä¸¤ä¸ªnginxçš„æ ¹ç›®å½•ä»¥åŠé…ç½®æ–‡ä»¶å’Œé¡µé¢ä¸å…±ç”¨çœ‹åˆ°è´Ÿè½½åˆ†æ‹…ï¼Œç­‰ç­‰è¿™äº›é—®é¢˜éƒ½è¦è§£å†³æ‰æŠ˜è…¾äº†è¿™ä¹ˆä¹…ï¼Œå„ä½çœ‹å®˜ ä½ è§‰çš„æˆ‘å¤šæ­¤ä¸€ä¸¾ï¼ŒNONONOï¼Œå„ä½çœ‹å®˜~ ä½ ç»†å¬åˆ†è¯´

æš—æ ï¼š

è¿™æ±Ÿå±±é£é›¨ å²æœˆå±±æ²³

åˆ€å…‰å‰‘å½± ç¾äº†å¤šå°‘ä¸–é—´ä¼ è¯´

ä¸”çœ‹ä»–å£è‹¥æ‚¬æ²³ è¡£ä¸Šæœ‰é£å°˜

å´åŸæ¥æ˜¯ä¸€ä½æ±Ÿæ¹–è¯´ä¹¦äºº

é‚£å¤©å±±å¥³å­ ç‹¬å®ˆæ¯åŸ

ä¹Ÿåªæ˜¯ä¸ºäº†æ›¾ç»çš„é‚£ä¸€ä¸ªäºº



å¥½äº†ï¼Œç»§ç»­ã€‚ã€‚ã€‚





![image-20240814163333384](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814163333384.png)

æ‰¾åˆ°äº†ğŸ‘†



ä¿®æ”¹serviceæ–‡ä»¶

![image-20240814163455646](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814163455646.png)



![image-20240814164144821](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164144821.png)





è¿›å…¥æºç è·¯å¾„ï¼Œmake cleanï¼Œ

![image-20240814163444096](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814163444096.png)



![image-20240814163548372](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814163548372.png)

è¿™æ ·è¿˜æ˜¯æ–°å»ºæ ¹ç›®å½•ï¼Œä½†æ˜¯pidæ–‡ä»¶å’Œè€ç‰ˆæœ¬å…±ç”¨ğŸ‘†

makeä¸€ä¸‹ï¼Œä¸è¦make install

![image-20240814163652839](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814163652839.png)



![image-20240814164103142](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164103142.png)

è¿™æ ·ä¸¤ä¸ªç‰ˆæœ¬çš„nginxäºŒè¿›åˆ¶å°±å‡†å¤‡okäº†ï¼Œ

![image-20240814164237722](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164237722.png)

é•¿é“¾æ¥æŒ‚èµ·æ¥

![image-20240814164257348](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164257348.png)

![image-20240814164327356](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164327356.png)



curl å¾ªç¯èµ·æ¥

![image-20240814164312143](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164312143.png)



æ‰€ä»¥è¿™æ¬¡å®éªŒå°±æ˜¯å…³é”®PIDFile

![image-20240814164457168](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164457168.png)



åˆ‡æ¢nginxäºŒè¿›åˆ¶æ–‡ä»¶

![image-20240814164601607](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164601607.png)



å‘é€USR2

![image-20240814164646813](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164646813.png)



æ­¤æ—¶é•¿è¿æ¥ä¸ä¼šæ–­ï¼Œå¾ªç¯curlå¯è§è´Ÿè½½åˆ†æ‹…

![image-20240814164722745](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164722745.png)



![image-20240814164740859](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164740859.png)

![image-20240814164748782](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814164748782.png)



å‘é€WINCH

![image-20240814165024161](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814165024161.png)

æ˜¯å¾ªç¯curlå°±å·²ç»å…¨éƒ¨è´Ÿè½½åˆ°æ–°çš„nginxç‰ˆæœ¬ä¸Šäº†

![image-20240814165057717](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814165057717.png)

æœ€åä¸€æ­¥ å‘é€QUIT

![image-20240814165204774](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814165204774.png)

å¤±è´¥ã€‚ã€‚ã€‚



æˆ‘è¦ç¦»å¼€åœ°çƒã€‚ã€‚ã€‚ã€‚





æ”¹æˆè¿™æ ·è¯•è¯•

![image-20240814165406330](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814165406330.png)





![image-20240814170618614](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814170618614.png)

å¥‡æ€ªæ²¡æœ‰å»æˆ‘ä»¥ä¸ºçš„åœ°æ–¹ç”ŸæˆPIDæ–‡ä»¶å•Šï¼Œè€Œæ˜¯é…ç½®æ–‡ä»¶æŠ¢å…ˆäº†ã€‚ã€‚ã€‚



å¥½ç»§ç»­ï¼Œè€å­åˆæœ‰ä¿¡å¿ƒäº†



æ³¨é”€ç‚¹/apps/nginx/conf/nginx.confé‡Œçš„pidé‚£è¡Œ

<img src="4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814170733644.png" alt="image-20240814170733644" style="zoom:50%;" />



![image-20240814170846336](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814170846336.png)

å¥½äº†è¿™ä¸‹ æ–°è€nginxçš„pidæ–‡ä»¶ä¸€è‡´äº†



ç¡®è®¤ä¸‹serviceæ–‡ä»¶é…ç½®ï¼Œè¿˜æ˜¯æ”¹æˆè¿™æ ·è¯•è¯•ğŸ‘‡

![image-20240814170950428](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814170950428.png)



![image-20240814171048514](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171048514.png)



å¥½äº†ï¼Œç»§ç»­æµ‹è¯•

é•¿è¿æ¥å’Œcurl

![image-20240814171123183](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171123183.png)

![image-20240814171133942](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171133942.png)



![image-20240814171154188](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171154188.png)



äºŒè¿›åˆ¶æ–‡ä»¶çš„å¤„ç†

![image-20240814171243161](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171243161.png)



USR2å‘é€

![image-20240814171308684](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171308684.png)

é•¿è¿æ¥ä¸æ–­ğŸ‘†ï¼Œè´Ÿè½½åˆ†æ‹…è§‚å¯ŸğŸ‘‡

![image-20240814171323418](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171323418.png)



å‘é€WINCH

![image-20240814171419914](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171419914.png)

curlçš„ä¸åœ¨è´Ÿè½½åˆ°è¢«åˆ‡æ¢ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œä»¥åŠé•¿è¿æ¥ä¸æ–­

![image-20240814171447494](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171447494.png)



å‘é€QUIT



![image-20240814171702320](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171702320.png)



![image-20240814171724230](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171724230.png)



![image-20240814171731684](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814171731684.png)

ç»ˆäºæå®šäº†~åœ°çƒæˆ‘è¿˜æ˜¯å›æ¥å§~~~



å†åˆ‡å›1.26.0å»ï¼ŒåŒç†äº†å°±~~~ï¼Œ

![image-20240814180145671](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814180145671.png)



![image-20240814180156168](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814180156168.png)



![image-20240814180303093](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814180303093.png)



![image-20240814180311363](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814180311363.png)



![image-20240814180317484](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814180317484.png)



![image-20240814180325426](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814180325426.png)



![image-20240814180336832](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814180336832.png)



ä»¥ä¸Šå°±æ˜¯åˆ‡å›1.26çš„æ“¦æ¬§æ€»





æ€»ä¹‹ï¼š

1ã€ç”Ÿäº§ä¸­ï¼Œå°±ä¸è¦è¿™ä¹ˆéº»çƒ¦ï¼Œç›´æ¥

```bash
ç¼–è¯‘çš„æ—¶å€™ å¤åˆ¶è€ç‰ˆæœ¬nginx -Vçš„æ‰€æœ‰å‚æ•°ï¼Œå¯èƒ½è¦ç•¥ä½œåˆ å‡ï¼Œå°±æ˜¯æŠ¥é”™äº†å°±åˆ æ‰æ²¡å¿…è¦çš„ä¸€äº›ï¼Œç‰¹åˆ«æ˜¯è€ç‰ˆæœ¬æ˜¯yumçš„å‚æ•°ä¼šè¿‡å¤š

ç„¶åå¤„ç†äºŒè¿›åˆ¶æ–‡ä»¶

ç„¶åusr2
ç„¶åwinch
æœ€åquit
å°±æå®šäº†

ç”±äºæ–°ç‰ˆæœ¬ç¼–è¯‘ä¹Ÿæ˜¯è€çš„ç¼–è¯‘å‚æ•°ï¼Œæ‰€ä»¥è´Ÿè½½åˆ†æ‹…çœ‹ä¸åˆ°æ•ˆæœï¼Œå…¶å®åªæ˜¯æˆ‘ä¸ä¼šçœ‹ï¼Œè€Œå·²ï¼Œå®é™…å°±æ˜¯usr2å‘è¿‡å»ï¼Œä¸¤ä¸ªç‰ˆæœ¬åŒæ—¶å·¥ä½œï¼Œ
winchå‘è¿‡å»ï¼Œè€ç‰ˆæœ¬nginx ä¸å¤„ç†æ–°çš„è¯·æ±‚ï¼Œ
quitå‘è¿‡å»ï¼Œå¤„ç†å®Œè€ç‰ˆæœ¬çš„è¯·æ±‚è¿æ¥åï¼Œå°±é€€å‡ºäº†ï¼Œå°±å°†æ–°ç‰ˆæœ¬çš„masterè¿›ç¨‹ç‹¬ç«‹å‡ºæ¥äº†ã€‚
```



2ã€æˆ‘åšæˆä¸¤ä¸ªç‰ˆæœ¬ç‹¬ç«‹é…ç½®å°±æ˜¯çœ‹çœ‹è€Œå·²çš„ï¼Œ

æœ¬æ¥ä¸¤ä¸ªç‰ˆæœ¬ç‹¬ç«‹æ˜¯ æœ€åä¸€æ­¥quitå‘è¿‡å»ï¼Œå°±æ‰€æœ‰nginxè¿›ç¨‹éƒ½é€€æ‰äº†ï¼Œ

æ‰€ä»¥æ‰éœ€è¦ä¿®æ”¹serviceæ–‡ä»¶ï¼Œè€Œä¿®æ”¹çš„å…³é”®å°±æ˜¯å»æ‰-c /etc/nginx/nginx.confé…ç½®æ–‡ä»¶ï¼ŒåŒæ—¶å°†æ–°ç‰ˆæœ¬çš„pidfile å’Œ è€ç‰ˆæœ¬çš„pidfile ä¿æŒä¸€è‡´ï¼Œæ‰ä¿è¯æœ€åquitä¿¡å·ä¸ä¼šæ€æ‰æ‰€æœ‰çš„nginxè¿›ç¨‹çš„ã€‚



3ã€ç ”ç©¶ä¸‹å¦‚ä½•å®ç°æ­£å„¿å…«ç»ç”Ÿäº§ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸ä¿®æ”¹serviceç›´æ¥ç¬¬1ç‚¹ä¸­ å¦‚ä½•è§‚å¯Ÿæ–°è€ç‰ˆæœ¬çš„è´Ÿè½½æ•ˆæœ

å¼€å§‹æ“ä½œ

1ã€å½“å‰serviceï¼Œå½“å‰nginxç‰ˆæœ¬å¦‚ä¸‹

![image-20240814181202841](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814181202841.png)



2ã€æµ‹è¯•æ‰‹æ³•

![image-20240814181336681](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814181336681.png)



![image-20240814181413320](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814181413320.png)





é•¿è¿æ¥æŒ‚èµ·æ¥

![image-20240814181540089](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814181540089.png)



![image-20240814181556987](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814181556987.png)





3ã€å¼€å§‹é™çº§ï¼Œå½“ç„¶æ˜¯çƒ­é™çº§



å¤„ç†äºŒè¿›åˆ¶

![image-20240814181645437](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814181645437.png)



![image-20240814182109718](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814182109718.png)

å…¶å®ä¸æ˜¯ä¸Šå›¾è¯´çš„"ä¸çœ‹çœ‹åˆ°1.24.0å‡ºæ¥"ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè§‚å¯Ÿä¹…ä¸€ç‚¹ï¼Œè¿˜æ˜¯å¯ä»¥çœ‹è§çš„

![image-20240814183310579](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814183310579.png)

ä»–æ˜¯ä¸€é˜µå­å…¨éƒ¨è½¬ç»™1.26ï¼Œä¸€é˜µå­å…¨éƒ¨è½¬ç»™1.24ï¼Œè§‚å¯Ÿä¹…ç‚¹å°±çœ‹åˆ°äº†ï¼Œè¯•è¿‡ä¸¤éäº†ï¼Œç¡®å®è¦ç­‰å¾ˆä¹…æ‰ä¼šçœ‹åˆ°è´Ÿè½½åˆ†æ‹…åœ°æ•ˆæœï¼Œè¿™ä¸ªæ¯”ä¸åŒåœ°é¡µé¢æ¥çš„æ…¢å¾ˆå¤šã€‚

![image-20240814182136391](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814182136391.png)



![image-20240814182201055](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814182201055.png)

é•¿è¿æ¥ä¸ä¼šæ–­

![image-20240814182308925](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814182308925.png)





å›é€€æ“ä½œ

ä¸€æ ·å•Šï¼Œå›é€€å°±å½“ä½œé™çº§æ“ä½œï¼Œä¸€æ ·çš„ï¼Œä¸è¿‡å¥½åƒæœ‰HUPçš„æ“ä½œï¼Œä¸ç®¡äº†ã€‚



![image-20240814183752552](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814183752552.png)



é•¿è¿æ¥æŒ‚ç€ï¼Œä»å‡çº§åˆ°å›é€€éƒ½æ²¡æ–­

![image-20240814183828817](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814183828817.png)



æ˜å¤©ç ”ç©¶ä¸‹ å‡çº§ å›é€€ é•¿è¿æ¥å§‹ç»ˆä¸æ–­åœ°æ“ä½œï¼Œä¸Šé¢åªæ˜¯ç ”ç©¶äº† å‡çº§ é™çº§ é•¿è¿æ¥ä¸æ–­åœ°æ“ä½œã€‚



![image-20240814184603342](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814184603342.png)

HUPå¥½åƒåªèƒ½å›æ»š æ–°å¼€åœ°å­masterè¿›ç¨‹ã€‚æ˜å¤©å†å¼„





å›æ»šå¥½åƒåˆå¯ä»¥äº†ï¼Œ

![image-20240814185457185](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814185457185.png)



åˆ†ææ˜¯QUITä»¥åå°±æ— æ³•ä½¿ç”¨HUPå›æ»šäº†

![image-20240814185627767](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814185627767.png)

æœ‰ä¸ªé•¿è¿æ¥æŒ‚ç€ï¼Œæ‰€ä»¥æœ‰ä¸ªshutting downğŸ‘†



ä¸€æ—¦quitäº†ç¡®å®å°±ä¸èƒ½hupå›æ»š

![image-20240814190026131](4.Haproxyä½¿ç”¨socatå·¥å…·ç®¡ç†å’Œé™æ€è°ƒåº¦ç®—æ³•.assets/image-20240814190026131.png)

å°±åªèƒ½ç­‰ç”¨æˆ·é•¿è¿æ¥è‡ªå·±ç»“æŸäº†ï¼Œå†å»åšå¹³æ»‘é™çº§äº†ã€‚

å› ä¸ºquitäº†å°±ä¸ä¼šå†HUPæ‰“å¼€å­wokerè¿›ç¨‹äº†ï¼Œæ²¡æ³•å›é€€äº†ï¼Œåªèƒ½åšå›é™ï¼Œä¸è¿‡å›é™ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´ç”¨æˆ·é•¿è¿æ¥æ–­å•Šï¼Œæ˜å¤©ç»§ç»­





ç»“è®ºï¼šæ‰€ä»¥çƒ­å‡çº§æœ€åä¸€ä¸ªQUITæ˜¯ä¸è¦æ•²åœ°ï¼Œå¯ä»¥ä¿æŒæ—¶åˆ»HUPå›æ»šã€‚

å¦‚æœæ•²äº†HUPï¼Œæ˜¯ä¸æ˜¯å¯ä»¥å†åœ¨å­masterä¸‹æŒ‚masterï¼Ÿè¯•è¯•ï¼Œä¸è¡Œï¼Œä¸èƒ½å¤šå±‚æŒ‚ä¸‹å»ï¼Œ

å°±æ˜¯ä¸€ä¸ªmaseræŒ‚å†æŒ‚ä¸€ä¸ªmasterï¼Œæ‰€ä»¥quitä¸èƒ½ä¹±æ•²ï¼Œè¦ä¿è¯éšæ—¶å¯ä»¥hupå›å»ã€‚













# å·¥ä½œæ¡ˆä¾‹



https://docs.github.com/en/copilot/managing-copilot/managing-github-copilot-in-your-organization/configuring-your-proxy-server-or-firewall-for-copilot

å¼€å‘å†…ç½‘copilotæ”¾è¡Œå’Œè‡ªåŠ¨å…³é—­git pushçš„æªæ–½



















## nginxåç«¯èŠ‚ç‚¹æä¾›æœåŠ¡çš„å¹³æ»‘å‡çº§



## haporxyåç«¯èŠ‚ç‚¹çš„å¹³æ»‘å‡çº§



