# 第1节. 文件查找

## 章节目录

![img](1-文件查找.assets/clip_image002.jpg)

grep是过滤文本的行

cut是过滤文本的列

这里是磁盘上搜索文件

##  locate找文件非常快，依赖于mlocate.db

![img](1-文件查找.assets/clip_image004.jpg)

![img](1-文件查找.assets/clip_image006.jpg)

用updatedb创建/var/lib/mlocate/mlocate.db文件。如果工作中磁盘文件很多，就会占用磁盘IO，瞬间飙高，<font color=red>导致业务被波及</font>。所以需要操作窗口。

 默认模糊搜索

![img](1-文件查找.assets/clip_image008.jpg)

 

![img](1-文件查找.assets/clip_image010.jpg)

👇要updatedb(不能随便用，生产小心)更新一下数据库，就能利用locate查找了

![img](1-文件查找.assets/clip_image012.jpg)

![img](1-文件查找.assets/clip_image014.jpg)

![img](1-文件查找.assets/clip_image015.png)

### locate支持基本正则

![img](1-文件查找.assets/clip_image017.jpg)

![img](1-文件查找.assets/clip_image019.jpg)

👆基本正则还是比较麻烦，上图。

```
[15:27:53 root@localhost ~]#find / -name passwd |grep -Ei "^/[a-z]+/passwd$"
/etc/passwd
/Etc/passwd
/a/passwd
/A/passwd
/Z/passwd
/z/passwd
[15:28:17 root@localhost ~]#find / -name passwd |grep -Ei "^/[A-Z]+/passwd$"
/etc/passwd
/Etc/passwd
/a/passwd
/A/passwd
/Z/passwd
/z/passwd
[15:28:51 root@localhost ~]#find / -name passwd |grep -E "^/[A-Z]+/passwd$"
/A/passwd
/Z/passwd
[15:28:57 root@localhost ~]#find / -name passwd |grep -E "^/[a-z]+/passwd$"
/etc/passwd
/a/passwd
/z/passwd
[15:29:03 root@localhost ~]#find / -name passwd |grep -E "^/[a-Z]+/passwd$"
/etc/passwd
/Etc/passwd
/a/passwd
/A/passwd
/Z/passwd
/z/passwd
[15:29:09 root@localhost ~]#find / -name passwd |grep -E "^/[A-z]+/passwd$"
grep: Invalid range end
[15:29:17 root@localhost ~]#find / -name passwd |grep -E "^/[A-z]+/passwd$"
grep: Invalid range end
[15:29:22 root@localhost ~]#
👆通过上面的实验发现find后面的[A-Z][a-z][a-Z]这样写都有其特定的意义，但是没有[A-z]的写法。这点和通配符不同


[15:37:01 root@localhost ~]#locate -r "^/[a-z]+/passwd$"
[15:37:06 root@localhost ~]#locate -r "^/[A-Z]+/passwd$"
[15:37:10 root@localhost ~]#find / -name passwd |grep -E "^/[a-z]+/passwd$"
/etc/passwd
/a/passwd
/z/passwd
👆可见locate -r只支持正则，所以+这种扩展正则表达式 是不支持的。

[15:38:24 root@localhost ~]#locate -r "^/[A-Z]*/passwd$"
/A/passwd
/Z/passwd
[15:39:57 root@localhost ~]#locate -r "^/[a-Z]*/passwd$"
/A/passwd
/Etc/passwd
/Z/passwd
/a/passwd
/etc/passwd
/z/passwd
[15:40:01 root@localhost ~]#locate -r "^/[[:alnum:]]*/passwd$"
/A/passwd
/Etc/passwd
/Z/passwd
/a/passwd
/etc/passwd
/z/passwd
[15:40:45 root@localhost ~]#find / -name passwd |grep -E "^/[[:alnum:]]+/passwd$"
/etc/passwd
/Etc/passwd
/a/passwd
/A/passwd
/Z/passwd
/z/passwd

```

## find 实时查找，其实也可以利用xargs变得快些，同样占CPU，locate就是在机器上APP服务维护阶段执行updatedb会占CPU

```
[15:36:15 root@pyConsole /]#time `ls --hide=proc | xargs -i -P 0 find /{} -name "*i*"`
-bash: /bin: Is a directory

real    0m1.101s
user    0m1.206s
sys     0m0.336s
[15:36:17 root@pyConsole /]#time `ls --hide=proc | xargs -i -P 0 find /{} -name "*i*"`
-bash: /bin: Is a directory

real    0m1.391s
user    0m1.496s
sys     0m0.356s
[15:36:22 root@pyConsole /]#time `ls --hide=proc | xargs -i -P 0 find /{} -name "*i*"`
-bash: /bin: Is a directory

real    0m1.123s
user    0m1.186s
sys     0m0.363s
[15:36:24 root@pyConsole /]#time `find / -name "*i*"`
find: ‘/proc/4065730’: No such file or directory
find: ‘/proc/4065733’: No such file or directory
-bash: /boot/efi: Is a directory

real    0m1.677s
user    0m1.380s
sys     0m0.396s
[15:36:28 root@pyConsole /]#time `find / -name "*i*"`
-bash: /boot/efi: Is a directory

real    0m1.721s
user    0m1.400s
sys     0m0.399s
[15:36:31 root@pyConsole /]#time `find / -name "*i*"`
-bash: /boot/efi: Is a directory

real    0m1.739s
user    0m1.407s
sys     0m0.404s
[15:36:34 root@pyConsole /]#

```

### locate和find一样存在一些普通用户没有某些文件夹权限，也会搜不到。

![img](1-文件查找.assets/clip_image021.jpg)

![img](1-文件查找.assets/clip_image023.jpg)

find默认就是递归查找，也就是会进到子目录里继续查找。

[处理动作]比较实用，搜出来删除之类。

![img](1-文件查找.assets/clip_image025.jpg)

![img](1-文件查找.assets/clip_image027.jpg)

![img](1-文件查找.assets/clip_image029.jpg)

### find 指定搜索深度

![img](1-文件查找.assets/clip_image031.jpg)

![img](1-文件查找.assets/clip_image033.jpg)

![img](1-文件查找.assets/clip_image034.png)

```
[16:08:08 root@pyConsole /]#find / -name "*i*" -maxdepth 1
find: warning: you have specified the -maxdepth option after a non-option argument -name, but options are not positional (-maxdepth affects tests specified before it as well as those specified after it).  Please specify options before other arguments.

/bin
/sbin
/lib
/lib64
/media
/.bash_history
/switch

```

```
更精准一些的搜索方法
[16:10:06 root@pyConsole /]#find / -name "passwd"
/etc/pam.d/passwd
/etc/passwd
/var/lib/sss/mc/passwd
/usr/bin/passwd
/usr/share/licenses/passwd
/usr/share/doc/passwd
/usr/share/bash-completion/completions/passwd
[16:10:11 root@pyConsole /]#
[16:10:13 root@pyConsole /]#
[16:10:13 root@pyConsole /]#find / -name "passwd" -maxdepth 2
find: warning: you have specified the -maxdepth option after a non-option argument -name, but options are not positional (-maxdepth affects tests specified before it as well as those specified after it).  Please specify options before other arguments.

/etc/passwd
[16:10:18 root@pyConsole /]#find -maxdepth 2 / -name passwd
find: paths must precede expression: /
Usage: find [-H] [-L] [-P] [-Olevel] [-D help|tree|search|stat|rates|opt|exec] [path...] [expression]
[16:10:59 root@pyConsole /]#find / -maxdepth 2 -name passwd
/etc/passwd
[16:11:11 root@pyConsole /]#find / -maxdepth 2 -mindepth 2 -name passwd
/etc/passwd
[16:11:22 root@pyConsole /]#find /  -name passwd
/etc/pam.d/passwd
/etc/passwd
/var/lib/sss/mc/passwd
/usr/bin/passwd
/usr/share/licenses/passwd
/usr/share/doc/passwd
/usr/share/bash-completion/completions/passwd
[16:11:29 root@pyConsole /]#
[16:11:32 root@pyConsole /]#find / -maxdepth 3 -mindepth 3 -name passwd
/etc/pam.d/passwd
/usr/bin/passwd
[16:11:36 root@pyConsole /]#

```

### find -depth选项,这个有什么应用场景？想不出来

![img](1-文件查找.assets/clip_image036.jpg)



![img](1-文件查找.assets/clip_image038.jpg)

![img](1-文件查找.assets/clip_image040.jpg)

默认是先搜索目录本身，再进到每个目录再去搜索。

![img](1-文件查找.assets/clip_image041.png)

现在就是先处理文件，再处理文件夹。应用场景呢？



### find自带的是通配符不是正则

<img src="1-文件查找.assets/clip_image043.jpg" alt="img" style="zoom:50%;" /> 

![img](1-文件查找.assets/clip_image045.jpg)



###  find -iname 不分大小写 

<img src="1-文件查找.assets/clip_image047.jpg" alt="img" style="zoom:50%;" /> 

![img](1-文件查找.assets/clip_image049.jpg)

```
[16:32:18 root@localhost ~]#find / -name etc
/run/initramfs/state/etc
/etc
/usr/share/factory/etc
/usr/local/etc
[16:32:25 root@localhost ~]#find / -iname etc   👈忽略大小写的方法，这也是个总结点，以后用▲来表示总结线索吧，▲忽略大小写2
/run/initramfs/state/etc
/etc
/root/ETc
/usr/share/zoneinfo/Etc
/usr/share/zoneinfo/posix/Etc
/usr/share/zoneinfo/right/Etc
/usr/share/factory/etc
/usr/local/etc
/Etc
[16:32:32 root@localhost ~]#

```

###  find -inum 根据inode编号来搜

<img src="1-文件查找.assets/image-20220207165221450.png" alt="image-20220207165221450" style="zoom:67%;" /> 

```
[16:54:36 root@localhost ~]#find / -inum 70
/sys/kernel/tracing/events/raw_syscalls/sys_exit/filter
/sys/kernel/debug/tracing/events/raw_syscalls/sys_exit/filter
/sys/fs/cgroup/devices/system.slice/sys-kernel-tracing.mount/tasks
/sys/fs/cgroup/memory/system.slice/system-systemd\x2dhibernate\x2dresume.slice/tasks
/sys/fs/cgroup/pids/system.slice/systemd-journald-dev-log.socket/pids.current
/sys/bus/memory/drivers_autoprobe
[16:54:39 root@localhost ~]#
[16:54:41 root@localhost ~]#
[16:54:41 root@localhost ~]#find / -inum 70 -exec  ls -il {} +   👈提前用一下exec看下效果呵呵
70 -rw-r--r--. 1 root root 4096 Feb  7 16:54  /sys/bus/memory/drivers_autoprobe
70 -rw-r--r--. 1 root root    0 Feb  7 16:54  /sys/fs/cgroup/devices/system.slice/sys-kernel-tracing.mount/tasks
70 -rw-r--r--. 1 root root    0 Feb  7 16:54 '/sys/fs/cgroup/memory/system.slice/system-systemd\x2dhibernate\x2dresume.slice/tasks'
70 -r--r--r--. 1 root root    0 Feb  7 16:54  /sys/fs/cgroup/pids/system.slice/systemd-journald-dev-log.socket/pids.current
70 -rw-r--r--. 1 root root    0 Jan 29 09:57  /sys/kernel/debug/tracing/events/raw_syscalls/sys_exit/filter
70 -rw-r--r--. 1 root root    0 Jan 29 09:57  /sys/kernel/tracing/events/raw_syscalls/sys_exit/filter
[16:54:43 root@localhost ~]#
👆节点编号相同也不是同一个文件哈哈。
```

### 搜索inode节点编号，以及搜索inode相同的文件(硬的)



<img src="1-文件查找.assets/clip_image051.jpg" alt="img" style="zoom:67%;" />  



### find 的regex要匹配的是全路径，locate不需要

![img](1-文件查找.assets/clip_image053.jpg)

![img](1-文件查找.assets/clip_image055.jpg)

```
对比实验
17:07:14 root@localhost ~]#ll /usr/share/pixmaps/
total 92
-rw-r--r--. 1 root root  5459 Sep  9 13:25 cockpit.png
-rw-r--r--. 1 root root 13071 Jun 28  2021 fedora-gdm-logo.png
-rw-r--r--. 1 root root 21820 Jun 28  2021 fedora-logo.png
-rw-r--r--. 1 root root 12760 Jun 28  2021 fedora-logo-small.png
-rw-r--r--. 1 root root  6620 Jun 28  2021 fedora-logo-sprite.png
-rw-r--r--. 1 root root  1442 Jun 28  2021 fedora-logo-sprite.svg
-rw-r--r--. 1 root root 14493 Jun 28  2021 system-logo-white.png

👇这是通配符
[17:07:37 root@localhost ~]#find /usr/share/pixmaps -name *png
/usr/share/pixmaps/fedora-gdm-logo.png
/usr/share/pixmaps/fedora-logo-small.png
/usr/share/pixmaps/fedora-logo-sprite.png
/usr/share/pixmaps/fedora-logo.png
/usr/share/pixmaps/system-logo-white.png
/usr/share/pixmaps/cockpit.png


👇这是find里使用正则，注意这里的正则匹配的是全路径
[17:08:21 root@localhost ~]#find /usr/share/pixmaps -regex ".*\.png$"
/usr/share/pixmaps/fedora-gdm-logo.png
/usr/share/pixmaps/fedora-logo-small.png
/usr/share/pixmaps/fedora-logo-sprite.png
/usr/share/pixmaps/fedora-logo.png
/usr/share/pixmaps/system-logo-white.png
/usr/share/pixmaps/cockpit.png
[17:08:30 root@localhost ~]#find /usr/share/pixmaps -regex "\.png$"
[17:08:33 root@localhost ~]#
[17:08:34 root@localhost ~]#

👇这是locate里的正则
[17:09:12 root@localhost ~]#locate -r "/usr/share/pixmaps/.*\.png$"
/usr/share/pixmaps/cockpit.png
/usr/share/pixmaps/fedora-gdm-logo.png
/usr/share/pixmaps/fedora-logo-small.png
/usr/share/pixmaps/fedora-logo-sprite.png
/usr/share/pixmaps/fedora-logo.png
/usr/share/pixmaps/system-logo-white.png
👇当然locate无需全路径
```

![image-20220207171246996](1-文件查找.assets/image-20220207171246996.png) 

### find 选项的PPT总结图

![img](1-文件查找.assets/clip_image057.jpg)

###  虽然这里才些，但是要注意-name 后面要带上双引号的

```
[18:32:04 root@localhost ~]#find -name "f*"
./f2
./data/f2
./data/f1
./f1~
./fz~
./f3
./f1
./f1.link
[18:32:05 root@localhost ~]#find -name f*
find: paths must precede expression: f1~
Usage: find [-H] [-L] [-P] [-Olevel] [-D help|tree|search|stat|rates|opt|exec] [path...] [expression]
[18:32:11 root@localhost ~]#
[18:32:12 root@localhost ~]#
[18:32:12 root@localhost ~]#

```







![img](1-文件查找.assets/clip_image059.jpg)

![img](1-文件查找.assets/clip_image061.jpg)

默认是print，这里换了个动作-ls

 

![img](1-文件查找.assets/clip_image062.png)

![img](1-文件查找.assets/clip_image063.png)

![img](1-文件查找.assets/clip_image065.jpg)

![img](1-文件查找.assets/clip_image067.jpg)

这样-nouser就体现出来了

 

![img](1-文件查找.assets/clip_image069.jpg)

 

![img](1-文件查找.assets/clip_image071.jpg)

 

![img](1-文件查找.assets/clip_image073.jpg)

 

![img](1-文件查找.assets/clip_image075.jpg)

![img](1-文件查找.assets/clip_image077.jpg)

 

 

 

![img](1-文件查找.assets/clip_image079.jpg)

 

![img](1-文件查找.assets/clip_image080.png)

 

![img](1-文件查找.assets/clip_image082.jpg)

![img](1-文件查找.assets/clip_image084.jpg)

 

![img](1-文件查找.assets/clip_image086.jpg)

 

 

![img](1-文件查找.assets/clip_image087.png)

![img](1-文件查找.assets/clip_image088.png)

-a与的运算优先级要比-o或运算高，所以-type f -a -ls先进行运算了。

![img](1-文件查找.assets/clip_image089.png)

![img](1-文件查找.assets/clip_image090.png)

![img](1-文件查找.assets/clip_image092.jpg)

 

![img](1-文件查找.assets/clip_image094.jpg)

![img](1-文件查找.assets/clip_image096.jpg)

如果find 后接 regex就需要是全路径匹配。

![img](1-文件查找.assets/clip_image098.jpg)

 

![img](1-文件查找.assets/clip_image100.jpg)

![img](1-文件查找.assets/clip_image102.jpg)

![img](1-文件查找.assets/clip_image103.png)

 

![img](1-文件查找.assets/clip_image104.png)

用裁剪prune

![img](1-文件查找.assets/clip_image106.jpg)

题外话

![img](1-文件查找.assets/clip_image107.png)

 

![img](1-文件查找.assets/clip_image109.jpg)

![img](1-文件查找.assets/clip_image111.jpg)

![img](1-文件查找.assets/clip_image113.jpg)

![img](1-文件查找.assets/clip_image115.jpg)

![img](1-文件查找.assets/clip_image117.jpg)

写10K，实际上是(9k-10k]

![img](1-文件查找.assets/clip_image119.jpg)

![img](1-文件查找.assets/clip_image121.jpg)

![img](1-文件查找.assets/clip_image122.png)

 

![img](1-文件查找.assets/clip_image124.jpg)

 

![img](1-文件查找.assets/clip_image126.jpg)

![img](1-文件查找.assets/clip_image128.jpg)

 

![img](1-文件查找.assets/clip_image130.jpg)

![img](1-文件查找.assets/clip_image132.jpg)

 

![img](1-文件查找.assets/clip_image134.jpg)

![img](1-文件查找.assets/clip_image136.jpg)

![img](1-文件查找.assets/clip_image138.jpg)

![img](1-文件查找.assets/clip_image140.jpg)

![img](1-文件查找.assets/clip_image142.jpg)

上图错了，/622，不是必须6，而是110里面有一个就行了

![img](1-文件查找.assets/clip_image144.jpg)

![img](1-文件查找.assets/clip_image146.jpg)

![img](1-文件查找.assets/clip_image148.jpg)

![img](1-文件查找.assets/clip_image150.jpg)

 

![img](1-文件查找.assets/clip_image152.jpg)

但是是交互式的。

![img](1-文件查找.assets/clip_image154.jpg)

 

案例，日志处理

![img](1-文件查找.assets/clip_image156.jpg)

找到大于10M的，移动到tmp/下。

![img](1-文件查找.assets/clip_image157.png)

![img](1-文件查找.assets/clip_image158.png)

![img](1-文件查找.assets/clip_image160.jpg)

![img](1-文件查找.assets/clip_image161.png)

![img](1-文件查找.assets/clip_image162.png)

![img](1-文件查找.assets/clip_image164.jpg)

 

![img](1-文件查找.assets/clip_image166.jpg)

 

 
