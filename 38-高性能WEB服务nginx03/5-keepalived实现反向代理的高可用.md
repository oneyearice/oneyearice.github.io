# ç¬¬5èŠ‚. keepalivedå®ç°åå‘ä»£ç†çš„é«˜å¯ç”¨



**nginxçš„é«˜å¯ç”¨æ€ä¹ˆåšï¼Œç”¨keepaliveåšï¼Œkeepaliveçš„è„šæœ¬æ¥æ˜¯æ–°å¯¹nginxçš„HAã€‚**



é€šè¿‡è„šæœ¬ï¼Œç›‘æ§Master/Slaveçš„çŠ¶æ€ï¼Œè¿›ä¸€æ­¥è°ƒæ•´å„è‡ªçš„ä¼˜å…ˆçº§ï¼Œä»è€ŒæŠ¢å VIPï¼Œå®ç°HAçš„æ•…éšœåˆ‡æ¢ï¼Œå¬ç€å°±å’ŒVRRPã€HSRPå·®ä¸å¤šäº†ã€‚ç»“æœkeepaliveçš„é…ç½®æ–‡ä»¶ä¸€çœ‹å…¨TMæ˜¯vrrpï¼Œå“ˆå“ˆå“ˆ~



åé¢è¿˜ä¼šå­¦ä¹ HA Proxy åå‘ä»£ç†è½¯ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼š

â‘ keepavlie + nginx  å®ç° nginxçš„HA

â‘¡keepalive + ha proxy å®ç°ha proxyæœ¬èº«çš„HA

â‘¢å…¶å®è¯´ç™½äº†ä»»ä½•æœåŠ¡ä¹‹é—´éƒ½å¯ä»¥ç”¨keepaliveåšHAäº†ï¼Œä¸è¿‡æœåŠ¡L4å’ŒL7é‡ŒL7å¤§å¤šæ•°ç”¨nginxäº†ã€‚

â‘£æ€»ä¹‹ï¼Œkeepaliveç»å¸¸é…åˆè°ƒåº¦å™¨(nginxã€haproxyã€sqlè¯»å†™åˆ†ç¦»å™¨ä¹Ÿè¡Œå§) ä¸€å—ä½¿ç”¨ã€‚

â‘¤å…¶å®keepaliveé€šè¿‡å®éªŒå°±èƒ½çŸ¥é“ä»–å°±æ˜¯æœºå™¨çº§åˆ«çš„VIPï¼Œå°±æ˜¯ç½‘å·¥çŸ¥é“çš„VRRPã€‚å¯ä»¥è¯´keepaliveåšä¸¤å°æœºå™¨çš„IP HAä¹Ÿå°±æ˜¯VIPï¼Œç„¶ånginxç›‘å¬åœ¨è¿™ä¸ªVIPä¸Šè€Œå·²ã€‚æ˜¯è¿™ä¹ˆä¸ªé€»è¾‘



# æ­å»º

## **1ã€å‡†å¤‡ä¸¤å°webæœåŠ¡å™¨ä¹Ÿå°±æ˜¯realserver**

![image-20240312165900876](5-keepalivedå®ç°åå‘ä»£ç†çš„é«˜å¯ç”¨.assets/image-20240312165900876.png)

![image-20240312165921037](5-keepalivedå®ç°åå‘ä»£ç†çš„é«˜å¯ç”¨.assets/image-20240312165921037.png)



## **2ã€æ­å»ºmaster/slave ä¸¤å°keepalive**

```shell
yum -y install keepalived

è®¡åˆ’è™šæ‹Ÿåœ°å€--VIP  192.168.126.100

vim /etc/keepalived/keepalived.conf

global_defs é‡Œä¿®æ”¹ä¸€ä¸‹
	notification_email {
	    xx@xx.xx	æ”¶ä»¶ç®±
	}
	notification_email_from å‘ä»¶ç®±ï¼Œæˆ–è€…ä»…ä»…,å°±æ˜¯ä¸ªå‘ä»¶åœ°å€ï¼Œé‚®ç®±å…¶å®ä¸å­˜åœ¨ä¹Ÿå¯ä»¥ã€‚ã€‚
	smtp_server 127.0.0.1  æœ¬æœºçš„smtp serverè¦å¯ç”¨å’¯ postfix
	router_id xxx   æ¯ä¸ªæœåŠ¡å™¨èµ·ä¸ªè‡ªå·±çš„åå­—ï¼Œæ¯”å¦‚keep1


ä¸‹é¢vrrp_instance VI_1 è¿™ç§å°±æ˜¯vrrpçš„å®ä¾‹ï¼Œç”¨æ¥å®ç°VIPæµ®åŠ¨IPçš„ã€‚
	virtual_router_id xx   å†™ä¸ªç¼–å·æ¯”å¦‚66ï¼Œæ³¨æ„ä¸¤å°éƒ½å†™66ï¼Œè™šæ‹Ÿæˆä¸€ä¸ªè·¯ç”±å™¨
	prioity ä¸åŠ¨å°±ç”¨é»˜è®¤çš„100
	authentication { 
    		auth_type PASS
    		auth_pass  xxx   å†™ä¸¤å°çš„åå•†å¯†ç ï¼›æ®è¯´å¯†ç å³ä½¿è®¾ç½®äº†ï¼ŒæŠ“åŒ…ä¹Ÿæ˜¯æ˜æ–‡çš„ã€‚æ€€ç–‘~
    	}
	vitual_ipaddress {
		a.b.c.d    vipå’Œç«¯å£ä¹Ÿå¯ä»¥ç›´æ¥å†™æˆğŸ‘‡
		192.168.126.100/24 dev eth0 label eth0:1
	}

å†å¾€ä¸‹å°±æ˜¯virtual_server a.b.c.d 443 {
	è¿™äº›å°±æ˜¯LVSäº†ï¼ŒL4çš„è°ƒåº¦äº†ï¼Œæœ¬æ¬¡å®éªŒåªæ˜¯ç”¨keepaliveåšnginxçš„HAï¼Œæ‰€ä»¥è¿™é‡Œä¸ç®¡äº†åé¢å…¨åˆ æ‰
}



å°†æ­¤é…ç½®æ–‡ä»¶å¤åˆ¶ä¸€ä»½åˆ° å¦ä¸€å° keepaliveæœºå™¨ä¸Šï¼Œå¹¶ç•¥ä½œä¿®æ”¹ğŸ‘‡ï¼›å½“ç„¶ä¸¤å°éœ€è¦åšé˜²ç«å¢™ã€selinux ç¦ç”¨ã€æ—¶é—´åŒæ­¥æ“ä½œ

vim /etc/keepalived/keepalived.conf
   ä¿®æ”¹
   router_id ka2
   
   state BACKUP
   è™šæ‹Ÿè·¯ç”±å™¨idå¿…é¡»ä¸€æ ·çš„
   priority 80   ä¼˜å…ˆçº§å’Œmasterè¦ä¸åŒ
   å…¶ä»–ä¹Ÿéƒ½ä¸€æ ·
 
 åˆ°æ­¤å°±é…ç½®å®Œäº†
 
 systemctl start keepalived   å°±okäº†ï¼Œping VIPå°±é€šäº†ã€‚

```





![image-20240312175842860](5-keepalivedå®ç°åå‘ä»£ç†çš„é«˜å¯ç”¨.assets/image-20240312175842860.png)

å‚è€ƒï¼šhttps://blog.51cto.com/sparkgo/6127764







æ‰€ä»¥keepaliveæ˜¯ç§’çº§çš„HAå’¯ï¼Œå¦‚ä½•åŠ å¿«æ”¶æ•›å‘¢ï¼Ÿäº¤æ¢æœºé‡Œçš„vrrpä¹Ÿæ˜¯ç§’çº§çš„ï¼Ÿä¸è¿‡æœ‰FRRå¥½åƒå¯ä»¥åŠ é€Ÿï¼Œè¯´é”™äº†æ˜¯BFDã€‚

**æ–¹æ³•1ï¼šä¿®æ”¹ç§’ä»£ç ç¼–è¯‘å’¯è¦**

https://blog.csdn.net/hitcompass1/article/details/104054934

![image-20240312182220333](5-keepalivedå®ç°åå‘ä»£ç†çš„é«˜å¯ç”¨.assets/image-20240312182220333.png)



**æ–¹æ³•2ï¼šä½¿ç”¨é«˜ç‰ˆæœ¬çš„vrrpï¼Œä¸æ˜¯keepaliveé«˜ç‰ˆæœ¬æ˜¯å¦æ”¯æŒå˜ç§’**

https://support.huawei.com/enterprise/zh/doc/EDOC1100112421/6e22bde4

![image-20240312181841809](5-keepalivedå®ç°åå‘ä»£ç†çš„é«˜å¯ç”¨.assets/image-20240312181841809.png)



**æ–¹æ³•3ï¼šç”¨BFDè”åŠ¨** 

https://support.huawei.com/enterprise/zh/doc/EDOC1100112421/54b4f71c

![image-20240312182131492](5-keepalivedå®ç°åå‘ä»£ç†çš„é«˜å¯ç”¨.assets/image-20240312182131492.png)



**å…¶å®æ–¹æ³•2 3 éƒ½ä¸æ˜¯keepaliveäº†è€Œæ˜¯ç½‘ç»œè®¾å¤‡çš„vrrpäº†ï¼Œæ‰€ä»¥å¯ä»¥ç”¨ç½‘ç»œè®¾å¤‡æ¥å®ç°åŠ é€Ÿæ”¶æ•›çš„vrrpæ¥æ›¿ä»£keepaliveã€‚è¿™ä¹Ÿæ˜¯ä¸ªæ€è·¯ï¼Œå½“ç„¶å‰ææ˜¯ä½ æœ‰ç°æˆçš„ç½‘ç»œè®¾å¤‡è€Œä¸æ˜¯å¦è´­**



## **3ã€vipæœ‰äº†å°±æ­å»ºnginx**
