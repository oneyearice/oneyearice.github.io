# ç¬¬4èŠ‚. nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£…



# éå¸¸ç»å…¸çš„ä¸€è‡´æ€§hashç®—æ³•

â‘ èƒŒæ™¯é—®é¢˜äº§ç”Ÿçš„åŸå› ï¼šæ¥ä¸Šç¯‡ï¼Œä¸Šç¯‡äº¤ä»£äº†è¯¥ç®—æ³•äº§ç”Ÿçš„èƒŒæ™¯ï¼Œæ˜¯ç¼“å­˜ç©¿é€ã€‚æ‰€ä»¥æ‰æœ‰äº†è¿™ä¹ˆä¸ª   "ä¸€è‡´æ€§hashç®—æ³•"

https://www.xiaolincoding.com/os/8_network_system/hash.html#%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8D%E8%AF%B7%E6%B1%82

å¯ä»¥çœ‹çœ‹è¿™ç¯‡ä»‹ç»ï¼Œåˆ«äººå†™çš„ğŸ‘†

ç®€å•æ€»ç»“ä¸‹

â‘¡ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜(â‘ é‡Œä»‹ç»)ï¼Œäºæ˜¯åšäº†å¦‚ä¸‹ä¼˜åŒ–

```
hash (/a.html) = 128bit % 2^32 = 0 ~ 2^32-1     # ä¸€ä¸ªurlå°±æ˜¯æŸä¸€ä¸ªå€¼ï¼Œæ— æ•°ä¸ªç±»ä¼¼çš„å€¼å°±ç»„æˆäº†ä¸€ä¸ª0~2^32èŒƒå›´çš„åŒºé—´,è¿™åŒºé—´ä»–ä»¬è¯´çœ‹æˆä¸€ä¸ªç¯ï¼Œå¥½ï¼Œå…ˆè¿™ä¹ˆç€ï¼Œä¾ä½ ~ ç¯ä½ å¤§çˆ·ï¼Œä¸ºå•¥ç¯ï¼Ÿå…ˆç†è§£åªæ˜¯ä¸åµï¼Œæˆ‘ä¼°è®¡å°±æ˜¯å–æ¨¡çš„æ•°æ®æ¨¡å‹å¯èƒ½å°±æ˜¯ä¸æ–­çš„å„ç§è¢«é™¤æ•°éƒ½æ˜¯é€ƒä¸å‡ºè¿™ä¸ªä½™æ•°çš„åœˆåœˆå’¯ã€‚

varnish 1 hash(192.168.126.101) % 2^32   # varnishç¼“å­˜çš„ipä¹Ÿä¸€æ ·è½åœ¨ä¸Šé¢çš„0~2^32åŒºé—´é‡Œ
varnish 2    # è¿™ä¸ªèŠ‚ç‚¹æƒé‡æ˜¯2ï¼Œä¹Ÿæ˜¯ç”Ÿæˆ2æ¬¡éšæœºæ•°ğŸ‘‡ï¼Œè¿™ä¸¤ä¸ªéšæœºæ•°ä¹Ÿè½åœ¨åŒºé—´é‡Œçš„2ä¸ªä½ç½®ã€‚
				hash(192.168.126.102 + random_1) % 2^32
				hash(192.168.126.102 + random_2) % 2^32
varnish 3	# è¿™ä¸ªèŠ‚ç‚¹æƒé‡æ˜¯3ï¼Œä¹Ÿæ˜¯ç”Ÿæˆ3æ¬¡éšæœºæ•°ğŸ‘‡ï¼Œè¿™ä¸¤ä¸ªéšæœºæ•°ä¹Ÿè½åœ¨åŒºé—´é‡Œçš„3ä¸ªä½ç½®ã€‚
				hash(192.168.126.103 + random_1) % 2^32
				hash(192.168.126.103 + random_2) % 2^32
				hash(192.168.126.103 + random_3) % 2^32
```

ä¸€å¥è¯æ€»ç»“ï¼šè°ƒåº¦çš„èŠ‚ç‚¹ è½åœ¨ åŒºé—´é‡Œï¼›è¯·æ±‚çš„urlä¹Ÿè½åœ¨åŒºé—´é‡Œã€‚æŠŠåŒºé—´çœ‹æˆæ¢äºæ˜¯å°±æ˜¯è¿™æ ·äº†ğŸ‘‡

å¤§æ¦‚æ„æ€å°±æ˜¯é»‘åœˆæ˜¯urlï¼Œç»¿æ¡†å°±æ˜¯varnishèŠ‚ç‚¹ï¼Œéƒ½æ˜¯é€šè¿‡å“ˆå¸Œå–æ¨¡çš„ç®—æ³•è½è¿›å»çš„ã€‚

![image-20240305093709350](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240305093709350.png)

ç„¶åè°ƒåº¦çš„æ—¶å€™å°±æ˜¯ï¼Œé¡ºæ—¶é’ˆï¼ŒæŸä¸ªé»‘åœˆå°±æ˜¯urlå’¯ï¼Œäºæ˜¯è¿™ä¸ªurlçš„è¯·æ±‚å°±è°ƒåº¦åˆ°é¡ºæ—¶é’ˆæœ€è¿‘çš„ä¸€ä¸ªç»¿æ¡†ä¹Ÿå°±æ˜¯varnishã€‚



â‘¢è™½ç„¶ä¼˜åŒ–ï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼š

è°ƒåº¦ä¸Šå­˜åœ¨ä¸å‡è¡¡çš„æƒ…å†µï¼Œè€Œä¸”æ˜¯ç»å¸¸æ€§çš„ã€‚ç§°ä¹‹ä¸º"å€¾æ–œ"ï¼Œä¸‹å›¾å°±è°ƒåº¦å€¾æ–œçš„å‰å®³å’¯ğŸ‘‡

![image-20240305095803742](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240305095803742.png)

å¥½ï¼Œé—®é¢˜å°±æ˜¯åç«¯5ä¸ªèŠ‚ç‚¹å¦‚ä½•å‡è¡¡è°ƒåº¦å‘¢ï¼Ÿ

è§£å†³æ–¹æ³•å°±æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¤§é‡çš„è™šæ‹ŸèŠ‚ç‚¹å……æ–¥è¿™å“ˆå¸Œç¯ï¼Œäºæ˜¯å°±é”™è½åœ¨äº†urlè½è„šç‚¹å‘¨å›´äº†ï¼Œå°±å‡è¡¡äº†ã€‚

<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240305101415867.png" alt="image-20240305101415867" style="zoom:33%;" />

é‚£å¦‚ä½•ç”Ÿæˆè™šæ‹ŸèŠ‚ç‚¹å‘¢ï¼Œç­”æ¡ˆå°±æ˜¯ åˆ©ç”¨æƒé‡

```
varnish 1 hash(192.168.126.101) % 2^32   # varnishç¼“å­˜çš„ipä¹Ÿä¸€æ ·è½åœ¨ä¸Šé¢çš„0~2^32åŒºé—´é‡Œ
varnish 2    # è¿™ä¸ªèŠ‚ç‚¹æƒé‡æ˜¯2ï¼Œä¹Ÿæ˜¯ç”Ÿæˆ2æ¬¡éšæœºæ•°ğŸ‘‡ï¼Œè¿™ä¸¤ä¸ªéšæœºæ•°ä¹Ÿè½åœ¨åŒºé—´é‡Œçš„2ä¸ªä½ç½®ã€‚
				hash(192.168.126.102 + random_1) % 2^32
				hash(192.168.126.102 + random_2) % 2^32
varnish 3	# è¿™ä¸ªèŠ‚ç‚¹æƒé‡æ˜¯3ï¼Œä¹Ÿæ˜¯ç”Ÿæˆ3æ¬¡éšæœºæ•°ğŸ‘‡ï¼Œè¿™ä¸¤ä¸ªéšæœºæ•°ä¹Ÿè½åœ¨åŒºé—´é‡Œçš„3ä¸ªä½ç½®ã€‚
				hash(192.168.126.103 + random_1) % 2^32
				hash(192.168.126.103 + random_2) % 2^32
				hash(192.168.126.103 + random_3) % 2^32

æœ¬æ¥ 1 2 3 å°±æ˜¯æƒé‡ï¼Œå°±æ˜¯ç”Ÿæˆå‡ ä¸ªè½è„šç‚¹ï¼Œç°åœ¨æ”¹æˆ1000 2000 3000ï¼Œè¿™æ ·æƒé‡çš„è°ƒåº¦æ¯”ä¾‹è¿˜æ˜¯1ï¼š2ï¼š3æ²¡å˜ï¼Œå°±æ˜¯3ä¸ªvarnishç¼“å­˜èŠ‚ç‚¹çš„è°ƒåº¦æ¯”é‡ä¸å˜ï¼Œä½†æ˜¯1000 2000 3000ï¼Œå°±æ˜¯åˆ†åˆ«ä¼šæœ‰1000ä¸ªéšæœºæ•°æ¥ç”Ÿæˆ1000ä¸ªå“ˆå¸Œç¯ä¸Šçš„è½è„šç‚¹ã€‚
hash(192.168.126.102 + random_1) % 2^32
hash(192.168.126.102 + random_2) % 2^32
... ...
hash(192.168.126.102 + random_1000) % 2^32

è¿™æ ·å°±å®ç°äº†è™šæ‹ŸèŠ‚ç‚¹ã€‚1000ä¸ªè½è„šç‚¹ï¼Œå…¶å®éƒ½æ˜¯varnishçš„èŠ‚ç‚¹æ˜ å°„ã€‚
```



<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307100713570.png" alt="image-20240307100713570" style="zoom:50%;" />



<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307100717370.png" alt="image-20240307100717370" style="zoom:50%;" />





è®²äº†è¿™ä¹ˆå¤šï¼Œå®ç°èµ·æ¥ï¼Œä¸€ä¸ªå•è¯consistentå°±æå®šäº†ã€‚

```shell
hash $request_uri consistent;  
```



å¯¹æ¯”ä¸‹lvsçš„è°ƒåº¦ç®—æ³•ï¼š

é™æ€å’ŒåŠ¨æ€

é™æ€4ç§ï¼Œrrï¼Œwrï¼Œshï¼Œdh

![image-20240307115633000](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307115633000.png)

![image-20240307115640506](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307115640506.png)

é™æ€çš„4ç§ï¼Œnginxéƒ½æ˜¯æ”¯æŒçš„ï¼Œwrré»˜è®¤çš„ä¹Ÿå¯ä»¥å†™æƒé‡ä¹Ÿå°±æ˜¯ç­‰ä»·äºLVSçš„RRå’ŒWRR

ç„¶ånginxçš„hash å†™å˜é‡ hash $remote_addr; ip_hashå°±æ˜¯SHï¼Œhash $requst_uri;å°±æ˜¯ç›®æ ‡åœ°å€ä¸è¿‡æ˜¯urläº†ä¸æ˜¯DHï¼Œä¸è¿‡æ„æ€æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åŸºäºç›®æ ‡è°ƒåº¦--å°±æ˜¯ä»€ä¹ˆç›®æ ‡è°ƒåº¦åˆ°ä»€ä¹ˆæœºå™¨ä¸Šã€‚



6ç§åŠ¨æ€ï¼šLCã€

æœ€å°‘è¿æ¥LCï¼Œè¿™ä¸ªnginxä¹Ÿæœ‰ leat_connï¼Œè€Œä¸”nginxåŠ ä¸ªweightå€¼ä¹Ÿå°±æ˜¯wlcäº†ã€‚

![image-20240307132331915](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307132331915.png)



æœ€å°‘åŠ æƒè¿æ¥WLCï¼Œä¸Šä¸€è¡Œå·²ç»è¯´è¿‡äº†ï¼Œnginxä¹Ÿæ˜¯æœ‰çš„



![image-20240307133514639](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307133514639.png)



ä»¥åŠéƒ½æ˜¯åŸºäºè¿æ¥æ•°å’Œè´Ÿè½½çš„ä¸€ä¸ªè°ƒåº¦ï¼Œä¸è¿‡LVSéƒ½æ˜¯åŸºäºå››å±‚çš„ï¼Œå¹¶ä¸æ¶‰åŠåº”ç”¨å±‚ï¼Œè€Œnginxå¯ä»¥ã€‚

â€‹     <img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307133108326.png" alt="image-20240307133108326" style="zoom:40%;" /> 

â€‹      <img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307133350615.png" alt="image-20240307133350615" style="zoom:40%;" />

 

![image-20240307133443146](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307133443146.png) 







# nginxåšå››å±‚è°ƒåº¦

ä¹‹å‰httpåº”ç”¨å±‚è°ƒåº¦ç”¨çš„æ˜¯ngx_http_upstream-moduleï¼Œç°åœ¨åšL4çš„è°ƒåº¦ï¼Œç”¨çš„æ˜¯ngx_stream_core_moduleæ¨¡å—ã€‚





ä¸€äº›ç‰ˆæœ¬éœ€è¦yum -y install nginx-mod-stream æ¥æ‰‹åŠ¨å®‰è£…streamæ¨¡å—ï¼Œå½“ç„¶ä¸€èˆ¬æƒ…å†µ/etc/nginx/nginx.confä¸»é…ç½®æ–‡ä»¶é‡Œæ˜¯åŒ…å«äº†è¿™ä¸ªæ¨¡å—çš„

<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311193546708.png" alt="image-20240311193546708" style="zoom:33%;" />





æ‰€ä»¥httpçš„åä»£-è°ƒåº¦æ˜¯å†™åœ¨httpè¯­å¥å—ä¸‹çš„ï¼Œ

è€Œï¼ŒL4çš„åä»£-è°ƒåº¦æ˜¯å†™åœ¨streamè¯­å¥å—ä¸‹çš„



![image-20240307152126668](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307152126668.png)

1.9æ‰å¼€å§‹æ”¯æŒL4çš„åä»£

![image-20240307152152554](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307152152554.png)





![image-20240307152827346](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307152827346.png)



ç‚¹å‡»å»

![image-20240307152929978](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307152929978.png)





å°±æ˜¯2015å¹´4æœˆ29 å¼€å§‹æ”¯æŒçš„å’¯





## å¼€å§‹å®éªŒ-tcpä»£ç†db



**1ã€æä¸¤ä¸ª mysqlåšrealserver**



åˆ›å»ºæ•°æ®åº“ä¾¿äºnginxåä»£è°ƒåº¦å clientæµ‹è¯• çŸ¥é“è¿çš„å“ªä¸ªrealserverã€‚

![image-20240307155751801](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307155751801.png)



![image-20240307154530057](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307154530057.png)

<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307155653156.png" alt="image-20240307155653156" style="zoom: 33%;" />





**2ã€nginxåä»£é…ç½®åŸºäºtcpåè®®ä¹Ÿå°±æ˜¯L4çš„è°ƒåº¦**

![image-20240307162412732](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307162412732.png)

streamè¯­å¥å—æ˜¯å†™åœ¨mainä¸‹çš„ï¼Œä¹Ÿå°±æ˜¯å’Œhttp



å°±å†™åˆ°ä¸»é…æŒ‡æ–‡ä»¶é‡Œï¼Œæ”¾åˆ°æœ€ä¸‹é¢ï¼Œå’Œhttpå¹³çº§ï¼Œè‡ªç„¶å°±æ˜¯mainå±‚çº§äº†ã€‚

![image-20240307164636635](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307164636635.png)

é‡å¯nginxå°±ä¼šçœ‹åˆ°æœ¬åœ°å°±ä¼šç›‘å¬3306ï¼Œè¿™æ ·æ‰èƒ½åä»£å“¦

è¿™é‡Œä¹Ÿå¯ä»¥å†™æˆ0.0.0.0:3306

![image-20240307164917175](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307164917175.png)

é¡ºæ‰‹æµ‹ä¸‹ç«¯å£è¿é€šOKçš„ğŸ‘‡

![image-20240307164954278](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307164954278.png)



è¿™å°±å¥½äº†ï¼Œclientæµ‹è¯•

![image-20240307165952532](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307165952532.png)

å‘ç°è°ƒåº¦åˆ°äº†132è¿™ä¸ªDBä¸Šäº†

å¤šè¯•å‡ æ¬¡ä¹Ÿä¼šè°ƒåº¦åˆ°133ï¼Œå› ä¸ºæ˜¯least_connï¼Œå°±ä¸¤å°realserveréƒ½æ²¡æœ‰è¿æ¥çš„ã€‚

![image-20240307170040323](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307170040323.png)



è¯•è¯•æƒé‡

![image-20240307171001677](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307171001677.png)

æµ‹è¯•OKğŸ‘‡

![image-20240307170939556](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307170939556.png)





## å¼€å§‹å®éªŒ-tcpä»£ç†redis



**1ã€å®‰è£…redisï¼Œå¹¶ä¿®æ”¹ç›‘å¬æ‰€æœ‰ç«¯å£**

è¿™é‡Œç®€å•ç”¨ä¸‹redisï¼Œåé¢å•ç‹¬å¼€ç« èŠ‚

åœ¨åç«¯realserverï¼Œä¸¤å° ä¸Šéƒ½å®‰è£…redisï¼Œå½“ç„¶å¾—æœ‰epelæºã€‚

```
yum -y install redis
```

ä»¥å‰çœ‹åˆ°yum redisä¼šæœ‰ä¾èµ–åŒ…ï¼Œç°åœ¨çœ‹ä¸åˆ°äº†

![image-20240308152903495](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308152903495.png)

![image-20240308152749491](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308152749491.png)







![image-20240308145330202](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308145330202.png)

ä¿®æ”¹é…ç½®æ–‡ä»¶ç›‘å¬æ‰€æœ‰ç«¯å£ï¼ŒğŸ‘‡åˆ æ‰ä¹Ÿä¸€æ ·çš„æ•ˆæœ

![image-20240308145500370](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308145500370.png)

![image-20240308145545096](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308145545096.png)



redisé›†ç¾¤æ­å»ºåé¢å†å¼„ã€‚



**æµ‹è¯•ä¸‹ï¼Œæœ¬åœ°æµ‹è¯•å°±è¡Œ**
![image-20240308150103650](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150103650.png)

å¯ä»¥çœ‹åˆ°redis clié‡Œè‡ªå¸¦å¸®åŠ©ä¿¡æ¯çš„ã€‚

æœ€ç®€å•çš„å°±æ˜¯è®¾ç½®key valueï¼Œé”®å€¼å¯¹ã€‚

å†™ï¼Œè¯»ğŸ‘‡

![image-20240308150311795](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150311795.png)

è¿™æ˜¯134çš„ä¸€ä¸ªredisçš„é”®å€¼å¯¹ğŸ‘†ï¼Œ

å†è®¾ç½®133çš„redisé‡Œçš„ä¸€ä¸ªkey valueï¼ŒåŒºåˆ†å¼€æ¥æ–¹ä¾¿æµ‹è¯•æ•ˆæœ

å‘ç°é»˜è®¤è¦æœ¬åœ°é…ç½®ï¼Œè¿œç«¯é»˜è®¤è¿˜ä¸è¡Œ

![image-20240308150602510](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150602510.png)

æ”¹æœ¬åœ°é…ç½®ğŸ‘‡

![image-20240308150529912](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150529912.png)



æˆ–è€…å–æ¶ˆproctected mode

![image-20240308150752029](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150752029.png)

![image-20240308150821575](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150821575.png)

ä¸Šå›¾å–æ¶ˆè‚¯å®šä¸å®‰å…¨å’¯ï¼Œæ¨èå»é…ç½®æ–‡ä»¶é‡Œå†™æ˜bind ipå°±è¡Œäº†--å°±æ˜¯ç›‘å¬è‡ªå·±çš„IPå°±è¡Œäº†ã€‚![image-20240308153519706](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308153519706.png)





**3ã€é…ç½®nginx åä»£ åˆ°rediså»**
![image-20240308151337392](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308151337392.png)



![image-20240308151646616](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308151646616.png)

ä½†æ˜¯å‘ç°é»˜è®¤è¯´å¥½çš„1:1çš„è°ƒåº¦ï¼Œé»˜è®¤æƒé‡=1å˜›ã€‚ä½†æ˜¯æ²¡æœ‰çœ‹åˆ°134çš„redisçš„key valueå‡ºç°

è°ƒæ•´è°ƒåº¦æµ‹è¯•ä¸‹ğŸ‘‡

![image-20240308151853583](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308151853583.png)

ç»§ç»­è§‚å¯Ÿ

![image-20240308152502723](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308152502723.png)

![image-20240308152448984](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308152448984.png)

ğŸ‘†è¯´å¥½çš„1:3ä¹Ÿæ²¡çœ‹åˆ°ã€‚



è¦exité€€å‡ºæµ‹è¯•æ‰èƒ½çœ‹åˆ°è°ƒåº¦æ•ˆæœï¼Œç»§ç»­æµ‹è¯•

è°ƒåº¦ä¹Ÿä¸æ˜¯ç«‹é©¬ç”Ÿæ•ˆçš„å¥½åƒ

<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308153800514.png" alt="image-20240308153800514" style="zoom:44%;" />



è¦é€€å‡ºæ‰èƒ½çœ‹åˆ°1:3æƒé‡æ•ˆæœ

<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308154036850.png" alt="image-20240308154036850" style="zoom:44%;" />





<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308154426204.png" alt="image-20240308154426204" style="zoom:44%;" />



ç„¶åredisæ˜¯æ¯”member cacheå¼ºï¼ŒMemcacheæ˜¯åŸºäºå†…å­˜çš„ï¼Œredisæ˜¯å¯ä»¥å†…å­˜ä¹Ÿå¯ä»¥æ”¾åˆ°ç£ç›˜ä¸Šã€‚



æ³¨æ„ä¹Ÿå¯ä»¥ç”¨UDPã€‚

![image-20240308160650936](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308160650936.png)



<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308160858732.png" alt="image-20240308160858732" style="zoom:40%;" />

è¶…æ—¶é—´ä¹Ÿå…³æ³¨ä¸‹



<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308161820725.png" alt="image-20240308161820725" style="zoom:40%;" />

consistentå°±æ˜¯å‰æ–‡è®²çš„å“ˆå¸Œä¸€è‡´æ€§ç®—æ³•ï¼Œä¸è¿‡è¿™é‡Œæ˜¯é’ˆå¯¹çš„æºIPè®¡ç®—çš„å’¯ï¼Œæ‰€ä»¥å†æ¥çœ‹è¿™å›¾

![image-20240308161924284](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308161924284.png)

è¿™é‡Œçš„node--ä¹Ÿå°±æ˜¯åç«¯realserversä»¥åŠé”®--å°±æ˜¯hash $xxxï¼Œxxxæ˜¯requset_uriè¿˜æ˜¯remote_addråŸºäºä½ æ€ä¹ˆå†™ã€‚æ‰€ä»¥å‡åŒ€çš„è°ƒåº¦è¿˜çœŸå¯èƒ½å°±æ˜¯ä¾èµ–è¿™ä¸ªconsistentå…³é”®è¯äº†ï¼Œå‘µå‘µã€‚



### nginx ä¸èƒ½è¿™é‡Œç”¨ä¸‹åˆ’çº¿_ä½ç‰ˆæœ¬ï¼Ÿ

![image-20240308162649111](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308162649111.png)

![image-20240308162709503](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308162709503.png)

è°ƒç”¨çš„åœ°æ–¹è‡ªç„¶ä¹Ÿä¸èƒ½å’¯



**å¦‚æœç”¨ä¸‹åˆ’çº¿ä¼šæœ‰é—®é¢˜ æ®è¯´**

æµ‹è¯•ğŸ‘‡

![image-20240308162935020](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308162935020.png)

ä¿®æ”¹ä¸ºä¸‹åˆ’çº¿

![image-20240308163202116](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308163202116.png)

ä¹Ÿæ²¡é—®é¢˜ï¼Œé«˜ç‰ˆæœ¬ä¿®å¤äº†å¯èƒ½ğŸ‘†ã€‚ ä¼°è®¡å°±æ˜¯ä½ç‰ˆæœ¬é‡Œçš„_ä¸‹åˆ’çº¿ï¼Œä»£ç é‡Œæ²¡æœ‰åŒ¹é…å¥½æ¯”å¦‚regexå†™æ¼äº†ï¼Ÿ



# nginxçš„äºŒæ¬¡å¼€å‘çš„ç‰ˆæœ¬



https://tengine.taobao.org/

![image-20240308163738823](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308163738823.png)



æ¯”å¦‚ ngx_http_concat_moduleæ¨¡å—çš„æ•ˆç‡

https://tengine.taobao.org/document_cn/http_concat_cn.html

è¯¥æ¨¡å—ç±»ä¼¼äºapacheä¸­çš„mod_concatæ¨¡å—ï¼Œç”¨äºåˆå¹¶å¤šä¸ªæ–‡ä»¶åœ¨ä¸€ä¸ªå“åº”æŠ¥æ–‡ä¸­ã€‚



### å®‰è£…æµ‹ä¸‹Tengine

ä¸‹è½½æœ€æ–°çš„è¯•è¯•çœ‹

```
curl -LO https://tengine.taobao.org/download/tengine-3.1.0.tar.gz
 
tar xvf tengine-3.1.0.tar.gz
 
cd tengine-3.1.0.tar.gz


ç¼–è¯‘å‰ï¼Œéœ€å®‰è£…ä¾èµ–

yum install gcc pcre-devel openssl-devel zlib-devel

ç¼–è¯‘å‰ï¼Œéœ€è¦æ·»åŠ nginxç”¨æˆ·
useradd -r -s /sbin/nologin nginx

ç¼–è¯‘çš„æ—¶å€™è€ƒè™‘ä¸‹streamæ¨¡å—æ˜¯å¦æ”¯æŒï¼Œå½“ç„¶æ”¯æŒäº†ï¼Œ2015å¹´çš„nginx-1.9.0æ”¯æŒstreamçš„ï¼Œtengine-3.1.0éƒ½æ˜¯2023å¹´äº†ï¼Œæ²¡é—®é¢˜~,å…¶å®å¦‚æœä¸æ”¯æŒä¼šæŠ¥é”™çš„ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥è¿™ä¹ˆçœ‹ä¸‹æ˜¯å¦æ”¯æŒ
./configure --help |grep stream   çœ‹çœ‹æ˜¯å¦æœ‰--with-streamå­—çœ¼ã€‚æœ‰å°±æ”¯æŒå’¯

./configure --prefix=/apps/nginx \
--user=nginx \
--group=nginx \
--with-http_ssl_module \
--with-http_v2_module \
--with-http_realip_module \
--with-http_stub_status_module \
--with-http_gzip_static_module \
--with-pcre \
--with-stream \
--with-stream_ssl_module \
--with-stream_realip_module

 
make && make install

ln -s /apps/nginx/sbin/nginx /usr/bin/nginx

nginx å¯åŠ¨å°±è¡Œï¼Œå¦‚æœæŠ¥é”™ï¼Œå°±æŒ‰æç¤ºè§£å†³æŠ¥é”™
```

ç¡®è®¤æ˜¯å¦æ”¯æŒstreamæ¨¡å—ğŸ‘‡

![image-20240311104751014](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311104751014.png)

ç„¶åå°±okäº†

![image-20240311105657369](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311105657369.png)



å°è¯•å¯ç”¨concatï¼Œä½†æ˜¯ç”±äºç¼–è¯‘çš„æ—¶å€™æ²¡æœ‰åŠ ä¸Šè¿™ä¸ªæ¨¡å—ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¸æ”¯æŒã€‚

![image-20240311110227904](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311110227904.png)

ç»“æœå‘ç°å¼€å‘ç‰ˆ3.1.0ä¸æ”¯æŒå”‰

![image-20240311110436643](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311110436643.png)

æ¢

![image-20240311111026628](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311111026628.png)

å¦ˆçš„ï¼Œ2.3.1æ”¯æŒçš„ï¼Œä»–è¿™ä¸ªåˆ†å¼€å‘ç‰ˆæœ¬å’Œç¨³å®šç‰ˆï¼Œ3.1.0æ˜¯å¼€å‘ç‰ˆï¼Œè¿˜æ²¡æœ‰è¯¦ç»†çš„æ˜ç»†

![image-20240311111207265](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311111207265.png)

å°±é¦–é¡µæœ‰è¯´ï¼Œéš¾ä¸æˆå¤§ç‰ˆæœ¬1å°±æ˜¯ç¨³å®šç‰ˆï¼Œ2å°±æ˜¯å¼€å‘ç‰ˆï¼Ÿ



```
é‡æ–°ä¸‹è½½
curl -LO https://tengine.taobao.org/download/tengine-2.3.1.tar.gz
```

![image-20240311111603248](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311111603248.png)

æ“ï¼Œæœ‰ä¸ªå±



```
å†æ¢
curl -LO https://tengine.taobao.org/download/tengine-2.1.2.tar.gz
```

![image-20240311111745525](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311111745525.png)

æœ‰äº†ï¼Œæ“ï¼Œä½†æ˜¯è¿™ä¸ªç‰ˆæœ¬æ²¡æœ‰streamæ¨¡å—ï¼Œ

```
./configure --prefix=/apps/nginx \
--user=nginx \
--group=nginx \
--with-http_ssl_module \
--with-http_v2_module \
--with-http_realip_module \
--with-http_stub_status_module \
--with-http_gzip_static_module \
--with-pcre \
--with-http_concat_module
```

æŠ¥é”™å’Œå¤„ç†

![image-20240311112720494](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311112720494.png)

å‚è€ƒï¼šhttps://www.linuxquestions.org/questions/slackware-arm-108/gcc-7-x-compile-issue-with-nginx-4175608107/



ç»§ç»­ç¼–è¯‘ï¼Œç»§ç»­æŠ¥é”™

![image-20240311113115194](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311113115194.png)

å¤„ç†æ–¹æ³•ï¼Œæ³¨é‡Šæ‰è¿™è¡Œï¼Œ

![image-20240311113247197](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311113247197.png)

å†æ¬¡ç¼–è¯‘ï¼Œå†æ¬¡æŠ¥é”™

![image-20240311113321949](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311113321949.png)

å¦ˆçš„ï¼Œæ‰€ä»¥tenginxçš„concatåˆ°åº•è¡Œä¸è¡Œï¼Œä¸ºäº†ä¸€ä¸ªconcatï¼Œç»“æœé«˜ç‰ˆæœ¬çš„tenginxé‡Œæ²¡æœ‰concatï¼Œç”¨ä½ç‰ˆæœ¬é‡Œç»“æœstreamä¸æ”¯æŒï¼Œè€Œä¸”opensslä¹Ÿè¦é™ç‰ˆæœ¬ï¼Œæ“ã€‚å‚è€ƒï¼šhttps://blog.csdn.net/qq_39720249/article/details/84655501

![image-20240311113735834](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311113735834.png)



```
curl -LO https://www.openssl.org/source/old/1.0.1/openssl-1.0.1u.tar.gz

tar xvf openssl-1.0.1u.tar.gz

cd openssl-1.0.1u

./config --prefix=/apps/nginx/openssl-1.0.1u

make && make install

å†é‡æ–°ç¼–è¯‘tenginxè¯•è¯•çœ‹å’¯

```

![image-20240311115156438](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311115156438.png)

ç¼–è¯‘æŠ¥é”™

![image-20240311115946043](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311115946043.png)

![image-20240311120108780](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311120108780.png)

ç»™ä½ ä¸ªopensslç›®å½•

![image-20240311120347862](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311120347862.png)

![image-20240311120444899](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311120444899.png)

ok

![image-20240311120455040](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311120455040.png)

ç»§ç»­make

![image-20240311120729649](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311120729649.png)

fuck æŠ¥é”™æ˜¯openssl.o

ä¸‹é”™ç‰ˆæœ¬å‘¢äº†ï¼Œç»§ç»­

![image-20240311120826356](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311120826356.png)



```
curl -LO https://www.openssl.org/source/old/1.0.1/openssl-1.0.1o.tar.gz
cd openssl-1.0.1o
tar xvf openssl-1.0.1o.tar.gz
cd openssl-1.0.1o
rm -rf tengine-2.1.2/openssl   # åˆ é™¤ä¹‹å‰çš„opensslç›®å½•
mv openssl-1.0.1o tengine-2.1.2/openssl

cd tengine-2.1.2

./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-http_concat_module --with-cc-opt="-Wno-error"

make && make install

è¿˜æ˜¯openssl.oçš„æŠ¥é”™ï¼Œ
```

å¯èƒ½æ˜¯æ—§ç‰ˆçš„opensslæ²¡æœ‰åˆ é™¤å¯¼è‡´çš„ã€‚

https://juejin.cn/post/7106429674942627854

æŒ‰è¿™ä¸ªæ¥ä¸€éå†



![image-20240311202759788](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311202759788.png)







```
yum -y install remove nginx
yum -y remove nginx

cd /usr/local/ ; curl -LO https://tengine.taobao.org/download/tengine-2.1.2.tar.gz
tar xvf tengine-2.1.2.tar.gz
cd tengine-2.1.2
ll
./configure --help |grep concat
./configure --help |grep stream
yum remove openssl openssl-devel
cd ..
curl -LO https://www.openssl.org/source/old/1.0.1/openssl-1.0.1o.tar.gz
tar xvf openssl-1.0.1o.tar.gz
cd openssl-1.0.1o
./config --prefix=/opt/ldkjdata/nginx/openssl-1.0.1o
make && make install

è¿™æ˜¯OKçš„
```



```
cd ../tengine-2.1.2
pwd
vim src/os/unix/ngx_user.c
./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-openssl=../openssl-1.0.1o --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-http_concat_module --with-cc-opt="-Wno-error"
make -j 2 && make install

æœ€åä¸€æ­¥æŠ¥é”™opensslçš„é—®é¢˜è¿˜æ˜¯ï¼Œåæ­£è§£å†³è¦ä¹ˆæ­£é¢æå®šopensslï¼Œè¦ä¹ˆç”¨3.x.xtenginxå®‰è£…dsoçš„concatæ¨¡å—ã€‚

```



![image-20240311210108349](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240311210108349.png)





### **æ–¹æ¡ˆäºŒï¼šå°±ç”¨æœ€æ–°çš„ç„¶ååˆ©ç”¨--add-module=ç»“åˆå•ç‹¬ä¸‹è½½æ¨¡å—**





**åˆ°è¿™ä¸ªç½‘ç«™ä¸‹è½½concatæ¨¡å—**

https://github.com/alibaba/nginx-http-concat

ç„¶åä¸‹è½½æœ€æ–°çš„tenginx 3.1.0ï¼Œå†ç¼–è¯‘çš„æ—¶å€™åŠ ä¸Šè¿™ä¸ªæ¨¡å—å°±è¡Œäº†

```
git clone https://github.com/alibaba/nginx-http-concat.git
git clone https://github.com/vozlt/nginx-module-sts.git

cd tengine-3.1.0

./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --with-stream --with-stream_ssl_module --with-stream_realip_module --add-module=/root/nginx-http-concat

make -j 2 && make install


```



![image-20240312105753287](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312105753287.png)



OKé¸¡å·´å¼€äº†

![image-20240312105720094](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312105720094.png)

![image-20240312115230107](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312115230107.png)

è™½ç„¶okäº†ï¼Œä½†æ˜¯æˆ‘æœ‰ä¸€ä¸ªç–‘é—®å•Šï¼Œå°±æ˜¯ä¸ºä»€ä¹ˆ

1ã€å®˜ç½‘åˆ†å¼€å‘ç¨³å®šç‰ˆå’Œç¨³å®šç‰ˆï¼Œé¦–é¡µç¨³å®šç‰ˆåªæ˜¾ç¤ºåˆ°2013å¹´ï¼Œä»€ä¹ˆé¬¼

2ã€å¼€å‘ç¨³å®šç‰ˆé‡Œæœ€æ–°çš„ç«Ÿç„¶ä¸å¸¦concatæ¨¡å—ï¼Œè¿˜éœ€è¦å»11å¹´å‰çš„githubåº“é‡Œä¸‹è½½ï¼Œä»€ä¹ˆé¬¼







**ä¸‹è½½streamæ¨¡å—å»è¯•è¯•tengine-2.1.2ï¼Œä¸è¡Œå°±ç®—äº†**

å› ä¸ºç¼–è¯‘ï¼Œæ‰€ä»¥æ‰¾äº†ä¸ªæºæ–‡ä»¶ï¼Œ

https://github.com/vozlt/nginx-module-stream-sts



è¿˜æ˜¯ç”¨tengine-2.1.2æ¥å¼„è¯•è¯•

```
./configure --prefix=/apps/nginx --user=nginx --group=nginx --with-http_ssl_module --with-http_v2_module --with-http_realip_module --with-http_stub_status_module --with-http_gzip_static_module --with-pcre --add-module=/root/nginx-module-sts --with-cc-opt="-Wno-error" --add-module=/root/nginx-module-stream-sts

make dso_install     # æ³¨æ„è¿™é‡Œä¸ç›´æ¥make

make && make install  # ç„¶åå†make 
```

![image-20240312114016086](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312114016086.png)

![image-20240312114117855](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312114117855.png)

![image-20240312114133551](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312114133551.png)

è¿˜æ˜¯ä¸€æ ·çš„æŠ¥é”™ï¼Œä¸è¿‡streamæ¨¡å—å¥½åƒå¯ä»¥è¿™ä¹ˆåŠ ã€‚

![image-20240312114237936](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312114237936.png)

opensslï¼Œç®—äº†ä¸å¼„äº†ã€‚å°±ä¸Šé¢çš„æ–¹æ³•æå®šå°±è¡Œäº†ã€‚





# nginxä¼˜åŒ–



é»˜è®¤çš„Linuxå†…æ ¸å‚æ•°è€ƒè™‘çš„æ˜¯æœ€é€šç”¨åœºæ™¯ï¼Œä¸ç¬¦åˆç”¨äºæ”¯æŒé«˜å¹¶å‘è®¿é—®çš„WebæœåŠ¡å™¨çš„ å®šä¹‰ï¼Œæ ¹æ®ä¸šåŠ¡ç‰¹ç‚¹æ¥è¿›è¡Œè°ƒæ•´ï¼Œå½“Nginxä½œä¸ºé™æ€webå†…å®¹æœåŠ¡å™¨ã€åå‘ä»£ç†æˆ–è€…æä¾› å‹ç¼©æœåŠ¡å™¨çš„æœåŠ¡å™¨æ—¶ï¼Œå†…æ ¸å‚æ•°çš„è°ƒæ•´éƒ½æ˜¯ä¸åŒçš„ï¼Œæ­¤å¤„é’ˆå¯¹æœ€é€šç”¨çš„ã€ä½¿Nginxæ”¯æŒ æ›´å¤šå¹¶å‘è¯·æ±‚çš„TCPç½‘ç»œå‚æ•°åšç®€å•çš„é…ç½®,ä¿®æ”¹/etc/sysctl.confæ¥æ›´æ”¹å†…æ ¸å‚æ•°

fs.file-max = 999999

è¡¨ç¤ºå•ä¸ªè¿›ç¨‹è¾ƒå¤§å¯ä»¥æ‰“å¼€çš„å¥æŸ„æ•°

net.ipv4.tcp_tw_reuse = 1

å‚æ•°è®¾ç½®ä¸º 1 ï¼Œè¡¨ç¤ºå…è®¸å°†TIME_WAITçŠ¶æ€çš„socketé‡æ–°ç”¨äºæ–°çš„TCPé“¾æ¥ï¼Œè¿™å¯¹äº æœåŠ¡å™¨æ¥è¯´æ„ä¹‰é‡å¤§ï¼Œå› ä¸ºæ€»æœ‰å¤§é‡TIME_WAITçŠ¶æ€çš„é“¾æ¥å­˜åœ¨

net.ipv4.tcp_keepalive_time = 600

å½“keepaliveå¯åŠ¨æ—¶ï¼ŒTCPå‘é€keepaliveæ¶ˆæ¯çš„é¢‘åº¦ï¼›é»˜è®¤æ˜¯2å°æ—¶ï¼Œå°†å…¶è®¾ç½®ä¸º10åˆ†é’Ÿï¼Œ å¯æ›´å¿«çš„æ¸…ç†æ— æ•ˆé“¾æ¥

net.ipv4.tcp_fin_timeout = 30

å½“æœåŠ¡å™¨ä¸»åŠ¨å…³é—­é“¾æ¥æ—¶ï¼Œsocketä¿æŒåœ¨FIN_WAIT_2çŠ¶æ€çš„è¾ƒå¤§æ—¶é—´



net.ipv4.tcp_max_tw_buckets = 5000
è¡¨ç¤ºæ“ä½œç³»ç»Ÿå…è®¸TIME_WAITå¥—æ¥å­—æ•°é‡çš„è¾ƒå¤§å€¼ï¼Œå¦‚è¶…è¿‡æ­¤å€¼ï¼ŒTIME_WAIT  å¥—æ¥å­—å°†ç«‹åˆ»è¢«æ¸…é™¤å¹¶æ‰“å°è­¦å‘Šä¿¡æ¯,é»˜è®¤ä¸º8000ï¼Œè¿‡å¤šçš„TIME_WAITå¥—æ¥å­—ä¼šä½¿  WebæœåŠ¡å™¨å˜æ…¢

net.ipv4.ip_local_port_range = 1024 65000    ï¼Œæ¯”å¦‚nginx å¾€åç«¯å‘é€è¿æ¥çš„æºéšæœºç«¯å£

å®šä¹‰UDPå’ŒTCPé“¾æ¥çš„æœ¬åœ°ç«¯å£çš„å–å€¼èŒƒå›´

net.ipv4.tcp_rmem = 10240 87380 12582912
å®šä¹‰äº†TCPæ¥å—ç¼“å­˜çš„æœ€å°å€¼ã€é»˜è®¤å€¼ã€è¾ƒå¤§å€¼

net.ipv4.tcp_wmem = 10240 87380 12582912
å®šä¹‰TCPå‘é€ç¼“å­˜çš„æœ€å°å€¼ã€é»˜è®¤å€¼ã€è¾ƒå¤§å€¼

net.core.netdev_max_backlog = 8096    # backlogä¸æ˜¯logæ˜¯é˜Ÿåˆ—
å½“ç½‘å¡æ¥æ”¶æ•°æ®åŒ…çš„é€Ÿåº¦å¤§äºå†…æ ¸å¤„ç†é€Ÿåº¦æ—¶ï¼Œä¼šæœ‰ä¸€ä¸ªåˆ—é˜Ÿä¿å­˜è¿™äº›æ•°æ®åŒ…ã€‚ è¿™ä¸ªå‚æ•°è¡¨ç¤ºè¯¥åˆ—é˜Ÿçš„è¾ƒå¤§å€¼





net.core.rmem_default = 6291456  è¡¨ç¤ºå†…æ ¸å¥—æ¥å­—æ¥å—ç¼“å­˜åŒºé»˜è®¤å¤§å°
net.core.wmem_default = 6291456  è¡¨ç¤ºå†…æ ¸å¥—æ¥å­—å‘é€ç¼“å­˜åŒºé»˜è®¤å¤§å°
net.core.rmem_max = 12582912	è¡¨ç¤ºå†…æ ¸å¥—æ¥å­—æ¥å—ç¼“å­˜åŒºæœ€å¤§å¤§å°
net.core.wmem_max = 12582912 è¡¨ç¤ºå†…æ ¸å¥—æ¥å­—å‘é€ç¼“å­˜åŒºæœ€å¤§å¤§å°

æ³¨æ„ï¼šä»¥ä¸Šçš„å››ä¸ªå‚æ•°ï¼Œéœ€è¦æ ¹æ®ä¸šåŠ¡é€»è¾‘å’Œå®é™…çš„ç¡¬ä»¶æˆæœ¬æ¥ç»¼åˆè€ƒè™‘



net.ipv4.tcp_syncookies = 1
ä¸æ€§èƒ½æ— å…³ã€‚ç”¨äºè§£å†³TCPçš„SYNæ”»å‡»

net.ipv4.tcp_max_syn_backlog = 8192
è¿™ä¸ªå‚æ•°è¡¨ç¤ºTCPä¸‰æ¬¡æ¡æ‰‹å»ºç«‹é˜¶æ®µæ¥å—SYNè¯·æ±‚åˆ—é˜Ÿçš„è¾ƒå¤§é•¿åº¦ï¼Œé»˜è®¤1024ï¼Œå°†å…¶ è®¾ç½®çš„å¤§ä¸€äº›å¯ä½¿å‡ºç°Nginxç¹å¿™æ¥ä¸åŠacceptæ–°è¿æ¥æ—¶ï¼ŒLinuxä¸è‡³äºä¸¢å¤±å®¢æˆ·ç«¯å‘èµ· çš„é“¾æ¥è¯·æ±‚

net.ipv4.tcp_tw_recycle = 1
è¿™ä¸ªå‚æ•°ç”¨äºè®¾ç½®å¯ç”¨timewaitå¿«é€Ÿå›æ”¶

net.core.somaxconn=262114
é€‰é¡¹é»˜è®¤å€¼æ˜¯128ï¼Œè¿™ä¸ªå‚æ•°ç”¨äºè°ƒèŠ‚ç³»ç»ŸåŒæ—¶å‘èµ·çš„TCPè¿æ¥æ•°ï¼Œåœ¨é«˜å¹¶å‘çš„è¯·æ±‚ä¸­ï¼Œ
é»˜è®¤çš„å€¼å¯èƒ½ä¼šå¯¼è‡´é“¾æ¥è¶…æ—¶æˆ–è€…é‡ä¼ ï¼Œå› æ­¤éœ€è¦ç»“åˆé«˜å¹¶å‘è¯·æ±‚æ•°æ¥è°ƒèŠ‚æ­¤å€¼ã€‚

net.ipv4.tcp_max_orphans=262114
é€‰é¡¹ç”¨äºè®¾å®šç³»ç»Ÿä¸­æœ€å¤šæœ‰å¤šå°‘ä¸ªTCPå¥—æ¥å­—ä¸è¢«å…³è”åˆ°ä»»ä½•ä¸€ä¸ªç”¨æˆ·æ–‡ä»¶å¥æŸ„ä¸Šã€‚å¦‚ æœè¶…è¿‡è¿™ä¸ªæ•°å­—ï¼Œå­¤ç«‹é“¾æ¥å°†ç«‹å³è¢«å¤ä½å¹¶è¾“å‡ºè­¦å‘Šä¿¡æ¯ã€‚è¿™ä¸ªé™åˆ¶æŒ‡ç¤ºä¸ºäº†é˜²æ­¢ç®€å•çš„  DOSæ”»å‡»ï¼Œä¸ç”¨è¿‡åˆ†ä¾é è¿™ä¸ªé™åˆ¶ç”šè‡³è®¤ä¸ºçš„å‡å°è¿™ä¸ªå€¼ï¼Œæ›´å¤šçš„æƒ…å†µæ˜¯å¢åŠ è¿™ä¸ªå€¼









# zabbix-agent ç›‘æ§è®°å½•



1ã€ä¸»åŠ¨ã€è¢«åŠ¨ 

è§https://blog.51cto.com/u_15094852/2968778

å‚è€ƒä¸€ä¸‹https://blog.51cto.com/shone/5333216



ç„¶åè®°å½•æˆ‘çš„å…³é”®é…ç½®

**serç«¯**

ç”¨è¢«åŠ¨ï¼Œä¹Ÿå°±æ˜¯ â€œzabbix å®¢æˆ·ç«¯â€ï¼Œé”®å€¼ è¿™é‡Œå†™çš„æ˜¯ pingï¼Œå…¶å®å°±æ˜¯agentä¸Šçš„é…ç½®ï¼Œå¾€ä¸‹çœ‹

![image-20240312152958892](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312152958892.png)

ä¸Šå›¾ğŸ‘†çš„30sä¹Ÿå°±æ˜¯è¯´serverç«¯30ç§’å»å–ä¸€æ¬¡æ•°æ®ï¼Œæ­£å› ä¸ºagentæ˜¯è¢«åŠ¨æ¨¡å¼ï¼Œæ‰€ä»¥server-->agentå–æ‰ä¼šåˆ30sä¸€æ¬¡çš„æƒ…å†µï¼Œå¦‚æœæ˜¯agentæ˜¯ä¸»åŠ¨æ¨¡å¼server<---agentï¼Œæ­¤æ—¶serverå°±æ˜¯è¢«åŠ¨æ¥æ”¶ï¼Œagentå‘é€å¥½åƒå°±æ˜¯5sä¸€æ¬¡è¿˜æ˜¯100ä¸ªåŒ…ä¸€æ¬¡è®°ä¸å¾—äº†ã€‚





**agentå…ˆå®‰è£…**

zabbixçš„å®‰è£…è¿˜æ˜¯è¦æ³¨æ„ç‰ˆæœ¬çš„ï¼Œä¸¾ä¾‹

agentå’Œzabbixç‰ˆæœ¬è¦ç»Ÿä¸€,å¦åˆ™serverç«¯æ£€æµ‹é¡¹èµ·ä¸æ¥ï¼Œå³ä½¿agenté‚£è¾¹zabbix-agent -t ping å›è½¦æœ‰æ•°å€¼

agentå®‰è£…èµ°å®˜ç½‘zabbix.orgä¸‹è½½repoæºæ–‡ä»¶å°±è¡Œï¼š

https://www.zabbix.com/download?zabbix=6.4&os_distribution=centos&os_version=9&components=agent&db=&ws=



**agentç«¯é…ç½®**

![image-20240312153215184](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312153215184.png)



agentä¸Šæµ‹è¯•ğŸ‘‡ï¼Œå…¶å®agentä¸Šæœ€å¥½å†™æˆè¿™ç§ï¼Œä½†æ˜¯serverä¸Šæˆ‘ä¸ä¼šä¼ å‚

![image-20240312153839395](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240312153839395.png)







