# ç¬¬4èŠ‚. nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£…



# éå¸¸ç»å…¸çš„ä¸€è‡´æ€§hashç®—æ³•

â‘ èƒŒæ™¯é—®é¢˜äº§ç”Ÿçš„åŸå› ï¼šæ¥ä¸Šç¯‡ï¼Œä¸Šç¯‡äº¤ä»£äº†è¯¥ç®—æ³•äº§ç”Ÿçš„èƒŒæ™¯ï¼Œæ˜¯ç¼“å­˜ç©¿é€ã€‚æ‰€ä»¥æ‰æœ‰äº†è¿™ä¹ˆä¸ª   "ä¸€è‡´æ€§hashç®—æ³•"

https://www.xiaolincoding.com/os/8_network_system/hash.html#%E5%A6%82%E4%BD%95%E5%88%86%E9%85%8D%E8%AF%B7%E6%B1%82

å¯ä»¥çœ‹çœ‹è¿™ç¯‡ä»‹ç»ï¼Œåˆ«äººå†™çš„ğŸ‘†

ç®€å•æ€»ç»“ä¸‹

â‘¡ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜(â‘ é‡Œä»‹ç»)ï¼Œäºæ˜¯åšäº†å¦‚ä¸‹ä¼˜åŒ–

```
hash (/a.html) = 128bit % 2^32 = 0 ~ 2^32-1     # ä¸€ä¸ªurlå°±æ˜¯æŸä¸€ä¸ªå€¼ï¼Œæ— æ•°ä¸ªç±»ä¼¼çš„å€¼å°±ç»„æˆäº†ä¸€ä¸ª0~2^32èŒƒå›´çš„åŒºé—´,è¿™åŒºé—´ä»–ä»¬è¯´çœ‹æˆä¸€ä¸ªç¯ï¼Œå¥½ï¼Œå…ˆè¿™ä¹ˆç€ï¼Œä¾ä½ ~ ç¯ä½ å¤§çˆ·ï¼Œä¸ºå•¥ç¯ï¼Ÿå…ˆç†è§£åªæ˜¯ä¸åµï¼Œæˆ‘ä¼°è®¡å°±æ˜¯å–æ¨¡çš„æ•°æ®æ¨¡å‹å¯èƒ½å°±æ˜¯ä¸æ–­çš„å„ç§è¢«é™¤æ•°éƒ½æ˜¯é€ƒä¸å‡ºè¿™ä¸ªä½™æ•°çš„åœˆåœˆå’¯ã€‚

varnish 1 hash(192.168.126.101) % 2^32   # varnishç¼“å­˜çš„ipä¹Ÿä¸€æ ·è½åœ¨ä¸Šé¢çš„0~2^32åŒºé—´é‡Œ
varnish 2    # è¿™ä¸ªèŠ‚ç‚¹æƒé‡æ˜¯2ï¼Œä¹Ÿæ˜¯ç”Ÿæˆ2æ¬¡éšæœºæ•°ğŸ‘‡ï¼Œè¿™ä¸¤ä¸ªéšæœºæ•°ä¹Ÿè½åœ¨åŒºé—´é‡Œçš„2ä¸ªä½ç½®ã€‚
				hash(192.168.126.102 + random_1) % 2^32
				hash(192.168.126.102 + random_2) % 2^32
varnish 3	# è¿™ä¸ªèŠ‚ç‚¹æƒé‡æ˜¯3ï¼Œä¹Ÿæ˜¯ç”Ÿæˆ3æ¬¡éšæœºæ•°ğŸ‘‡ï¼Œè¿™ä¸¤ä¸ªéšæœºæ•°ä¹Ÿè½åœ¨åŒºé—´é‡Œçš„3ä¸ªä½ç½®ã€‚
				hash(192.168.126.103 + random_1) % 2^32
				hash(192.168.126.103 + random_2) % 2^32
				hash(192.168.126.103 + random_3) % 2^32
```

ä¸€å¥è¯æ€»ç»“ï¼šè°ƒåº¦çš„èŠ‚ç‚¹ è½åœ¨ åŒºé—´é‡Œï¼›è¯·æ±‚çš„urlä¹Ÿè½åœ¨åŒºé—´é‡Œã€‚æŠŠåŒºé—´çœ‹æˆæ¢äºæ˜¯å°±æ˜¯è¿™æ ·äº†ğŸ‘‡

å¤§æ¦‚æ„æ€å°±æ˜¯é»‘åœˆæ˜¯urlï¼Œç»¿æ¡†å°±æ˜¯varnishèŠ‚ç‚¹ï¼Œéƒ½æ˜¯é€šè¿‡å“ˆå¸Œå–æ¨¡çš„ç®—æ³•è½è¿›å»çš„ã€‚

![image-20240305093709350](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240305093709350.png)

ç„¶åè°ƒåº¦çš„æ—¶å€™å°±æ˜¯ï¼Œé¡ºæ—¶é’ˆï¼ŒæŸä¸ªé»‘åœˆå°±æ˜¯urlå’¯ï¼Œäºæ˜¯è¿™ä¸ªurlçš„è¯·æ±‚å°±è°ƒåº¦åˆ°é¡ºæ—¶é’ˆæœ€è¿‘çš„ä¸€ä¸ªç»¿æ¡†ä¹Ÿå°±æ˜¯varnishã€‚



â‘¢è™½ç„¶ä¼˜åŒ–ï¼Œä½†æ˜¯è¿˜æ˜¯å­˜åœ¨é—®é¢˜ï¼š

è°ƒåº¦ä¸Šå­˜åœ¨ä¸å‡è¡¡çš„æƒ…å†µï¼Œè€Œä¸”æ˜¯ç»å¸¸æ€§çš„ã€‚ç§°ä¹‹ä¸º"å€¾æ–œ"ï¼Œä¸‹å›¾å°±è°ƒåº¦å€¾æ–œçš„å‰å®³å’¯ğŸ‘‡

![image-20240305095803742](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240305095803742.png)

å¥½ï¼Œé—®é¢˜å°±æ˜¯åç«¯5ä¸ªèŠ‚ç‚¹å¦‚ä½•å‡è¡¡è°ƒåº¦å‘¢ï¼Ÿ

è§£å†³æ–¹æ³•å°±æ˜¯è™šæ‹ŸèŠ‚ç‚¹ï¼Œå¤§é‡çš„è™šæ‹ŸèŠ‚ç‚¹å……æ–¥è¿™å“ˆå¸Œç¯ï¼Œäºæ˜¯å°±é”™è½åœ¨äº†urlè½è„šç‚¹å‘¨å›´äº†ï¼Œå°±å‡è¡¡äº†ã€‚

<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240305101415867.png" alt="image-20240305101415867" style="zoom:33%;" />

é‚£å¦‚ä½•ç”Ÿæˆè™šæ‹ŸèŠ‚ç‚¹å‘¢ï¼Œç­”æ¡ˆå°±æ˜¯ åˆ©ç”¨æƒé‡

```
varnish 1 hash(192.168.126.101) % 2^32   # varnishç¼“å­˜çš„ipä¹Ÿä¸€æ ·è½åœ¨ä¸Šé¢çš„0~2^32åŒºé—´é‡Œ
varnish 2    # è¿™ä¸ªèŠ‚ç‚¹æƒé‡æ˜¯2ï¼Œä¹Ÿæ˜¯ç”Ÿæˆ2æ¬¡éšæœºæ•°ğŸ‘‡ï¼Œè¿™ä¸¤ä¸ªéšæœºæ•°ä¹Ÿè½åœ¨åŒºé—´é‡Œçš„2ä¸ªä½ç½®ã€‚
				hash(192.168.126.102 + random_1) % 2^32
				hash(192.168.126.102 + random_2) % 2^32
varnish 3	# è¿™ä¸ªèŠ‚ç‚¹æƒé‡æ˜¯3ï¼Œä¹Ÿæ˜¯ç”Ÿæˆ3æ¬¡éšæœºæ•°ğŸ‘‡ï¼Œè¿™ä¸¤ä¸ªéšæœºæ•°ä¹Ÿè½åœ¨åŒºé—´é‡Œçš„3ä¸ªä½ç½®ã€‚
				hash(192.168.126.103 + random_1) % 2^32
				hash(192.168.126.103 + random_2) % 2^32
				hash(192.168.126.103 + random_3) % 2^32

æœ¬æ¥ 1 2 3 å°±æ˜¯æƒé‡ï¼Œå°±æ˜¯ç”Ÿæˆå‡ ä¸ªè½è„šç‚¹ï¼Œç°åœ¨æ”¹æˆ1000 2000 3000ï¼Œè¿™æ ·æƒé‡çš„è°ƒåº¦æ¯”ä¾‹è¿˜æ˜¯1ï¼š2ï¼š3æ²¡å˜ï¼Œå°±æ˜¯3ä¸ªvarnishç¼“å­˜èŠ‚ç‚¹çš„è°ƒåº¦æ¯”é‡ä¸å˜ï¼Œä½†æ˜¯1000 2000 3000ï¼Œå°±æ˜¯åˆ†åˆ«ä¼šæœ‰1000ä¸ªéšæœºæ•°æ¥ç”Ÿæˆ1000ä¸ªå“ˆå¸Œç¯ä¸Šçš„è½è„šç‚¹ã€‚
hash(192.168.126.102 + random_1) % 2^32
hash(192.168.126.102 + random_2) % 2^32
... ...
hash(192.168.126.102 + random_1000) % 2^32

è¿™æ ·å°±å®ç°äº†è™šæ‹ŸèŠ‚ç‚¹ã€‚1000ä¸ªè½è„šç‚¹ï¼Œå…¶å®éƒ½æ˜¯varnishçš„èŠ‚ç‚¹æ˜ å°„ã€‚
```



<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307100713570.png" alt="image-20240307100713570" style="zoom:50%;" />



<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307100717370.png" alt="image-20240307100717370" style="zoom:50%;" />





è®²äº†è¿™ä¹ˆå¤šï¼Œå®ç°èµ·æ¥ï¼Œä¸€ä¸ªå•è¯consistentå°±æå®šäº†ã€‚

```shell
hash $request_uri consistent;  
```



å¯¹æ¯”ä¸‹lvsçš„è°ƒåº¦ç®—æ³•ï¼š

é™æ€å’ŒåŠ¨æ€

é™æ€4ç§ï¼Œrrï¼Œwrï¼Œshï¼Œdh

![image-20240307115633000](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307115633000.png)

![image-20240307115640506](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307115640506.png)

é™æ€çš„4ç§ï¼Œnginxéƒ½æ˜¯æ”¯æŒçš„ï¼Œwrré»˜è®¤çš„ä¹Ÿå¯ä»¥å†™æƒé‡ä¹Ÿå°±æ˜¯ç­‰ä»·äºLVSçš„RRå’ŒWRR

ç„¶ånginxçš„hash å†™å˜é‡ hash $remote_addr; ip_hashå°±æ˜¯SHï¼Œhash $requst_uri;å°±æ˜¯ç›®æ ‡åœ°å€ä¸è¿‡æ˜¯urläº†ä¸æ˜¯DHï¼Œä¸è¿‡æ„æ€æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯åŸºäºç›®æ ‡è°ƒåº¦--å°±æ˜¯ä»€ä¹ˆç›®æ ‡è°ƒåº¦åˆ°ä»€ä¹ˆæœºå™¨ä¸Šã€‚



6ç§åŠ¨æ€ï¼šLCã€

æœ€å°‘è¿æ¥LCï¼Œè¿™ä¸ªnginxä¹Ÿæœ‰ leat_connï¼Œè€Œä¸”nginxåŠ ä¸ªweightå€¼ä¹Ÿå°±æ˜¯wlcäº†ã€‚

![image-20240307132331915](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307132331915.png)



æœ€å°‘åŠ æƒè¿æ¥WLCï¼Œä¸Šä¸€è¡Œå·²ç»è¯´è¿‡äº†ï¼Œnginxä¹Ÿæ˜¯æœ‰çš„



![image-20240307133514639](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307133514639.png)



ä»¥åŠéƒ½æ˜¯åŸºäºè¿æ¥æ•°å’Œè´Ÿè½½çš„ä¸€ä¸ªè°ƒåº¦ï¼Œä¸è¿‡LVSéƒ½æ˜¯åŸºäºå››å±‚çš„ï¼Œå¹¶ä¸æ¶‰åŠåº”ç”¨å±‚ï¼Œè€Œnginxå¯ä»¥ã€‚

â€‹     <img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307133108326.png" alt="image-20240307133108326" style="zoom:40%;" /> 

â€‹      <img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307133350615.png" alt="image-20240307133350615" style="zoom:40%;" />

 

![image-20240307133443146](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307133443146.png) 







# nginxåšå››å±‚è°ƒåº¦

ä¹‹å‰httpåº”ç”¨å±‚è°ƒåº¦ç”¨çš„æ˜¯ngx_http_upstream-moduleï¼Œç°åœ¨åšL4çš„è°ƒåº¦ï¼Œç”¨çš„æ˜¯ngx_stream_core_moduleæ¨¡å—ã€‚



æ‰€ä»¥httpçš„åä»£-è°ƒåº¦æ˜¯å†™åœ¨httpè¯­å¥å—ä¸‹çš„ï¼Œ

è€Œï¼ŒL4çš„åä»£-è°ƒåº¦æ˜¯å†™åœ¨streamè¯­å¥å—ä¸‹çš„



![image-20240307152126668](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307152126668.png)

1.9æ‰å¼€å§‹æ”¯æŒL4çš„åä»£

![image-20240307152152554](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307152152554.png)





![image-20240307152827346](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307152827346.png)



ç‚¹å‡»å»

![image-20240307152929978](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307152929978.png)





å°±æ˜¯2015å¹´4æœˆ29 å¼€å§‹æ”¯æŒçš„å’¯





## å¼€å§‹å®éªŒ-tcpä»£ç†db



**1ã€æä¸¤ä¸ª mysqlåšrealserver**



åˆ›å»ºæ•°æ®åº“ä¾¿äºnginxåä»£è°ƒåº¦å clientæµ‹è¯• çŸ¥é“è¿çš„å“ªä¸ªrealserverã€‚

![image-20240307155751801](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307155751801.png)



![image-20240307154530057](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307154530057.png)

<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307155653156.png" alt="image-20240307155653156" style="zoom: 33%;" />





**2ã€nginxåä»£é…ç½®åŸºäºtcpåè®®ä¹Ÿå°±æ˜¯L4çš„è°ƒåº¦**

![image-20240307162412732](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307162412732.png)

streamè¯­å¥å—æ˜¯å†™åœ¨mainä¸‹çš„ï¼Œä¹Ÿå°±æ˜¯å’Œhttp



å°±å†™åˆ°ä¸»é…æŒ‡æ–‡ä»¶é‡Œï¼Œæ”¾åˆ°æœ€ä¸‹é¢ï¼Œå’Œhttpå¹³çº§ï¼Œè‡ªç„¶å°±æ˜¯mainå±‚çº§äº†ã€‚

![image-20240307164636635](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307164636635.png)

é‡å¯nginxå°±ä¼šçœ‹åˆ°æœ¬åœ°å°±ä¼šç›‘å¬3306ï¼Œè¿™æ ·æ‰èƒ½åä»£å“¦

è¿™é‡Œä¹Ÿå¯ä»¥å†™æˆ0.0.0.0:3306

![image-20240307164917175](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307164917175.png)

é¡ºæ‰‹æµ‹ä¸‹ç«¯å£è¿é€šOKçš„ğŸ‘‡

![image-20240307164954278](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307164954278.png)



è¿™å°±å¥½äº†ï¼Œclientæµ‹è¯•

![image-20240307165952532](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307165952532.png)

å‘ç°è°ƒåº¦åˆ°äº†132è¿™ä¸ªDBä¸Šäº†

å¤šè¯•å‡ æ¬¡ä¹Ÿä¼šè°ƒåº¦åˆ°133ï¼Œå› ä¸ºæ˜¯least_connï¼Œå°±ä¸¤å°realserveréƒ½æ²¡æœ‰è¿æ¥çš„ã€‚

![image-20240307170040323](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307170040323.png)



è¯•è¯•æƒé‡

![image-20240307171001677](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307171001677.png)

æµ‹è¯•OKğŸ‘‡

![image-20240307170939556](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240307170939556.png)





## å¼€å§‹å®éªŒ-tcpä»£ç†redis



**1ã€å®‰è£…redisï¼Œå¹¶ä¿®æ”¹ç›‘å¬æ‰€æœ‰ç«¯å£**

è¿™é‡Œç®€å•ç”¨ä¸‹redisï¼Œåé¢å•ç‹¬å¼€ç« èŠ‚

åœ¨åç«¯realserverï¼Œä¸¤å° ä¸Šéƒ½å®‰è£…redisï¼Œå½“ç„¶å¾—æœ‰epelæºã€‚

```
yum -y install redis
```

ä»¥å‰çœ‹åˆ°yum redisä¼šæœ‰ä¾èµ–åŒ…ï¼Œç°åœ¨çœ‹ä¸åˆ°äº†

![image-20240308152903495](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308152903495.png)

![image-20240308152749491](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308152749491.png)







![image-20240308145330202](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308145330202.png)

ä¿®æ”¹é…ç½®æ–‡ä»¶ç›‘å¬æ‰€æœ‰ç«¯å£ï¼ŒğŸ‘‡åˆ æ‰ä¹Ÿä¸€æ ·çš„æ•ˆæœ

![image-20240308145500370](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308145500370.png)

![image-20240308145545096](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308145545096.png)



redisé›†ç¾¤æ­å»ºåé¢å†å¼„ã€‚



**æµ‹è¯•ä¸‹ï¼Œæœ¬åœ°æµ‹è¯•å°±è¡Œ**
![image-20240308150103650](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150103650.png)

å¯ä»¥çœ‹åˆ°redis clié‡Œè‡ªå¸¦å¸®åŠ©ä¿¡æ¯çš„ã€‚

æœ€ç®€å•çš„å°±æ˜¯è®¾ç½®key valueï¼Œé”®å€¼å¯¹ã€‚

å†™ï¼Œè¯»ğŸ‘‡

![image-20240308150311795](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150311795.png)

è¿™æ˜¯134çš„ä¸€ä¸ªredisçš„é”®å€¼å¯¹ğŸ‘†ï¼Œ

å†è®¾ç½®133çš„redisé‡Œçš„ä¸€ä¸ªkey valueï¼ŒåŒºåˆ†å¼€æ¥æ–¹ä¾¿æµ‹è¯•æ•ˆæœ

å‘ç°é»˜è®¤è¦æœ¬åœ°é…ç½®ï¼Œè¿œç«¯é»˜è®¤è¿˜ä¸è¡Œ

![image-20240308150602510](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150602510.png)

æ”¹æœ¬åœ°é…ç½®ğŸ‘‡

![image-20240308150529912](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150529912.png)



æˆ–è€…å–æ¶ˆproctected mode

![image-20240308150752029](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150752029.png)

![image-20240308150821575](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308150821575.png)

ä¸Šå›¾å–æ¶ˆè‚¯å®šä¸å®‰å…¨å’¯ï¼Œæ¨èå»é…ç½®æ–‡ä»¶é‡Œå†™æ˜bind ipå°±è¡Œäº†--å°±æ˜¯ç›‘å¬è‡ªå·±çš„IPå°±è¡Œäº†ã€‚![image-20240308153519706](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308153519706.png)





**3ã€é…ç½®nginx åä»£ åˆ°rediså»**
![image-20240308151337392](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308151337392.png)



![image-20240308151646616](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308151646616.png)

ä½†æ˜¯å‘ç°é»˜è®¤è¯´å¥½çš„1:1çš„è°ƒåº¦ï¼Œé»˜è®¤æƒé‡=1å˜›ã€‚ä½†æ˜¯æ²¡æœ‰çœ‹åˆ°134çš„redisçš„key valueå‡ºç°

è°ƒæ•´è°ƒåº¦æµ‹è¯•ä¸‹ğŸ‘‡

![image-20240308151853583](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308151853583.png)

ç»§ç»­è§‚å¯Ÿ

![image-20240308152502723](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308152502723.png)

![image-20240308152448984](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308152448984.png)

ğŸ‘†è¯´å¥½çš„1:3ä¹Ÿæ²¡çœ‹åˆ°ã€‚



è¦exité€€å‡ºæµ‹è¯•æ‰èƒ½çœ‹åˆ°è°ƒåº¦æ•ˆæœï¼Œç»§ç»­æµ‹è¯•

è°ƒåº¦ä¹Ÿä¸æ˜¯ç«‹é©¬ç”Ÿæ•ˆçš„å¥½åƒ

<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308153800514.png" alt="image-20240308153800514" style="zoom:44%;" />



è¦é€€å‡ºæ‰èƒ½çœ‹åˆ°1:3æƒé‡æ•ˆæœ

<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308154036850.png" alt="image-20240308154036850" style="zoom:44%;" />





<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308154426204.png" alt="image-20240308154426204" style="zoom:44%;" />



ç„¶åredisæ˜¯æ¯”member cacheå¼ºï¼ŒMemcacheæ˜¯åŸºäºå†…å­˜çš„ï¼Œredisæ˜¯å¯ä»¥å†…å­˜ä¹Ÿå¯ä»¥æ”¾åˆ°ç£ç›˜ä¸Šã€‚



æ³¨æ„ä¹Ÿå¯ä»¥ç”¨UDPã€‚

![image-20240308160650936](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308160650936.png)



<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308160858732.png" alt="image-20240308160858732" style="zoom:40%;" />

è¶…æ—¶é—´ä¹Ÿå…³æ³¨ä¸‹



<img src="4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308161820725.png" alt="image-20240308161820725" style="zoom:40%;" />

consistentå°±æ˜¯å‰æ–‡è®²çš„å“ˆå¸Œä¸€è‡´æ€§ç®—æ³•ï¼Œä¸è¿‡è¿™é‡Œæ˜¯é’ˆå¯¹çš„æºIPè®¡ç®—çš„å’¯ï¼Œæ‰€ä»¥å†æ¥çœ‹è¿™å›¾

![image-20240308161924284](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308161924284.png)

è¿™é‡Œçš„node--ä¹Ÿå°±æ˜¯åç«¯realserversä»¥åŠé”®--å°±æ˜¯hash $xxxï¼Œxxxæ˜¯requset_uriè¿˜æ˜¯remote_addråŸºäºä½ æ€ä¹ˆå†™ã€‚æ‰€ä»¥å‡åŒ€çš„è°ƒåº¦è¿˜çœŸå¯èƒ½å°±æ˜¯ä¾èµ–è¿™ä¸ªconsistentå…³é”®è¯äº†ï¼Œå‘µå‘µã€‚



### nginx ä¸èƒ½è¿™é‡Œç”¨ä¸‹åˆ’çº¿_ä½ç‰ˆæœ¬ï¼Ÿ

![image-20240308162649111](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308162649111.png)

![image-20240308162709503](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308162709503.png)

è°ƒç”¨çš„åœ°æ–¹è‡ªç„¶ä¹Ÿä¸èƒ½å’¯



**å¦‚æœç”¨ä¸‹åˆ’çº¿ä¼šæœ‰é—®é¢˜ æ®è¯´**

æµ‹è¯•ğŸ‘‡

![image-20240308162935020](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308162935020.png)

ä¿®æ”¹ä¸ºä¸‹åˆ’çº¿

![image-20240308163202116](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308163202116.png)

ä¹Ÿæ²¡é—®é¢˜ï¼Œé«˜ç‰ˆæœ¬ä¿®å¤äº†å¯èƒ½ğŸ‘†ã€‚ ä¼°è®¡å°±æ˜¯ä½ç‰ˆæœ¬é‡Œçš„_ä¸‹åˆ’çº¿ï¼Œä»£ç é‡Œæ²¡æœ‰åŒ¹é…å¥½æ¯”å¦‚regexå†™æ¼äº†ï¼Ÿ



# nginxçš„äºŒæ¬¡å¼€å‘çš„ç‰ˆæœ¬



https://tengine.taobao.org/

![image-20240308163738823](4-nginxå››å±‚ä»£ç†åŠŸèƒ½å’Œtengineç¼–è¯‘å®‰è£….assets/image-20240308163738823.png)



æ¯”å¦‚ ngx_http_concat_moduleæ¨¡å—çš„æ•ˆç‡

https://tengine.taobao.org/document_cn/http_concat_cn.html

è¯¥æ¨¡å—ç±»ä¼¼äºapacheä¸­çš„mod_concatæ¨¡å—ï¼Œç”¨äºåˆå¹¶å¤šä¸ªæ–‡ä»¶åœ¨ä¸€ä¸ªå“åº”æŠ¥æ–‡ä¸­ã€‚









