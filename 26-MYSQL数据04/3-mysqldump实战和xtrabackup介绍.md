# ç¬¬3èŠ‚. mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç»



![image-20230720174307740](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720174307740.png)

-F --flush-logsï¼šå­˜åœ¨æ»šåŠ¨å¤šæ¬¡æ•°æ®åº“-A -Bæ¶‰åŠå¤šä¸ªæ•°æ®åº“ï¼Œä¼°è®¡ä¸€ä¸ªæ•°æ®åº“å°±ä¼šæ»šåŠ¨ä¸€æ¬¡ï¼›æ‰€ä»¥éœ€è¦é…åˆ--single-transactionæ¥åšä¸€æ¬¡äº‹åŠ¡æ»šåŠ¨ä¸€æ¬¡ï¼Œå°±æ˜¯ç›¸å½“äºä¸ç”¨ äººå·¥flush logsåˆ·æ–°binlogäº†ã€‚--master-dataè‚¯å®šè¦çš„ï¼ŒmysqldumpåŠ¨ä½œå¯¹åº”çš„binlogä½ç½®å¾—è®°ä¸‹æ¥çš„ã€‚

![image-20230720175721854](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720175721854.png)

![image-20230720175735534](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720175735534.png)

è¿™ä¸ªå°±ç›´æ¥STD è¾“å‡ºåˆ°å±å¹•ä¸Šäº†å“¦ï¼Œç„¶åå†çœ‹çœ‹binlog

![image-20230720175810296](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720175810296.png)

ä»34å¼€å§‹åˆ°45ï¼Œå¤šäº†12ä¸ªã€‚

![image-20230720180038255](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720180038255.png)

åªä¼šåˆ·å‡ºä¸€ä¸ªbinlog

![image-20230720180106778](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720180106778.png)

-F æ»šåŠ¨çš„å¥½å¤„ä¹Ÿå°±æ˜¯flush logsçš„å¥½å¤„ï¼Œå°±æ˜¯ä¸Šå›¾çš„000046å·æ–‡ä»¶æ˜¯æ–°çš„æ—¥å¿—ï¼Œå’Œè€æ—¥å¿—åˆ†å¼€æ¥æ”¾äº†ï¼Œå°±æ˜¯æ–°è€æ—¥å¿—å­˜æ”¾æ¸…æ™°ï¼Œå¤„ç†å¤‡ä»½è¿˜åŸå°±æœ‰æ˜ç¡®çš„000045--è€æ—¥å¿—ï¼Œ000046æ–°æ—¥å¿—ï¼Œæ˜ç¡®çš„æ–‡ä»¶åˆ†ç•Œçº¿å°±å‡ºæ¥äº†ï¼Œæ— éœ€å»æ–‡ä»¶é‡Œæ‰’ä½ç½®å»å®šç•Œäº†ã€‚



çœ‹ä¸‹è¿™æ¡ä¼˜åŒ–å¤‡ä»½CLIçš„å®æ“æ•ˆæœ

```shell
mysqldump -F -A --single-transaction --master-data=2 > /data/all_`date +%F`.sql
```

![image-20230720181446130](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720181446130.png)

ç°åœ¨000046å·æ–‡ä»¶389ï¼Œ

```
drop table coc;
show master logs;
```

<img src="3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720181726077.png" alt="image-20230720181726077" style="zoom:50%;" /> 

<img src="3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720181741273.png" alt="image-20230720181741273" style="zoom:50%;" /> 

![image-20230720181827857](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720181827857.png)

![image-20230720181839060](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720181839060.png)

å¥½ï¼Œæ­¤æ—¶000046çš„sizeè¾¾åˆ°äº†711ï¼Œä»389ã€‚æ—¥å¿—å¢é•¿äº†å¾ˆå¤šã€‚

![image-20230720182015058](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720182015058.png)

![image-20230720182117775](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720182117775.png)

-Fçš„æ•ˆæœå°±å‡ºæ¥äº†ï¼Œç»“åˆ--single-transactionä»¥åŠ--master-data=2

å°±æ˜¯æ–°çš„binlogæ–‡ä»¶000047çš„389è¿™ä¸ªä½ç½®ä½œä¸ºmysqldumpçš„èŠ‚ç‚¹ï¼Œå»çœ‹çœ‹all_`date +%F`.sqlæ–‡ä»¶é‡Œå¿…ç„¶ä¹Ÿå†™ç€000047 389è¿™ä¸ªä½ç½®ç‚¹

![image-20230720182356563](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720182356563.png)

ç›¸å½“äºflushäº†ä¸€ä¸ªæ–°æ—¥å¿—æ–‡ä»¶ï¼Œä»è¿™ä¸ªæ–‡ä»¶ä»¥å‰çš„binlogå°±åŒ…å«åœ¨äº†å…¨å¤‡æ–‡ä»¶äº†ï¼Œä»è¿™ä¸ªèŠ‚ç‚¹å¼€å§‹ä»¥åå°±ä¸åŒ…å«åœ¨å…¨å¤‡é‡Œã€‚



å…¨å¤‡å·²ç»åŒ…å«çš„binlogå°±å¯ä»¥æ¸…ä¸€ä¸‹äº†ï¼Œå“¦ï¼Œæ‰€ä»¥binlogæ¸…é‡Œæ˜¯è¿™ä¹ˆæ¸…çš„ï¼

![image-20230720182928051](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720182928051.png)

ç£ç›˜ä¸Šè‡ªç„¶ä¹ŸåŒæ­¥äº†

![image-20230720183019294](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720183019294.png)

ğŸ‘‡è¿™ä¸ªresetæ²¡å¿…è¦å§ï¼Œä¸ç„¶ä½ è¿˜åŸçš„å…¨å¤‡æ²¡é—®é¢˜ï¼Œè¡¥å·®ä»·çš„æ—¶å€™å¤„ç†binlogå°±ä¸èƒ½ç›´æ¥å¤åˆ¶mysqldump --master-data äº§ç”Ÿå¾—binlogç¼–å·å’Œä½ç½®äº†

![image-20230720183108259](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720183108259.png)

å¾—æ”¹æˆæ–°çš„binlogç¼–å·ï¼Œå’Œä½ç½®ï¼Œä¸è¿‡-Fæ˜¯åˆ·æ–°å¾—ï¼Œä½ç½®ä¸ç”¨å†™äº†ç›´æ¥ç¼–å·å°±è¡Œäº†ã€‚

![image-20230720183441328](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720183441328.png)

![image-20230720183426054](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230720183426054.png)





### æ¸©å¤‡-MyISAMä¸æ”¯æŒäº‹åŠ¡ï¼Œè¦åŠ é”ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

![image-20230721095441971](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721095441971.png)

MyISAMå¤‡ä»½è¦ç”¨-xï¼Œå…¨éƒ¨åŠ ä¸Šè¯»é”ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚

-l  åˆ«ç”¨äº†ï¼Œä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ï¼Œå› ä¸ºä¸€ä¸ªåº“ä¸€ä¸ªåº“çš„åŠ é”ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚

æ‰€ä»¥InnoDBä¸è¦ç”¨è¿™äº›é€‰é¡¹ï¼Œè¿™äº›é€‰é¡¹æ˜¯MyISAMæ‰éœ€è¦çš„ã€‚



çƒ­å¤‡-InnoDBï¼Œå¼€å¯äº‹åŠ¡

![image-20230721100742777](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721100742777.png)

å°±æ˜¯æ‰€æœ‰çš„mysqldumpåœ¨ä¹Ÿç»™äº‹åŠ¡é‡Œï¼Œè€Œäº‹åŠ¡çš„é»˜è®¤éš”ç¦»çº§åˆ«æ˜¯"å¯é‡å¤è¯»"ï¼Œæ‰€ä»¥å¯ä»¥åšåˆ°æ‰€æœ‰æ•°æ®åº“çš„æ•°æ®ä¸€è‡´æ€§ã€‚

â€‹		ä½†æ˜¯äº‹åŠ¡å¯ä»¥éš”ç¦»DMLï¼Œä¸èƒ½éš”ç¦»DDLã€‚è¯·çœ‹ä¸‹å›¾ğŸ‘‡

![image-20230721112409156](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721112409156.png)

![image-20230721112637904](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721112637904.png)



DDLè¯­è¨€ï¼šdrop table,   rename table, truncate tableï¼›è¿™äº›äº‹åŠ¡é’ˆå¯¹è¿™äº›æ˜¯ä¸å…·å¤‡éš”ç¦»æ€§çš„ã€‚

æ³¨æ„truncate tableå’Œdelete fromçš„åŒºåˆ«ï¼Œå‰è€…æ˜¯DDLï¼Œåç¼€æ˜¯DMLã€‚è¿™äº›äº‹åŠ¡å…·å¤‡å¯¹å…¶çš„éš”ç¦»æ€§ã€‚



![image-20230721133619769](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721133619769.png)

![image-20230721133644846](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721133644846.png)

-qå°±æ˜¯--quickçœ‹æ¥è¿˜ä¸é”™



## å¤„ç†æ–¹å¼

ä¸€èˆ¬æ¥è®²MyISAMï¼Œ-x

å¯¹äºInnoDBï¼Œ--single-transaction

ä½†æ˜¯å¯¹äºæ•°æ®åº“æ¥è®²ï¼Œåˆæœ‰mysqlè¿™ç§ç³»ç»Ÿåº“æ˜¯MyISAMçš„ï¼Œåˆæœ‰å¸¸è§„çš„å…¶ä»–æ‰€æœ‰åº“å°±éƒ½æ˜¯InnoDBã€‚

å¦‚æœ

mysqldump -x --single-transaction ï¼Œ-xå°±å¤±æ•ˆäº†ï¼Œä¸Šå›¾é‡Œæœ‰æåˆ°çš„ã€‚



-Aåº”è¯¥å°±åŒ…å«äº†-E -R --triggers --default-characterè¿™äº›äº†ï¼Œå› ä¸º-AåŒ…å«äº†mysqlç³»ç»Ÿåº“ã€‚

ä½†æ˜¯-Få’Œ--hex-blobç†è®ºä¸Šæ˜¯éœ€è¦çš„ï¼Œç„¶å--deafult-character-setè¿™ä¸ªéœ€è¦ç‰¹å®šæŒ‡å®šå—ï¼Ÿä¸å†™ä¼šä¸ä¼šæ›´å¥½ï¼Œå†™çš„å°±è¦çœ‹ä¸‹æ˜¯å¦å’ŒåŸæœ¬çš„æ•°æ®åº“çš„é»˜è®¤å­—ç¬¦é›†ä¸€è‡´ï¼Œè¦å†™æˆä¸€è‡´çš„å­—ç¬¦é›†ã€‚

--master-data=1å°±æ˜¯æœ‰ä¸»ä»å¤åˆ¶äº†ã€‚

```
InnoDBå»ºè®®å¤‡ä»½ç­–ç•¥
mysqldump â€“uroot â€“A â€“F â€“E â€“R --single-transaction --master-data=1 --
flush-privileges --triggers --default-character-set=utf8 --hex-blob
>$BACKUP/fullbak_$BACKUP_TIME.sql

MyISAMå»ºè®®å¤‡ä»½ç­–ç•¥
mysqldump â€“uroot â€“A â€“F â€“E â€“R â€“x --master-data=1 --flush-privileges --  triggers --default-character-set=utf8 --hex-blob
>$BACKUP/fullbak_$BACKUP_TIME.sql

```

MyISAMå°±æ˜¯éœ€è¦åŠ ä¸Š-xé€‰é¡¹ã€‚





## åˆ†åº“å¤‡ä»½

ä¹‹å‰-Aå¯èƒ½å¤‡çš„å¤ªå¤šäº†ï¼Œæ²¡å¿…è¦ï¼Œäºæ˜¯è¿™é‡Œå¼€å§‹å­¦ä¹ ä¸€ä¸‹åˆ†åº“å¤‡ä»½

æ¥çœ‹çœ‹é”™è¯¯å¾—æ¡ˆä¾‹ï¼š

![image-20230721160941655](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721160941655.png)

ä¸Šå›¾å¾—grep ç”¨çš„å€’æ˜¯æŒºæºœå¾—ï¼Œä¸è¿‡ä¹Ÿå°±æ˜¯-wçš„äº‹ï¼Œå†™æˆäº†^xxx$ï¼›

ç„¶åä¸Šå›¾ç”¨for å¾ªç¯é‡Œçš„--single-transactionæ˜¯ä¸æ˜¯æœ‰æ¯’ï¼Œä¸€ä¸ªå¾ªç¯ä¸€ä¸ªæ•°æ®ä¸€ä¸ªå¯¹ç«‹çš„äº‹åŠ¡ï¼ŒTMæœ‰10ä¸ªdbå°±è¦å¼€å¯10ä¸ªäº‹åŠ¡ï¼Œæ•°æ®çš„ä¸€è‡´æ€§è¿˜æœ‰å—ï¼Ÿ



æ˜æ˜-Bå°±å¯ä»¥è·Ÿå¤šä¸ªdbï¼Œéè¦ç§€forã€‚

<img src="3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721161302765.png" alt="image-20230721161302765" style="zoom:50%;" /> 

![image-20230721161326013](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721161326013.png)



ä¼˜åŒ–ä¸‹ï¼Œå–å‡ºæ‰€æœ‰éœ€è¦å¤‡ä»½çš„æ•°æ®åº“

![image-20230721161500085](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721161500085.png)

è¿™æ ·ğŸ‘‡å°±å¯ä»¥å•¦ï¼š

![image-20230721162621397](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721162621397.png)

OKï¼Œåº“éƒ½å¤‡å¥½äº†ğŸ‘‡ï¼š

![image-20230721180354880](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721180354880.png)

æˆ–è€…ğŸ‘‡è¿™æ ·ï¼š

![image-20230721162943898](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721162943898.png)

çœ‹ç€æœ‰ç‚¹é—®é¢˜ï¼Œä½†æ˜¯echoå‡ºæ¥çš„cliç›´æ¥å¤åˆ¶æ˜¯å¯ä»¥çš„ï¼Œçœ‹ç€åƒæ²¡æœ‰è°ƒç”¨bash

ä¼˜åŒ–ä¸‹å°±å¯ä»¥äº†

![image-20230721164018891](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721164018891.png)

OKäº†ï¼Œå¤§å°å’Œç¬¬ä¸€ä¸ªå‘½ä»¤å†™æ³•ä¸€æ ·

![image-20230721164054288](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721164054288.png)

å’Œå‹ç¼©æ‰“åŒ…ç»“åˆä¸€ä¸‹

![image-20230721171035131](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721171035131.png)



ç„¶åè¡¥å……ä¸€ä¸ªè§†é¢‘é‡Œé”™è¯¯çš„æ€è·¯ï¼ˆè¿˜æ˜¯-B åªå¸¦äº†ä¸€ä¸ªdbï¼‰ï¼Œä½†æ˜¯æœ‰æ„æ€çš„å†™æ³•ï¼ˆsedå†™çš„6ï¼‰

![image-20230721181016396](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721181016396.png)

ä½†æ˜¯ç”Ÿæˆçš„å‘½ä»¤æ²¡æœ‰æ‰§è¡Œï¼Œè¿˜éœ€è¦é‡å®šå‘åˆ°bashï¼Œæˆ–è€…\`\`åæ–œæ æ‰è¡Œã€‚

![image-20230721181256685](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230721181256685.png)



## xtrabackup-æ›´ä¸“ä¸šçš„å¤‡ä»½å·¥å…·



ä»–æœ‰å¾ˆå¤šäº§å“ï¼ŒğŸ‘†è¿™æ˜¯xtrabackupï¼Œå…¶å®äººå®¶è¿˜æœ‰ç›‘æ§ï¼Œè¿˜æœ‰ç®¡ç†ï¼Œè¿˜æœ‰å·ç§°æ¯”mysqlæ›´ç‰›é€¼çš„db

![image-20230725142144047](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230725142144047.png)



https://www.percona.com/downloads

![image-20230725142007680](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230725142007680.png)

8.0å¯¹åº”çš„åº”è¯¥æ˜¯mysql8.X

2.4å¯¹åº”çš„å°±æ˜¯mysql5.x



è¿™ä¸ªå·¥å…·å¯¹æ¯”mysqldumpçš„ä¼˜åŠ¿

1ã€é€Ÿåº¦æ›´å¿«ï¼Œè€Œä¸”ä¸æ˜¯åƒmysqldumpé‚£ç§å…¶å®å°±æ˜¯é€šè¿‡mysqlå‘½ä»¤è¿›å…¥æ•°æ®åº“ç„¶åé€šè¿‡å¤§çš„selectå‘½ä»¤æ¥æŸ¥çš„ã€‚extrabackupæ˜¯é€šè¿‡æ•°æ®å—æ–‡ä»¶çš„å¤åˆ¶ã€‚

2ã€å¤‡ä»½çš„æ—¶å€™æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡

3ã€æœ‰å‹ç¼©åŠŸèƒ½èŠ‚çº¦ç£ç›˜ï¼Œè¿™ä¸ªä¸ç®—ä»€ä¹ˆä¼˜ç‚¹å§ï¼Œmysqldumpå‡ºæ¥ä¹Ÿèƒ½è‡ªå·±zipä¸€ä¸‹ã€‚

4ã€å¤‡ä»½çš„è‡ªåŠ¨æ£€éªŒï¼Œè¿™ä¸ªæ˜¯å¦èƒ½ä¿éšœå¤‡ä»½å‡ºæ¥çš„æ–‡ä»¶å¯ä»¥æ­£å¸¸è¿˜åŸçš„æ„æ€å‘¢ï¼Ÿå¦‚æœæ˜¯ï¼Œè¿˜ä¸é”™ã€‚

5ã€å¼€æºã€å…è´¹ï¼Œåº”è¯¥æ˜¯å¯¹æ ‡çš„çº¢å¸½ä¼ä¸šçº§çš„å¤‡ä»½å·¥å…·mysqlbackupã€‚



### xtrabackupå·¥å…·çš„å†…éƒ¨çš„ä¸€äº›å·¥ä½œæœºåˆ¶

2.2ç‰ˆæœ¬ä¹‹å‰æ¯”è¾ƒçƒ‚ï¼šå…¶å®ä¸»è¦æœ‰ä¸¤ä¸ªç¨‹åºç»„æˆ

innobackupexï¼šperè„šæœ¬

xtrabackupï¼šC/C++å†™çš„

è¿˜ä¸¤ä¸ªä¸æ€ä¹ˆç”¨ï¼šxbcryptåŠ è§£å¯†çš„ï¼›xbstreamå¹¶å‘ç”¨çš„



xtrabackup ä¸èƒ½å¤‡ä»½éinnodbè¡¨ï¼Œ

innobackupex å¯ä»¥ç”¨æ¥å¤‡ä»½éinnodbè¡¨ã€‚å’Œmysqlserverçš„äº¤äº’å°±æ˜¯æŒ‡è¿›å…¥mysqlè¿›è¡Œé”è¡¨ä¹‹ç±»çš„æ“ä½œã€‚![image-20230726084459229](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726084459229.png)

ä¸€ä¸ªinnobackupexè„šæœ¬ï¼Œä¸€ä¸ªbinæ–‡ä»¶ï¼Œä¸€ä¸ªè¿˜ä¼šè°ƒå¦ä¸€ä¸ªï¼Œè®²å®Œäº†ã€‚

![image-20230726091050974](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726091050974.png)

redoæ‹·è´çº¿ç¨‹ï¼šå°±æ˜¯os_thread_createï¼Œç³»ç»Ÿåˆ›å»ºçº¿ç¨‹æ¥åšredoä¹Ÿå°±æ˜¯äº‹åŠ¡æ—¥å¿—çš„å¤åˆ¶ã€‚

ibdæ‹·è´çº¿ç¨‹ï¼šå°±æ˜¯ç³»ç»Ÿåˆ›å»ºçº¿ç¨‹ï¼Œæ¥åšinnodbçš„ibdæ–‡ä»¶(é‡Œé¢æœ‰æ•°æ®å’Œç´¢å¼•)çš„å¤‡ä»½ã€‚

innodbæ‹·è´å®Œå°±å¼€å§‹å¼„MyISAMå¼•æ“çš„æ•°æ®åº“äº†ï¼Œä¸»è¦æ˜¯mysqlç³»ç»Ÿåº“å§ã€‚

MyISAMçš„è¢«ï¼Œæœ¬è´¨å°±æ˜¯å¤åˆ¶frmã€MYDã€MYIæ–‡ä»¶ï¼Œetcè¯´æ˜è¿˜æœ‰åˆ«çš„æ–‡ä»¶ï¼Œéš¾é“æ˜¯ç›¸å…³çš„logï¼Ÿå½“ç„¶è¦åŠ å…¨å±€è¯»é”ã€‚å½“ç„¶è¿™äº›åŠ¨ä½œéƒ½æ˜¯åœ¨ä¸€ä¸ªå¤§çš„äº‹åŠ¡é‡Œè¿›è¡Œçš„ã€‚

åœæ­¢ä¸€å¼€å§‹å¼€å¯çš„äº‹åŠ¡åï¼Œè§£é”ï¼Œé€€å‡ºxtrabackupäºŒè¿›åˆ¶ç¨‹åºã€‚æ¥ç€ç»“æŸinnobackupexè„šæœ¬ã€‚

ä»¥ä¸Šå°±æ˜¯è€ç‰ˆæœ¬çš„xtrabackupçš„è¢«è¿‡ç¨‹ğŸ‘†ã€‚

ä»2.4ä»¥åï¼Œå°±ä¸å†æ˜¯åˆ†æ¥çš„æ–‡ä»¶äº†ï¼Œè€Œæ˜¯åˆåœ¨ä¸€èµ·ï¼Œéƒ½æ˜¯Cå†™çš„äº†ã€‚

![image-20230726092013110](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726092013110.png)



### ä¸‹é¢å°±æ˜¯å¼€å§‹å®‰è£…xtrabackup

æ³¨æ„å¯ç”¨epelæºå› ä¸ºéœ€è¦libev.soï¼Œè¿™ä¸ªåœ¨epelæºé‡Œã€‚è¿™æ˜¯è§†é¢‘é‡Œè®²çš„ï¼Œæˆ‘å‘ç°libevå¥½åƒç°åœ¨ä¹Ÿåœ¨baseæºäº†ã€‚åæ­£ä¸€ä¸ªrock.repoé‡Œæœ‰å¾ˆå¤šæºï¼šbaseã€appsteam

![image-20230726092852468](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726092852468.png)

![image-20230726093008994](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726093008994.png)

![image-20230726092907002](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726092907002.png)

ç°åœ¨çš„ç‰ˆæœ¬æ—©å°±æ²¡äº†innobackupexuè¿™ä¸ªæ–‡ä»¶äº†ï¼Œå¯èƒ½2.4ä»¥åè¿˜ä¿ç•™äº†å®ƒä½œä¸ºxtrabackupçš„è½¯è¿æ¥ï¼Œè¿™æ˜¯è€ƒè™‘ä¸€éƒ¨åˆ†äººçš„ä½¿ç”¨ä¹ æƒ¯ï¼Œåé¢å¹²è„†å°±è¿è½¯è¿æ¥éƒ½éƒ½æ²¡æœ‰äº†ã€‚



### xtrabackupçš„ç”¨æ³•







--defaults-file --user  --password --hosts --databases å°±ç™»å…¥çš„ç”¨æˆ·åå’Œå¯†ç ï¼Œç™»å…¥ä¸»æœºï¼Œå¤‡ä»½çš„æ•°æ®åº“

--defaults-fileæ˜¯è¯»å–é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚/etc/my.cnfï¼Œè¿™ä¸ªé€‰é¡¹è¦ç½®é¡¶

--incremental --incremental-basedirï¼Œå¢é‡å¤‡ä»½ï¼Œå·²ç»åŸºäºå‰ä¸€æ¬¡å…¨å¤‡æˆ–å¢å€çš„ç›®å½•ã€‚

å·®å¼‚å¤‡ä»½ã€å¢é‡å¤‡ä»½çš„åŒºåˆ«

å¢é‡å¤‡ä»½ï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡åˆ°å‰é¢å»ï¼Œä¸ä¸€å®šèƒ½å¤Ÿæ˜¯ç´§æ¥ç€ä¸Šä¸€æ¬¡çš„å¢é‡ã€‚

![image-20230726100241132](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726100241132.png)

--incremental-dirï¼šæ˜¯æŒ‡å®šè¿˜åŸå¤‡ä»½çš„å¢é‡å¤‡ä»½çš„ç›®å½•

--include=nameï¼šæŒ‡å®šæ ‡æ˜ï¼Œæ ¼å¼ï¼šdatabasename.tablename



xtrabackupå¤‡ä»½è¿˜åŸå¤§è‡´åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š

1ã€å¤‡ä»½

ä¸Šé¢ä¸€å°æ®µæ–‡å­—å°±æ˜¯è®²çš„å¤‡ä»½ï¼›

2ã€é¢„å¤„ç†ï¼šçœ‹åˆ°è¿™å°±ä¼šæƒ³åˆ°mysqldumpçš„æ—¶å€™å­˜åœ¨è¿™äº›æƒ…å†µçš„å§ï¼Œè¿™ä¸ªæœ€å¸¸ç”¨çš„mysqldumpæ€ä¹ˆè€ƒè™‘å’Œå¤„ç†è¿™äº›äº‹æƒ…çš„å‘¢ï¼Ÿå°è±¡ä¸­mysqldumpä¹Ÿå°±æ˜¯skip-networkä¸€ä¸‹ç„¶åå¼€å¯å•ä¸ªäº‹åŠ¡å¤‡ä»½ï¼Œè¿˜åŸå°±å®Œäº†

![image-20230726104942694](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726104942694.png)

3ã€è¿˜åŸ



ä¸‹é¢è®²è®²ç»†èŠ‚

![image-20230726114003472](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726114003472.png)

å›¾ä¸­æ²¡æœ‰ç”»å‡ºâ‘ ï¼Œâ‘ å…¶å®å°±æ˜¯ç¬¬ä¸€æ­¥å¤‡ä»½å’¯ï¼›"â‘¢å°±æ˜¯è¿˜åŸï¼Œå°±æ˜¯ç­‰ç¬¬â‘¡æ­¥é¢„å¤„ç†å®Œäº†å¾—åˆ°å®Œå…¨çš„æ•°æ®åº“æ–‡ä»¶åï¼Œå¤åˆ¶åˆ°/var/lib/mysql/ä¸‹ï¼Œå°±æ˜¯è¿™ä¹ˆä¸ªæ„æ€ã€‚"

â‘¡å°±æ˜¯é¢„å¤„ç†ï¼›æ˜¯å°†1çš„å…¨å¤‡å’Œ2ã€3çš„å¢é‡æ•´åˆåœ¨ä¸€èµ·ï¼Œè¿™ä¸ªæ•´åˆå¹¶ä¸ç®€å•ã€‚



![image-20230726114827201](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726114827201.png)

çœ‹è¿™ä¸ªå›¾ï¼Œå°±èƒ½çœ‹å‡ºæ¥xtrabackupæ¯”myslqdumpä¸“ä¸šçš„åœ°æ–¹äº†ï¼Œå°±æ˜¯æ‹…å¿ƒä½ mysqldumpåœ¨åšåœæœæˆ–è€…dumpçš„æ—¶å€™å­˜åœ¨è·¨è¶Šå¤‡ä»½æ—¶é—´èŠ‚ç‚¹çš„äº‹åŠ¡--å›¾ä¸­t1äº‹åŠ¡ã€‚

æ¥ï¼Œé‡æ–°è®²è®²ä¸Šå›¾ï¼Œå½“è¿›è¡Œå¤‡ä»½çš„æ—¶å€™ï¼Œæ¯”å¦‚2è¿™ä¸ªå¢é‡å¤‡ä»½çš„èŠ‚ç‚¹ï¼Œæœ‰ä¸€ä¸ªt1äº‹åŠ¡è¿›è¡Œäº†ä¸€åŠï¼Œæ­¤æ—¶2èŠ‚ç‚¹å¤„å¤‡ä»½ä¸‹æ¥çš„äº‹åŠ¡logè‚¯å®šä¼šå›æ»šï¼Œå›æ»šåˆ°å‰é¢ï¼›è¿˜æœ‰ä¸€ä¸ªt2äº‹åŠ¡å®ƒæ˜¯å·²ç»æ‰§è¡Œå®Œäº†åœ¨2èŠ‚ç‚¹å¤‡ä»½åŠ¨ä½œçš„æ—¶å€™å°±å·²ç»æ‰§è¡Œå®Œäº†ã€‚æ‰€ä»¥2èŠ‚ç‚¹å¤‡ä»½çš„ä¸œè¥¿ä¸æ˜¯ä¸€ä¸ªæ—¶é—´èŠ‚ç‚¹çš„äº†ï¼Œå› ä¸º2èŠ‚ç‚¹æœ¬æ¥å¤‡ä»½çš„èŠ‚ç‚¹ç†è®ºä¸Šæ—¶é—´èŠ‚ç‚¹æ˜¯ä¸€è‡´çš„ï¼Œä½†æ˜¯t1ç”±äºæ˜¯åŠä¸ªäº‹åŠ¡ï¼Œæ˜¯åæ¥å›æ»šäº†çš„ï¼Œæ•°æ®è‡ªç„¶å°±ä¸ä¸€è‡´äº†ã€‚è¿™ä¸ªè¯´æ³•å¯¹å—ï¼Œt1åœ¨äº‹åŠ¡é‡Œï¼Œå¤–ç•Œæ˜¯å¯é‡å¤è¯»ï¼Œå“ªæ€•commitä¹Ÿæ˜¯å¯é‡å¤è¯»çš„ï¼Œæ‰€ä»¥ä¸ä¼šå½±å“å¤–ç•Œå§ï¼Œå¯¹äºå¤–ç•Œæ¥è®²t1æ˜¯ä¸å­˜åœ¨çš„å¯¹å§ï¼Ÿé—®é¢˜æ˜¯ï¼Œå‰ä¸€åŠäº‹åŠ¡ä½ å…¶å®å¤‡ä¸‹æ¥äº†åªä¸è¿‡æ˜¯å›æ»šäº†ï¼Œåä¸€åŠäº‹åŠ¡åœ¨3èŠ‚ç‚¹å¤„å…¶å®ä¹Ÿæ˜¯åœ¨åä¸€ä¸ªå¢é‡å¤‡ä»½é‡Œå¤‡ä»½ä¸‹æ¥äº†ï¼Œæ‰€ä»¥t1çš„å‰ä¸€åŠäº‹åŠ¡ä¸è¦å›æ»šï¼Œè€Œæ˜¯ç­‰åé¢ä¸€ä¸ªå¢é‡å¤‡ä»½åå†å»æ‹¼t2çš„åä¸€åŠäº‹åŠ¡ï¼Œå¦åˆ™æ•´ä½“ä¸Št1å°±ä¸¢äº†ï¼Œä¸€æ—¦t1ä¸¢äº†ï¼Œè¿™ä¸ªæ•´ä½“äº‹åŠ¡ä¸¢äº†ï¼Œé‚£ä¹ˆå°±å’Œå®é™…æ•°æ®ä¸ä¸€è‡´äº†ï¼ŒåŠæ—¶t1æ‰§è¡Œçš„æ—¶å€™æ˜¯ å¯é‡å¤è¯»ï¼Œå¤–ç•Œæ˜¯ä¸å—å½±å“çš„ï¼Œä½†æ˜¯t1æ•´ä½“æ˜¯ä¼šç»“æŸcommitçš„ï¼Œæ‰€ä»¥å¤–ç•Œå°±å—åˆ°å½±å“äº†çš„ï¼Œæ‰€ä»¥t1çš„äº‹åŠ¡éœ€è¦åˆå¹¶çš„ã€‚

<img src="3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726115224133.png" alt="image-20230726115224133" style="zoom:50%;" />



å¦‚æœ3èŠ‚ç‚¹å¤„ä¹Ÿå‡ºç°äº†æ‰§è¡Œä¸€åŠçš„äº‹åŠ¡ï¼Œé‚£å°±å›æ»šå•Šï¼Œä¹Ÿæ²¡å•¥å¤§é—®é¢˜ã€‚

æ‰€ä»¥æœ€åä¸€ä¸ªå¤‡ä»½ç‚¹çš„è·¨è¶Šäº‹åŠ¡æ‰ä¼šå›æ»šï¼Œè€Œå‰é¢çš„è·¨å¤‡ä»½ç‚¹çš„äº‹åŠ¡æ˜¯éœ€è¦æ•´åˆçš„ï¼Œåšäº†ä¸€åŠçš„äº‹åŠ¡å‡‘å…¨äº†å°±ä¸ä¼šå›æ»šäº†ï¼Œæ‰€ä»¥æ‰æœ‰äº†â‘¡é¢„å¤„ç†æ­¥éª¤ã€‚



æ‰€ä»¥éœ€è¦åœ¨<font color=red>cliä¹Ÿå°±æ˜¯å‘½ä»¤æ•²çš„æ—¶å€™ï¼Œè¦ä½“ç°å‡ºæ˜¯ä¸æ˜¯æœ€åä¸€æ¬¡å¤‡ä»½èŠ‚ç‚¹çš„è¿˜åŸåŠ¨ä½œ</font>ï¼Œå¦‚æœä¸æ˜¯å°±å­˜åœ¨æ‹¼å‡‘ä¸å®Œæ•´äº‹åŠ¡çš„æƒ…å†µçš„ï¼Œæœ‰è¿™ä¸ªæƒ…å†µå°±è¦æ‹¼å‡‘çš„ï¼›å¦‚æœæ˜¯æœ€åä¸€æ¬¡å¤‡ä»½èŠ‚ç‚¹ï¼Œå¦‚æœå­˜åœ¨ä¸å®Œæ•´çš„äº‹åŠ¡å°±å›æ»šå•¦ã€‚è¿™ä¸ªæƒ…å†µç®€ç§°ä¸º <font color=red>"å°å£"</font>ï¼ŒåŒæ ·å­˜åœ¨äºsqlserverå’Œorcaleã€‚

å°å£å°±æ˜¯ä¸å®Œæ•´çš„äº‹åŠ¡ä¸å›æ»šï¼Œç­‰åç»­å¦ä¸€åŠäº‹åŠ¡æ‹¼å‡‘ï¼Œå°±å«åšä¸å°å£ï¼Œè€Œclié‡Œæ˜ç¡®æ˜¯æœ€åä¸€æ¬¡è¿˜åŸ--è¿™ä¸ªåŠ¨ä½œæ‰€æ¶‰åŠåŠä¸ªäº‹åŠ¡æ˜¯ç›´æ¥å›æ»šçš„æ— éœ€ç­‰å¾…å› ä¸ºæ²¡æœ‰åç»­ï¼Œæ‰€ä»¥å°±å«åšå°å£ã€‚è¿™æ˜¯å£è¯­åŒ–æ²Ÿé€šçš„æ—¶å€™å­˜åœ¨è¿™ä¹ˆä¸ªè¯´æ³•ã€‚emmå°±æ˜¯è¡Œå®¶ä¸€å‡ºæ‰‹(å£)å°±çŸ¥æœ‰æ²¡æœ‰ã€‚è£…Bç”¨çš„ç°åœ¨æ˜¯ã€‚å½“ç„¶æ­£é€”å°±æ˜¯ç†è§£åˆ«äººç”¨çš„ï¼Œè‡ªå·±è¯´å‡ºæ¥å°±æ˜¯è£…Bç”¨çš„ã€‚



å¤‡ä»½æ—¶ä¸ä¼šå›æ»šçš„ï¼Œåªæœ‰è¿˜åŸçš„æ—¶å€™æ‰ä¼šå›æ»šï¼æ¯”å¦‚ï¼Œ1èŠ‚ç‚¹åšçš„å¤‡ä»½ï¼Œå¦‚æœä¹Ÿæˆªæ–­äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œæ²¡å…³ç³»ï¼Œå¤‡ä»½é‡Œçš„äº‹åŠ¡åªæœ‰ä¸€åŠæ²¡äº‹ï¼Œå°±æ—¶ä¸€åŠåœ¨é‚£çš„ï¼Œè¿˜åŸçš„æ—¶å€™æ‰ä¼šè¯´è¿™ä¸ªä¸€åŠçš„äº‹åŠ¡å›ä¸å›æ»šã€‚

![image-20230726143116120](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726143116120.png)

å¦‚æœä½ å°±æ˜¯é‚£2èŠ‚ç‚¹çš„å¤‡ä»½è¿›è¡Œè¿˜åŸï¼Œé‚£å°±æ˜¯è¦å›æ»šå•¦ï¼Œå°å£åœ¨å“ªé‡Œï¼Œé‚£é‡Œå°±å›æ»šã€‚

è¿˜åŸçš„æ—¶å€™ï¼Œæœ€åä¸€æ¬¡ä½ å®šåœ¨é‚£é‡Œï¼Œé‚£é‡Œå°±ä¼šå›æ»šã€‚



å¤‡ä»½CLIçš„é€‰é¡¹è§åé¢å®éªŒï¼Œç„¶åxtrabackupå¤‡çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆä¸€äº›è¾…åŠ©æ–‡ä»¶ï¼Œæ¯”å¦‚xtrabackup_infoæ–‡ä»¶ç”¨æ¥è®°å½•å·¥å…·çš„ç‰ˆæœ¬ã€cliç”¨äº†å“ªäº›é€‰é¡¹ã€èŠ±è´¹äº†å¤šé•¿æ—¶é—´ã€å¤‡ä»½äº†LSN--æ—¥å¿—çš„åºåˆ—å·ã€‚



è¿™ä¸ªLSNå·å…¶å®ç±»ä¼¼binglogçš„ä½ç½®ï¼Œæ˜¯OSç»„ç»‡æ•°æ®ä»¥PAGEä¸ºå•ä½ç±»ä¼¼å—çš„æ¦‚å¿µï¼Œç„¶åè¿™ä¸ªPAGEçš„

![image-20230726162959303](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726162959303.png)

![image-20230726163832888](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726163832888.png)



### ç»§ç»­è§£é‡Šä¸‹LSNï¼š

ç£ç›˜ä¸Šçš„DBç»„ç»‡æ•°æ®æ˜¯æŒ‰é¡µpageæ¥å­˜æ”¾çš„ï¼Œ

ç±»ä¼¼block--å—æ˜¯OSä»¥åŠä¸Šæ¬¡FSéƒ½æ˜¯è¿™ä¹ˆç»„ç»‡çš„ï¼Œä¸è¿‡OSçš„å—å’ŒFSæ–‡ä»¶ç³»ç»Ÿçš„å—ä¸æ˜¯ä¸€å›äº‹ã€‚

æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬æ¥æ€»ç»“ä¸‹ï¼Œos-blockï¼Œfs-blockï¼Œdb-page

pageçš„ä¸€ä¸ªå•ä½å®¹é‡è¦æ¯”blockå¤§çš„å¤šäº†å»äº†ï¼Œä¸€åŠyumä¸‹æ¥æˆ–è€…ç¼–è¯‘çš„æ—¶å€™ä¸æ”¹æºç ï¼Œä¹Ÿä¸ä¼šæ”¹å®ƒï¼Œé»˜è®¤å°±æ˜¯16Kbytesä¸€ä¸ªå•ä½åˆ†é…çš„ã€‚

![image-20230726163301181](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726163301181.png)

1ã€æ•°æ®å¤‡ä»½çš„æ—¶å€™ï¼Œä¼šè®°å½•PAGEé‡Œçš„ä¸€ä¸ªæ•°å€¼ï¼Œè¿™ä¸ªæ•°å€¼å°±æ˜¯LSN

2ã€LSNå°±æ˜¯äº‹åŠ¡çš„ç¼–å·ï¼Œåœ¨æ•°æ®åº“åšä»»ä½•ä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šæŠŠäº‹åŠ¡æ—¥å¿—çš„ç¼–å·å†™é“PAGEé‡Œå»ã€‚

æ¯”å¦‚PAGEé‡Œéƒ½æ”¾äº†ä¸€äº›æ•°æ®ï¼Œå¦‚æœä½ ä¿®æ”¹äº†æŸä¸ªPAGEé‡Œçš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸ªPAGEé¡µé‡Œå°±ä¼šè®°å½•LSNå·ã€‚è¿™ä¸ªLSNå·åªå¢ä¸å‡ã€‚

![image-20230726164457814](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726164457814.png)

ç°åœ¨æ¥ä¸Šå›¾ç»§ç»­è¯´ï¼Œç°åœ¨xtrabackupå¤‡ä»½æ•°æ®çš„æ—¶å€™ï¼Œå°±ä¼šæŠŠæœ€å¤§çš„äº‹åŠ¡ç¼–å·LSNè®°å½•ä¸‹æ¥ï¼Œæ¯”å¦‚ä¸Šå›¾å°±æ˜¯10002ã€‚

â€‹		ç°åœ¨åˆæœ‰æ–°çš„æ”¹åŠ¨ï¼Œæ¯”å¦‚10002å˜æˆå½“æ—¶çš„äº‹åŠ¡æ—¥å¿—ç¼–å·æ¯”å¦‚æ˜¯ï¼š20000ã€‚

<img src="3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726164834058.png" alt="image-20230726164834058" style="zoom:35%;" />

ç°åœ¨å†ä¸€æ¬¡å¤‡ä»½-åšå¢é‡å¤‡ä»½ï¼Œä¹Ÿå°±æ˜¯è¯´ä»10002ä¸Šæ¬¡å¤‡ä»½çš„ç‚¹åˆ°ç°åœ¨20000è¿™ä¸ªç‚¹ï¼Œä¸­é—´æ¶‰åŠçš„æ•°æ®åšå¢é‡å¤‡ä»½ï¼Œé‚£ä¹ˆå¯¹åº”åˆ°PAGEä¸Šï¼Œä¹Ÿå°±æ˜¯æ¶‰åŠåˆ°çš„å‡ ä¸ªPAGEï¼ˆ15000å’Œ20000è¿™ä¸¤ä¸ªé¡µï¼‰æ‰ä¼šå»å¤„ç†ã€‚

<img src="3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726165432985.png" alt="image-20230726165432985" style="zoom:33%;" />





å°±æ˜¯æ ¹æ®LSNæ¥åˆ¤æ–­å“ªäº›PAGEéœ€è¦å¤‡ä»½ï¼Œå“ªäº›ä¸ç”¨ï¼Œä»è€Œå®ç°å¢é‡å¤‡ä»½ã€‚





![image-20230726171453986](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726171453986.png)

xtrabackup_checkpointsï¼šè¿™ä¸ªå°±æ˜¯æ¶‰åŠå¤‡ä»½æ—¶å€™è®°å½•çš„LSNå’Œå¤‡ä»½åå†è®°å½•ä¸€æ¬¡çš„LSNï¼Œæ¶‰åŠæ˜¯å…¨å¤‡è¿˜æ˜¯å¢é‡ï¼Œæ¶‰åŠæ˜¯å¦æ˜¯preparedçŠ¶æ€ï¼Œä¹Ÿå³æ˜¯ä¸Šé¢è®²äº†è¿™ä¹ˆå¤šLSNçš„å†…å®¹ä»‹ç»ã€‚



xtrabackup_binlog_infoï¼šåŒæ ·ä¹Ÿä¼šæ¶‰åŠbinlogçš„ä½ç½®è®°å½•ï¼Œä¸Šé¢è®²çš„æ˜¯äº‹åŠ¡æ—¥å¿—çš„ä½ç½®è®°å½•ã€‚

æ‰€ä»¥å¤‡ä»½è¿˜åŸçš„æ—¶å€™ä¹Ÿæ˜¯åŸºäºbinlogçš„ä½ç½®çš„ï¼Œä¸éœ€è¦è®¤ä¸ºä¿®æ”¹ï¼Œç„¶åäº‹åŠ¡æ—¥å¿—ä¼°è®¡æ˜¯ç”¨æ¥"å°å£"--ä¹Ÿå°±æ˜¯å›æ»šå’ŒåŒæ­¥ç”¨çš„å§ã€‚åŒæ­¥å°±æ˜¯commitåè¿˜ç¡®è®¤å†™é“ç£ç›˜é‡Œçš„æ„æ€å’¯ã€‚



backup-my.cnf  å°±æ˜¯å¤‡ä»½é…ç½®æ–‡ä»¶

xtrabackup_logfileï¼šè¯¥å·¥å…·è‡ªèº«çš„æ—¥å¿—è®°å½•ã€‚

![image-20230726173228447](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230726173228447.png)



## ä½¿ç”¨xtrabackupæ¥åšå¤‡ä»½

![image-20230731110634256](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731110634256.png)

è¯´è¦å¯†ç ï¼Œå¥½çš„ï¼Œ

![image-20230731110707502](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731110707502.png)

ç»“æœè¯´xtrabackupç‰ˆæœ¬ä¸æ”¯æŒ

https://mariadb.com/kb/zh-cn/percona-xtrabackup-percona-xtrabackup/

<img src="3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731111147515.png" alt="image-20230731111147515" style="zoom:50%;" />



çœ‹çœ‹è§†é¢‘é‡Œè€çš„ç‰ˆæœ¬çš„æ—¶å€™ï¼Œæ”¯æŒçš„æƒ…å†µå§

![image-20230731111515611](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731111515611.png)

![image-20230731111643427](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731111643427.png)

å›¾ä¸­å¯è§mysqlæ˜¯MyISAMçš„ï¼Œæ‰€ä»¥æœ¬è´¨ä¸Šå°±æ˜¯é”è¡¨+å¤åˆ¶ã€‚

ä¸€äº›å¤‡ä»½äº§ç”Ÿçš„æ–‡ä»¶

![image-20230731112025471](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731112025471.png)

é™¤äº†ä¸ªåˆ«ä¹‹å‰å°±æœ‰ğŸ‘‡![image-20230731112108485](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731112108485.png)

binllogä½ç½®ğŸ‘‡

![image-20230731112241039](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731112241039.png)



![image-20230731122143821](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731122143821.png)

ä¸Šå›¾å°±æ˜¯åšäº†ä¸€æ¬¡å…¨å¤‡ï¼Œä»lsn=0åˆ°lsn=1541816

compact=0åº”è¯¥æ˜¯æ²¡æœ‰å‹ç¼©

![image-20230731122458994](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731122458994.png)

ğŸ‘†è¿™æ˜¯å¤‡ä»½è¿‡ç¨‹çš„ä¸€äº›ä¿¡æ¯ã€‚



![image-20230731122622996](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731122622996.png)

è¿™æ˜¯ä¸ªdataæ–‡ä»¶ï¼Œçœ‹ä¸äº†ã€‚



è¿™äº›å°±æ˜¯å¤‡ä»½ä¸‹æ¥çš„æ–‡ä»¶äº†ğŸ‘‡

![image-20230731122803317](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731122803317.png)



### ä¸‹é¢å°±æ˜¯æ¢å¤ä¹Ÿå°±æ˜¯è¿˜åŸï¼Œ2å¤§æ­¥

### ç¬¬ä¸€æ­¥ï¼Œé¢„å¤„ç†ï¼Œå°±æ˜¯ä¸Šæ–‡è®²çš„å¾—åˆ°ä¸€ä¸ªå®Œæ•´çš„æ•°æ®

xtrabackup --prepare --target-dir=/backup/

scp -r /backup/* ç›®æ ‡ä¸»æœº:/backup         # å°†å¤‡ä»½æ–‡ä»¶scpåˆ°éœ€è¦è¿˜åŸå¾—æœºå™¨ä¸Š

### ç¬¬äºŒæ­¥ï¼Œè¿˜åŸï¼Œä¹Ÿå°±æ˜¯å°†é¢„å¤„ç†å¾—åˆ°çš„å®Œæ•´æ•°æ®å¤åˆ¶è¿‡å»

![image-20230731134720019](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731134720019.png)

é…ç½®æ–‡ä»¶é‡Œçš„datadirå¯ä»¥é‡æ–°å®šä¹‰ğŸ‘†ï¼Œä¸ä¸€å®šè¦å’ŒåŸæ¥ä¸€æ ·ã€‚

![image-20230731134921162](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731134921162.png)



xtrabackup --copy-back --target-dir=/backup/     				# ä¸ç”¨æŒ‡å®šæ•°æ®åº“çš„å­˜æ”¾è·¯å¾„ï¼Œä¼šè‡ªåŠ¨è¯»å–/etc/my.cnfé…ç½®æ–‡ä»¶é‡Œçš„è·¯å¾„

![image-20230731152433834](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731152433834.png)

å¦‚å›¾ï¼Œå¯è§/data/mysqlè·¯å¾„æ˜¯è‡ªåŠ¨è¯»å–é…ç½®æ–‡ä»¶é‡Œçš„è¿›è¡Œå¤åˆ¶è¿‡å»çš„ï¼Œæ‰€ä»¥å¤‡ä»½çš„dbè·¯å¾„å’Œè¿˜åŸçš„dbå­˜æ”¾è·¯å¾„å¯ä»¥ä¸ä¸€è‡´çš„ã€‚



å¤åˆ¶çš„æ—¶å€™ï¼Œè¦ä¿è¯æ•°æ®åº“ä¸èƒ½å¯åŠ¨ï¼Œç›®æ ‡æ–‡ä»¶å¤¹å¾—ä¸ºç©ºã€‚

æ‰€ä»¥è¿˜åŸå¾—æ—¶å€™ï¼Œéƒ½ä¼šå½±å“ä¸šåŠ¡ï¼Œæºæ•°æ®åº“å¾—æ¸…ç©ºã€‚



### æœ€åï¼Œæ¢å¤ä¸‹æ–‡ä»¶å¾—æƒé™

chown -R mysql:mysql /var/lib/mysql

systemctl start mariadb

![image-20230731152724005](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731152724005.png)





## xtrabackupå¢é‡å¤‡ä»½å’Œè¿˜åŸ

![image-20230731153209815](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731153209815.png)



--target-dir=/backup/base   æ–‡ä»¶å¤¹ä¸éœ€è¦æ‰‹åŠ¨åˆ›å»ºï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆçš„ã€‚

--incremental-basedir=/backup/<font color=red>base</font>    æŒ‡å®šåŸºäºä¸Šä¸€æ¬¡å…¨å¤‡çš„å¢é‡ã€‚

--incremental-basedir=/backup/<font color=red>inc1</font>     å¢é‡å°±æ˜¯åŸºäºå‰ä¸€æ¬¡çš„å¢é‡ç»§ç»­çš„



![image-20230731170751782](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731170751782.png)

è¿˜åŸçš„æ—¶å€™å°±è¦æ¶‰åŠå›æ»šäº†ï¼Œæ¶‰åŠæ˜¯å¦å›æ»šï¼Œä¹Ÿå°±æ˜¯é»‘è¯-å°ä¸å°å£ã€‚

å…¶å®åªæœ‰æœ€åä¸€æ¬¡è¿˜åŸæ‰ä¼šå°å£ï¼Œæ‰ä¼šå›æ»šï¼Œå‰é¢çš„éƒ½ä¸ä¼šå›æ»š--ä¸ä¼šå°å£ã€‚

--apply-log-only å°±æ˜¯ä»…ä»…åº”ç”¨æ—¥å¿—ï¼Œå°±æ˜¯ä»…ä»…æ¢å¤æ—¥å¿—ï¼Œä½†æ˜¯ä¸åšæ—¥å¿—çš„å›æ»šã€‚

å…¶å®æœ€åä¸€æ¬¡ä¹Ÿå¯ä»¥åŠ ä¸Š--apply-log-onlyå»è®©ä»–ä¸åšå›æ»šï¼Œæ— æ‰€è°“ï¼Œå¤§ä¸äº†å°±æ˜¯åšäº†ä¸€åŠçš„æœªæäº¤çš„äº‹åŠ¡ï¼Œä½ å¯åŠ¨æ•°æ®åº“æœåŠ¡çš„æ—¶å€™ä¹Ÿä¼šç»™ä½ è‡ªåŠ¨å›æ»šçš„ã€‚åæ­£æ²¡æäº¤å˜›æœ‰ä»€ä¹ˆå…³ç³»ã€‚



#### ä¸‹é¢æ˜¯å®éªŒ

æ¸…ç†ä¸€ä¸‹å¤‡ä»½æ–‡ä»¶å¤¹

![image-20230731174530919](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731174530919.png)

â‘ åšä¸€ä¸ªå…¨å¤‡

![image-20230731174707467](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731174707467.png)

å…¨éƒ¨åšå¥½äº†ğŸ‘‡

![image-20230731175302392](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731175302392.png)

â‘¡å¢åŠ ç‚¹æ•°æ®

![image-20230731175455050](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731175455050.png)

è¿™æ˜¯ç¬¬ä¸€æ¬¡åšå¢é‡å¤‡ä»½ï¼ŒåŸºäºbaseå†…å®¹åšçš„ç¬¬ä¸€æ¬¡å¢é‡å¤‡ä»½

![image-20230731175700132](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731175700132.png)

![image-20230731175740658](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731175740658.png)

inc1å¢é‡æ–‡ä»¶å°±å‡ºæ¥äº†ğŸ‘†è€Œä¸”åšå¢é‡æ˜¯èƒ½å¤Ÿå¾ˆå¥½çš„èŠ‚çº¦ç£ç›˜ç©ºé—´çš„ï¼Œä¸”èƒ½æä¾›å¤‡ä»½é€Ÿåº¦çš„å› ä¸ºå¤‡ä»½çš„æ•°æ®å°‘å•Šã€‚

![image-20230731175920575](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731175920575.png)



â‘¢ç¬¬äºŒæ¬¡å¢é‡å¤‡ä»½å‰ï¼Œå†æ”¹æ”¹æ•°æ®

![image-20230731180155740](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731180155740.png)

ç„¶ååšç¬¬äºŒæ¬¡å¢é‡å¤‡ä»½

![image-20230731180553983](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731180553983.png)

ğŸ‘†æ³¨æ„--target-diræ˜¯åŸºäºä¸Šä¸€æ¬¡çš„å¢é‡æ–‡ä»¶ï¼Œæ¥åš--incremental-basediræ–°çš„å¢é‡æ–‡ä»¶ã€‚



åˆ°æ­¤ï¼Œåšäº†â‘ å…¨å¤‡â‘¡ç¬¬ä¸€æ¬¡å¢å¤‡â‘¢ç¬¬äºŒæ¬¡å¢å¤‡ã€‚

![image-20230731180731054](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731180731054.png)

å¤åˆ¶åˆ°æ–°çš„ä¸€å°æœºå™¨ä¸Š

![image-20230731180847727](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731180847727.png)



â‘£ç„¶åå¼€å§‹è¿˜åŸï¼Œåœ¨æ–°çš„æœºå™¨ä¸Š

è¿˜åŸ2å¤§éƒ¨ï¼Œé¢„å¤„ç† å’Œ å¤åˆ¶ï¼Œå½“ç„¶chownå’Œrestartæ”¶å°¾ä¹Ÿæ˜¯è‡ªç„¶ã€‚

ç°åœ¨æ˜¯23Mçš„æ–‡ä»¶

<img src="3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731181144708.png" alt="image-20230731181144708" style="zoom:50%;" /> 

å› ä¸ºæœ‰3ä¸ªå¤‡ä»½æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦åˆ†åˆ«æ•´ç†ä¹Ÿå°±æ˜¯é¢„å¤„ç†3æ¬¡ã€‚

4.1  ç¬¬ä¸€æ¬¡prepare

![image-20230731181313289](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731181313289.png)

ç„¶åå°±ä¼šå‘ç°

<img src="3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731181634588.png" alt="image-20230731181634588" style="zoom:50%;" /> 

è¿™ä¸ª/backup/baseå…¨å¤‡æ–‡ä»¶å˜å¤§äº†ï¼Œçœ‹æ¥ï¼Œé¢„å¤„ç†å°±æ˜¯å°†å¢é‡å¤‡ä»½æ–‡ä»¶å¾€å‰é¢çš„å…¨å¤‡é‡Œæ·»åŠ å•Šã€‚

4.2 ç¬¬äºŒæ¬¡prepareğŸ‘‡

![image-20230731181924837](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731181924837.png)

![image-20230731182018283](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731182018283.png)

ç„¶åå‘ç°inc1å˜å¤§äº†ï¼Œbaseæ²¡å˜è¿˜æ˜¯28ï¼Œæ²¡å…³ç³»ï¼Œå®ƒå†…éƒ¨æœ‰ä¸€äº›æœºåˆ¶ï¼Œä¸è¿‡æœ€ç»ˆç¡®å®æ˜¯å¾€baseé‡Œæ•´çš„ã€‚

4.3 ç¬¬ä¸‰æ¬¡prepare

![image-20230731182150661](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731182150661.png)

ä¹Ÿæ˜¯å°†inc2å¾€baseé‡Œæ•´å’Œå•Š

æ­¤æ—¶ğŸ‘‡

![image-20230731182318698](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731182318698.png)



â‘¤å°†ä¸Šé¢ç¬¬4æ­¥æ•´åˆå¥½çš„æ–‡ä»¶å¤åˆ¶è¿‡å»ï¼Œä¸è¿‡æ˜¯ç”¨xtrabackupçš„cliè¿›è¡Œå¤åˆ¶çš„ï¼Œè€Œä¸”è¦å…ˆæ¸…ç©ºç›®æ ‡åº“æ–‡ä»¶å¤¹ã€‚

![image-20230731182558480](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731182558480.png)

æ³¨æ„ä¿ç•™æ–‡ä»¶å¤¹ï¼Œè¿™æ ·å°±ä¸ç”¨é‡æ–°å»ºå†æ”¹æ‰€æœ‰è€…äº†ã€‚



åœæœ

![image-20230731182713642](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731182713642.png)

å›¾ä¸­ğŸ‘†ç”±äºæ˜¯æœåŠ¡å™¨å¼€å¯çš„çŠ¶æ€è¿›è¡Œrm -rf /data/mysql/*çš„ï¼Œè§†é¢‘ä¸­çš„è€å¸ˆæ€•æœåŠ¡åœæ‰ä¼šäº§ç”Ÿä»€ä¹ˆæ–‡ä»¶æ¯”å¦‚æ—¥å¿—å•¥çš„å§ä¹Ÿè®¸ï¼Œæ‰€æœ‰åˆll /data/mysql/ç¡®è®¤æ˜¯ç©ºæ‰æ”¾å¿ƒã€‚



![image-20230731182931328](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731182931328.png)

ğŸ‘†å¤åˆ¶è¿‡å»ï¼Œå°±å¥½äº†ä¸Šé¢å‘½ä»¤æ•²å®ŒğŸ‘‡å°±æœ‰äº†å¦‚ä¸‹å†…å®¹ï¼š

![image-20230731183145449](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731183145449.png)

å¤§å°çœ‹çœ‹![image-20230731183241016](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731183241016.png)

åŸæ¥çš„æ•°æ®æ–‡ä»¶å¤§å°è¦å°ä¸€ç‚¹ï¼Œ

![image-20230731183332358](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731183332358.png)

å› ä¸ºè¿˜åŸå‡ºæ¥çš„ä¼šåˆä¸€äº›xtrabackup_*æ–‡ä»¶



â‘¥ä¿®æ”¹å±æ€§å’Œå¯åŠ¨æœåŠ¡

![image-20230731183507528](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731183507528.png)



â‘¦éªŒè¯æ•°æ®

![image-20230731183610834](3-mysqldumpå®æˆ˜å’Œxtrabackupä»‹ç».assets/image-20230731183610834.png)



ä»¥ä¸Šå°±æ˜¯xtrabackupçš„å†…å®¹ï¼Œä¸è¿‡ç°åœ¨ä¹ŸçŸ¥é“è¿™ä¸ªä¸æ¨èäº†ï¼Œè™½ç„¶è¿˜ä¸é”™ã€‚ä¸è¿‡å‘¢ï¼Œä¹Ÿå¯ç”¨ç”¨perconaçš„DBï¼Œé‚£æ ·å¤‡ä»½çš„æ–¹å¼å¯èƒ½å°±å’Œxtrabackupä¸€æ ·äº†ï¼Œä¸è¿‡xtrabackupè™½ç„¶ä¸ç”¨äº†ï¼Œä½†æ˜¯å®ƒçš„æ€è·¯è‚¯å®šæ˜¯å¿…é¡»è¦è´¦åŠ¡çš„ã€‚







