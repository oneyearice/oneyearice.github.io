# 7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.md







# åŸºäºVRRP Script å®ç°å…¶ä»–åº”ç”¨çš„HA

**nginxå’Œhaproxyçš„æœåŠ¡HA**

ä¸Šé¢è®²äº†virtual_serverè‡ªå¸¦é›†æˆçš„è¯­å¥å—å®ç°äº†LVSçš„HAï¼Œä¸‹é¢ç”¨è„šæœ¬æ›²çº¿æ•‘å›½äº†



![image-20241223151715056](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241223151715056.png)



![image-20241223181016176](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223181016176.png)







åˆ©ç”¨kill 0  æ£€æŸ¥è¿›ç¨‹æ˜¯å¦OK

![image-20241223152122691](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241223152122691.png)



![image-20241223152109718](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241223152109718.png)



![image-20241223153012907](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241223153012907.png)

åªæ˜¯æ£€æŸ¥è¿›ç¨‹æ­»æ´»ï¼Œå¹¶ä¸ä»£è¡¨å¥½åï¼Œcurlæ‰æ˜¯ä¸šåŠ¡çš„æ£€æŸ¥







# haproxy+keepalived



```bash
yum -y install haproxy

vim /etc/haproxy/haproxf.cfg
	...
	# ç»“å°¾åŠ ä¸Š
	listen www.ming.org_80
    bind 192.168.126.100:80
    server server1 192.168.126.138:80 check
    server server2 192.168.126.139:80 check


```

![image-20241223161351491](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223161351491.png)



ä½†æ˜¯haproxyçš„bindåœ°å€è¦å­˜åœ¨çš„ï¼ŒVIPæ²¡æœ‰è½åœ¨çš„ä»èŠ‚ç‚¹æ˜¯æ²¡æœ‰è¿™ä¸ªIPçš„ï¼Œæ‰€ä»¥haproxyæœåŠ¡èµ·ä¸æ¥

![image-20241223162454355](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223162454355.png)

é€šè¿‡journalct -uå¯è§ğŸ‘‡

![image-20241223162441999](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223162441999.png)

### ä¿®æ”¹å†…æ ¸å‚æ•°ä½¿å¾—haproxyç›‘å¬åœ¨VIP(æ²¡è½è¿‡æ¥-ä»èŠ‚ç‚¹)ä¸Š

![image-20241223163202181](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223163202181.png)

```bash
echo "net.ipv4.ip_nonlocal_bind = 1" >> /etc/sysctl.conf
sysctl -p
```

![image-20241223163401650](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223163401650.png)

æ­¤æ—¶å°±å¯ä»¥äº†

![image-20241223163439020](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223163439020.png)

åŒæ ·ä¸»èŠ‚ç‚¹ä¹Ÿè¦é…ç½®å¦åˆ™VIPé£˜èµ°äº†ï¼Œhaproxyåˆ°æ—¶å€™å°±èµ·ä¸æ¥äº†

![image-20241223163513774](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223163513774.png)



![image-20241223173721279](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223173721279.png)



åˆ é™¤ä¹‹å‰å®éªŒçš„lvsé…ç½®å°±æ˜¯vsçš„è¯­å¥å—ï¼Œä¸»ä»éƒ½åˆ ï¼Œè¿™äº›é…ç½®ä¼šå¯¼è‡´lvsçš„è½¬å‘è§„åˆ™ğŸ‘‡ï¼Œæ¸…å¹²å‡€å°±è¡Œï¼Œå’Œhaproxyå†²çªäº†

![image-20241223174253677](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223174253677.png)



**æµ‹è¯•OK**

![image-20241223175226212](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241223175226212.png)





### å®ç°haproxyçš„HA

è¦å®ç°haproxyæŒ‚äº†ï¼Œkeepavliedçš„VIPä¹Ÿè¦åˆ‡èµ°



æŠŠè„šæœ¬å†™åˆ°keepalivedçš„ä¸»é…ç½®æ–‡ä»¶é‡Œï¼Œæ¨èè¿™ä¹ˆåšï¼Œä»¥ä¾¿å¤ç”¨

```bash
[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

vrrp_script check_down {
    # ç¿»è¯‘ä¸‹ğŸ‘‡ï¼šå¦‚æœæ–‡ä»¶ä¸å­˜åœ¨å°±ä¸ºTrueï¼ŒçœŸå°±æ˜¯ä¸æ‰§è¡Œä¸‹é¢çš„æ“ä½œOPTIONS(interval\weight\fall\rise\timeoutè¿™äº›)ï¼›å¦‚æœæ–‡ä»¶å­˜åœ¨(æ–‡ä»¶è¢«åˆ›å»ºå‡ºæ¥äº†)å°±ä¸ºfasleå‡-é‚£ä¹ˆå°±ä¼šæ‰§è¡Œä¸‹é¢çš„OPTIONSç‰¹åˆ«æ—¶weightæƒé‡-30ã€‚
	script "[ ! -f /etc/keepalived/down ]"
	interval 1
	# è¿™ä¸ªæƒé‡å°±æ˜¯vrrpçš„ä¼˜å…ˆçº§ï¼Œå…·ä½“æ—¶åœ¨å­é…ç½®æ–‡ä»¶vrrpè¯­å¥å—é‡Œå®šä¹‰çš„
	weight -30
	fall 3
	rise 2
	timeout 2
}

include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@ka01 ~]#


# è°ƒç”¨ä¸Šé¢å®šä¹‰çš„è„šæœ¬
[root@ka01 ~]# vim /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    #nopreempt
    preempt_delay 10
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }
    unicast_src_ip 10.1.1.1
    unicast_peer{
        10.1.1.2
    }

    #notify_master "/apps/keepalived/bin/notify.sh master"
    #notify_backup "/apps/keepalived/bin/notify.sh backup"
    #notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept

    track_script {
        check_down
    }
}

```



ä¸»ä»keepalivedèŠ‚ç‚¹éƒ½é…ç½®ä¸‹

ç„¶åç”±äºæ­¤æ—¶è„šæœ¬åˆ¤æ–­åŸåˆ™æ˜¯ï¼šscript "[ ! -f /etc/keepalived/down ]"ï¼Œæ‰€ä»¥æ­¤æ—¶è¯¥downæ–‡ä»¶ä¸å­˜åœ¨=>å–éä¸ºçœŸï¼Œæ‰€ä»¥è„šæœ¬æ‰§è¡Œä¸ºçœŸï¼Œå°±ä¸ä¼šå¯ç”¨è¯­å¥å—ä¸‹é¢çš„é…ç½®é¡¹ã€‚ä¹Ÿå°±ä¸ä¼šåˆ‡ä¸»ï¼ŒVIPä¸ä¼šé£˜ã€‚



æµ‹è¯•ï¼Œåˆ‡æ¢ï¼Œåªéœ€è¦åˆ›å»ºè¯¥æ–‡ä»¶å°±è¡Œäº†

![image-20241224112314916](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224112314916.png)



![image-20241224112333046](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224112333046.png)



åˆ›å»ºæ–‡ä»¶è§¦å‘è„šæœ¬ğŸ‘‡ï¼Œä¸»ä»åˆ‡æ¢ï¼ŒVIPæ¼‚ç§»äº†

![image-20241224112553634](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224112553634.png)



![image-20241224112639100](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224112639100.png)



ç»§ç»­åœ¨ä»èŠ‚ç‚¹æµ‹è¯•ï¼Œåˆ›å»ºdownæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°VIPå°±è®©å‡ºå»äº†ğŸ‘‡

![image-20241224113325775](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224113325775.png)

ä¸¤è¾¹éƒ½æœ‰è„šæœ¬æ‰§è¡Œå¤±è´¥çš„æƒ…å†µï¼Œæ‰€ä»¥è¿˜æ˜¯çœ‹å„è‡ªåŸå§‹ä¼˜å…ˆçº§éƒ½å‡å»weightåçš„å¤§å°äº†ã€‚



![image-20241224114430472](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224114430472.png)

æ³¨é‡Šæ‰nopreempt è§‚å¯Ÿå¯è§

![image-20241224114458397](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224114458397.png)

æ¢å¤äº†

![image-20241224114508699](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224114508699.png)



<img src="7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224115835274.png" alt="image-20241224115835274" style="zoom:50%;" />





### åˆ©ç”¨killallå®ç°haproxyçš„æ£€æŸ¥-ä¸æ˜¯å¾ˆä¸¥è°¨

é”™è¯¯å†™æ³•

![image-20241224144457000](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224144457000.png)

è„šæœ¬åé¢ ä¸è¦æ€»æ˜¯å¸¦[]æ–¹æ‹¬å·ï¼Œè¿™ç§teståˆ¤æ–­æ˜¯å¦ä¸ºæ¯”è¾ƒç»“æœä¸ºçœŸçš„è¯­æ³•ï¼ŒğŸ‘†ä¸Šå›¾ä¸€å®šä¼šä¸¢å¤±VIPçš„ï¼Œä¸»å˜ä»çš„ï¼Œå› ä¸ºè„šæœ¬å­˜åœ¨é”™è¯¯ğŸ‘‡

![image-20241224145100368](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224145100368.png)

ç„¶åreloadåçœ‹statusæœç„¶æ˜¯2ğŸ‘‡

![image-20241224144934967](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224144934967.png)



å»æ‰æ–¹æ‹¬å·å°±è¡Œ

```bash
[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

vrrp_script check_down {
        script "[ ! -f /etc/keepalived/down ]"
        interval 1
        weight -30
        fall 3
        rise 2
        timeout 2
}

vrrp_script check_haproxy {
        script "/usr/bin/killall -0 haproxy"
        interval 1
        weight -30
        fall 3
        rise 2
        timeout 2
}


include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@ka01 ~]#

[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    #nopreempt
    preempt_delay 10
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }
    unicast_src_ip 10.1.1.1
    unicast_peer{
        10.1.1.2
    }

    #notify_master "/apps/keepalived/bin/notify.sh master"
    #notify_backup "/apps/keepalived/bin/notify.sh backup"
    #notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept

    track_script {
        check_down
        check_haproxy
    }
}
[root@ka01 ~]#

```

reloadå³å¯ï¼Œä¸æ”¾å¿ƒrestartéƒ½æ²¡æœ‰é—®é¢˜

VIPä¹Ÿåœ¨ï¼Œæ²¡é—®é¢˜

![image-20241224145621588](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224145621588.png)

åœæ‰haproxyè§‚å¯Ÿæ˜¯å¦åˆ‡æ¢ä¸»ä»

![image-20241224145930208](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224145930208.png)



#### è¿˜å¯ä»¥å†™è„šæœ¬å»è°ƒç”¨ï¼Œè¿™é‡Œä¾æ—§ä½¿ç”¨ä¸å¤ªä¸¥è°¨çš„killall

```bash
[root@ka01 ~]# cat /etc/keepalived/check_haproxy.sh
#!/bin/bash

/usr/bin/killall -0 haproxy
[root@ka01 ~]#
[root@ka01 ~]# chmod +x /etc/keepalived/check_haproxy.sh
[root@ka01 ~]# ll /etc/keepalived/check_haproxy.sh
-rwxr-xr-x 1 root root 41 Dec 24 15:01 /etc/keepalived/check_haproxy.sh
[root@ka01 ~]#

```

![image-20241224150237288](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224150237288.png)



![image-20241224150437100](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224150437100.png)



![image-20241224150458239](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224150458239.png)

ç”±äºæ˜¯restartï¼Œä¼šå°†VIPè®©å‡ºå»çš„ï¼Œä½†æ˜¯ç”±äºå¼€å¯äº†preempt_delay 10æ‰€ä»¥10såä¼šæŠ¢å›æ¥çš„

<img src="7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224150642062.png" alt="image-20241224150642062" style="zoom:40%;" />

ç„¶ååœæ‰haproxyï¼Œå‘ç°å¯ä»¥å®ç°VIPçš„åˆ‡æ¢çš„ğŸ‘‡

<img src="7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224150804297.png" alt="image-20241224150804297" style="zoom:33%;" />



![image-20241224151508621](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224151508621.png)

ka001ä»100 å‡åˆ°äº†70ï¼Œç„¶åäº¤å‡ºVIPå˜æˆä»äº†ğŸ‘†



ğŸ‘‡è¿™æ˜¯ka01ä¸Šçš„haproxyåˆèµ·æ¥äº†ï¼Œprorityå°±æ¢å¤ä¸º100äº†ï¼Œç„¶å**åˆ**å¼€å¯äº†æŠ¢å ï¼Œå°±å›æ¥äº†ğŸ‘‡

![image-20241224151932936](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224151932936.png)



### ä½†æ˜¯killall -0 ä¹Ÿæœ‰å±€é™æ€§

ä»–åªèƒ½æŸ¥çœ‹è¿›ç¨‹åœ¨ä¸åœ¨ï¼Œä½†æ˜¯è¿›ç¨‹STOPåœ¨é‚£ï¼Œè¿˜æ˜¯æ­£å¸¸è¿è¡Œåœ¨é‚£ï¼Œkillall -0æ˜¯çœ‹ä¸å‡ºæ¥çš„ğŸ‘‡

killall -19 STOPï¼Œkillall -19 æ¢å¤CONT

![image-20241224153358580](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224153358580.png)

æ­¤æ—¶VIPåº”è¯¥åˆ‡èµ°ï¼Œä½†æ˜¯ç”±äºåˆ¤æ–­é€»è¾‘å¯¼è‡´æœªåˆ‡ï¼Œæ‰€ä»¥ä¸šåŠ¡æŒ‚äº†

![image-20241224154930813](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224154930813.png)







### å°±åº”è¯¥ç”¨curlå»æ£€æŸ¥-ç„¶åè¿™ä¹Ÿæ˜¯ä¸€ä¸ªé”™è¯¯çš„æ€è·¯

```bash
[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

vrrp_script check_down {
        script "[ ! -f /etc/keepalived/down ]"
        interval 1
        weight -30
        fall 3
        rise 2
        timeout 2
}

vrrp_script check_haproxy {
		# è¿™ä¸ªæ£€æŸ¥è²Œä¼¼OKï¼Œå…¶å®ä¼šæŠ–åŠ¨çš„ä¸šåŠ¡ï¼Œå› ä¸ºå½“curlçš„ç»“æœä¸æ˜¯0çš„æ—¶å€™å°±æ˜¯falseäºæ˜¯æ‰§è¡Œä¸‹é¢çš„ä¼˜å…ˆçº§æƒé‡é™ä½ï¼Œè®©å‡ºä¸»ï¼ŒVIPé£˜èµ°ï¼Œäºæ˜¯curl å°±å˜æˆäº†trueï¼Œäºæ˜¯VIPå°±æŠ¢å›æ¥äº†ï¼Œæ‰€ä»¥è¿™æ˜¯ä¸€ä¸ªé”™è¯¯çš„æ¡ˆä¾‹ï¼ï¼
        script "/usr/bin/curl -Im1 192.168.126.100"
        interval 1
        weight -30
        fall 3
        rise 2
        timeout 2
}


include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@ka01 ~]#

```



![image-20241224164852718](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224164852718.png)









### æœ€ç»ˆé’ˆå¯¹haproxyè¿˜æ˜¯æ”¹æˆ

![image-20241224164647020](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224164647020.png)

æ‰¾åˆ°è¿›ç¨‹ï¼Œä¸”ä¸æ˜¯STOPçš„å°±è¡Œå•Š

```bash
[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

vrrp_script check_down {
        script "[ ! -f /etc/keepalived/down ]"
        interval 1
        weight -30
        fall 3
        rise 2
        timeout 2
}

vrrp_script check_haproxy {
        script "ps auxf |grep -v color |grep haproxy  |grep -Ev 'T(s|l)'"
        interval 1
        weight -30
        fall 3
        rise 2
        timeout 2
}


include /apps/keepalived/etc/keepalived/conf.d/*.conf


[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    #nopreempt
    preempt_delay 10
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }
    unicast_src_ip 10.1.1.1
    unicast_peer{
        10.1.1.2
    }

    #notify_master "/apps/keepalived/bin/notify.sh master"
    #notify_backup "/apps/keepalived/bin/notify.sh backup"
    #notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept

    track_script {
        check_down
        check_haproxy
    }
}
[root@ka01 ~]#

```

æ­¤æ—¶ç”¨æˆ·è®¿é—®éƒ½OKäº†

![image-20241224164930164](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224164930164.png)



![image-20241224165441153](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224165441153.png)





### æœ€ç»ˆæ”¹æˆè¿™æ ·äº†ğŸ‘‡

![image-20241224171708413](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224171708413.png)



![image-20241224171717052](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224171717052.png)



å¦‚æœä¸ç”¨è„šæœ¬ï¼Œä¼šè¿™æ ·ğŸ‘‡æŠ¥é”™

![image-20241224171807634](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224171807634.png)

ä¸Šå›¾ğŸ‘†ä¸å†™æˆè„šæœ¬ï¼Œæ‰§è¡Œæœ‰é—®é¢˜ï¼Œæ˜æ˜å•æ•²å°±æ˜¯echo $?æ˜¯0æ¥ç€ï¼Œèµ°vrrpé‡Œå°±æ˜¯1ğŸ‘‡ï¼Œæ‰€ä»¥è¿˜æ˜¯å†™æˆè„šæœ¬ã€‚

![image-20241224171846116](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224171846116.png)





# nginxçš„haä¹Ÿç”¨keepalivedæ¥åš



è§‚å¯Ÿnginxçš„é…ç½®æ–‡ä»¶ï¼Œå½“ç„¶ä¸è§‚å¯Ÿä¸€èˆ¬ä¹Ÿæ˜¯å¦‚æ­¤

![image-20241224173032817](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241224173032817.png)

ç«™ç‚¹åä»£ä¹Ÿå¥½ï¼Œé¡µé¢å®å®åœ¨åœ¨çš„å†…å®¹ä¹Ÿç½¢ï¼Œéƒ½æ¨èä¸€ä¸ªç«™ç‚¹å†™åˆ°ä¸€ä¸ªå­é…ç½®æ–‡ä»¶(æ³¨æ„ä»¥.confç»“å°¾)é‡Œï¼Œç„¶åï¼Œä¼˜å…ˆæŠ¢åœ¨ä¸‹é¢çš„server 80ä¸Šã€‚



```bash
[root@ka01 conf.d]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}


vrrp_script check_haproxy {
        script "/etc/keepalived/check_nginx.sh"
        interval 1
        weight -30
        fall 3
        rise 2
        timeout 2
}


include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@ka01 conf.d]#


[root@ka01 conf.d]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    #nopreempt
    preempt_delay 10
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }
    unicast_src_ip 10.1.1.1
    unicast_peer{
        10.1.1.2
    }

    #notify_master "/apps/keepalived/bin/notify.sh master"
    #notify_backup "/apps/keepalived/bin/notify.sh backup"
    #notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept

    track_script {
        check_down
        check_haproxy
    }
}


[root@ka01 conf.d]# cat /etc/keepalived/check_nginx.sh
#!/bin/bash
/usr/bin/ps aux |grep -v color |grep nginx  |grep -Ev 'T(s|l)'
[root@ka01 conf.d]#

```

è¿™ä¸ªnginxæ£€æµ‹è„šæœ¬åªéœ€è¦é…ç½®åœ¨masterä¸Šå°±è¡Œäº†ï¼Œå› ä¸ºä¸»ä¸Šå‘ç°nginxæŒ‚äº†ï¼Œç„¶åè‡ªé™ä¼˜å…ˆçº§ï¼Œè®©å‡ºVIPï¼Œslaveå‡çº§æˆä¸»ï¼Œå‘Šè­¦å‘å‡ºï¼Œç„¶åäººå·¥æˆ–è€…è‡ªåŠ¨ä»‹å…¥ä¿®å¤æ•…éšœï¼Œdelay xxx æŠ¢å›ä¸»ã€‚ä»æ²¡å¿…è¦é…ç½®nginxæ£€æµ‹è„šæœ¬ï¼Œä»çš„nginxæ£€æµ‹å¦‚æœæœ‰æ„ä¹‰å°±æ˜¯ä»èŠ‚ç‚¹æ­¤æ—¶å‡çº§ä¸ºä¸»èŠ‚ç‚¹äº†ï¼Œå‘ç°nginxæŒ‚äº†ï¼Œè‡ªé™prorityè®©å‡ºVIPç»™åˆ«çš„èŠ‚ç‚¹ï¼Œè¿™ä¸ªåˆ«çš„èŠ‚ç‚¹å¯èƒ½æ˜¯ç¬¬ä¸‰ä¸ªï¼Œæˆ–è€…æ˜¯ä¹‹å‰çš„ä¸»ï¼Œè€Œä¸€èˆ¬æˆ‘ä»¬å°±2ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥è¿˜æ˜¯è®©ç»™ä¹‹å‰çš„ä¸»ï¼ŒåŠ å…¥ä¹‹å‰çš„ä¸»æ¢å¤äº†è‡ªç„¶æœ‰æŠ¢å å’Œprorityä¼˜å…ˆçº§æ¢å¤ç»“åˆåä¼šæŠ¢å›æ¥ï¼Œä¸ç”¨ä»å»è®©çš„åŠ¨ä½œçš„ã€‚æ‰€ä»¥ä»æ— éœ€é…ç½®nginxæ£€æµ‹è„šæœ¬ã€‚





# mysqlçš„HA-åº”è¯¥ä¸æ˜¯å’Œkeepalivedæ¥å¹²å§

æœ‰çŠ¶æ€çš„HAå¯èƒ½è¿˜æ˜¯è¦æ‰¾åº”ç”¨è‡ªèº«çš„HAè§£å†³æ–¹æ¡ˆï¼Œè€Œä¸æ˜¯ç”¨keepalivedæ¥å¼„ï¼Œkeepalivedæ¯”è¾ƒé€‚åˆæ— çŠ¶æ€çš„æœåŠ¡çš„HAæ¥ç€ã€‚

![image-20241225095549942](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241225095549942.png)

![image-20241225095622490](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241225095622490.png)

![image-20241225095839784](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241225095839784.png)

![image-20241225095901920](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241225095901920.png)



# zabbix-serverçš„ha

å’Œmsyqlä¸€æ ·ï¼Œzabbix 6.0å¼€å§‹æœ¬èº«è‡ªå¸¦HAäº†ï¼Œè¿˜æ˜¯ä¸è¦ç”¨keepaliveæ¥å®ç°zabbixçš„HAäº†ã€‚

<img src="7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241225100020736.png" alt="image-20241225100020736" style="zoom:50%;" />







# keepalivedçš„è„šæœ¬æ‰§è¡Œè¡Œä¸º

æœ‰ä¸€ä¸ªé»˜è®¤è´¦å·ï¼Œä¸€èˆ¬æ˜¯ä¸å­˜åœ¨åè€Œæ¯”è¾ƒå¥½çš„ï¼Œç¼–è¯‘å®‰è£…å¥½åƒå°±æ˜¯æ²¡æœ‰è¯¥é»˜è®¤ç”¨æˆ·çš„ï¼Œyumæä¸å¥½æœ‰ï¼Œå°±è¦æ³¨æ„æƒé™å¯èƒ½ä¸å¤Ÿçš„é—®é¢˜ã€‚  ä¸å­˜åœ¨æœ€å¥½ï¼Œå°±ä»¥rootè¿è¡Œäº†ï¼Œæƒé™æ²¡é—®é¢˜~

![image-20241225100344574](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241225100344574.png)



![image-20241225100410045](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241225100410045.png)





# æ€»ç»“



![image-20241225105146337](7.Keepalivedå®ç°Haproxyå’ŒNginxå…¶å®ƒæœåŠ¡çš„é«˜å¯ç”¨.assets/image-20241225105146337.png)











