# 5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.md



# åŒä¸»æ¨¡å‹

ä¸¤å°èŠ‚ç‚¹ä¸æµªè´¹

å…¶å®å°±æ˜¯å¤šä¸šåŠ¡çš„A/Aäº†ï¼Œå°±å¥½æ¯”ECMPå…¶å®æ˜¯å¤šç”¨æˆ·çš„é“¾è·¯è´Ÿè½½åˆ†æ‹…å’¯ã€‚



1ã€ä¸»é…ç½®æ–‡ä»¶ä¸å˜

![image-20241219112829817](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241219112829817.png)



![image-20241219112848815](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241219112848815.png)



2ã€å­é…ç½®æ–‡ä»¶è·Ÿç€ä¸šåŠ¡èµ°ä¹Ÿå°±æ˜¯ä¸€ä¸ªç«™ç‚¹ä¸€ä¸ªå­é…ç½®æ–‡ä»¶ä¸€ä¸ªVIP

![image-20241219112944043](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241219112944043.png)

ä¸Šå›¾æ”¹ä¸ºnopreempté™ä½å›åˆ‡å¯¼è‡´é—ªæ–­ã€‚



![image-20241219112924805](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241219112924805.png)



å†åšç¬¬äºŒä¸ªç«™ç‚¹çš„å­é…ç½®æ–‡ä»¶

![image-20241219113748631](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241219113748631.png)



![image-20241219113822596](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241219113822596.png)



é‡å¯keepalivedæœåŠ¡å

è®©192.168.126.100è½åœ¨ka001ä¸Šï¼Œè®©192.168.126.102è½åœ¨ka002ä¸ŠğŸ‘‡

![image-20241219113847054](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241219113847054.png)



![image-20241219113855724](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241219113855724.png)





# åŒæ­¥ç»„

ASAé‡Œçš„failoveré‡Œæœ‰ä¸ªç«¯å£ç»„ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯ä¸€ä¸ªæ¦‚å¿µã€‚



VIP è¦èƒ½ç¥¨ï¼ŒDIPä¹Ÿè¦èƒ½é£˜

![image-20241219135954335](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241219135954335.png)



```bash
vrrp_sync_group VG_1 {
	group {  # æˆä¸ºä¸€ä¸ªgroupåï¼Œè¦é£˜å°±ä¸€å—é£˜äº†ã€‚
		VI_1 # name of vrrp_instance (below)
		VI_2 # One of each moveable IP
	}
	vrrp_instance VI_1 {
		eth0
		vip
	}
	vrrp_instance VI_2 {
		eth1
		dip
	}
}
	
```







# keepaliveå†…åµŒLVSè§„åˆ™

LVSå•ç‚¹é—®é¢˜ï¼Œå’Œå¥åº·æ£€æµ‹é—®é¢˜ï¼Œç®—æ˜¯LVSçš„é—ç•™é—®é¢˜ï¼Œkeepalivedéƒ½æœ‰è§£å†³æ–¹æ¡ˆ

lvs ä»¥å‰è¦ç”¨ipvsadminå·¥å…·æ¥ ç¼–è¾‘è½¬å‘è§„åˆ™ã€‚

```bash
ipvsadmin -A -t vip:80 -s rr; ipvsadmin -a -t vip:80 -r rip1:80 -m|g|i ï¼ˆnat|gatway|tunnelï¼‰ 
```

keepalivedé‡Œå†…ç½®çš„lvsï¼Œæ— éœ€å†ä¾èµ–ipvsadminæ¥åˆ›å»ºè§„åˆ™ï¼Œç›´æ¥ç”¨keepaliveçš„é…ç½®æ–‡ä»¶å°±è¡Œã€‚ä¸è¿‡å¯ä»¥ç”¨ipvadminæ¥çœ‹çœ‹å·²ç»åˆ›å»ºçš„è§„åˆ™ã€‚



keepaliveå†…åµŒlvsè§„åˆ™ï¼Œå¿…ç„¶ä¿æŒlvsçš„å¯¹å¤–IPå’ŒVRRPé‡Œçš„VIPä¸€è‡´

VRRPçš„VIPæ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼Œç„¶åå°±åŒ¹é…virtual_server IP port è¯­å¥å—ï¼Œæ¥è°ƒåº¦åˆ°åç«¯å®ä¾‹ã€‚



```bash
# ä¸»èŠ‚ç‚¹

[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.136
   vrrp_mcast_group4 230.0.0.0
}

include /apps/keepalived/etc/keepalived/conf.d/*.conf
[root@ka01 ~]#

[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    #nopreempt
    preempt_delay 10
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }
    unicast_src_ip 10.1.1.1
    unicast_peer{
        10.1.1.2
    }

    notify_master "/apps/keepalived/bin/notify.sh master"
    notify_backup "/apps/keepalived/bin/notify.sh backup"
    notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept
}

virtual_server 192.168.126.100 80 {
    delay_loop 6
    lb_algo wrr
    lb_kind DR
    #persistence_timeout 50
    protocol TCP
    sorry_server 127.0.0.1 80


    real_server 192.168.126.138 80 {
        weight 2
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
    real_server 192.168.126.139 80 {
        weight 1
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
}

[root@ka01 ~]#



----------------------------


# ä»èŠ‚ç‚¹

[root@ka02 ~]# cat /apps/keepalived/etc/keepalived/keepalived.conf
! Configuration File for keepalived

global_defs {
   router_id 192.168.126.137
   vrrp_mcast_group4 230.0.0.0
}
include /apps/keepalived/etc/keepalived/conf.d/*.conf

[root@ka02 ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 90
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    unicast src_ip 10.1.1.2
    unicast_peer{
        10.1.1.1
    }

    notify_master "/apps/keepalived/bin/notify.sh master"
    notify_backup "/apps/keepalived/bin/notify.sh backup"
    notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept
}

virtual_server 192.168.126.100 80 {
    delay_loop 6
    lb_algo wrr
    lb_kind DR
    protocol TCP
    sorry_server 127.0.0.1 80


    real_server 192.168.126.138 80 {
        weight 2
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
    real_server 192.168.126.139 80 {
        weight 1
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
}


[root@ka02 ~]#


```



persistence_timeout  æ˜¯ä¼šè¯ä¿æŒï¼Œå…ˆæ³¨é‡Šæ‰ï¼Œå¦åˆ™å•ç”¨æˆ·æµ‹è¯•çœ‹ä¸å‡ºæ¥wrrçš„æƒé‡è°ƒåº¦æ¯”ä¾‹äº†



LVSè§„åˆ™å·²ç»ç”Ÿæ•ˆ

![image-20241220101322113](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220101322113.png)

ä¸è¿‡ä»èŠ‚ç‚¹ä¸æ‰¿è½½VIPï¼Œæ‰€ä»¥è§„åˆ™å®é™…æ˜¯æœªèµ·ä½œç”¨çš„ã€‚

![image-20241220101345467](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220101345467.png)



æµ‹è¯•ç¡®å®æ˜¯2:1çš„wrrè°ƒåº¦

![image-20241220101500331](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220101500331.png)

ä¸æ­¤åŒæ—¶å¯é€šè¿‡ipvadm -Lnè§‚å¯Ÿå‘½ä¸­è§„åˆ™æ¬¡æ•°ï¼Œå› ä¸ºVIPè½åœ¨ä¸»èŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥å…¶ä¸Šæ‰å¯è§LVSè§„åˆ™å‘½ä¸­æƒ…å†µ

![image-20241220102352401](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220102352401.png)



ç„¶åçœ‹ä¸‹åç«¯rsçš„å¥åº·æ£€æŸ¥ å‘ç°ä¸é€šåï¼Œä¸å†å¾€æ•…éšœæœåŠ¡å™¨è½¬å‘çš„æƒ…å†µ

åç«¯æŒ‚ä¸€ä¸ª

![image-20241220103534912](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220103534912.png)

è°ƒåº¦èƒ½å¤Ÿè¯†åˆ«åˆ°ï¼Œå¹¶ä¼˜åŒ–è½¬å‘ğŸ‘‡

![](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220103509741.png)



æ­¤æ—¶å°±ä¸ä¼šå†å¾€æ•…éšœèŠ‚ç‚¹192.168.126.138è½¬å‘äº†ï¼Œå› ä¸ºLVSçš„è½¬å‘è§„åˆ™å·²ç»è°ƒæ•´ğŸ‘‡

![image-20241220103709179](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220103709179.png)

RSèµ·æ¥åï¼ŒLVSè§„åˆ™ä¼šè‡ªåŠ¨åŠ å›æ¥ï¼Œè½¬å‘é‡æ–°æ¢å¤wrr2:1è°ƒåº¦

![image-20241220104213792](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220104213792.png)



![image-20241220104231886](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220104231886.png)



æ‰€ä»¥keepalived+lvsæ˜¯é»„é‡‘æ­æ¡£~



![image-20241220104507555](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220104507555.png)



<img src="5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220104535324.png" alt="image-20241220104535324" style="zoom:47%;" />







## L4æ£€æŸ¥çš„é…ç½®æ–¹æ³•

<img src="5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220101650147.png" alt="image-20241220101650147" style="zoom:40%;" />



ä¿æŒä¹‹å‰çš„httpæ£€æŸ¥çš„é…ç½®æ–‡ä»¶ï¼Œç„¶åå¤åˆ¶ä¸€ä»½å‡ºæ¥åšL4æ£€æŸ¥ï¼Œvimçš„ä½¿ç”¨æŠ€å·§ï¼Œåˆ é™¤é€‰ä¸­è¡Œï¼Œvimè¿›å»ç„¶åæŒ‰vé€‰æ‹©å¤šè¡Œï¼Œdå°±è¡Œäº†





```bash
# ä¸»èŠ‚ç‚¹
[root@ka01 ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 100
    advert_int 3
    #nopreempt
    preempt_delay 10
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }
    unicast_src_ip 10.1.1.1
    unicast_peer{
        10.1.1.2
    }

    notify_master "/apps/keepalived/bin/notify.sh master"
    notify_backup "/apps/keepalived/bin/notify.sh backup"
    notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept
}

virtual_server 192.168.126.100 80 {
    delay_loop 6
    lb_algo wrr
    lb_kind DR
    #persistence_timeout 50
    protocol TCP
    sorry_server 127.0.0.1 80


    real_server 192.168.126.138 80 {
        weight 2
        TCP_CHECK {
            connect_timeout 5
            nb_get_retry 3
            delay_before_retry 3
            connect_port 80
       }
    }
    real_server 192.168.126.139 80 {
        weight 1
        TCP_CHECK {
            connect_timeout 5
            nb_get_retry 3
            delay_before_retry 3
            connect_port 80
       }

    }
}

[root@ka01 ~]#


# ä»èŠ‚ç‚¹
[root@ka02 ~]# cat /apps/keepalived/etc/keepalived/conf.d/www.ming.org.conf
vrrp_instance VI_1 {
    state BACKUP
    interface eth1
    virtual_router_id 51
    priority 90
    advert_int 3
    authentication {
        auth_type PASS
        auth_pass cisco
    }
    virtual_ipaddress {
        192.168.126.100/24 dev eth0 label eth0:1
    }

    unicast src_ip 10.1.1.2
    unicast_peer{
        10.1.1.1
    }

    notify_master "/apps/keepalived/bin/notify.sh master"
    notify_backup "/apps/keepalived/bin/notify.sh backup"
    notify_fault "/apps/keepalived/bin/notify.sh fault"

    # Allow packets addressed to the VIPs above to be received
    accept
}

virtual_server 192.168.126.100 80 {
    delay_loop 6
    lb_algo wrr
    lb_kind DR
    #persistence_timeout 50
    protocol TCP
    sorry_server 127.0.0.1 80


    real_server 192.168.126.138 80 {
        weight 2
        TCP_CHECK {
            connect_timeout 5
            nb_get_retry 3
            delay_before_retry 3
            connect_port 80
       }
    }
    real_server 192.168.126.139 80 {
        weight 1
        TCP_CHECK {
            connect_timeout 5
            nb_get_retry 3
            delay_before_retry 3
            connect_port 80
       }

    }
}

[root@ka02 ~]#


```

4å±‚å°±æ˜¯ä»…çœ‹ç«¯å£äº†ï¼Œ

å¦‚æœ80è¿˜æ˜¯é€šçš„ï¼Œé‚£ä¹ˆå¥åº·æ£€æŸ¥åˆ¤æ–­è¿˜æ˜¯OKçš„ï¼Œæ‰€ä»¥è¿˜æ˜¯ä¼šå¾€æ•…éšœæœºå™¨è½¬å‘çš„



**tcpé€šçš„ï¼Œä½†æ˜¯index.htmlæ²¡æœ‰æƒé™è¯»å–**

![image-20241220111015397](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220111015397.png)



![image-20241220111030272](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220111030272.png)



![image-20241220111035882](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220111035882.png)



**tcpé€šçš„ï¼Œä½†æ˜¯httpdæŒ‚äº†ï¼Œncæ¨¡æ‹Ÿäº†ä¸€ä¸ª80**

192.168.126.138ä¸Š stop httpdï¼Œncä¸€ä¸ª80

![image-20241220141551504](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220141551504.png)

ç„¶åæµ‹è¯•çš„æ—¶å€™curlå¸¦ä¸Štimeoutè¶…æ—¶é€‰é¡¹

![image-20241220141636209](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220141636209.png)



### mod_sslä¼šè‡ªåŠ¨ç”Ÿæˆè¯ä¹¦ä¸ç”¨è‡ªå·±åŠ¨æ‰‹

å®‰è£…mod_sslåhttpdçš„443å°±æ‰“å¼€äº†



æœ¬æ¥æ˜¯vså°±å†™äº†ä¸€ä¸ª80ï¼Œç°åœ¨å¤šäº†ä¸€ä¸ª443

![image-20241220143020173](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220143020173.png)

æ²¡æœ‰å¿…è¦å†å†™ä¸€ä¸ªå¤§çš„å­—å…¸ï¼Œå¯ä»¥åˆ©ç”¨é˜²ç«å¢™æ ‡ç­¾æ•´åˆ



```bash
iptables -t mangle -A PREROUTING -d 192.168.126.100 -p tcp -m multiport --dports 80,443 -j MARK --set-mark 6
```

```bash
virtual_server fwmark 6 {
    delay_loop 3
    # æ”¹ä¸ºrråä¸‹é¢çš„weight å°±ä¸ç”Ÿæ•ˆäº†ï¼Œå°±æ˜¯1:1rräº†
    lb_algo rr
    lb_kind DR
    #persistence_timeout 50
    protocol TCP
    sorry_server 127.0.0.1 80


    real_server 192.168.126.138 80 {
        weight 2
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
    real_server 192.168.126.139 80 {
        weight 1
        HTTP_GET {
            url {
              path /index.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
}


```

### æ­¤æ—¶å°±æ ¹æ®é˜²ç«å¢™æ ‡ç­¾æ¥è½¬å‘äº†

![image-20241220145234290](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220145234290.png)





### åšä¸¤ä¸ªVIPå¯¹åº”ä¸¤ä¸ªä¸šåŠ¡A/A



```bash
iptables -t mangle -A PREROUTING -d 192.168.126.101 -p tcp -m multiport --dports 80,443 -j MARK --set-mark 6

```



```bash
virtual_server fwmark 7 {
    delay_loop 3
    lb_algo rr
    lb_kind DR
    #persistence_timeout 50
    protocol TCP
    sorry_server 127.0.0.1 80


    real_server 192.168.126.138 80 {
        weight 2
        HTTP_GET {
            url {
              path /index222.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
    real_server 192.168.126.139 80 {
        weight 1
        HTTP_GET {
            url {
              path /index222.html
              status_code 200
            }
            connect_timeout 1
            nb_get_retry 3
            delay_before_retry 1
        }
    }
}


```

```bash
ifconfig lo:2 192.168.126.101 netmask 255.255.255.255  #broadcast 192.168.126.101 up
```

<img src="5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220154656829.png" alt="image-20241220154656829" style="zoom:33%;" />

![image-20241220152907237](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220152907237.png)



![image-20241220152944121](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220152944121.png)

å†…æ ¸ä¹‹å‰æœ€192.168.126.100è¿™ä¸ªVIPçš„DRæ¨¡å¼å·²ç»ä¿®æ”¹è¿‡äº†

![image-20241220154756067](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220154756067.png)



æµ‹è¯•

![image-20241220153642434](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220153642434.png)



![image-20241220153656684](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220153656684.png)



![image-20241220153736154](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220153736154.png)



é—®é¢˜æ˜¯ï¼šFWM 7 rr ä¸æ˜¯åº”è¯¥1:1å˜›

iptablesæ ‡ç­¾æ‰“é”™äº†ï¼ŒğŸ‘‡192.168.126.101åº”è¯¥è¾¾æˆ7çš„

![image-20241220155447761](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220155447761.png)



![image-20241220155923891](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220155923891.png)



ç¬¬äºŒå°keepalivedä¸€æ ·



è¿™å°±wrrå’Œrréƒ½OKäº†

![image-20241220160112081](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220160112081.png)



192.168.126.100è¿™ä¸ªVIPæ˜¯ iptablesæ‰“æ ‡æœª6 èµ°çš„wrr

![image-20241220160150955](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220160150955.png)



192.168.126.101è¿™ä¸ªVIPæ˜¯è½åœ¨ka02ä¸Šï¼Œiptablesæ‰“æ ‡æœª7èµ°çš„rr

![image-20241220160227237](5.Keepalivedå¤šä¸»æ¨¡å¼å’Œå®ç°LVS.assets/image-20241220160227237.png)

æ³¨æ„ğŸ‘†è™½ç„¶2:1 ä½†ç”±äºæ˜¯rrï¼Œæ‰€ä»¥weightä¸ç”Ÿæ•ˆçš„ã€‚











 			
