# ç¬¬4èŠ‚. httpd2



# apacheçš„æ–‡ä»¶æ„æˆäº†è§£



## rockylinux9ä¸Šapacheç›´æ¥yumå®‰è£…çš„ç‰ˆæœ¬

![image-20231002150545518](4-httpd2.assets/image-20231002150545518.png)

å®‰è£…httpdè½¯ä»¶æ—¶çš„ä¾èµ–

![image-20231002151852271](4-httpd2.assets/image-20231002151852271.png)

å…¶ä¸­é‡è¦æ–‡ä»¶ï¼Œæ¯”å¦‚confæ–‡ä»¶éƒ½åœ¨httpd-core-xxxè¿™ä¸ªè½¯ä»¶åŒ…é‡Œã€‚



![image-20231002152142691](4-httpd2.assets/image-20231002152142691.png)



![image-20231002152251820](4-httpd2.assets/image-20231002152251820.png)



## /etc/httpd  å°±æ˜¯apacheè½¯ä»¶çš„å·¥ä½œæ€»ç›®å½•



æœåŠ¡serviceæ–‡ä»¶å°±ä¸åœ¨httpd-core-xxxè¿™ä¸ªåŒ…é‡Œäº†ï¼Œè€Œæ˜¯åœ¨httpd.x86_64è¿™ä¸ªé‡Œ

![image-20231002152630485](4-httpd2.assets/image-20231002152630485.png)



## å…³äºmodules

**â‘ /etc/httpd/modules æ¨¡å—ç›®å½•**   conf.modules.dè¿™ä¸ªä¸€çœ‹å°±æ˜¯confé…ç½®æ–‡ä»¶çš„æ¨¡æ¿ä¸æ˜¯è¿™é‡Œè¦æ¢³ç†çš„/etc/httpd/modulesè¿™ä¸ªæ¨¡å—

![image-20231002152855090](4-httpd2.assets/image-20231002152855090.png)

è¿˜æœ‰**/usr/lib64/httpd/modules/**è¿™ä¸ª æ¨¡å—

![image-20231002153117988](4-httpd2.assets/image-20231002153117988.png)



å…¶å®æ˜¯ä¸€æ ·çš„

![image-20231002153523655](4-httpd2.assets/image-20231002153523655.png)

/etc/httpd/modulesæ—¶/usr/lib64/httpd/modulesçš„è½¯è¿æ¥ã€‚



/etc/httpdæ˜¯ä½œä¸ºapacheçš„æ€»ç›®å½•ï¼Œåé¢ä¸€äº›é…ç½®ä¸Šï¼Œéƒ½ä»¥è¿™ä¸ªç›®å½•ä¸ºç›¸å¯¹è·¯å¾„çš„ã€‚é…ç½®ä¸Šç›´æ¥å†™çš„å°±æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œè€Œç›¸å¯¹çš„å°±æ˜¯è¿™ä¸ªç›®å½•ã€‚



<img src="4-httpd2.assets/image-20231002154538313.png" alt="image-20231002154538313" style="zoom:50%;" />

mod_auth_basic.soæ¨¡å—çš„ä½œç”¨ï¼šç”¨æ¥éªŒè¯ç”¨æˆ·åå¯†ç çš„ä¸€ä¸ªåŸºæœ¬åŠŸèƒ½ï¼›ä¸€èˆ¬æ¥è®²ç”¨æˆ·ç™»å…¥POSTæäº¤ç”¨æˆ·å¯†ç ï¼Œå¯¹æ¯”DBé‡Œçš„è®°å½•ï¼Œä¸€è‡´åˆ™éªŒè¯é€šè¿‡ï¼Œè€Œè¿™ä¸€å¥—ä¸œè¥¿æ¶‰åŠè½¯ä»¶å¼€å‘çš„è¿‡ç¨‹(...è¿™å°±æ¶‰åŠè½¯ä»¶å¼€å‘äº†ï¼Ÿä¸å°±æ˜¯POSTå¯¹æ¯”DBåº“å˜›ï¼Œå…ˆä¼°ä¸”è®¤åŒè¿™ä¸ªè§‚ç‚¹å§ï¼Œä¼°è®¡æ˜¯æ¶‰åŠDBå’ŒPOSTå¤„ç†å§ï¼Œæ­£å¸¸djangoå¥½åƒæŒºç®€å•çš„å¤„ç†è¿™å—)ã€‚è€Œmod_auth_basic.soè¿™ä¸ªæ¨¡å—å°±å¯ä»¥å¯¹æŸä¸€ä¸ªç½‘ç«™åšåŸºæœ¬çš„ç”¨æˆ·åå¯†ç è®¤è¯ã€‚



apachectl å¯ç”¨å…³é—­çš„äºŒè¿›åˆ¶ç¨‹åºï¼Œä¸è¿‡ä¸€èˆ¬ç”¨systemctl start httpdã€‚

<img src="4-httpd2.assets/image-20231002155130628.png" alt="image-20231002155130628" style="zoom:50%;" />

/usr/sbin/httpdæ˜¯apacheçš„ä¸»è¿›ç¨‹ï¼Œsystemctl start httpdå¯åŠ¨çš„å°±æ˜¯è¿™ä¸ªã€‚

![image-20231002155645802](4-httpd2.assets/image-20231002155645802.png)

ç„¶åapachectl è¿™ä¸ªcliä¹Ÿçœ‹ä¸‹æ•ˆæœğŸ‘‡

![image-20231002155842566](4-httpd2.assets/image-20231002155842566.png)



## ç„¶å/var/wwwè¿™ä¸ªè€³ç†Ÿèƒ½è¯¦çš„ç›®å½•

![image-20231002160212430](4-httpd2.assets/image-20231002160212430.png)

æ˜¯åœ¨httpd-filesystem-2.4xxxxè¿™ä¸ªåŒ…é‡Œäº†ï¼Œ



![image-20231002160419040](4-httpd2.assets/image-20231002160419040.png)





## 

![image-20231002164015389](4-httpd2.assets/image-20231002164015389.png)

åˆšå®‰è£…å¥½çš„httpdçš„é…ç½®æ£€æµ‹çœ‹çœ‹

![image-20231002164151938](4-httpd2.assets/image-20231002164151938.png)

Syntax OKï¼Œè¯­æ³•OKï¼Œç„¶åæç¤ºæ¶ˆæ¯è¯´çš„æ˜¯FQDNçš„äº‹æƒ…ï¼Œæ²¡å•¥åé¢ä¼šé…ç½®ã€‚



<img src="4-httpd2.assets/image-20231002172220407.png" alt="image-20231002172220407" style="zoom:50%;" />





è·Ÿpptpï¼Œl2tpçš„æœåŠ¡ä¸€æ ·ï¼ŒvpnæœåŠ¡è·‘èµ·æ¥é’ˆå¯¹é’ˆå¯¹æŸä¸ªç”¨æˆ·è¸¢ä¸‹çº¿ï¼Œå°±å¯ä»¥æ‰¾åˆ°ç”¨æˆ·æ‹¨å…¥æ¥å£çš„è¿›ç¨‹PIDï¼›

![image-20231002171800595](4-httpd2.assets/image-20231002171800595.png)

æˆ‘çš„æ„æ€å°±æ˜¯é’ˆå¯¹è¿›ç¨‹çš„IDï¼Œé€šå¸¸æœåŠ¡è½¯ä»¶ä»¬ä¼šè‡ªå·±åŠ¨æ€ç”Ÿæˆxxx.pidæ–‡ä»¶æ¥ä¿å­˜çš„ï¼Œä¸ç„¶ps aux å»çœ‹å¯èƒ½æœ‰å¾ˆå¤šä¸å¥½åŒºåˆ†--å°±æ¯”å¦‚ä¸Šå›¾çš„ppp0ã€ppp1å¦‚æœè¿™äº›å¾ˆå¤šï¼Œps aux |grep ppp ä¹Ÿä¸çŸ¥é“å“ªä¸ªæ¥å£æ—¶å“ªä¸ªè¿›ç¨‹çš„ã€‚

![image-20231002171632726](4-httpd2.assets/image-20231002171632726.png)







# httpdçš„é…ç½®

```
[root@node1 ~]# cat /etc/httpd/conf/httpd.conf  |grep -Ev '^ *#'

ServerRoot "/etc/httpd"    # è¿™å°±æ˜¯æ ¹ï¼Œæ‰€æœ‰çš„é…ç½®ç›®å½•çš„ç›¸å¯¹è·¯å¾„éƒ½æ˜¯ç›¸å¯¹è¿™ä¸ªç›®å½•çš„

Listen 80

Include conf.modules.d/*.conf  # åŒ…å«çš„è¾…åŠ©é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œå°±æ˜¯ç›¸å¯¹è·¯å¾„äº†ï¼Œ/etc/httpd/conf.modules.d/äº†ã€‚

User apache
Group apache


ServerAdmin root@localhost


<Directory />
    AllowOverride none
    Require all denied
</Directory>


DocumentRoot "/var/www/html"

<Directory "/var/www">
    AllowOverride None
    Require all granted
</Directory>

<Directory "/var/www/html">
    Options Indexes FollowSymLinks

    AllowOverride None

    Require all granted
</Directory>

<IfModule dir_module>
    DirectoryIndex index.html
</IfModule>

<Files ".ht*">
    Require all denied
</Files>

ErrorLog "logs/error_log"

LogLevel warn

<IfModule log_config_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%h %l %u %t \"%r\" %>s %b" common

    <IfModule logio_module>
      LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
    </IfModule>


    CustomLog "logs/access_log" combined
</IfModule>

<IfModule alias_module>


    ScriptAlias /cgi-bin/ "/var/www/cgi-bin/"

</IfModule>

<Directory "/var/www/cgi-bin">
    AllowOverride None
    Options None
    Require all granted
</Directory>

<IfModule mime_module>
    TypesConfig /etc/mime.types

    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz



    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
</IfModule>

AddDefaultCharset UTF-8

<IfModule mime_magic_module>
    MIMEMagicFile conf/magic
</IfModule>


EnableSendfile on

IncludeOptional conf.d/*.conf    # ç”±äºå½“å‰æ–‡ä»¶ä¹Ÿå°±æ˜¯/etc/httpd/conf/httpd.confé‡Œçš„ä¸œè¥¿å¤ªå¤šï¼Œæ‰€ä»¥å»ºè®®åé¢çš„é…ç½®éƒ½æ”¾åˆ°conf.d/ä¸‹é¢ã€‚

```

ä¸ç®¡æ€ä¹ˆè¯´å…ˆå¤‡ä»½è¿™ä¸ªä¸»é…ç½®æ–‡ä»¶

![image-20231002171223673](4-httpd2.assets/image-20231002171223673.png)



## HTTPDå¸¸è§é…ç½®



**httpdé…ç½®æ–‡ä»¶çš„ç»„æˆï¼š**

**ä¸»è¦ç»„æˆ**

â€‹	Global Environment

â€‹	Main server configuration virtual host

**é…ç½®æ ¼å¼ï¼šdirective value **     # æŒ‡ä»¤ å€¼å¾—æ ¼å¼ï¼Œç±»ä¼¼å­—å…¸å¾—é”®å€¼å¯¹ã€‚

 	Directive  ä¸åŒºåˆ†å­—ç¬¦å¤§å°å†™
 	
 	Value ä¸ºè·¯å¾„æ—¶ï¼Œæ˜¯å¦åŒºåˆ†å¤§å°å†™ï¼Œå–å†³äºæ–‡ä»¶ç³»ç»Ÿ

**å®˜æ–¹å¸®åŠ©**

â€‹	http://httpd.apache.org/docs/2.4/





é…ç½®çš„æ ¼å¼éƒ½æ˜¯ç±»ä¼¼key valueçš„æ–¹å¼

![image-20231002172445904](4-httpd2.assets/image-20231002172445904.png)



### **listen**çš„å†™æ³•

![image-20231002173316125](4-httpd2.assets/image-20231002173316125.png)

IP-address ä¸å†™å°±æ˜¯ç»‘å®šæ‰€æœ‰IPã€‚

IPåœ°å€æœ¬åœ°ä¸å­˜åœ¨ï¼Œhttpdéƒ½ä¸ä¼šè®©ä½ èµ·æ¥

![image-20231002173731350](4-httpd2.assets/image-20231002173731350.png)





ä¿®æ”¹ç›‘å¬ç«¯å£éœ€è¦é‡å¯æœåŠ¡çš„ï¼Œreloadä¸è¡ŒğŸ‘‡

ä¸æ˜¯æ‰€æœ‰çš„é…ç½®éƒ½èƒ½reloadï¼Œè¿›è€Œæ— éœ€é‡å¯æœåŠ¡ï¼Œ

![image-20231002191024480](4-httpd2.assets/image-20231002191024480.png)

å°†æ¥å°±å¯ä»¥åšä¸¤ä¸ªç½‘ç«™ï¼Œä¸€ä¸ª80ï¼Œä¸€ä¸ª8080ã€‚å¯ä»¥ä½¿ç”¨è™šæ‹Ÿä¸»æœºæŠ€æœ¯ã€‚æ˜¯VPSå˜›ï¼Ÿæ„Ÿè§‰ä¸æ˜¯..



### ServerTokens



ğŸ‘‡ä¸‹å›¾å¯è§serverå­—æ®µå°±æš´éœ²äº†apacheçš„ç‰ˆæœ¬å’Œæ“ä½œç³»ç»Ÿã€‚

![image-20231002192122295](4-httpd2.assets/image-20231002192122295.png)





ä½¿ç”¨curlçœ‹å¤´éƒ¨ä¿¡æ¯



![image-20231002192414737](4-httpd2.assets/image-20231002192414737.png)

â‘ å¥½åƒ-iå’Œ-Iä¸€æ ·ï¼Œå¿½ç•¥å¤§å°å†™äº†ï¼›å…¶å®ä¸å¯¹çš„ï¼Œ-I æ˜¯å¤§å†™ï¼Œçœ‹ä¸‹å›¾æ¡ˆä¾‹

â‘¡å°±æ˜¯curl -iå¯ä»¥æŸ¥çœ‹headå¤´éƒ¨ä¿¡æ¯ã€‚å…¶ä¸­å°±æœ‰serverå­—æ®µæ˜¾ç¤ºä½ çš„apacheç‰ˆæœ¬å’Œæ“ä½œç³»ç»Ÿã€‚

![image-20231002193755743](4-httpd2.assets/image-20231002193755743.png)

æˆ‘æŠŠ/var/www/html/index.html  æ‹¿æ‰--å°±è¯¥æ”¹æˆxxx

![image-20231002193839513](4-httpd2.assets/image-20231002193839513.png)

ç„¶åå‘¢å°±æœ‰ä¸¤ä¸ªç°è±¡ï¼Œâ‘  -iå’Œ-Iä¸åŒ  â‘¡403æŠ¥é”™

![image-20231002193948440](4-httpd2.assets/image-20231002193948440.png)

![image-20231002194005503](4-httpd2.assets/image-20231002194005503.png)

![image-20231002194237903](4-httpd2.assets/image-20231002194237903.png)

ç„¶å403é¡µé¢æŠ¥é”™ï¼Œæ˜¯**é¡µé¢ä¸å­˜**çš„ä¸€ä¸ªæŠ¥é”™ï¼Œäº†è§£ä¸‹ğŸ‘‡ï¼Œå½“ç„¶ä¹Ÿå¯èƒ½æ˜¯**é¡µé¢æ–‡ä»¶æ²¡æœ‰è®¿é—®æƒé™**ã€‚è¿™é‡Œå°±æ˜¯index.htmlæ²¡æœ‰åˆ›å»ºå¯¼è‡´çš„æŠ¥é”™403ã€‚



è¿˜æœ‰ä¸€ä¸ªç‚¹ï¼Œå°±æ˜¯å¦‚æœä½ ä¿®æ”¹äº†index.htmlçš„é»˜è®¤ä½ç½®--/var/www/html/index.htmlï¼Œé‚£ä¹ˆä¿®æ”¹åçš„è·¯å¾„ä¹Ÿè¦è®©apacheè¿™ä¸ªidæœ‰è‡³å°‘è¯»çš„æƒé™å§ã€‚



ä¿®æ”¹index.htmlæ–‡ä»¶æ— éœ€é‡å¯æœåŠ¡ï¼Œåˆ·æ–°é¡µé¢å°±è¡Œäº†





å›åˆ°serverTokençš„å†…å®¹ï¼ŒServerTokenå°±æ˜¯ç”¨æ¥æ©ç›–çœŸå®çš„serverå­—æ®µä¿¡æ¯çš„ã€‚

![image-20231002194904864](4-httpd2.assets/image-20231002194904864.png)



æ ¹æ®å‚æ•°è¯´æ˜ï¼Œå¯çŸ¥httpdé»˜è®¤ç”¨çš„fullï¼Œå°±æ˜¯æŠŠä¿¡æ¯æ˜¾ç¤ºå…¨äº†ï¼Œç„¶åé€éœ²ä¿¡æ¯æœ€å°‘çš„æ˜¯Prod[uctOnly]ï¼Œæ–¹æ‹¬å·æ˜¯å¯ä»¥çœç•¥çš„æ„æ€ï¼Œlinuxé€šç”¨å†™æ³•ã€‚

å…¶å®prodæš´éœ²çš„ä¿¡æ¯ä¹Ÿæ²¡å¿…è¦ï¼Œæœ€å¥½å•¥éƒ½ä¸æš´éœ²ï¼Œè¿™å°±ä¸æ˜¯httpdè‡ªå¸¦çš„åŠŸèƒ½äº†--æˆ–è€…æºç ä¿®æ”¹è¿™äº›ä¿¡æ¯(å­—ç¬¦ä¸²Apacheæœä¸€æœæ”¹ä¸€æ”¹å°±è¡Œäº†)ç„¶åç¼–è¯‘å®‰è£…ï¼›å¦‚æœä¸æ”¹æºç ï¼Œå°±éœ€è¦å‰ç«¯é€šè¿‡è°ƒåº¦å™¨æ¥è¿‡æ»¤æ‰ã€‚



### ä¿®æ”¹é…ç½®æ–‡ä»¶æ¨èä¸è¦åŠ¨/etc/httpd/conf/httpd.confè¿™ä¸ªä¸»é…ç½®æ–‡ä»¶

æ¢å¤ä¸€ä¸‹ä¹‹å‰çš„listençš„ä¿®æ”¹

<img src="4-httpd2.assets/image-20231002201425850.png" alt="image-20231002201425850" style="zoom:50%;" /> 

/etc/httpd/conf.d/ä¸‹æ–°å»ºtest.confï¼Œç¼–è¾‘æ‰€éœ€æŒ‡ä»¤å’Œå€¼

<img src="4-httpd2.assets/image-20231002201630225.png" alt="image-20231002201630225" style="zoom:50%;" /> 



![image-20231002201747038](4-httpd2.assets/image-20231002201747038.png)



å†è¡¥ä¸€ä¸ªservertokens



![image-20231002210749565](4-httpd2.assets/image-20231002210749565.png)

éœ€è¦é‡å¯æœåŠ¡çš„

![image-20231002210735334](4-httpd2.assets/image-20231002210735334.png)

ğŸ‘†è¿™å¼ å›¾å°±çœ‹æ¸…æ¥šäº†-iå’Œ-Içš„åŒºåˆ«ï¼Œ-iå°±æ˜¯includeåŒ…å«å¤´éƒ¨å’Œé¡µé¢å†…å®¹ã€‚-Iå°±æ˜¯ä»…ä»…å¤´éƒ¨ã€‚

ç„¶åservertokenså¯è§ï¼Œå·²ç»ç”Ÿæ•ˆäº†ï¼Œåªæœ‰Apacheè¿™ä¸ªç®€ç•¥ä¿¡æ¯äº†ã€‚

<img src="4-httpd2.assets/image-20231002211150803.png" alt="image-20231002211150803" style="zoom:50%;" />





### æŒä¹…è¿æ¥

**Persistent Connection**ï¼šè¿æ¥å»ºç«‹ï¼Œæ¯ä¸ªèµ„æºè·å–å®Œæˆåä¸ä¼šæ–­å¼€è¿ æ¥ï¼Œè€Œæ˜¯ç»§ç»­ç­‰å¾…å…¶å®ƒçš„è¯·æ±‚å®Œæˆï¼Œé»˜è®¤å…³é—­æŒä¹…è¿æ¥

**æ–­å¼€æ¡ä»¶**ï¼šæ—¶é—´é™åˆ¶ï¼šä»¥ç§’ä¸ºå•ä½ï¼Œ é»˜è®¤5sï¼Œhttpd-2.4 æ”¯æŒæ¯«ç§’çº§ 

**å‰¯ä½œç”¨**ï¼šå¯¹å¹¶å‘è®¿é—®é‡å¤§çš„æœåŠ¡å™¨ï¼ŒæŒä¹…è¿æ¥ä¼šä½¿æœ‰äº›è¯·æ±‚å¾—ä¸åˆ°å“åº” 

**æŠ˜è¡·**ï¼šä½¿ç”¨è¾ƒçŸ­çš„æŒä¹…è¿æ¥æ—¶é—´

**è®¾ç½®**ï¼šKeepAlive On|Off 

â€‹			KeepAliveTimeout 15

**æµ‹è¯•**ï¼štelnet WEB_SERVER_IP PORT

â€‹			GET /URL HTTP/1.1 

â€‹			Host: WEB_SERVER_IP



å‰é¢çš„ç« èŠ‚è®²è¿‡http1.1ç‰ˆæœ¬é»˜è®¤å°±æ”¯æŒpersistent connectionçš„ğŸ‘‡

<img src="4-httpd2.assets/image-20231003182851461.png" alt="image-20231003182851461" style="zoom:33%;" /> 



![image-20231003185240529](4-httpd2.assets/image-20231003185240529.png)

å®˜æ–¹è¯´æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå½“ç„¶2.4ç‰ˆæœ¬çš„httpçš„ï¼Œè‡ªç„¶ä¹Ÿæ˜¯http1.1åè®®ã€‚

å¦‚æœçŸ¥é“æ˜¯å¦å¼€å¯äº†"æŒä¹…è¿æ¥"--é€šè¿‡telnet 80ç„¶åGETæ–¹å¼è¿›è¡Œæµ‹è¯•æŒä¹…è¿æ¥

â‘ æŒä¹…è¿æ¥å°±æ˜¯ä¸€ä¸ªtcpè¿æ¥é‡Œï¼Œå¯ä»¥å¤„ç†å¤šä¸ªç”¨æˆ·è¯·æ±‚

â‘¡æµ‹è¯•æ–¹æ³•ï¼š

<img src="4-httpd2.assets/image-20231003195743965.png" alt="image-20231003195743965" style="zoom:43%;" />



![image-20231003200208006](4-httpd2.assets/image-20231003200208006.png)

ä¸Šå›¾ğŸ‘†å°±æ˜¯ç”¨telnetå¼€å¯äº†80çš„ç«¯å£TCPè¿æ¥--ç®—æ˜¯ä¸€ä¸ªé•¿è¿æ¥ï¼Œç„¶åè¿™é‡Œæœ‰keepalive timeoutçš„è¶…æ—¶(é»˜è®¤æ˜¯secondsç§’ä¸ºå•ä½ï¼Œä¹Ÿæ”¯æŒmsæ¯«ç§’)ã€‚

![image-20231003201550679](4-httpd2.assets/image-20231003201550679.png)

è¿™æ˜¯ğŸ‘†KeepAliveTimeout Directiveçš„å‚æ•°è§£é‡Šï¼Œè¿™é‡Œè¦æ³¨æ„é»˜è®¤æ˜¯5ç§’é’Ÿï¼Œç„¶å5ç§’é’Ÿçš„è¶…æ—¶è¡¨ç°åœ¨ä»€ä¹ˆç‚¹ä¸Šå‘¢ï¼Œå°±æ˜¯ä½ è¾“å…¥host 3.3.3.3 å›è½¦å‘é€äº†ä¸ªGETrequestå‡ºå»åï¼Œå¼€å§‹è®¡æ—¶çš„ï¼Œä¹Ÿå°±æ˜¯wait for a subsequtent request befor closing the connã€‚æ€ä¸€ä¸ªsubsequentäº†å¾—~éšåçš„ï¼Œæ‰€ä»¥ä¸¤ä¸ªè¯·æ±‚ä¹‹é—´è¶…æ—¶æ—¶é—´å°±æ˜¯keepAliveTimeoutã€‚

![image-20231003202037101](4-httpd2.assets/image-20231003202037101.png)

![image-20231003202246056](4-httpd2.assets/image-20231003202246056.png)

é™¤äº†è¿™ä¸ªkeepalivetimeoutï¼Œè¿˜æœ‰ä¸€ä¸ªå‚æ•°è®¾ç½®æ˜¯ æŒä¹…è¿æ¥é‡Œ èµ„æºä¸‹è½½æ¬¡æ•°(getå…¶å®å°±æ˜¯ä¸‹è½½é¡µé¢äº†) åˆ°äº†ä¹Ÿå¯ä»¥æ–­å¼€ã€‚é€šè¿‡poe.comé—®ä¸€ä¸‹å°±æ‰¾åˆ°äº†

<img src="4-httpd2.assets/image-20231003202857771.png" alt="image-20231003202857771" style="zoom:33%;" />



![image-20231003202846612](4-httpd2.assets/image-20231003202846612.png)

æµ‹è¯•ä¸‹ğŸ‘‡

![image-20231003202950633](4-httpd2.assets/image-20231003202950633.png)

![image-20231003203003219](4-httpd2.assets/image-20231003203003219.png)

![image-20231003203125064](4-httpd2.assets/image-20231003203125064.png)

ğŸ‘†ä¸Šå›¾å¯ä¸æ˜¯keepalivetimeout 30ç§’è¶…æ—¶å“¦ï¼Œæ²¡åˆ°å‘¢ï¼›è¿™æ˜¯maxkeepaliverequests 2ï¼Œ2æ¬¡ä¸‹è½½è¶…äº†çš„é™åˆ¶ã€‚



ç„¶åè¡¥å……è¯´æ˜ä¸€ä¸‹ï¼Œæµ‹è¯•æ–¹æ³•ğŸ‘‡

<img src="4-httpd2.assets/image-20231003203643432.png" alt="image-20231003203643432" style="zoom:50%;" />

å…¶å®å°±æ˜¯ç±»ä¼¼curlä»¥åŠæµè§ˆå™¨çš„è¡Œä¸ºï¼Œé€šè¿‡æŠ“åŒ…å¯è§

![image-20231003203925169](4-httpd2.assets/image-20231003203925169.png)

curlä¸€æ ·ï¼Œå°±ä¸æŠ“äº†ï¼Œç„¶åhostå…¶å®æ˜¯å¯ä»¥éšä¾¿å†™çš„ã€‚





### DSOï¼šDynamic Shared Object

åŠ¨æ€çš„å…±äº«å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´httpçš„æ¨¡å—æ˜¯æ”¯æŒåŠ¨æ€åŠ è½½çš„ã€‚

![image-20231003214016126](4-httpd2.assets/image-20231003214016126.png)

![image-20231003214036829](4-httpd2.assets/image-20231003214036829.png)

ä¸Šå›¾å…¶å®è¿˜æœ‰å¾ˆå¤šï¼Œmodulesï¼Œé€šè¿‡ls å»çœ‹æ›´æ–¹ä¾¿

![image-20231003214134488](4-httpd2.assets/image-20231003214134488.png)

è¿™äº›æ¨¡å—æ˜¯å¦éƒ½åŠ è½½äº†ï¼Œå¯ä»¥é€šè¿‡ğŸ‘‡httpd -Mæ¥æŸ¥çœ‹ï¼Œå¯è§105ä¸ªæ¨¡å—ï¼ŒåŠ è½½äº†93ä¸ªã€‚

![image-20231003214446559](4-httpd2.assets/image-20231003214446559.png)



ğŸ‘‡è¿™å¼ å›¾å°±è¯´æ˜äº†ï¼Œç¡®å®æ˜¯ls /etc/httpd/modulesçš„æ¨¡å—mod_auth_basic.soåŠ è½½åé€šè¿‡httpd -Må¯è§çš„ğŸ‘‡

![image-20231003214700417](4-httpd2.assets/image-20231003214700417.png)



å…³äºæ¨¡å—åŠ è½½ä¹Ÿæ˜¯ç”±é…ç½®çš„ï¼ŒåŒæ ·åœ¨ä¸»é…ç½®æ–‡ä»¶/etc/httpd/conf/httpd.confé‡Œå¯æ‰¾åˆ°ğŸ‘‡

<img src="4-httpd2.assets/image-20231003215249068.png" alt="image-20231003215249068" style="zoom:50%;" />

ğŸ‘†è¯´æ˜è¦è¿›åˆ°/etc/httpd/conf.modules.d/ä¸‹çœ‹

![image-20231003215523172](4-httpd2.assets/image-20231003215523172.png)



![image-20231003215623706](4-httpd2.assets/image-20231003215623706.png)

ğŸ‘†è¿™æ ·å°±å°±çœ‹åˆ°äº†LoadModuleåŠ è½½å“ªäº›å…·ä½“çš„æ¨¡å—äº†ï¼Œè¿™å°±æ˜¯105ä¸ªæ¨¡å—ï¼ŒåŠ è½½äº†93ä¸ªçš„åŸå› ã€‚

![image-20231004115119779](4-httpd2.assets/image-20231004115119779.png)

æ³¨é‡Šåï¼Œå†æ¬¡çœ‹çœ‹åŠ è½½æ¨¡å—çš„æ•°é‡

æœç„¶å°‘äº†1ä¸ª

![image-20231004115743677](4-httpd2.assets/image-20231004115743677.png)

è®°å¾—æ¢å¤è¯¥æ¨¡å—çš„åŠ è½½ï¼Œåç»­è¦ç”¨

### æ‰€ä»¥è¿™ä¹Ÿæ˜¯åŠ è½½å’Œå¸è½½æ¨¡å—çš„æ–¹æ³•ğŸ‘†

æ€»ç»“å¦‚ä¸‹ï¼š

DSOï¼š Dynamic Shared Object

â€‹	åŠ è½½åŠ¨æ€æ¨¡å—é…ç½®ï¼Œä¸éœ€é‡å¯å³ç”Ÿæ•ˆ

â€‹		/etc/httpd/conf/httpd.conf 

â€‹		Include conf.modules.d/*.conf 

â€‹	é…ç½®æŒ‡å®šå®ç°æ¨¡å—åŠ è½½æ ¼å¼ï¼š

â€‹		LoadModule <mod_name> <mod_path>

æ¨¡å—æ–‡ä»¶è·¯å¾„å¯ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼šç›¸å¯¹äºServerRootï¼ˆé»˜è®¤/etc/httpdï¼‰

â€‹	ç¤ºä¾‹ï¼šLoadModule auth_basic_module modules/mod_auth_basic.so

åŠ¨æ€æ¨¡å—è·¯å¾„ï¼š /usr/lib64/httpd/modules/

æŸ¥çœ‹é™æ€ç¼–è¯‘çš„æ¨¡å—  httpd -l    # çœ‹çš„æ˜¯é™æ€ç¼–è¯‘çš„æ¨¡å—åŒºåˆ«shareçš„ï¼Œæ˜¯ç»‘å®šçš„æ¨¡å—ã€‚

æŸ¥çœ‹é™æ€ç¼–è¯‘åŠåŠ¨æ€è£…è½½çš„æ¨¡å—	httpd â€“M   # çœ‹çš„æ˜¯å…¨éƒ¨çš„åŒ…å«ï¼šshare(å…±äº«)æ¨¡å—å’Œstatic(é™æ€å…¶å®å¯ä»¥å«ç‹¬äº«)æ¨¡å—

![image-20231004123153330](4-httpd2.assets/image-20231004123153330.png)

ç„¶åstaticæ¨¡å—æ˜¯æ— æ³•é€šè¿‡ä¹‹å‰ä¸Šæ–‡è®²çš„ é…ç½®æ–‡ä»¶å» å¸è½½ï¼Œæ˜¯httpdæœåŠ¡æœ¬èº«è‡ªå¸¦çš„é»˜è®¤å°±æœ‰çš„ã€‚  çœŸè¦æƒ³"å¸è½½"ä¹Ÿå¯ä»¥---å°±æ˜¯æºç é‡Œå»æ‰ï¼Œé‡æ–°ç¼–è¯‘ã€‚ä¸è¿‡ä¼°è®¡å¸äº†ä¹Ÿå°±æ²¡æ³•ç”¨äº†ï¼Œè¿™ä¸ªè‡ªå¸¦çš„ä¼°è®¡æ˜¯coreæ ¸å¿ƒçš„ä¸œè¥¿ã€‚httpdè½¯ä»¶ç»„æˆæœ¬èº«å°±æ˜¯æ ¸å¿ƒcore+æ¨¡å—modulesã€‚



### MPM(Multi-Processing Module)å¤šè·¯å¤„ç†æ¨¡å—

å‰æ–‡è®²è¿‡preforkï¼Œworkerï¼Œeventï¼Œè¿™é‡Œè®²å¦‚ä½•è¿›è¡Œé…ç½®

ä»¥å‰ï¼šè¦è¿›è¡Œè¯¥å¤„ç†æ–¹å¼çš„åˆ‡æ¢ï¼Œéœ€è¦é‡æ–°ç¼–è¯‘ï¼Œå› ä¸ºæ˜¯ç»‘å®šåœ¨coreä»£ç æ¨¡å—é‡Œé¢çš„ã€‚

ç°åœ¨ï¼šä½†æ˜¯ä»centos7å¼€å§‹(å¥‡äº†æ€ªäº†ï¼Œéš¾é“ä¸æ˜¯ä»httpdçš„æŸä¸ªç‰ˆæœ¬å¼€å§‹å˜›ï¼Œæ€ä¹ˆè¿˜æ˜¯ä»centosç‰ˆæœ¬å¼€å§‹å‘¢)ï¼Œä¹Ÿæ”¯æŒé…ç½®æ–‡ä»¶çš„æ–¹å¼æ¥åˆ‡æ¢äº†ã€‚



é»˜è®¤å¤„ç†æ–¹å¼æ˜¯ï¼šä»¥å‰å¥½åƒæ˜¯prefork--å°±æ˜¯ä¸€ä¸ªä¸»è¿›ç¨‹-å¤šä¸ªå­è¿›ç¨‹-æ¯ä¸ªå­è¿›ç¨‹é‡Œåªå¼€ä¸€ä¸ªçº¿ç¨‹ï¼›ç°åœ¨ä¸æ˜¯äº†ï¼Œç°åœ¨å¥½åƒæ˜¯event(å¯ä»¥å»/etc/httpd/conf.modules.d/00-mpm.confå¯è§å°±æ˜¯event)ï¼Œæœ‰3680ç‹¬ç«‹çš„å­è¿›ç¨‹ï¼Œè¿˜æœ‰å‡ ä¸ªäº†å¾ˆå¤šçº¿ç¨‹çš„å­è¿›ç¨‹ã€‚

![image-20231004124607028](4-httpd2.assets/image-20231004124607028.png)

![image-20231004124642569](4-httpd2.assets/image-20231004124642569.png)

![image-20231004124727914](4-httpd2.assets/image-20231004124727914.png)

ä¸è¿‡é€šè¿‡ps auxfçœ‹åˆ°çš„åªæ˜¾ç¤ºåˆ°å­è¿›ç¨‹ã€‚çº¿ç¨‹å°±ä¸æ˜¾ç¤ºäº†ğŸ‘‡

![image-20231004125001421](4-httpd2.assets/image-20231004125001421.png)

ps -efä¸€æ ·

![image-20231004125116398](4-httpd2.assets/image-20231004125116398.png)

ç„¶åè¿›ç¨‹æ•°ä¸æ˜¯é™æ­»çš„ï¼Œå¦‚æœè¿›ç¨‹æ•°ä¸å¤Ÿï¼Œä¾ç„¶ä¼šå¢åŠ çš„ã€‚ä¸è¿‡è¿™é‡Œæ¶‰åŠçº¿ç¨‹ï¼Œä¸çŸ¥é“å…·ä½“çš„å¢åŠ ç»†èŠ‚äº†ï¼Œå¯èƒ½å…ˆå¢åŠ çº¿ç¨‹å§ã€‚

![image-20231004125739459](4-httpd2.assets/image-20231004125739459.png)

æ²¡æœ‰è®²æ˜¯Unixåˆ°åº•æ˜¯é»˜è®¤å“ªä¸ªï¼Ÿ

çœ‹é…ç½®æ–‡ä»¶ï¼Œæœç„¶æ˜¯eventğŸ‘‡

![image-20231004125840593](4-httpd2.assets/image-20231004125840593.png)

ä¿®æ”¹æ–¹æ³•ï¼Œå®˜ç½‘æŸ¥çœ‹è·¯å¾„

<img src="4-httpd2.assets/image-20231004130216634.png" alt="image-20231004130216634" style="zoom:50%;" />

![image-20231004130146111](4-httpd2.assets/image-20231004130146111.png)

å¦ˆçš„ï¼Œå“ˆå“ˆï¼ŒæŸ¥ä¸ªå±ï¼Œ/etc/httpd/conf.modules.d/00-mpm.confé‡Œå†™çš„å¥½å¥½çš„ï¼Œä½ ä¸Šé¢æˆªå›¾çš„æ—¶å€™çœ‹ä¸åˆ°ï¼Œé å“¦ï¼Œä»€ä¹ˆçœ¼ç¥ã€‚

è¿™é‡Œæ³¨é‡ŠåŸæ¥çš„ï¼Œå–æ¶ˆæ‰€éœ€çš„å°±è¡Œäº†

![image-20231004130646356](4-httpd2.assets/image-20231004130646356.png)

é‡å¯åï¼Œå†pstree -p åº”è¯¥å°±æ²¡æœ‰èŠ±æ‹¬å·--ä¹Ÿå°±æ˜¯æ²¡æœ‰çº¿ç¨‹äº†ï¼Œç»“æœäº‹ä¸æ„¿è¿

![image-20231004130821032](4-httpd2.assets/image-20231004130821032.png)

ğŸ‘†è¿˜æ˜¯æœ‰ä¸€å †çº¿ç¨‹å•Šï¼Œä¸€ä¸ªè¿›ç¨‹é‡Œå¼€äº†å¥½å¤šçº¿ç¨‹ï¼Œå¥‡æ€ªäº†ã€‚ä¸è¿‡æ›´åƒworkerã€‚



å†åˆ‡æˆworker

![image-20231004131112527](4-httpd2.assets/image-20231004131112527.png)

å‘ç°workerå¼€å¯çš„çº¿ç¨‹è¦å¤šäº†å»äº†ï¼Œå’Œeventä¸€æ ·å¤šã€‚

![image-20231004131143577](4-httpd2.assets/image-20231004131143577.png)

![image-20231004131150578](4-httpd2.assets/image-20231004131150578.png)

![image-20231004131158239](4-httpd2.assets/image-20231004131158239.png)

æ‰€ä»¥ï¼Œæˆ‘è§‰çš„ï¼Œæ–°ç‰ˆæœ¬çš„preforkä¹Ÿä¸æ˜¯åŸæ¥çš„preforkäº†ï¼Œä¸æ˜¯ä¸€ä¸ªè¿›ç¨‹é‡Œå°±å¼€ä¸€ä¸ªçº¿ç¨‹äº†ï¼Œç¡®å®å¯è§å¼€äº†ä½†å¼€çš„ä¸å¤šï¼Œç›¸æ¯”è€Œè¨€ çº¿ç¨‹å¼€å¯çš„æ•°é‡è¿œè¿œå°äºeventæˆ–è€…workerã€‚

é€šè¿‡pstree -p æ˜¯æ— æ³•åŒºåˆ†workerå’Œeventçš„ï¼Œeventæ˜¯æ¯ä¸€ä¸ªå­è¿›ç¨‹é‡Œçš„å¤šä¸ªçº¿ç¨‹ä¸­æœ‰ä¸€ä¸ªæ˜¯ç›‘å¬çº¿ç¨‹ï¼Œè¿™æ˜¯é‡Œé¢ç¨‹åºè°ƒåº¦çš„äº‹æƒ…äº†ï¼Œæ— æ³•åœ¨pstreeä¸­æŸ¥çœ‹çš„ã€‚



ä¸è¿‡æˆ‘å¥½å¥‡çš„æ˜¯ä¸ºä»€ä¹ˆç°åœ¨çš„preforkä¸æ˜¯å•çº¯çš„ä¸€ä¸ªå­è¿›ç¨‹é‡Œä»…ä»…ä¸€ä¸ªçº¿ç¨‹äº†ã€‚

![image-20231004131908159](4-httpd2.assets/image-20231004131908159.png)



### æµ‹è¯•mpmçš„eventå’Œpreforkçš„å¹¶å‘èƒ½åŠ›workeråŒç†

![image-20231004211630339](4-httpd2.assets/image-20231004211630339.png)

è®°å¾—ä¿®æ”¹é¡µé¢æ–‡ä»¶çš„è®¿é—®æƒé™

![image-20231004212338485](4-httpd2.assets/image-20231004212338485.png)

æµ‹è¯•CLI

![image-20231004212700484](4-httpd2.assets/image-20231004212700484.png)

-C1000å°±æ˜¯1000ä¸ªå¹¶å‘ï¼ŒåŒæ—¶å»serverä¸Šçœ‹çœ‹å¹¶å‘é‡ï¼›-n æ˜¯å‘åŠ¨çš„requestä¸ªæ•°ã€‚

![image-20231004212747287](4-httpd2.assets/image-20231004212747287.png)

ps auxçœ‹åˆ°çš„æ˜¯è¿›ç¨‹æ¶¨äº†å¾ˆå¤šï¼ŒåŸæ¥å°±æ˜¯å‡ ä¸ªï¼Œç°åœ¨æ˜¯258ä¸ª

pstreeçœ‹åˆ°çš„éƒ½æ˜¯çº¿ç¨‹æ•°ï¼Œ1296ä¸ªäº†å·²ç»ã€‚

![image-20231004212853576](4-httpd2.assets/image-20231004212853576.png)

ç­‰äº†ä¸€å°ä¼šğŸ‘†ç»“æœè¢« serverç«¯resetäº†ï¼Œè¯´æ˜è¯·æ±‚é‡å¤ªå¤§äº†å§ï¼Œå‡å°‘è¯·æ±‚é‡ç»§ç»­æµ‹è¯•

![image-20231004213603426](4-httpd2.assets/image-20231004213603426.png)

åœ¨ğŸ‘†ä¸Šå›¾abæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå¤šæ¬¡åœ¨serverç«¯æŸ¥çœ‹å¹¶å‘æƒ…å†µğŸ‘‡

![image-20231004213747462](4-httpd2.assets/image-20231004213747462.png)

PSï¼šä¸Šå›¾ğŸ‘†æåˆ°çš„æ­¤æ—¶ restart ä¼šç­‰è›®ä¹…ï¼Œæˆ‘è§‰çš„ä¸ä¸€å®šæ˜¯abçš„å¹¶å‘å›æ”¶æ…¢é€ æˆçš„ï¼Œæœ¬èº«httpdæœåŠ¡é‡å¯å°±æ…¢ï¼Œæœ‰æ—¶å€™å¿«ï¼Œè¿‡åŠçš„æ—¶å€™æ„Ÿè§‰éƒ½æ˜¯æ…¢çš„ï¼Œä»å‰é¢ä¸æ–­çš„é‡å¯åŠ¨ä½œå¾—å‡ºçš„ç»éªŒè¿™æ˜¯ã€‚

å¥½ï¼Œç¬¬ä¸€ä¸ªprefork mpmçš„å¹¶å‘ç»“æœæœ‰äº†ï¼Œä¸»è¦å°±æ˜¯çœ‹Request per secondï¼Œæ¯ç§’å¤„ç†äº†3ä¸ªè¯·æ±‚ã€‚è¿™æ˜¯å¹³å‡æµ‹è¯•ç»“æœã€‚

![image-20231004214256700](4-httpd2.assets/image-20231004214256700.png)



å†ä¿®æ”¹ä¸ºevent mpmæ¥æµ‹è¯•ä¸‹

![image-20231004214517223](4-httpd2.assets/image-20231004214517223.png)

å¤šæ¬¡æŸ¥çœ‹è¿›ç¨‹æ•°å’Œçº¿ç¨‹æ•°æ²¡æœ‰å˜åŒ–ï¼Œè¯´æ˜è¯¥é‡Šæ”¾çš„éƒ½é‡Šæ”¾äº†ï¼Œè€Œä¸”6ä¸ªè¿›ç¨‹å’Œ209ä¸ªçº¿ç¨‹åŸºæœ¬ä¸Šå°±æ˜¯eventçš„åˆå§‹å¼€å¯çš„é‡äº†ã€‚

ç„¶åab å‘½ä»¤èµ°ä¸€æ³¢

ç„¶è€Œè¿™é‡Œä»…ä»…çœ‹requests per secondå‘ç°eventåè€Œåªæœ‰3.08ï¼Œè¦å°äºperforkçš„3.13å“ˆå“ˆï¼Œæ€ä¹ˆå¯èƒ½ï¼Œä¸è¿‡ç»¼åˆå¼€è¿›ç¨‹å’Œçº¿ç¨‹çš„å¼€å¯æ•°é‡ï¼Œeventæ˜¯è¦è¿œè¿œå°äºperforkçš„ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹å°±æ˜¯eventè¦æ›´åŠ èŠ‚çœèµ„æºçš„ã€‚æ¢å¥è¯è¯´å¦‚æœç›¸åŒèµ„æºçš„æ¶ˆè€—ä¸‹eventçš„å¹¶å‘å¤„ç†å°±ä¼šè¿œè¿œé«˜äºpreforkäº†ã€‚   å¦å¤–ä¸ºå•¥eventæ¨¡å¼ç³»ç»ŸæœåŠ¡æ²¡æœ‰å¤šå¼€å†™è¿›ç¨‹å’Œçº¿ç¨‹ï¼Œè®©å¤„ç†é‡ä¸Šä¸€ä¸ªå°é˜¶ï¼Œè¿™å°±ä¸çŸ¥é“äº†ï¼Œå¯èƒ½æœåŠ¡åˆ¤æ–­å¤„ç†çš„é€Ÿåº¦è¿˜è¡Œæ— éœ€å¢åŠ èµ„æºå¼€é”€ã€‚

![image-20231004215240906](4-httpd2.assets/image-20231004215240906.png)

ç„¶åä¸Šå›¾ğŸ‘†æµ‹è¯•æœŸé—´ï¼Œå¹¶å‘æ²¡å•¥å¤§å˜åŒ–ï¼Œç»“æŸäº†5åˆ†é’Ÿå·¦å³ï¼Œä¹Ÿä¸è§å›æ”¶1ä¸ªçº¿ç¨‹

![image-20231004215601418](4-httpd2.assets/image-20231004215601418.png)

æä¸æ‡‚ã€‚ã€‚ã€‚å“ˆå“ˆï¼Œç»§ç»­å¾€ä¸‹çœ‹å§ï¼Œè¿™é‡Œå…ˆè¿™æ ·ï¼Œå¹¶å‘æµ‹è¯•



å¶ç„¶çœ‹åˆ°è¿™ç¯‡

https://lvwenhan.com/tech-epic/500.html

éœ€è¦è‡ªè¡Œç ”ç©¶ä¸‹çš„æ„Ÿè§‰ğŸ‘†

ç„¶åï¼Œè¿™ä¸ªURLåªæ˜¯è¯¥ä½œè€…çš„ä¸€ç¯‡ï¼Œå…¨éƒ¨çš„é«˜å¹¶å‘åœ¨è¿™é‡Œhttps://github.com/johnlui/PPHCï¼ŒæŒºç‰›é€¼ã€‚ä¸æ˜¯æˆ‘ç°åœ¨è¯¥å»çœ‹çš„ï¼Œä¸è¿‡åƒinnodbã€åˆ†å¸ƒå¼dbã€K8Sï¼Œè¿™äº›ç¡®å®æ˜¯æˆ‘çš„æ–¹å‘ï¼Œæ‰€ä»¥è¿™ä¸ªblogæˆ‘æ„Ÿè§‰ç¡®å®æ˜¯å¤§ä½¬çº§çš„ã€‚



### å¹¶å‘æ•°è¶…äº†-clientçš„socketæ‰“å¼€æ•°

![image-20231005103954158](4-httpd2.assets/image-20231005103954158.png)

è¯´æ˜¯æ”¶åˆ°ulimit -aé‡Œçš„æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶

![image-20231005104112961](4-httpd2.assets/image-20231005104112961.png)

è¿æ¥æ•°ï¼Œæœ€ç»ˆå°±æ˜¯æ‰“å¼€çš„socketæ–‡ä»¶ï¼Œlinuxä¸€åˆ‡çš†æ–‡ä»¶ã€‚

è°ƒå¤§ä¹Ÿæ²¡æœ‰ç”¨ï¼Œå¯èƒ½æ˜¯ä¸æ­¢è°ƒè¿™ä¸€ä¸ªåœ°æ–¹ã€‚

![image-20231005104315085](4-httpd2.assets/image-20231005104315085.png)

å“¦ï¼Œæ“~~~ï¼ æ˜¯CLIæ•²é”™äº†ï¼Œå¹¶å‘-c 1010 å¤§äºæ€»æ•° -n 1000äº†ï¼Œè¿™ç®—ä¹Œé¾™å§~

<img src="4-httpd2.assets/image-20231005104521858.png" alt="image-20231005104521858" style="zoom:33%;" />



æé”™äº†~å†æ¥ä¸€éğŸ‘‡

![image-20231005105039105](4-httpd2.assets/image-20231005105039105.png)



è°ƒå¤§socket æ–‡ä»¶ä¸Šé™ï¼Œç¡®å®å°±å¯ä»¥äº†

![image-20231005105236764](4-httpd2.assets/image-20231005105236764.png)





### å¹¶å‘è¶…äº†-serverç«¯çš„è¿›ç¨‹æ•°

åœ¨serverç«¯æ”¹ä¸ºperforkè¿›è¡Œæµ‹è¯•

![image-20231005111041626](4-httpd2.assets/image-20231005111041626.png)



å¤§é¡µé¢æ–‡ä»¶çš„å¹¶å‘ï¼Œç»“æœå°±æ˜¯è¢«server resetäº†ï¼Œè¶…å‡ºäº†serverçš„æ‰¿å—èƒ½åŠ›--å°±æ˜¯è¿›ç¨‹æ•°è¶…äº†ï¼Œå¤§é¡µé¢æ–‡ä»¶ä¸‹è½½çš„æ…¢ï¼Œè¿›ç¨‹å ç”¨æ—¶é—´é•¿ï¼Œå›æ”¶çš„æ…¢ï¼Œä¸å¤Ÿç”¨äº†ã€‚

![image-20231005110445445](4-httpd2.assets/image-20231005110445445.png)

æ”¹æˆå°æ–‡ä»¶å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥ä¸‹é¢ç ”ç©¶ä¸‹serverçš„å¤„ç†ä¸Šé™é—®é¢˜ï¼Œå°æ–‡ä»¶æµ‹è¯•çš„æ—¶å€™ï¼Œserverçš„è¿›ç¨‹æ•°æ˜¯å¤Ÿç”¨çš„ï¼Œå› ä¸ºå›æ”¶çš„å¿«ï¼Œå°é¡µé¢æ‰“å¼€(ä¸‹è½½)å¤„ç†çš„å¿«ï¼Œè¿›ç¨‹å›æ”¶çš„å¿«ï¼Œæ‰€ä»¥å¤Ÿç”¨

![image-20231005110535388](4-httpd2.assets/image-20231005110535388.png)



### prefork çš„ é… ç½® 



![image-20231005113344862](4-httpd2.assets/image-20231005113344862.png)



 **StartServers** 	     # è¿™æ˜¯ä¸€å¼€å§‹çš„ps auxf |grep httpd é»˜è®¤å¼€å¯çš„è¿›ç¨‹æ•°

![image-20231005112946957](4-httpd2.assets/image-20231005112946957.png) 

perforké»˜è®¤æ˜¯å¼€5ä¸ªè¿›ç¨‹æ•°

ç„¶åçº¿ç¨‹å¼€çš„ä¹Ÿä¸å¤š

![image-20231005113049683](4-httpd2.assets/image-20231005113049683.png)



**StartServers** 				**8 **			# åˆå§‹å¼€å¯8ä¸ªè¿›ç¨‹

**MinSpareServers 			5 **     	#  æœ€å°‘ä¿ç•™5ä¸ªç©ºé—²è¿›ç¨‹

**MaxSpareServers 			20**		# æœ€å¤šä¿ç•™20ä¸ªç©ºé—²è¿›ç¨‹

è¿èµ·æ¥çš„æ„æ€å°±æ˜¯ï¼Œ8ä¸ªåˆå§‹è¿›ç¨‹éšç€ç”¨æˆ·è¯·æ±‚å˜å¤šï¼Œä¼šå¼€å¯çš„è¶Šæ¥è¶Šå¤šï¼›

ä½†æ˜¯è‡³å°‘ä¿ç•™5ä¸ªç©ºé—²çš„è¿›ç¨‹ä¸åˆ†é…å‡ºå»ï¼Œæ¯”å¦‚ä»8æ¶¨åˆ°100è¿›ç¨‹ï¼Œé‚£ä¹ˆä¼šå¼€105ä¸ªã€‚

å½“ç”¨æˆ·è¯·æ±‚ä¸‹é™äº†ï¼Œé‚£ä¹ˆæ¯”å¦‚100ä¸ªç”¨æˆ·è¯·æ±‚å¤§æ–‡ä»¶ï¼Œ100ä¸ªè¿›ç¨‹å¼€ç€ï¼Œéšç€è¯·æ±‚å¤„ç†ç»“æŸï¼Œè¿™ä¸ª100è¿›ç¨‹ä¼šå›æ”¶80ä¸ªï¼Œç•™20ä¸ªç©ºé—²ï¼Œå› ä¸ºæœ€å¤š20ä¸ªã€‚

æˆ‘æ˜¯è¿™ä¹ˆç†è§£çš„ğŸ‘†











 **ServerLimit 						256æœ€å¤šè¿›ç¨‹æ•°,æœ€å¤§20000**

![image-20231005115358268](4-httpd2.assets/image-20231005115358268.png)

2000æˆ–è€…20Wå¯èƒ½å’ŒMPMæ¨¡å‹æœ‰å…³



MaxRequestsPerChild 		4000 å­è¿›ç¨‹æœ€å¤šèƒ½å¤„ç†çš„è¯·æ±‚æ•°é‡ã€‚åœ¨å¤„ç† MaxRequestsPerChild ä¸ªè¯·æ±‚ä¹‹å,å­è¿›ç¨‹å°†ä¼šè¢«çˆ¶è¿›ç¨‹ç»ˆæ­¢ï¼Œè¿™æ—¶å€™å­è¿› ç¨‹å ç”¨çš„å†…å­˜å°±ä¼šé‡Šæ”¾(ä¸º0æ—¶æ°¸è¿œä¸é‡Šæ”¾ï¼‰





![image-20231005115651327](4-httpd2.assets/image-20231005115651327.png)





ç„¶åä¿®æ”¹ä¸€ä¸‹é…ç½®

<img src="4-httpd2.assets/image-20231005214201480.png" alt="image-20231005214201480" style="zoom:50%;" />

ç„¶åé‡å¯æœåŠ¡

<img src="4-httpd2.assets/image-20231005214233007.png" alt="image-20231005214233007" style="zoom:50%;" />



ç„¶åçœ‹ä¸‹å¯¹åº”çš„å‚æ•°æ˜¯å¦è½å®

![image-20231005214353694](4-httpd2.assets/image-20231005214353694.png)



![image-20231005214910043](4-httpd2.assets/image-20231005214910043.png)



ä¿®æ”¹MaxClientsä¸º2560å‘ç°ç¡®å®è°ƒå¤§äº†ï¼Œè€Œä¸”è¯¥å‚æ•°å®˜æ–¹ç½‘ç«™ä¸Šæ˜¯æ‰¾ä¸åˆ°çš„ï¼Œå¯èƒ½æ˜¯æ—©æœŸç‰ˆæœ¬çš„å‚æ•°åœ¨2.4é‡Œæ²¡æœ‰å†™ï¼Œä½†æ˜¯ä¾ç„¶æœ‰æ•ˆã€‚

![image-20231005215037524](4-httpd2.assets/image-20231005215037524.png)

![image-20231005215231550](4-httpd2.assets/image-20231005215231550.png)

ç„¶åMaxClients 2560è¿™ä¸ªè°ƒå¤§äº†ä»¥åï¼ŒStartServers 2000è¿™ä¸ªåˆå§‹çš„å­è¿›ç¨‹æ•°å°±å¯¹äº†2000ä¸ªå°±OKäº†

![image-20231005215432844](4-httpd2.assets/image-20231005215432844.png)

ä»¥ä¸Šæ˜¯é—´éš”3-5åˆ†é’Ÿå¤šæ¬¡é”®å…¥çš„ï¼ŒğŸ‘‡é—´éš”2åˆ†é’Ÿå¤šæ¬¡è¾“å…¥çš„å‘½ä»¤ï¼Œè¯´æ˜æ­¤æ—¶å­è¿›ç¨‹æ•°å’Œçº¿ç¨‹æ•°æ¶¨åœğŸ‘‡ã€‚

![image-20231005215502265](4-httpd2.assets/image-20231005215502265.png)

![image-20231005215717815](4-httpd2.assets/image-20231005215717815.png)

è¿™ä¸ªå‚æ•°æ˜¯httpd 2.2ç‰ˆæœ¬é‡Œçš„å‚æ•°ã€‚

![image-20231005215758566](4-httpd2.assets/image-20231005215758566.png)



ç”±äºæ­¤æ—¶è¿›ç¨‹æ•°è°ƒå¤§äº†ï¼Œå†æ¬¡ç”¨abæµ‹è¯•ä¸€ä¸‹

è¿™æ˜¯ğŸ‘‡æœ¬ç¯‡ ä¸Šæ–‡çš„ å†…å®¹--ä¹‹å‰abæµ‹è¯•çš„ç»“æœ

![image-20231005215948912](4-httpd2.assets/image-20231005215948912.png)

è¿™æ˜¯ğŸ‘‡è°ƒå¤§å‚æ•°åçš„æµ‹è¯•ç»“æœğŸ‘‡ï¼Œè‚¯å®šå°±å¯ä»¥äº†å› ä¸ºserveråˆå§‹åŒ–äº†2000ä¸ªè¿›ç¨‹ï¼Œè¿™é‡Œabæµ‹è¯•æ—¶1500ä¸ªå¹¶å‘ï¼Œè€Œä¸”2.4çš„preforkè™½ç„¶2000ä¸ªè¿›ç¨‹ï¼Œä½†æ˜¯åŒæ ·ä¹Ÿå¼€å¯äº†çº¿ç¨‹1W+äº†éƒ½ï¼Œè‚¯å®šæ”¯æŒ1500ä¸ªtcpè¿æ¥äº†ã€‚

åŒæ ·æ­¤æ—¶å†…å­˜æ¶ˆè€—ä¹Ÿå¤§ï¼šserverç«¯ğŸ‘‡

![image-20231005220148591](4-httpd2.assets/image-20231005220148591.png)

çœ‹ä¸‹ç°åœ¨çš„æµ‹è¯•ç»“æœğŸ‘‡ï¼Œç¡®å®ä¸å†æŠ¥é”™ï¼Œä½†æ˜¯å†…å­˜è¦å¤Ÿçš„ï¼Œå¥½åœ¨æˆ‘çš„å†…å­˜è¿˜è¡Œç»™çš„ã€‚æ€ä¹ˆåˆ¤æ–­ç»™çš„å†…å®¹å¤Ÿä¸å¤Ÿï¼Œç®€å•ï¼Œfree -h çœ‹çœ‹æ¶¨ä¸æ¶¨ä¸å°±è¡Œäº†ï¼Œæ²¡å˜åŒ–å°±æ˜¯å¤Ÿç”¨äº†--ä¸Šå›¾å°±æ˜¯å†…å­˜ï¼š2.8Gç”¨äº†ã€‚

![image-20231005220502216](4-httpd2.assets/image-20231005220502216.png)



![image-20231005220534024](4-httpd2.assets/image-20231005220534024.png)

è¿›ç¨‹æ•°ä¹Ÿæ¶¨äº†å†™ï¼Œçº¿ç¨‹åŒæ ·æ¶¨äº†ï¼Œè¯´æ˜2000ä¸ªåˆå§‹å­è¿›ç¨‹StartServersè¿˜ä¸å¤Ÿï¼Œå› ä¸ºm.txtå¤ªå¤§äº†

![image-20231005220925971](4-httpd2.assets/image-20231005220925971.png)



åŠå¤©10åˆ†é’Ÿè¿‡å»äº†ï¼Œ 1500ä¸ªå¹¶å‘å°±ç¬é—´æ¶ˆè€—1500ä¸ªtcpï¼Œç„¶åè¦è®¿é—®2000æ¬¡ï¼Œm.txtåˆå¤ªå¤§ï¼Œä¸‹è½½è€—æ—¶é•¿tcpå¾—ä¸åˆ°é‡Šæ”¾ï¼Œä»ç¬¬ä¸€ä¸ªtcpå»ºç«‹åˆ°æœ€åä¸€tcpé‡Šæ”¾ï¼Œå†ç»äº†ä¸€å…±1500*2000=30 00 000 æ¬¡çš„tcpè¿æ¥ã€‚å‰é¢é¡µé¢åŠ è½½å®Œm.txtå°±ä¼šå¾—åˆ°é‡Šæ”¾å§--æ„Ÿè§‰ä¼šé‡Šæ”¾-ä¸è¿‡é‡Šæ”¾çš„æ¡ä»¶å¯èƒ½æ—¶timeoutå’Œä¸Šé¢è®¾ç½®çš„4000ä¸ªè¯·æ±‚æ•°MaxRequestsPerChildã€‚

![image-20231005221013256](4-httpd2.assets/image-20231005221013256.png)



æ€»ç»“

ServerLimitå’ŒMaxClientséƒ½æ˜¯é™åˆ¶æœ€å¤§å¹¶å‘è¿æ¥çš„å‚æ•°ï¼Œéƒ½éœ€è¦æ”¹çš„ã€‚



### worker MPMçš„å‚æ•°

![image-20231005221452020](4-httpd2.assets/image-20231005221452020.png)

threads ä¸€èˆ¬è¡¨ç¤ºçº¿ç¨‹ï¼Œpythoné‡Œçš„import ä¹Ÿæ˜¯è¿™ä¹ˆè¡¨ç¤ºçš„

![image-20231005221714878](4-httpd2.assets/image-20231005221714878.png)

MinSpareThreads æœ€å°ç©ºé—²çº¿ç¨‹

ThreadsPerChild 25 å°±æ˜¯ æ¯ä¸ªå­è¿›ç¨‹é‡Œå¼€25ä¸ªçº¿ç¨‹ï¼Œç›´æ¥çœ‹GPTçš„è§£é‡Šå§ğŸ‘‡

![image-20231005222134918](4-httpd2.assets/image-20231005222134918.png)



![image-20231005222246436](4-httpd2.assets/image-20231005222246436.png)

