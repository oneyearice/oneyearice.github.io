# 第3节. httpd软件工作模型



# URI

**URI: Uniform Resource Identifier 统一资源标识，分为URL和URN**

​	>	URN: Uniform Resource Naming，统一资源命名

​					示例： P2P下载使用的磁力链接是URN的一种实现 magnet:?xt=urn:btih:6605589.....890EF888666

​	>	URL: Uniform Resorce Locator，统一资源定位符，用于描述某服务器某特定资源位置。

两者区别：URN如同一个人的名称，而URL代表一个人的住址。换言之， URN定义某事物的身份，而URL提供查找该事物的方法。URN仅用于命名， 而不指定地址

<img src="3-httpd软件工作模型.assets/image-20230926170209512.png" alt="image-20230926170209512" style="zoom:50%;" />

额，看来URI真的很多啊，哈哈哈



其实URL使用是最多的，URI里面虽然包含了很多，但是URL是最最多的，所以通常人们提到屌丝的时候，大概也不是什么赞美，哎哎哎，通常工作中URI和URL其实是混为一谈的，不必较真。但是你自己说出来的就得是URL





# URL组成

![image-20230926174512659](3-httpd软件工作模型.assets/image-20230926174512659.png)

URL格式：

```
<scheme>://<user>:<password>@<host>:<port>/<path>;<params>?<query>#<frag>
```

**scheme**:方案，访问服务器以获取资源时要使用哪种协议，比如https://，这就是scheme，ftp://也是schema，不同的scheme其实就是不同的协议，自然后面的port也就不同。
**user**:用户，某些方案访问资源时需要的用户名      # 基本不用
**password**:密码，用户对应的密码，中间用：分隔      # 基本不用
**Host**:主机，资源宿主服务器的主机名或IP地址
**port**:端口,资源宿主服务器正在监听的端口号，很多方案有默认端口号
**path**:路径,服务器资源的本地名，由一个/将其与前面的URL组件分隔
**params**:参数，指定输入的参数，参数为名/值对，多个参数，用;分隔      # 名/值对，就是在说 键值对的形式
**query**:查询，传递参数给程序，如数据库，用？分隔,多个查询用&分隔    #  这个比较常见，👇cat是类型的简写。

<img src="3-httpd软件工作模型.assets/image-20230926181328783.png" alt="image-20230926181328783" style="zoom:50%;" />

上图👆?cat=670,671,672实际上就是mysql的select * from goods where cat='670,671,672';



**frag**:片段,一小片或一部分资源的名字，此组件在客户端使用，用#分隔      这个是跳转，比如业内跳转到下面的内容。

​        当点击M的时候👇，就等价于在URL后面补一个#m，这就是frag片段，可用来直接跳转到下面的特定行。

![image-20230927101506329](3-httpd软件工作模型.assets/image-20230927101506329.png)



![image-20230927101526588](3-httpd软件工作模型.assets/image-20230927101526588.png)





---



![image-20230926181801624](3-httpd软件工作模型.assets/image-20230926181801624.png)

&就是select里的and，翻译成DQL就是select * from goods where cat='670,671,672' and ev='exbrand_华为(HUAWEI)^' and cid3='672';   这里还涉及%2C就是,逗号     然后%5E好像是^脱字符，

<img src="3-httpd软件工作模型.assets/image-20230926182329805.png" alt="image-20230926182329805" style="zoom:50%;" />





<img src="3-httpd软件工作模型.assets/image-20230926182640685.png" alt="image-20230926182640685" style="zoom:50%;" />





![image-20230927103727240](3-httpd软件工作模型.assets/image-20230927103727240.png)







## 网站访问量

**IP(独立IP)**：即Internet Protocol,指独立IP数。一天内来自相同客户机IP地址只 计算一次，记录远程客户机IP地址的计算机访问网站的次数，是衡量网站流量 的重要指标；

​			需要注意的是，IP不代表一个用户，一个公司可能出口就是一个IP。



**PV(访问量)**：	即Page View, 页面浏览量或点击量，用户每次刷新即被计算一 次，PV反映的是浏览某网站的页面数，PV与来访者的数量成正比，PV并不是页 面的来访者数量，而是网站被访问的页面数量;

​			PV,是页面刷新一次就算一次， 叫页面点击量，我觉的前提是你的业务不涉及自动刷新功能吧。



**UV(独立访客)**：即Unique Visitor,访问网站的一台电脑为一个访客。一天内相 同的客户端只被计算一次。可以理解成访问某网站的电脑的数量。网站判断来 访电脑的身份是通过来访电脑的cookies实现的。如果更换了IP后但不清除 cookies，再访问相同网站，该网站的统计中UV数是不变的

​			这里涉及cookies标识用户身份，按上文描述，IP就算换了，缓存还在cookies还在，用户身份不变的，这其实好理解，类似缓存一样，身份老的cookies一直在那呢，所以server还是认为同一个用户。



网站统计：http://www.alexa.cn/rank/



### 网站统计实例

![image-20230927114419964](3-httpd软件工作模型.assets/image-20230927114419964.png)



### 网站访问量

![image-20230927114430684](3-httpd软件工作模型.assets/image-20230927114430684.png)





# web服务请求处理步骤



## **一次完整 的http请求处理过程**

![image-20230927114348800](3-httpd软件工作模型.assets/image-20230927114348800.png)

## **1、建立连接：接收或拒绝连接请求**

​			三次握手后，发http请求过去，对方收到后去判断是否为合法用户，来判断是否接收和拒绝。



## **2、接收请求：接收客户端请求报文中对某资源的一次请求的过程**

​			接收请求会有多种响应模型，统称为web I/O响应模型👇：

​				**Web访问响应模型（Web I/O）**
​					**单进程I/O模型**：启动一个进程处理用户请求，而且一次只处理一个，多个 请求被串行响应

​					**多进程I/O模型**：并行启动多个进程,每个进程响应一个连接请求

​					**复用I/O结构**：启动一个进程，同时响应N个连接请求 

​						实现方法：多线程模型和事件驱动
​								多线程模型：一个进程生成N个线程，每线程响应一个连接请求
​								事件驱动：一个进程处理N个请求

​					**复用的多进程I/O模型**：启动M个进程，每个进程响应N个连接请求，同时接 收M*N个请求

就是讲了一个服务器的进程-线程，处理单-多用户请求的情况。

前面提到的tcp连接里多个请求并发，和这里的关系就是tcp连接就是用户连接请求。



### web访问响应模型

<img src="3-httpd软件工作模型.assets/image-20230927134429743.png" alt="image-20230927134429743" style="zoom:50%;" />

(c) 就是单进程 通过"连接复用器"来对接多个连接请求，思路如下👇： 不知道这个连接复用器是否是多线程还是指的是事件驱动呢？好像是的，连接服用可能也是事件驱动的一种应用场景，什么应用场景--就是网络连接的事件驱动下产生的连接服用器这么一个效果。俺是这样理解了~

​		①这里涉及一个情况：就是一堆用户的请求连接过来，server需要从DB里调用数据资源取到后才能给到用户响应response，所以不是每个用户的请求都能够立即响应的，也不需要立刻响应的，就算该进程就为一个用户服务，也会存在 调用资源没法立即响应的情况。所以这有了连接复用器的 发挥空间。

​			同样再梳理一遍：连接复用器 也叫 连接池 ，这个pool里就接收用户发起的请求，比如来个7个用户(7剑夏天山)，但是立即需要处理的请求不是所有的用户，用户的响应，需要server去磁盘上或者db里找到对应的文件数据资源。这些资源在server找到之前，是不需要和回应用户的，此时只需要和用户保持连接(长连接)就行。

​			比如针对某个用户的网页请求，server已经把对应的网页文件已经从磁盘上调度/加载到当前的进程里了，此时就可以回应他了。

​			所以server回应用户，涉及后端的  数据查找-网页文件合并？-加载到进程？ 大概这些步骤吧。

结合下图👇理解一下，accept函数调用后，就接收client的connect，开启一个新的socket就是一个连接，通过这个socket连接来响应用户请求，这一个连接就是上面讨论的用户请求，一个socket通常不会独享也给进程，都是多个socket通过连接复用器来共享一个进程的。

<img src="3-httpd软件工作模型.assets/image-20230927143547740.png" alt="image-20230927143547740" style="zoom:50%;" />

在后面讲到nginx的时候，会展开说，一个进程并发给多个用户响应，背后有一些复杂的I/O模型，涉及 阻塞、非阻塞、复用多路复用。



(d) 其实就是(c)的进一步，比如nginx，会开一个主进程，然后有几个颗CPU，就开几个子进程，然后每个子进程来讲，就是一个(c)结构。每个子进程再为多个用户提供响应服务。



不过图中提到的都是线程，而不是进程，这一点也有不同，我才可能是这样，niginx为例，①主进程一个②几个CPU开启几个子进程③子进程再开启多个线程，此时细化到线程才对应(c)的单线程I/0 连接复用器结构。



apache是(b)结构，多线程I/0结构；一个用户请求过来就开启一个线程为其响应，所以资源消耗主要是内存消耗比较大。apache并发所以上不去，虽说上不去，但传统行业基本也够用(用户量没有互联网公司的业务大一般情况)，互联网不行nginx才行。

<img src="3-httpd软件工作模型.assets/image-20230927161628592.png" alt="image-20230927161628592" style="zoom:50%;" />



<img src="3-httpd软件工作模型.assets/image-20230927161301440.png" alt="image-20230927161301440" style="zoom:50%;" />



## 3、处理请求：服务器对请求报文进行解析，并获取请求的资源及请求方法等相 关信息，根据方法，资源，首部和可选的主体部分对请求进行处理

```
元数据：请求报文首部
<method> <URL> <VERSION>
HEADERS 	格式 name:value
<request body>  
示例：
Host: www.magedu.com     请求的主机名称
Server: Apache/2.4.7

HTTP常用请求方式(方法)，Method
GET、POST、HEAD、PUT、DELETE、TRACE、OPTIONS
```



估计是这里一堆东西，不过好像一些关键字变了👇：

![image-20230927164054085](3-httpd软件工作模型.assets/image-20230927164054085.png)



比如，GET 方法，然后结合URL里指明的页面，此时server就会去找这个URL所指的资源，于是进入下一步4-访问资源。



## 4、访问资源

服务器获取请求报文中请求的资源web服务器，即存放了web资源的服务器，负责向请求者提供对方请求的静态资源，或动态运行后生成的资源
**资源放置于本地文件系统特定的路径**：DocRoot     #   apache的默认路径找页面资源咯

```
DocRoot --->  /var/www/html    # 默认的页面根路径。
/var/www/html/images/logo.jpg

http://www.xxxx.com/images/logo.jpg    # images/log.jpg就是去httpd的根路径下找。
```

**web服务器资源路径映射方式：**
	①docroot
	②alias
	③虚拟主机docroot
	④用户家目录docroot



找到磁盘上的网页文件后，要构建 "响应报文" 于是进入下一步 5-构建响应报文。



**apache的documentation**入口官网竟然没了，不过可以直接进去

https://httpd.apache.org/docs/



## 5、构建响应报文：

一旦Web服务器识别出了资源，就执行请求方法中描述的动作，并返回响应 报文。响应报文中 包含有响应状态码、响应首部，如果生成了响应主体的话，还包 括响应主体

1、**响应实体**：如果事务处理产生了响应主体，就将内容放在响应报文中回送过 去。响应报文中通常包括：

​			描述了响应主体MIME类型的Content-Type首部

​			描述了响应主体长度的Content-Length

​			实际报文的主体内容

2、**URL重定向**：web服务构建的响应并非客户端请求的资源，而是资源另外一 个访问路径

永久重定向301：[http://www.360buy.com](http://www.360buy.com/)

临时重定向302/307：[http://www.taobao.com](http://www.taobao.com/)  不过这个也变成301了，需要重新找一个

https://blog.csdn.net/idwtwt/article/details/90692773    👈这个有时间再研究吧，不研究也行，知道有这个回事就行。









